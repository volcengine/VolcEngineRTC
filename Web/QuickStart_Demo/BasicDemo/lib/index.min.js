/**
 * Copyright (c) 2025 The VolcEngineRTC project authors. All Rights Reserved.
 * @brief VolcEngine Advance API
 * version: 4.66.16
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).VERTC=t()}(this,(function(){"use strict";function e(e,t){return t.forEach((function(t){t&&"string"!=typeof t&&!Array.isArray(t)&&Object.keys(t).forEach((function(i){if("default"!==i&&!(i in e)){var o=Object.getOwnPropertyDescriptor(t,i);Object.defineProperty(e,i,o.get?o:{enumerable:!0,get:function(){return t[i]}})}}))})),Object.freeze(e)}var t="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function i(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function o(e){if(e.__esModule)return e;var t=e.default;if("function"==typeof t){var i=function e(){if(this instanceof e){var i=[null];return i.push.apply(i,arguments),new(Function.bind.apply(t,i))}return t.apply(this,arguments)};i.prototype=t.prototype}else i={};return Object.defineProperty(i,"__esModule",{value:!0}),Object.keys(e).forEach((function(t){var o=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(i,t,o.get?o:{enumerable:!0,get:function(){return e[t]}})})),i}var r=function(e){return e&&e.Math===Math&&e},s=r("object"==typeof globalThis&&globalThis)||r("object"==typeof window&&window)||r("object"==typeof self&&self)||r("object"==typeof t&&t)||r("object"==typeof t&&t)||function(){return this}()||Function("return this")(),n=function(e){try{return!!e()}catch(t){return!0}},a=!n((function(){var e=function(){}.bind();return"function"!=typeof e||e.hasOwnProperty("prototype")})),d=a,c=Function.prototype,l=c.apply,u=c.call,h="object"==typeof Reflect&&Reflect.apply||(d?u.bind(l):function(){return u.apply(l,arguments)}),_=a,m=Function.prototype,p=m.call,v=_&&m.bind.bind(p,p),f=_?v:function(e){return function(){return p.apply(e,arguments)}},S=f,g=S({}.toString),y=S("".slice),b=function(e){return y(g(e),8,-1)},T=b,I=f,E=function(e){if("Function"===T(e))return I(e)},R="object"==typeof document&&document.all,C=void 0===R&&void 0!==R?function(e){return"function"==typeof e||e===R}:function(e){return"function"==typeof e},k={},A=!n((function(){return 7!==Object.defineProperty({},1,{get:function(){return 7}})[1]})),P=a,N=Function.prototype.call,w=P?N.bind(N):function(){return N.apply(N,arguments)},O={},M={}.propertyIsEnumerable,L=Object.getOwnPropertyDescriptor,x=L&&!M.call({1:2},1);O.f=x?function(e){var t=L(this,e);return!!t&&t.enumerable}:M;var V,D,U=function(e,t){return{enumerable:!(1&e),configurable:!(2&e),writable:!(4&e),value:t}},Z=n,W=b,X=Object,G=f("".split),F=Z((function(){return!X("z").propertyIsEnumerable(0)}))?function(e){return"String"===W(e)?G(e,""):X(e)}:X,H=function(e){return null==e},Y=H,K=TypeError,B=function(e){if(Y(e))throw new K("Can't call method on "+e);return e},J=F,j=B,z=function(e){return J(j(e))},Q=C,q=function(e){return"object"==typeof e?null!==e:Q(e)},$={},ee=$,te=s,ie=C,oe=function(e){return ie(e)?e:void 0},re=function(e,t){return arguments.length<2?oe(ee[e])||oe(te[e]):ee[e]&&ee[e][t]||te[e]&&te[e][t]},se=f({}.isPrototypeOf),ne=s.navigator,ae=ne&&ne.userAgent,de=ae?String(ae):"",ce=s,le=de,ue=ce.process,he=ce.Deno,_e=ue&&ue.versions||he&&he.version,me=_e&&_e.v8;me&&(D=(V=me.split("."))[0]>0&&V[0]<4?1:+(V[0]+V[1])),!D&&le&&(!(V=le.match(/Edge\/(\d+)/))||V[1]>=74)&&(V=le.match(/Chrome\/(\d+)/))&&(D=+V[1]);var pe=D,ve=pe,fe=n,Se=s.String,ge=!!Object.getOwnPropertySymbols&&!fe((function(){var e=Symbol("symbol detection");return!Se(e)||!(Object(e)instanceof Symbol)||!Symbol.sham&&ve&&ve<41})),ye=ge&&!Symbol.sham&&"symbol"==typeof Symbol.iterator,be=re,Te=C,Ie=se,Ee=Object,Re=ye?function(e){return"symbol"==typeof e}:function(e){var t=be("Symbol");return Te(t)&&Ie(t.prototype,Ee(e))},Ce=String,ke=function(e){try{return Ce(e)}catch(t){return"Object"}},Ae=C,Pe=ke,Ne=TypeError,we=function(e){if(Ae(e))return e;throw new Ne(Pe(e)+" is not a function")},Oe=we,Me=H,Le=function(e,t){var i=e[t];return Me(i)?void 0:Oe(i)},xe=w,Ve=C,De=q,Ue=TypeError,Ze={exports:{}},We=!0,Xe=s,Ge=Object.defineProperty,Fe=s,He=function(e,t){try{Ge(Xe,e,{value:t,configurable:!0,writable:!0})}catch(i){Xe[e]=t}return t},Ye="__core-js_shared__",Ke=Ze.exports=Fe[Ye]||He(Ye,{});(Ke.versions||(Ke.versions=[])).push({version:"3.39.0",mode:"pure",copyright:"Â© 2014-2024 Denis Pushkarev (zloirock.ru)",license:"https://github.com/zloirock/core-js/blob/v3.39.0/LICENSE",source:"https://github.com/zloirock/core-js"});var Be=Ze.exports,Je=Be,je=function(e,t){return Je[e]||(Je[e]=t||{})},ze=B,Qe=Object,qe=function(e){return Qe(ze(e))},$e=qe,et=f({}.hasOwnProperty),tt=Object.hasOwn||function(e,t){return et($e(e),t)},it=f,ot=0,rt=Math.random(),st=it(1..toString),nt=function(e){return"Symbol("+(void 0===e?"":e)+")_"+st(++ot+rt,36)},at=je,dt=tt,ct=nt,lt=ge,ut=ye,ht=s.Symbol,_t=at("wks"),mt=ut?ht.for||ht:ht&&ht.withoutSetter||ct,pt=function(e){return dt(_t,e)||(_t[e]=lt&&dt(ht,e)?ht[e]:mt("Symbol."+e)),_t[e]},vt=w,ft=q,St=Re,gt=Le,yt=function(e,t){var i,o;if("string"===t&&Ve(i=e.toString)&&!De(o=xe(i,e)))return o;if(Ve(i=e.valueOf)&&!De(o=xe(i,e)))return o;if("string"!==t&&Ve(i=e.toString)&&!De(o=xe(i,e)))return o;throw new Ue("Can't convert object to primitive value")},bt=TypeError,Tt=pt("toPrimitive"),It=function(e,t){if(!ft(e)||St(e))return e;var i,o=gt(e,Tt);if(o){if(void 0===t&&(t="default"),i=vt(o,e,t),!ft(i)||St(i))return i;throw new bt("Can't convert object to primitive value")}return void 0===t&&(t="number"),yt(e,t)},Et=Re,Rt=function(e){var t=It(e,"string");return Et(t)?t:t+""},Ct=q,kt=s.document,At=Ct(kt)&&Ct(kt.createElement),Pt=function(e){return At?kt.createElement(e):{}},Nt=Pt,wt=!A&&!n((function(){return 7!==Object.defineProperty(Nt("div"),"a",{get:function(){return 7}}).a})),Ot=A,Mt=w,Lt=O,xt=U,Vt=z,Dt=Rt,Ut=tt,Zt=wt,Wt=Object.getOwnPropertyDescriptor;k.f=Ot?Wt:function(e,t){if(e=Vt(e),t=Dt(t),Zt)try{return Wt(e,t)}catch(i){}if(Ut(e,t))return xt(!Mt(Lt.f,e,t),e[t])};var Xt=n,Gt=C,Ft=/#|\.prototype\./,Ht=function(e,t){var i=Kt[Yt(e)];return i===Jt||i!==Bt&&(Gt(t)?Xt(t):!!t)},Yt=Ht.normalize=function(e){return String(e).replace(Ft,".").toLowerCase()},Kt=Ht.data={},Bt=Ht.NATIVE="N",Jt=Ht.POLYFILL="P",jt=Ht,zt=we,Qt=a,qt=E(E.bind),$t=function(e,t){return zt(e),void 0===t?e:Qt?qt(e,t):function(){return e.apply(t,arguments)}},ei={},ti=A&&n((function(){return 42!==Object.defineProperty((function(){}),"prototype",{value:42,writable:!1}).prototype})),ii=q,oi=String,ri=TypeError,si=function(e){if(ii(e))return e;throw new ri(oi(e)+" is not an object")},ni=A,ai=wt,di=ti,ci=si,li=Rt,ui=TypeError,hi=Object.defineProperty,_i=Object.getOwnPropertyDescriptor,mi="enumerable",pi="configurable",vi="writable";ei.f=ni?di?function(e,t,i){if(ci(e),t=li(t),ci(i),"function"==typeof e&&"prototype"===t&&"value"in i&&vi in i&&!i[vi]){var o=_i(e,t);o&&o[vi]&&(e[t]=i.value,i={configurable:pi in i?i[pi]:o[pi],enumerable:mi in i?i[mi]:o[mi],writable:!1})}return hi(e,t,i)}:hi:function(e,t,i){if(ci(e),t=li(t),ci(i),ai)try{return hi(e,t,i)}catch(o){}if("get"in i||"set"in i)throw new ui("Accessors not supported");return"value"in i&&(e[t]=i.value),e};var fi=ei,Si=U,gi=A?function(e,t,i){return fi.f(e,t,Si(1,i))}:function(e,t,i){return e[t]=i,e},yi=s,bi=h,Ti=E,Ii=C,Ei=k.f,Ri=jt,Ci=$,ki=$t,Ai=gi,Pi=tt,Ni=function(e){var t=function(i,o,r){if(this instanceof t){switch(arguments.length){case 0:return new e;case 1:return new e(i);case 2:return new e(i,o)}return new e(i,o,r)}return bi(e,this,arguments)};return t.prototype=e.prototype,t},wi=function(e,t){var i,o,r,s,n,a,d,c,l,u=e.target,h=e.global,_=e.stat,m=e.proto,p=h?yi:_?yi[u]:yi[u]&&yi[u].prototype,v=h?Ci:Ci[u]||Ai(Ci,u,{})[u],f=v.prototype;for(s in t)o=!(i=Ri(h?s:u+(_?".":"#")+s,e.forced))&&p&&Pi(p,s),a=v[s],o&&(d=e.dontCallGetSet?(l=Ei(p,s))&&l.value:p[s]),n=o&&d?d:t[s],(i||m||typeof a!=typeof n)&&(c=e.bind&&o?ki(n,yi):e.wrap&&o?Ni(n):m&&Ii(n)?Ti(n):n,(e.sham||n&&n.sham||a&&a.sham)&&Ai(c,"sham",!0),Ai(v,s,c),m&&(Pi(Ci,r=u+"Prototype")||Ai(Ci,r,{}),Ai(Ci[r],s,n),e.real&&f&&(i||!f[s])&&Ai(f,s,n)))},Oi=Math.ceil,Mi=Math.floor,Li=Math.trunc||function(e){var t=+e;return(t>0?Mi:Oi)(t)},xi=function(e){var t=+e;return t!=t||0===t?0:Li(t)},Vi=xi,Di=Math.max,Ui=Math.min,Zi=function(e,t){var i=Vi(e);return i<0?Di(i+t,0):Ui(i,t)},Wi=xi,Xi=Math.min,Gi=function(e){var t=Wi(e);return t>0?Xi(t,9007199254740991):0},Fi=function(e){return Gi(e.length)},Hi=z,Yi=Zi,Ki=Fi,Bi=function(e){return function(t,i,o){var r=Hi(t),s=Ki(r);if(0===s)return!e&&-1;var n,a=Yi(o,s);if(e&&i!=i){for(;s>a;)if((n=r[a++])!=n)return!0}else for(;s>a;a++)if((e||a in r)&&r[a]===i)return e||a||0;return!e&&-1}},Ji={includes:Bi(!0),indexOf:Bi(!1)},ji={},zi=tt,Qi=z,qi=Ji.indexOf,$i=ji,eo=f([].push),to=function(e,t){var i,o=Qi(e),r=0,s=[];for(i in o)!zi($i,i)&&zi(o,i)&&eo(s,i);for(;t.length>r;)zi(o,i=t[r++])&&(~qi(s,i)||eo(s,i));return s},io=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"],oo=to,ro=io,so=Object.keys||function(e){return oo(e,ro)},no=qe,ao=so;wi({target:"Object",stat:!0,forced:n((function(){ao(1)}))},{keys:function(e){return ao(no(e))}});var co=i($.Object.keys),lo={};lo[pt("toStringTag")]="z";var uo="[object z]"===String(lo),ho=uo,_o=C,mo=b,po=pt("toStringTag"),vo=Object,fo="Arguments"===mo(function(){return arguments}()),So=ho?mo:function(e){var t,i,o;return void 0===e?"Undefined":null===e?"Null":"string"==typeof(i=function(e,t){try{return e[t]}catch(i){}}(t=vo(e),po))?i:fo?mo(t):"Object"===(o=mo(t))&&_o(t.callee)?"Arguments":o},go=So,yo=String,bo=function(e){if("Symbol"===go(e))throw new TypeError("Cannot convert a Symbol value to a string");return yo(e)},To={},Io=A,Eo=ti,Ro=ei,Co=si,ko=z,Ao=so;To.f=Io&&!Eo?Object.defineProperties:function(e,t){Co(e);for(var i,o=ko(t),r=Ao(t),s=r.length,n=0;s>n;)Ro.f(e,i=r[n++],o[i]);return e};var Po,No=re("document","documentElement"),wo=nt,Oo=je("keys"),Mo=function(e){return Oo[e]||(Oo[e]=wo(e))},Lo=si,xo=To,Vo=io,Do=ji,Uo=No,Zo=Pt,Wo="prototype",Xo="script",Go=Mo("IE_PROTO"),Fo=function(){},Ho=function(e){return"<"+Xo+">"+e+"</"+Xo+">"},Yo=function(e){e.write(Ho("")),e.close();var t=e.parentWindow.Object;return e=null,t},Ko=function(){try{Po=new ActiveXObject("htmlfile")}catch(r){}var e,t,i;Ko="undefined"!=typeof document?document.domain&&Po?Yo(Po):(t=Zo("iframe"),i="java"+Xo+":",t.style.display="none",Uo.appendChild(t),t.src=String(i),(e=t.contentWindow.document).open(),e.write(Ho("document.F=Object")),e.close(),e.F):Yo(Po);for(var o=Vo.length;o--;)delete Ko[Wo][Vo[o]];return Ko()};Do[Go]=!0;var Bo=Object.create||function(e,t){var i;return null!==e?(Fo[Wo]=Lo(e),i=new Fo,Fo[Wo]=null,i[Go]=e):i=Ko(),void 0===t?i:xo.f(i,t)},Jo={},jo=to,zo=io.concat("length","prototype");Jo.f=Object.getOwnPropertyNames||function(e){return jo(e,zo)};var Qo={},qo=f([].slice),$o=b,er=z,tr=Jo.f,ir=qo,or="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[];Qo.f=function(e){return or&&"Window"===$o(e)?function(e){try{return tr(e)}catch(t){return ir(or)}}(e):tr(er(e))};var rr={};rr.f=Object.getOwnPropertySymbols;var sr=gi,nr=function(e,t,i,o){return o&&o.enumerable?e[t]=i:sr(e,t,i),e},ar=ei,dr=function(e,t,i){return ar.f(e,t,i)},cr={},lr=pt;cr.f=lr;var ur,hr,_r,mr=$,pr=tt,vr=cr,fr=ei.f,Sr=function(e){var t=mr.Symbol||(mr.Symbol={});pr(t,e)||fr(t,e,{value:vr.f(e)})},gr=w,yr=re,br=pt,Tr=nr,Ir=function(){var e=yr("Symbol"),t=e&&e.prototype,i=t&&t.valueOf,o=br("toPrimitive");t&&!t[o]&&Tr(t,o,(function(e){return gr(i,this)}),{arity:1})},Er=So,Rr=uo?{}.toString:function(){return"[object "+Er(this)+"]"},Cr=uo,kr=ei.f,Ar=gi,Pr=tt,Nr=Rr,wr=pt("toStringTag"),Or=function(e,t,i,o){var r=i?e:e&&e.prototype;r&&(Pr(r,wr)||kr(r,wr,{configurable:!0,value:t}),o&&!Cr&&Ar(r,"toString",Nr))},Mr=C,Lr=s.WeakMap,xr=Mr(Lr)&&/native code/.test(String(Lr)),Vr=s,Dr=q,Ur=gi,Zr=tt,Wr=Be,Xr=Mo,Gr=ji,Fr="Object already initialized",Hr=Vr.TypeError,Yr=Vr.WeakMap;if(xr||Wr.state){var Kr=Wr.state||(Wr.state=new Yr);Kr.get=Kr.get,Kr.has=Kr.has,Kr.set=Kr.set,ur=function(e,t){if(Kr.has(e))throw new Hr(Fr);return t.facade=e,Kr.set(e,t),t},hr=function(e){return Kr.get(e)||{}},_r=function(e){return Kr.has(e)}}else{var Br=Xr("state");Gr[Br]=!0,ur=function(e,t){if(Zr(e,Br))throw new Hr(Fr);return t.facade=e,Ur(e,Br,t),t},hr=function(e){return Zr(e,Br)?e[Br]:{}},_r=function(e){return Zr(e,Br)}}var Jr={set:ur,get:hr,has:_r,enforce:function(e){return _r(e)?hr(e):ur(e,{})},getterFor:function(e){return function(t){var i;if(!Dr(t)||(i=hr(t)).type!==e)throw new Hr("Incompatible receiver, "+e+" required");return i}}},jr=b,zr=Array.isArray||function(e){return"Array"===jr(e)},Qr=C,qr=Be,$r=f(Function.toString);Qr(qr.inspectSource)||(qr.inspectSource=function(e){return $r(e)});var es=qr.inspectSource,ts=f,is=n,os=C,rs=So,ss=es,ns=function(){},as=re("Reflect","construct"),ds=/^\s*(?:class|function)\b/,cs=ts(ds.exec),ls=!ds.test(ns),us=function(e){if(!os(e))return!1;try{return as(ns,[],e),!0}catch(t){return!1}},hs=function(e){if(!os(e))return!1;switch(rs(e)){case"AsyncFunction":case"GeneratorFunction":case"AsyncGeneratorFunction":return!1}try{return ls||!!cs(ds,ss(e))}catch(t){return!0}};hs.sham=!0;var _s=!as||is((function(){var e;return us(us.call)||!us(Object)||!us((function(){e=!0}))||e}))?hs:us,ms=zr,ps=_s,vs=q,fs=pt("species"),Ss=Array,gs=function(e){var t;return ms(e)&&(t=e.constructor,(ps(t)&&(t===Ss||ms(t.prototype))||vs(t)&&null===(t=t[fs]))&&(t=void 0)),void 0===t?Ss:t},ys=function(e,t){return new(gs(e))(0===t?0:t)},bs=$t,Ts=F,Is=qe,Es=Fi,Rs=ys,Cs=f([].push),ks=function(e){var t=1===e,i=2===e,o=3===e,r=4===e,s=6===e,n=7===e,a=5===e||s;return function(d,c,l,u){for(var h,_,m=Is(d),p=Ts(m),v=Es(p),f=bs(c,l),S=0,g=u||Rs,y=t?g(d,v):i||n?g(d,0):void 0;v>S;S++)if((a||S in p)&&(_=f(h=p[S],S,m),e))if(t)y[S]=_;else if(_)switch(e){case 3:return!0;case 5:return h;case 6:return S;case 2:Cs(y,h)}else switch(e){case 4:return!1;case 7:Cs(y,h)}return s?-1:o||r?r:y}},As={forEach:ks(0),map:ks(1),filter:ks(2),some:ks(3),every:ks(4),find:ks(5),findIndex:ks(6),filterReject:ks(7)},Ps=wi,Ns=s,ws=w,Os=f,Ms=A,Ls=ge,xs=n,Vs=tt,Ds=se,Us=si,Zs=z,Ws=Rt,Xs=bo,Gs=U,Fs=Bo,Hs=so,Ys=Jo,Ks=Qo,Bs=rr,Js=k,js=ei,zs=To,Qs=O,qs=nr,$s=dr,en=je,tn=ji,on=nt,rn=pt,sn=cr,nn=Sr,an=Ir,dn=Or,cn=Jr,ln=As.forEach,un=Mo("hidden"),hn="Symbol",_n="prototype",mn=cn.set,pn=cn.getterFor(hn),vn=Object[_n],fn=Ns.Symbol,Sn=fn&&fn[_n],gn=Ns.RangeError,yn=Ns.TypeError,bn=Ns.QObject,Tn=Js.f,In=js.f,En=Ks.f,Rn=Qs.f,Cn=Os([].push),kn=en("symbols"),An=en("op-symbols"),Pn=en("wks"),Nn=!bn||!bn[_n]||!bn[_n].findChild,wn=function(e,t,i){var o=Tn(vn,t);o&&delete vn[t],In(e,t,i),o&&e!==vn&&In(vn,t,o)},On=Ms&&xs((function(){return 7!==Fs(In({},"a",{get:function(){return In(this,"a",{value:7}).a}})).a}))?wn:In,Mn=function(e,t){var i=kn[e]=Fs(Sn);return mn(i,{type:hn,tag:e,description:t}),Ms||(i.description=t),i},Ln=function(e,t,i){e===vn&&Ln(An,t,i),Us(e);var o=Ws(t);return Us(i),Vs(kn,o)?(i.enumerable?(Vs(e,un)&&e[un][o]&&(e[un][o]=!1),i=Fs(i,{enumerable:Gs(0,!1)})):(Vs(e,un)||In(e,un,Gs(1,Fs(null))),e[un][o]=!0),On(e,o,i)):In(e,o,i)},xn=function(e,t){Us(e);var i=Zs(t),o=Hs(i).concat(Zn(i));return ln(o,(function(t){Ms&&!ws(Vn,i,t)||Ln(e,t,i[t])})),e},Vn=function(e){var t=Ws(e),i=ws(Rn,this,t);return!(this===vn&&Vs(kn,t)&&!Vs(An,t))&&(!(i||!Vs(this,t)||!Vs(kn,t)||Vs(this,un)&&this[un][t])||i)},Dn=function(e,t){var i=Zs(e),o=Ws(t);if(i!==vn||!Vs(kn,o)||Vs(An,o)){var r=Tn(i,o);return!r||!Vs(kn,o)||Vs(i,un)&&i[un][o]||(r.enumerable=!0),r}},Un=function(e){var t=En(Zs(e)),i=[];return ln(t,(function(e){Vs(kn,e)||Vs(tn,e)||Cn(i,e)})),i},Zn=function(e){var t=e===vn,i=En(t?An:Zs(e)),o=[];return ln(i,(function(e){!Vs(kn,e)||t&&!Vs(vn,e)||Cn(o,kn[e])})),o};Ls||(fn=function(){if(Ds(Sn,this))throw new yn("Symbol is not a constructor");var e=arguments.length&&void 0!==arguments[0]?Xs(arguments[0]):void 0,t=on(e),i=function(e){var o=void 0===this?Ns:this;o===vn&&ws(i,An,e),Vs(o,un)&&Vs(o[un],t)&&(o[un][t]=!1);var r=Gs(1,e);try{On(o,t,r)}catch(s){if(!(s instanceof gn))throw s;wn(o,t,r)}};return Ms&&Nn&&On(vn,t,{configurable:!0,set:i}),Mn(t,e)},qs(Sn=fn[_n],"toString",(function(){return pn(this).tag})),qs(fn,"withoutSetter",(function(e){return Mn(on(e),e)})),Qs.f=Vn,js.f=Ln,zs.f=xn,Js.f=Dn,Ys.f=Ks.f=Un,Bs.f=Zn,sn.f=function(e){return Mn(rn(e),e)},Ms&&$s(Sn,"description",{configurable:!0,get:function(){return pn(this).description}})),Ps({global:!0,constructor:!0,wrap:!0,forced:!Ls,sham:!Ls},{Symbol:fn}),ln(Hs(Pn),(function(e){nn(e)})),Ps({target:hn,stat:!0,forced:!Ls},{useSetter:function(){Nn=!0},useSimple:function(){Nn=!1}}),Ps({target:"Object",stat:!0,forced:!Ls,sham:!Ms},{create:function(e,t){return void 0===t?Fs(e):xn(Fs(e),t)},defineProperty:Ln,defineProperties:xn,getOwnPropertyDescriptor:Dn}),Ps({target:"Object",stat:!0,forced:!Ls},{getOwnPropertyNames:Un}),an(),dn(fn,hn),tn[un]=!0;var Wn=ge&&!!Symbol.for&&!!Symbol.keyFor,Xn=wi,Gn=re,Fn=tt,Hn=bo,Yn=je,Kn=Wn,Bn=Yn("string-to-symbol-registry"),Jn=Yn("symbol-to-string-registry");Xn({target:"Symbol",stat:!0,forced:!Kn},{for:function(e){var t=Hn(e);if(Fn(Bn,t))return Bn[t];var i=Gn("Symbol")(t);return Bn[t]=i,Jn[i]=t,i}});var jn=wi,zn=tt,Qn=Re,qn=ke,$n=Wn,ea=je("symbol-to-string-registry");jn({target:"Symbol",stat:!0,forced:!$n},{keyFor:function(e){if(!Qn(e))throw new TypeError(qn(e)+" is not a symbol");if(zn(ea,e))return ea[e]}});var ta=zr,ia=C,oa=b,ra=bo,sa=f([].push),na=wi,aa=re,da=h,ca=w,la=f,ua=n,ha=C,_a=Re,ma=qo,pa=function(e){if(ia(e))return e;if(ta(e)){for(var t=e.length,i=[],o=0;o<t;o++){var r=e[o];"string"==typeof r?sa(i,r):"number"!=typeof r&&"Number"!==oa(r)&&"String"!==oa(r)||sa(i,ra(r))}var s=i.length,n=!0;return function(e,t){if(n)return n=!1,t;if(ta(this))return t;for(var o=0;o<s;o++)if(i[o]===e)return t}}},va=ge,fa=String,Sa=aa("JSON","stringify"),ga=la(/./.exec),ya=la("".charAt),ba=la("".charCodeAt),Ta=la("".replace),Ia=la(1..toString),Ea=/[\uD800-\uDFFF]/g,Ra=/^[\uD800-\uDBFF]$/,Ca=/^[\uDC00-\uDFFF]$/,ka=!va||ua((function(){var e=aa("Symbol")("stringify detection");return"[null]"!==Sa([e])||"{}"!==Sa({a:e})||"{}"!==Sa(Object(e))})),Aa=ua((function(){return'"\\udf06\\ud834"'!==Sa("\udf06\ud834")||'"\\udead"'!==Sa("\udead")})),Pa=function(e,t){var i=ma(arguments),o=pa(t);if(ha(o)||void 0!==e&&!_a(e))return i[1]=function(e,t){if(ha(o)&&(t=ca(o,this,fa(e),t)),!_a(t))return t},da(Sa,null,i)},Na=function(e,t,i){var o=ya(i,t-1),r=ya(i,t+1);return ga(Ra,e)&&!ga(Ca,r)||ga(Ca,e)&&!ga(Ra,o)?"\\u"+Ia(ba(e,0),16):e};Sa&&na({target:"JSON",stat:!0,arity:3,forced:ka||Aa},{stringify:function(e,t,i){var o=ma(arguments),r=da(ka?Pa:Sa,null,o);return Aa&&"string"==typeof r?Ta(r,Ea,Na):r}});var wa=rr,Oa=qe;wi({target:"Object",stat:!0,forced:!ge||n((function(){wa.f(1)}))},{getOwnPropertySymbols:function(e){var t=wa.f;return t?t(Oa(e)):[]}});var Ma=i($.Object.getOwnPropertySymbols),La=n,xa=pe,Va=pt("species"),Da=function(e){return xa>=51||!La((function(){var t=[];return(t.constructor={})[Va]=function(){return{foo:1}},1!==t[e](Boolean).foo}))},Ua=As.filter;wi({target:"Array",proto:!0,forced:!Da("filter")},{filter:function(e){return Ua(this,e,arguments.length>1?arguments[1]:void 0)}});var Za=s,Wa=$,Xa=function(e,t){var i=Wa[e+"Prototype"],o=i&&i[t];if(o)return o;var r=Za[e],s=r&&r.prototype;return s&&s[t]},Ga=Xa("Array","filter"),Fa=se,Ha=Ga,Ya=Array.prototype,Ka=i((function(e){var t=e.filter;return e===Ya||Fa(Ya,e)&&t===Ya.filter?Ha:t})),Ba={exports:{}},Ja=wi,ja=n,za=z,Qa=k.f,qa=A;Ja({target:"Object",stat:!0,forced:!qa||ja((function(){Qa(1)})),sham:!qa},{getOwnPropertyDescriptor:function(e,t){return Qa(za(e),t)}});var $a=$.Object,ed=Ba.exports=function(e,t){return $a.getOwnPropertyDescriptor(e,t)};$a.getOwnPropertyDescriptor.sham&&(ed.sham=!0);var td=i(Ba.exports),id=A,od=zr,rd=TypeError,sd=Object.getOwnPropertyDescriptor,nd=id&&!function(){if(void 0!==this)return!0;try{Object.defineProperty([],"length",{writable:!1}).length=1}catch(e){return e instanceof TypeError}}(),ad=TypeError,dd=function(e){if(e>9007199254740991)throw ad("Maximum allowed index exceeded");return e},cd=qe,ld=Fi,ud=nd?function(e,t){if(od(e)&&!sd(e,"length").writable)throw new rd("Cannot set read only .length");return e.length=t}:function(e,t){return e.length=t},hd=dd;wi({target:"Array",proto:!0,arity:1,forced:n((function(){return 4294967297!==[].push.call({length:4294967296},1)}))||!function(){try{Object.defineProperty([],"length",{writable:!1}).push()}catch(e){return e instanceof TypeError}}()},{push:function(e){var t=cd(this),i=ld(t),o=arguments.length;hd(i+o);for(var r=0;r<o;r++)t[i]=arguments[r],i++;return ud(t,i),i}});var _d=Xa("Array","push"),md=se,pd=_d,vd=Array.prototype,fd=i((function(e){var t=e.push;return e===vd||md(vd,e)&&t===vd.push?pd:t})),Sd=n,gd=function(e,t){var i=[][e];return!!i&&Sd((function(){i.call(null,t||function(){return 1},1)}))},yd=As.forEach,bd=gd("forEach")?[].forEach:function(e){return yd(this,e,arguments.length>1?arguments[1]:void 0)};wi({target:"Array",proto:!0,forced:[].forEach!==bd},{forEach:bd});var Td=Xa("Array","forEach"),Id=So,Ed=tt,Rd=se,Cd=Td,kd=Array.prototype,Ad={DOMTokenList:!0,NodeList:!0},Pd=i((function(e){var t=e.forEach;return e===kd||Rd(kd,e)&&t===kd.forEach||Ed(Ad,Id(e))?Cd:t})),Nd=re,wd=Jo,Od=rr,Md=si,Ld=f([].concat),xd=Nd("Reflect","ownKeys")||function(e){var t=wd.f(Md(e)),i=Od.f;return i?Ld(t,i(e)):t},Vd=A,Dd=ei,Ud=U,Zd=function(e,t,i){Vd?Dd.f(e,t,Ud(0,i)):e[t]=i},Wd=xd,Xd=z,Gd=k,Fd=Zd;wi({target:"Object",stat:!0,sham:!A},{getOwnPropertyDescriptors:function(e){for(var t,i,o=Xd(e),r=Gd.f,s=Wd(o),n={},a=0;s.length>a;)void 0!==(i=r(o,t=s[a++]))&&Fd(n,t,i);return n}});var Hd=i($.Object.getOwnPropertyDescriptors),Yd={exports:{}},Kd=wi,Bd=A,Jd=To.f;Kd({target:"Object",stat:!0,forced:Object.defineProperties!==Jd,sham:!Bd},{defineProperties:Jd});var jd=$.Object,zd=Yd.exports=function(e,t){return jd.defineProperties(e,t)};jd.defineProperties.sham&&(zd.sham=!0);var Qd=i(Yd.exports),qd={exports:{}},$d=wi,ec=A,tc=ei.f;$d({target:"Object",stat:!0,forced:Object.defineProperty!==tc,sham:!ec},{defineProperty:tc});var ic=$.Object,oc=qd.exports=function(e,t,i){return ic.defineProperty(e,t,i)};ic.defineProperty.sham&&(oc.sham=!0);var rc=i(qd.exports),sc=wi,nc=n,ac=zr,dc=q,cc=qe,lc=Fi,uc=dd,hc=Zd,_c=ys,mc=Da,pc=pe,vc=pt("isConcatSpreadable"),fc=pc>=51||!nc((function(){var e=[];return e[vc]=!1,e.concat()[0]!==e})),Sc=function(e){if(!dc(e))return!1;var t=e[vc];return void 0!==t?!!t:ac(e)};sc({target:"Array",proto:!0,arity:1,forced:!fc||!mc("concat")},{concat:function(e){var t,i,o,r,s,n=cc(this),a=_c(n,0),d=0;for(t=-1,o=arguments.length;t<o;t++)if(Sc(s=-1===t?n:arguments[t]))for(r=lc(s),uc(d+r),i=0;i<r;i++,d++)i in s&&hc(a,d,s[i]);else uc(d+1),hc(a,d++,s);return a.length=d,a}}),Sr("asyncIterator"),Sr("hasInstance"),Sr("isConcatSpreadable"),Sr("iterator"),Sr("match"),Sr("matchAll"),Sr("replace"),Sr("search"),Sr("species"),Sr("split");var gc=Ir;Sr("toPrimitive"),gc();var yc=re,bc=Or;Sr("toStringTag"),bc(yc("Symbol"),"Symbol"),Sr("unscopables"),Or(s.JSON,"JSON",!0);var Tc,Ic,Ec,Rc=$.Symbol,Cc={},kc=A,Ac=tt,Pc=Function.prototype,Nc=kc&&Object.getOwnPropertyDescriptor,wc=Ac(Pc,"name"),Oc={EXISTS:wc,PROPER:wc&&"something"===function(){}.name,CONFIGURABLE:wc&&(!kc||kc&&Nc(Pc,"name").configurable)},Mc=!n((function(){function e(){}return e.prototype.constructor=null,Object.getPrototypeOf(new e)!==e.prototype})),Lc=tt,xc=C,Vc=qe,Dc=Mc,Uc=Mo("IE_PROTO"),Zc=Object,Wc=Zc.prototype,Xc=Dc?Zc.getPrototypeOf:function(e){var t=Vc(e);if(Lc(t,Uc))return t[Uc];var i=t.constructor;return xc(i)&&t instanceof i?i.prototype:t instanceof Zc?Wc:null},Gc=n,Fc=C,Hc=q,Yc=Bo,Kc=Xc,Bc=nr,Jc=pt("iterator"),jc=!1;[].keys&&("next"in(Ec=[].keys())?(Ic=Kc(Kc(Ec)))!==Object.prototype&&(Tc=Ic):jc=!0);var zc=!Hc(Tc)||Gc((function(){var e={};return Tc[Jc].call(e)!==e}));Fc((Tc=zc?{}:Yc(Tc))[Jc])||Bc(Tc,Jc,(function(){return this}));var Qc={IteratorPrototype:Tc,BUGGY_SAFARI_ITERATORS:jc},qc=Qc.IteratorPrototype,$c=Bo,el=U,tl=Or,il=Cc,ol=function(){return this},rl=function(e,t,i,o){var r=t+" Iterator";return e.prototype=$c(qc,{next:el(+!o,i)}),tl(e,r,!1,!0),il[r]=ol,e},sl=f,nl=we,al=q,dl=function(e){return al(e)||null===e},cl=String,ll=TypeError,ul=function(e,t,i){try{return sl(nl(Object.getOwnPropertyDescriptor(e,t)[i]))}catch(o){}},hl=q,_l=B,ml=function(e){if(dl(e))return e;throw new ll("Can't set "+cl(e)+" as a prototype")},pl=Object.setPrototypeOf||("__proto__"in{}?function(){var e,t=!1,i={};try{(e=ul(Object.prototype,"__proto__","set"))(i,[]),t=i instanceof Array}catch(o){}return function(i,o){return _l(i),ml(o),hl(i)?(t?e(i,o):i.__proto__=o,i):i}}():void 0),vl=wi,fl=w,Sl=Oc,gl=rl,yl=Xc,bl=Or,Tl=nr,Il=Cc,El=Qc,Rl=Sl.PROPER,Cl=El.BUGGY_SAFARI_ITERATORS,kl=pt("iterator"),Al="keys",Pl="values",Nl="entries",wl=function(){return this},Ol=function(e,t,i,o,r,s,n){gl(i,t,o);var a,d,c,l=function(e){if(e===r&&p)return p;if(!Cl&&e&&e in _)return _[e];switch(e){case Al:case Pl:case Nl:return function(){return new i(this,e)}}return function(){return new i(this)}},u=t+" Iterator",h=!1,_=e.prototype,m=_[kl]||_["@@iterator"]||r&&_[r],p=!Cl&&m||l(r),v="Array"===t&&_.entries||m;if(v&&(a=yl(v.call(new e)))!==Object.prototype&&a.next&&(bl(a,u,!0,!0),Il[u]=wl),Rl&&r===Pl&&m&&m.name!==Pl&&(h=!0,p=function(){return fl(m,this)}),r)if(d={values:l(Pl),keys:s?p:l(Al),entries:l(Nl)},n)for(c in d)(Cl||h||!(c in _))&&Tl(_,c,d[c]);else vl({target:t,proto:!0,forced:Cl||h},d);return n&&_[kl]!==p&&Tl(_,kl,p,{name:r}),Il[t]=p,d},Ml=function(e,t){return{value:e,done:t}},Ll=z,xl=Cc,Vl=Jr;ei.f;var Dl=Ol,Ul=Ml,Zl="Array Iterator",Wl=Vl.set,Xl=Vl.getterFor(Zl);Dl(Array,"Array",(function(e,t){Wl(this,{type:Zl,target:Ll(e),index:0,kind:t})}),(function(){var e=Xl(this),t=e.target,i=e.index++;if(!t||i>=t.length)return e.target=null,Ul(void 0,!0);switch(e.kind){case"keys":return Ul(i,!1);case"values":return Ul(t[i],!1)}return Ul([i,t[i]],!1)}),"values"),xl.Arguments=xl.Array;var Gl={CSSRuleList:0,CSSStyleDeclaration:0,CSSValueList:0,ClientRectList:0,DOMRectList:0,DOMStringList:0,DOMTokenList:1,DataTransferItemList:0,FileList:0,HTMLAllCollection:0,HTMLCollection:0,HTMLFormElement:0,HTMLSelectElement:0,MediaList:0,MimeTypeArray:0,NamedNodeMap:0,NodeList:1,PaintRequestList:0,Plugin:0,PluginArray:0,SVGLengthList:0,SVGNumberList:0,SVGPathSegList:0,SVGPointList:0,SVGStringList:0,SVGTransformList:0,SourceBufferList:0,StyleSheetList:0,TextTrackCueList:0,TextTrackList:0,TouchList:0},Fl=s,Hl=Or,Yl=Cc;for(var Kl in Gl)Hl(Fl[Kl],Kl),Yl[Kl]=Yl.Array;var Bl=Rc,Jl=pt,jl=ei.f,zl=Jl("metadata"),Ql=Function.prototype;void 0===Ql[zl]&&jl(Ql,zl,{value:null}),Sr("asyncDispose"),Sr("dispose"),Sr("metadata");var ql=Bl,$l=f,eu=re("Symbol"),tu=eu.keyFor,iu=$l(eu.prototype.valueOf),ou=eu.isRegisteredSymbol||function(e){try{return void 0!==tu(iu(e))}catch(t){return!1}};wi({target:"Symbol",stat:!0},{isRegisteredSymbol:ou});for(var ru=je,su=re,nu=f,au=Re,du=pt,cu=su("Symbol"),lu=cu.isWellKnownSymbol,uu=su("Object","getOwnPropertyNames"),hu=nu(cu.prototype.valueOf),_u=ru("wks"),mu=0,pu=uu(cu),vu=pu.length;mu<vu;mu++)try{var fu=pu[mu];au(cu[fu])&&du(fu)}catch(wZ){}var Su=function(e){if(lu&&lu(e))return!0;try{for(var t=hu(e),i=0,o=uu(_u),r=o.length;i<r;i++)if(_u[o[i]]==t)return!0}catch(wZ){}return!1};wi({target:"Symbol",stat:!0,forced:!0},{isWellKnownSymbol:Su}),Sr("customMatcher"),Sr("observable"),wi({target:"Symbol",stat:!0,name:"isRegisteredSymbol"},{isRegistered:ou}),wi({target:"Symbol",stat:!0,name:"isWellKnownSymbol",forced:!0},{isWellKnown:Su}),Sr("matcher"),Sr("metadataKey"),Sr("patternMatch"),Sr("replaceAll");var gu=i(ql),yu=f,bu=xi,Tu=bo,Iu=B,Eu=yu("".charAt),Ru=yu("".charCodeAt),Cu=yu("".slice),ku=function(e){return function(t,i){var o,r,s=Tu(Iu(t)),n=bu(i),a=s.length;return n<0||n>=a?e?"":void 0:(o=Ru(s,n))<55296||o>56319||n+1===a||(r=Ru(s,n+1))<56320||r>57343?e?Eu(s,n):o:e?Cu(s,n,n+2):r-56320+(o-55296<<10)+65536}},Au={codeAt:ku(!1),charAt:ku(!0)},Pu=Au.charAt,Nu=bo,wu=Jr,Ou=Ol,Mu=Ml,Lu="String Iterator",xu=wu.set,Vu=wu.getterFor(Lu);Ou(String,"String",(function(e){xu(this,{type:Lu,string:Nu(e),index:0})}),(function(){var e,t=Vu(this),i=t.string,o=t.index;return o>=i.length?Mu(void 0,!0):(e=Pu(i,o),t.index+=e.length,Mu(e,!1))}));var Du=i(cr.f("iterator"));function Uu(e){return(Uu="function"==typeof gu&&"symbol"==typeof Du?function(e){return typeof e}:function(e){return e&&"function"==typeof gu&&e.constructor===gu&&e!==gu.prototype?"symbol":typeof e})(e)}var Zu=i(cr.f("toPrimitive"));function Wu(e){var t=function(e,t){if("object"!=Uu(e)||!e)return e;var i=e[Zu];if(void 0!==i){var o=i.call(e,t||"default");if("object"!=Uu(o))return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==Uu(t)?t:t+""}function Xu(e,t,i){return(t=Wu(t))in e?rc(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function Gu(e,t){var i=co(e);if(Ma){var o=Ma(e);t&&(o=Ka(o).call(o,(function(t){return td(e,t).enumerable}))),fd(i).apply(i,o)}return i}function Fu(e){for(var t=1;t<arguments.length;t++){var i,o,r=null!=arguments[t]?arguments[t]:{};t%2?Pd(i=Gu(Object(r),!0)).call(i,(function(t){Xu(e,t,r[t])})):Hd?Qd(e,Hd(r)):Pd(o=Gu(Object(r))).call(o,(function(t){rc(e,t,td(r,t))}))}return e}var Hu=(e=>(e[e.VIDEO_SOURCE_TYPE_EXTERNAL=0]="VIDEO_SOURCE_TYPE_EXTERNAL",e[e.VIDEO_SOURCE_TYPE_INTERNAL=1]="VIDEO_SOURCE_TYPE_INTERNAL",e))(Hu||{}),Yu=(e=>(e[e.AUDIO_SOURCE_TYPE_EXTERNAL=0]="AUDIO_SOURCE_TYPE_EXTERNAL",e[e.AUDIO_SOURCE_TYPE_INTERNAL=1]="AUDIO_SOURCE_TYPE_INTERNAL",e))(Yu||{}),Ku=(e=>(e[e.QUIT=0]="QUIT",e[e.DROPPED=1]="DROPPED",e[e.SWITCH_TO_INVISIBLE=2]="SWITCH_TO_INVISIBLE",e[e.KICKED_BY_ADMIN=3]="KICKED_BY_ADMIN",e))(Ku||{}),Bu=(e=>(e[e.CHANNEL_PROFILE_COMMUNICATION=0]="CHANNEL_PROFILE_COMMUNICATION",e[e.CHANNEL_PROFILE_LIVE_BROADCASTING=1]="CHANNEL_PROFILE_LIVE_BROADCASTING",e))(Bu||{}),Ju=(e=>(e[e.AUTO_SUBSCRIBE_MODE=0]="AUTO_SUBSCRIBE_MODE",e[e.MANUAL_SUBSCRIBE_MODE=1]="MANUAL_SUBSCRIBE_MODE",e))(Ju||{}),ju=(e=>(e[e.SUBSCRIBE_SUCC=0]="SUBSCRIBE_SUCC",e[e.SUBSCRIBE_FAIL=1]="SUBSCRIBE_FAIL",e))(ju||{}),zu=(e=>(e[e.PUBLISH_SUCC=0]="PUBLISH_SUCC",e[e.PUBLISH_FAIL=1]="PUBLISH_FAIL",e))(zu||{}),Qu=(e=>(e[e.MIRROR_MODE_OFF=0]="MIRROR_MODE_OFF",e[e.MIRROR_MODE_ON=1]="MIRROR_MODE_ON",e))(Qu||{}),qu=(e=>(e[e.RENDER_MODE_HIDDEN=0]="RENDER_MODE_HIDDEN",e[e.RENDER_MODE_FIT=1]="RENDER_MODE_FIT",e[e.RENDER_MODE_FILL=2]="RENDER_MODE_FILL",e))(qu||{}),$u=(e=>(e[e.STREAM_INDEX_MAIN=0]="STREAM_INDEX_MAIN",e[e.STREAM_INDEX_SCREEN=1]="STREAM_INDEX_SCREEN",e))($u||{}),eh=(e=>(e[e.AUDIO=1]="AUDIO",e[e.VIDEO=2]="VIDEO",e[e.AUDIO_AND_VIDEO=3]="AUDIO_AND_VIDEO",e))(eh||{}),th=(e=>(e[e.STREAM_REMOVE_REASON_UNPUBLISH=0]="STREAM_REMOVE_REASON_UNPUBLISH",e[e.STREAM_REMOVE_REASON_PUBLISH_FAILED=1]="STREAM_REMOVE_REASON_PUBLISH_FAILED",e[e.STREAM_REMOVE_REASON_KEEP_LIVE_FAILED=2]="STREAM_REMOVE_REASON_KEEP_LIVE_FAILED",e[e.STREAM_REMOVE_REASON_CLIENT_DISCONNECTED=3]="STREAM_REMOVE_REASON_CLIENT_DISCONNECTED",e[e.STREAM_REMOVE_REASON_REPUBLISH=4]="STREAM_REMOVE_REASON_REPUBLISH",e[e.STREAM_REMOVE_REASON_OTHER=5]="STREAM_REMOVE_REASON_OTHER",e[e.STREAM_REMOVE_REASON_TOKEN_PRIVILEGE_EXPIRED=6]="STREAM_REMOVE_REASON_TOKEN_PRIVILEGE_EXPIRED",e))(th||{}),ih=(e=>(e[e.CONNECTION_START=0]="CONNECTION_START",e[e.CONNECTION_STATE_DISCONNECTED=1]="CONNECTION_STATE_DISCONNECTED",e[e.CONNECTION_STATE_CONNECTING=2]="CONNECTION_STATE_CONNECTING",e[e.CONNECTION_STATE_CONNECTED=3]="CONNECTION_STATE_CONNECTED",e[e.CONNECTION_STATE_RECONNECTING=4]="CONNECTION_STATE_RECONNECTING",e[e.CONNECTION_STATE_RECONNECTED=5]="CONNECTION_STATE_RECONNECTED",e[e.CONNECTION_STATE_LOST=6]="CONNECTION_STATE_LOST",e))(ih||{}),oh=(e=>(e.ICE_FAILED="iceFailed",e.NODE_CHANGE="nodeChange",e.JOIN_TIMEOUT="joinTimeout",e.NOTIFY_RECONNECT="notifyReconnect",e))(oh||{}),rh=(e=>(e.AUTO="auto",e.H264="h264",e.VP8="vp8",e.ByteVC1="ByteVC1",e))(rh||{}),sh=(e=>(e[e.MIRROR_TYPE_NONE=0]="MIRROR_TYPE_NONE",e[e.MIRROR_TYPE_RENDER=1]="MIRROR_TYPE_RENDER",e))(sh||{}),nh=(e=>(e[e.NORMAL=0]="NORMAL",e[e.DISCONNECT=1]="DISCONNECT",e[e.RESET=2]="RESET",e))(nh||{}),ah=(e=>(e[e.MICROPHONE=0]="MICROPHONE",e[e.AUDIOMIXING=1]="AUDIOMIXING",e))(ah||{}),dh=(e=>(e[e.domestic=0]="domestic",e[e.overseas=1]="overseas",e))(dh||{}),ch=(e=>(e[e.OFFLINE=0]="OFFLINE",e[e.ONLINE=1]="ONLINE",e[e.UNREACHABLE=2]="UNREACHABLE",e))(ch||{}),lh=(e=>(e[e.AUDIO_AND_VIDEO=0]="AUDIO_AND_VIDEO",e[e.AUDIO_ONLY=1]="AUDIO_ONLY",e[e.VIDEO_ONLY=2]="VIDEO_ONLY",e))(lh||{}),uh=(e=>(e[e.PREV_FRAME=0]="PREV_FRAME",e[e.OTHER_FRAME=1]="OTHER_FRAME",e))(uh||{}),hh=(e=>(e[e.DISABLE=0]="DISABLE",e[e.VIDEO_STREAM_LOW=1]="VIDEO_STREAM_LOW",e[e.AUDIO_ONLY=2]="AUDIO_ONLY",e))(hh||{}),_h=(e=>(e[e.LOW=0]="LOW",e[e.MEDIUM=100]="MEDIUM",e[e.HIGH=200]="HIGH",e))(_h||{}),mh=(e=>(e[e.UNKNOWN=0]="UNKNOWN",e[e.EXCELLENT=1]="EXCELLENT",e[e.GOOD=2]="GOOD",e[e.POOR=3]="POOR",e[e.BAD=4]="BAD",e[e.VBAD=5]="VBAD",e[e.DOWN=6]="DOWN",e))(mh||{}),ph=(e=>(e[e.Unknown=-1]="Unknown",e[e.SubscribeFallbackByBandwidth=0]="SubscribeFallbackByBandwidth",e[e.SubscribeRecoverByBandwidth=2]="SubscribeRecoverByBandwidth",e))(ph||{}),vh=(e=>(e[e.communication=0]="communication",e[e.chat=5]="chat",e[e.chatRoom=6]="chatRoom",e[e.coHost=9]="coHost",e[e.meeting=16]="meeting",e[e.classRoom=18]="classRoom",e))(vh||{}),fh=(e=>(e[e.default=0]="default",e[e.fluent=1]="fluent",e[e.standard=2]="standard",e[e.hd=3]="hd",e[e.standardStereo=4]="standardStereo",e[e.hdMono=5]="hdMono",e))(fh||{}),Sh=(e=>(e[e.AUTO_PLAY=0]="AUTO_PLAY",e[e.VIDEO_ONLY=1]="VIDEO_ONLY",e[e.PLAY_MANUALLY=2]="PLAY_MANUALLY",e))(Sh||{}),gh=(e=>(e.LC="LC",e.HEv1="HEv1",e.HEv2="HEv2",e))(gh||{}),yh=(e=>(e.H264="H264",e.H265="H265",e))(yh||{}),bh=(e=>(e[e.ASR_ONLY=0]="ASR_ONLY",e[e.ASR_AND_TRANSLATION=1]="ASR_AND_TRANSLATION",e))(bh||{}),Th=(e=>(e[e.STARTED=0]="STARTED",e[e.STOPPED=1]="STOPPED",e[e.ERROR=2]="ERROR",e[e.UPDATED=3]="UPDATED",e))(Th||{}),Ih=(e=>(e[e.FORWARD_STREAM_STATE_SUCCESS=0]="FORWARD_STREAM_STATE_SUCCESS",e[e.FORWARD_STREAM_STATE_FAILURE=1]="FORWARD_STREAM_STATE_FAILURE",e))(Ih||{}),Eh=(e=>(e[e.FORWARD_STREAM_ERROR_OK=0]="FORWARD_STREAM_ERROR_OK",e[e.FORWARD_STREAM_ERROR_INVALID_TOKEN=1202]="FORWARD_STREAM_ERROR_INVALID_TOKEN",e[e.FORWARD_STREAM_ERROR_RESPONSE=1203]="FORWARD_STREAM_ERROR_RESPONSE",e[e.FORWARD_STREAM_ERROR_REMOTE_KICKED=1204]="FORWARD_STREAM_ERROR_REMOTE_KICKED",e[e.FORWARD_STREAM_ERROR_NOT_SUPPORT=1205]="FORWARD_STREAM_ERROR_NOT_SUPPORT",e))(Eh||{}),Rh=(e=>(e[e.DEFAULT=0]="DEFAULT",e[e.HIGH=1]="HIGH",e))(Rh||{}),Ch=(e=>(e[e.VIDEO_ONLY_ONE=0]="VIDEO_ONLY_ONE",e[e.VIDEO_ON_DEMAND=1]="VIDEO_ON_DEMAND",e[e.VIDEO_ALWAYS_SIMULCAST=2]="VIDEO_ALWAYS_SIMULCAST",e))(Ch||{}),kh=(e=>(e.VIDEO_STREAM_HIGH="high",e.VIDEO_STREAM_MID="mid",e.VIDEO_STREAM_LOW="low",e))(kh||{}),Ah=(e=>(e[e.NONE=0]="NONE",e[e.AFTER_CAPTURE=1]="AFTER_CAPTURE",e[e.AFTER_PROCESS=2]="AFTER_PROCESS",e))(Ah||{}),Ph=(e=>(e[e.ROOM_MODE_RTC=0]="ROOM_MODE_RTC",e[e.ROOM_MODE_RTS_ONLY=1]="ROOM_MODE_RTS_ONLY",e))(Ph||{}),Nh=Object.freeze({__proto__:null,AAC_PROFILE:gh,AudioProfileType:fh,AudioReportMode:ah,AudioSelectionPriority:Rh,AudioSourceType:Yu,ChannelProfile:Bu,ConnectionState:ih,EarMonitorPosition:Ah,FallbackOrRecoverReason:ph,ForwardStreamError:Eh,ForwardStreamState:Ih,LocalMainReportMode:nh,LogChannel:dh,MediaType:eh,MirrorMode:Qu,MirrorType:sh,NetworkQuality:mh,PublicInterpolationMode:uh,PublicStreamType:lh,PublishState:zu,RTCAutoPlayPolicy:Sh,ReconnectReason:oh,RemoteUserPriority:_h,RoomMode:Ph,RoomProfileType:vh,SUBTITLE_MODE:bh,SimulcastStreamType:kh,StreamIndex:$u,StreamRemoveReason:th,SubscribeFallbackOption:hh,SubscribeMode:Ju,SubscribeState:ju,SubtitleEventType:Th,TRANSCODING_VIDEO_CODEC:yh,USER_ONLINE_STATUS:ch,UserOfflineReason:Ku,VideoCodecType:rh,VideoRenderMode:qu,VideoSimulcastMode:Ch,VideoSourceType:Hu}),wh=(e=>(e[e.AUTO=0]="AUTO",e[e.MODE_L=1]="MODE_L",e[e.MODE_R=2]="MODE_R",e[e.MODE_MIX=3]="MODE_MIX",e))(wh||{}),Oh=(e=>(e[e.PLAYOUT=0]="PLAYOUT",e[e.PUBLISH=1]="PUBLISH",e[e.PLAYOUT_AND_PUBLISH=2]="PLAYOUT_AND_PUBLISH",e))(Oh||{}),Mh=(e=>(e[e.AUDIO_MIXING_STATE_PRELOADED=0]="AUDIO_MIXING_STATE_PRELOADED",e[e.AUDIO_MIXING_STATE_PLAYING=1]="AUDIO_MIXING_STATE_PLAYING",e[e.AUDIO_MIXING_STATE_PAUSED=2]="AUDIO_MIXING_STATE_PAUSED",e[e.AUDIO_MIXING_STATE_STOPPED=3]="AUDIO_MIXING_STATE_STOPPED",e[e.AUDIO_MIXING_STATE_FAILED=4]="AUDIO_MIXING_STATE_FAILED",e[e.AUDIO_MIXING_STATE_FINISHED=5]="AUDIO_MIXING_STATE_FINISHED",e[e.AUDIO_MIXING_STATE_PCM_ENABLED=6]="AUDIO_MIXING_STATE_PCM_ENABLED",e[e.AUDIO_MIXING_STATE_PCM_DISABLED=7]="AUDIO_MIXING_STATE_PCM_DISABLED",e))(Mh||{}),Lh=Object.freeze({__proto__:null,AudioMixingDualMonoMode:wh,AudioMixingState:Mh,AudioMixingType:Oh}),xh=(e=>(e.onTrackEnded="onTrackEnded",e.onTrackMute="onTrackMute",e.onTrackUnmute="onTrackUnmute",e.onPlayerEvent="onPlayerEvent",e.onAutoplayFailed="onAutoplayFailed",e.onUserJoined="onUserJoined",e.onUserLeave="onUserLeave",e.onConnectionStateChanged="onConnectionStateChanged",e.onUserPublishStream="onUserPublishStream",e.onUserUnpublishStream="onUserUnpublishStream",e.onUserPublishScreen="onUserPublishScreen",e.onUserUnpublishScreen="onUserUnpublishScreen",e.onRoomMessageReceived="onRoomMessageReceived",e.onRoomBinaryMessageReceived="onRoomBinaryMessageReceived",e.onUserMessageReceived="onUserMessageReceived",e.onUserBinaryMessageReceived="onUserBinaryMessageReceived",e.onVideoFirstFrameRendered="onVideoFirstFrameRendered",e.onVideoFirstFrameDecoded="onVideoFirstFrameDecoded",e.onRemoteVideoFirstFrame="onRemoteVideoFirstFrame",e.onAudioFirstFrameDecoded="onAudioFirstFrameDecoded",e.onRemoteAudioFirstFrame="onRemoteAudioFirstFrame",e.onFirstPublicStreamVideoFrameRendered="onFirstPublicStreamVideoFrameRendered",e.onFirstPublicStreamVideoFrameDecoded="onFirstPublicStreamVideoFrameDecoded",e.onFirstPublicStreamAudioFrameDecoded="onFirstPublicStreamAudioFrameDecoded",e.onVideoDeviceStateChanged="onVideoDeviceStateChanged",e.onAudioDeviceStateChanged="onAudioDeviceStateChanged",e.onRemoteStreamStats="onRemoteStreamStats",e.onPublicStreamStats="onPublicStreamStats",e.onLocalStreamStats="onLocalStreamStats",e.onAudioVolumeIndication="onAudioVolumeIndication",e.onLocalAudioPropertiesReport="onLocalAudioPropertiesReport",e.onRemoteAudioPropertiesReport="onRemoteAudioPropertiesReport",e.onActiveSpeaker="onActiveSpeaker",e.onAudioPlaybackDeviceChanged="onAudioPlaybackDeviceChanged",e.onUserStartVideoCapture="onUserStartVideoCapture",e.onUserStopVideoCapture="onUserStopVideoCapture",e.onUserStartAudioCapture="onUserStartAudioCapture",e.onUserStopAudioCapture="onUserStopAudioCapture",e.onAutoPublishResult="onAutoPublishResult",e.onAutoSubscribeResult="onAutoSubscribeResult",e.onLiveTranscodingResult="onLiveTranscodingResult",e.onStreamMixingEvent="onStreamMixingEvent",e.onAudioPlaybackDeviceTestVolume="onAudioPlaybackDeviceTestVolume",e.onSEIMessageReceived="onSEIMessageReceived",e.onError="onError",e.onAudioMixingStateChanged="onAudioMixingStateChanged",e.onUserMessageReceivedOutsideRoom="onUserMessageReceivedOutsideRoom",e.onUserBinaryMessageReceivedOutsideRoom="onUserBinaryMessageReceivedOutsideRoom",e.onTokenWillExpire="onTokenWillExpire",e.onTokenPublishPrivilegeWillExpire="onTokenPublishPrivilegeWillExpire",e.onTokenPublishPrivilegeDidExpired="onTokenPublishPrivilegeDidExpired",e.onTokenSubscribePrivilegeWillExpire="onTokenSubscribePrivilegeWillExpire",e.onTokenSubscribePrivilegeDidExpired="onTokenSubscribePrivilegeDidExpired",e.onCloudProxyConnected="onCloudProxyConnected",e.onPushPublicStreamResult="onPushPublicStreamResult",e.onPublicStreamSEIMessageReceived="onPublicStreamSEIMessageReceived",e.onNetworkQuality="onNetworkQuality",e.onSimulcastSubscribeFallback="onSimulcastSubscribeFallback",e.onRemoteVideoSizeChanged="onRemoteVideoSizeChanged",e.onVideoStreamBanned="onVideoStreamBanned",e.onAudioStreamBanned="onAudioStreamBanned",e.onLocalVideoSizeChanged="onLocalVideoSizeChanged",e.onSubtitleStateChanged="onSubtitleStateChanged",e.onSubtitleMessageReceived="onSubtitleMessageReceived",e.onServerParamsSetResult="onServerParamsSetResult",e.onLocalStreamTrackChangedByExtension="onLocalStreamTrackChangedByExtension",e.onVendorConnectionStateChanged="onVendorConnectionStateChanged",e.onForwardStreamError="onForwardStreamError",e.onRejoinWithTcp="onRejoinWithTcp",e.onIceConnectWithTcp="onIceConnectWithTcp",e.onPublishRetry="onPublishRetry",e.onSubscribeRetry="onSubscribeRetry",e.onPublishResult="onPublishResult",e.onSubscribeResult="onSubscribeResult",e.onSEIStreamUpdate="onSEIStreamUpdate",e))(xh||{}),Vh=wi,Dh=zr,Uh=f([].reverse),Zh=[1,2];Vh({target:"Array",proto:!0,forced:String(Zh)===String(Zh.reverse())},{reverse:function(){return Dh(this)&&(this.length=this.length),Uh(this)}});var Wh=Xa("Array","reverse"),Xh=se,Gh=Wh,Fh=Array.prototype,Hh=i((function(e){var t=e.reverse;return e===Fh||Xh(Fh,e)&&t===Fh.reverse?Gh:t})),Yh=q,Kh=b,Bh=pt("match"),Jh=function(e){var t;return Yh(e)&&(void 0!==(t=e[Bh])?!!t:"RegExp"===Kh(e))},jh=si,zh=w,Qh=tt,qh=se,$h=function(){var e=jh(this),t="";return e.hasIndices&&(t+="d"),e.global&&(t+="g"),e.ignoreCase&&(t+="i"),e.multiline&&(t+="m"),e.dotAll&&(t+="s"),e.unicode&&(t+="u"),e.unicodeSets&&(t+="v"),e.sticky&&(t+="y"),t},e_=RegExp.prototype,t_=function(e){var t=e.flags;return void 0!==t||"flags"in e_||Qh(e,"flags")||!qh(e_,e)?t:zh($h,e)},i_=f,o_=qe,r_=Math.floor,s_=i_("".charAt),n_=i_("".replace),a_=i_("".slice),d_=/\$([$&'`]|\d{1,2}|<[^>]*>)/g,c_=/\$([$&'`]|\d{1,2})/g,l_=wi,u_=w,h_=f,__=B,m_=C,p_=H,v_=Jh,f_=bo,S_=Le,g_=t_,y_=function(e,t,i,o,r,s){var n=i+e.length,a=o.length,d=c_;return void 0!==r&&(r=o_(r),d=d_),n_(s,d,(function(s,d){var c;switch(s_(d,0)){case"$":return"$";case"&":return e;case"`":return a_(t,0,i);case"'":return a_(t,n);case"<":c=r[a_(d,1,-1)];break;default:var l=+d;if(0===l)return s;if(l>a){var u=r_(l/10);return 0===u?s:u<=a?void 0===o[u-1]?s_(d,1):o[u-1]+s_(d,1):s}c=o[l-1]}return void 0===c?"":c}))},b_=pt("replace"),T_=TypeError,I_=h_("".indexOf),E_=h_("".replace),R_=h_("".slice),C_=Math.max;l_({target:"String",proto:!0},{replaceAll:function(e,t){var i,o,r,s,n,a,d,c,l,u,h=__(this),_=0,m="";if(!p_(e)){if((i=v_(e))&&(o=f_(__(g_(e))),!~I_(o,"g")))throw new T_("`.replaceAll` does not allow non-global regexes");if(r=S_(e,b_))return u_(r,e,h,t);if(i)return E_(f_(h),e,t)}for(s=f_(h),n=f_(e),(a=m_(t))||(t=f_(t)),d=n.length,c=C_(1,d),l=I_(s,n);-1!==l;)u=a?f_(t(n,l,s)):y_(n,s,l,[],void 0,t),m+=R_(s,_,l)+u,_=l+d,l=l+c>s.length?-1:I_(s,n,l+c);return _<s.length&&(m+=R_(s,_)),m}});var k_=Xa("String","replaceAll"),A_=se,P_=k_,N_=String.prototype,w_=i((function(e){var t=e.replaceAll;return"string"==typeof e||e===N_||A_(N_,e)&&t===N_.replaceAll?P_:t})),O_="\t\n\v\f\r Â áââââââââââââ¯âã\u2028\u2029\ufeff",M_=B,L_=bo,x_=O_,V_=f("".replace),D_=RegExp("^["+x_+"]+"),U_=RegExp("(^|[^"+x_+"])["+x_+"]+$"),Z_=function(e){return function(t){var i=L_(M_(t));return 1&e&&(i=V_(i,D_,"")),2&e&&(i=V_(i,U_,"$1")),i}},W_={start:Z_(1),end:Z_(2),trim:Z_(3)},X_=Oc.PROPER,G_=n,F_=O_,H_=W_.trim;wi({target:"String",proto:!0,forced:function(e){return G_((function(){return!!F_[e]()||"âÂá "!=="âÂá "[e]()||X_&&F_[e].name!==e}))}("trim")},{trim:function(){return H_(this)}});var Y_,K_=Xa("String","trim"),B_=se,J_=K_,j_=String.prototype,z_=i((function(e){var t=e.trim;return"string"==typeof e||e===j_||B_(j_,e)&&t===j_.trim?J_:t})),Q_=new Uint8Array(16);function q_(){if(!Y_&&!(Y_="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto)))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return Y_(Q_)}var $_=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;for(var em=[],tm=0;tm<256;++tm)em.push((tm+256).toString(16).substr(1));function im(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=(em[e[t+0]]+em[e[t+1]]+em[e[t+2]]+em[e[t+3]]+"-"+em[e[t+4]]+em[e[t+5]]+"-"+em[e[t+6]]+em[e[t+7]]+"-"+em[e[t+8]]+em[e[t+9]]+"-"+em[e[t+10]]+em[e[t+11]]+em[e[t+12]]+em[e[t+13]]+em[e[t+14]]+em[e[t+15]]).toLowerCase();if(!function(e){return"string"==typeof e&&$_.test(e)}(i))throw TypeError("Stringified UUID is invalid");return i}function om(e,t,i){var o=(e=e||{}).random||(e.rng||q_)();if(o[6]=15&o[6]|64,o[8]=63&o[8]|128,t){i=i||0;for(var r=0;r<16;++r)t[i+r]=o[r];return t}return im(o)}const rm=()=>"undefined"==typeof window,sm=()=>om(),nm=e=>"number"==typeof e;function am(e){return null==e?"undefined | null":"string"==typeof e?e:JSON.stringify({contentHint:e.contentHint,enabled:e.enabled,id:e.id,kind:e.kind,label:e.label,muted:e.muted,readyState:e.readyState})}function dm(e){return null==e?"undefined | null":"string"==typeof e?e:JSON.stringify({id:e.id,active:e.active})}function cm(e){return null==e?"undefined | null":"string"==typeof e?e:JSON.stringify({track:am(e.track)})}function lm(e){return null==e?"undefined | null":"string"==typeof e?e:JSON.stringify({track:am(e.track)})}function um(e){return null==e?"undefined | null":"string"==typeof e?e:JSON.stringify({currentDirection:e.currentDirection,direction:e.direction,mid:e.mid,stopped:e.stopped,receiver:lm(e.receiver),sender:cm(e.sender)})}const hm="@byted/ve-rtc",_m="@byted/ve-rtc-cache-size";var mm=new class{constructor(){Xu(this,"storeKey",void 0),Xu(this,"logLevel",void 0),Xu(this,"LogfileSize",void 0),Xu(this,"db",void 0),Xu(this,"logId",void 0),Xu(this,"cacheLog",void 0),Xu(this,"cachedSize",void 0),Xu(this,"preCacheTime",void 0),Xu(this,"timer",void 0),Xu(this,"_getSize",(e=>new Blob(e).size/1048576)),this.storeKey="",this.logId=1,this.cacheLog="",this.logLevel="none",this.LogfileSize=100,this._createStore()}_createStore(){if(rm()||!window.indexedDB)return;const e=indexedDB.open("@byted/ve-rtc");e.onupgradeneeded=()=>{e.result.createObjectStore(hm);try{localStorage.removeItem(_m)}catch(wZ){}},e.onerror=e=>{},e.onsuccess=()=>{this.db=e.result,this._getCachedSize()}}_getCachedSize(){try{const e=localStorage.getItem(_m);e?this.cachedSize=Number(e):this.values().then((e=>{this.cachedSize=this._getSize(e),this._setCachedSize()}))}catch(wZ){}}_setCachedSize(){try{localStorage.setItem(_m,"".concat(this.cachedSize))}catch(wZ){}}_getStore(e){if(this.db)return this.db.transaction(hm,e).objectStore(hm)}set(e){return new Promise(((t,i)=>{if("none"===this.logLevel)return t();if(e&&this.preCacheTime&&this.preCacheTime-Date.now()<1e3)return this.cacheLog+="\n\n".concat(this.logId,": ").concat(e),this.logId++,this.timer||(this.timer=setTimeout((()=>{this.set("")}),1e3-(this.preCacheTime-Date.now()))),t();clearTimeout(this.timer),this.timer=null;const o=this._getStore("readwrite");if(!o)return i("get store fail");this.cachedSize&&this.cachedSize>this.LogfileSize&&this.keyEarliest().then((e=>{this.get(e).then((t=>{this.del(e).then((()=>{this.cachedSize=this.cachedSize-this._getSize(["".concat(t)]),this._setCachedSize()}))}))}));const r=o.get(this.storeKey);r.onsuccess=()=>{try{const i="".concat(r.result||"").concat(this.cacheLog),s=e?"".concat(i?"\n\n":"").concat(this.logId,": ").concat(e):"";o.put("".concat(i).concat(s),this.storeKey),e&&this.logId++,this.cacheLog="",this.cachedSize=(this.cachedSize||0)+this._getSize(["".concat(this.cacheLog).concat(s)]),this._setCachedSize(),this.preCacheTime=Date.now(),t()}catch(s){if(!e)return i(s);this.cacheLog+="\n\n".concat(this.logId,": ").concat(e),this.logId++,i(s)}},r.onerror=t=>{if(!e)return i(t);this.cacheLog+="\n\n".concat(this.logId,": ").concat(e),this.logId++,i(t)}}))}get(e){return new Promise(((t,i)=>{const o=this._getStore("readonly");if(!o)return i();const r=o.get(e);r.onsuccess=()=>{t(r.result)},r.onerror=e=>{i(e)}}))}del(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.storeKey;return new Promise(((t,i)=>{const o=this._getStore("readwrite");if(!o)return i();const r=o.delete(e);r.onsuccess=()=>t(r.result),r.onerror=e=>i(e)}))}keyEarliest(){return this.keys().then((e=>{let t,i=Date.now();return e.forEach((e=>{if(!e||!e.length)return;const o=e.split("-")[0];Number(o)<i&&(i=Number(o),t=e)})),t}))}keys(){return new Promise(((e,t)=>{const i=this._getStore("readonly");if(!i)return t();if(i.getAllKeys){const o=i.getAllKeys();return o.onsuccess=()=>{e(o.result)},void(o.onerror=()=>{t()})}const o=[];i.openCursor().onsuccess=function(){this.result&&(o.push(this.result.key),this.result.continue())},i.transaction.oncomplete=()=>e(o)}))}values(){return new Promise(((e,t)=>{const i=this._getStore("readonly");if(!i)return t();if(i.getAll){const o=i.getAll();return o.onsuccess=()=>{e(o.result)},void(o.onerror=()=>{t()})}const o=[];i.openCursor().onsuccess=function(){this.result&&(o.push(this.result.value),this.result.continue())},i.transaction.oncomplete=()=>e(o)}))}download(e){e=e||this.storeKey,this.get(e).then((t=>{const i=document.createElement("a");i.download="".concat(e,".txt"),i.href="data:text/paint;utf-8,".concat(t||""),i.click()}))}};let pm=class{constructor(){Xu(this,"_all",{})}on(e,t){const i=this._all[e];i?i.push(t):this._all[e]=[t]}once(e,t){var i=this;const o=function(){t(...arguments),i.off(e,o)};this.on(e,o)}off(e,t){const i=this._all[e];null==i||i.splice(i.indexOf(t)>>>0,1)}emit(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),o=1;o<t;o++)i[o-1]=arguments[o];const r=this._all[e];null==r||r.slice().forEach((e=>e(...i)))}safeEmit(e){try{for(var t=arguments.length,i=new Array(t>1?t-1:0),o=1;o<t;o++)i[o-1]=arguments[o];return this.emit(e,...i)}catch(wZ){console.error(wZ)}}destroy(){this._all={}}};const vm=["UPLOAD_CONSOLE_LENGTH_CUT","UPLOAD_REPORT_LIMIT"];const fm=new class extends pm{constructor(){super(...arguments),Xu(this,"config",{UPLOAD_CONSOLE_ON:!1,UPLOAD_CONSOLE_LENGTH_CUT:200,UPLOAD_REPORT_LIMIT:45e4,ENABLE_REPORT_IDB_BUFFER:!1})}setParameter(e,t){if(function(e){return vm.includes(e)}(e))try{const i=Number(t);if(Number.isNaN(i))return;this.config[e]=i}catch(i){return void console.warn("Cannot convert core lib parameter ".concat(e,":").concat(t," into number"))}else this.config[e]=t;this.emit(e,this.config[e])}getParameter(e){return this.config[e]}getKeys(){return Object.keys(this.config)}};var Sm=zr,gm=Fi,ym=dd,bm=$t,Tm=function(e,t,i,o,r,s,n,a){for(var d,c,l=r,u=0,h=!!n&&bm(n,a);u<o;)u in i&&(d=h?h(i[u],u,t):i[u],s>0&&Sm(d)?(c=gm(d),l=Tm(e,t,d,c,l,s-1)-1):(ym(l+1),e[l]=d),l++),u++;return l},Im=Tm,Em=qe,Rm=Fi,Cm=xi,km=ys;wi({target:"Array",proto:!0},{flat:function(){var e=arguments.length?arguments[0]:void 0,t=Em(this),i=Rm(t),o=km(t,0);return o.length=Im(o,t,t,i,0,void 0===e?1:Cm(e)),o}});var Am=Xa("Array","flat"),Pm=se,Nm=Am,wm=Array.prototype,Om=i((function(e){var t=e.flat;return e===wm||Pm(wm,e)&&t===wm.flat?Nm:t})),Mm={};!function(e){var t="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Int32Array;function i(e,t){return Object.prototype.hasOwnProperty.call(e,t)}e.assign=function(e){for(var t=Array.prototype.slice.call(arguments,1);t.length;){var o=t.shift();if(o){if("object"!=typeof o)throw new TypeError(o+"must be non-object");for(var r in o)i(o,r)&&(e[r]=o[r])}}return e},e.shrinkBuf=function(e,t){return e.length===t?e:e.subarray?e.subarray(0,t):(e.length=t,e)};var o={arraySet:function(e,t,i,o,r){if(t.subarray&&e.subarray)e.set(t.subarray(i,i+o),r);else for(var s=0;s<o;s++)e[r+s]=t[i+s]},flattenChunks:function(e){var t,i,o,r,s,n;for(o=0,t=0,i=e.length;t<i;t++)o+=e[t].length;for(n=new Uint8Array(o),r=0,t=0,i=e.length;t<i;t++)s=e[t],n.set(s,r),r+=s.length;return n}},r={arraySet:function(e,t,i,o,r){for(var s=0;s<o;s++)e[r+s]=t[i+s]},flattenChunks:function(e){return[].concat.apply([],e)}};e.setTyped=function(t){t?(e.Buf8=Uint8Array,e.Buf16=Uint16Array,e.Buf32=Int32Array,e.assign(e,o)):(e.Buf8=Array,e.Buf16=Array,e.Buf32=Array,e.assign(e,r))},e.setTyped(t)}(Mm);var Lm={},xm={},Vm={},Dm=Mm;function Um(e){for(var t=e.length;--t>=0;)e[t]=0}var Zm=256,Wm=286,Xm=30,Gm=15,Fm=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],Hm=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],Ym=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],Km=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],Bm=new Array(576);Um(Bm);var Jm=new Array(60);Um(Jm);var jm=new Array(512);Um(jm);var zm=new Array(256);Um(zm);var Qm=new Array(29);Um(Qm);var qm,$m,ep,tp=new Array(Xm);function ip(e,t,i,o,r){this.static_tree=e,this.extra_bits=t,this.extra_base=i,this.elems=o,this.max_length=r,this.has_stree=e&&e.length}function op(e,t){this.dyn_tree=e,this.max_code=0,this.stat_desc=t}function rp(e){return e<256?jm[e]:jm[256+(e>>>7)]}function sp(e,t){e.pending_buf[e.pending++]=255&t,e.pending_buf[e.pending++]=t>>>8&255}function np(e,t,i){e.bi_valid>16-i?(e.bi_buf|=t<<e.bi_valid&65535,sp(e,e.bi_buf),e.bi_buf=t>>16-e.bi_valid,e.bi_valid+=i-16):(e.bi_buf|=t<<e.bi_valid&65535,e.bi_valid+=i)}function ap(e,t,i){np(e,i[2*t],i[2*t+1])}function dp(e,t){var i=0;do{i|=1&e,e>>>=1,i<<=1}while(--t>0);return i>>>1}function cp(e,t,i){var o,r,s=new Array(16),n=0;for(o=1;o<=Gm;o++)s[o]=n=n+i[o-1]<<1;for(r=0;r<=t;r++){var a=e[2*r+1];0!==a&&(e[2*r]=dp(s[a]++,a))}}function lp(e){var t;for(t=0;t<Wm;t++)e.dyn_ltree[2*t]=0;for(t=0;t<Xm;t++)e.dyn_dtree[2*t]=0;for(t=0;t<19;t++)e.bl_tree[2*t]=0;e.dyn_ltree[512]=1,e.opt_len=e.static_len=0,e.last_lit=e.matches=0}function up(e){e.bi_valid>8?sp(e,e.bi_buf):e.bi_valid>0&&(e.pending_buf[e.pending++]=e.bi_buf),e.bi_buf=0,e.bi_valid=0}function hp(e,t,i,o){var r=2*t,s=2*i;return e[r]<e[s]||e[r]===e[s]&&o[t]<=o[i]}function _p(e,t,i){for(var o=e.heap[i],r=i<<1;r<=e.heap_len&&(r<e.heap_len&&hp(t,e.heap[r+1],e.heap[r],e.depth)&&r++,!hp(t,o,e.heap[r],e.depth));)e.heap[i]=e.heap[r],i=r,r<<=1;e.heap[i]=o}function mp(e,t,i){var o,r,s,n,a=0;if(0!==e.last_lit)do{o=e.pending_buf[e.d_buf+2*a]<<8|e.pending_buf[e.d_buf+2*a+1],r=e.pending_buf[e.l_buf+a],a++,0===o?ap(e,r,t):(ap(e,(s=zm[r])+Zm+1,t),0!==(n=Fm[s])&&np(e,r-=Qm[s],n),ap(e,s=rp(--o),i),0!==(n=Hm[s])&&np(e,o-=tp[s],n))}while(a<e.last_lit);ap(e,256,t)}function pp(e,t){var i,o,r,s=t.dyn_tree,n=t.stat_desc.static_tree,a=t.stat_desc.has_stree,d=t.stat_desc.elems,c=-1;for(e.heap_len=0,e.heap_max=573,i=0;i<d;i++)0!==s[2*i]?(e.heap[++e.heap_len]=c=i,e.depth[i]=0):s[2*i+1]=0;for(;e.heap_len<2;)s[2*(r=e.heap[++e.heap_len]=c<2?++c:0)]=1,e.depth[r]=0,e.opt_len--,a&&(e.static_len-=n[2*r+1]);for(t.max_code=c,i=e.heap_len>>1;i>=1;i--)_p(e,s,i);r=d;do{i=e.heap[1],e.heap[1]=e.heap[e.heap_len--],_p(e,s,1),o=e.heap[1],e.heap[--e.heap_max]=i,e.heap[--e.heap_max]=o,s[2*r]=s[2*i]+s[2*o],e.depth[r]=(e.depth[i]>=e.depth[o]?e.depth[i]:e.depth[o])+1,s[2*i+1]=s[2*o+1]=r,e.heap[1]=r++,_p(e,s,1)}while(e.heap_len>=2);e.heap[--e.heap_max]=e.heap[1],function(e,t){var i,o,r,s,n,a,d=t.dyn_tree,c=t.max_code,l=t.stat_desc.static_tree,u=t.stat_desc.has_stree,h=t.stat_desc.extra_bits,_=t.stat_desc.extra_base,m=t.stat_desc.max_length,p=0;for(s=0;s<=Gm;s++)e.bl_count[s]=0;for(d[2*e.heap[e.heap_max]+1]=0,i=e.heap_max+1;i<573;i++)(s=d[2*d[2*(o=e.heap[i])+1]+1]+1)>m&&(s=m,p++),d[2*o+1]=s,o>c||(e.bl_count[s]++,n=0,o>=_&&(n=h[o-_]),a=d[2*o],e.opt_len+=a*(s+n),u&&(e.static_len+=a*(l[2*o+1]+n)));if(0!==p){do{for(s=m-1;0===e.bl_count[s];)s--;e.bl_count[s]--,e.bl_count[s+1]+=2,e.bl_count[m]--,p-=2}while(p>0);for(s=m;0!==s;s--)for(o=e.bl_count[s];0!==o;)(r=e.heap[--i])>c||(d[2*r+1]!==s&&(e.opt_len+=(s-d[2*r+1])*d[2*r],d[2*r+1]=s),o--)}}(e,t),cp(s,c,e.bl_count)}function vp(e,t,i){var o,r,s=-1,n=t[1],a=0,d=7,c=4;for(0===n&&(d=138,c=3),t[2*(i+1)+1]=65535,o=0;o<=i;o++)r=n,n=t[2*(o+1)+1],++a<d&&r===n||(a<c?e.bl_tree[2*r]+=a:0!==r?(r!==s&&e.bl_tree[2*r]++,e.bl_tree[32]++):a<=10?e.bl_tree[34]++:e.bl_tree[36]++,a=0,s=r,0===n?(d=138,c=3):r===n?(d=6,c=3):(d=7,c=4))}function fp(e,t,i){var o,r,s=-1,n=t[1],a=0,d=7,c=4;for(0===n&&(d=138,c=3),o=0;o<=i;o++)if(r=n,n=t[2*(o+1)+1],!(++a<d&&r===n)){if(a<c)do{ap(e,r,e.bl_tree)}while(0!=--a);else 0!==r?(r!==s&&(ap(e,r,e.bl_tree),a--),ap(e,16,e.bl_tree),np(e,a-3,2)):a<=10?(ap(e,17,e.bl_tree),np(e,a-3,3)):(ap(e,18,e.bl_tree),np(e,a-11,7));a=0,s=r,0===n?(d=138,c=3):r===n?(d=6,c=3):(d=7,c=4)}}Um(tp);var Sp=!1;function gp(e,t,i,o){np(e,0+(o?1:0),3),function(e,t,i,o){up(e),o&&(sp(e,i),sp(e,~i)),Dm.arraySet(e.pending_buf,e.window,t,i,e.pending),e.pending+=i}(e,t,i,!0)}Vm._tr_init=function(e){Sp||(!function(){var e,t,i,o,r,s=new Array(16);for(i=0,o=0;o<28;o++)for(Qm[o]=i,e=0;e<1<<Fm[o];e++)zm[i++]=o;for(zm[i-1]=o,r=0,o=0;o<16;o++)for(tp[o]=r,e=0;e<1<<Hm[o];e++)jm[r++]=o;for(r>>=7;o<Xm;o++)for(tp[o]=r<<7,e=0;e<1<<Hm[o]-7;e++)jm[256+r++]=o;for(t=0;t<=Gm;t++)s[t]=0;for(e=0;e<=143;)Bm[2*e+1]=8,e++,s[8]++;for(;e<=255;)Bm[2*e+1]=9,e++,s[9]++;for(;e<=279;)Bm[2*e+1]=7,e++,s[7]++;for(;e<=287;)Bm[2*e+1]=8,e++,s[8]++;for(cp(Bm,287,s),e=0;e<Xm;e++)Jm[2*e+1]=5,Jm[2*e]=dp(e,5);qm=new ip(Bm,Fm,257,Wm,Gm),$m=new ip(Jm,Hm,0,Xm,Gm),ep=new ip(new Array(0),Ym,0,19,7)}(),Sp=!0),e.l_desc=new op(e.dyn_ltree,qm),e.d_desc=new op(e.dyn_dtree,$m),e.bl_desc=new op(e.bl_tree,ep),e.bi_buf=0,e.bi_valid=0,lp(e)},Vm._tr_stored_block=gp,Vm._tr_flush_block=function(e,t,i,o){var r,s,n=0;e.level>0?(2===e.strm.data_type&&(e.strm.data_type=function(e){var t,i=4093624447;for(t=0;t<=31;t++,i>>>=1)if(1&i&&0!==e.dyn_ltree[2*t])return 0;if(0!==e.dyn_ltree[18]||0!==e.dyn_ltree[20]||0!==e.dyn_ltree[26])return 1;for(t=32;t<Zm;t++)if(0!==e.dyn_ltree[2*t])return 1;return 0}(e)),pp(e,e.l_desc),pp(e,e.d_desc),n=function(e){var t;for(vp(e,e.dyn_ltree,e.l_desc.max_code),vp(e,e.dyn_dtree,e.d_desc.max_code),pp(e,e.bl_desc),t=18;t>=3&&0===e.bl_tree[2*Km[t]+1];t--);return e.opt_len+=3*(t+1)+5+5+4,t}(e),r=e.opt_len+3+7>>>3,(s=e.static_len+3+7>>>3)<=r&&(r=s)):r=s=i+5,i+4<=r&&-1!==t?gp(e,t,i,o):4===e.strategy||s===r?(np(e,2+(o?1:0),3),mp(e,Bm,Jm)):(np(e,4+(o?1:0),3),function(e,t,i,o){var r;for(np(e,t-257,5),np(e,i-1,5),np(e,o-4,4),r=0;r<o;r++)np(e,e.bl_tree[2*Km[r]+1],3);fp(e,e.dyn_ltree,t-1),fp(e,e.dyn_dtree,i-1)}(e,e.l_desc.max_code+1,e.d_desc.max_code+1,n+1),mp(e,e.dyn_ltree,e.dyn_dtree)),lp(e),o&&up(e)},Vm._tr_tally=function(e,t,i){return e.pending_buf[e.d_buf+2*e.last_lit]=t>>>8&255,e.pending_buf[e.d_buf+2*e.last_lit+1]=255&t,e.pending_buf[e.l_buf+e.last_lit]=255&i,e.last_lit++,0===t?e.dyn_ltree[2*i]++:(e.matches++,t--,e.dyn_ltree[2*(zm[i]+Zm+1)]++,e.dyn_dtree[2*rp(t)]++),e.last_lit===e.lit_bufsize-1},Vm._tr_align=function(e){np(e,2,3),ap(e,256,Bm),function(e){16===e.bi_valid?(sp(e,e.bi_buf),e.bi_buf=0,e.bi_valid=0):e.bi_valid>=8&&(e.pending_buf[e.pending++]=255&e.bi_buf,e.bi_buf>>=8,e.bi_valid-=8)}(e)};var yp=function(e,t,i,o){for(var r=65535&e,s=e>>>16&65535,n=0;0!==i;){i-=n=i>2e3?2e3:i;do{s=s+(r=r+t[o++]|0)|0}while(--n);r%=65521,s%=65521}return r|s<<16};var bp=function(){for(var e,t=[],i=0;i<256;i++){e=i;for(var o=0;o<8;o++)e=1&e?3988292384^e>>>1:e>>>1;t[i]=e}return t}();var Tp,Ip=function(e,t,i,o){var r=bp,s=o+i;e^=-1;for(var n=o;n<s;n++)e=e>>>8^r[255&(e^t[n])];return~e},Ep={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"},Rp=Mm,Cp=Vm,kp=yp,Ap=Ip,Pp=Ep,Np=-2,wp=258,Op=262,Mp=103,Lp=113,xp=666;function Vp(e,t){return e.msg=Pp[t],t}function Dp(e){return(e<<1)-(e>4?9:0)}function Up(e){for(var t=e.length;--t>=0;)e[t]=0}function Zp(e){var t=e.state,i=t.pending;i>e.avail_out&&(i=e.avail_out),0!==i&&(Rp.arraySet(e.output,t.pending_buf,t.pending_out,i,e.next_out),e.next_out+=i,t.pending_out+=i,e.total_out+=i,e.avail_out-=i,t.pending-=i,0===t.pending&&(t.pending_out=0))}function Wp(e,t){Cp._tr_flush_block(e,e.block_start>=0?e.block_start:-1,e.strstart-e.block_start,t),e.block_start=e.strstart,Zp(e.strm)}function Xp(e,t){e.pending_buf[e.pending++]=t}function Gp(e,t){e.pending_buf[e.pending++]=t>>>8&255,e.pending_buf[e.pending++]=255&t}function Fp(e,t){var i,o,r=e.max_chain_length,s=e.strstart,n=e.prev_length,a=e.nice_match,d=e.strstart>e.w_size-Op?e.strstart-(e.w_size-Op):0,c=e.window,l=e.w_mask,u=e.prev,h=e.strstart+wp,_=c[s+n-1],m=c[s+n];e.prev_length>=e.good_match&&(r>>=2),a>e.lookahead&&(a=e.lookahead);do{if(c[(i=t)+n]===m&&c[i+n-1]===_&&c[i]===c[s]&&c[++i]===c[s+1]){s+=2,i++;do{}while(c[++s]===c[++i]&&c[++s]===c[++i]&&c[++s]===c[++i]&&c[++s]===c[++i]&&c[++s]===c[++i]&&c[++s]===c[++i]&&c[++s]===c[++i]&&c[++s]===c[++i]&&s<h);if(o=wp-(h-s),s=h-wp,o>n){if(e.match_start=t,n=o,o>=a)break;_=c[s+n-1],m=c[s+n]}}}while((t=u[t&l])>d&&0!=--r);return n<=e.lookahead?n:e.lookahead}function Hp(e){var t,i,o,r,s,n,a,d,c,l,u=e.w_size;do{if(r=e.window_size-e.lookahead-e.strstart,e.strstart>=u+(u-Op)){Rp.arraySet(e.window,e.window,u,u,0),e.match_start-=u,e.strstart-=u,e.block_start-=u,t=i=e.hash_size;do{o=e.head[--t],e.head[t]=o>=u?o-u:0}while(--i);t=i=u;do{o=e.prev[--t],e.prev[t]=o>=u?o-u:0}while(--i);r+=u}if(0===e.strm.avail_in)break;if(n=e.strm,a=e.window,d=e.strstart+e.lookahead,c=r,l=void 0,(l=n.avail_in)>c&&(l=c),i=0===l?0:(n.avail_in-=l,Rp.arraySet(a,n.input,n.next_in,l,d),1===n.state.wrap?n.adler=kp(n.adler,a,l,d):2===n.state.wrap&&(n.adler=Ap(n.adler,a,l,d)),n.next_in+=l,n.total_in+=l,l),e.lookahead+=i,e.lookahead+e.insert>=3)for(s=e.strstart-e.insert,e.ins_h=e.window[s],e.ins_h=(e.ins_h<<e.hash_shift^e.window[s+1])&e.hash_mask;e.insert&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[s+3-1])&e.hash_mask,e.prev[s&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=s,s++,e.insert--,!(e.lookahead+e.insert<3)););}while(e.lookahead<Op&&0!==e.strm.avail_in)}function Yp(e,t){for(var i,o;;){if(e.lookahead<Op){if(Hp(e),e.lookahead<Op&&0===t)return 1;if(0===e.lookahead)break}if(i=0,e.lookahead>=3&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+3-1])&e.hash_mask,i=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),0!==i&&e.strstart-i<=e.w_size-Op&&(e.match_length=Fp(e,i)),e.match_length>=3)if(o=Cp._tr_tally(e,e.strstart-e.match_start,e.match_length-3),e.lookahead-=e.match_length,e.match_length<=e.max_lazy_match&&e.lookahead>=3){e.match_length--;do{e.strstart++,e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+3-1])&e.hash_mask,i=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart}while(0!=--e.match_length);e.strstart++}else e.strstart+=e.match_length,e.match_length=0,e.ins_h=e.window[e.strstart],e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+1])&e.hash_mask;else o=Cp._tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++;if(o&&(Wp(e,!1),0===e.strm.avail_out))return 1}return e.insert=e.strstart<2?e.strstart:2,4===t?(Wp(e,!0),0===e.strm.avail_out?3:4):e.last_lit&&(Wp(e,!1),0===e.strm.avail_out)?1:2}function Kp(e,t){for(var i,o,r;;){if(e.lookahead<Op){if(Hp(e),e.lookahead<Op&&0===t)return 1;if(0===e.lookahead)break}if(i=0,e.lookahead>=3&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+3-1])&e.hash_mask,i=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),e.prev_length=e.match_length,e.prev_match=e.match_start,e.match_length=2,0!==i&&e.prev_length<e.max_lazy_match&&e.strstart-i<=e.w_size-Op&&(e.match_length=Fp(e,i),e.match_length<=5&&(1===e.strategy||3===e.match_length&&e.strstart-e.match_start>4096)&&(e.match_length=2)),e.prev_length>=3&&e.match_length<=e.prev_length){r=e.strstart+e.lookahead-3,o=Cp._tr_tally(e,e.strstart-1-e.prev_match,e.prev_length-3),e.lookahead-=e.prev_length-1,e.prev_length-=2;do{++e.strstart<=r&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+3-1])&e.hash_mask,i=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart)}while(0!=--e.prev_length);if(e.match_available=0,e.match_length=2,e.strstart++,o&&(Wp(e,!1),0===e.strm.avail_out))return 1}else if(e.match_available){if((o=Cp._tr_tally(e,0,e.window[e.strstart-1]))&&Wp(e,!1),e.strstart++,e.lookahead--,0===e.strm.avail_out)return 1}else e.match_available=1,e.strstart++,e.lookahead--}return e.match_available&&(o=Cp._tr_tally(e,0,e.window[e.strstart-1]),e.match_available=0),e.insert=e.strstart<2?e.strstart:2,4===t?(Wp(e,!0),0===e.strm.avail_out?3:4):e.last_lit&&(Wp(e,!1),0===e.strm.avail_out)?1:2}function Bp(e,t,i,o,r){this.good_length=e,this.max_lazy=t,this.nice_length=i,this.max_chain=o,this.func=r}function Jp(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=8,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new Rp.Buf16(1146),this.dyn_dtree=new Rp.Buf16(122),this.bl_tree=new Rp.Buf16(78),Up(this.dyn_ltree),Up(this.dyn_dtree),Up(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new Rp.Buf16(16),this.heap=new Rp.Buf16(573),Up(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new Rp.Buf16(573),Up(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}function jp(e){var t;return e&&e.state?(e.total_in=e.total_out=0,e.data_type=2,(t=e.state).pending=0,t.pending_out=0,t.wrap<0&&(t.wrap=-t.wrap),t.status=t.wrap?42:Lp,e.adler=2===t.wrap?0:1,t.last_flush=0,Cp._tr_init(t),0):Vp(e,Np)}function zp(e){var t,i=jp(e);return 0===i&&((t=e.state).window_size=2*t.w_size,Up(t.head),t.max_lazy_match=Tp[t.level].max_lazy,t.good_match=Tp[t.level].good_length,t.nice_match=Tp[t.level].nice_length,t.max_chain_length=Tp[t.level].max_chain,t.strstart=0,t.block_start=0,t.lookahead=0,t.insert=0,t.match_length=t.prev_length=2,t.match_available=0,t.ins_h=0),i}function Qp(e,t,i,o,r,s){if(!e)return Np;var n=1;if(-1===t&&(t=6),o<0?(n=0,o=-o):o>15&&(n=2,o-=16),r<1||r>9||8!==i||o<8||o>15||t<0||t>9||s<0||s>4)return Vp(e,Np);8===o&&(o=9);var a=new Jp;return e.state=a,a.strm=e,a.wrap=n,a.gzhead=null,a.w_bits=o,a.w_size=1<<a.w_bits,a.w_mask=a.w_size-1,a.hash_bits=r+7,a.hash_size=1<<a.hash_bits,a.hash_mask=a.hash_size-1,a.hash_shift=~~((a.hash_bits+3-1)/3),a.window=new Rp.Buf8(2*a.w_size),a.head=new Rp.Buf16(a.hash_size),a.prev=new Rp.Buf16(a.w_size),a.lit_bufsize=1<<r+6,a.pending_buf_size=4*a.lit_bufsize,a.pending_buf=new Rp.Buf8(a.pending_buf_size),a.d_buf=1*a.lit_bufsize,a.l_buf=3*a.lit_bufsize,a.level=t,a.strategy=s,a.method=i,zp(e)}Tp=[new Bp(0,0,0,0,(function(e,t){var i=65535;for(i>e.pending_buf_size-5&&(i=e.pending_buf_size-5);;){if(e.lookahead<=1){if(Hp(e),0===e.lookahead&&0===t)return 1;if(0===e.lookahead)break}e.strstart+=e.lookahead,e.lookahead=0;var o=e.block_start+i;if((0===e.strstart||e.strstart>=o)&&(e.lookahead=e.strstart-o,e.strstart=o,Wp(e,!1),0===e.strm.avail_out))return 1;if(e.strstart-e.block_start>=e.w_size-Op&&(Wp(e,!1),0===e.strm.avail_out))return 1}return e.insert=0,4===t?(Wp(e,!0),0===e.strm.avail_out?3:4):(e.strstart>e.block_start&&(Wp(e,!1),e.strm.avail_out),1)})),new Bp(4,4,8,4,Yp),new Bp(4,5,16,8,Yp),new Bp(4,6,32,32,Yp),new Bp(4,4,16,16,Kp),new Bp(8,16,32,32,Kp),new Bp(8,16,128,128,Kp),new Bp(8,32,128,256,Kp),new Bp(32,128,258,1024,Kp),new Bp(32,258,258,4096,Kp)],xm.deflateInit=function(e,t){return Qp(e,t,8,15,8,0)},xm.deflateInit2=Qp,xm.deflateReset=zp,xm.deflateResetKeep=jp,xm.deflateSetHeader=function(e,t){return e&&e.state?2!==e.state.wrap?Np:(e.state.gzhead=t,0):Np},xm.deflate=function(e,t){var i,o,r,s;if(!e||!e.state||t>5||t<0)return e?Vp(e,Np):Np;if(o=e.state,!e.output||!e.input&&0!==e.avail_in||o.status===xp&&4!==t)return Vp(e,0===e.avail_out?-5:Np);if(o.strm=e,i=o.last_flush,o.last_flush=t,42===o.status)if(2===o.wrap)e.adler=0,Xp(o,31),Xp(o,139),Xp(o,8),o.gzhead?(Xp(o,(o.gzhead.text?1:0)+(o.gzhead.hcrc?2:0)+(o.gzhead.extra?4:0)+(o.gzhead.name?8:0)+(o.gzhead.comment?16:0)),Xp(o,255&o.gzhead.time),Xp(o,o.gzhead.time>>8&255),Xp(o,o.gzhead.time>>16&255),Xp(o,o.gzhead.time>>24&255),Xp(o,9===o.level?2:o.strategy>=2||o.level<2?4:0),Xp(o,255&o.gzhead.os),o.gzhead.extra&&o.gzhead.extra.length&&(Xp(o,255&o.gzhead.extra.length),Xp(o,o.gzhead.extra.length>>8&255)),o.gzhead.hcrc&&(e.adler=Ap(e.adler,o.pending_buf,o.pending,0)),o.gzindex=0,o.status=69):(Xp(o,0),Xp(o,0),Xp(o,0),Xp(o,0),Xp(o,0),Xp(o,9===o.level?2:o.strategy>=2||o.level<2?4:0),Xp(o,3),o.status=Lp);else{var n=8+(o.w_bits-8<<4)<<8;n|=(o.strategy>=2||o.level<2?0:o.level<6?1:6===o.level?2:3)<<6,0!==o.strstart&&(n|=32),n+=31-n%31,o.status=Lp,Gp(o,n),0!==o.strstart&&(Gp(o,e.adler>>>16),Gp(o,65535&e.adler)),e.adler=1}if(69===o.status)if(o.gzhead.extra){for(r=o.pending;o.gzindex<(65535&o.gzhead.extra.length)&&(o.pending!==o.pending_buf_size||(o.gzhead.hcrc&&o.pending>r&&(e.adler=Ap(e.adler,o.pending_buf,o.pending-r,r)),Zp(e),r=o.pending,o.pending!==o.pending_buf_size));)Xp(o,255&o.gzhead.extra[o.gzindex]),o.gzindex++;o.gzhead.hcrc&&o.pending>r&&(e.adler=Ap(e.adler,o.pending_buf,o.pending-r,r)),o.gzindex===o.gzhead.extra.length&&(o.gzindex=0,o.status=73)}else o.status=73;if(73===o.status)if(o.gzhead.name){r=o.pending;do{if(o.pending===o.pending_buf_size&&(o.gzhead.hcrc&&o.pending>r&&(e.adler=Ap(e.adler,o.pending_buf,o.pending-r,r)),Zp(e),r=o.pending,o.pending===o.pending_buf_size)){s=1;break}s=o.gzindex<o.gzhead.name.length?255&o.gzhead.name.charCodeAt(o.gzindex++):0,Xp(o,s)}while(0!==s);o.gzhead.hcrc&&o.pending>r&&(e.adler=Ap(e.adler,o.pending_buf,o.pending-r,r)),0===s&&(o.gzindex=0,o.status=91)}else o.status=91;if(91===o.status)if(o.gzhead.comment){r=o.pending;do{if(o.pending===o.pending_buf_size&&(o.gzhead.hcrc&&o.pending>r&&(e.adler=Ap(e.adler,o.pending_buf,o.pending-r,r)),Zp(e),r=o.pending,o.pending===o.pending_buf_size)){s=1;break}s=o.gzindex<o.gzhead.comment.length?255&o.gzhead.comment.charCodeAt(o.gzindex++):0,Xp(o,s)}while(0!==s);o.gzhead.hcrc&&o.pending>r&&(e.adler=Ap(e.adler,o.pending_buf,o.pending-r,r)),0===s&&(o.status=Mp)}else o.status=Mp;if(o.status===Mp&&(o.gzhead.hcrc?(o.pending+2>o.pending_buf_size&&Zp(e),o.pending+2<=o.pending_buf_size&&(Xp(o,255&e.adler),Xp(o,e.adler>>8&255),e.adler=0,o.status=Lp)):o.status=Lp),0!==o.pending){if(Zp(e),0===e.avail_out)return o.last_flush=-1,0}else if(0===e.avail_in&&Dp(t)<=Dp(i)&&4!==t)return Vp(e,-5);if(o.status===xp&&0!==e.avail_in)return Vp(e,-5);if(0!==e.avail_in||0!==o.lookahead||0!==t&&o.status!==xp){var a=2===o.strategy?function(e,t){for(var i;;){if(0===e.lookahead&&(Hp(e),0===e.lookahead)){if(0===t)return 1;break}if(e.match_length=0,i=Cp._tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++,i&&(Wp(e,!1),0===e.strm.avail_out))return 1}return e.insert=0,4===t?(Wp(e,!0),0===e.strm.avail_out?3:4):e.last_lit&&(Wp(e,!1),0===e.strm.avail_out)?1:2}(o,t):3===o.strategy?function(e,t){for(var i,o,r,s,n=e.window;;){if(e.lookahead<=wp){if(Hp(e),e.lookahead<=wp&&0===t)return 1;if(0===e.lookahead)break}if(e.match_length=0,e.lookahead>=3&&e.strstart>0&&(o=n[r=e.strstart-1])===n[++r]&&o===n[++r]&&o===n[++r]){s=e.strstart+wp;do{}while(o===n[++r]&&o===n[++r]&&o===n[++r]&&o===n[++r]&&o===n[++r]&&o===n[++r]&&o===n[++r]&&o===n[++r]&&r<s);e.match_length=wp-(s-r),e.match_length>e.lookahead&&(e.match_length=e.lookahead)}if(e.match_length>=3?(i=Cp._tr_tally(e,1,e.match_length-3),e.lookahead-=e.match_length,e.strstart+=e.match_length,e.match_length=0):(i=Cp._tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++),i&&(Wp(e,!1),0===e.strm.avail_out))return 1}return e.insert=0,4===t?(Wp(e,!0),0===e.strm.avail_out?3:4):e.last_lit&&(Wp(e,!1),0===e.strm.avail_out)?1:2}(o,t):Tp[o.level].func(o,t);if(3!==a&&4!==a||(o.status=xp),1===a||3===a)return 0===e.avail_out&&(o.last_flush=-1),0;if(2===a&&(1===t?Cp._tr_align(o):5!==t&&(Cp._tr_stored_block(o,0,0,!1),3===t&&(Up(o.head),0===o.lookahead&&(o.strstart=0,o.block_start=0,o.insert=0))),Zp(e),0===e.avail_out))return o.last_flush=-1,0}return 4!==t?0:o.wrap<=0?1:(2===o.wrap?(Xp(o,255&e.adler),Xp(o,e.adler>>8&255),Xp(o,e.adler>>16&255),Xp(o,e.adler>>24&255),Xp(o,255&e.total_in),Xp(o,e.total_in>>8&255),Xp(o,e.total_in>>16&255),Xp(o,e.total_in>>24&255)):(Gp(o,e.adler>>>16),Gp(o,65535&e.adler)),Zp(e),o.wrap>0&&(o.wrap=-o.wrap),0!==o.pending?0:1)},xm.deflateEnd=function(e){var t;return e&&e.state?42!==(t=e.state.status)&&69!==t&&73!==t&&91!==t&&t!==Mp&&t!==Lp&&t!==xp?Vp(e,Np):(e.state=null,t===Lp?Vp(e,-3):0):Np},xm.deflateSetDictionary=function(e,t){var i,o,r,s,n,a,d,c,l=t.length;if(!e||!e.state)return Np;if(2===(s=(i=e.state).wrap)||1===s&&42!==i.status||i.lookahead)return Np;for(1===s&&(e.adler=kp(e.adler,t,l,0)),i.wrap=0,l>=i.w_size&&(0===s&&(Up(i.head),i.strstart=0,i.block_start=0,i.insert=0),c=new Rp.Buf8(i.w_size),Rp.arraySet(c,t,l-i.w_size,i.w_size,0),t=c,l=i.w_size),n=e.avail_in,a=e.next_in,d=e.input,e.avail_in=l,e.next_in=0,e.input=t,Hp(i);i.lookahead>=3;){o=i.strstart,r=i.lookahead-2;do{i.ins_h=(i.ins_h<<i.hash_shift^i.window[o+3-1])&i.hash_mask,i.prev[o&i.w_mask]=i.head[i.ins_h],i.head[i.ins_h]=o,o++}while(--r);i.strstart=o,i.lookahead=2,Hp(i)}return i.strstart+=i.lookahead,i.block_start=i.strstart,i.insert=i.lookahead,i.lookahead=0,i.match_length=i.prev_length=2,i.match_available=0,e.next_in=a,e.input=d,e.avail_in=n,i.wrap=s,0},xm.deflateInfo="pako deflate (from Nodeca project)";var qp={},$p=Mm,ev=!0,tv=!0;try{String.fromCharCode.apply(null,[0])}catch(OZ){ev=!1}try{String.fromCharCode.apply(null,new Uint8Array(1))}catch(OZ){tv=!1}for(var iv=new $p.Buf8(256),ov=0;ov<256;ov++)iv[ov]=ov>=252?6:ov>=248?5:ov>=240?4:ov>=224?3:ov>=192?2:1;function rv(e,t){if(t<65534&&(e.subarray&&tv||!e.subarray&&ev))return String.fromCharCode.apply(null,$p.shrinkBuf(e,t));for(var i="",o=0;o<t;o++)i+=String.fromCharCode(e[o]);return i}iv[254]=iv[254]=1,qp.string2buf=function(e){var t,i,o,r,s,n=e.length,a=0;for(r=0;r<n;r++)55296==(64512&(i=e.charCodeAt(r)))&&r+1<n&&56320==(64512&(o=e.charCodeAt(r+1)))&&(i=65536+(i-55296<<10)+(o-56320),r++),a+=i<128?1:i<2048?2:i<65536?3:4;for(t=new $p.Buf8(a),s=0,r=0;s<a;r++)55296==(64512&(i=e.charCodeAt(r)))&&r+1<n&&56320==(64512&(o=e.charCodeAt(r+1)))&&(i=65536+(i-55296<<10)+(o-56320),r++),i<128?t[s++]=i:i<2048?(t[s++]=192|i>>>6,t[s++]=128|63&i):i<65536?(t[s++]=224|i>>>12,t[s++]=128|i>>>6&63,t[s++]=128|63&i):(t[s++]=240|i>>>18,t[s++]=128|i>>>12&63,t[s++]=128|i>>>6&63,t[s++]=128|63&i);return t},qp.buf2binstring=function(e){return rv(e,e.length)},qp.binstring2buf=function(e){for(var t=new $p.Buf8(e.length),i=0,o=t.length;i<o;i++)t[i]=e.charCodeAt(i);return t},qp.buf2string=function(e,t){var i,o,r,s,n=t||e.length,a=new Array(2*n);for(o=0,i=0;i<n;)if((r=e[i++])<128)a[o++]=r;else if((s=iv[r])>4)a[o++]=65533,i+=s-1;else{for(r&=2===s?31:3===s?15:7;s>1&&i<n;)r=r<<6|63&e[i++],s--;s>1?a[o++]=65533:r<65536?a[o++]=r:(r-=65536,a[o++]=55296|r>>10&1023,a[o++]=56320|1023&r)}return rv(a,o)},qp.utf8border=function(e,t){var i;for((t=t||e.length)>e.length&&(t=e.length),i=t-1;i>=0&&128==(192&e[i]);)i--;return i<0||0===i?t:i+iv[e[i]]>t?i:t};var sv=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0},nv=xm,av=Mm,dv=qp,cv=Ep,lv=sv,uv=Object.prototype.toString;function hv(e){if(!(this instanceof hv))return new hv(e);this.options=av.assign({level:-1,method:8,chunkSize:16384,windowBits:15,memLevel:8,strategy:0,to:""},e||{});var t=this.options;t.raw&&t.windowBits>0?t.windowBits=-t.windowBits:t.gzip&&t.windowBits>0&&t.windowBits<16&&(t.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new lv,this.strm.avail_out=0;var i=nv.deflateInit2(this.strm,t.level,t.method,t.windowBits,t.memLevel,t.strategy);if(0!==i)throw new Error(cv[i]);if(t.header&&nv.deflateSetHeader(this.strm,t.header),t.dictionary){var o;if(o="string"==typeof t.dictionary?dv.string2buf(t.dictionary):"[object ArrayBuffer]"===uv.call(t.dictionary)?new Uint8Array(t.dictionary):t.dictionary,0!==(i=nv.deflateSetDictionary(this.strm,o)))throw new Error(cv[i]);this._dict_set=!0}}function _v(e,t){var i=new hv(t);if(i.push(e,!0),i.err)throw i.msg||cv[i.err];return i.result}hv.prototype.push=function(e,t){var i,o,r=this.strm,s=this.options.chunkSize;if(this.ended)return!1;o=t===~~t?t:!0===t?4:0,"string"==typeof e?r.input=dv.string2buf(e):"[object ArrayBuffer]"===uv.call(e)?r.input=new Uint8Array(e):r.input=e,r.next_in=0,r.avail_in=r.input.length;do{if(0===r.avail_out&&(r.output=new av.Buf8(s),r.next_out=0,r.avail_out=s),1!==(i=nv.deflate(r,o))&&0!==i)return this.onEnd(i),this.ended=!0,!1;0!==r.avail_out&&(0!==r.avail_in||4!==o&&2!==o)||("string"===this.options.to?this.onData(dv.buf2binstring(av.shrinkBuf(r.output,r.next_out))):this.onData(av.shrinkBuf(r.output,r.next_out)))}while((r.avail_in>0||0===r.avail_out)&&1!==i);return 4===o?(i=nv.deflateEnd(this.strm),this.onEnd(i),this.ended=!0,0===i):2!==o||(this.onEnd(0),r.avail_out=0,!0)},hv.prototype.onData=function(e){this.chunks.push(e)},hv.prototype.onEnd=function(e){0===e&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=av.flattenChunks(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg},Lm.Deflate=hv,Lm.deflate=_v,Lm.deflateRaw=function(e,t){return(t=t||{}).raw=!0,_v(e,t)},Lm.gzip=function(e,t){return(t=t||{}).gzip=!0,_v(e,t)};var mv={},pv=se,vv=t_,fv=RegExp.prototype,Sv=i((function(e){return e===fv||pv(fv,e)?vv(e):e.flags})),gv={},yv=Mm,bv=15,Tv=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],Iv=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],Ev=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],Rv=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64],Cv=Mm,kv=yp,Av=Ip,Pv=function(e,t){var i,o,r,s,n,a,d,c,l,u,h,_,m,p,v,f,S,g,y,b,T,I,E,R,C;i=e.state,o=e.next_in,R=e.input,r=o+(e.avail_in-5),s=e.next_out,C=e.output,n=s-(t-e.avail_out),a=s+(e.avail_out-257),d=i.dmax,c=i.wsize,l=i.whave,u=i.wnext,h=i.window,_=i.hold,m=i.bits,p=i.lencode,v=i.distcode,f=(1<<i.lenbits)-1,S=(1<<i.distbits)-1;e:do{m<15&&(_+=R[o++]<<m,m+=8,_+=R[o++]<<m,m+=8),g=p[_&f];t:for(;;){if(_>>>=y=g>>>24,m-=y,0===(y=g>>>16&255))C[s++]=65535&g;else{if(!(16&y)){if(64&y){if(32&y){i.mode=12;break e}e.msg="invalid literal/length code",i.mode=30;break e}g=p[(65535&g)+(_&(1<<y)-1)];continue t}for(b=65535&g,(y&=15)&&(m<y&&(_+=R[o++]<<m,m+=8),b+=_&(1<<y)-1,_>>>=y,m-=y),m<15&&(_+=R[o++]<<m,m+=8,_+=R[o++]<<m,m+=8),g=v[_&S];;){if(_>>>=y=g>>>24,m-=y,16&(y=g>>>16&255)){if(T=65535&g,m<(y&=15)&&(_+=R[o++]<<m,(m+=8)<y&&(_+=R[o++]<<m,m+=8)),(T+=_&(1<<y)-1)>d){e.msg="invalid distance too far back",i.mode=30;break e}if(_>>>=y,m-=y,T>(y=s-n)){if((y=T-y)>l&&i.sane){e.msg="invalid distance too far back",i.mode=30;break e}if(I=0,E=h,0===u){if(I+=c-y,y<b){b-=y;do{C[s++]=h[I++]}while(--y);I=s-T,E=C}}else if(u<y){if(I+=c+u-y,(y-=u)<b){b-=y;do{C[s++]=h[I++]}while(--y);if(I=0,u<b){b-=y=u;do{C[s++]=h[I++]}while(--y);I=s-T,E=C}}}else if(I+=u-y,y<b){b-=y;do{C[s++]=h[I++]}while(--y);I=s-T,E=C}for(;b>2;)C[s++]=E[I++],C[s++]=E[I++],C[s++]=E[I++],b-=3;b&&(C[s++]=E[I++],b>1&&(C[s++]=E[I++]))}else{I=s-T;do{C[s++]=C[I++],C[s++]=C[I++],C[s++]=C[I++],b-=3}while(b>2);b&&(C[s++]=C[I++],b>1&&(C[s++]=C[I++]))}break}if(64&y){e.msg="invalid distance code",i.mode=30;break e}g=v[(65535&g)+(_&(1<<y)-1)]}}break}}while(o<r&&s<a);o-=b=m>>3,_&=(1<<(m-=b<<3))-1,e.next_in=o,e.next_out=s,e.avail_in=o<r?r-o+5:5-(o-r),e.avail_out=s<a?a-s+257:257-(s-a),i.hold=_,i.bits=m},Nv=function(e,t,i,o,r,s,n,a){var d,c,l,u,h,_,m,p,v,f=a.bits,S=0,g=0,y=0,b=0,T=0,I=0,E=0,R=0,C=0,k=0,A=null,P=0,N=new yv.Buf16(16),w=new yv.Buf16(16),O=null,M=0;for(S=0;S<=bv;S++)N[S]=0;for(g=0;g<o;g++)N[t[i+g]]++;for(T=f,b=bv;b>=1&&0===N[b];b--);if(T>b&&(T=b),0===b)return r[s++]=20971520,r[s++]=20971520,a.bits=1,0;for(y=1;y<b&&0===N[y];y++);for(T<y&&(T=y),R=1,S=1;S<=bv;S++)if(R<<=1,(R-=N[S])<0)return-1;if(R>0&&(0===e||1!==b))return-1;for(w[1]=0,S=1;S<bv;S++)w[S+1]=w[S]+N[S];for(g=0;g<o;g++)0!==t[i+g]&&(n[w[t[i+g]]++]=g);if(0===e?(A=O=n,_=19):1===e?(A=Tv,P-=257,O=Iv,M-=257,_=256):(A=Ev,O=Rv,_=-1),k=0,g=0,S=y,h=s,I=T,E=0,l=-1,u=(C=1<<T)-1,1===e&&C>852||2===e&&C>592)return 1;for(;;){m=S-E,n[g]<_?(p=0,v=n[g]):n[g]>_?(p=O[M+n[g]],v=A[P+n[g]]):(p=96,v=0),d=1<<S-E,y=c=1<<I;do{r[h+(k>>E)+(c-=d)]=m<<24|p<<16|v}while(0!==c);for(d=1<<S-1;k&d;)d>>=1;if(0!==d?(k&=d-1,k+=d):k=0,g++,0==--N[S]){if(S===b)break;S=t[i+n[g]]}if(S>T&&(k&u)!==l){for(0===E&&(E=T),h+=y,R=1<<(I=S-E);I+E<b&&!((R-=N[I+E])<=0);)I++,R<<=1;if(C+=1<<I,1===e&&C>852||2===e&&C>592)return 1;r[l=k&u]=T<<24|I<<16|h-s}}return 0!==k&&(r[h+k]=S-E<<24|64<<16),a.bits=T,0},wv=-2,Ov=12,Mv=30;function Lv(e){return(e>>>24&255)+(e>>>8&65280)+((65280&e)<<8)+((255&e)<<24)}function xv(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new Cv.Buf16(320),this.work=new Cv.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function Vv(e){var t;return e&&e.state?(t=e.state,e.total_in=e.total_out=t.total=0,e.msg="",t.wrap&&(e.adler=1&t.wrap),t.mode=1,t.last=0,t.havedict=0,t.dmax=32768,t.head=null,t.hold=0,t.bits=0,t.lencode=t.lendyn=new Cv.Buf32(852),t.distcode=t.distdyn=new Cv.Buf32(592),t.sane=1,t.back=-1,0):wv}function Dv(e){var t;return e&&e.state?((t=e.state).wsize=0,t.whave=0,t.wnext=0,Vv(e)):wv}function Uv(e,t){var i,o;return e&&e.state?(o=e.state,t<0?(i=0,t=-t):(i=1+(t>>4),t<48&&(t&=15)),t&&(t<8||t>15)?wv:(null!==o.window&&o.wbits!==t&&(o.window=null),o.wrap=i,o.wbits=t,Dv(e))):wv}function Zv(e,t){var i,o;return e?(o=new xv,e.state=o,o.window=null,0!==(i=Uv(e,t))&&(e.state=null),i):wv}var Wv,Xv,Gv=!0;function Fv(e){if(Gv){var t;for(Wv=new Cv.Buf32(512),Xv=new Cv.Buf32(32),t=0;t<144;)e.lens[t++]=8;for(;t<256;)e.lens[t++]=9;for(;t<280;)e.lens[t++]=7;for(;t<288;)e.lens[t++]=8;for(Nv(1,e.lens,0,288,Wv,0,e.work,{bits:9}),t=0;t<32;)e.lens[t++]=5;Nv(2,e.lens,0,32,Xv,0,e.work,{bits:5}),Gv=!1}e.lencode=Wv,e.lenbits=9,e.distcode=Xv,e.distbits=5}function Hv(e,t,i,o){var r,s=e.state;return null===s.window&&(s.wsize=1<<s.wbits,s.wnext=0,s.whave=0,s.window=new Cv.Buf8(s.wsize)),o>=s.wsize?(Cv.arraySet(s.window,t,i-s.wsize,s.wsize,0),s.wnext=0,s.whave=s.wsize):((r=s.wsize-s.wnext)>o&&(r=o),Cv.arraySet(s.window,t,i-o,r,s.wnext),(o-=r)?(Cv.arraySet(s.window,t,i-o,o,0),s.wnext=o,s.whave=s.wsize):(s.wnext+=r,s.wnext===s.wsize&&(s.wnext=0),s.whave<s.wsize&&(s.whave+=r))),0}gv.inflateReset=Dv,gv.inflateReset2=Uv,gv.inflateResetKeep=Vv,gv.inflateInit=function(e){return Zv(e,15)},gv.inflateInit2=Zv,gv.inflate=function(e,t){var i,o,r,s,n,a,d,c,l,u,h,_,m,p,v,f,S,g,y,b,T,I,E,R,C=0,k=new Cv.Buf8(4),A=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!e||!e.state||!e.output||!e.input&&0!==e.avail_in)return wv;(i=e.state).mode===Ov&&(i.mode=13),n=e.next_out,r=e.output,d=e.avail_out,s=e.next_in,o=e.input,a=e.avail_in,c=i.hold,l=i.bits,u=a,h=d,I=0;e:for(;;)switch(i.mode){case 1:if(0===i.wrap){i.mode=13;break}for(;l<16;){if(0===a)break e;a--,c+=o[s++]<<l,l+=8}if(2&i.wrap&&35615===c){i.check=0,k[0]=255&c,k[1]=c>>>8&255,i.check=Av(i.check,k,2,0),c=0,l=0,i.mode=2;break}if(i.flags=0,i.head&&(i.head.done=!1),!(1&i.wrap)||(((255&c)<<8)+(c>>8))%31){e.msg="incorrect header check",i.mode=Mv;break}if(8!=(15&c)){e.msg="unknown compression method",i.mode=Mv;break}if(l-=4,T=8+(15&(c>>>=4)),0===i.wbits)i.wbits=T;else if(T>i.wbits){e.msg="invalid window size",i.mode=Mv;break}i.dmax=1<<T,e.adler=i.check=1,i.mode=512&c?10:Ov,c=0,l=0;break;case 2:for(;l<16;){if(0===a)break e;a--,c+=o[s++]<<l,l+=8}if(i.flags=c,8!=(255&Sv(i))){e.msg="unknown compression method",i.mode=Mv;break}if(57344&Sv(i)){e.msg="unknown header flags set",i.mode=Mv;break}i.head&&(i.head.text=c>>8&1),512&Sv(i)&&(k[0]=255&c,k[1]=c>>>8&255,i.check=Av(i.check,k,2,0)),c=0,l=0,i.mode=3;case 3:for(;l<32;){if(0===a)break e;a--,c+=o[s++]<<l,l+=8}i.head&&(i.head.time=c),512&Sv(i)&&(k[0]=255&c,k[1]=c>>>8&255,k[2]=c>>>16&255,k[3]=c>>>24&255,i.check=Av(i.check,k,4,0)),c=0,l=0,i.mode=4;case 4:for(;l<16;){if(0===a)break e;a--,c+=o[s++]<<l,l+=8}i.head&&(i.head.xflags=255&c,i.head.os=c>>8),512&Sv(i)&&(k[0]=255&c,k[1]=c>>>8&255,i.check=Av(i.check,k,2,0)),c=0,l=0,i.mode=5;case 5:if(1024&Sv(i)){for(;l<16;){if(0===a)break e;a--,c+=o[s++]<<l,l+=8}i.length=c,i.head&&(i.head.extra_len=c),512&Sv(i)&&(k[0]=255&c,k[1]=c>>>8&255,i.check=Av(i.check,k,2,0)),c=0,l=0}else i.head&&(i.head.extra=null);i.mode=6;case 6:if(1024&Sv(i)&&((_=i.length)>a&&(_=a),_&&(i.head&&(T=i.head.extra_len-i.length,i.head.extra||(i.head.extra=new Array(i.head.extra_len)),Cv.arraySet(i.head.extra,o,s,_,T)),512&Sv(i)&&(i.check=Av(i.check,o,_,s)),a-=_,s+=_,i.length-=_),i.length))break e;i.length=0,i.mode=7;case 7:if(2048&Sv(i)){if(0===a)break e;_=0;do{T=o[s+_++],i.head&&T&&i.length<65536&&(i.head.name+=String.fromCharCode(T))}while(T&&_<a);if(512&Sv(i)&&(i.check=Av(i.check,o,_,s)),a-=_,s+=_,T)break e}else i.head&&(i.head.name=null);i.length=0,i.mode=8;case 8:if(4096&Sv(i)){if(0===a)break e;_=0;do{T=o[s+_++],i.head&&T&&i.length<65536&&(i.head.comment+=String.fromCharCode(T))}while(T&&_<a);if(512&Sv(i)&&(i.check=Av(i.check,o,_,s)),a-=_,s+=_,T)break e}else i.head&&(i.head.comment=null);i.mode=9;case 9:if(512&Sv(i)){for(;l<16;){if(0===a)break e;a--,c+=o[s++]<<l,l+=8}if(c!==(65535&i.check)){e.msg="header crc mismatch",i.mode=Mv;break}c=0,l=0}i.head&&(i.head.hcrc=Sv(i)>>9&1,i.head.done=!0),e.adler=i.check=0,i.mode=Ov;break;case 10:for(;l<32;){if(0===a)break e;a--,c+=o[s++]<<l,l+=8}e.adler=i.check=Lv(c),c=0,l=0,i.mode=11;case 11:if(0===i.havedict)return e.next_out=n,e.avail_out=d,e.next_in=s,e.avail_in=a,i.hold=c,i.bits=l,2;e.adler=i.check=1,i.mode=Ov;case Ov:if(5===t||6===t)break e;case 13:if(i.last){c>>>=7&l,l-=7&l,i.mode=27;break}for(;l<3;){if(0===a)break e;a--,c+=o[s++]<<l,l+=8}switch(i.last=1&c,l-=1,3&(c>>>=1)){case 0:i.mode=14;break;case 1:if(Fv(i),i.mode=20,6===t){c>>>=2,l-=2;break e}break;case 2:i.mode=17;break;case 3:e.msg="invalid block type",i.mode=Mv}c>>>=2,l-=2;break;case 14:for(c>>>=7&l,l-=7&l;l<32;){if(0===a)break e;a--,c+=o[s++]<<l,l+=8}if((65535&c)!=(c>>>16^65535)){e.msg="invalid stored block lengths",i.mode=Mv;break}if(i.length=65535&c,c=0,l=0,i.mode=15,6===t)break e;case 15:i.mode=16;case 16:if(_=i.length){if(_>a&&(_=a),_>d&&(_=d),0===_)break e;Cv.arraySet(r,o,s,_,n),a-=_,s+=_,d-=_,n+=_,i.length-=_;break}i.mode=Ov;break;case 17:for(;l<14;){if(0===a)break e;a--,c+=o[s++]<<l,l+=8}if(i.nlen=257+(31&c),c>>>=5,l-=5,i.ndist=1+(31&c),c>>>=5,l-=5,i.ncode=4+(15&c),c>>>=4,l-=4,i.nlen>286||i.ndist>30){e.msg="too many length or distance symbols",i.mode=Mv;break}i.have=0,i.mode=18;case 18:for(;i.have<i.ncode;){for(;l<3;){if(0===a)break e;a--,c+=o[s++]<<l,l+=8}i.lens[A[i.have++]]=7&c,c>>>=3,l-=3}for(;i.have<19;)i.lens[A[i.have++]]=0;if(i.lencode=i.lendyn,i.lenbits=7,E={bits:i.lenbits},I=Nv(0,i.lens,0,19,i.lencode,0,i.work,E),i.lenbits=E.bits,I){e.msg="invalid code lengths set",i.mode=Mv;break}i.have=0,i.mode=19;case 19:for(;i.have<i.nlen+i.ndist;){for(;f=(C=i.lencode[c&(1<<i.lenbits)-1])>>>16&255,S=65535&C,!((v=C>>>24)<=l);){if(0===a)break e;a--,c+=o[s++]<<l,l+=8}if(S<16)c>>>=v,l-=v,i.lens[i.have++]=S;else{if(16===S){for(R=v+2;l<R;){if(0===a)break e;a--,c+=o[s++]<<l,l+=8}if(c>>>=v,l-=v,0===i.have){e.msg="invalid bit length repeat",i.mode=Mv;break}T=i.lens[i.have-1],_=3+(3&c),c>>>=2,l-=2}else if(17===S){for(R=v+3;l<R;){if(0===a)break e;a--,c+=o[s++]<<l,l+=8}l-=v,T=0,_=3+(7&(c>>>=v)),c>>>=3,l-=3}else{for(R=v+7;l<R;){if(0===a)break e;a--,c+=o[s++]<<l,l+=8}l-=v,T=0,_=11+(127&(c>>>=v)),c>>>=7,l-=7}if(i.have+_>i.nlen+i.ndist){e.msg="invalid bit length repeat",i.mode=Mv;break}for(;_--;)i.lens[i.have++]=T}}if(i.mode===Mv)break;if(0===i.lens[256]){e.msg="invalid code -- missing end-of-block",i.mode=Mv;break}if(i.lenbits=9,E={bits:i.lenbits},I=Nv(1,i.lens,0,i.nlen,i.lencode,0,i.work,E),i.lenbits=E.bits,I){e.msg="invalid literal/lengths set",i.mode=Mv;break}if(i.distbits=6,i.distcode=i.distdyn,E={bits:i.distbits},I=Nv(2,i.lens,i.nlen,i.ndist,i.distcode,0,i.work,E),i.distbits=E.bits,I){e.msg="invalid distances set",i.mode=Mv;break}if(i.mode=20,6===t)break e;case 20:i.mode=21;case 21:if(a>=6&&d>=258){e.next_out=n,e.avail_out=d,e.next_in=s,e.avail_in=a,i.hold=c,i.bits=l,Pv(e,h),n=e.next_out,r=e.output,d=e.avail_out,s=e.next_in,o=e.input,a=e.avail_in,c=i.hold,l=i.bits,i.mode===Ov&&(i.back=-1);break}for(i.back=0;f=(C=i.lencode[c&(1<<i.lenbits)-1])>>>16&255,S=65535&C,!((v=C>>>24)<=l);){if(0===a)break e;a--,c+=o[s++]<<l,l+=8}if(f&&!(240&f)){for(g=v,y=f,b=S;f=(C=i.lencode[b+((c&(1<<g+y)-1)>>g)])>>>16&255,S=65535&C,!(g+(v=C>>>24)<=l);){if(0===a)break e;a--,c+=o[s++]<<l,l+=8}c>>>=g,l-=g,i.back+=g}if(c>>>=v,l-=v,i.back+=v,i.length=S,0===f){i.mode=26;break}if(32&f){i.back=-1,i.mode=Ov;break}if(64&f){e.msg="invalid literal/length code",i.mode=Mv;break}i.extra=15&f,i.mode=22;case 22:if(i.extra){for(R=i.extra;l<R;){if(0===a)break e;a--,c+=o[s++]<<l,l+=8}i.length+=c&(1<<i.extra)-1,c>>>=i.extra,l-=i.extra,i.back+=i.extra}i.was=i.length,i.mode=23;case 23:for(;f=(C=i.distcode[c&(1<<i.distbits)-1])>>>16&255,S=65535&C,!((v=C>>>24)<=l);){if(0===a)break e;a--,c+=o[s++]<<l,l+=8}if(!(240&f)){for(g=v,y=f,b=S;f=(C=i.distcode[b+((c&(1<<g+y)-1)>>g)])>>>16&255,S=65535&C,!(g+(v=C>>>24)<=l);){if(0===a)break e;a--,c+=o[s++]<<l,l+=8}c>>>=g,l-=g,i.back+=g}if(c>>>=v,l-=v,i.back+=v,64&f){e.msg="invalid distance code",i.mode=Mv;break}i.offset=S,i.extra=15&f,i.mode=24;case 24:if(i.extra){for(R=i.extra;l<R;){if(0===a)break e;a--,c+=o[s++]<<l,l+=8}i.offset+=c&(1<<i.extra)-1,c>>>=i.extra,l-=i.extra,i.back+=i.extra}if(i.offset>i.dmax){e.msg="invalid distance too far back",i.mode=Mv;break}i.mode=25;case 25:if(0===d)break e;if(_=h-d,i.offset>_){if((_=i.offset-_)>i.whave&&i.sane){e.msg="invalid distance too far back",i.mode=Mv;break}_>i.wnext?(_-=i.wnext,m=i.wsize-_):m=i.wnext-_,_>i.length&&(_=i.length),p=i.window}else p=r,m=n-i.offset,_=i.length;_>d&&(_=d),d-=_,i.length-=_;do{r[n++]=p[m++]}while(--_);0===i.length&&(i.mode=21);break;case 26:if(0===d)break e;r[n++]=i.length,d--,i.mode=21;break;case 27:if(i.wrap){for(;l<32;){if(0===a)break e;a--,c|=o[s++]<<l,l+=8}if(h-=d,e.total_out+=h,i.total+=h,h&&(e.adler=i.check=Sv(i)?Av(i.check,r,h,n-h):kv(i.check,r,h,n-h)),h=d,(Sv(i)?c:Lv(c))!==i.check){e.msg="incorrect data check",i.mode=Mv;break}c=0,l=0}i.mode=28;case 28:if(i.wrap&&Sv(i)){for(;l<32;){if(0===a)break e;a--,c+=o[s++]<<l,l+=8}if(c!==(4294967295&i.total)){e.msg="incorrect length check",i.mode=Mv;break}c=0,l=0}i.mode=29;case 29:I=1;break e;case Mv:I=-3;break e;case 31:return-4;default:return wv}return e.next_out=n,e.avail_out=d,e.next_in=s,e.avail_in=a,i.hold=c,i.bits=l,(i.wsize||h!==e.avail_out&&i.mode<Mv&&(i.mode<27||4!==t))&&Hv(e,e.output,e.next_out,h-e.avail_out),u-=e.avail_in,h-=e.avail_out,e.total_in+=u,e.total_out+=h,i.total+=h,i.wrap&&h&&(e.adler=i.check=Sv(i)?Av(i.check,r,h,e.next_out-h):kv(i.check,r,h,e.next_out-h)),e.data_type=i.bits+(i.last?64:0)+(i.mode===Ov?128:0)+(20===i.mode||15===i.mode?256:0),(0===u&&0===h||4===t)&&0===I&&(I=-5),I},gv.inflateEnd=function(e){if(!e||!e.state)return wv;var t=e.state;return t.window&&(t.window=null),e.state=null,0},gv.inflateGetHeader=function(e,t){var i;return e&&e.state&&2&(i=e.state).wrap?(i.head=t,t.done=!1,0):wv},gv.inflateSetDictionary=function(e,t){var i,o=t.length;return e&&e.state?0!==(i=e.state).wrap&&11!==i.mode?wv:11===i.mode&&kv(1,t,o,0)!==i.check?-3:Hv(e,t,o,o)?(i.mode=31,-4):(i.havedict=1,0):wv},gv.inflateInfo="pako inflate (from Nodeca project)";var Yv={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8};var Kv=gv,Bv=Mm,Jv=qp,jv=Yv,zv=Ep,Qv=sv,qv=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1},$v=Object.prototype.toString;function ef(e){if(!(this instanceof ef))return new ef(e);this.options=Bv.assign({chunkSize:16384,windowBits:0,to:""},e||{});var t=this.options;t.raw&&t.windowBits>=0&&t.windowBits<16&&(t.windowBits=-t.windowBits,0===t.windowBits&&(t.windowBits=-15)),!(t.windowBits>=0&&t.windowBits<16)||e&&e.windowBits||(t.windowBits+=32),t.windowBits>15&&t.windowBits<48&&(15&t.windowBits||(t.windowBits|=15)),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new Qv,this.strm.avail_out=0;var i=Kv.inflateInit2(this.strm,t.windowBits);if(i!==jv.Z_OK)throw new Error(zv[i]);if(this.header=new qv,Kv.inflateGetHeader(this.strm,this.header),t.dictionary&&("string"==typeof t.dictionary?t.dictionary=Jv.string2buf(t.dictionary):"[object ArrayBuffer]"===$v.call(t.dictionary)&&(t.dictionary=new Uint8Array(t.dictionary)),t.raw&&(i=Kv.inflateSetDictionary(this.strm,t.dictionary))!==jv.Z_OK))throw new Error(zv[i])}function tf(e,t){var i=new ef(t);if(i.push(e,!0),i.err)throw i.msg||zv[i.err];return i.result}ef.prototype.push=function(e,t){var i,o,r,s,n,a=this.strm,d=this.options.chunkSize,c=this.options.dictionary,l=!1;if(this.ended)return!1;o=t===~~t?t:!0===t?jv.Z_FINISH:jv.Z_NO_FLUSH,"string"==typeof e?a.input=Jv.binstring2buf(e):"[object ArrayBuffer]"===$v.call(e)?a.input=new Uint8Array(e):a.input=e,a.next_in=0,a.avail_in=a.input.length;do{if(0===a.avail_out&&(a.output=new Bv.Buf8(d),a.next_out=0,a.avail_out=d),(i=Kv.inflate(a,jv.Z_NO_FLUSH))===jv.Z_NEED_DICT&&c&&(i=Kv.inflateSetDictionary(this.strm,c)),i===jv.Z_BUF_ERROR&&!0===l&&(i=jv.Z_OK,l=!1),i!==jv.Z_STREAM_END&&i!==jv.Z_OK)return this.onEnd(i),this.ended=!0,!1;a.next_out&&(0!==a.avail_out&&i!==jv.Z_STREAM_END&&(0!==a.avail_in||o!==jv.Z_FINISH&&o!==jv.Z_SYNC_FLUSH)||("string"===this.options.to?(r=Jv.utf8border(a.output,a.next_out),s=a.next_out-r,n=Jv.buf2string(a.output,r),a.next_out=s,a.avail_out=d-s,s&&Bv.arraySet(a.output,a.output,r,s,0),this.onData(n)):this.onData(Bv.shrinkBuf(a.output,a.next_out)))),0===a.avail_in&&0===a.avail_out&&(l=!0)}while((a.avail_in>0||0===a.avail_out)&&i!==jv.Z_STREAM_END);return i===jv.Z_STREAM_END&&(o=jv.Z_FINISH),o===jv.Z_FINISH?(i=Kv.inflateEnd(this.strm),this.onEnd(i),this.ended=!0,i===jv.Z_OK):o!==jv.Z_SYNC_FLUSH||(this.onEnd(jv.Z_OK),a.avail_out=0,!0)},ef.prototype.onData=function(e){this.chunks.push(e)},ef.prototype.onEnd=function(e){e===jv.Z_OK&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=Bv.flattenChunks(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg},mv.Inflate=ef,mv.inflate=tf,mv.inflateRaw=function(e,t){return(t=t||{}).raw=!0,tf(e,t)},mv.ungzip=tf;var of={};(0,Mm.assign)(of,Lm,mv,Yv);var rf=i(of);let sf=1;const nf="VERTC",af=()=>window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB;class df{constructor(e){Xu(this,"storeName",void 0),Xu(this,"pendingList",[]),this.storeName=e,!rm()&&af()&&this._checkAndCreateStore(e)}async _checkAndCreateStore(e,t){const i=await df._promiseLock.lock();if(af().databases){let e;await new Promise((t=>{const i=()=>af().databases().finally(t);e=setInterval(i,100),i()})).finally((()=>clearInterval(e)))}return new Promise((o=>{df.db&&(df.db.close(),delete df.db);const r=t?af().open(nf,t):af().open(nf);r.onupgradeneeded=()=>{r.result.createObjectStore(e)},r.onerror=()=>{console.error("IndexedDBInterface error",r.error)},r.onsuccess=()=>{const t=r.result;df.db=t;try{df.db.transaction(this.storeName,"readonly"),this.pendingList.forEach((async e=>{let{txMode:t,pendResolve:i,pendReject:o}=e;try{i(await this._getStore(t))}catch(r){o()}})),o()}catch(s){o(this._checkAndCreateStore(e,t.version+1))}finally{i()}}}))}async _getStore(e){const t=await df._promiseLock.lock();return new Promise(((i,o)=>{if(!df.db)return this.pendingList.push({txMode:e,pendResolve:i,pendReject:o}),void t();try{i(df.db.transaction(this.storeName,e).objectStore(this.storeName))}catch(r){return void this.pendingList.push({txMode:e,pendResolve:i,pendReject:o})}finally{t()}}))}async put2String(e,t){let i;try{i=JSON.stringify(e)}catch(o){i=e}return await this.put(i,t)}async get4String(e){const t=await this.get(e);let i;try{i=JSON.parse(t)}catch(o){i=t}return i}async put(e,t){const i=await this._getStore("readwrite");return new Promise(((o,r)=>{const s=i.put(e,t);s.onsuccess=()=>{o()},s.onerror=e=>{r(e)}}))}async get(e){const t=await this._getStore("readonly");return new Promise(((i,o)=>{const r=t.get(e);r.onsuccess=()=>{i(r.result)},r.onerror=e=>{o(e)}}))}async del(e){const t=await this._getStore("readwrite");return new Promise(((i,o)=>{const r=t.delete(e);r.onsuccess=()=>{i()},r.onerror=e=>{o(e)}}))}}Xu(df,"db",void 0),Xu(df,"state","init"),Xu(df,"_promiseLock",new class{constructor(e){Xu(this,"lockingPromise",Promise.resolve()),Xu(this,"locks",0),Xu(this,"name",""),Xu(this,"lockId",void 0),this.lockId=sf++,e&&(this.name=e)}get isLocked(){return this.locks>0}lock(){let e;this.locks+=1;const t=new Promise((t=>{e=()=>{this.locks-=1,t()}})),i=this.lockingPromise.then((()=>e));return this.lockingPromise=this.lockingPromise.then((()=>t)),i}}("iDB"));var cf=Ji.includes;wi({target:"Array",proto:!0,forced:n((function(){return!Array(1).includes()}))},{includes:function(e){return cf(this,e,arguments.length>1?arguments[1]:void 0)}});var lf=Xa("Array","includes"),uf=Jh,hf=TypeError,_f=pt("match"),mf=wi,pf=function(e){if(uf(e))throw new hf("The method doesn't accept regular expressions");return e},vf=B,ff=bo,Sf=function(e){var t=/./;try{"/./"[e](t)}catch(i){try{return t[_f]=!1,"/./"[e](t)}catch(o){}}return!1},gf=f("".indexOf);mf({target:"String",proto:!0,forced:!Sf("includes")},{includes:function(e){return!!~gf(ff(vf(this)),ff(pf(e)),arguments.length>1?arguments[1]:void 0)}});var yf=Xa("String","includes"),bf=se,Tf=lf,If=yf,Ef=Array.prototype,Rf=String.prototype,Cf=i((function(e){var t=e.includes;return e===Ef||bf(Ef,e)&&t===Ef.includes?Tf:"string"==typeof e||e===Rf||bf(Rf,e)&&t===Rf.includes?If:t}));function kf(e,t){if(null==e)return{};var i,o,r=function(e,t){if(null==e)return{};var i={};for(var o in e)if({}.hasOwnProperty.call(e,o)){if(Cf(t).call(t,o))continue;i[o]=e[o]}return i}(e,t);if(Ma){var s=Ma(e);for(o=0;o<s.length;o++)i=s[o],Cf(t).call(t,i)||{}.propertyIsEnumerable.call(e,i)&&(r[i]=e[i])}return r}const Af=["message"];var Pf,Nf,wf=new class{constructor(){Xu(this,"name","LongStringReportor"),Xu(this,"inBuffer",[]),Xu(this,"outBuffer",[])}push(e){e.message&&this.inBuffer.push(Fu(Fu({},e),{},{message:{id:sm().slice(0,3),index:0,end:!0,msg:e.message}}))}splice(e){const t=[];let i=0;for(;this.outBuffer.length;){const o=JSON.stringify(this.outBuffer[0]).length;if(!(o<e))break;e-=o,i+=o,t.push(this.outBuffer.shift())}for(;this.inBuffer[0]&&e>0;){const o=this.inBuffer[0],{message:r}=o,s=Fu(Fu({},kf(o,Af)),{},{message:Fu(Fu({},r),{},{msg:""})}),n=JSON.stringify(s).length,a=e-n,d=Fu({},s);if(a>r.msg.length)d.message.msg=r.msg,this.inBuffer.shift();else{if(!(a>=10))break;{const e=r.msg.slice(0,a);d.message.msg=e,d.message.end=!1,this.inBuffer[0].message.msg=r.msg.slice(a),this.inBuffer[0].message.index++}}const c=JSON.stringify(d.message),l=c.length;e-=l+n,i+=l+n,t.push(Fu(Fu({},d),{},{message:c}))}return{payload:t,payloadSize:i}}unshift(e){this.outBuffer=e.concat(this.outBuffer)}get(){return[...this.outBuffer,...this.inBuffer.map((e=>Fu(Fu({},e),{},{message:JSON.stringify(e.message)})))]}set(e){e.forEach((e=>{!function(e){return void 0!==e.report_id}(e)?(e.message||(e.message=""),this.inBuffer.push(Fu(Fu({},e),{},{message:JSON.parse(e.message)}))):this.outBuffer.push(e)})),this.outBuffer=[].concat(this.outBuffer),this.inBuffer=[].concat(this.inBuffer)}isEmpty(){return 0===this.inBuffer.length&&0===this.outBuffer.length}};const Of=5e5,Mf={product_line:"rtc",report_version:"5",os:"web",user_agent:rm()?"":null===(Pf=navigator)||void 0===Pf?void 0:Pf.userAgent,platform:"web",product:"webrtc",app_state:"active"},Lf="LogReportor",xf="undefined"!=typeof window&&(window.location.search.includes("_rtc_debug_")||(null===(Nf=window.localStorage)||void 0===Nf?void 0:Nf.getItem("_rtc_debug_")));class Vf{constructor(e){Xu(this,"_buffer",void 0),this._buffer=new df(e)}async set(e,t){await this._buffer.put2String(e,t)}async get(e){var t;let i=[];try{i=await this._buffer.get4String(e)}catch(o){}return null!==(t=i)&&void 0!==t?t:[]}}var Df=new class{constructor(){Xu(this,"reportCommon",Mf),Xu(this,"reportIds",new Map),Xu(this,"dataBuffer",[]),Xu(this,"reportorList",[]),Xu(this,"dbBuffer",void 0),Xu(this,"posting",!1),Xu(this,"sucSendTimer",void 0),Xu(this,"preSucTime",0),Xu(this,"errSendTimer",void 0),Xu(this,"errSendDelay",100),Xu(this,"_logServerUrl",void 0),Xu(this,"_retryCount",0),Xu(this,"_reportLimit",Of),Xu(this,"_disableTimeout",!1),rm()||(window.addEventListener("beforeunload",(()=>{clearTimeout(this.errSendTimer),clearTimeout(this.sucSendTimer),this.send(void 0,!0)})),document.addEventListener("visibilitychange",(()=>{"visible"===document.visibilityState?this.setCommonStats({app_state:"active"}):"hidden"===document.visibilityState&&this.setCommonStats({app_state:"background"})})),xf&&(window.__rtc_debug_reportor__=this)),fm.on("UPLOAD_REPORT_LIMIT",(e=>{this.setReportLimit(e)})),fm.on("ENABLE_REPORT_IDB_BUFFER",(e=>{e&&this.enableIndexedDBBuffer()})),setTimeout((()=>{this.reportorList.push(IS),this.reportorList.push(wf)}))}setUrl(e){this._logServerUrl=e}setCommonStats(e){this.reportCommon=Object.assign(this.reportCommon,e)}getCommonStats(){return this.reportCommon}setReportLimit(e){this._reportLimit=Math.max(e,5e4),this._reportLimit=Math.min(e,5e5)}getReportId(e){var t;e=null!==(t=e)&&void 0!==t?t:"__global__",this.reportIds.has(e)||this.reportIds.set(e,0);let i=this.reportIds.get(e);return void 0===i&&(dS("no reportId in reportId map with engine-session-id ".concat(e),0,{}),i=0),this.reportIds.set(e,i+1),i}push(e){if(arguments.length>1&&void 0!==arguments[1]&&arguments[1])this.send(e);else{var t;const i=null!==(t=e.engine_session_id)&&void 0!==t?t:"__global__";this.reportIds.has(i)||this.reportIds.set(i,0),this.dataBuffer.push(e),!this.posting&&!this.errSendTimer&&Date.now()-this.preSucTime>2e3&&(clearTimeout(this.sucSendTimer),this.send())}}enableIndexedDBBuffer(){this.dbBuffer||(this.dbBuffer=new Vf("ReportorDBBuffer"),this.dbBuffer.get(Lf).then((e=>{e.forEach((e=>{this.push(e)}))})),this.reportorList.forEach((e=>{var t;null===(t=this.dbBuffer)||void 0===t||t.get(e.name).then((t=>{e.set(t)}))})))}backup(){try{var e;null===(e=this.dbBuffer)||void 0===e||e.set([...this.dataBuffer],Lf),this.reportorList.forEach((e=>{var t;null===(t=this.dbBuffer)||void 0===t||t.set([...e.get()],e.name)}))}catch(t){dS("Error when save log into IDB",-1,t)}}unshift(e){this.dataBuffer=e[0].concat(this.dataBuffer),this.reportorList.forEach(((t,i)=>{var o;t.unshift(null!==(o=e[i+1])&&void 0!==o?o:[])}))}_splice(){let e=function(e,t){let i=0;for(let o=0;o<e.length;o++)if(i+=JSON.stringify(e[o]).length,i>t)return o;return e.length}(this.dataBuffer,this._reportLimit);0===e&&this.dataBuffer.length>0&&(this._reportLimit=JSON.stringify(this.dataBuffer[0]).length+10,e=1,dS("update report limit to ".concat(this._reportLimit),0,null));const t=this.dataBuffer.splice(0,e),i=JSON.stringify(t).length,o=[t];let r=this._reportLimit-i;return this.reportorList.forEach((e=>{const{payload:t,payloadSize:i}=e.splice(r);t.forEach((e=>{var t,i,o;void 0===e.report_id&&(e.report_id=this.getReportId(e.engine_session_id),!rm()&&window.__onRTCReport&&(null===(t=(i=window).__onRTCReport)||void 0===t||t.call(i,null!==(o=e.engine_session_id)&&void 0!==o?o:"global",e,this.getCommonStats())))})),o.push(t),r-=i})),o}async send(e,t){this.backup();const i=this.reportorList.reduce(((e,t)=>e&&t.isEmpty()),!0);if(!e&&!this.dataBuffer.length&&i||!this._logServerUrl)return;e||(this.posting=!0);let o=[];e||(o=this._splice());const r=xf,s={data:e||Om(o).call(o),header:Fu(Fu({},this.reportCommon),{},{http_retry_count:this._retryCount}),from:"web",os:"web",version:"1"},n={method:"POST",body:r?JSON.stringify(s):rf.gzip(JSON.stringify(s))};if(!this._disableTimeout)try{const e=new AbortController;n.signal=e.signal,setTimeout((()=>{e.abort()}),1e4)}catch(l){console.warn("AbortController is not supported"),this._disableTimeout=!0}r||(n.headers={"Content-Encoding":"gzip","Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"});let a,d,c=null;try{a=await fetch(this._logServerUrl,n),200!==a.status&&304!==a.status||(c=JSON.parse(await a.text()))}catch(u){d=u}e||(this.posting=!1),c&&0===c.StatusCode?e||t||this.sucSend():(setTimeout((()=>{var e,t,i;dS("reportor post error, resJSON:".concat(null===(e=c)||void 0===e?void 0:e.toString()," err:").concat(d),null!==(t=null===(i=a)||void 0===i?void 0:i.status)&&void 0!==t?t:-1,d)}),0),e?this.send(e):(this.unshift(o),t?this.send():this.errSend()))}_getDataBufferTotalSize(){return this.dataBuffer.reduce(((e,t)=>e+JSON.stringify(t).length),0)}sucSend(){this.errSendDelay=100,this._retryCount=0,this.preSucTime=Date.now();const e=this._getDataBufferTotalSize()>1e6?1e3:2e3;this.sucSendTimer=setTimeout((()=>this.send()),e)}errSend(){this.errSendTimer=setTimeout((()=>{this.send(),delete this.errSendTimer}),this.errSendDelay),this.errSendDelay*=2,this._retryCount++}};class Uf{constructor(e){Xu(this,"modifyIds",{pre_connection:!1}),this.id=e}report(e,t,i){const o=Fu(Fu(Fu({event_key:e,rtc_timestamp:Date.now()},this.modifyIds),t),{},{report_id:Df.getReportId(this.modifyIds.engine_session_id)});var r,s;("object"==typeof i&&Object.keys(i).length>0&&(o.common_extra_info=JSON.stringify(i)),Object.keys(o).forEach((e=>{void 0!==o[e]&&""!==o[e]||delete o[e]})),!rm()&&window.__onRTCReport)&&(null===(r=(s=window).__onRTCReport)||void 0===r||r.call(s,this.modifyIds.engine_session_id,o,Df.getCommonStats()));"UT"!=={}.VITE_TEST&&Df.push(o)}reportLog(e){const t=Fu(Fu({event_key:"rtc_invoke_status",sdk_api_name:"console_log",rtc_timestamp:Date.now()},this.modifyIds),{},{message:e});IS.push(t)}reportLongString(e,t){const i=Fu(Fu({event_key:"rtc_invoke_status",sdk_api_name:"sdk_long_string_".concat(e),rtc_timestamp:Date.now()},this.modifyIds),{},{message:t});wf.push(i)}set(e){this.modifyIds=Object.assign(this.modifyIds,e)}destroy(){}}class Zf{constructor(e){Xu(this,"_preTime",Date.now()),Xu(this,"_one2oneNum",0),Xu(this,"_one2manyNum",0),Xu(this,"_one2oneMsgCache",new Map),Xu(this,"_one2manyMsgCache",new Map),Xu(this,"roomId",""),Xu(this,"userId",""),Xu(this,"rtsSessionId",""),Xu(this,"logger",void 0),Xu(this,"serverUrl","server"),this.id=e,this.logger=new LS("MessageReportor",1)}needReport(e){return!!Zf.config&&(Date.now()-this._preTime>=36e5&&(this._preTime=Date.now(),this._one2oneNum=0,this._one2manyNum=0),"one2one"===e&&this._one2oneNum<Zf.config.max_one2one_fpt_per_hour&&Math.random()<=Zf.config.one2one_fpt_ratio/100||"one2many"===e&&this._one2manyNum<Zf.config.max_one2many_fpt_per_hour&&Math.random()<=Zf.config.one2many_fpt_ratio/100)}cacheP2PMsg(e){var t;this._one2oneMsgCache.set(e.msg_id,Fu({config_version:(null===(t=Zf.config)||void 0===t?void 0:t.version)||""},e))}updateP2PMsg(e,t){const i=this._one2oneMsgCache.get(e);i&&this._one2oneMsgCache.set(e,Fu(Fu({},i),t))}cacheCustomMsg(e){var t;this._one2manyMsgCache.set(e.msg_id,Fu({config_version:(null===(t=Zf.config)||void 0===t?void 0:t.version)||""},e))}updateOne2ManyMsg(e,t){const i=this._one2manyMsgCache.get(e);i&&this._one2manyMsgCache.set(e,Fu(Fu({},i),t))}reportP2PMsg(e){const t=this._one2oneMsgCache.get(e);var i;t&&(this.logger.info("reportP2PMsg",t.type,JSON.stringify(t)),null===(i=uS(this.id))||void 0===i||i.report("rts_message",t))}reportOne2ManyMsg(e){const t=this._one2manyMsgCache.get(e);var i;t&&(this.logger.info("reportOne2ManyMsg",t.type,JSON.stringify(t)),null===(i=uS(this.id))||void 0===i||i.report("rts_message",t))}reportMsgRecv(e){var t,i;e.config_version=(null===(t=Zf.config)||void 0===t?void 0:t.version)||"",this.logger.info("reportMsgRecv",e.type,JSON.stringify(e)),null===(i=uS(this.id))||void 0===i||i.report("rts_message",e)}destroy(){this._one2manyNum=0,this._one2oneNum=0,this._one2manyMsgCache.clear(),this._one2oneMsgCache.clear(),this._preTime=Date.now(),this.roomId="",this.userId="",this.rtsSessionId=""}}Xu(Zf,"config",void 0);const Wf=new Map,Xf=(e,t)=>{const i=Wf.get(e);i&&(i.serverUrl=t)},Gf=e=>{new LS("MessageReportor",1).info("setConfig","get config: ".concat(JSON.stringify(e))),Zf.config=e},Ff=(e,t)=>{const i=Wf.get(e);i&&(i.rtsSessionId=t)},Hf=e=>{const t=Wf.get(e)||new Zf(e);return Wf.set(e,t),t},Yf=e=>{const t=Wf.get(e);t&&(t.destroy(),Wf.delete(e))},Kf=(e,t)=>{const i=Wf.get(e);i&&(i.roomId=t||"")},Bf=(e,t)=>{const i=Wf.get(e);i&&(i.userId=t||"")},Jf=(e,t)=>{const i=Wf.get(e);if(null!=i&&i.needReport("one2one")){const e=t.to?"one2one":"one2server";t.enable_report=!0,t.report_msg_id=t.id,i.cacheP2PMsg({rts_session_id:i.rtsSessionId,msg_id:"".concat(t.id),node_role:"src_sdk",from:t.from,to:t.to||i.serverUrl,msg_type:e,type:e,rts_room_id:t.room,req_ts:Date.now(),send_ts:Date.now(),ack_ts:Date.now(),msg_size:0,error_code:0,recv_msg_ts:0,fwd_msg_ts:0,reply_ack_ts:0,cur_dst_uid:""})}return t},jf=(e,t,i)=>{var o;t.enable_report&&nm(t.report_msg_id)&&(null===(o=Wf.get(e))||void 0===o||o.updateP2PMsg("".concat(t.report_msg_id),{send_ts:Date.now(),msg_size:i}))},zf=(e,t,i)=>{if(t.enable_report&&nm(t.report_msg_id)){const o=Wf.get(e);null==o||o.updateP2PMsg("".concat(t.report_msg_id),{ack_ts:Date.now(),error_code:i}),null==o||o.reportP2PMsg("".concat(t.report_msg_id))}},Qf=(e,t,i)=>{const o=Wf.get(e);return null!=o&&o.needReport("one2many")&&(i.enable_report=!0,i.report_msg_id=t,o.cacheCustomMsg({rts_session_id:o.rtsSessionId,msg_id:"".concat(t),node_role:"src_sdk",from:i.clientId,to:o.roomId||i.roomId,msg_type:"one2many",type:"one2many",rts_room_id:o.roomId,req_ts:Date.now(),send_ts:Date.now(),ack_ts:Date.now(),msg_size:0,error_code:0,recv_msg_ts:0,fwd_msg_ts:0,reply_ack_ts:0,cur_dst_uid:""})),i},qf=(e,t,i)=>{if(t.enable_report&&nm(t.report_msg_id)){const o=Wf.get(e),r=t.to?"one2one":"one2many";null==o||o.reportMsgRecv({rts_session_id:o.rtsSessionId,msg_id:"".concat(t.report_msg_id),msg_size:i.msg_size,node_role:"dst_sdk",msg_type:r,type:r,rts_room_id:t.room,from:t.from,to:t.to||t.room,error_code:0,recv_msg_ts:i.recv_msg_ts,fwd_msg_ts:i.fwd_msg_ts,reply_ack_ts:Date.now(),cur_dst_uid:t.to?"":o.userId,config_version:"",req_ts:0,send_ts:0,ack_ts:0})}},$f=(e,t,i)=>{if(t.enable_report&&nm(t.report_msg_id)){const o=Wf.get(e);o&&(null==o||o.updateOne2ManyMsg("".concat(t.report_msg_id),{ack_ts:Date.now(),error_code:i}),null==o||o.reportOne2ManyMsg("".concat(t.report_msg_id)))}},eS=(e,t,i)=>{if(t.enable_report&&nm(t.report_msg_id)){const o=Wf.get(e);o&&o.updateOne2ManyMsg("".concat(t.report_msg_id),{send_ts:Date.now(),msg_size:i})}},tS=(e,t,i)=>{if(t.enable_report&&nm(t.report_msg_id)){const o=Wf.get(e);null==o||o.reportMsgRecv({rts_session_id:o.rtsSessionId,msg_id:"".concat(t.report_msg_id),msg_size:i.msg_size,node_role:"dst_sdk",msg_type:"one2many",type:"one2many",rts_room_id:t.roomId,from:t.clientId,to:t.roomId,error_code:0,recv_msg_ts:i.recv_msg_ts,fwd_msg_ts:i.fwd_msg_ts,reply_ack_ts:Date.now(),cur_dst_uid:o.userId,config_version:"",req_ts:0,send_ts:0,ack_ts:0})}};class iS{constructor(e){Xu(this,"_timer",void 0),Xu(this,"userMessage",{}),Xu(this,"roomMessage",{}),this.id=e,this._setTimer()}_setTimer(){const e=()=>{this._reportAndgReset(),clearTimeout(this._timer),this._timer=setTimeout(e,1e4)};e()}_reportAndgReset(){(Object.keys(this.userMessage).length||Object.keys(this.roomMessage).length)&&(this._report(),this._reset())}_report(){var e;null===(e=uS(this.id))||void 0===e||e.report("rtc_message_statistics",{dc_user_message:Object.keys(this.userMessage).map((e=>this.userMessage[e])),dc_room_message:Object.keys(this.roomMessage).map((e=>this.roomMessage[e])),media_server_ip:""})}_reset(){this.userMessage={},this.roomMessage={}}_checkInitUserMessage(e,t){this.userMessage["".concat(t,"-").concat(e)]||(this.userMessage["".concat(t,"-").concat(e)]={dc_peer_user_id:e,dc_send_total:0,dc_recv_total:0,dc_send_ack:0,dc_send_fail:0,dc_fail_timeout:0,dc_fail_no_receiver:0,dc_fail_no_relay_path:0,dc_cost_time:0,dc_cost_e2s:0,dc_cost_s2s:0,dc_least_time:Number(1/0),dc_most_time:0,dc_cost_peer_s2e:0,dc_send_ack_100:0,dc_send_ack_200:0,dc_send_ack_400:0,dc_send_ack_1s:0,dc_message_type:t,dc_send_binary:0})}_sendUserMessage(e,t,i){this._checkInitUserMessage(e,t),this.userMessage["".concat(t,"-").concat(e)].dc_send_total++,i&&this.userMessage["".concat(t,"-").concat(e)].dc_send_binary++}_recvUserMessage(e,t){this._checkInitUserMessage(e,t),this.userMessage["".concat(t,"-").concat(e)].dc_recv_total++}_sendUserFail(e,t,i){const o=this.userMessage["".concat(t,"-").concat(e)];o&&(o.dc_send_fail++,this._handleUserFail(o,i))}_handleUserFail(e,t){t&&(t.code||t.err)&&(["TIME_OUT","USER_MESSAGE_TIMEOUT"].includes(t.code)?e.dc_fail_timeout++:3===t.err?e.dc_fail_no_receiver++:4===t.err?e.dc_fail_no_relay_path++:1===t.err&&e.dc_fail_timeout++)}_sendUserAck(e,t,i,o,r){const s=this.userMessage["".concat(t,"-").concat(e)];s&&(s.dc_send_ack++,s.dc_cost_time+=i,s.dc_cost_s2s+=o||0,s.dc_cost_peer_s2e+=r,s.dc_cost_e2s+=i-(o||0)-r,i/2<=100?(s.dc_send_ack_100++,s.dc_send_ack_200++,s.dc_send_ack_400++,s.dc_send_ack_1s++):i/2<=200?(s.dc_send_ack_200++,s.dc_send_ack_400++,s.dc_send_ack_1s++):i/2<=400?(s.dc_send_ack_400++,s.dc_send_ack_1s++):i/2<=1e3&&s.dc_send_ack_1s++,i<s.dc_least_time&&(s.dc_least_time=i),i>s.dc_most_time&&(s.dc_most_time=i))}sendRoomMessage(e,t){this.roomMessage[e]||(this.roomMessage[e]={dc_room_id:e,dc_send_total:0,dc_send_ack:0,dc_cost_time:0,dc_least_time:Number(1/0),dc_most_time:0,dc_send_fail:0,dc_send_ack_100:0,dc_send_ack_200:0,dc_send_ack_400:0,dc_send_ack_1s:0,dc_send_binary:0}),this.roomMessage[e].dc_send_total++,t&&this.roomMessage[e].dc_send_binary++}sendRoomFail(e){const t=this.roomMessage[e];t&&t.dc_send_fail++}sendRoomAck(e,t){const i=this.roomMessage[e];i&&(i.dc_send_ack++,i.dc_cost_time+=t,t<i.dc_least_time&&(i.dc_least_time=t),t>i.dc_most_time&&(i.dc_most_time=t),t/2<=100?(i.dc_send_ack_100++,i.dc_send_ack_200++,i.dc_send_ack_400++,i.dc_send_ack_1s++):t/2<=200?(i.dc_send_ack_200++,i.dc_send_ack_400++,i.dc_send_ack_1s++):t/2<=400?(i.dc_send_ack_400++,i.dc_send_ack_1s++):t/2<=1e3&&i.dc_send_ack_1s++)}sendP2PMessage(e,t){this._sendUserMessage(e,"p2p",t)}recvP2PMessage(e){this._recvUserMessage(e,"p2p")}sendP2PFail(e,t){this._sendUserFail(e,"p2p",t)}sendP2PAck(e,t,i,o){this._sendUserAck(e,"p2p",t,i,o)}sendP2POutRoomMessage(e,t){this._sendUserMessage(e,"p2p_outside_room",t)}recvP2POutRoomMessage(e){this._recvUserMessage(e,"p2p_outside_room")}sendP2POutRoomFail(e,t){this._sendUserFail(e,"p2p_outside_room",t)}sendP2POutRoomAck(e,t,i,o){this._sendUserAck(e,"p2p_outside_room",t,i,o)}sendP2serverMessage(e){this._sendUserMessage("","p2server",e)}sendP2serverFail(e){this._sendUserFail("","p2server",e)}sendP2serveAck(e,t,i){this._sendUserAck("","p2server",e,t,i)}countP2PMessage(e,t,i,o,r){this.sendP2PMessage(t,i),e?this.sendP2PAck(t,Date.now()-o,r.s2s_time||0,r.s2e_time||0):this.sendP2PFail(t,r)}countRoomMessage(e,t,i,o){this.sendRoomMessage(t,i),e?this.sendRoomAck(t,Date.now()-o):this.sendRoomFail(t)}countUserMessageOutsideRoom(e,t,i,o,r){this.sendP2POutRoomMessage(t,i),e?this.sendP2POutRoomAck(t,Date.now()-o,r.s2s_time,r.s2e_time):this.sendP2POutRoomFail(t,r)}countServerMessage(e,t,i,o){this.sendP2serverMessage(t),e?(o=o||{},this.sendP2serveAck(Date.now()-i,o.s2s_time||0,o.s2e_time||0)):this.sendP2serverFail(o)}destroy(){this._reset(),clearTimeout(this._timer)}}const oS=e=>{Df.setCommonStats(e)},rS=e=>{Df.setUrl(e)},sS=new Uf("global"),nS=(e,t,i)=>{sS.report("rtc_sdk_api_call",{sdk_api_name:e,error_code:t,message:i})},aS=(e,t,i)=>{sS.report("rtc_sdk_callback",{sdk_callback_name:e,error_code:t,message:i})},dS=(e,t,i)=>{sS.report("rtc_error",{message:e,error_code:t},i)},cS=function(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"",r=arguments.length>4?arguments[4]:void 0;sS.report("rtc_invoke_status",{sdk_api_name:e,message:t,error_code:i,stream_id:o,elapse:0},r)};const lS=new Map,uS=e=>lS.get(e),hS=(e,t)=>{const i=new Uf(e);return i.set(Fu(Fu({},t),{},{engine_session_id:sm()})),i.report("sdk_init_engine",{start:Date.now(),type:"begin"}),lS.set(e,i),i},_S=new Map;function mS(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};t=Object.assign({debounce:0},t);const{debounce:i,debounceTag:o}=t;function r(e,t,o,r){if(!i)return t(...o);{const s="".concat(r,"_").concat(e),n=_S.get(s);clearTimeout(n);const a=setTimeout((()=>{t(...o)}),i);_S.set(s,a)}}return function(t,i,s){if("function"==typeof s.value){const t=s.value;s.value=function(){for(var s,n,a=arguments.length,d=new Array(a),c=0;c<a;c++)d[c]=arguments[c];const l=this.engineId||this.id,u=sm(),h={};var _,m;(e.forEach(((e,t)=>{h[e]=d[t]})),"joinRoom"===i)&&(null===(_=uS(l))||void 0===_||_.set({room_id:d[1],user_id:null===(m=d[2])||void 0===m?void 0:m.userId}));let p,v="";if(o)try{v=o(...d)}catch(f){}r(i,pS,[l,i,d,h,{event_session_id:u}],"start_".concat(v));try{p=t.apply(this,d)}catch(S){throw r(i,vS,[l,i,S.message,S.code||-1,{event_session_id:u}],"end_".concat(v)),S}return"function"==typeof(null===(s=p)||void 0===s?void 0:s.then)?p.then((e=>(r(i,vS,[l,i,[null!=e?e:{}],0,{event_session_id:u}],"end_".concat(v)),e))).catch((e=>{throw r(i,vS,[l,i,e.message,e.code,{event_session_id:u}],"end_".concat(v)),e})):(r(i,vS,[l,i,[null!==(n=p)&&void 0!==n?n:{}],0,{event_session_id:u}],"end_".concat(v)),p)}}}}const pS=function(e,t,i,o){var r;let s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};const n=Fu({sdk_api_name:t,message:JSON.stringify(gS(i)),error_code:0},s);null===(r=uS(e))||void 0===r||r.report("rtc_sdk_api_call",n,o)},vS=function(e,t,i){var o;let r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};const s=Fu({sdk_callback_name:t,error_code:arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,message:JSON.stringify(Array.isArray(i)?gS(i):i)},r);null===(o=uS(e))||void 0===o||o.report("rtc_sdk_callback",s)},fS=function(e,t,i){var o;let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"",n=arguments.length>5?arguments[5]:void 0;null===(o=uS(e))||void 0===o||o.report("rtc_invoke_status",{sdk_api_name:t,message:i,error_code:r,stream_id:s,elapse:0},n)},SS=10;function gS(e){const t=e=>{if(null!=e&&e._reportName)return e._reportName;if(e instanceof HTMLElement)return e.toString();if(e instanceof ArrayBuffer||ArrayBuffer.isView(e)){const t=ArrayBuffer.isView(e)?e.buffer:e,o=t.byteLength;let r=[];if(o>SS){var i;const e=new DataView(t);r=[...Array.from({length:SS/2}).map(((t,i)=>e.getUint8(i))),"...",...Hh(i=Array.from({length:SS/2}).map(((e,t)=>o-1-t))).call(i).map((t=>e.getUint8(t)))]}else r=Array.from(new Uint8Array(t));return"".concat(e.constructor.name,"(").concat(o,") [").concat(r.join(", "),"]")}if(e instanceof ImageData)return"ImageData";if(Array.isArray(e))return e.map(t);if(["[object Object]","[object MediaStreamTrack]"].includes(Object.prototype.toString.call(e))){const i={};for(const o in e)i[o]=t(e[o]);return i}return e instanceof Function?"[User Function]":e};return e.map(t)}const yS="undefined"!=typeof window&&window.location.search.includes("_rtc_upload_console_");function bS(e,t){return e.map((e=>{let i="";try{if("string"==typeof e)return e;if(void 0===e)return"undefined";if(null===e)return"null";if(e instanceof MediaStreamTrack)return am(e);if(e instanceof MediaStream)return dm(e);if(e instanceof RTCRtpSender)return cm(e);if(e instanceof RTCRtpReceiver)return lm(e);if(e instanceof RTCRtpTransceiver)return um(e);i=JSON.stringify(e)}catch(o){i=e.toString()}return i&&i.length>=t&&(i=i.slice(0,t)),i})).join(", ")}var TS,IS=new class{constructor(){Xu(this,"name","ConsoleReportor"),Xu(this,"_uuid","".concat(Math.floor(899*Math.random())+100)),Xu(this,"_consoleReportId",0),Xu(this,"_engineReportIdMap",new Map),Xu(this,"_enabled","NULL"),Xu(this,"_consoleCutLength",fm.getParameter("UPLOAD_CONSOLE_LENGTH_CUT")),Xu(this,"buffer",[]),yS&&setTimeout((()=>{this.switchOn()}),0),fm.on("UPLOAD_CONSOLE_ON",(e=>{e?this.switchOn():this.turnOff()})),fm.on("UPLOAD_CONSOLE_LENGTH_CUT",(e=>{this._consoleCutLength=e}))}get enabled(){return"OFF"!==this._enabled}switchOn(){"NULL"===this._enabled&&(console.log("[LoggerReportor.constructor] console upload switch ON"),this._enabled="ON")}turnOff(){"NULL"===this._enabled&&(console.log("[LoggerReportor.constructor] console upload switch OFF"),this._enabled="OFF",this.buffer=[])}getEngineConsoleId(e){var t;const i=null!==(t=this._engineReportIdMap.get(e))&&void 0!==t?t:0;return this._engineReportIdMap.set(e,i+1),i}report(e,t,i,o,r,s,n,a,d){if("OFF"===this._enabled)return;const c=uS(t),l=this._consoleReportId++,u=this.getEngineConsoleId(t),h=bS(d,this._consoleCutLength),_=[...d],m="".concat(a).replace(/%o|%s/gi,(()=>bS([_.shift()],this._consoleCutLength))),p="[".concat(this._uuid,"-").concat(l,"][").concat(t,"-").concat(u,"]-").concat(i,"-").concat(e,"[").concat(o,"]").concat(r,"[").concat(s,".").concat(n,"] ").concat(m," ").concat(h);var v;c?c.reportLog(p):(v=p,sS.reportLog(v))}push(e){"OFF"!==this._enabled&&this.buffer.push(e)}splice(e){if("ON"!==this._enabled)return{payload:[],payloadSize:0};const{index:t,size:i}=function(e,t){let i=0;for(let o=0;o<e.length;o++){const r=JSON.stringify(e[o]).length;if(i+=r,i>t)return{index:o,size:i-r}}return{index:e.length,size:i}}(this.buffer,e);return{payload:this.buffer.splice(0,t),payloadSize:i}}unshift(e){this.buffer=e.concat(this.buffer)}get(){return this.buffer}set(e){this.buffer=e.concat(this.buffer)}isEmpty(){return"OFF"===this._enabled||0===this.buffer.length}};const ES="[VERTC]",RS="#0050b3",CS={DEBUG:"rgba(0, 0, 0, 0)"," INFO":"rgba(93, 173, 226, 0)"," WARN":"rgba(255, 119, 0, 0.3)",ERROR:"rgba(255, 0, 0, 0.3)"," SUCC":"rgba(0, 119, 0, 0.3)"},kS="undefined"!=typeof window&&(window.location.search.includes("_rtc_debug_")||(null===(TS=window.localStorage)||void 0===TS?void 0:TS.getItem("_rtc_debug_")));const AS=()=>{const e=new Date;return"".concat(e.toTimeString().split(" ")[0],":").concat(e.getMilliseconds().toString().padStart(3,"0"))};var PS,NS,wS,OS,MS,LS=class{constructor(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"global";Xu(this,"indent",void 0),Xu(this,"module",void 0),Xu(this,"_engineId",void 0),this.module=e,this.indent=t,this._engineId=i}_print(e,t){for(var i=arguments.length,o=new Array(i>2?i-2:0),r=2;r<i;r++)o[r-2]=arguments[r];const s=o.shift();try{const e=[...o],i="".concat(s).replace(/%o/gi,(()=>{const t=e.shift();return JSON.stringify(t)}));mm.set("".concat(ES,"[").concat(this.module,".").concat(t,"] ").concat(i," ").concat(e.map((e=>JSON.stringify(e))).join(", ")))}catch(wZ){}let n="";for(let d=0;d<this.indent;d++)n+="    ";const a=AS();IS.report(ES,this._engineId,a,e,n,this.module,t,s,o),kS&&console.log("%c".concat(a,"-").concat(ES,"%c[").concat(e,"]%c").concat(n,"[").concat(this.module,".").concat(t,"] ").concat(s),"color:".concat(RS,";"),"background-color:".concat(CS[e],";"),"color:".concat(RS,";"),...o)}print(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),o=1;o<t;o++)i[o-1]=arguments[o];this._print(" INFO",e,...i)}debug(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),o=1;o<t;o++)i[o-1]=arguments[o];this._print("DEBUG",e,...i)}info(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),o=1;o<t;o++)i[o-1]=arguments[o];this._print(" INFO",e,...i)}warn(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),o=1;o<t;o++)i[o-1]=arguments[o];this._print(" WARN",e,...i)}error(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),o=1;o<t;o++)i[o-1]=arguments[o];this._print("ERROR",e,...i)}success(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),o=1;o<t;o++)i[o-1]=arguments[o];this._print(" SUCC",e,...i)}};const xS=()=>"undefined"==typeof window,VS=xS()?"":window.navigator.userAgent;function DS(){let e="none";return xS()||(null!==VS.match("Firefox")?e="mozilla":null!==VS.match("Chrome")?(e="chrome-stable",null!==VS.match("Electron")&&(e="electron")):(null!==VS.match("Safari")||null!==VS.match("AppleWebKit"))&&(e="safari")),e}const US="mozilla"===DS(),ZS="safari"===DS(),WS="chrome-stable"===DS(),XS=!xS()&&/CriOS/i.test(VS),GS=!xS()&&/Edg\//i.test(VS),FS=!xS()&&/EdgA/i.test(VS),HS=!xS()&&/EdgiOS/i.test(VS),YS=GS||FS||HS,KS=!xS()&&/DingTalk/i.test(navigator.userAgent),BS=!xS()&&/OPR\//.test(navigator.userAgent),JS=!xS()&&(!!/(iPad)/i.exec(VS)||/Macintosh/i.test(VS)&&"ontouchend"in document),jS=!xS()&&/Macintosh/i.test(VS),zS=!xS()&&/MicroMessenger/i.test(VS),QS=!xS()&&VS.toLowerCase().includes("mobile"),qS=!xS()&&!!/(iPhone|iPad|iPod)/i.exec(VS),$S=!xS()&&/Android/i.test(VS),eg=!xS()&&/Windows/i.test(VS),tg=!xS()&&/OpenHarmony/i.test(VS);let ig=0,og="0";const rg=!xS()&&(null===(PS=VS.match(/version\/(\d+)/i))||void 0===PS?void 0:PS[1]);var sg;ZS&&rg&&(ig=Number(rg),og=null===(sg=navigator.userAgent.match(/version\/(\d+\.\d+)/i))||void 0===sg?void 0:sg[1]);const ng=!xS()&&(null===(NS=VS.match(/Firefox\/(\d+)/i))||void 0===NS?void 0:NS[1]);US&&ng&&(ig=Number(ng));const ag=ig,dg=ig,cg=og,lg=null!==(wS=!xS()&&(null===(OS=VS.match(/ ([\d_]+) like Mac OS X/i))||void 0===OS||null===(OS=OS[1])||void 0===OS?void 0:OS.split("_").map((e=>parseInt(e)))))&&void 0!==wS?wS:[];let ug=0;const hg=!xS()&&(null===(MS=VS.match(/Chrome\/(\d+)/i))||void 0===MS?void 0:MS[1]);hg&&(ug=Number(hg));const _g=ug,mg="VolcEngine",pg="RTC_DEVICE_ID",vg="RTC_ACCESS_NODE",fg="RTC_ACCESS_URLS",Sg="ENGINE_WEB_CONFIG",gg="SERVER_CONFIG";class yg{get(e){const t=localStorage.getItem(e);if(!t)return null;try{const i=JSON.parse(t);return i.ttl>0&&Date.now()-i.saveTime>i.ttl?(this.delete(e),null):i.message}catch(i){return null}}set(e,t){const i={ttl:arguments.length>2&&void 0!==arguments[2]?arguments[2]:-1,saveTime:Date.now(),message:t};try{return localStorage.setItem(e,JSON.stringify(i)),!0}catch(o){return!1}}getTtl(e){const t=localStorage.getItem(e);if(!t)return null;try{return JSON.parse(t).ttl}catch(i){return null}}delete(e){try{return localStorage.removeItem(e),!0}catch(t){return!1}}}var bg=new class extends yg{constructor(){super(...arguments),Xu(this,"_accessVersion","v2")}getDeviceId(){if(xS())return"";let e=this.get(pg);return e&&!/^[0-9a-f]{8}(-[0-9a-f]{4}){3}-[0-9a-f]{12}$/.test(e)||(e=function(e){let t="";for(let i=0;i<e;i++)t+=Math.floor(10*Math.random());return t}(16)),this.setDeviceId(e),e}setDeviceId(e){return oS({device_id:e}),this.set(pg,e),e}getAccessKey(e){return"".concat(vg,"_").concat(e,"-").concat(mg,"-").concat(this._accessVersion)}getAccessNode(e){return this.get(this.getAccessKey(e))}setAccessNode(e,t,i){return this.set(this.getAccessKey(e),t,1e3*i)}deleteAccessNode(e,t){let i=this.getAccessNode(e);const o=this.getTtl(this.getAccessKey(e));Array.isArray(i)&&i.length>0&&(i=i.filter((e=>e.mediaID!==t.mediaID&&e.msgKey!==t.msgKey)),i.length>0?this.setAccessNode(e,i,o||0):this.clearAccessNode(e))}clearAccessNode(e){if(e)this.delete(this.getAccessKey(e));else for(const t in localStorage)t.startsWith(vg)&&localStorage.removeItem(t)}getAccessUrls(){return this.get("".concat(fg,"-").concat(mg))}setAccessUrls(e){const t=e.map((e=>{let{host:t,path:i}=e;return"https://".concat(t).concat(i)}));return this.set("".concat(fg,"-").concat(mg),t)}clearAccessUrls(){this.delete("".concat(fg,"-").concat(mg))}getEngineWebConfig(e,t){var i;const o="".concat(e,"_").concat(t,"_").concat(this.getDeviceId()),r=this.get(Sg);return(null==r||null===(i=r.find((e=>e.key===o)))||void 0===i?void 0:i.config)||{}}setEngineWebConfig(e,t,i){if(!i)return;const o="".concat(e,"_").concat(t,"_").concat(this.getDeviceId());let r=this.get(Sg)||[];return r=r.filter((e=>e.key!==o)),r.push({key:o,config:i}),this.set(Sg,r.slice(-5))}getServerConfig(e){var t;const i="".concat(e),o=this.get(gg);return(null==o||null===(t=o.find((e=>e.key===i)))||void 0===t?void 0:t.config)||{}}setServerConfig(e,t){if(!t)return;const i="".concat(e);let o=this.get(gg)||[];return o=o.filter((e=>e.key!==i)),o.push({key:i,config:t}),this.set(gg,o.slice(-5))}};const Tg=new LS("JoinRoomConfig",0);class Ig{constructor(e){Xu(this,"_useTcpAfterJoinTimeout",Ig.DEFAULT_CONF.useTcpAfterJoinTimeout),Xu(this,"_joinWithTcpOnly",Ig.DEFAULT_CONF.joinWithTcpOnly),Xu(this,"_joinWithTcpOnlyDelay",Ig.DEFAULT_CONF.joinWithTcpOnlyDelay),Xu(this,"_blackBrowserRegexList",[]),this._engineId=e,location.search.indexOf("__rtc_tcp_only__")>-1&&(this._joinWithTcpOnly=!0,this._joinWithTcpOnlyDelay=0),this._report()}static setDefaulConf(e){let{useTcpAfterJoinTimeout:t,joinWithTcpOnly:i,joinWithTcpOnlyDelay:o}=e;return"boolean"==typeof t&&(Ig.DEFAULT_CONF.useTcpAfterJoinTimeout=t),"boolean"==typeof i&&(Ig.DEFAULT_CONF.joinWithTcpOnly=i),"number"==typeof o&&(Ig.DEFAULT_CONF.joinWithTcpOnlyDelay=Math.max(0,o)),Ig.DEFAULT_CONF}get useTcpAfterJoinTimeout(){return this._useTcpAfterJoinTimeout}get useTcpJoin(){return this._joinWithTcpOnly}get useTcpJoinDelay(){return this._joinWithTcpOnlyDelay}isBlackBrower(){return this._blackBrowserRegexList.find((e=>new RegExp(e).test(navigator.userAgent)))}setServerConfig(e){var t,i,o;let r=!1;"boolean"==typeof(null==e||null===(t=e.use_tcp_after_join_timeout)||void 0===t?void 0:t.enable)&&(this._useTcpAfterJoinTimeout=e.use_tcp_after_join_timeout.enable,r=!0),"boolean"==typeof(null==e||null===(i=e.join_with_tcp_only)||void 0===i?void 0:i.enable)&&(this._joinWithTcpOnly=e.join_with_tcp_only.enable,r=!0),"number"==typeof(null==e||null===(o=e.join_with_tcp_only)||void 0===o?void 0:o.delay_ms)&&(this._joinWithTcpOnlyDelay=e.join_with_tcp_only.delay_ms,r=!0),e&&Array.isArray(e.black_browser_regex_list)&&(this._blackBrowserRegexList=e.black_browser_regex_list,r=!0),r&&this._report()}toString(){return JSON.stringify({use_tcp_after_join_timeout:this._useTcpAfterJoinTimeout,join_with_tcp_only:this._joinWithTcpOnly,join_with_tcp_only_delay:this._joinWithTcpOnlyDelay,black_browser_regex_list:this._blackBrowserRegexList})}_report(){Tg.print("_report",this.toString()),fS(this._engineId,"web_join_room_config",this.toString())}}Xu(Ig,"DEFAULT_CONF",{useTcpAfterJoinTimeout:!0,joinWithTcpOnly:!1,joinWithTcpOnlyDelay:5e3});var Eg=(e=>(e.INVALID_ENGINE="INVALID_ENGINE",e.INVALID_PARAMS="INVALID_PARAMS",e.INVOKED_BEFORE_JOIN_ROOM="INVOKED_BEFORE_JOIN_ROOM",e.INVALID_TOKEN="INVALID_TOKEN",e.JOIN_ROOM_FAILED="JOIN_ROOM_FAILED",e.UPDATE_TOKEN_WITH_INVALID_TOKEN="UPDATE_TOKEN_WITH_INVALID_TOKEN",e.UPDATE_TOKEN_BEFORE_JOIN="UPDATE_TOKEN_BEFORE_JOIN",e.REPEAT_JOIN="REPEAT_JOIN",e.REPEAT_PUBLISH="REPEAT_PUBLISH",e.REPEAT_PUSH="REPEAT_PUSH",e.REPEAT_PLAY="REPEAT_PLAY",e.PUBLISH_BEFORE_JOIN="PUBLISH_BEFORE_JOIN",e.UNPUBLISH_BEFORE_JOIN="UNPUBLISH_BEFORE_JOIN",e.SUBSCRIBE_BEFORE_JOIN="SUBSCRIBE_BEFORE_JOIN",e.UNSUBSCRIBE_BEFORE_JOIN="UNSUBSCRIBE_BEFORE_JOIN",e.NO_PUBLISH_PERMISSION="NO_PUBLISH_PERMISSION",e.STREAM_NOT_EXIST="STREAM_NOT_EXIST",e.EMPTY_STREAM="EMPTY_STREAM",e.NOT_CONNECTED_YET="NOT_CONNECTED_YET",e.IM_BEFORE_JOIN="IM_BEFORE_JOIN",e.USER_NOT_EXIST="USER_NOT_EXIST",e.ALREADY_IN_ROOM="ALREADY_IN_ROOM",e.KICKED_OUT="KICKED_OUT",e.ROOM_DISMISS="ROOM_DISMISS",e.TOKEN_EXPIRED="TOKEN_EXPIRED",e.TOKEN_NO_PUBLISH_PERMISSION="TOKEN_NO_PUBLISH_PERMISSION",e.TOKEN_NO_SUBSCRIBE_PERMISSION="TOKEN_NO_SUBSCRIBE_PERMISSION",e.DUPLICATE_LOGIN="DUPLICATE_LOGIN",e.INVOKED_BEFORE_CAPTURE="INVOKED_BEFORE_CAPTURE",e.REPEAT_CAPTURE="REPEAT_CAPTURE",e.GET_VIDEO_TRACK_FAILED="GET_VIDEO_TRACK_FAILED",e.GET_AUDIO_TRACK_FAILED="GET_AUDIO_TRACK_FAILED",e.GET_SCREEN_TRACK_FAILED="GET_SCREEN_TRACK_FAILED",e.STREAM_TYPE_NOT_MATCH="STREAM_TYPE_NOT_MATCH",e.CANT_FIND_DOM="CANT_FIND_DOM",e.INVALID_DEVICE_ID="INVALID_DEVICE_ID",e.NO_PERMISSION="NO_PERMISSION",e.NOT_SUPPORTED="NOT_SUPPORTED",e.INTERRUPT="INTERRUPT",e.ICE_SERVER_WRONG="ICE_SERVER_WRONG",e.ESTABLISH_DATACHANNEL_FAILED="ESTABLISH_DATACHANNEL_FAILED",e.LOAD_RESOURCES_FAILED="LOAD_RESOURCES_FAILED",e.SIGNALING_CHANNEL_NOT_OPEN="SIGNALING_CHANNEL_NOT_OPEN",e.TIME_OUT="TIME_OUT",e.REFUSE_OPERATION_IN_DISCONNECT="REFUSE_OPERATION_IN_DISCONNECT",e.ADD_TRANSCEIVER_FAILED="ADD_TRANSCEIVER_FAILED",e.UPDATE_TRACK_FAILED="UPDATE_TRACK_FAILED",e.PUBLISH_FAILED="PUBLISH_FAILED",e.UNPUBLISH_FAILED="UNPUBLISH_FAILED",e.SUBSCRIBE_FAILED="SUBSCRIBE_FAILED",e.UNSUBSCRIBE_FAILED="UNSUBSCRIBE_FAILED",e.OPERATION_CANCEL="OPERATION_CANCEL",e.START_CLOUD_PROXY_AFTER_JOIN="START_CLOUD_PROXY_AFTER_JOIN",e.STOP_CLOUD_PROXY_BEFORE_LEAVE="STOP_CLOUD_PROXY_BEFORE_LEAVE",e.UNEXPECTED_ERROR="UNEXPECTED_ERROR",e.REPEAT_DEVICE_TEST="REPEAT_DEVICE_TEST",e.AUDIO_DEVICE_TEST_FAILED="AUDIO_DEVICE_RECORD_FAILED",e.ALREADY_LOGIN="ALREADY_LOGIN",e.LOGIN_FAILED="LOGIN_FAILED",e.NOT_LOGIN="NOT_LOGIN",e.RTM_DUPLICATE_LOGIN="RTM_DUPLICATE_LOGIN",e.RTM_TOKEN_ERROR="RTM_TOKEN_ERROR",e.USER_MESSAGE_TIMEOUT="USER_MESSAGE_TIMEOUT",e.USER_MESSAGE_BROKEN="USER_MESSAGE_BROKEN",e.USER_MESSAGE_NO_RECEIVER="USER_MESSAGE_NO_RECEIVER",e.USER_MESSAGE_NO_RELAYPATH="USER_MESSAGE_NO_RELAYPATH",e.USER_MESSAGE_EXCEED_QPS="USER_MESSAGE_EXCEED_QPS",e.USER_MESSAGE_SEND_TO_SERVER_ERROR="USER_MESSAGE_SEND_TO_SERVER_ERROR",e.USER_MESSAGE_SERVER_RESPONSE_ERROR="USER_MESSAGE_SERVER_RESPONSE_ERROR",e.USER_MESSAGE_NOT_JOIN="USER_MESSAGE_NOT_JOIN",e.USER_MESSAGE_INIT="USER_MESSAGE_INIT",e.USER_MESSAGE_NO_CONNECTION="USER_MESSAGE_NO_CONNECTION",e.USER_MESSAGE_NOT_LOGIN="USER_MESSAGE_NOT_LOGIN",e.USER_MESSAGE_SERVER_PARAMS_NOTSET="USER_MESSAGE_SERVER_PARAMS_NOTSET",e.USER_MESSAGE_UNKNOWN="USER_MESSAGE_UNKNOWN",e.START_PUBLIC_STREAM_BEFORE_JOIN="START_PUBLIC_STREAM_BEFORE_JOIN",e.RECONNECT_FAILED="RECONNECT_FAILED",e.SUBTITLE_ALREADY_ON="SUBTITLE_ALREADY_ON",e.SUBTITLE_NOT_TURNED_ON="SUBTITLE_NOT_TURNED_ON",e.SUBTITLE_ERR_POSTPROCESS="SUBTITLE_ERR_POSTPROCESS",e.SUBTITLE_ERR_CONNECTION_ERROR="SUBTITLE_ERR_CONNECTION_ERROR",e.SUBTITLE_ERR_PROCESS_ERROR="SUBTITLE_ERR_PROCESS_ERROR",e.SUBTITLE_ERR_UNKNOWN="SUBTITLE_ERR_UNKNOWN",e.UNEXPECTED_INVOKE_FORWARD_STREAM="UNEXPECTED_INVOKE_FORWARD_STREAM",e.ROOM_FORBIDDEN="ROOM_FORBIDDEN",e.USER_FORBIDDEN="USER_FORBIDDEN",e.ERR_ELECTRON_IS_NULL="ERR_ELECTRON_IS_NULL",e.ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR="ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR",e.SET_SIMULCAST_FAILED="SET_SIMULCAST_FAILED",e.MIXING_OLD_AND_NEW_APIS="MIXING_OLD_AND_NEW_APIS",e.WTN_PUSH_FAILED="WTN_PUSH_FAILED",e.WTN_PLAY_FAILED="WTN_PLAY_FAILED",e.NOT_ALLOWED_IN_RTS_ROOM="NOT_ALLOWED_IN_RTS_ROOM",e.NOT_ALLOWED_IN_RESTRICTED_MODE="NOT_ALLOWED_IN_RESTRICTED_MODE",e))(Eg||{}),Rg=(e=>(e[e.AUDIO_MIXING_ERROR_OK=0]="AUDIO_MIXING_ERROR_OK",e[e.AUDIO_MIXING_ERROR_PRELOAD_FAILED=1]="AUDIO_MIXING_ERROR_PRELOAD_FAILED",e[e.AUDIO_MIXING_ERROR_START_FAILED=2]="AUDIO_MIXING_ERROR_START_FAILED",e[e.AUDIO_MIXING_ERROR_ID_NOT_FOUND=3]="AUDIO_MIXING_ERROR_ID_NOT_FOUND",e[e.AUDIO_MIXING_ERROR_SET_POSITION_FAILED=4]="AUDIO_MIXING_ERROR_SET_POSITION_FAILED",e[e.AUDIO_MIXING_ERROR_INVALID_VOLUME=5]="AUDIO_MIXING_ERROR_INVALID_VOLUME",e[e.AUDIO_MIXING_ERROR_LOAD_CONFLICT=6]="AUDIO_MIXING_ERROR_LOAD_CONFLICT",e[e.AUDIO_MIXING_ERROR_ID_TYPE_NOT_MATCH=7]="AUDIO_MIXING_ERROR_ID_TYPE_NOT_MATCH",e[e.AUDIO_MIXING_ERROR_ID_TYPE_INVALID_PITCH=8]="AUDIO_MIXING_ERROR_ID_TYPE_INVALID_PITCH",e[e.AUDIO_MIXING_ERROR_INVALID_AUDIO_TRACK=9]="AUDIO_MIXING_ERROR_INVALID_AUDIO_TRACK",e))(Rg||{});class Cg extends Error{constructor(e,t,i){super(t),Xu(this,"code",void 0),Xu(this,"message",void 0),Xu(this,"error",void 0),this.code=e,this.message=t,this.error=i,Object.setPrototypeOf(this,Cg.prototype)}toString(){return"SDKError: ".concat(this.code," ").concat(this.message)}}function kg(e,t){if("boolean"!=typeof e)throw new Cg(Eg.INVALID_PARAMS,"Invalid ".concat(t,": The value should be boolean type."))}const Ag=()=>!rm()&&"function"==typeof HTMLVideoElement.prototype.requestVideoFrameCallback;function Pg(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:Number.POSITIVE_INFINITY;if(e<i||e>o||"number"!=typeof e){throw new Cg(Eg.INVALID_PARAMS,"Invalid ".concat(t,": the value range is [").concat(i,", ").concat(o,"]. integer only"))}}function Ng(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:Number.POSITIVE_INFINITY;if(null==e)throw new Cg(Eg.INVALID_PARAMS,"".concat(t," cannot be empty"));if(!function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Number.POSITIVE_INFINITY;return"string"==typeof e&&e.length<=i&&e.length>=t}(e,i,o))throw new Cg(Eg.INVALID_PARAMS,"Invalid ".concat(t,": The value should be string type. Length of the string: [").concat(i,",").concat(o,"]"))}function wg(e,t,i){if(!i.includes(e))throw new Cg(Eg.INVALID_PARAMS,"Invalid ".concat(t,": The value can only be set as ").concat(JSON.stringify(i)))}function Og(e){if(!(e instanceof MediaStreamTrack))throw new Cg(Eg.INVALID_PARAMS,"Invalid track, The value should be MediaStreamTrack type.")}function Mg(e,t){if(Vg(e))throw new Cg(Eg.INVALID_PARAMS,"Invalid ".concat(t,", should not be empty"))}function Lg(e,t){if(!(e instanceof ArrayBuffer))throw new Cg(Eg.INVALID_PARAMS,"Invalid ".concat(t,", should be ArrayBuffer"))}function xg(e){try{const t=navigator.mediaDevices.getSupportedConstraints();for(const i of Object.keys(e))t[i]||delete e[i]}catch(t){}}function Vg(e){return null==e}function Dg(e){if("string"!=typeof e||!/^[a-zA-Z0-9@._-]{1,128}$/.test(e))throw new Cg(Eg.INVALID_PARAMS,"The RoomId must be within 128 bytes. The supported characters: a-z,A-Z,0-9,@,-,_,.")}function Ug(e){if("string"!=typeof e||!/^[a-zA-Z0-9@._-]{1,128}$/.test(e))throw new Cg(Eg.INVALID_PARAMS,"The userId must be within 128 bytes. The supported characters: a-z,A-Z,0-9,@,-,_,.")}function Zg(e){if("string"!=typeof e||!/^[a-zA-Z0-9@._-]{1,128}$/.test(e))throw new Cg(Eg.INVALID_PARAMS,"The publicStreamId must be within 128 bytes. The supported characters: a-z,A-Z,0-9,@,-,_,.")}function Wg(e){Mg(e,"videoPlayerOption")}function Xg(e,t){if("number"==typeof e&&!Number.isNaN(e)&&e>=1)return;const i=e;if(!(null!=i&&i.min||null!=i&&i.max||null!=i&&i.exact||null!=i&&i.ideal))throw new Cg(Eg.INVALID_PARAMS,"".concat(t," is not a valid ConstrainULong"))}function Gg(e){!function(e,t){if(!Array.isArray(e))throw new Cg(Eg.INVALID_PARAMS,"Invalid ".concat(t,", should be array"))}(e,"videoEncoderConfig");for(const t of e)Mg(t,"videoEncoderConfigItem"),Pg(null==t?void 0:t.maxKbps,"maxKbps"),Xg(null==t?void 0:t.width,"width"),Xg(null==t?void 0:t.height,"height"),Xg(null==t?void 0:t.frameRate,"frameRate")}function Fg(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Number.NEGATIVE_INFINITY,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:Number.POSITIVE_INFINITY;return Pg(e,t,Number.NEGATIVE_INFINITY,Number.POSITIVE_INFINITY),e=(e=e>i?e:i)<o?e:o}var Hg=(e=>(e[e.NONE=0]="NONE",e))(Hg||{});const Yg="rtc-access-ag.bytedance.com,rtc-access.bytedance.com,rtc-access2-hl.bytedance.com,rtcg-access.bytevcloud.com".split(",");function Kg(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";return e?(/^https?:\/\/.+/.test(e)||(e="https://".concat(e)),"".concat(e,"/dispatch/v1/AccessInfo?Action=GetAccessInfo")):""}const Bg="https://web-log-report.rtc.volcvideo.com/video/v1/webrtc_log/",Jg="common.rtc.volcvideo.com,rtcg.volcvideos.com".split(","),jg={VERSION:"4.66.16",ICE_CONFIG_REQUEST_URLS_INTERNAL:Yg.map(Kg),ICE_CONFIG_REQUEST_URLS:[],EXPECTED_ADDR:"",LOG_SERVER_URL:Bg,CONFIG_REQUEST_DOMAINS:Jg,DEVICE_ID:"",OVERSEA:!1,PLATFORM:"",PRODUCT:"",FORCE_ENABLED_REPORT_CALLBACKS:[],SKIP_WEB_AUDIO_IN_TRACK:!1,ENFORCE_WEB_AUDIO_SUPPORTED:!1,AUDIO_STALL:!0,VIDEO_STALL:!0,VIDEO_STALL_100MS:!1,STATS_SCALLBACK_SUPPORT:!0,JOIN_ROOM_CONFIG:Ig.DEFAULT_CONF,SIGNAL_COMPRESSION:!0,SIGNAL_CROP_JOINROOM:!0,VIDEO_STALL_DATA:500,AUDIO_STALL_DATA:200,IOS_SAFARI_ORIENTATION:!1,BLACK_FRAME_LIFETIME:6e4,FALLBACK_ENCODE_CODEC:"",SEI_TIME_OUT:2e3,SEI_COUNT_FPS:1,PRE_ICE:!1,STATS_LOOP_INTERVAL:1e3,HIDDEN_STATS:!1,UPLOAD_REMOTE_STATS:Hg.NONE,SDK_CODEC_NEGOTIATION:!0,AUDIO_CODEC:"OPUS",DISABLE_ENCODED_TRANSFORM:!1,SKIP_SEI_FILTER:!1,AREA_CODE:"",DISABLE_COMPUTE_PRESSURE:!1,SEND_MESSAGE_SYNC:!1,H264_HW_ENCODER:!1,GPU_URL:"",ENABLE_FALLBACK_HANDLER:!1,ENABLE_STANDARD_HANDLER:!1,PC_KILLSWITCH:{},ENABLE_PLAY_AFTER_CLICK:!1};function zg(e,t){if(nS("setParameter",0,"key: ".concat(e,", value: ").concat(t)),"VERSION"===e)return;if("H264_HW_ENCODER"===e){jg.H264_HW_ENCODER=!!t;const e=RTCPeerConnection.prototype.setRemoteDescription;return void(RTCPeerConnection.prototype.setRemoteDescription=function(t){var i;return e.call(this,{type:t.type,sdp:null===(i=t.sdp)||void 0===i?void 0:w_(i).call(i,"42e01f","42001f")})})}if("GPU_URL"===e)return void(jg.GPU_URL=t);if("JOIN_ROOM_CONFIG"===e)return Ig.setDefaulConf(t);if("ICE_CONFIG_REQUEST_URLS"===e){const e="string"==typeof t?[t]:t;return jg.ICE_CONFIG_REQUEST_URLS=e.map(Kg),bg.clearAccessUrls(),void bg.clearAccessNode()}if("VIDEO_STALL_DATA"===e)return void(jg.VIDEO_STALL_DATA=Math.max(500,Number(t)));if("AUDIO_STALL_DATA"===e)return void(jg.AUDIO_STALL_DATA=Math.max(200,Number(t)));if("VIDEO_STALL_100MS"===e)return void(jg.VIDEO_STALL_100MS=Ag()&&!!t);if("PLATFORM"===e&&"string"==typeof t)return void oS({platform:t});if("PRODUCT"===e&&"string"==typeof t)return void oS({product:t});if("FORCE_ENABLED_REPORT_CALLBACKS"===e){const e="string"==typeof t?[t]:t;return void(jg.FORCE_ENABLED_REPORT_CALLBACKS=e)}if("LOG_SERVER_URL"===e){const e=t===dh.overseas?"https://web-log-report.volcvideos.com/video/v1/webrtc_log/":t===dh.domestic?Bg:"string"==typeof t?t:void 0;e&&(jg.LOG_SERVER_URL=e,rS(e))}else if("OVERSEA"===e)return oS({extra_is_oversea:t?"1":"0"}),void(jg.OVERSEA=t);if("CONFIG_REQUEST_DOMAINS"===e&&Array.isArray(t)&&t.length>0)return void(jg.CONFIG_REQUEST_DOMAINS=t);if("SEI_TIME_OUT"===e&&"number"!=typeof t)return;if("SEI_COUNT_FPS"===e&&"number"!=typeof t)return;if("UPLOAD_REMOTE_STATS"===e&&"string"==typeof t){const e=t.split(",").map((e=>z_(e).call(e))).reduce(((e,t)=>"video"===t?e|eh.VIDEO:"audio"===t?e|eh.AUDIO:e),Hg.NONE);return void(jg.UPLOAD_REMOTE_STATS=e)}if("AINR_URLS"===e&&"string"==typeof t)try{const{gulpUrl:e,wasmUrl:i,type5ModelUrl:o,type6ModelUrl:r}=JSON.parse(t);return void(jg.AINR_URLS={gulpUrl:e,wasmUrl:i,type5ModelUrl:o,type6ModelUrl:r})}catch(wZ){console.error(wZ)}"DEVICE_ID"===e&&bg.setDeviceId(t);fm.getKeys().includes(e)?fm.setParameter(e,t):Reflect.set(jg,e,t)}function Qg(e){return"DEVICE_ID"===e?bg.getDeviceId():jg[e]}function qg(e,t,i){var o,r,s,n,a,d,c,l;return{type:"publicstream",action:t,publicStreamID:e,publicStreamMeta:{audio:{},video:{fps:(null===(o=i.video)||void 0===o?void 0:o.fps)||15,bitrate:1e3*((null===(r=i.video)||void 0===r?void 0:r.kBitRate)||40),width:(null===(s=i.video)||void 0===s?void 0:s.width)||640,height:(null===(n=i.video)||void 0===n?void 0:n.height)||360},layout:{layoutMode:2,interpolationMode:(null===(a=i.layout)||void 0===a?void 0:a.interpolationMode)||uh.PREV_FRAME,canvas:{bgColor:(null===(d=i.layout)||void 0===d?void 0:d.backgroundColor)||"#000000",bgImage:(null===(c=i.layout)||void 0===c?void 0:c.backgroundImage)||""},regions:(null===(l=i.layout)||void 0===l||null===(l=l.regions)||void 0===l?void 0:l.map((e=>({roomId:e.roomId,userId:e.userId,alterImage:e.alertImage||"",alpha:!e.alpha||Number(e.alpha)>1||Number(e.alpha)<=0?1:Number(e.alpha),x:!e.x||Number(e.x)>=1||Number(e.x)<0?0:Number(e.x),y:!e.y||Number(e.y)>=1||Number(e.y)<0?0:Number(e.y),w:!e.w||Number(e.w)>1||Number(e.w)<=0?1:Number(e.w),h:!e.h||Number(e.h)>1||Number(e.h)<=0?1:Number(e.h),zorder:!e.zorder||Number(e.zorder)<0||Number(e.zorder)>100?0:Number(e.zorder),renderMode:void 0===e.renderMode?1:e.renderMode,streamType:e.isScreenStream?1:0,mediaType:e.mediaType||0,sourceCrop:e.sourceCrop}))))||[]}}}}let $g=[];function ey(e){$g=e}const ty=(e,t)=>{const i=$g;if(!i.length)return;const o=e[0],r=t.width||lb(o.width),s=t.height||lb(o.height),n=r*s;if(lb(o.width)*lb(o.height)<=n)return;let a,d,c=i[0];i.forEach((e=>{const t=lb(e.width)*lb(e.height);a||(n<t?a=e:c=e)})),d=a&&lb(a.width)*lb(a.height)-n<n-lb(c.width)*lb(c.height)?Object.assign({},a):Object.assign({},c);const l=e.filter((e=>!(d&&lb(e.width)*lb(e.height)>=n)||(d.maxKbps=Math.min(e.maxKbps,d.maxKbps),!1)));return l.unshift({width:r,height:s,frameRate:t.frameRate?Math.round(t.frameRate):l[0].frameRate,maxKbps:d.maxKbps}),l},iy={width:640,height:480,frameRate:15,maxKbps:600},oy={width:1920,height:1080,frameRate:15,maxKbps:3e3};let ry;const sy=new Uint8Array(16);function ny(){if(!ry&&(ry="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!ry))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return ry(sy)}const ay=[];for(let MZ=0;MZ<256;++MZ)ay.push((MZ+256).toString(16).slice(1));var dy={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function cy(e,t,i){if(dy.randomUUID&&!t&&!e)return dy.randomUUID();const o=(e=e||{}).random||(e.rng||ny)();if(o[6]=15&o[6]|64,o[8]=63&o[8]|128,t){i=i||0;for(let e=0;e<16;++e)t[i+e]=o[e];return t}return function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return ay[e[t+0]]+ay[e[t+1]]+ay[e[t+2]]+ay[e[t+3]]+"-"+ay[e[t+4]]+ay[e[t+5]]+"-"+ay[e[t+6]]+ay[e[t+7]]+"-"+ay[e[t+8]]+ay[e[t+9]]+"-"+ay[e[t+10]]+ay[e[t+11]]+ay[e[t+12]]+ay[e[t+13]]+ay[e[t+14]]+ay[e[t+15]]}(o)}var ly={exports:{}},uy=s;wi({global:!0,forced:uy.globalThis!==uy},{globalThis:uy});var hy=i(s);var _y,my,py={exports:{}},vy=new Proxy({},{get(e,t){throw new Error(`Module "" has been externalized for browser compatibility. Cannot access ".${t}" in client code.  See http://vitejs.dev/guide/troubleshooting.html#module-externalized-for-browser-compatibility for more details.`)}}),fy=o(Object.freeze({__proto__:null,default:vy}));function Sy(){return _y||(_y=1,py.exports=(e=e||function(e,i){var o;if("undefined"!=typeof window&&window.crypto&&(o=window.crypto),"undefined"!=typeof self&&self.crypto&&(o=self.crypto),void 0!==hy&&hy.crypto&&(o=hy.crypto),!o&&"undefined"!=typeof window&&window.msCrypto&&(o=window.msCrypto),!o&&void 0!==t&&t.crypto&&(o=t.crypto),!o)try{o=fy}catch(v){}var r=function(){if(o){if("function"==typeof o.getRandomValues)try{return o.getRandomValues(new Uint32Array(1))[0]}catch(v){}if("function"==typeof o.randomBytes)try{return o.randomBytes(4).readInt32LE()}catch(v){}}throw new Error("Native crypto module could not be used to get secure random number.")},s=Object.create||function(){function e(){}return function(t){var i;return e.prototype=t,i=new e,e.prototype=null,i}}(),n={},a=n.lib={},d=a.Base={extend:function(e){var t=s(this);return e&&t.mixIn(e),t.hasOwnProperty("init")&&this.init!==t.init||(t.init=function(){t.$super.init.apply(this,arguments)}),t.init.prototype=t,t.$super=this,t},create:function(){var e=this.extend();return e.init.apply(e,arguments),e},init:function(){},mixIn:function(e){for(var t in e)e.hasOwnProperty(t)&&(this[t]=e[t]);e.hasOwnProperty("toString")&&(this.toString=e.toString)},clone:function(){return this.init.prototype.extend(this)}},c=a.WordArray=d.extend({init:function(e,t){e=this.words=e||[],this.sigBytes=t!=i?t:4*e.length},toString:function(e){return(e||u).stringify(this)},concat:function(e){var t=this.words,i=e.words,o=this.sigBytes,r=e.sigBytes;if(this.clamp(),o%4)for(var s=0;s<r;s++){var n=i[s>>>2]>>>24-s%4*8&255;t[o+s>>>2]|=n<<24-(o+s)%4*8}else for(var a=0;a<r;a+=4)t[o+a>>>2]=i[a>>>2];return this.sigBytes+=r,this},clamp:function(){var t=this.words,i=this.sigBytes;t[i>>>2]&=4294967295<<32-i%4*8,t.length=e.ceil(i/4)},clone:function(){var e=d.clone.call(this);return e.words=this.words.slice(0),e},random:function(e){for(var t=[],i=0;i<e;i+=4)t.push(r());return new c.init(t,e)}}),l=n.enc={},u=l.Hex={stringify:function(e){for(var t=e.words,i=e.sigBytes,o=[],r=0;r<i;r++){var s=t[r>>>2]>>>24-r%4*8&255;o.push((s>>>4).toString(16)),o.push((15&s).toString(16))}return o.join("")},parse:function(e){for(var t=e.length,i=[],o=0;o<t;o+=2)i[o>>>3]|=parseInt(e.substr(o,2),16)<<24-o%8*4;return new c.init(i,t/2)}},h=l.Latin1={stringify:function(e){for(var t=e.words,i=e.sigBytes,o=[],r=0;r<i;r++){var s=t[r>>>2]>>>24-r%4*8&255;o.push(String.fromCharCode(s))}return o.join("")},parse:function(e){for(var t=e.length,i=[],o=0;o<t;o++)i[o>>>2]|=(255&e.charCodeAt(o))<<24-o%4*8;return new c.init(i,t)}},_=l.Utf8={stringify:function(e){try{return decodeURIComponent(escape(h.stringify(e)))}catch(t){throw new Error("Malformed UTF-8 data")}},parse:function(e){return h.parse(unescape(encodeURIComponent(e)))}},m=a.BufferedBlockAlgorithm=d.extend({reset:function(){this._data=new c.init,this._nDataBytes=0},_append:function(e){"string"==typeof e&&(e=_.parse(e)),this._data.concat(e),this._nDataBytes+=e.sigBytes},_process:function(t){var i,o=this._data,r=o.words,s=o.sigBytes,n=this.blockSize,a=s/(4*n),d=(a=t?e.ceil(a):e.max((0|a)-this._minBufferSize,0))*n,l=e.min(4*d,s);if(d){for(var u=0;u<d;u+=n)this._doProcessBlock(r,u);i=r.splice(0,d),o.sigBytes-=l}return new c.init(i,l)},clone:function(){var e=d.clone.call(this);return e._data=this._data.clone(),e},_minBufferSize:0});a.Hasher=m.extend({cfg:d.extend(),init:function(e){this.cfg=this.cfg.extend(e),this.reset()},reset:function(){m.reset.call(this),this._doReset()},update:function(e){return this._append(e),this._process(),this},finalize:function(e){return e&&this._append(e),this._doFinalize()},blockSize:16,_createHelper:function(e){return function(t,i){return new e.init(i).finalize(t)}},_createHmacHelper:function(e){return function(t,i){return new p.HMAC.init(e,i).finalize(t)}}});var p=n.algo={};return n}(Math),e)),py.exports;var e}ly.exports=(my=Sy(),function(){if("function"==typeof ArrayBuffer){var e=my.lib.WordArray,t=e.init,i=e.init=function(e){if(e instanceof ArrayBuffer&&(e=new Uint8Array(e)),(e instanceof Int8Array||"undefined"!=typeof Uint8ClampedArray&&e instanceof Uint8ClampedArray||e instanceof Int16Array||e instanceof Uint16Array||e instanceof Int32Array||e instanceof Uint32Array||e instanceof Float32Array||e instanceof Float64Array)&&(e=new Uint8Array(e.buffer,e.byteOffset,e.byteLength)),e instanceof Uint8Array){for(var i=e.byteLength,o=[],r=0;r<i;r++)o[r>>>2]|=e[r]<<24-r%4*8;t.call(this,o,i)}else t.apply(this,arguments)};i.prototype=e}}(),my.lib.WordArray);var gy,yy=i(ly.exports),by={exports:{}},Ty={exports:{}};function Iy(){return gy||(gy=1,function(e){e.exports=function(e){return function(){var t=e,i=t.lib.WordArray;function o(e,t,o){for(var r=[],s=0,n=0;n<t;n++)if(n%4){var a=o[e.charCodeAt(n-1)]<<n%4*2|o[e.charCodeAt(n)]>>>6-n%4*2;r[s>>>2]|=a<<24-s%4*8,s++}return i.create(r,s)}t.enc.Base64={stringify:function(e){var t=e.words,i=e.sigBytes,o=this._map;e.clamp();for(var r=[],s=0;s<i;s+=3)for(var n=(t[s>>>2]>>>24-s%4*8&255)<<16|(t[s+1>>>2]>>>24-(s+1)%4*8&255)<<8|t[s+2>>>2]>>>24-(s+2)%4*8&255,a=0;a<4&&s+.75*a<i;a++)r.push(o.charAt(n>>>6*(3-a)&63));var d=o.charAt(64);if(d)for(;r.length%4;)r.push(d);return r.join("")},parse:function(e){var t=e.length,i=this._map,r=this._reverseMap;if(!r){r=this._reverseMap=[];for(var s=0;s<i.length;s++)r[i.charCodeAt(s)]=s}var n=i.charAt(64);if(n){var a=e.indexOf(n);-1!==a&&(t=a)}return o(e,t,r)},_map:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="}}(),e.enc.Base64}(Sy())}(Ty)),Ty.exports}var Ey,Ry={exports:{}};function Cy(){return Ey||(Ey=1,function(e){e.exports=function(e){return function(t){var i=e,o=i.lib,r=o.WordArray,s=o.Hasher,n=i.algo,a=[];!function(){for(var e=0;e<64;e++)a[e]=4294967296*t.abs(t.sin(e+1))|0}();var d=n.MD5=s.extend({_doReset:function(){this._hash=new r.init([1732584193,4023233417,2562383102,271733878])},_doProcessBlock:function(e,t){for(var i=0;i<16;i++){var o=t+i,r=e[o];e[o]=16711935&(r<<8|r>>>24)|4278255360&(r<<24|r>>>8)}var s=this._hash.words,n=e[t+0],d=e[t+1],_=e[t+2],m=e[t+3],p=e[t+4],v=e[t+5],f=e[t+6],S=e[t+7],g=e[t+8],y=e[t+9],b=e[t+10],T=e[t+11],I=e[t+12],E=e[t+13],R=e[t+14],C=e[t+15],k=s[0],A=s[1],P=s[2],N=s[3];k=c(k,A,P,N,n,7,a[0]),N=c(N,k,A,P,d,12,a[1]),P=c(P,N,k,A,_,17,a[2]),A=c(A,P,N,k,m,22,a[3]),k=c(k,A,P,N,p,7,a[4]),N=c(N,k,A,P,v,12,a[5]),P=c(P,N,k,A,f,17,a[6]),A=c(A,P,N,k,S,22,a[7]),k=c(k,A,P,N,g,7,a[8]),N=c(N,k,A,P,y,12,a[9]),P=c(P,N,k,A,b,17,a[10]),A=c(A,P,N,k,T,22,a[11]),k=c(k,A,P,N,I,7,a[12]),N=c(N,k,A,P,E,12,a[13]),P=c(P,N,k,A,R,17,a[14]),k=l(k,A=c(A,P,N,k,C,22,a[15]),P,N,d,5,a[16]),N=l(N,k,A,P,f,9,a[17]),P=l(P,N,k,A,T,14,a[18]),A=l(A,P,N,k,n,20,a[19]),k=l(k,A,P,N,v,5,a[20]),N=l(N,k,A,P,b,9,a[21]),P=l(P,N,k,A,C,14,a[22]),A=l(A,P,N,k,p,20,a[23]),k=l(k,A,P,N,y,5,a[24]),N=l(N,k,A,P,R,9,a[25]),P=l(P,N,k,A,m,14,a[26]),A=l(A,P,N,k,g,20,a[27]),k=l(k,A,P,N,E,5,a[28]),N=l(N,k,A,P,_,9,a[29]),P=l(P,N,k,A,S,14,a[30]),k=u(k,A=l(A,P,N,k,I,20,a[31]),P,N,v,4,a[32]),N=u(N,k,A,P,g,11,a[33]),P=u(P,N,k,A,T,16,a[34]),A=u(A,P,N,k,R,23,a[35]),k=u(k,A,P,N,d,4,a[36]),N=u(N,k,A,P,p,11,a[37]),P=u(P,N,k,A,S,16,a[38]),A=u(A,P,N,k,b,23,a[39]),k=u(k,A,P,N,E,4,a[40]),N=u(N,k,A,P,n,11,a[41]),P=u(P,N,k,A,m,16,a[42]),A=u(A,P,N,k,f,23,a[43]),k=u(k,A,P,N,y,4,a[44]),N=u(N,k,A,P,I,11,a[45]),P=u(P,N,k,A,C,16,a[46]),k=h(k,A=u(A,P,N,k,_,23,a[47]),P,N,n,6,a[48]),N=h(N,k,A,P,S,10,a[49]),P=h(P,N,k,A,R,15,a[50]),A=h(A,P,N,k,v,21,a[51]),k=h(k,A,P,N,I,6,a[52]),N=h(N,k,A,P,m,10,a[53]),P=h(P,N,k,A,b,15,a[54]),A=h(A,P,N,k,d,21,a[55]),k=h(k,A,P,N,g,6,a[56]),N=h(N,k,A,P,C,10,a[57]),P=h(P,N,k,A,f,15,a[58]),A=h(A,P,N,k,E,21,a[59]),k=h(k,A,P,N,p,6,a[60]),N=h(N,k,A,P,T,10,a[61]),P=h(P,N,k,A,_,15,a[62]),A=h(A,P,N,k,y,21,a[63]),s[0]=s[0]+k|0,s[1]=s[1]+A|0,s[2]=s[2]+P|0,s[3]=s[3]+N|0},_doFinalize:function(){var e=this._data,i=e.words,o=8*this._nDataBytes,r=8*e.sigBytes;i[r>>>5]|=128<<24-r%32;var s=t.floor(o/4294967296),n=o;i[15+(r+64>>>9<<4)]=16711935&(s<<8|s>>>24)|4278255360&(s<<24|s>>>8),i[14+(r+64>>>9<<4)]=16711935&(n<<8|n>>>24)|4278255360&(n<<24|n>>>8),e.sigBytes=4*(i.length+1),this._process();for(var a=this._hash,d=a.words,c=0;c<4;c++){var l=d[c];d[c]=16711935&(l<<8|l>>>24)|4278255360&(l<<24|l>>>8)}return a},clone:function(){var e=s.clone.call(this);return e._hash=this._hash.clone(),e}});function c(e,t,i,o,r,s,n){var a=e+(t&i|~t&o)+r+n;return(a<<s|a>>>32-s)+t}function l(e,t,i,o,r,s,n){var a=e+(t&o|i&~o)+r+n;return(a<<s|a>>>32-s)+t}function u(e,t,i,o,r,s,n){var a=e+(t^i^o)+r+n;return(a<<s|a>>>32-s)+t}function h(e,t,i,o,r,s,n){var a=e+(i^(t|~o))+r+n;return(a<<s|a>>>32-s)+t}i.MD5=s._createHelper(d),i.HmacMD5=s._createHmacHelper(d)}(Math),e.MD5}(Sy())}(Ry)),Ry.exports}var ky,Ay={exports:{}},Py={exports:{}};function Ny(){return ky||(ky=1,function(e){e.exports=function(e){return i=(t=e).lib,o=i.WordArray,r=i.Hasher,s=t.algo,n=[],a=s.SHA1=r.extend({_doReset:function(){this._hash=new o.init([1732584193,4023233417,2562383102,271733878,3285377520])},_doProcessBlock:function(e,t){for(var i=this._hash.words,o=i[0],r=i[1],s=i[2],a=i[3],d=i[4],c=0;c<80;c++){if(c<16)n[c]=0|e[t+c];else{var l=n[c-3]^n[c-8]^n[c-14]^n[c-16];n[c]=l<<1|l>>>31}var u=(o<<5|o>>>27)+d+n[c];u+=c<20?1518500249+(r&s|~r&a):c<40?1859775393+(r^s^a):c<60?(r&s|r&a|s&a)-1894007588:(r^s^a)-899497514,d=a,a=s,s=r<<30|r>>>2,r=o,o=u}i[0]=i[0]+o|0,i[1]=i[1]+r|0,i[2]=i[2]+s|0,i[3]=i[3]+a|0,i[4]=i[4]+d|0},_doFinalize:function(){var e=this._data,t=e.words,i=8*this._nDataBytes,o=8*e.sigBytes;return t[o>>>5]|=128<<24-o%32,t[14+(o+64>>>9<<4)]=Math.floor(i/4294967296),t[15+(o+64>>>9<<4)]=i,e.sigBytes=4*t.length,this._process(),this._hash},clone:function(){var e=r.clone.call(this);return e._hash=this._hash.clone(),e}}),t.SHA1=r._createHelper(a),t.HmacSHA1=r._createHmacHelper(a),e.SHA1;var t,i,o,r,s,n,a}(Sy())}(Py)),Py.exports}var wy,Oy,My={exports:{}};function Ly(){return Oy||(Oy=1,function(e){e.exports=function(e){return i=(t=e).lib,o=i.Base,r=i.WordArray,s=t.algo,n=s.MD5,a=s.EvpKDF=o.extend({cfg:o.extend({keySize:4,hasher:n,iterations:1}),init:function(e){this.cfg=this.cfg.extend(e)},compute:function(e,t){for(var i,o=this.cfg,s=o.hasher.create(),n=r.create(),a=n.words,d=o.keySize,c=o.iterations;a.length<d;){i&&s.update(i),i=s.update(e).finalize(t),s.reset();for(var l=1;l<c;l++)i=s.finalize(i),s.reset();n.concat(i)}return n.sigBytes=4*d,n}}),t.EvpKDF=function(e,t,i){return a.create(i).compute(e,t)},e.EvpKDF;var t,i,o,r,s,n,a}(Sy(),Ny(),wy||(wy=1,function(e){e.exports=function(e){var t,i,o;i=(t=e).lib.Base,o=t.enc.Utf8,t.algo.HMAC=i.extend({init:function(e,t){e=this._hasher=new e.init,"string"==typeof t&&(t=o.parse(t));var i=e.blockSize,r=4*i;t.sigBytes>r&&(t=e.finalize(t)),t.clamp();for(var s=this._oKey=t.clone(),n=this._iKey=t.clone(),a=s.words,d=n.words,c=0;c<i;c++)a[c]^=1549556828,d[c]^=909522486;s.sigBytes=n.sigBytes=r,this.reset()},reset:function(){var e=this._hasher;e.reset(),e.update(this._iKey)},update:function(e){return this._hasher.update(e),this},finalize:function(e){var t=this._hasher,i=t.finalize(e);return t.reset(),t.finalize(this._oKey.clone().concat(i))}})}(Sy())}(My)))}(Ay)),Ay.exports}var xy,Vy={exports:{}};function Dy(){return xy||(xy=1,function(e){e.exports=function(e){e.lib.Cipher||function(t){var i=e,o=i.lib,r=o.Base,s=o.WordArray,n=o.BufferedBlockAlgorithm,a=i.enc;a.Utf8;var d=a.Base64,c=i.algo.EvpKDF,l=o.Cipher=n.extend({cfg:r.extend(),createEncryptor:function(e,t){return this.create(this._ENC_XFORM_MODE,e,t)},createDecryptor:function(e,t){return this.create(this._DEC_XFORM_MODE,e,t)},init:function(e,t,i){this.cfg=this.cfg.extend(i),this._xformMode=e,this._key=t,this.reset()},reset:function(){n.reset.call(this),this._doReset()},process:function(e){return this._append(e),this._process()},finalize:function(e){return e&&this._append(e),this._doFinalize()},keySize:4,ivSize:4,_ENC_XFORM_MODE:1,_DEC_XFORM_MODE:2,_createHelper:function(){function e(e){return"string"==typeof e?g:f}return function(t){return{encrypt:function(i,o,r){return e(o).encrypt(t,i,o,r)},decrypt:function(i,o,r){return e(o).decrypt(t,i,o,r)}}}}()});o.StreamCipher=l.extend({_doFinalize:function(){return this._process(!0)},blockSize:1});var u=i.mode={},h=o.BlockCipherMode=r.extend({createEncryptor:function(e,t){return this.Encryptor.create(e,t)},createDecryptor:function(e,t){return this.Decryptor.create(e,t)},init:function(e,t){this._cipher=e,this._iv=t}}),_=u.CBC=function(){var e=h.extend();function i(e,i,o){var r,s=this._iv;s?(r=s,this._iv=t):r=this._prevBlock;for(var n=0;n<o;n++)e[i+n]^=r[n]}return e.Encryptor=e.extend({processBlock:function(e,t){var o=this._cipher,r=o.blockSize;i.call(this,e,t,r),o.encryptBlock(e,t),this._prevBlock=e.slice(t,t+r)}}),e.Decryptor=e.extend({processBlock:function(e,t){var o=this._cipher,r=o.blockSize,s=e.slice(t,t+r);o.decryptBlock(e,t),i.call(this,e,t,r),this._prevBlock=s}}),e}(),m=(i.pad={}).Pkcs7={pad:function(e,t){for(var i=4*t,o=i-e.sigBytes%i,r=o<<24|o<<16|o<<8|o,n=[],a=0;a<o;a+=4)n.push(r);var d=s.create(n,o);e.concat(d)},unpad:function(e){var t=255&e.words[e.sigBytes-1>>>2];e.sigBytes-=t}};o.BlockCipher=l.extend({cfg:l.cfg.extend({mode:_,padding:m}),reset:function(){var e;l.reset.call(this);var t=this.cfg,i=t.iv,o=t.mode;this._xformMode==this._ENC_XFORM_MODE?e=o.createEncryptor:(e=o.createDecryptor,this._minBufferSize=1),this._mode&&this._mode.__creator==e?this._mode.init(this,i&&i.words):(this._mode=e.call(o,this,i&&i.words),this._mode.__creator=e)},_doProcessBlock:function(e,t){this._mode.processBlock(e,t)},_doFinalize:function(){var e,t=this.cfg.padding;return this._xformMode==this._ENC_XFORM_MODE?(t.pad(this._data,this.blockSize),e=this._process(!0)):(e=this._process(!0),t.unpad(e)),e},blockSize:4});var p=o.CipherParams=r.extend({init:function(e){this.mixIn(e)},toString:function(e){return(e||this.formatter).stringify(this)}}),v=(i.format={}).OpenSSL={stringify:function(e){var t=e.ciphertext,i=e.salt;return(i?s.create([1398893684,1701076831]).concat(i).concat(t):t).toString(d)},parse:function(e){var t,i=d.parse(e),o=i.words;return 1398893684==o[0]&&1701076831==o[1]&&(t=s.create(o.slice(2,4)),o.splice(0,4),i.sigBytes-=16),p.create({ciphertext:i,salt:t})}},f=o.SerializableCipher=r.extend({cfg:r.extend({format:v}),encrypt:function(e,t,i,o){o=this.cfg.extend(o);var r=e.createEncryptor(i,o),s=r.finalize(t),n=r.cfg;return p.create({ciphertext:s,key:i,iv:n.iv,algorithm:e,mode:n.mode,padding:n.padding,blockSize:e.blockSize,formatter:o.format})},decrypt:function(e,t,i,o){return o=this.cfg.extend(o),t=this._parse(t,o.format),e.createDecryptor(i,o).finalize(t.ciphertext)},_parse:function(e,t){return"string"==typeof e?t.parse(e,this):e}}),S=(i.kdf={}).OpenSSL={execute:function(e,t,i,o,r){if(o||(o=s.random(8)),r)n=c.create({keySize:t+i,hasher:r}).compute(e,o);else var n=c.create({keySize:t+i}).compute(e,o);var a=s.create(n.words.slice(t),4*i);return n.sigBytes=4*t,p.create({key:n,iv:a,salt:o})}},g=o.PasswordBasedCipher=f.extend({cfg:f.cfg.extend({kdf:S}),encrypt:function(e,t,i,o){var r=(o=this.cfg.extend(o)).kdf.execute(i,e.keySize,e.ivSize,o.salt,o.hasher);o.iv=r.iv;var s=f.encrypt.call(this,e,t,r.key,o);return s.mixIn(r),s},decrypt:function(e,t,i,o){o=this.cfg.extend(o),t=this._parse(t,o.format);var r=o.kdf.execute(i,e.keySize,e.ivSize,t.salt,o.hasher);return o.iv=r.iv,f.decrypt.call(this,e,t,r.key,o)}})}()}(Sy(),Ly())}(Vy)),Vy.exports}!function(e){e.exports=function(e){return function(){var t=e,i=t.lib.BlockCipher,o=t.algo,r=[],s=[],n=[],a=[],d=[],c=[],l=[],u=[],h=[],_=[];!function(){for(var e=[],t=0;t<256;t++)e[t]=t<128?t<<1:t<<1^283;var i=0,o=0;for(t=0;t<256;t++){var m=o^o<<1^o<<2^o<<3^o<<4;m=m>>>8^255&m^99,r[i]=m,s[m]=i;var p=e[i],v=e[p],f=e[v],S=257*e[m]^16843008*m;n[i]=S<<24|S>>>8,a[i]=S<<16|S>>>16,d[i]=S<<8|S>>>24,c[i]=S,S=16843009*f^65537*v^257*p^16843008*i,l[m]=S<<24|S>>>8,u[m]=S<<16|S>>>16,h[m]=S<<8|S>>>24,_[m]=S,i?(i=p^e[e[e[f^p]]],o^=e[e[o]]):i=o=1}}();var m=[0,1,2,4,8,16,32,64,128,27,54],p=o.AES=i.extend({_doReset:function(){if(!this._nRounds||this._keyPriorReset!==this._key){for(var e=this._keyPriorReset=this._key,t=e.words,i=e.sigBytes/4,o=4*((this._nRounds=i+6)+1),s=this._keySchedule=[],n=0;n<o;n++)n<i?s[n]=t[n]:(c=s[n-1],n%i?i>6&&n%i==4&&(c=r[c>>>24]<<24|r[c>>>16&255]<<16|r[c>>>8&255]<<8|r[255&c]):(c=r[(c=c<<8|c>>>24)>>>24]<<24|r[c>>>16&255]<<16|r[c>>>8&255]<<8|r[255&c],c^=m[n/i|0]<<24),s[n]=s[n-i]^c);for(var a=this._invKeySchedule=[],d=0;d<o;d++){if(n=o-d,d%4)var c=s[n];else c=s[n-4];a[d]=d<4||n<=4?c:l[r[c>>>24]]^u[r[c>>>16&255]]^h[r[c>>>8&255]]^_[r[255&c]]}}},encryptBlock:function(e,t){this._doCryptBlock(e,t,this._keySchedule,n,a,d,c,r)},decryptBlock:function(e,t){var i=e[t+1];e[t+1]=e[t+3],e[t+3]=i,this._doCryptBlock(e,t,this._invKeySchedule,l,u,h,_,s),i=e[t+1],e[t+1]=e[t+3],e[t+3]=i},_doCryptBlock:function(e,t,i,o,r,s,n,a){for(var d=this._nRounds,c=e[t]^i[0],l=e[t+1]^i[1],u=e[t+2]^i[2],h=e[t+3]^i[3],_=4,m=1;m<d;m++){var p=o[c>>>24]^r[l>>>16&255]^s[u>>>8&255]^n[255&h]^i[_++],v=o[l>>>24]^r[u>>>16&255]^s[h>>>8&255]^n[255&c]^i[_++],f=o[u>>>24]^r[h>>>16&255]^s[c>>>8&255]^n[255&l]^i[_++],S=o[h>>>24]^r[c>>>16&255]^s[l>>>8&255]^n[255&u]^i[_++];c=p,l=v,u=f,h=S}p=(a[c>>>24]<<24|a[l>>>16&255]<<16|a[u>>>8&255]<<8|a[255&h])^i[_++],v=(a[l>>>24]<<24|a[u>>>16&255]<<16|a[h>>>8&255]<<8|a[255&c])^i[_++],f=(a[u>>>24]<<24|a[h>>>16&255]<<16|a[c>>>8&255]<<8|a[255&l])^i[_++],S=(a[h>>>24]<<24|a[c>>>16&255]<<16|a[l>>>8&255]<<8|a[255&u])^i[_++],e[t]=p,e[t+1]=v,e[t+2]=f,e[t+3]=S},keySize:8});t.AES=i._createHelper(p)}(),e.AES}(Sy(),Iy(),Cy(),Ly(),Dy())}(by);var Uy=by.exports,Zy={exports:{}};!function(e){e.exports=function(e){return e.enc.Hex}(Sy())}(Zy);var Wy=i(Zy.exports),Xy={exports:{}};!function(e){e.exports=function(e){return e.mode.CTR=(t=e.lib.BlockCipherMode.extend(),i=t.Encryptor=t.extend({processBlock:function(e,t){var i=this._cipher,o=i.blockSize,r=this._iv,s=this._counter;r&&(s=this._counter=r.slice(0),this._iv=void 0);var n=s.slice(0);i.encryptBlock(n,0),s[o-1]=s[o-1]+1|0;for(var a=0;a<o;a++)e[t+a]^=n[a]}}),t.Decryptor=i,t),e.mode.CTR;var t,i}(Sy(),Dy())}(Xy);var Gy=i(Xy.exports),Fy={exports:{}};!function(e){e.exports=function(e){return e.pad.NoPadding={pad:function(){},unpad:function(){}},e.pad.NoPadding}(Sy(),Dy())}(Fy);var Hy,Yy=i(Fy.exports);const Ky=new TextDecoder,By=new TextEncoder,Jy=()=>cy(),jy=()=>Date.now();function zy(e){let t=0;for(var i=arguments.length,o=new Array(i>1?i-1:0),r=1;r<i;r++)o[r-1]=arguments[r];for(const a of o)t+=a.length;const s=new e(t);let n=0;for(const a of o)s.set(a,n),n+=a.length;return s}class Qy{static token2auth(e,t,i,o){return o?"Bearer ".concat(o):"Basic ".concat(Qy.createUnsafeToken(e,t,i))}static createUnsafeToken(e,t,i){return window.btoa([e,t,i].filter((e=>null!==e)).join(":"))}static merge(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};for(const[i,o]of Object.entries(e))null!==o&&"object"==typeof o?Qy.merge(e[i],t[i]):void 0!==t[i]&&(e[i]=t[i])}static ab2str(e){return Ky.decode(e)}static ab2obj(e){try{const t=Qy.ab2str(e);return JSON.parse(t)}catch(t){return{}}}static str2ab(e){return By.encode(e).buffer}static async ab2b64str(e){if(Qg("SEND_MESSAGE_SYNC")){const t=String.fromCharCode.apply(null,new Uint8Array(e));return window.btoa(t)}return(await new Promise((t=>{const i=new FileReader;i.onload=()=>t(i.result),i.readAsDataURL(new Blob([e]))}))).split(",",2)[1]}static async b64str2ab(e,t){return fetch("data:application/octet;base64,".concat(e)).then((e=>e.arrayBuffer())).catch((i=>{throw t&&t.report("rtc_error",{error_code:2001,message:"".concat(i.message," -> ").concat(e)}),i}))}}function qy(e){return new Promise((t=>{setTimeout(t,e)}))}function $y(){const e=Number("".concat(Math.random()).slice(-7).padEnd(7,"0")).toString(2).padEnd(28,"1").split(""),t=[];for(;e.length;)t.push(e.splice(0,7));return t.map(((e,i)=>{const o=i===t.length-1?"0":"1";return Number.parseInt(o+e.join(""),2)}))}const eb=()=>Math.floor(65535*Math.random());function tb(e){return"string"==typeof e&&e.indexOf("__web__rtc__rtt__")>-1}let ib;function ob(e){return Number(Math.max(-127,10*Math.log10(Math.pow(e/255,2))).toFixed(2))}function rb(e){return(e&eh.AUDIO)===eh.AUDIO}function sb(e){return(e&eh.VIDEO)===eh.VIDEO}function nb(e){const t={};return Object.keys(e).forEach((i=>{"object"==typeof e[i]?t[i]=nb(e[i]):i.startsWith("_")&&!Qg("HIDDEN_STATS")||(t[i]=e[i])})),t}function ab(e){return void 0===e}function db(e){return function(t,i,o){const r=o.value;o.value=function(){console.warn("[RTC WebSDK]: Api: ".concat(i," has been abandoned from version ").concat(e));for(var t=arguments.length,o=new Array(t),s=0;s<t;s++)o[s]=arguments[s];return r.apply(this,o)}}}function cb(e){console.warn("[RTC WebSDK]: ".concat(e))}function lb(e){return"number"==typeof e?e:"number"==typeof(null==e?void 0:e.exact)?e.exact:"number"==typeof(null==e?void 0:e.ideal)?e.ideal:"number"==typeof(null==e?void 0:e.max)?e.max:"number"==typeof(null==e?void 0:e.min)?e.min:1}class ub{constructor(){Xu(this,"_id",void 0),this._id=Math.ceil(Math.random()*Number.MAX_SAFE_INTEGER)}getMessageId(){return++this._id>Number.MAX_SAFE_INTEGER&&(this._id=0),this._id}}const hb="undefined"!=typeof window&&(window.location.search.includes("_rtc_debug_")||!(null===(Hy=window.localStorage)||void 0===Hy||!Hy.getItem("_rtc_debug_")));function _b(e){const t=atob(e),i=t.length,o=new Uint8Array(i);for(let r=0;r<i;r++)o[r]=t.charCodeAt(r);return o}function mb(e){let t="";const i=e.byteLength;for(let o=0;o<i;o++)t+=String.fromCharCode(e[o]);return btoa(t)}function pb(e,t,i){const o=vb(e),r=vb(t),s=vb(i);return function(e){const t=e.toString(Wy),i=new Uint8Array(t.length/2);for(let o=0;o<t.length;o+=2)i[o/2]=parseInt(t.substr(o,2),16);return i}(Uy.encrypt(o,r,{iv:s,mode:Gy,padding:Yy}).ciphertext)}function vb(e){const t=[];for(let i=0;i<e.length;i+=4)t.push(e[i]<<24|(e[i+1]||0)<<16|(e[i+2]||0)<<8|(e[i+3]||0));return yy.create(t,e.length)}function fb(){const e=document.createElement("canvas"),t=e.getContext("webgl")||e.getContext("experimental-webgl");if(!t)return{renderer:"unknown(WebGLRenderingContext not existed)",vendor:"unknown(WebGLRenderingContext not existed)"};const i=t.getExtension("WEBGL_debug_renderer_info");if(!i)return{renderer:"unknown(info not existed)",vendor:"unknown(info not existed)"};return{renderer:t.getParameter(i.UNMASKED_RENDERER_WEBGL),vendor:t.getParameter(i.UNMASKED_VENDOR_WEBGL)}}function Sb(e){var t,i;return e instanceof Error&&e.code?"".concat(e," | native.name=").concat(null===(t=e.error)||void 0===t?void 0:t.name," native.message=").concat(null===(i=e.error)||void 0===i?void 0:i.message):e instanceof Error?"NativeError: ".concat(e.name," ").concat(e.message):"UnknownError: ".concat(e)}var gb,yb,bb,Tb,Ib,Eb,Rb,Cb,kb,Ab,Pb,Nb;const wb={};function Ob(e,t){try{return e[t].toString().includes("[native code]")?"native":"non-native"}catch(i){return"untouchable"}}const Mb=("undefined"!=typeof window?[[null===(gb=window.RTCPeerConnection)||void 0===gb?void 0:gb.prototype,"RTCPeerConnection.prototype"],[window.RTCPeerConnection,"RTCPeerConnection"],[null===(yb=window.RTCDataChannel)||void 0===yb?void 0:yb.prototype,"RTCDataChannel.prototype"],[window.RTCDataChannel,"RTCDataChannel"],[null===(bb=window.MediaStreamTrack)||void 0===bb?void 0:bb.prototype,"MediaStreamTrack.prototype"],[window.MediaStreamTrack,"MediaStreamTrack"],[null===(Tb=window.MediaStream)||void 0===Tb?void 0:Tb.prototype,"MediaStream.prototype"],[window.MediaStream,"MediaStream"],[null===(Ib=window.HTMLAudioElement)||void 0===Ib?void 0:Ib.prototype,"HTMLAudioElement.prototype"],[null===(Eb=window.HTMLVideoElement)||void 0===Eb?void 0:Eb.prototype,"HTMLVideoElement.prototype"],[null===(Rb=window.HTMLMediaElement)||void 0===Rb?void 0:Rb.prototype,"HTMLMediaElement.prototype"],[null!==(Cb=null===(kb=window.AudioContext)||void 0===kb?void 0:kb.prototype)&&void 0!==Cb?Cb:null===(Ab=window.webkitAudioContext)||void 0===Ab?void 0:Ab.prototype,"AudioContext.prototype"],[null===(Pb=window.BaseAudioContext)||void 0===Pb?void 0:Pb.prototype,"BaseAudioContext.prototype"],[null===(Nb=window.AudioNode)||void 0===Nb?void 0:Nb.prototype,"AudioNode.prototype"],[window.navigator.mediaDevices,"navigator.mediaDevices"],[window.console,"console"]]:[]).reduce(((e,t)=>{let[i,o]=t;return e.concat(function(e,t){return e?Object.getOwnPropertyNames(e).filter((t=>{if("peerIdentity"===t)return!1;try{return"function"==typeof e[t]||void 0===e[t]}catch(i){return!1}})).map((i=>({obj:e,prefix:t,attr:i}))):[]}(i,o))}),[]);"undefined"!=typeof window&&Mb.push({obj:window.navigator.mediaDevices,prefix:"navigator.mediaDevices",attr:"getUserMedia"},{obj:window.navigator.mediaDevices,prefix:"navigator.mediaDevices",attr:"getDisplayMedia"},{obj:window.navigator.mediaDevices,prefix:"navigator.mediaDevices",attr:"enumerateDevices"},{obj:window.navigator.mediaDevices,prefix:"navigator.mediaDevices",attr:"getSupportedConstraints"});for(const{obj:MZ,prefix:LZ,attr:xZ}of Mb){const e="".concat(LZ,".").concat(xZ);wb[e]=Ob(MZ,xZ)}hb&&console.log("RTC_AMBULANCE",wb);const Lb=Object.entries(wb).filter((e=>{let[t,i]=e;return"non-native"===i})).map((e=>{let[t,i]=e;return t}));Object.keys(Lb).length&&console.warn("RTC_AMBULANCE","have non-native code:\n",Lb.join("\n"));let xb=!0,Vb=!0;function Db(e,t,i){const o=e.match(t);return o&&o.length>=i&&parseInt(o[i],10)}function Ub(e,t,i){if(!e.RTCPeerConnection)return;const o=e.RTCPeerConnection.prototype,r=o.addEventListener;o.addEventListener=function(e,o){if(e!==t)return r.apply(this,arguments);const s=e=>{const t=i(e);t&&(o.handleEvent?o.handleEvent(t):o(t))};return this._eventMap=this._eventMap||{},this._eventMap[t]||(this._eventMap[t]=new Map),this._eventMap[t].set(o,s),r.apply(this,[e,s])};const s=o.removeEventListener;o.removeEventListener=function(e,i){if(e!==t||!this._eventMap||!this._eventMap[t])return s.apply(this,arguments);if(!this._eventMap[t].has(i))return s.apply(this,arguments);const o=this._eventMap[t].get(i);return this._eventMap[t].delete(i),0===this._eventMap[t].size&&delete this._eventMap[t],0===Object.keys(this._eventMap).length&&delete this._eventMap,s.apply(this,[e,o])},Object.defineProperty(o,"on"+t,{get(){return this["_on"+t]},set(e){this["_on"+t]&&(this.removeEventListener(t,this["_on"+t]),delete this["_on"+t]),e&&this.addEventListener(t,this["_on"+t]=e)},enumerable:!0,configurable:!0})}function Zb(e){return"boolean"!=typeof e?new Error("Argument type: "+typeof e+". Please use a boolean."):(xb=e,e?"adapter.js logging disabled":"adapter.js logging enabled")}function Wb(e){return"boolean"!=typeof e?new Error("Argument type: "+typeof e+". Please use a boolean."):(Vb=!e,"adapter.js deprecation warnings "+(e?"disabled":"enabled"))}function Xb(){if("object"==typeof window){if(xb)return;"undefined"!=typeof console&&"function"==typeof console.log&&console.log.apply(console,arguments)}}function Gb(e,t){Vb&&console.warn(e+" is deprecated, please use "+t+" instead.")}function Fb(e){return"[object Object]"===Object.prototype.toString.call(e)}function Hb(e){return Fb(e)?Object.keys(e).reduce((function(t,i){const o=Fb(e[i]),r=o?Hb(e[i]):e[i],s=o&&!Object.keys(r).length;return void 0===r||s?t:Object.assign(t,{[i]:r})}),{}):e}function Yb(e,t,i){t&&!i.has(t.id)&&(i.set(t.id,t),Object.keys(t).forEach((o=>{o.endsWith("Id")?Yb(e,e.get(t[o]),i):o.endsWith("Ids")&&t[o].forEach((t=>{Yb(e,e.get(t),i)}))})))}function Kb(e,t,i){const o=i?"outbound-rtp":"inbound-rtp",r=new Map;if(null===t)return r;const s=[];return e.forEach((e=>{"track"===e.type&&e.trackIdentifier===t.id&&s.push(e)})),s.forEach((t=>{e.forEach((i=>{i.type===o&&i.trackId===t.id&&Yb(e,i,r)}))})),r}const Bb=Xb;function Jb(e,t){const i=e&&e.navigator;if(!i.mediaDevices)return;const o=function(e){if("object"!=typeof e||e.mandatory||e.optional)return e;const t={};return Object.keys(e).forEach((i=>{if("require"===i||"advanced"===i||"mediaSource"===i)return;const o="object"==typeof e[i]?e[i]:{ideal:e[i]};void 0!==o.exact&&"number"==typeof o.exact&&(o.min=o.max=o.exact);const r=function(e,t){return e?e+t.charAt(0).toUpperCase()+t.slice(1):"deviceId"===t?"sourceId":t};if(void 0!==o.ideal){t.optional=t.optional||[];let e={};"number"==typeof o.ideal?(e[r("min",i)]=o.ideal,t.optional.push(e),e={},e[r("max",i)]=o.ideal,t.optional.push(e)):(e[r("",i)]=o.ideal,t.optional.push(e))}void 0!==o.exact&&"number"!=typeof o.exact?(t.mandatory=t.mandatory||{},t.mandatory[r("",i)]=o.exact):["min","max"].forEach((e=>{void 0!==o[e]&&(t.mandatory=t.mandatory||{},t.mandatory[r(e,i)]=o[e])}))})),e.advanced&&(t.optional=(t.optional||[]).concat(e.advanced)),t},r=function(e,r){if(t.version>=61)return r(e);if((e=JSON.parse(JSON.stringify(e)))&&"object"==typeof e.audio){const t=function(e,t,i){t in e&&!(i in e)&&(e[i]=e[t],delete e[t])};t((e=JSON.parse(JSON.stringify(e))).audio,"autoGainControl","googAutoGainControl"),t(e.audio,"noiseSuppression","googNoiseSuppression"),e.audio=o(e.audio)}if(e&&"object"==typeof e.video){let s=e.video.facingMode;s=s&&("object"==typeof s?s:{ideal:s});const n=t.version<66;if(s&&("user"===s.exact||"environment"===s.exact||"user"===s.ideal||"environment"===s.ideal)&&(!i.mediaDevices.getSupportedConstraints||!i.mediaDevices.getSupportedConstraints().facingMode||n)){let t;if(delete e.video.facingMode,"environment"===s.exact||"environment"===s.ideal?t=["back","rear"]:"user"!==s.exact&&"user"!==s.ideal||(t=["front"]),t)return i.mediaDevices.enumerateDevices().then((i=>{let n=(i=i.filter((e=>"videoinput"===e.kind))).find((e=>t.some((t=>e.label.toLowerCase().includes(t)))));return!n&&i.length&&t.includes("back")&&(n=i[i.length-1]),n&&(e.video.deviceId=s.exact?{exact:n.deviceId}:{ideal:n.deviceId}),e.video=o(e.video),Bb("chrome: "+JSON.stringify(e)),r(e)}))}e.video=o(e.video)}return Bb("chrome: "+JSON.stringify(e)),r(e)},s=function(e){return t.version>=64?e:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[e.name]||e.name,message:e.message,constraint:e.constraint||e.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}};if(i.getUserMedia=function(e,t,o){r(e,(e=>{i.webkitGetUserMedia(e,t,(e=>{o&&o(s(e))}))}))}.bind(i),i.mediaDevices.getUserMedia){const e=i.mediaDevices.getUserMedia.bind(i.mediaDevices);i.mediaDevices.getUserMedia=function(t){return r(t,(t=>e(t).then((e=>{if(t.audio&&!e.getAudioTracks().length||t.video&&!e.getVideoTracks().length)throw e.getTracks().forEach((e=>{e.stop()})),new DOMException("","NotFoundError");return e}),(e=>Promise.reject(s(e))))))}}}function jb(e){e.MediaStream=e.MediaStream||e.webkitMediaStream}function zb(e){if("object"==typeof e&&e.RTCPeerConnection&&!("ontrack"in e.RTCPeerConnection.prototype)){Object.defineProperty(e.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(e){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=e)},enumerable:!0,configurable:!0});const t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=t=>{t.stream.addEventListener("addtrack",(i=>{let o;o=e.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find((e=>e.track&&e.track.id===i.track.id)):{track:i.track};const r=new Event("track");r.track=i.track,r.receiver=o,r.transceiver={receiver:o},r.streams=[t.stream],this.dispatchEvent(r)})),t.stream.getTracks().forEach((i=>{let o;o=e.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find((e=>e.track&&e.track.id===i.id)):{track:i};const r=new Event("track");r.track=i,r.receiver=o,r.transceiver={receiver:o},r.streams=[t.stream],this.dispatchEvent(r)}))},this.addEventListener("addstream",this._ontrackpoly)),t.apply(this,arguments)}}else Ub(e,"track",(e=>(e.transceiver||Object.defineProperty(e,"transceiver",{value:{receiver:e.receiver}}),e)))}function Qb(e){if("object"==typeof e&&e.RTCPeerConnection&&!("getSenders"in e.RTCPeerConnection.prototype)&&"createDTMFSender"in e.RTCPeerConnection.prototype){const t=function(e,t){return{track:t,get dtmf(){return void 0===this._dtmf&&("audio"===t.kind?this._dtmf=e.createDTMFSender(t):this._dtmf=null),this._dtmf},_pc:e}};if(!e.RTCPeerConnection.prototype.getSenders){e.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};const i=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,o){let r=i.apply(this,arguments);return r||(r=t(this,e),this._senders.push(r)),r};const o=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){o.apply(this,arguments);const t=this._senders.indexOf(e);-1!==t&&this._senders.splice(t,1)}}const i=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){this._senders=this._senders||[],i.apply(this,[e]),e.getTracks().forEach((e=>{this._senders.push(t(this,e))}))};const o=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){this._senders=this._senders||[],o.apply(this,[e]),e.getTracks().forEach((e=>{const t=this._senders.find((t=>t.track===e));t&&this._senders.splice(this._senders.indexOf(t),1)}))}}else if("object"==typeof e&&e.RTCPeerConnection&&"getSenders"in e.RTCPeerConnection.prototype&&"createDTMFSender"in e.RTCPeerConnection.prototype&&e.RTCRtpSender&&!("dtmf"in e.RTCRtpSender.prototype)){const t=e.RTCPeerConnection.prototype.getSenders;e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e},Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function qb(e){if(!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){const[e,i,o]=arguments;if(arguments.length>0&&"function"==typeof e)return t.apply(this,arguments);if(0===t.length&&(0===arguments.length||"function"!=typeof e))return t.apply(this,[]);const r=function(e){const t={};return e.result().forEach((e=>{const i={id:e.id,timestamp:e.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[e.type]||e.type};e.names().forEach((t=>{i[t]=e.stat(t)})),t[i.id]=i})),t},s=function(e){return new Map(Object.keys(e).map((t=>[t,e[t]])))};if(arguments.length>=2){const o=function(e){i(s(r(e)))};return t.apply(this,[o,e])}return new Promise(((e,i)=>{t.apply(this,[function(t){e(s(r(t)))},i])})).then(i,o)}}function $b(e){if(!("object"==typeof e&&e.RTCPeerConnection&&e.RTCRtpSender&&e.RTCRtpReceiver))return;if(!("getStats"in e.RTCRtpSender.prototype)){const t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e});const i=e.RTCPeerConnection.prototype.addTrack;i&&(e.RTCPeerConnection.prototype.addTrack=function(){const e=i.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){const e=this;return this._pc.getStats().then((t=>Kb(t,e.track,!0)))}}if(!("getStats"in e.RTCRtpReceiver.prototype)){const t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e}),Ub(e,"track",(e=>(e.receiver._pc=e.srcElement,e))),e.RTCRtpReceiver.prototype.getStats=function(){const e=this;return this._pc.getStats().then((t=>Kb(t,e.track,!1)))}}if(!("getStats"in e.RTCRtpSender.prototype)||!("getStats"in e.RTCRtpReceiver.prototype))return;const t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof e.MediaStreamTrack){const e=arguments[0];let t,i,o;return this.getSenders().forEach((i=>{i.track===e&&(t?o=!0:t=i)})),this.getReceivers().forEach((t=>(t.track===e&&(i?o=!0:i=t),t.track===e))),o||t&&i?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):t?t.getStats():i?i.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return t.apply(this,arguments)}}function eT(e){e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map((e=>this._shimmedLocalStreams[e][0]))};const t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,i){if(!i)return t.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};const o=t.apply(this,arguments);return this._shimmedLocalStreams[i.id]?-1===this._shimmedLocalStreams[i.id].indexOf(o)&&this._shimmedLocalStreams[i.id].push(o):this._shimmedLocalStreams[i.id]=[i,o],o};const i=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){this._shimmedLocalStreams=this._shimmedLocalStreams||{},e.getTracks().forEach((e=>{if(this.getSenders().find((t=>t.track===e)))throw new DOMException("Track already exists.","InvalidAccessError")}));const t=this.getSenders();i.apply(this,arguments);const o=this.getSenders().filter((e=>-1===t.indexOf(e)));this._shimmedLocalStreams[e.id]=[e].concat(o)};const o=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[e.id],o.apply(this,arguments)};const r=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},e&&Object.keys(this._shimmedLocalStreams).forEach((t=>{const i=this._shimmedLocalStreams[t].indexOf(e);-1!==i&&this._shimmedLocalStreams[t].splice(i,1),1===this._shimmedLocalStreams[t].length&&delete this._shimmedLocalStreams[t]})),r.apply(this,arguments)}}function tT(e,t){if(!e.RTCPeerConnection)return;if(e.RTCPeerConnection.prototype.addTrack&&t.version>=65)return eT(e);const i=e.RTCPeerConnection.prototype.getLocalStreams;e.RTCPeerConnection.prototype.getLocalStreams=function(){const e=i.apply(this);return this._reverseStreams=this._reverseStreams||{},e.map((e=>this._reverseStreams[e.id]))};const o=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(t){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},t.getTracks().forEach((e=>{if(this.getSenders().find((t=>t.track===e)))throw new DOMException("Track already exists.","InvalidAccessError")})),!this._reverseStreams[t.id]){const i=new e.MediaStream(t.getTracks());this._streams[t.id]=i,this._reverseStreams[i.id]=t,t=i}o.apply(this,[t])};const r=e.RTCPeerConnection.prototype.removeStream;function s(e,t){let i=t.sdp;return Object.keys(e._reverseStreams||[]).forEach((t=>{const o=e._reverseStreams[t],r=e._streams[o.id];i=i.replace(new RegExp(r.id,"g"),o.id)})),new RTCSessionDescription({type:t.type,sdp:i})}e.RTCPeerConnection.prototype.removeStream=function(e){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},r.apply(this,[this._streams[e.id]||e]),delete this._reverseStreams[this._streams[e.id]?this._streams[e.id].id:e.id],delete this._streams[e.id]},e.RTCPeerConnection.prototype.addTrack=function(t,i){if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");const o=[].slice.call(arguments,1);if(1!==o.length||!o[0].getTracks().find((e=>e===t)))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");if(this.getSenders().find((e=>e.track===t)))throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};const r=this._streams[i.id];if(r)r.addTrack(t),Promise.resolve().then((()=>{this.dispatchEvent(new Event("negotiationneeded"))}));else{const o=new e.MediaStream([t]);this._streams[i.id]=o,this._reverseStreams[o.id]=i,this.addStream(o)}return this.getSenders().find((e=>e.track===t))},["createOffer","createAnswer"].forEach((function(t){const i=e.RTCPeerConnection.prototype[t],o={[t](){const e=arguments;return arguments.length&&"function"==typeof arguments[0]?i.apply(this,[t=>{const i=s(this,t);e[0].apply(null,[i])},t=>{e[1]&&e[1].apply(null,t)},arguments[2]]):i.apply(this,arguments).then((e=>s(this,e)))}};e.RTCPeerConnection.prototype[t]=o[t]}));const n=e.RTCPeerConnection.prototype.setLocalDescription;e.RTCPeerConnection.prototype.setLocalDescription=function(){return arguments.length&&arguments[0].type?(arguments[0]=function(e,t){let i=t.sdp;return Object.keys(e._reverseStreams||[]).forEach((t=>{const o=e._reverseStreams[t],r=e._streams[o.id];i=i.replace(new RegExp(o.id,"g"),r.id)})),new RTCSessionDescription({type:t.type,sdp:i})}(this,arguments[0]),n.apply(this,arguments)):n.apply(this,arguments)};const a=Object.getOwnPropertyDescriptor(e.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(e.RTCPeerConnection.prototype,"localDescription",{get(){const e=a.get.apply(this);return""===e.type?e:s(this,e)}}),e.RTCPeerConnection.prototype.removeTrack=function(e){if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!e._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(!(e._pc===this))throw new DOMException("Sender was not created by this connection.","InvalidAccessError");let t;this._streams=this._streams||{},Object.keys(this._streams).forEach((i=>{this._streams[i].getTracks().find((t=>e.track===t))&&(t=this._streams[i])})),t&&(1===t.getTracks().length?this.removeStream(this._reverseStreams[t.id]):t.removeTrack(e.track),this.dispatchEvent(new Event("negotiationneeded")))}}function iT(e,t){!e.RTCPeerConnection&&e.webkitRTCPeerConnection&&(e.RTCPeerConnection=e.webkitRTCPeerConnection),e.RTCPeerConnection&&t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(t){const i=e.RTCPeerConnection.prototype[t],o={[t](){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),i.apply(this,arguments)}};e.RTCPeerConnection.prototype[t]=o[t]}))}function oT(e,t){Ub(e,"negotiationneeded",(e=>{const i=e.target;if(!(t.version<72||i.getConfiguration&&"plan-b"===i.getConfiguration().sdpSemantics)||"stable"===i.signalingState)return e}))}var rT=Object.freeze({__proto__:null,fixNegotiationNeeded:oT,shimAddTrackRemoveTrack:tT,shimAddTrackRemoveTrackWithNative:eT,shimGetDisplayMedia:function(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&("function"==typeof t?e.navigator.mediaDevices.getDisplayMedia=function(i){return t(i).then((t=>{const o=i.video&&i.video.width,r=i.video&&i.video.height,s=i.video&&i.video.frameRate;return i.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t,maxFrameRate:s||3}},o&&(i.video.mandatory.maxWidth=o),r&&(i.video.mandatory.maxHeight=r),e.navigator.mediaDevices.getUserMedia(i)}))}:console.error("shimGetDisplayMedia: getSourceId argument is not a function"))},shimGetSendersWithDtmf:Qb,shimGetStats:qb,shimGetUserMedia:Jb,shimMediaStream:jb,shimOnTrack:zb,shimPeerConnection:iT,shimSenderReceiverGetStats:$b});function sT(e,t){const i=e&&e.navigator,o=e&&e.MediaStreamTrack;if(i.getUserMedia=function(e,t,o){Gb("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),i.mediaDevices.getUserMedia(e).then(t,o)},!(t.version>55&&"autoGainControl"in i.mediaDevices.getSupportedConstraints())){const e=function(e,t,i){t in e&&!(i in e)&&(e[i]=e[t],delete e[t])},t=i.mediaDevices.getUserMedia.bind(i.mediaDevices);if(i.mediaDevices.getUserMedia=function(i){return"object"==typeof i&&"object"==typeof i.audio&&(i=JSON.parse(JSON.stringify(i)),e(i.audio,"autoGainControl","mozAutoGainControl"),e(i.audio,"noiseSuppression","mozNoiseSuppression")),t(i)},o&&o.prototype.getSettings){const t=o.prototype.getSettings;o.prototype.getSettings=function(){const i=t.apply(this,arguments);return e(i,"mozAutoGainControl","autoGainControl"),e(i,"mozNoiseSuppression","noiseSuppression"),i}}if(o&&o.prototype.applyConstraints){const t=o.prototype.applyConstraints;o.prototype.applyConstraints=function(i){return"audio"===this.kind&&"object"==typeof i&&(i=JSON.parse(JSON.stringify(i)),e(i,"autoGainControl","mozAutoGainControl"),e(i,"noiseSuppression","mozNoiseSuppression")),t.apply(this,[i])}}}}function nT(e){"object"==typeof e&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function aT(e,t){if("object"!=typeof e||!e.RTCPeerConnection&&!e.mozRTCPeerConnection)return;!e.RTCPeerConnection&&e.mozRTCPeerConnection&&(e.RTCPeerConnection=e.mozRTCPeerConnection),t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(t){const i=e.RTCPeerConnection.prototype[t],o={[t](){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),i.apply(this,arguments)}};e.RTCPeerConnection.prototype[t]=o[t]}));const i={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},o=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){const[e,r,s]=arguments;return o.apply(this,[e||null]).then((e=>{if(t.version<53&&!r)try{e.forEach((e=>{e.type=i[e.type]||e.type}))}catch(o){if("TypeError"!==o.name)throw o;e.forEach(((t,o)=>{e.set(o,Object.assign({},t,{type:i[t.type]||t.type}))}))}return e})).then(r,s)}}function dT(e){if("object"!=typeof e||!e.RTCPeerConnection||!e.RTCRtpSender)return;if(e.RTCRtpSender&&"getStats"in e.RTCRtpSender.prototype)return;const t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e});const i=e.RTCPeerConnection.prototype.addTrack;i&&(e.RTCPeerConnection.prototype.addTrack=function(){const e=i.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}function cT(e){if("object"!=typeof e||!e.RTCPeerConnection||!e.RTCRtpSender)return;if(e.RTCRtpSender&&"getStats"in e.RTCRtpReceiver.prototype)return;const t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e}),Ub(e,"track",(e=>(e.receiver._pc=e.srcElement,e))),e.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function lT(e){e.RTCPeerConnection&&!("removeStream"in e.RTCPeerConnection.prototype)&&(e.RTCPeerConnection.prototype.removeStream=function(e){Gb("removeStream","removeTrack"),this.getSenders().forEach((t=>{t.track&&e.getTracks().includes(t.track)&&this.removeTrack(t)}))})}function uT(e){e.DataChannel&&!e.RTCDataChannel&&(e.RTCDataChannel=e.DataChannel)}function hT(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.addTransceiver;t&&(e.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];let e=arguments[1]&&arguments[1].sendEncodings;void 0===e&&(e=[]),e=[...e];const i=e.length>0;i&&e.forEach((e=>{if("rid"in e){if(!/^[a-z0-9]{0,16}$/i.test(e.rid))throw new TypeError("Invalid RID value provided.")}if("scaleResolutionDownBy"in e&&!(parseFloat(e.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in e&&!(parseFloat(e.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")}));const o=t.apply(this,arguments);if(i){const{sender:t}=o,i=t.getParameters();(!("encodings"in i)||1===i.encodings.length&&0===Object.keys(i.encodings[0]).length)&&(i.encodings=e,t.sendEncodings=e,this.setParametersPromises.push(t.setParameters(i).then((()=>{delete t.sendEncodings})).catch((()=>{delete t.sendEncodings}))))}return o})}function _T(e){if("object"!=typeof e||!e.RTCRtpSender)return;const t=e.RTCRtpSender.prototype.getParameters;t&&(e.RTCRtpSender.prototype.getParameters=function(){const e=t.apply(this,arguments);return"encodings"in e||(e.encodings=[].concat(this.sendEncodings||[{}])),e})}function mT(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then((()=>t.apply(this,arguments))).finally((()=>{this.setParametersPromises=[]})):t.apply(this,arguments)}}function pT(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.createAnswer;e.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then((()=>t.apply(this,arguments))).finally((()=>{this.setParametersPromises=[]})):t.apply(this,arguments)}}var vT=Object.freeze({__proto__:null,shimAddTransceiver:hT,shimCreateAnswer:pT,shimCreateOffer:mT,shimGetDisplayMedia:function(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&(e.navigator.mediaDevices.getDisplayMedia=function(i){if(!i||!i.video){const e=new DOMException("getDisplayMedia without video constraints is undefined");return e.name="NotFoundError",e.code=8,Promise.reject(e)}return!0===i.video?i.video={mediaSource:t}:i.video.mediaSource=t,e.navigator.mediaDevices.getUserMedia(i)})},shimGetParameters:_T,shimGetUserMedia:sT,shimOnTrack:nT,shimPeerConnection:aT,shimRTCDataChannel:uT,shimReceiverGetStats:cT,shimRemoveStream:lT,shimSenderGetStats:dT});function fT(e){if("object"==typeof e&&e.RTCPeerConnection){if("getLocalStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in e.RTCPeerConnection.prototype)){const t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addStream=function(e){this._localStreams||(this._localStreams=[]),this._localStreams.includes(e)||this._localStreams.push(e),e.getAudioTracks().forEach((i=>t.call(this,i,e))),e.getVideoTracks().forEach((i=>t.call(this,i,e)))},e.RTCPeerConnection.prototype.addTrack=function(e){for(var i=arguments.length,o=new Array(i>1?i-1:0),r=1;r<i;r++)o[r-1]=arguments[r];return o&&o.forEach((e=>{this._localStreams?this._localStreams.includes(e)||this._localStreams.push(e):this._localStreams=[e]})),t.apply(this,arguments)}}"removeStream"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.removeStream=function(e){this._localStreams||(this._localStreams=[]);const t=this._localStreams.indexOf(e);if(-1===t)return;this._localStreams.splice(t,1);const i=e.getTracks();this.getSenders().forEach((e=>{i.includes(e.track)&&this.removeTrack(e)}))})}}function ST(e){if("object"==typeof e&&e.RTCPeerConnection&&("getRemoteStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in e.RTCPeerConnection.prototype))){Object.defineProperty(e.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(e){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=e),this.addEventListener("track",this._onaddstreampoly=e=>{e.streams.forEach((e=>{if(this._remoteStreams||(this._remoteStreams=[]),this._remoteStreams.includes(e))return;this._remoteStreams.push(e);const t=new Event("addstream");t.stream=e,this.dispatchEvent(t)}))})}});const t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){const e=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(t){t.streams.forEach((t=>{if(e._remoteStreams||(e._remoteStreams=[]),e._remoteStreams.indexOf(t)>=0)return;e._remoteStreams.push(t);const i=new Event("addstream");i.stream=t,e.dispatchEvent(i)}))}),t.apply(e,arguments)}}}function gT(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype,i=t.createOffer,o=t.createAnswer,r=t.setLocalDescription,s=t.setRemoteDescription,n=t.addIceCandidate;t.createOffer=function(e,t){const o=arguments.length>=2?arguments[2]:arguments[0],r=i.apply(this,[o]);return t?(r.then(e,t),Promise.resolve()):r},t.createAnswer=function(e,t){const i=arguments.length>=2?arguments[2]:arguments[0],r=o.apply(this,[i]);return t?(r.then(e,t),Promise.resolve()):r};let a=function(e,t,i){const o=r.apply(this,[e]);return i?(o.then(t,i),Promise.resolve()):o};t.setLocalDescription=a,a=function(e,t,i){const o=s.apply(this,[e]);return i?(o.then(t,i),Promise.resolve()):o},t.setRemoteDescription=a,a=function(e,t,i){const o=n.apply(this,[e]);return i?(o.then(t,i),Promise.resolve()):o},t.addIceCandidate=a}function yT(e){const t=e&&e.navigator;if(t.mediaDevices&&t.mediaDevices.getUserMedia){const e=t.mediaDevices,i=e.getUserMedia.bind(e);t.mediaDevices.getUserMedia=e=>i(bT(e))}!t.getUserMedia&&t.mediaDevices&&t.mediaDevices.getUserMedia&&(t.getUserMedia=function(e,i,o){t.mediaDevices.getUserMedia(e).then(i,o)}.bind(t))}function bT(e){return e&&void 0!==e.video?Object.assign({},e,{video:Hb(e.video)}):e}function TT(e){if(!e.RTCPeerConnection)return;const t=e.RTCPeerConnection;e.RTCPeerConnection=function(e,i){if(e&&e.iceServers){const t=[];for(let i=0;i<e.iceServers.length;i++){let o=e.iceServers[i];void 0===o.urls&&o.url?(Gb("RTCIceServer.url","RTCIceServer.urls"),o=JSON.parse(JSON.stringify(o)),o.urls=o.url,delete o.url,t.push(o)):t.push(e.iceServers[i])}e.iceServers=t}return new t(e,i)},e.RTCPeerConnection.prototype=t.prototype,"generateCertificate"in t&&Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get:()=>t.generateCertificate})}function IT(e){"object"==typeof e&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function ET(e){const t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(e){if(e){void 0!==e.offerToReceiveAudio&&(e.offerToReceiveAudio=!!e.offerToReceiveAudio);const t=this.getTransceivers().find((e=>"audio"===e.receiver.track.kind));!1===e.offerToReceiveAudio&&t?"sendrecv"===t.direction?t.setDirection?t.setDirection("sendonly"):t.direction="sendonly":"recvonly"===t.direction&&(t.setDirection?t.setDirection("inactive"):t.direction="inactive"):!0!==e.offerToReceiveAudio||t||this.addTransceiver("audio",{direction:"recvonly"}),void 0!==e.offerToReceiveVideo&&(e.offerToReceiveVideo=!!e.offerToReceiveVideo);const i=this.getTransceivers().find((e=>"video"===e.receiver.track.kind));!1===e.offerToReceiveVideo&&i?"sendrecv"===i.direction?i.setDirection?i.setDirection("sendonly"):i.direction="sendonly":"recvonly"===i.direction&&(i.setDirection?i.setDirection("inactive"):i.direction="inactive"):!0!==e.offerToReceiveVideo||i||this.addTransceiver("video",{direction:"recvonly"})}return t.apply(this,arguments)}}function RT(e){"object"!=typeof e||e.AudioContext||(e.AudioContext=e.webkitAudioContext)}var CT=Object.freeze({__proto__:null,shimAudioContext:RT,shimCallbacksAPI:gT,shimConstraints:bT,shimCreateOfferLegacy:ET,shimGetUserMedia:yT,shimLocalStreamsAPI:fT,shimRTCIceServerUrls:TT,shimRemoteStreamsAPI:ST,shimTrackEventTransceiver:IT}),kT={exports:{}};!function(e){const t={generateIdentifier:function(){return Math.random().toString(36).substring(2,12)}};t.localCName=t.generateIdentifier(),t.splitLines=function(e){return z_(e).call(e).split("\n").map((e=>z_(e).call(e)))},t.splitSections=function(e){return e.split("\nm=").map(((e,t)=>{var i;return z_(i=t>0?"m="+e:e).call(i)+"\r\n"}))},t.getDescription=function(e){const i=t.splitSections(e);return i&&i[0]},t.getMediaSections=function(e){const i=t.splitSections(e);return i.shift(),i},t.matchPrefix=function(e,i){return t.splitLines(e).filter((e=>0===e.indexOf(i)))},t.parseCandidate=function(e){let t;t=0===e.indexOf("a=candidate:")?e.substring(12).split(" "):e.substring(10).split(" ");const i={foundation:t[0],component:{1:"rtp",2:"rtcp"}[t[1]]||t[1],protocol:t[2].toLowerCase(),priority:parseInt(t[3],10),ip:t[4],address:t[4],port:parseInt(t[5],10),type:t[7]};for(let o=8;o<t.length;o+=2)switch(t[o]){case"raddr":i.relatedAddress=t[o+1];break;case"rport":i.relatedPort=parseInt(t[o+1],10);break;case"tcptype":i.tcpType=t[o+1];break;case"ufrag":i.ufrag=t[o+1],i.usernameFragment=t[o+1];break;default:void 0===i[t[o]]&&(i[t[o]]=t[o+1])}return i},t.writeCandidate=function(e){const t=[];t.push(e.foundation);const i=e.component;"rtp"===i?t.push(1):"rtcp"===i?t.push(2):t.push(i),t.push(e.protocol.toUpperCase()),t.push(e.priority),t.push(e.address||e.ip),t.push(e.port);const o=e.type;return t.push("typ"),t.push(o),"host"!==o&&e.relatedAddress&&e.relatedPort&&(t.push("raddr"),t.push(e.relatedAddress),t.push("rport"),t.push(e.relatedPort)),e.tcpType&&"tcp"===e.protocol.toLowerCase()&&(t.push("tcptype"),t.push(e.tcpType)),(e.usernameFragment||e.ufrag)&&(t.push("ufrag"),t.push(e.usernameFragment||e.ufrag)),"candidate:"+t.join(" ")},t.parseIceOptions=function(e){return e.substring(14).split(" ")},t.parseRtpMap=function(e){let t=e.substring(9).split(" ");const i={payloadType:parseInt(t.shift(),10)};return t=t[0].split("/"),i.name=t[0],i.clockRate=parseInt(t[1],10),i.channels=3===t.length?parseInt(t[2],10):1,i.numChannels=i.channels,i},t.writeRtpMap=function(e){let t=e.payloadType;void 0!==e.preferredPayloadType&&(t=e.preferredPayloadType);const i=e.channels||e.numChannels||1;return"a=rtpmap:"+t+" "+e.name+"/"+e.clockRate+(1!==i?"/"+i:"")+"\r\n"},t.parseExtmap=function(e){const t=e.substring(9).split(" ");return{id:parseInt(t[0],10),direction:t[0].indexOf("/")>0?t[0].split("/")[1]:"sendrecv",uri:t[1],attributes:t.slice(2).join(" ")}},t.writeExtmap=function(e){return"a=extmap:"+(e.id||e.preferredId)+(e.direction&&"sendrecv"!==e.direction?"/"+e.direction:"")+" "+e.uri+(e.attributes?" "+e.attributes:"")+"\r\n"},t.parseFmtp=function(e){const t={};let i;const o=e.substring(e.indexOf(" ")+1).split(";");for(let n=0;n<o.length;n++){var r,s;i=z_(r=o[n]).call(r).split("="),t[z_(s=i[0]).call(s)]=i[1]}return t},t.writeFmtp=function(e){let t="",i=e.payloadType;if(void 0!==e.preferredPayloadType&&(i=e.preferredPayloadType),e.parameters&&Object.keys(e.parameters).length){const o=[];Object.keys(e.parameters).forEach((t=>{void 0!==e.parameters[t]?o.push(t+"="+e.parameters[t]):o.push(t)})),t+="a=fmtp:"+i+" "+o.join(";")+"\r\n"}return t},t.parseRtcpFb=function(e){const t=e.substring(e.indexOf(" ")+1).split(" ");return{type:t.shift(),parameter:t.join(" ")}},t.writeRtcpFb=function(e){let t="",i=e.payloadType;return void 0!==e.preferredPayloadType&&(i=e.preferredPayloadType),e.rtcpFeedback&&e.rtcpFeedback.length&&e.rtcpFeedback.forEach((e=>{t+="a=rtcp-fb:"+i+" "+e.type+(e.parameter&&e.parameter.length?" "+e.parameter:"")+"\r\n"})),t},t.parseSsrcMedia=function(e){const t=e.indexOf(" "),i={ssrc:parseInt(e.substring(7,t),10)},o=e.indexOf(":",t);return o>-1?(i.attribute=e.substring(t+1,o),i.value=e.substring(o+1)):i.attribute=e.substring(t+1),i},t.parseSsrcGroup=function(e){const t=e.substring(13).split(" ");return{semantics:t.shift(),ssrcs:t.map((e=>parseInt(e,10)))}},t.getMid=function(e){const i=t.matchPrefix(e,"a=mid:")[0];if(i)return i.substring(6)},t.parseFingerprint=function(e){const t=e.substring(14).split(" ");return{algorithm:t[0].toLowerCase(),value:t[1].toUpperCase()}},t.getDtlsParameters=function(e,i){return{role:"auto",fingerprints:t.matchPrefix(e+i,"a=fingerprint:").map(t.parseFingerprint)}},t.writeDtlsParameters=function(e,t){let i="a=setup:"+t+"\r\n";return e.fingerprints.forEach((e=>{i+="a=fingerprint:"+e.algorithm+" "+e.value+"\r\n"})),i},t.parseCryptoLine=function(e){const t=e.substring(9).split(" ");return{tag:parseInt(t[0],10),cryptoSuite:t[1],keyParams:t[2],sessionParams:t.slice(3)}},t.writeCryptoLine=function(e){return"a=crypto:"+e.tag+" "+e.cryptoSuite+" "+("object"==typeof e.keyParams?t.writeCryptoKeyParams(e.keyParams):e.keyParams)+(e.sessionParams?" "+e.sessionParams.join(" "):"")+"\r\n"},t.parseCryptoKeyParams=function(e){if(0!==e.indexOf("inline:"))return null;const t=e.substring(7).split("|");return{keyMethod:"inline",keySalt:t[0],lifeTime:t[1],mkiValue:t[2]?t[2].split(":")[0]:void 0,mkiLength:t[2]?t[2].split(":")[1]:void 0}},t.writeCryptoKeyParams=function(e){return e.keyMethod+":"+e.keySalt+(e.lifeTime?"|"+e.lifeTime:"")+(e.mkiValue&&e.mkiLength?"|"+e.mkiValue+":"+e.mkiLength:"")},t.getCryptoParameters=function(e,i){return t.matchPrefix(e+i,"a=crypto:").map(t.parseCryptoLine)},t.getIceParameters=function(e,i){const o=t.matchPrefix(e+i,"a=ice-ufrag:")[0],r=t.matchPrefix(e+i,"a=ice-pwd:")[0];return o&&r?{usernameFragment:o.substring(12),password:r.substring(10)}:null},t.writeIceParameters=function(e){let t="a=ice-ufrag:"+e.usernameFragment+"\r\na=ice-pwd:"+e.password+"\r\n";return e.iceLite&&(t+="a=ice-lite\r\n"),t},t.parseRtpParameters=function(e){const i={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},o=t.splitLines(e)[0].split(" ");i.profile=o[2];for(let s=3;s<o.length;s++){const r=o[s],n=t.matchPrefix(e,"a=rtpmap:"+r+" ")[0];if(n){const o=t.parseRtpMap(n),s=t.matchPrefix(e,"a=fmtp:"+r+" ");switch(o.parameters=s.length?t.parseFmtp(s[0]):{},o.rtcpFeedback=t.matchPrefix(e,"a=rtcp-fb:"+r+" ").map(t.parseRtcpFb),i.codecs.push(o),o.name.toUpperCase()){case"RED":case"ULPFEC":i.fecMechanisms.push(o.name.toUpperCase())}}}t.matchPrefix(e,"a=extmap:").forEach((e=>{i.headerExtensions.push(t.parseExtmap(e))}));const r=t.matchPrefix(e,"a=rtcp-fb:* ").map(t.parseRtcpFb);return i.codecs.forEach((e=>{r.forEach((t=>{e.rtcpFeedback.find((e=>e.type===t.type&&e.parameter===t.parameter))||e.rtcpFeedback.push(t)}))})),i},t.writeRtpDescription=function(e,i){let o="";o+="m="+e+" ",o+=i.codecs.length>0?"9":"0",o+=" "+(i.profile||"UDP/TLS/RTP/SAVPF")+" ",o+=i.codecs.map((e=>void 0!==e.preferredPayloadType?e.preferredPayloadType:e.payloadType)).join(" ")+"\r\n",o+="c=IN IP4 0.0.0.0\r\n",o+="a=rtcp:9 IN IP4 0.0.0.0\r\n",i.codecs.forEach((e=>{o+=t.writeRtpMap(e),o+=t.writeFmtp(e),o+=t.writeRtcpFb(e)}));let r=0;return i.codecs.forEach((e=>{e.maxptime>r&&(r=e.maxptime)})),r>0&&(o+="a=maxptime:"+r+"\r\n"),i.headerExtensions&&i.headerExtensions.forEach((e=>{o+=t.writeExtmap(e)})),o},t.parseRtpEncodingParameters=function(e){const i=[],o=t.parseRtpParameters(e),r=-1!==o.fecMechanisms.indexOf("RED"),s=-1!==o.fecMechanisms.indexOf("ULPFEC"),n=t.matchPrefix(e,"a=ssrc:").map((e=>t.parseSsrcMedia(e))).filter((e=>"cname"===e.attribute)),a=n.length>0&&n[0].ssrc;let d;const c=t.matchPrefix(e,"a=ssrc-group:FID").map((e=>e.substring(17).split(" ").map((e=>parseInt(e,10)))));c.length>0&&c[0].length>1&&c[0][0]===a&&(d=c[0][1]),o.codecs.forEach((e=>{if("RTX"===e.name.toUpperCase()&&e.parameters.apt){let t={ssrc:a,codecPayloadType:parseInt(e.parameters.apt,10)};a&&d&&(t.rtx={ssrc:d}),i.push(t),r&&(t=JSON.parse(JSON.stringify(t)),t.fec={ssrc:a,mechanism:s?"red+ulpfec":"red"},i.push(t))}})),0===i.length&&a&&i.push({ssrc:a});let l=t.matchPrefix(e,"b=");return l.length&&(l=0===l[0].indexOf("b=TIAS:")?parseInt(l[0].substring(7),10):0===l[0].indexOf("b=AS:")?1e3*parseInt(l[0].substring(5),10)*.95-16e3:void 0,i.forEach((e=>{e.maxBitrate=l}))),i},t.parseRtcpParameters=function(e){const i={},o=t.matchPrefix(e,"a=ssrc:").map((e=>t.parseSsrcMedia(e))).filter((e=>"cname"===e.attribute))[0];o&&(i.cname=o.value,i.ssrc=o.ssrc);const r=t.matchPrefix(e,"a=rtcp-rsize");i.reducedSize=r.length>0,i.compound=0===r.length;const s=t.matchPrefix(e,"a=rtcp-mux");return i.mux=s.length>0,i},t.writeRtcpParameters=function(e){let t="";return e.reducedSize&&(t+="a=rtcp-rsize\r\n"),e.mux&&(t+="a=rtcp-mux\r\n"),void 0!==e.ssrc&&e.cname&&(t+="a=ssrc:"+e.ssrc+" cname:"+e.cname+"\r\n"),t},t.parseMsid=function(e){let i;const o=t.matchPrefix(e,"a=msid:");if(1===o.length)return i=o[0].substring(7).split(" "),{stream:i[0],track:i[1]};const r=t.matchPrefix(e,"a=ssrc:").map((e=>t.parseSsrcMedia(e))).filter((e=>"msid"===e.attribute));return r.length>0?(i=r[0].value.split(" "),{stream:i[0],track:i[1]}):void 0},t.parseSctpDescription=function(e){const i=t.parseMLine(e),o=t.matchPrefix(e,"a=max-message-size:");let r;o.length>0&&(r=parseInt(o[0].substring(19),10)),isNaN(r)&&(r=65536);const s=t.matchPrefix(e,"a=sctp-port:");if(s.length>0)return{port:parseInt(s[0].substring(12),10),protocol:i.fmt,maxMessageSize:r};const n=t.matchPrefix(e,"a=sctpmap:");if(n.length>0){const e=n[0].substring(10).split(" ");return{port:parseInt(e[0],10),protocol:e[1],maxMessageSize:r}}},t.writeSctpDescription=function(e,t){let i=[];return i="DTLS/SCTP"!==e.protocol?["m="+e.kind+" 9 "+e.protocol+" "+t.protocol+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctp-port:"+t.port+"\r\n"]:["m="+e.kind+" 9 "+e.protocol+" "+t.port+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctpmap:"+t.port+" "+t.protocol+" 65535\r\n"],void 0!==t.maxMessageSize&&i.push("a=max-message-size:"+t.maxMessageSize+"\r\n"),i.join("")},t.generateSessionId=function(){return Math.random().toString().substr(2,22)},t.writeSessionBoilerplate=function(e,i,o){let r;const s=void 0!==i?i:2;r=e||t.generateSessionId();return"v=0\r\no="+(o||"thisisadapterortc")+" "+r+" "+s+" IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},t.getDirection=function(e,i){const o=t.splitLines(e);for(let t=0;t<o.length;t++)switch(o[t]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return o[t].substring(2)}return i?t.getDirection(i):"sendrecv"},t.getKind=function(e){return t.splitLines(e)[0].split(" ")[0].substring(2)},t.isRejected=function(e){return"0"===e.split(" ",2)[1]},t.parseMLine=function(e){const i=t.splitLines(e)[0].substring(2).split(" ");return{kind:i[0],port:parseInt(i[1],10),protocol:i[2],fmt:i.slice(3).join(" ")}},t.parseOLine=function(e){const i=t.matchPrefix(e,"o=")[0].substring(2).split(" ");return{username:i[0],sessionId:i[1],sessionVersion:parseInt(i[2],10),netType:i[3],addressType:i[4],address:i[5]}},t.isValidSDP=function(e){if("string"!=typeof e||0===e.length)return!1;const i=t.splitLines(e);for(let t=0;t<i.length;t++)if(i[t].length<2||"="!==i[t].charAt(1))return!1;return!0},e.exports=t}(kT);var AT=kT.exports,PT=i(AT),NT=e({__proto__:null,default:PT},[AT]);function wT(e){if(!e.RTCIceCandidate||e.RTCIceCandidate&&"foundation"in e.RTCIceCandidate.prototype)return;const t=e.RTCIceCandidate;e.RTCIceCandidate=function(e){if("object"==typeof e&&e.candidate&&0===e.candidate.indexOf("a=")&&((e=JSON.parse(JSON.stringify(e))).candidate=e.candidate.substring(2)),e.candidate&&e.candidate.length){const i=new t(e),o=PT.parseCandidate(e.candidate);for(const e in o)e in i||Object.defineProperty(i,e,{value:o[e]});return i.toJSON=function(){return{candidate:i.candidate,sdpMid:i.sdpMid,sdpMLineIndex:i.sdpMLineIndex,usernameFragment:i.usernameFragment}},i}return new t(e)},e.RTCIceCandidate.prototype=t.prototype,Ub(e,"icecandidate",(t=>(t.candidate&&Object.defineProperty(t,"candidate",{value:new e.RTCIceCandidate(t.candidate),writable:"false"}),t)))}function OT(e){!e.RTCIceCandidate||e.RTCIceCandidate&&"relayProtocol"in e.RTCIceCandidate.prototype||Ub(e,"icecandidate",(e=>{if(e.candidate){const t=PT.parseCandidate(e.candidate.candidate);"relay"===t.type&&(e.candidate.relayProtocol={0:"tls",1:"tcp",2:"udp"}[t.priority>>24])}return e}))}function MT(e,t){if(!e.RTCPeerConnection)return;"sctp"in e.RTCPeerConnection.prototype||Object.defineProperty(e.RTCPeerConnection.prototype,"sctp",{get(){return void 0===this._sctp?null:this._sctp}});const i=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,"chrome"===t.browser&&t.version>=76){const{sdpSemantics:e}=this.getConfiguration();"plan-b"===e&&Object.defineProperty(this,"sctp",{get(){return void 0===this._sctp?null:this._sctp},enumerable:!0,configurable:!0})}if(function(e){if(!e||!e.sdp)return!1;const t=PT.splitSections(e.sdp);return t.shift(),t.some((e=>{const t=PT.parseMLine(e);return t&&"application"===t.kind&&-1!==t.protocol.indexOf("SCTP")}))}(arguments[0])){const e=function(e){const t=e.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(null===t||t.length<2)return-1;const i=parseInt(t[1],10);return i!=i?-1:i}(arguments[0]),i=function(e){let i=65536;return"firefox"===t.browser&&(i=t.version<57?-1===e?16384:2147483637:t.version<60?57===t.version?65535:65536:2147483637),i}(e),o=function(e,i){let o=65536;"firefox"===t.browser&&57===t.version&&(o=65535);const r=PT.matchPrefix(e.sdp,"a=max-message-size:");return r.length>0?o=parseInt(r[0].substring(19),10):"firefox"===t.browser&&-1!==i&&(o=2147483637),o}(arguments[0],e);let r;r=0===i&&0===o?Number.POSITIVE_INFINITY:0===i||0===o?Math.max(i,o):Math.min(i,o);const s={};Object.defineProperty(s,"maxMessageSize",{get:()=>r}),this._sctp=s}return i.apply(this,arguments)}}function LT(e){if(!e.RTCPeerConnection||!("createDataChannel"in e.RTCPeerConnection.prototype))return;function t(e,t){const i=e.send;e.send=function(){return i.apply(e,arguments)}}const i=e.RTCPeerConnection.prototype.createDataChannel;e.RTCPeerConnection.prototype.createDataChannel=function(){const e=i.apply(this,arguments);return t(e),e},Ub(e,"datachannel",(e=>(t(e.channel,e.target),e)))}function xT(e){if(!e.RTCPeerConnection||"connectionState"in e.RTCPeerConnection.prototype)return;const t=e.RTCPeerConnection.prototype;Object.defineProperty(t,"connectionState",{get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(t,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(e){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),e&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=e)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach((e=>{const i=t[e];t[e]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=e=>{const t=e.target;if(t._lastConnectionState!==t.connectionState){t._lastConnectionState=t.connectionState;const i=new Event("connectionstatechange",e);t.dispatchEvent(i)}return e},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),i.apply(this,arguments)}}))}function VT(e,t){if(!e.RTCPeerConnection)return;if("chrome"===t.browser&&t.version>=71)return;if("safari"===t.browser&&t.version>=605)return;const i=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(t){if(t&&t.sdp&&-1!==t.sdp.indexOf("\na=extmap-allow-mixed")){const i=t.sdp.split("\n").filter((e=>"a=extmap-allow-mixed"!==z_(e).call(e))).join("\n");e.RTCSessionDescription&&t instanceof e.RTCSessionDescription?arguments[0]=new e.RTCSessionDescription({type:t.type,sdp:i}):t.sdp=i}return i.apply(this,arguments)}}function DT(e,t){if(!e.RTCPeerConnection||!e.RTCPeerConnection.prototype)return;const i=e.RTCPeerConnection.prototype.addIceCandidate;i&&0!==i.length&&(e.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?("chrome"===t.browser&&t.version<78||"firefox"===t.browser&&t.version<68||"safari"===t.browser)&&arguments[0]&&""===arguments[0].candidate?Promise.resolve():i.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())})}function UT(e,t){if(!e.RTCPeerConnection||!e.RTCPeerConnection.prototype)return;const i=e.RTCPeerConnection.prototype.setLocalDescription;i&&0!==i.length&&(e.RTCPeerConnection.prototype.setLocalDescription=function(){let e=arguments[0]||{};if("object"!=typeof e||e.type&&e.sdp)return i.apply(this,arguments);if(e={type:e.type,sdp:e.sdp},!e.type)switch(this.signalingState){case"stable":case"have-local-offer":case"have-remote-pranswer":e.type="offer";break;default:e.type="answer"}if(e.sdp||"offer"!==e.type&&"answer"!==e.type)return i.apply(this,[e]);return("offer"===e.type?this.createOffer:this.createAnswer).apply(this).then((e=>i.apply(this,[e])))})}var ZT=Object.freeze({__proto__:null,removeExtmapAllowMixed:VT,shimAddIceCandidateNullOrEmpty:DT,shimConnectionState:xT,shimMaxMessageSize:MT,shimParameterlessSetLocalDescription:UT,shimRTCIceCandidate:wT,shimRTCIceCandidateRelayProtocol:OT,shimSendThrowTypeError:LT});if(function(){let{window:e}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{shimChrome:!0,shimFirefox:!0,shimSafari:!0};const i=Xb,o=function(e){const t={browser:null,version:null};if(void 0===e||!e.navigator||!e.navigator.userAgent)return t.browser="Not a browser.",t;const{navigator:i}=e;if(i.mozGetUserMedia)t.browser="firefox",t.version=Db(i.userAgent,/Firefox\/(\d+)\./,1);else if(i.webkitGetUserMedia||!1===e.isSecureContext&&e.webkitRTCPeerConnection)t.browser="chrome",t.version=Db(i.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else{if(!e.RTCPeerConnection||!i.userAgent.match(/AppleWebKit\/(\d+)\./))return t.browser="Not a supported browser.",t;t.browser="safari",t.version=Db(i.userAgent,/AppleWebKit\/(\d+)\./,1),t.supportsUnifiedPlan=e.RTCRtpTransceiver&&"currentDirection"in e.RTCRtpTransceiver.prototype}return t}(e),r={browserDetails:o,commonShim:ZT,extractVersion:Db,disableLog:Zb,disableWarnings:Wb,sdp:NT};switch(o.browser){case"chrome":if(!rT||!iT||!t.shimChrome)return i("Chrome shim is not included in this adapter release."),r;if(null===o.version)return i("Chrome shim can not determine version, not shimming."),r;i("adapter.js shimming chrome."),r.browserShim=rT,DT(e,o),UT(e),Jb(e,o),jb(e),iT(e,o),zb(e),tT(e,o),Qb(e),qb(e),$b(e),oT(e,o),wT(e),OT(e),xT(e),MT(e,o),LT(e),VT(e,o);break;case"firefox":if(!vT||!aT||!t.shimFirefox)return i("Firefox shim is not included in this adapter release."),r;i("adapter.js shimming firefox."),r.browserShim=vT,DT(e,o),UT(e),sT(e,o),aT(e,o),nT(e),lT(e),dT(e),cT(e),uT(e),hT(e),_T(e),mT(e),pT(e),wT(e),xT(e),MT(e,o),LT(e);break;case"safari":if(!CT||!t.shimSafari)return i("Safari shim is not included in this adapter release."),r;i("adapter.js shimming safari."),r.browserShim=CT,DT(e,o),UT(e),TT(e),ET(e),gT(e),fT(e),ST(e),IT(e),yT(e),RT(e),wT(e),OT(e),MT(e,o),LT(e),VT(e,o);break;default:i("Unsupported browser!")}}({window:"undefined"==typeof window?void 0:window}),"undefined"!=typeof MediaStreamTrack){const e=MediaStreamTrack.prototype.getSettings;MediaStreamTrack.prototype.getSettings=function(){const t=e.call(this);return t.width&&(t.width=Math.floor(t.width)),t.height&&(t.height=Math.floor(t.height)),t.frameRate&&(t.frameRate=Math.floor(t.frameRate)),t}}var WT=ke,XT=TypeError,GT=qo,FT=Math.floor,HT=function(e,t){var i=e.length;if(i<8)for(var o,r,s=1;s<i;){for(r=s,o=e[s];r&&t(e[r-1],o)>0;)e[r]=e[--r];r!==s++&&(e[r]=o)}else for(var n=FT(i/2),a=HT(GT(e,0,n),t),d=HT(GT(e,n),t),c=a.length,l=d.length,u=0,h=0;u<c||h<l;)e[u+h]=u<c&&h<l?t(a[u],d[h])<=0?a[u++]:d[h++]:u<c?a[u++]:d[h++];return e},YT=HT,KT=de.match(/firefox\/(\d+)/i),BT=!!KT&&+KT[1],JT=/MSIE|Trident/.test(de),jT=de.match(/AppleWebKit\/(\d+)\./),zT=!!jT&&+jT[1],QT=wi,qT=f,$T=we,eI=qe,tI=Fi,iI=function(e,t){if(!delete e[t])throw new XT("Cannot delete property "+WT(t)+" of "+WT(e))},oI=bo,rI=n,sI=YT,nI=gd,aI=BT,dI=JT,cI=pe,lI=zT,uI=[],hI=qT(uI.sort),_I=qT(uI.push),mI=rI((function(){uI.sort(void 0)})),pI=rI((function(){uI.sort(null)})),vI=nI("sort"),fI=!rI((function(){if(cI)return cI<70;if(!(aI&&aI>3)){if(dI)return!0;if(lI)return lI<603;var e,t,i,o,r="";for(e=65;e<76;e++){switch(t=String.fromCharCode(e),e){case 66:case 69:case 70:case 72:i=3;break;case 68:case 71:i=4;break;default:i=2}for(o=0;o<47;o++)uI.push({k:t+o,v:i})}for(uI.sort((function(e,t){return t.v-e.v})),o=0;o<uI.length;o++)t=uI[o].k.charAt(0),r.charAt(r.length-1)!==t&&(r+=t);return"DGBEFHACIJK"!==r}}));QT({target:"Array",proto:!0,forced:mI||!pI||!vI||!fI},{sort:function(e){void 0!==e&&$T(e);var t=eI(this);if(fI)return void 0===e?hI(t):hI(t,e);var i,o,r=[],s=tI(t);for(o=0;o<s;o++)o in t&&_I(r,t[o]);for(sI(r,function(e){return function(t,i){return void 0===i?-1:void 0===t?1:void 0!==e?+e(t,i)||0:oI(t)>oI(i)?1:-1}}(e)),i=tI(r),o=0;o<i;)t[o]=r[o++];for(;o<s;)iI(t,o++);return t}});var SI=Xa("Array","sort"),gI=se,yI=SI,bI=Array.prototype,TI=i((function(e){var t=e.sort;return e===bI||gI(bI,e)&&t===bI.sort?yI:t})),II={exports:{}};!function(e){var t=Object.prototype.hasOwnProperty,i="~";function o(){}function r(e,t,i){this.fn=e,this.context=t,this.once=i||!1}function s(e,t,o,s,n){if("function"!=typeof o)throw new TypeError("The listener must be a function");var a=new r(o,s||e,n),d=i?i+t:t;return e._events[d]?e._events[d].fn?e._events[d]=[e._events[d],a]:e._events[d].push(a):(e._events[d]=a,e._eventsCount++),e}function n(e,t){0==--e._eventsCount?e._events=new o:delete e._events[t]}function a(){this._events=new o,this._eventsCount=0}Object.create&&(o.prototype=Object.create(null),(new o).__proto__||(i=!1)),a.prototype.eventNames=function(){var e,o,r=[];if(0===this._eventsCount)return r;for(o in e=this._events)t.call(e,o)&&r.push(i?o.slice(1):o);return Object.getOwnPropertySymbols?r.concat(Object.getOwnPropertySymbols(e)):r},a.prototype.listeners=function(e){var t=i?i+e:e,o=this._events[t];if(!o)return[];if(o.fn)return[o.fn];for(var r=0,s=o.length,n=new Array(s);r<s;r++)n[r]=o[r].fn;return n},a.prototype.listenerCount=function(e){var t=i?i+e:e,o=this._events[t];return o?o.fn?1:o.length:0},a.prototype.emit=function(e,t,o,r,s,n){var a=i?i+e:e;if(!this._events[a])return!1;var d,c,l=this._events[a],u=arguments.length;if(l.fn){switch(l.once&&this.removeListener(e,l.fn,void 0,!0),u){case 1:return l.fn.call(l.context),!0;case 2:return l.fn.call(l.context,t),!0;case 3:return l.fn.call(l.context,t,o),!0;case 4:return l.fn.call(l.context,t,o,r),!0;case 5:return l.fn.call(l.context,t,o,r,s),!0;case 6:return l.fn.call(l.context,t,o,r,s,n),!0}for(c=1,d=new Array(u-1);c<u;c++)d[c-1]=arguments[c];l.fn.apply(l.context,d)}else{var h,_=l.length;for(c=0;c<_;c++)switch(l[c].once&&this.removeListener(e,l[c].fn,void 0,!0),u){case 1:l[c].fn.call(l[c].context);break;case 2:l[c].fn.call(l[c].context,t);break;case 3:l[c].fn.call(l[c].context,t,o);break;case 4:l[c].fn.call(l[c].context,t,o,r);break;default:if(!d)for(h=1,d=new Array(u-1);h<u;h++)d[h-1]=arguments[h];l[c].fn.apply(l[c].context,d)}}return!0},a.prototype.on=function(e,t,i){return s(this,e,t,i,!1)},a.prototype.once=function(e,t,i){return s(this,e,t,i,!0)},a.prototype.removeListener=function(e,t,o,r){var s=i?i+e:e;if(!this._events[s])return this;if(!t)return n(this,s),this;var a=this._events[s];if(a.fn)a.fn!==t||r&&!a.once||o&&a.context!==o||n(this,s);else{for(var d=0,c=[],l=a.length;d<l;d++)(a[d].fn!==t||r&&!a[d].once||o&&a[d].context!==o)&&c.push(a[d]);c.length?this._events[s]=1===c.length?c[0]:c:n(this,s)}return this},a.prototype.removeAllListeners=function(e){var t;return e?(t=i?i+e:e,this._events[t]&&n(this,t)):(this._events=new o,this._eventsCount=0),this},a.prototype.off=a.prototype.removeListener,a.prototype.addListener=a.prototype.on,a.prefixed=i,a.EventEmitter=a,e.exports=a}(II);var EI=II.exports,RI=i(EI);const CI=new LS("VERTC",0);class kI extends EI.EventEmitter{safeEmit(e){const t=this.listenerCount(e);try{for(var i=arguments.length,o=new Array(i>1?i-1:0),r=1;r<i;r++)o[r-1]=arguments[r];return super.emit(e,...o)}catch(wZ){return CI.error("safeEmit","safeEmit() | event listener threw an error [event:%s]:%o",e,wZ),console.error(wZ),Boolean(t)}}async asyncEmit(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),o=1;o<t;o++)i[o-1]=arguments[o];await Promise.resolve().then((()=>{try{super.emit(e,...i)}catch(wZ){CI.error("safeEmit","safeEmit() | event listener threw an error [event:%s]:%o",e,wZ),console.error(wZ)}}))}}var AI=(e=>(e[e.BLACK=0]="BLACK",e[e.NORMAL=1]="NORMAL",e))(AI||{}),PI=(e=>(e.streamRemovedBySchedule308="stream removed",e.clientRePublish="client republish",e.publishStreamFaied="publish failed",e.clientUnPublish="client unpublished",e.clientDisconnected="client disconnected",e.videoMuted="video muted",e))(PI||{}),NI=(e=>(e.PushLimitWarn="PushLimitWarn",e.OTHER="OTHER",e))(NI||{}),wI=(e=>(e.CHANGE_CODEC="changeCodec",e))(wI||{}),OI=(e=>(e.ON_ADD_STREAM="onAddStream",e.ON_ADD_STREAM_LIST="onAddStreamList",e.ON_REMOVE_STREAM="onRemoveStream",e.ON_REMOVE_STREAM_LIST="onRemoveStreamList",e.USER_DISCONNECTION="userDisconnection",e.USER_DISCONNECTION_LIST="userDisconnectionList",e.USER_CONNECTION="userConnection",e.USER_CONNECTION_LIST="userConnectionList",e.ON_UPDATE_STREAM_ATTRIBUTES="onUpdateStreamAttributes",e.ON_UPDATE_ROOM_ATTRIBUTES="onUpdateRoomAttributes",e.ON_UPDATE_USER_ATTRIBUTES="onUpdateUserAttributes",e.ON_PUSH_TRACK="onPushTrack",e.ON_REMOVE_TRACK="onRemoveTrack",e.ON_CUSTOM_MESSAGE="onCustomMessage",e.NODE_CHANGE="nodeChange",e.USER_MESSAGE_RECEIVED="userMessageReceived",e.USER_BINARY_MESSAGE_RECEIVED="userBinaryMessageReceived",e.USER_MESSAGE_RECEIVED_OUTSIDE_ROOM="userMessageReceivedOutsideRoom",e.USER_BINARY_MESSAGE_RECEIVED_OUTSIDE_ROOM="userBinaryMessageReceivedOutsideRoom",e.POST_PROCESSING_MESSAGE="postProcessingMessage",e.ON_USER_TOKEN_WILL_EXPIRE="onUserTokenWillExpire",e.ON_TOKEN_PUBLISH_PRIVILEGE_WILL_EXPIRE="onTokenPublishPrivilegeWillExpire",e.ON_TOKEN_PUBLISH_PRIVILEGE_DID_EXPIRED="onTokenPublishPrivilegeDidExpired",e.ON_TOKEN_SUBSCRIBE_PRIVILEGE_WILL_EXPIRE="onTokenSubscribePrivilegeWillExpire",e.ON_TOKEN_SUBSCRIBE_PRIVILEGE_DID_EXPIRED="onTokenSubscribePrivilegeDidExpired",e.STREAM_CONTROL_MESSAGE="streamControlMessage",e.ON_SPEAKER_CHANGE="onSpeakerChange",e.ON_STREAM_FAILED="streamFailed",e.ON_NOTIFY_RECONNECT="notifyReconnect",e.ON_FORWARD_DST_ROOM_USER_KICK="onForwardDstRoomUserKick",e.ENGINE_CONTROL_MESSAGE="engineControlMessage",e.ON_STREAM_PUSHED_BY_OTHER="onStreamPushedByOther",e.ON_STREAM_PULL_STATE_CHANGED="onStreamPullStateChanged",e))(OI||{}),MI=(e=>(e.RSCP="RSCP",e.RTT="RTT",e.SSC="SSC",e))(MI||{}),LI=(e=>(e.ON_CONNECTION_STATE_CHANGE="onConnectionStateChange",e.ON_VENDOR_CONNECTION_STATE_CHANGE="onVendorConnectionStateChange",e.ABNORMAL_DISCONNECTION="normalConnection",e.ON_RECONNECT_FAILED="onReconnectFailed",e.CONNECT_WITH_TCP="onIceConnectWithTcp",e))(LI||{}),xI=(e=>(e.userLeave="userLeave",e.connectionLost="connectionLost",e.userDuplicateLogin="userDuplicateLogin",e.kickedByAdmin="kickedByAdmin",e.roleChanged="roleChanged",e.onUserTokenDidExpire="onUserTokenDidExpire",e))(xI||{}),VI=(e=>(e[e.roomDismissByAdmin=2]="roomDismissByAdmin",e))(VI||{}),DI=(e=>(e[e.LIMIT_MODE=1]="LIMIT_MODE",e[e.NORMAL_MODE=2]="NORMAL_MODE",e))(DI||{}),UI=(e=>(e[e.NORMAL=0]="NORMAL",e[e.BLACK=1]="BLACK",e))(UI||{}),ZI=(e=>(e[e.EXTERNAL=0]="EXTERNAL",e[e.INTERNAL=1]="INTERNAL",e))(ZI||{}),WI=(e=>(e.AUDIO="audio",e.VIDEO="video",e))(WI||{}),XI=(e=>(e.MAIN="main",e.SCREEN="screen",e.PUBLIC="public",e.VIRTUAL="virtual",e))(XI||{});class GI extends kI{constructor(e,t,i){super(),Xu(this,"trackId",Jy()),Xu(this,"_logger",void 0),Xu(this,"trackInfo",void 0),Xu(this,"_originTrack",void 0),Xu(this,"_channelCount",void 0),this._ctx=e,this._logger=new LS("Track",4,e.id),this.trackInfo=i,this._originTrack=t,this._channelCount=t.getSettings().channelCount}get dummy(){return this.trackInfo.isDummy}get virtual(){return"virtual"===this.trackInfo.streamIndex}get isScreen(){return"screen"===this.trackInfo.streamIndex}get isPublic(){return"public"===this.trackInfo.streamIndex}get sourceType(){return this.trackInfo.sourceType}get mediaType(){return this.trackInfo.mediaType}get captureSessionId(){return this.trackInfo.captureSessionId}get streamIndex(){const{streamIndex:e}=this.trackInfo;return"main"===e?$u.STREAM_INDEX_MAIN:"screen"===e?$u.STREAM_INDEX_SCREEN:void 0}get channelCount(){var e;return null!==(e=this._channelCount)&&void 0!==e?e:0}get originTrack(){return this._originTrack}set originTrack(e){this._originTrack=e,this._channelCount=mediaTrack.getSettings().channelCount}get logger(){return this._logger.module=this.constructor.name,this._logger}destroy(){this._originTrack.stop()}}class FI extends GI{constructor(e,t,i){super(e,t,i),Xu(this,"_mediaTrack",void 0),Xu(this,"_preProcessingTrack",void 0),Xu(this,"isTrackReady",void 0),Xu(this,"handleTrackEnded",(()=>{this.emit("track-ended",this),this.destroy()})),Xu(this,"handleMute",(()=>{this.emit("track-mute",this)})),Xu(this,"handleUnmute",(()=>{this.emit("track-unmute",this)})),this._initListeners(),this.isTrackReady=this.generatePreProcessingTrack()}get mediaTrack(){var e;return null!==(e=this._mediaTrack)&&void 0!==e?e:this._originTrack}set mediaTrack(e){this.mediaTrack.id!==e.id&&(this._mediaTrack=e,this.isTrackReady=this.generatePreProcessingTrack())}get preprocessingTrack(){var e;return null!==(e=this._preProcessingTrack)&&void 0!==e?e:this.mediaTrack}async generatePreProcessingTrack(){var e;const t=null===(e=this._preProcessingTrack)||void 0===e?void 0:e.id;this._preProcessingTrack=void 0;try{const e=await this._ctx.extensionManager.getPreProcessingTrack(this);e instanceof MediaStreamTrack&&(this._preProcessingTrack=e,t!==this._preProcessingTrack.id&&setTimeout((()=>{this.emit("needReplaceTrack")})))}catch(i){console.error(i)}}destroy(){var e,t;this._originTrack.removeEventListener("ended",this.handleTrackEnded),this._originTrack.removeEventListener("mute",this.handleMute),this._originTrack.removeEventListener("unmute",this.handleUnmute),null===(e=this._preProcessingTrack)||void 0===e||e.stop(),null===(t=this._mediaTrack)||void 0===t||t.stop(),super.destroy()}_initListeners(){this._originTrack instanceof MediaStreamTrack&&(this._originTrack.addEventListener("ended",this.handleTrackEnded),this._originTrack.addEventListener("mute",this.handleMute),this._originTrack.addEventListener("unmute",this.handleUnmute))}}class HI extends GI{constructor(e,t,i){super(e,t,i),Xu(this,"_mediaTrack",void 0),this._originTrack=t}get mediaTrack(){var e;return null!==(e=this._mediaTrack)&&void 0!==e?e:this._originTrack}set mediaTrack(e){this.mediaTrack.id!==e.id&&(this._mediaTrack=e)}get preprocessingTrack(){return this.mediaTrack}}var YI=(e=>(e.H264="H264",e.VP8="VP8",e.ByteVC1="ByteVC1",e))(YI||{});const KI=async()=>{const e=[];return await oE()&&await iE()&&e.push(YI.ByteVC1),await $I()&&await qI()&&e.push(YI.H264),await tE()&&await eE()&&e.push(YI.VP8),e},BI={};function JI(e){const t=e.split("\n");let i=!1;for(const o of t)if(o.includes("level-asymmetry-allowed=1")&&o.includes("packetization-mode=1")&&o.includes("profile-level-id=42e0")){i=!0;break}if(i){const e=navigator.userAgent.toLowerCase();let t=!1;const i=[/miuibrowser/,/70.*HeyTapBrowser/i];for(const o of i)o.test(e)&&(t=!0);return!t}return!1}const jI=async e=>{const t=new RTCPeerConnection;t.addTransceiver("video",{direction:e});const i=await t.createOffer();return t.close(),i.sdp.toLowerCase()},zI=async()=>{let e=await jI("sendonly");return navigator.userAgent.includes("VivoBrowser")&&(e=await jI("sendonly")),BI.h264encode=JI(e),BI.vp8encode=e.indexOf("vp8")>-1,BI.h265encode=e.indexOf("h265")>-1,BI},QI=async()=>{let e=await jI("recvonly");return navigator.userAgent.includes("VivoBrowser")&&(e=await jI("recvonly")),BI.h264decode=JI(e),BI.vp8decode=e.indexOf("vp8")>-1,BI.h265decode=e.indexOf("h265")>-1,BI},qI=async()=>{if(void 0===BI.h264encode)try{await zI()}catch(e){return!1}return BI.h264encode||!1},$I=async()=>{if(void 0===BI.h264decode)try{await QI()}catch(e){return!1}return BI.h264decode||!1},eE=async()=>{if(void 0===BI.vp8encode)try{await zI()}catch(e){return!1}return BI.vp8encode||!1},tE=async()=>{if(void 0===BI.vp8decode)try{await QI()}catch(e){return!1}return BI.vp8decode||!1},iE=async()=>{if(void 0===BI.h265encode)try{await zI()}catch(e){return!1}return BI.h265encode||!1},oE=async()=>{if(void 0===BI.h265decode)try{await QI()}catch(e){return!1}return BI.h265decode||!1},rE=()=>"undefined"!=typeof TransformStream&&"undefined"!=typeof RTCRtpSender&&"undefined"!=typeof RTCRtpReceiver&&"undefined"!=typeof RTCRtpScriptTransform&&"transform"in RTCRtpSender.prototype&&"transform"in RTCRtpReceiver.prototype&&hE()&&mE(),sE=()=>"undefined"!=typeof TransformStream&&"undefined"!=typeof RTCRtpSender&&"undefined"!=typeof RTCRtpReceiver&&void 0!==RTCRtpSender.prototype.createEncodedStreams&&void 0!==RTCRtpReceiver.prototype.createEncodedStreams,nE=()=>jS?WS&&_g>=70||US&&dg>=80||ZS&&ag>=14:eg?WS&&_g>=70||US&&dg>=80:qS?lg[0]>=14:!(!$S&&!tg)&&(WS&&_g>=86),aE=WS&&_g<=114,dE=!US||dg>=96,cE=!(ZS&&ag<=14),lE=$S&&WS||qS&&lg[0]>=16,uE=void 0!==hy&&"PressureObserver"in hy,hE=()=>"undefined"!=typeof window&&window.Worker,_E=!(ZS&&ag<=14),mE=()=>"undefined"!=typeof MessageChannel;var pE=(e=>(e[e.internal=0]="internal",e[e.external=1]="external",e[e.bypass=2]="bypass",e))(pE||{});const vE=new Uint8Array([109,167,53,190,103,90,72,1,170,89,63,164,194,199,19,85]),fE=new Uint8Array([109,167,53,190,103,90,72,1,170,89,63,164,194,199,19,84]),SE=new Uint8Array([31,239,3,50,242,120,76,85,169,42,161,91,75,186,22]);function gE(e){const t=[];for(;e>=255;)e-=255,t.push(255);return t.push(e),new Uint8Array(t)}function yE(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=0;for(;255===e[t]&&t<e.byteLength;)t++,i+=255;return t<e.byteLength&&(i+=e[t++]),[i,t]}const bE=new Uint8Array([80,1]);class TE{static generateSEI(e,t){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const o=new Uint8Array([0,0,0,1]),r=t?bE:new Uint8Array([6]),s=new Uint8Array([5]),n=TE.__uuid||(i?vE:fE),a=gE(e.byteLength+n.byteLength),d=(e=>{const t=[];let i=0;for(const o of e)i>=2&&o<=3&&(t.push(3),i=0),0===o?i++:i=0,t.push(o);return new Uint8Array(t)})(e);return new Uint8Array([...o,...r,...s,...a,...n,...d,128])}static decodeSEIBody(e,t){const i=(e=>{const t=[];for(let i=0;i<e.length;i++)e[i]<=3&&0===e[i-1]&&0===e[i-2]||t.push(e[i]);return new Uint8Array(t)})(e=e.slice(0,e.length-1));if(i.byteLength<2)return;let o=0;const r=t?2:1;if(5!==i[r]&&100!==i[r])return;o+=1+r;const[s,n]=yE(i,o);o=n;let a=2;const d=o+s;i.byteLength>=fE.byteLength&&s>=fE.byteLength&&(i.slice(o,o+fE.byteLength).toString()===fE.toString()||i.slice(o,o+SE.byteLength).toString()===SE.toString())?(o+=fE.byteLength,a=1):i.byteLength>=fE.byteLength&&s>=fE.byteLength&&i.slice(o,o+vE.byteLength).toString()===vE.toString()&&(o+=vE.byteLength,a=0);return{type:a,payload:i.slice(o,d)}}static parseInternalSEI(e){const t=new Map;let i=0;if(0===e.type){for(;e.payload.byteLength-i>=2;){const[o,r]=yE(e.payload,i);i=r;const[s,n]=yE(e.payload,i);if(i=n,t.get(o)||!(s<=e.payload.byteLength-i))break;t.set(o,e.payload.slice(i,i+s)),i+=s}return t}}static makeInternalSei(e){const t=[];for(const[r,s]of e){const e=gE(r),i=gE(s.byteLength);t.push(e,i,s)}const i=t.reduce(((e,t)=>e+t.byteLength),0),o=new Uint8Array(i);return t.reduce(((e,t)=>(o.set(t,e),e+t.byteLength)),0),o}}Xu(TE,"__uuid",void 0);var IE=wi,EE=f,RE=Zi,CE=RangeError,kE=String.fromCharCode,AE=String.fromCodePoint,PE=EE([].join);IE({target:"String",stat:!0,arity:1,forced:!!AE&&1!==AE.length},{fromCodePoint:function(e){for(var t,i=[],o=arguments.length,r=0;o>r;){if(t=+arguments[r++],RE(t,1114111)!==t)throw new CE(t+" is not a valid code point");i[r]=t<65536?kE(t):kE(55296+((t-=65536)>>10),t%1024+56320)}return PE(i,"")}});var NE=s,wE=A,OE=Object.getOwnPropertyDescriptor,ME=function(e){if(!wE)return NE[e];var t=OE(NE,e);return t&&t.value},LE=n,xE=We,VE=pt("iterator"),DE=!LE((function(){var e=new URL("b?a=1&b=2&c=3","https://a"),t=e.searchParams,i=new URLSearchParams("a=1&a=2&b=3"),o="";return e.pathname="c%20d",t.forEach((function(e,i){t.delete("b"),o+=i+e})),i.delete("a",2),i.delete("b",void 0),!e.toJSON||!i.has("a",1)||i.has("a",2)||!i.has("a",void 0)||i.has("b")||!t.size&&xE||!t.sort||"https://a/c%20d?a=1&c=3"!==e.href||"3"!==t.get("c")||"a=1"!==String(new URLSearchParams("?a=1"))||!t[VE]||"a"!==new URL("https://a@b").username||"b"!==new URLSearchParams(new URLSearchParams("a=b")).get("a")||"xn--e1aybc"!==new URL("https://ÑÐµÑÑ").host||"#%D0%B1"!==new URL("https://a#Ð±").hash||"a1c3"!==o||"x"!==new URL("https://x",void 0).host})),UE=nr,ZE=se,WE=TypeError,XE=function(e,t){if(ZE(t,e))return e;throw new WE("Incorrect invocation")},GE=So,FE=Le,HE=H,YE=Cc,KE=pt("iterator"),BE=function(e){if(!HE(e))return FE(e,KE)||FE(e,"@@iterator")||YE[GE(e)]},JE=w,jE=we,zE=si,QE=ke,qE=BE,$E=TypeError,eR=function(e,t){var i=arguments.length<2?qE(e):t;if(jE(i))return zE(JE(i,e));throw new $E(QE(e)+" is not iterable")},tR=TypeError,iR=function(e,t){if(e<t)throw new tR("Not enough arguments");return e},oR=wi,rR=s,sR=ME,nR=re,aR=w,dR=f,cR=A,lR=DE,uR=nr,hR=dr,_R=function(e,t,i){for(var o in t)i&&i.unsafe&&e[o]?e[o]=t[o]:UE(e,o,t[o],i);return e},mR=Or,pR=rl,vR=Jr,fR=XE,SR=C,gR=tt,yR=$t,bR=So,TR=si,IR=q,ER=bo,RR=Bo,CR=U,kR=eR,AR=BE,PR=Ml,NR=iR,wR=YT,OR=pt("iterator"),MR="URLSearchParams",LR=MR+"Iterator",xR=vR.set,VR=vR.getterFor(MR),DR=vR.getterFor(LR),UR=sR("fetch"),ZR=sR("Request"),WR=sR("Headers"),XR=ZR&&ZR.prototype,GR=WR&&WR.prototype,FR=rR.TypeError,HR=rR.encodeURIComponent,YR=String.fromCharCode,KR=nR("String","fromCodePoint"),BR=parseInt,JR=dR("".charAt),jR=dR([].join),zR=dR([].push),QR=dR("".replace),qR=dR([].shift),$R=dR([].splice),eC=dR("".split),tC=dR("".slice),iC=dR(/./.exec),oC=/\+/g,rC=/^[0-9a-f]+$/i,sC=function(e,t){var i=tC(e,t,t+2);return iC(rC,i)?BR(i,16):NaN},nC=function(e){for(var t=0,i=128;i>0&&e&i;i>>=1)t++;return t},aC=function(e){var t=null;switch(e.length){case 1:t=e[0];break;case 2:t=(31&e[0])<<6|63&e[1];break;case 3:t=(15&e[0])<<12|(63&e[1])<<6|63&e[2];break;case 4:t=(7&e[0])<<18|(63&e[1])<<12|(63&e[2])<<6|63&e[3]}return t>1114111?null:t},dC=function(e){for(var t=(e=QR(e,oC," ")).length,i="",o=0;o<t;){var r=JR(e,o);if("%"===r){if("%"===JR(e,o+1)||o+3>t){i+="%",o++;continue}var s=sC(e,o+1);if(s!=s){i+=r,o++;continue}o+=2;var n=nC(s);if(0===n)r=YR(s);else{if(1===n||n>4){i+="ï¿½",o++;continue}for(var a=[s],d=1;d<n&&!(++o+3>t||"%"!==JR(e,o));){var c=sC(e,o+1);if(c!=c){o+=3;break}if(c>191||c<128)break;zR(a,c),o+=2,d++}if(a.length!==n){i+="ï¿½";continue}var l=aC(a);null===l?i+="ï¿½":r=KR(l)}}i+=r,o++}return i},cC=/[!'()~]|%20/g,lC={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+"},uC=function(e){return lC[e]},hC=function(e){return QR(HR(e),cC,uC)},_C=pR((function(e,t){xR(this,{type:LR,target:VR(e).entries,index:0,kind:t})}),MR,(function(){var e=DR(this),t=e.target,i=e.index++;if(!t||i>=t.length)return e.target=null,PR(void 0,!0);var o=t[i];switch(e.kind){case"keys":return PR(o.key,!1);case"values":return PR(o.value,!1)}return PR([o.key,o.value],!1)}),!0),mC=function(e){this.entries=[],this.url=null,void 0!==e&&(IR(e)?this.parseObject(e):this.parseQuery("string"==typeof e?"?"===JR(e,0)?tC(e,1):e:ER(e)))};mC.prototype={type:MR,bindURL:function(e){this.url=e,this.update()},parseObject:function(e){var t,i,o,r,s,n,a,d=this.entries,c=AR(e);if(c)for(i=(t=kR(e,c)).next;!(o=aR(i,t)).done;){if(s=(r=kR(TR(o.value))).next,(n=aR(s,r)).done||(a=aR(s,r)).done||!aR(s,r).done)throw new FR("Expected sequence with length 2");zR(d,{key:ER(n.value),value:ER(a.value)})}else for(var l in e)gR(e,l)&&zR(d,{key:l,value:ER(e[l])})},parseQuery:function(e){if(e)for(var t,i,o=this.entries,r=eC(e,"&"),s=0;s<r.length;)(t=r[s++]).length&&(i=eC(t,"="),zR(o,{key:dC(qR(i)),value:dC(jR(i,"="))}))},serialize:function(){for(var e,t=this.entries,i=[],o=0;o<t.length;)e=t[o++],zR(i,hC(e.key)+"="+hC(e.value));return jR(i,"&")},update:function(){this.entries.length=0,this.parseQuery(this.url.query)},updateURL:function(){this.url&&this.url.update()}};var pC=function(){fR(this,vC);var e=xR(this,new mC(arguments.length>0?arguments[0]:void 0));cR||(this.size=e.entries.length)},vC=pC.prototype;if(_R(vC,{append:function(e,t){var i=VR(this);NR(arguments.length,2),zR(i.entries,{key:ER(e),value:ER(t)}),cR||this.length++,i.updateURL()},delete:function(e){for(var t=VR(this),i=NR(arguments.length,1),o=t.entries,r=ER(e),s=i<2?void 0:arguments[1],n=void 0===s?s:ER(s),a=0;a<o.length;){var d=o[a];if(d.key!==r||void 0!==n&&d.value!==n)a++;else if($R(o,a,1),void 0!==n)break}cR||(this.size=o.length),t.updateURL()},get:function(e){var t=VR(this).entries;NR(arguments.length,1);for(var i=ER(e),o=0;o<t.length;o++)if(t[o].key===i)return t[o].value;return null},getAll:function(e){var t=VR(this).entries;NR(arguments.length,1);for(var i=ER(e),o=[],r=0;r<t.length;r++)t[r].key===i&&zR(o,t[r].value);return o},has:function(e){for(var t=VR(this).entries,i=NR(arguments.length,1),o=ER(e),r=i<2?void 0:arguments[1],s=void 0===r?r:ER(r),n=0;n<t.length;){var a=t[n++];if(a.key===o&&(void 0===s||a.value===s))return!0}return!1},set:function(e,t){var i=VR(this);NR(arguments.length,1);for(var o,r=i.entries,s=!1,n=ER(e),a=ER(t),d=0;d<r.length;d++)(o=r[d]).key===n&&(s?$R(r,d--,1):(s=!0,o.value=a));s||zR(r,{key:n,value:a}),cR||(this.size=r.length),i.updateURL()},sort:function(){var e=VR(this);wR(e.entries,(function(e,t){return e.key>t.key?1:-1})),e.updateURL()},forEach:function(e){for(var t,i=VR(this).entries,o=yR(e,arguments.length>1?arguments[1]:void 0),r=0;r<i.length;)o((t=i[r++]).value,t.key,this)},keys:function(){return new _C(this,"keys")},values:function(){return new _C(this,"values")},entries:function(){return new _C(this,"entries")}},{enumerable:!0}),uR(vC,OR,vC.entries,{name:"entries"}),uR(vC,"toString",(function(){return VR(this).serialize()}),{enumerable:!0}),cR&&hR(vC,"size",{get:function(){return VR(this).entries.length},configurable:!0,enumerable:!0}),mR(pC,MR),oR({global:!0,constructor:!0,forced:!lR},{URLSearchParams:pC}),!lR&&SR(WR)){var fC=dR(GR.has),SC=dR(GR.set),gC=function(e){if(IR(e)){var t,i=e.body;if(bR(i)===MR)return t=e.headers?new WR(e.headers):new WR,fC(t,"content-type")||SC(t,"content-type","application/x-www-form-urlencoded;charset=UTF-8"),RR(e,{body:CR(0,ER(i)),headers:CR(0,t)})}return e};if(SR(UR)&&oR({global:!0,enumerable:!0,dontCallGetSet:!0,forced:!0},{fetch:function(e){return UR(e,arguments.length>1?gC(arguments[1]):{})}}),SR(ZR)){var yC=function(e){return fR(this,XR),new ZR(e,arguments.length>1?gC(arguments[1]):{})};XR.constructor=yC,yC.prototype=XR,oR({global:!0,constructor:!0,dontCallGetSet:!0,forced:!0},{Request:yC})}}var bC,TC={URLSearchParams:pC,getState:VR},IC=A,EC=f,RC=w,CC=n,kC=so,AC=rr,PC=O,NC=qe,wC=F,OC=Object.assign,MC=Object.defineProperty,LC=EC([].concat),xC=!OC||CC((function(){if(IC&&1!==OC({b:1},OC(MC({},"a",{enumerable:!0,get:function(){MC(this,"b",{value:3,enumerable:!1})}}),{b:2})).b)return!0;var e={},t={},i=Symbol("assign detection"),o="abcdefghijklmnopqrst";return e[i]=7,o.split("").forEach((function(e){t[e]=e})),7!==OC({},e)[i]||kC(OC({},t)).join("")!==o}))?function(e,t){for(var i=NC(e),o=arguments.length,r=1,s=AC.f,n=PC.f;o>r;)for(var a,d=wC(arguments[r++]),c=s?LC(kC(d),s(d)):kC(d),l=c.length,u=0;l>u;)a=c[u++],IC&&!RC(n,d,a)||(i[a]=d[a]);return i}:OC,VC=w,DC=si,UC=Le,ZC=function(e,t,i){var o,r;DC(e);try{if(!(o=UC(e,"return"))){if("throw"===t)throw i;return i}o=VC(o,e)}catch(wZ){r=!0,o=wZ}if("throw"===t)throw i;if(r)throw o;return DC(o),i},WC=si,XC=ZC,GC=Cc,FC=pt("iterator"),HC=Array.prototype,YC=function(e){return void 0!==e&&(GC.Array===e||HC[FC]===e)},KC=$t,BC=w,JC=qe,jC=function(e,t,i,o){try{return o?t(WC(i)[0],i[1]):t(i)}catch(wZ){XC(e,"throw",wZ)}},zC=YC,QC=_s,qC=Fi,$C=Zd,ek=eR,tk=BE,ik=Array,ok=f,rk=2147483647,sk=/[^\0-\u007E]/,nk=/[.\u3002\uFF0E\uFF61]/g,ak="Overflow: input needs wider integers to process",dk=RangeError,ck=ok(nk.exec),lk=Math.floor,uk=String.fromCharCode,hk=ok("".charCodeAt),_k=ok([].join),mk=ok([].push),pk=ok("".replace),vk=ok("".split),fk=ok("".toLowerCase),Sk=function(e){return e+22+75*(e<26)},gk=function(e,t,i){var o=0;for(e=i?lk(e/700):e>>1,e+=lk(e/t);e>455;)e=lk(e/35),o+=36;return lk(o+36*e/(e+38))},yk=function(e){var t=[];e=function(e){for(var t=[],i=0,o=e.length;i<o;){var r=hk(e,i++);if(r>=55296&&r<=56319&&i<o){var s=hk(e,i++);56320==(64512&s)?mk(t,((1023&r)<<10)+(1023&s)+65536):(mk(t,r),i--)}else mk(t,r)}return t}(e);var i,o,r=e.length,s=128,n=0,a=72;for(i=0;i<e.length;i++)(o=e[i])<128&&mk(t,uk(o));var d=t.length,c=d;for(d&&mk(t,"-");c<r;){var l=rk;for(i=0;i<e.length;i++)(o=e[i])>=s&&o<l&&(l=o);var u=c+1;if(l-s>lk((rk-n)/u))throw new dk(ak);for(n+=(l-s)*u,s=l,i=0;i<e.length;i++){if((o=e[i])<s&&++n>rk)throw new dk(ak);if(o===s){for(var h=n,_=36;;){var m=_<=a?1:_>=a+26?26:_-a;if(h<m)break;var p=h-m,v=36-m;mk(t,uk(Sk(m+p%v))),h=lk(p/v),_+=36}mk(t,uk(Sk(h))),a=gk(n,u,c===d),n=0,c++}}n++,s++}return _k(t,"")},bk=wi,Tk=A,Ik=DE,Ek=s,Rk=$t,Ck=f,kk=nr,Ak=dr,Pk=XE,Nk=tt,wk=xC,Ok=function(e){var t=JC(e),i=QC(this),o=arguments.length,r=o>1?arguments[1]:void 0,s=void 0!==r;s&&(r=KC(r,o>2?arguments[2]:void 0));var n,a,d,c,l,u,h=tk(t),_=0;if(!h||this===ik&&zC(h))for(n=qC(t),a=i?new this(n):ik(n);n>_;_++)u=s?r(t[_],_):t[_],$C(a,_,u);else for(a=i?new this:[],l=(c=ek(t,h)).next;!(d=BC(l,c)).done;_++)u=s?jC(c,r,[d.value,_],!0):d.value,$C(a,_,u);return a.length=_,a},Mk=qo,Lk=Au.codeAt,xk=function(e){var t,i,o=[],r=vk(pk(fk(e),nk,"."),".");for(t=0;t<r.length;t++)i=r[t],mk(o,ck(sk,i)?"xn--"+yk(i):i);return _k(o,".")},Vk=bo,Dk=Or,Uk=iR,Zk=TC,Wk=Jr,Xk=Wk.set,Gk=Wk.getterFor("URL"),Fk=Zk.URLSearchParams,Hk=Zk.getState,Yk=Ek.URL,Kk=Ek.TypeError,Bk=Ek.parseInt,Jk=Math.floor,jk=Math.pow,zk=Ck("".charAt),Qk=Ck(/./.exec),qk=Ck([].join),$k=Ck(1..toString),eA=Ck([].pop),tA=Ck([].push),iA=Ck("".replace),oA=Ck([].shift),rA=Ck("".split),sA=Ck("".slice),nA=Ck("".toLowerCase),aA=Ck([].unshift),dA="Invalid scheme",cA="Invalid host",lA="Invalid port",uA=/[a-z]/i,hA=/[\d+-.a-z]/i,_A=/\d/,mA=/^0x/i,pA=/^[0-7]+$/,vA=/^\d+$/,fA=/^[\da-f]+$/i,SA=/[\0\t\n\r #%/:<>?@[\\\]^|]/,gA=/[\0\t\n\r #/:<>?@[\\\]^|]/,yA=/^[\u0000-\u0020]+/,bA=/(^|[^\u0000-\u0020])[\u0000-\u0020]+$/,TA=/[\t\n\r]/g,IA=function(e){var t,i,o,r;if("number"==typeof e){for(t=[],i=0;i<4;i++)aA(t,e%256),e=Jk(e/256);return qk(t,".")}if("object"==typeof e){for(t="",o=function(e){for(var t=null,i=1,o=null,r=0,s=0;s<8;s++)0!==e[s]?(r>i&&(t=o,i=r),o=null,r=0):(null===o&&(o=s),++r);return r>i?o:t}(e),i=0;i<8;i++)r&&0===e[i]||(r&&(r=!1),o===i?(t+=i?":":"::",r=!0):(t+=$k(e[i],16),i<7&&(t+=":")));return"["+t+"]"}return e},EA={},RA=wk({},EA,{" ":1,'"':1,"<":1,">":1,"`":1}),CA=wk({},RA,{"#":1,"?":1,"{":1,"}":1}),kA=wk({},CA,{"/":1,":":1,";":1,"=":1,"@":1,"[":1,"\\":1,"]":1,"^":1,"|":1}),AA=function(e,t){var i=Lk(e,0);return i>32&&i<127&&!Nk(t,e)?e:encodeURIComponent(e)},PA={ftp:21,file:null,http:80,https:443,ws:80,wss:443},NA=function(e,t){var i;return 2===e.length&&Qk(uA,zk(e,0))&&(":"===(i=zk(e,1))||!t&&"|"===i)},wA=function(e){var t;return e.length>1&&NA(sA(e,0,2))&&(2===e.length||"/"===(t=zk(e,2))||"\\"===t||"?"===t||"#"===t)},OA=function(e){return"."===e||"%2e"===nA(e)},MA={},LA={},xA={},VA={},DA={},UA={},ZA={},WA={},XA={},GA={},FA={},HA={},YA={},KA={},BA={},JA={},jA={},zA={},QA={},qA={},$A={},eP=function(e,t,i){var o,r,s,n=Vk(e);if(t){if(r=this.parse(n))throw new Kk(r);this.searchParams=null}else{if(void 0!==i&&(o=new eP(i,!0)),r=this.parse(n,null,o))throw new Kk(r);(s=Hk(new Fk)).bindURL(this),this.searchParams=s}};eP.prototype={type:"URL",parse:function(e,t,i){var o,r,s,n,a,d=this,c=t||MA,l=0,u="",h=!1,_=!1,m=!1;for(e=Vk(e),t||(d.scheme="",d.username="",d.password="",d.host=null,d.port=null,d.path=[],d.query=null,d.fragment=null,d.cannotBeABaseURL=!1,e=iA(e,yA,""),e=iA(e,bA,"$1")),e=iA(e,TA,""),o=Ok(e);l<=o.length;){switch(r=o[l],c){case MA:if(!r||!Qk(uA,r)){if(t)return dA;c=xA;continue}u+=nA(r),c=LA;break;case LA:if(r&&(Qk(hA,r)||"+"===r||"-"===r||"."===r))u+=nA(r);else{if(":"!==r){if(t)return dA;u="",c=xA,l=0;continue}if(t&&(d.isSpecial()!==Nk(PA,u)||"file"===u&&(d.includesCredentials()||null!==d.port)||"file"===d.scheme&&!d.host))return;if(d.scheme=u,t)return void(d.isSpecial()&&PA[d.scheme]===d.port&&(d.port=null));u="","file"===d.scheme?c=KA:d.isSpecial()&&i&&i.scheme===d.scheme?c=VA:d.isSpecial()?c=WA:"/"===o[l+1]?(c=DA,l++):(d.cannotBeABaseURL=!0,tA(d.path,""),c=QA)}break;case xA:if(!i||i.cannotBeABaseURL&&"#"!==r)return dA;if(i.cannotBeABaseURL&&"#"===r){d.scheme=i.scheme,d.path=Mk(i.path),d.query=i.query,d.fragment="",d.cannotBeABaseURL=!0,c=$A;break}c="file"===i.scheme?KA:UA;continue;case VA:if("/"!==r||"/"!==o[l+1]){c=UA;continue}c=XA,l++;break;case DA:if("/"===r){c=GA;break}c=zA;continue;case UA:if(d.scheme=i.scheme,r===bC)d.username=i.username,d.password=i.password,d.host=i.host,d.port=i.port,d.path=Mk(i.path),d.query=i.query;else if("/"===r||"\\"===r&&d.isSpecial())c=ZA;else if("?"===r)d.username=i.username,d.password=i.password,d.host=i.host,d.port=i.port,d.path=Mk(i.path),d.query="",c=qA;else{if("#"!==r){d.username=i.username,d.password=i.password,d.host=i.host,d.port=i.port,d.path=Mk(i.path),d.path.length--,c=zA;continue}d.username=i.username,d.password=i.password,d.host=i.host,d.port=i.port,d.path=Mk(i.path),d.query=i.query,d.fragment="",c=$A}break;case ZA:if(!d.isSpecial()||"/"!==r&&"\\"!==r){if("/"!==r){d.username=i.username,d.password=i.password,d.host=i.host,d.port=i.port,c=zA;continue}c=GA}else c=XA;break;case WA:if(c=XA,"/"!==r||"/"!==zk(u,l+1))continue;l++;break;case XA:if("/"!==r&&"\\"!==r){c=GA;continue}break;case GA:if("@"===r){h&&(u="%40"+u),h=!0,s=Ok(u);for(var p=0;p<s.length;p++){var v=s[p];if(":"!==v||m){var f=AA(v,kA);m?d.password+=f:d.username+=f}else m=!0}u=""}else if(r===bC||"/"===r||"?"===r||"#"===r||"\\"===r&&d.isSpecial()){if(h&&""===u)return"Invalid authority";l-=Ok(u).length+1,u="",c=FA}else u+=r;break;case FA:case HA:if(t&&"file"===d.scheme){c=JA;continue}if(":"!==r||_){if(r===bC||"/"===r||"?"===r||"#"===r||"\\"===r&&d.isSpecial()){if(d.isSpecial()&&""===u)return cA;if(t&&""===u&&(d.includesCredentials()||null!==d.port))return;if(n=d.parseHost(u))return n;if(u="",c=jA,t)return;continue}"["===r?_=!0:"]"===r&&(_=!1),u+=r}else{if(""===u)return cA;if(n=d.parseHost(u))return n;if(u="",c=YA,t===HA)return}break;case YA:if(!Qk(_A,r)){if(r===bC||"/"===r||"?"===r||"#"===r||"\\"===r&&d.isSpecial()||t){if(""!==u){var S=Bk(u,10);if(S>65535)return lA;d.port=d.isSpecial()&&S===PA[d.scheme]?null:S,u=""}if(t)return;c=jA;continue}return lA}u+=r;break;case KA:if(d.scheme="file","/"===r||"\\"===r)c=BA;else{if(!i||"file"!==i.scheme){c=zA;continue}switch(r){case bC:d.host=i.host,d.path=Mk(i.path),d.query=i.query;break;case"?":d.host=i.host,d.path=Mk(i.path),d.query="",c=qA;break;case"#":d.host=i.host,d.path=Mk(i.path),d.query=i.query,d.fragment="",c=$A;break;default:wA(qk(Mk(o,l),""))||(d.host=i.host,d.path=Mk(i.path),d.shortenPath()),c=zA;continue}}break;case BA:if("/"===r||"\\"===r){c=JA;break}i&&"file"===i.scheme&&!wA(qk(Mk(o,l),""))&&(NA(i.path[0],!0)?tA(d.path,i.path[0]):d.host=i.host),c=zA;continue;case JA:if(r===bC||"/"===r||"\\"===r||"?"===r||"#"===r){if(!t&&NA(u))c=zA;else if(""===u){if(d.host="",t)return;c=jA}else{if(n=d.parseHost(u))return n;if("localhost"===d.host&&(d.host=""),t)return;u="",c=jA}continue}u+=r;break;case jA:if(d.isSpecial()){if(c=zA,"/"!==r&&"\\"!==r)continue}else if(t||"?"!==r)if(t||"#"!==r){if(r!==bC&&(c=zA,"/"!==r))continue}else d.fragment="",c=$A;else d.query="",c=qA;break;case zA:if(r===bC||"/"===r||"\\"===r&&d.isSpecial()||!t&&("?"===r||"#"===r)){if(".."===(a=nA(a=u))||"%2e."===a||".%2e"===a||"%2e%2e"===a?(d.shortenPath(),"/"===r||"\\"===r&&d.isSpecial()||tA(d.path,"")):OA(u)?"/"===r||"\\"===r&&d.isSpecial()||tA(d.path,""):("file"===d.scheme&&!d.path.length&&NA(u)&&(d.host&&(d.host=""),u=zk(u,0)+":"),tA(d.path,u)),u="","file"===d.scheme&&(r===bC||"?"===r||"#"===r))for(;d.path.length>1&&""===d.path[0];)oA(d.path);"?"===r?(d.query="",c=qA):"#"===r&&(d.fragment="",c=$A)}else u+=AA(r,CA);break;case QA:"?"===r?(d.query="",c=qA):"#"===r?(d.fragment="",c=$A):r!==bC&&(d.path[0]+=AA(r,EA));break;case qA:t||"#"!==r?r!==bC&&("'"===r&&d.isSpecial()?d.query+="%27":d.query+="#"===r?"%23":AA(r,EA)):(d.fragment="",c=$A);break;case $A:r!==bC&&(d.fragment+=AA(r,RA))}l++}},parseHost:function(e){var t,i,o;if("["===zk(e,0)){if("]"!==zk(e,e.length-1))return cA;if(t=function(e){var t,i,o,r,s,n,a,d=[0,0,0,0,0,0,0,0],c=0,l=null,u=0,h=function(){return zk(e,u)};if(":"===h()){if(":"!==zk(e,1))return;u+=2,l=++c}for(;h();){if(8===c)return;if(":"!==h()){for(t=i=0;i<4&&Qk(fA,h());)t=16*t+Bk(h(),16),u++,i++;if("."===h()){if(0===i)return;if(u-=i,c>6)return;for(o=0;h();){if(r=null,o>0){if(!("."===h()&&o<4))return;u++}if(!Qk(_A,h()))return;for(;Qk(_A,h());){if(s=Bk(h(),10),null===r)r=s;else{if(0===r)return;r=10*r+s}if(r>255)return;u++}d[c]=256*d[c]+r,2!=++o&&4!==o||c++}if(4!==o)return;break}if(":"===h()){if(u++,!h())return}else if(h())return;d[c++]=t}else{if(null!==l)return;u++,l=++c}}if(null!==l)for(n=c-l,c=7;0!==c&&n>0;)a=d[c],d[c--]=d[l+n-1],d[l+--n]=a;else if(8!==c)return;return d}(sA(e,1,-1)),!t)return cA;this.host=t}else if(this.isSpecial()){if(e=xk(e),Qk(SA,e))return cA;if(t=function(e){var t,i,o,r,s,n,a,d=rA(e,".");if(d.length&&""===d[d.length-1]&&d.length--,(t=d.length)>4)return e;for(i=[],o=0;o<t;o++){if(""===(r=d[o]))return e;if(s=10,r.length>1&&"0"===zk(r,0)&&(s=Qk(mA,r)?16:8,r=sA(r,8===s?1:2)),""===r)n=0;else{if(!Qk(10===s?vA:8===s?pA:fA,r))return e;n=Bk(r,s)}tA(i,n)}for(o=0;o<t;o++)if(n=i[o],o===t-1){if(n>=jk(256,5-t))return null}else if(n>255)return null;for(a=eA(i),o=0;o<i.length;o++)a+=i[o]*jk(256,3-o);return a}(e),null===t)return cA;this.host=t}else{if(Qk(gA,e))return cA;for(t="",i=Ok(e),o=0;o<i.length;o++)t+=AA(i[o],EA);this.host=t}},cannotHaveUsernamePasswordPort:function(){return!this.host||this.cannotBeABaseURL||"file"===this.scheme},includesCredentials:function(){return""!==this.username||""!==this.password},isSpecial:function(){return Nk(PA,this.scheme)},shortenPath:function(){var e=this.path,t=e.length;!t||"file"===this.scheme&&1===t&&NA(e[0],!0)||e.length--},serialize:function(){var e=this,t=e.scheme,i=e.username,o=e.password,r=e.host,s=e.port,n=e.path,a=e.query,d=e.fragment,c=t+":";return null!==r?(c+="//",e.includesCredentials()&&(c+=i+(o?":"+o:"")+"@"),c+=IA(r),null!==s&&(c+=":"+s)):"file"===t&&(c+="//"),c+=e.cannotBeABaseURL?n[0]:n.length?"/"+qk(n,"/"):"",null!==a&&(c+="?"+a),null!==d&&(c+="#"+d),c},setHref:function(e){var t=this.parse(e);if(t)throw new Kk(t);this.searchParams.update()},getOrigin:function(){var e=this.scheme,t=this.port;if("blob"===e)try{return new tP(e.path[0]).origin}catch(wZ){return"null"}return"file"!==e&&this.isSpecial()?e+"://"+IA(this.host)+(null!==t?":"+t:""):"null"},getProtocol:function(){return this.scheme+":"},setProtocol:function(e){this.parse(Vk(e)+":",MA)},getUsername:function(){return this.username},setUsername:function(e){var t=Ok(Vk(e));if(!this.cannotHaveUsernamePasswordPort()){this.username="";for(var i=0;i<t.length;i++)this.username+=AA(t[i],kA)}},getPassword:function(){return this.password},setPassword:function(e){var t=Ok(Vk(e));if(!this.cannotHaveUsernamePasswordPort()){this.password="";for(var i=0;i<t.length;i++)this.password+=AA(t[i],kA)}},getHost:function(){var e=this.host,t=this.port;return null===e?"":null===t?IA(e):IA(e)+":"+t},setHost:function(e){this.cannotBeABaseURL||this.parse(e,FA)},getHostname:function(){var e=this.host;return null===e?"":IA(e)},setHostname:function(e){this.cannotBeABaseURL||this.parse(e,HA)},getPort:function(){var e=this.port;return null===e?"":Vk(e)},setPort:function(e){this.cannotHaveUsernamePasswordPort()||(""===(e=Vk(e))?this.port=null:this.parse(e,YA))},getPathname:function(){var e=this.path;return this.cannotBeABaseURL?e[0]:e.length?"/"+qk(e,"/"):""},setPathname:function(e){this.cannotBeABaseURL||(this.path=[],this.parse(e,jA))},getSearch:function(){var e=this.query;return e?"?"+e:""},setSearch:function(e){""===(e=Vk(e))?this.query=null:("?"===zk(e,0)&&(e=sA(e,1)),this.query="",this.parse(e,qA)),this.searchParams.update()},getSearchParams:function(){return this.searchParams.facade},getHash:function(){var e=this.fragment;return e?"#"+e:""},setHash:function(e){""!==(e=Vk(e))?("#"===zk(e,0)&&(e=sA(e,1)),this.fragment="",this.parse(e,$A)):this.fragment=null},update:function(){this.query=this.searchParams.serialize()||null}};var tP=function(e){var t=Pk(this,iP),i=Uk(arguments.length,1)>1?arguments[1]:void 0,o=Xk(t,new eP(e,!1,i));Tk||(t.href=o.serialize(),t.origin=o.getOrigin(),t.protocol=o.getProtocol(),t.username=o.getUsername(),t.password=o.getPassword(),t.host=o.getHost(),t.hostname=o.getHostname(),t.port=o.getPort(),t.pathname=o.getPathname(),t.search=o.getSearch(),t.searchParams=o.getSearchParams(),t.hash=o.getHash())},iP=tP.prototype,oP=function(e,t){return{get:function(){return Gk(this)[e]()},set:t&&function(e){return Gk(this)[t](e)},configurable:!0,enumerable:!0}};if(Tk&&(Ak(iP,"href",oP("serialize","setHref")),Ak(iP,"origin",oP("getOrigin")),Ak(iP,"protocol",oP("getProtocol","setProtocol")),Ak(iP,"username",oP("getUsername","setUsername")),Ak(iP,"password",oP("getPassword","setPassword")),Ak(iP,"host",oP("getHost","setHost")),Ak(iP,"hostname",oP("getHostname","setHostname")),Ak(iP,"port",oP("getPort","setPort")),Ak(iP,"pathname",oP("getPathname","setPathname")),Ak(iP,"search",oP("getSearch","setSearch")),Ak(iP,"searchParams",oP("getSearchParams")),Ak(iP,"hash",oP("getHash","setHash"))),kk(iP,"toJSON",(function(){return Gk(this).serialize()}),{enumerable:!0}),kk(iP,"toString",(function(){return Gk(this).serialize()}),{enumerable:!0}),Yk){var rP=Yk.createObjectURL,sP=Yk.revokeObjectURL;rP&&kk(tP,"createObjectURL",Rk(rP,Yk)),sP&&kk(tP,"revokeObjectURL",Rk(sP,Yk))}Dk(tP,"URL"),bk({global:!0,constructor:!0,forced:!Ik,sham:!Tk},{URL:tP});var nP=wi,aP=n,dP=iR,cP=bo,lP=DE,uP=re("URL"),hP=lP&&aP((function(){uP.canParse()})),_P=aP((function(){return 1!==uP.canParse.length}));nP({target:"URL",stat:!0,forced:!hP||_P},{canParse:function(e){var t=dP(arguments.length,1),i=cP(e),o=t<2||void 0===arguments[1]?void 0:cP(arguments[1]);try{return!!new uP(i,o)}catch(wZ){return!1}}});var mP=wi,pP=iR,vP=bo,fP=DE,SP=re("URL");mP({target:"URL",stat:!0,forced:!fP},{parse:function(e){var t=pP(arguments.length,1),i=vP(e),o=t<2||void 0===arguments[1]?void 0:vP(arguments[1]);try{return new SP(i,o)}catch(wZ){return null}}});var gP=i($.URL);function yP(e){const t=PressureObserver.supportedSources;let i="thermal";i=null!=t&&t.includes("thermal")?"thermal":"cpu";const o=new PressureObserver((t=>{t.forEach((t=>{t.source===i&&e(t.state)}))}));return o.observe(i,{sampleInterval:2e3}),o}var bP=new class{constructor(){Xu(this,"_state",void 0),Xu(this,"_handler",!1)}init(){if(uE&&!Qg("DISABLE_COMPUTE_PRESSURE")&&"UT"!=={}.VITE_TEST)try{if(hE()){const e=new Blob(["(".concat(yP.toString(),")(self.postMessage)")],{type:"text/javascript"}),t=new Worker(gP.createObjectURL(e));t.onmessage=e=>{this._state=e.data},this._handler=t}else this._handler=yP((e=>{this._state=e}))}catch(e){}}get state(){return hb&&!rm()&&(window.thermal_status=this._state),this._handler||this.init(),this._state}};const TP=["codec","inbound-rtp","outbound-rtp","remote-inbound-rtp","remote-outbound-rtp","media-source","csrc","peer-connection","data-channel","stream","track","transceiver","sender","receiver","transport","sctp-transport","candidate-pair","local-candidate","remote-candidate","certificate","ice-server"],IP=new Map;let EP=!0;const RP=async e=>new Promise((t=>{const i={all:[],getTrackStats:()=>[]},o=Qg("STATS_SCALLBACK_SUPPORT");if(EP&&WS&&void 0===window.InstallTrigger&&aE&&o)try{var r,s,n;null===(r=e.getStats((e=>{const i=[];e.result().forEach((e=>{if(TP.includes(e.type))return;const t={};e.names().forEach((function(i){t[i]=e.stat(i)})),i.push(Fu(Fu({},t),{},{id:e.id,type:e.type,timestamp:e.timestamp}))})),t({all:i,getTrackStats:e=>i.filter((t=>"ssrc"!==t.type||t.googTrackId===e))})})))||void 0===r||null===(s=r.then)||void 0===s||null===(s=s.call(r,(()=>{t(i)})))||void 0===s||null===(n=s.catch)||void 0===n||n.call(s,(()=>{EP=!1,t(i)}))}catch(a){EP=!1,t(i)}else t(i)})),CP=async e=>{var t;const i=await e.getStats(),o={all:[]},r=new Map;i.forEach((e=>{const t=r.get(e.type)||new Map;t.set(e.id,e),r.set(e.type,t),o.all.push(e)}));const s=(e,t)=>{e.forEach((e=>{var i,o,s,n;let a,d,{codecId:c,transportId:l,trackId:u,playoutId:h}=e;if(null===(i=r.get("codec"))||void 0===i||i.forEach((e=>{e.id===c&&t.add(e)})),null===(o=r.get("transport"))||void 0===o||o.forEach((e=>{e.id===l&&(a=e,t.add(e))})),null===(s=r.get("track"))||void 0===s||s.forEach((e=>{e.id===u&&t.add(e)})),null===(n=r.get("media-playout"))||void 0===n||n.forEach((e=>{e.id===h&&t.add(e)})),a){var _,m;const{localCertificateId:e,remoteCertificateId:i,selectedCandidatePairId:o}=a;null===(_=r.get("certificate"))||void 0===_||_.forEach((o=>{(o.id===e||o.id===i)&&t.add(o)})),null===(m=r.get("candidate-pair"))||void 0===m||m.forEach((e=>{e.id===o&&(d=e,t.add(e))}))}if(d){var p,v;const{localCandidateId:e,remoteCandidateId:i}=d;null===(p=r.get("local-candidate"))||void 0===p||p.forEach((i=>{i.id===e&&t.add(i)})),null===(v=r.get("remote-candidate"))||void 0===v||v.forEach((e=>{e.id===i&&t.add(e)}))}}))};var n;if(r.get("media-source"))null===(n=r.get("media-source"))||void 0===n||n.forEach((e=>{var t;const i=new Set;i.add(e);const n=[];null===(t=r.get("outbound-rtp"))||void 0===t||t.forEach((t=>{var o;t.mediaSourceId===e.id&&(i.add(t),n.push(t),null===(o=r.get("remote-inbound-rtp"))||void 0===o||o.forEach((e=>{e.localId===t.id&&i.add(e)})))})),s(n,i),o[e.trackIdentifier]=Array.from(i)}));else if(r.get("track")){var a;null===(a=r.get("track"))||void 0===a||a.forEach((e=>{var t;const i=new Set;i.add(e);const n=[];null===(t=r.get("outbound-rtp"))||void 0===t||t.forEach((t=>{var o;t.trackId===e.id&&(i.add(t),n.push(t),null===(o=r.get("remote-inbound-rtp"))||void 0===o||o.forEach((e=>{e.localId===t.id&&i.add(e)})))})),s(n,i),o[e.trackIdentifier]=Array.from(i)}))}return null===(t=r.get("inbound-rtp"))||void 0===t||t.forEach((e=>{var t;const i=new Set;i.add(e),null===(t=r.get("remote-outbound-rtp"))||void 0===t||t.forEach((t=>{t.localId===e.id&&i.add(t)})),s([e],i);let{trackIdentifier:n}=e;var a;n||(null===(a=r.get("track"))||void 0===a||a.forEach((t=>{t.id===e.trackId&&(n=t.trackIdentifier)})));o[n]=Array.from(i)})),o};class kP extends kI{constructor(){super(...arguments),Xu(this,"_continuousVideoEncodeFailure",0),Xu(this,"_remoteStreamDecodeStatus",new Map)}setLocalVideoStats(e,t){this.checkVideoEncodeFailure(e,t)}setRemoteVideoStats(e,t){this.checkVideoDecodeFailure(e,t)}destroy(){this._continuousVideoEncodeFailure=0,this._remoteStreamDecodeStatus=new Map}checkVideoEncodeFailure(e,t){const i=e.frame_rate_input;window.__createEncodeError__&&(e.frame_rate_sent=0,e.frame_rate_encoded=0);const o=e.frame_rate_sent,r=e.frame_rate_encoded;var s;void 0!==i&&i>0&&void 0!==r&&0===r&&void 0!==o&&0===o?(this._continuousVideoEncodeFailure++,this._continuousVideoEncodeFailure>5&&(this.emit("rtc-encode-error",{codec:null==e?void 0:e.codecName,media_type:"video",track_frame_size_width:null==t?void 0:t.getSettings().width,track_frame_size_height:null==t?void 0:t.getSettings().height,track_frame_rate:null==t?void 0:t.getSettings().frameRate,stats_frame_size_width:null==e?void 0:e.frame_size_width,stats_frame_size_height:null==e?void 0:e.frame_size_height,stats_frame_rate_input:null==e?void 0:e.frame_rate_input,stats_frame_rate_sent:null==e?void 0:e.frame_rate_sent,stats_frame_rate_encoded:null==e?void 0:e.frame_rate_encoded,stats_frame_encoder_name:e.encoder_implementation,stats_is_hardware_encoder_enabled:jg.H264_HW_ENCODER,stats_gpu_url:jg.GPU_URL||(null===(s=fb())||void 0===s?void 0:s.renderer),is_screen:null==e?void 0:e.is_screen}),this._continuousVideoEncodeFailure=0)):this._continuousVideoEncodeFailure=0}checkVideoDecodeFailure(e,t){const i=e.stream_id;if(this._remoteStreamDecodeStatus.has(i)){const r=this._remoteStreamDecodeStatus.get(i),s=0===e.frame_rate_decoded&&e.packetsReceived>r.packets_received&&e.framesDecoded<10;var o;if(r.packets_received=e.packetsReceived,r.frames_decoded=e.framesDecoded,r.frame_rate_decoded=e.frame_rate_decoded,r.continuous_video_decode_failure=s?r.continuous_video_decode_failure+1:0,r.continuous_video_decode_failure>5)this.emit("rtc-decode-error",{codec:e.codecName,media_type:"video",track_frame_size_width:t.getSettings().width,track_frame_size_height:t.getSettings().height,track_frame_rate:t.getSettings().frameRate,stats_frame_size_width:e.frame_size_width,stats_frame_size_height:e.frame_size_height,stats_frame_rate_decode:e.frame_rate_decoded,stats_frame_rate_receive:e.frame_rate_received,stats_frame_decoder_name:e.decoder_name,stats_gpu_url:jg.GPU_URL||(null===(o=fb())||void 0===o?void 0:o.renderer),is_screen:e.is_screen}),r.continuous_video_decode_failure=0}else this._remoteStreamDecodeStatus.set(i,{packets_received:e.packetsReceived,frames_decoded:e.framesDecoded,frame_rate_decoded:e.frame_rate_decoded,continuous_video_decode_failure:0})}}class AP extends kI{constructor(e){super(),Xu(this,"_timer",void 0),Xu(this,"_reportTimer",void 0),Xu(this,"handler",void 0),Xu(this,"_monitor",void 0),Xu(this,"logger",void 0),Xu(this,"_destroyed",!1),Xu(this,"_isReportStarted",!1),this._context=e,this._monitor=uS(e.id),this.logger=new LS("Stats",3,e.id)}setVar(e){this.handler=e}stopReport(e){this._isReportStarted&&(this.logger.info("stopReport","invoke"),this._isReportStarted=!1,clearTimeout(this._reportTimer),delete this._reportTimer,fS(this._context.id,"del_media_statistics_timer","reason: ".concat(e,", stack: ").concat((new Error).stack),0,this._stream.streamId||""))}filterIllegal(e){const t={};return Object.keys(e).forEach((i=>{null===e[i]||void 0===e[i]||Number.isNaN(e[i])||(t[i]=e[i])})),t}destroy(){this.logger.info("destroy","invoke"),fS(this._context.id,"media_statistics_destroy","".concat((new Error).stack),0,"".concat(this._stream.streamId)),this.stopReport("destroy"),clearTimeout(this._timer),this._destroyed=!0}}class PP extends AP{constructor(e,t){super(e),Xu(this,"_stats",{audioStats:{},videoStats:{}}),Xu(this,"_preReports",{audio:{},video:{}}),Xu(this,"statsMonitor",void 0),this._stream=t,this.statsMonitor=new kP,this.statsMonitor.on("stats-exception",(e=>{this.emit("stats-exception",e)})),this.statsMonitor.on("rtc-encode-error",(e=>{var t;this.logger.info("rtc_encode_error",JSON.stringify(e)),null===(t=this._monitor)||void 0===t||t.report("rtc_encode_error",e)}));const i=async()=>{this._stats=await this._getLocalStats(this._stream,this._preReports,!1),this._destroyed||(this._timer=setTimeout(i,Qg("STATS_LOOP_INTERVAL")))};i()}setLocalStreamStatsEvtInterval(e,t){if(this._isReportStarted)return;this.logger.info("setLocalStreamStatsEvtInterval","invoke"),this._isReportStarted=!0,this.setVar(t),this._destroyed=!1;const i={audio:{},video:{}},o=async()=>{const t=await this._getLocalStats(this._stream,i,!0);e(t),this._destroyed||(this._reportTimer=setTimeout(o,2e3))};o()}getLocalStats(){return this._stats}async _getLocalStats(e,t,i){var o,r,s,n,a,d,c;const l=void 0!==(null===(o=e.audioTrack)||void 0===o?void 0:o.mixType)&&e.audioTrack.mixType!==Oh.PLAYOUT?null!==(r=null===(s=e.audioTrack)||void 0===s?void 0:s.mixedAudioTrack)&&void 0!==r?r:null===(n=e.audioTrack)||void 0===n?void 0:n.preprocessingTrack:null===(a=e.audioTrack)||void 0===a?void 0:a.preprocessingTrack,u=null===(d=e.videoTrack)||void 0===d?void 0:d.preprocessingTrack;var h;0===Object.keys(t.audio).length&&0===Object.keys(t.video).length&&(await this.getAudioStats(l,t,null===(h=e.audioTrack)||void 0===h?void 0:h.getAudioLevel(),i),await this.getVideoStats(u,t,i),await qy(150));return{audioStats:await this.getAudioStats(l,t,null===(c=e.audioTrack)||void 0===c?void 0:c.getAudioLevel(),i),videoStats:await this.getVideoStats(u,t,i),isScreen:e.isScreen}}async getAudioStats(e,t,i,o){var r,s,n;const a={},d={timestamp:Date.now()},{streamId:c,audioMid:l,isScreen:u,pubAttributes:h,pubAudio:_,audioTrack:m}=this._stream,p={media_type:"audio",is_screen:!!u,direction:"up",stream_id:c,vid:l,connection_status:navigator.onLine,track_enabled:null==e?void 0:e.enabled,capture_state:h.localaudio?"capture_state_on":"capture_state_off",mute_state:_?"mute_state_off":"mute_state_on",thermal_status:bP.state};if(m&&(p.playback_volume=m.getVolume()),!e||!this.handler)return a;const v=await(null===(r=this.handler.peer)||void 0===r?void 0:r.getStatsWithLowFrequency(e,!1,null===(s=this._stream.audioTransceiver)||void 0===s?void 0:s.sender));if(!v.length)return a;if(v.forEach((e=>{let{type:t,packetsSent:i,packetsLost:o,bytesSent:r,clockRate:s,roundTripTime:n,channels:c,audioLevel:l,mimeType:u,availableIncomingBitrate:h,availableOutgoingBitrate:_,bytesReceived:m,nominated:v,id:f,currentRoundTripTime:S,state:g,writable:y,requestsReceived:b,responsesReceived:T,requestsSent:I,consentRequestsSent:E,responsesSent:R,jitter:C,candidateType:k,ip:A,address:P,networkType:N,port:w,protocol:O,nackCount:M,retransmittedBytesSent:L,retransmittedPacketsSent:x,audioInputLevel:V,ssrc:D,totalAudioEnergy:U,totalSamplesDuration:Z,mediaType:W,fractionLost:X}=e;"outbound-rtp"===t?(d.packetsSent=i,d.bytesSent=r,p.bytes=r,p.packetsSent=i,p.nackCount=M,p.ssrc=D,p.retransmitted_bytes_sent=L,p.retransmitted_packets_sent=x,d.retransmittedBytesSent=L,d.retransmittedPacketsSent=x):"remote-inbound-rtp"===t?(d.packetsLost=o,p.packetsLost=o,p.net_jitter=1e3*C,a.rtt=1e3*n,p.rtt=a.rtt,a._fractionLost=X||0):"codec"===t?(a.recordSampleRate=s,a.numChannels=c,p.codecName=u):"media-source"===t&&void 0!==l?(p.audio_level=l?-10*Math.log10(Math.pow(l,2)):l,p.volume=255*l,p.total_audio_energy=U,p.totalInputDuration=Z,p.send_level||(p.send_level=l)):"ssrc"===t&&"audio"===W?V&&(p.send_level=V):"candidate-pair"===t?(p.ice_available_incoming_bitrate=h,p.ice_available_outgoing_bitrate=_,p.ice_bytes_received=m,p.ice_bytes_sent=r,p.ice_nominated=Number(v),p.ice_pair_id=f,p.ice_pair_rtt=S,p.ice_pair_state=g,p.ice_pair_writable=y,p.recv_ping_requests=b,p.recv_ping_responses=T,p.sent_ping_requests_before_first_response=I,p.sent_ping_requests_total=I+(E||0),p.sent_ping_responses=R):"local-candidate"===t?(p.local_candidate_type=k,p.local_ip=A||P,p.local_network_type=N,p.local_port=w,p.protocol=O):"remote-candidate"===t&&(p.remote_candidate_type=k,p.remote_ip=A||P,p.remote_port=w)})),p.send_level)p.send_level<1?p._sendVolumeLevel=32767*p.send_level:p._sendVolumeLevel=p.send_level;else{const e=(null==m?void 0:m.getAudioLevel())||0;p._sendVolumeLevel=Math.round(e/255*32767)}void 0===p.volume&&void 0!==i&&(p.volume=i,p.audio_level=i?-10*Math.log10(Math.pow(i/255,2)):i);const{audio:f}=t;if(!f.timestamp)return t.audio=d,this.filterIllegal(a);var S;(void 0!==d.packetsLost&&(a.audioLossRate=Math.max(0,d.packetsLost-f.packetsLost)/(d.packetsSent-f.packetsSent),a.audioLossRate=Number.isNaN(a.audioLossRate)?0:a.audioLossRate,p.fraction_lost=a.audioLossRate),a.statsInterval=d.timestamp-f.timestamp,p.stats_interval=a.statsInterval,a.sendKBitrate=(d.bytesSent-f.bytesSent||0)/a.statsInterval*8,p.mediaBitratebps=Math.round(1e3*a.sendKBitrate),p.bandwidth=Math.round(p.mediaBitratebps/1024),void 0!==d.retransmittedBytesSent&&(p.retransmitBitratebps=(d.retransmittedBytesSent-f.retransmittedBytesSent||0)/a.statsInterval),t.audio=d,p.vendor_mode=this._stream.vendorCode||0,p.pc_session_id=null===(n=this.handler)||void 0===n?void 0:n.peerConnectionId,o)&&(null===(S=this._monitor)||void 0===S||S.report("rtc_media_statistics",p));return a._retransmittedRate=(d.retransmittedPacketsSent-f.retransmittedPacketsSent)/(d.packetsSent-f.packetsSent),void 0===a.audioLossRate&&(a.audioLossRate=a._retransmittedRate,p.fraction_lost=a.audioLossRate),a._fractionLost=Math.max(a._fractionLost,a.audioLossRate),a._sendVolumeLevel=p._sendVolumeLevel,this.filterIllegal(a)}async getVideoStats(e,t,i){var o,r,s;const n={},a={timestamp:Date.now(),simulcast:{}},{streamId:d,videoMid:c,isScreen:l,pubAttributes:u,enableSimulcast:h,pubVideo:_}=this._stream,m={media_type:"video",is_screen:!!l,direction:"up",stream_id:d,vid:c,connection_status:navigator.onLine,track_enabled:null==e?void 0:e.enabled,capture_state:u.localvideo?"capture_state_on":"capture_state_off",mute_state:_?"mute_state_off":"mute_state_on",thermal_status:bP.state};if(!e||!this.handler)return n;m.cap_frame_width=e.getSettings().width,m.cap_frame_height=e.getSettings().height,m.frameRateSent=e.getSettings().frameRate,n.isScreen=l,m.is_intersecting=JSON.stringify(null===(o=this._stream)||void 0===o||null===(o=o.videoTrack)||void 0===o?void 0:o.intersection());const p=await(null===(r=this.handler.peer)||void 0===r?void 0:r.getStatsWithLowFrequency(e,!1,null===(s=this._stream.videoTransceiver)||void 0===s?void 0:s.sender));if(!p.length)return n;let v=0;p.forEach((e=>{const{type:i,framesEncoded:o,packetsLost:r,bytesSent:s,framesSent:d,retransmittedBytesSent:c,totalPacketSendDelay:l,totalEncodeTime:u,firCount:_,targetBitrate:p,roundTripTime:f,mimeType:S,frameWidth:g,frameHeight:y,packetsSent:b,googActualEncBitrate:T,googAvailableReceiveBandwidth:I,googAvailableSendBandwidth:E,googAvgEncodeMs:R,googBucketDelay:C,googEncodeUsagePercent:k,googFrameRateInput:A,availableIncomingBitrate:P,availableOutgoingBitrate:N,bytesReceived:w,nominated:O,id:M,currentRoundTripTime:L,state:x,writable:V,candidateType:D,ip:U,address:Z,networkType:W,port:X,nackCount:G,pliCount:F,protocol:H,qpSum:Y,requestsReceived:K,responsesReceived:B,googRetransmitBitrate:J,requestsSent:j,consentRequestsSent:z,responsesSent:Q,ssrc:q,googTargetEncBitrate:$,googTransmitBitrate:ee,retransmittedPacketsSent:te,encoderImplementation:ie,jitter:oe,rid:re,fractionLost:se,googAdaptationChanges:ne,qualityLimitationReason:ae,qualityLimitationDurations:de,googFirsReceived:ce,googFrameRateSent:le,keyFramesEncoded:ue,scalabilityMode:he,framesPerSecond:_e,frames:me}=e;"outbound-rtp"===i?(h&&(re?a.simulcast[re]=e:a.simulcast[v]=e,v++),a.framesEncoded=o||a.framesEncoded||0,m.key_frames_encoded=ue||0,a.bytesSent=s||a.bytesSent||0,a.framesSent=d||a.framesSent,m.bytes=s||m.bytes||0,a.packetsSent=b||a.packetsSent||0,m.packetsSent=b||m.packetsSent||0,m.nackCount=G||m.nackCount||0,m.pli_count=F||m.pli_count||0,m.qp_sum=Y||m.qp_sum||0,m.ssrc=q||m.ssrc||0,m.retransmitted_packets_sent=te,a.retransmittedPacketsSent=te,a.retransmittedBytesSent=c,m.encoder_implementation=ie,m.qualityLimitationReason=ae,m.qualityLimitationDurations=de,m.scalabilityMode=he,void 0!==g&&((!n.encodedFrameWidth||g>n.encodedFrameWidth)&&(n.encodedFrameWidth=g),(!n.encodedFrameHeight||y>n.encodedFrameHeight)&&(n.encodedFrameHeight=y),m.frame_size_height=y,m.frame_size_width=g)):"track"===i?(n.encodedFrameWidth=g,n.encodedFrameHeight=y,m.frame_size_height=y,m.frame_size_width=g):"remote-inbound-rtp"===i?(a.packetsLost=r,n.rtt=1e3*f,m.rtt=n.rtt,m.jitter=1e3*oe,m.packetsLost=r,n._fractionLost=se||0):"codec"===i?(n.codecType=S,m.codecName=S):"candidate-pair"===i?(m.ice_available_incoming_bitrate=P,m.ice_available_outgoing_bitrate=N,m.ice_bytes_received=w,m.ice_bytes_sent=s,m.ice_nominated=Number(O),m.ice_pair_id=M,m.ice_pair_rtt=L,m.ice_pair_state=x,m.ice_pair_writable=V,m.recv_ping_requests=K,m.recv_ping_responses=B,m.sent_ping_requests_before_first_response=j,m.sent_ping_requests_total=j+z,m.sent_ping_responses=Q):"local-candidate"===i?(m.local_candidate_type=D,m.local_ip=U||Z,m.local_network_type=W,m.local_port=X,m.protocol=H):"remote-candidate"===i?(m.remote_candidate_type=D,m.remote_ip=U||Z,m.remote_port=X):"VideoBwe"===i?(m.encBitratebps=T,m.available_receive_bandwidth=I,m.available_send_bandwidth=E,m.bucket_delay=C,m.retransmitBitratebps=J,m.targetEncBitratebps=$,m.transmit_bitrate=ee,n._sendBandWidth=Number(E)):"ssrc"===i&&(m.avg_encode_ms=R,m.encodeUsage=k,m.frame_rate_input=A,m.orignal_input_Framerate=Number(A),m.ddaptationChanges=ne,m.firsReceived=ce,m.frameRateSent=le);const pe=Qg("STATS_SCALLBACK_SUPPORT");if(!aE||!pe){const{video:e}=t,r=a.timestamp-e.timestamp;if("outbound-rtp"===i){const t=s-e.bytesSent,i=c-e.retransmittedBytesSent;m.encBitratebps=Math.round(8e3*(t-i)/r),m.bucket_delay=l/b,m.retransmitBitratebps=Math.round(8e3*i/r),m.targetEncBitratebps=p,m.transmit_bitrate=Math.round(1e3*(s-e.bytesSent)*8/r),m.avg_encode_ms=1e3*u/o,m.firsReceived=_+F}else"candidate-pair"===i?(m.available_send_bandwidth=N,n._sendBandWidth=N):"media-source"===i&&(m.frame_rate_input=_e,m.orignal_input_Framerate=Number(_e),m.frame_input=me)}}));const{video:f}=t;if(!f.timestamp)return t.video=a,this.filterIllegal(n);n.statsInterval=a.timestamp-f.timestamp,m.stats_interval=n.statsInterval;const S=Object.keys(a.simulcast);if(h){var g;m.sim_enc_width=[],m.sim_enc_height=[],m.sim_enc_bps=[],m.sim_enc_framerate=[],m.sim_enc_key_frames=[],m.sim_rids=[],m.sim_enc_bandwidth=[],m.sim_sent_framerate=[],m.sim_fraction_lost=[],m.sim_keyencoded=[],m.active_sim_streams=this._context.videoProfile.activeSimStreams||[],m.sim_retransmittedRate=[];let e=!1;var y;if(TI(S).call(S,((e,t)=>Number(e)-Number(t))).forEach((t=>{const{frameWidth:i,frameHeight:o,bytesSent:r,framesEncoded:s,framesSent:d,packetsLost:c,packetsSent:l,qualityLimitationReason:u,qualityLimitationDurations:h,qualityLimitationResolutionChanges:_,retransmittedPacketsSent:p,pliCount:v,keyFramesEncoded:S}=a.simulcast[t];void 0!==u&&(m.sim_qualityLimitationReason||(m.sim_qualityLimitationReason=[],m.sim_qualityLimitationDurations=[],m.sim_qualityLimitationResolutionChanges=[]),m.sim_qualityLimitationReason.push(u),m.sim_qualityLimitationDurations.push(h),m.sim_qualityLimitationResolutionChanges.push(_));const g=f.simulcast[t];if(m.sim_enc_width.push(i||0),m.sim_enc_height.push(o||0),m.sim_enc_key_frames.push(S||0),g){const o=(r-g.bytesSent||0)/n.statsInterval;m.sim_enc_bps.push(Math.round(8e3*o)),m.sim_enc_bandwidth.push(Math.round(8e3*o/1024));const a=1e3*(s-g.framesEncoded)/n.statsInterval;m.sim_enc_framerate.push(Math.round(a)),m.sim_rids.push(t);const u=void 0!==d?d-g.framesSent:s-g.framesEncoded,h=1e3*u/n.statsInterval;m.sim_sent_framerate.push(Math.round(h));let _=(c-g.packetsLost)/(l-g.packetsSent);n._retransmittedRate=(p-g.retransmittedPacketsSent)/(l-g.packetsSent),_=Number.isNaN(_)?0:_,m.sim_fraction_lost.push(_),m.sim_keyencoded.push(v-g.pliCount>0),m.sim_retransmittedRate.push(n._retransmittedRate),i>0&&!e&&(n.rid=t,n.sentKBitrate=8*o,n.encoderOutputFrameRate=a,n.encodedFrameCount=u,n.sentFrameRate=h,n.videoLossRate=_,e=!0)}})),m.vendor_mode=this._stream.vendorCode||0,m.pc_session_id=null===(g=this.handler)||void 0===g?void 0:g.peerConnectionId,i)null===(y=this._monitor)||void 0===y||y.report("rtc_media_statistics",m)}else{var b,T;if(n.encodedFrameCount=void 0!==a.framesSent?a.framesSent-f.framesSent:a.framesEncoded-f.framesEncoded,n.sentKBitrate=(a.bytesSent-f.bytesSent||0)/n.statsInterval*8,m.bitrate=Math.round(1e3*n.sentKBitrate),m.bandwidth=Math.round(m.bitrate/1024),n.encoderOutputFrameRate=1e3*(a.framesEncoded-f.framesEncoded)/n.statsInterval,m.frame_rate_encoded=Math.round(n.encoderOutputFrameRate),n.sentFrameRate=1e3*n.encodedFrameCount/n.statsInterval,m.frame_rate_sent=Math.round(n.sentFrameRate),n.videoLossRate=Math.max(0,a.packetsLost-f.packetsLost)/(a.packetsSent-f.packetsSent),n.videoLossRate=Number.isNaN(n.videoLossRate)?0:n.videoLossRate,m.fraction_lost=n.videoLossRate,n._retransmittedRate=(a.retransmittedPacketsSent-f.retransmittedPacketsSent)/(a.packetsSent-f.packetsSent),m.vendor_mode=this._stream.vendorCode||0,m.pc_session_id=null===(b=this.handler)||void 0===b?void 0:b.peerConnectionId,m.sentKBitrate=n.sentKBitrate,n.inputFrameRate=m.orignal_input_Framerate,n.encoderName=m.encoder_implementation,i)null===(T=this._monitor)||void 0===T||T.report("rtc_media_statistics",m);else this.statsMonitor.setLocalVideoStats(m,e)}return t.video=a,n._fractionLost=Math.max(n._fractionLost,n.videoLossRate),n._captureResolutionWidth=m.cap_frame_width,n._captureResolutionHeight=m.cap_frame_height,this.filterIllegal(n)}destroy(){super.destroy(),this.statsMonitor.destroy()}}class NP extends AP{constructor(e,t){super(e),Xu(this,"_stats",{audioStats:{},videoStats:{}}),Xu(this,"_preReports",{audio:{},video:{}}),Xu(this,"statsMonitor",void 0),this._stream=t,this.statsMonitor=new kP,this.statsMonitor.on("stats-exception",(e=>{this.emit("stats-exception",e)})),this.statsMonitor.on("rtc-decode-error",(e=>{var t;this.logger.info("rtc_decode_error",JSON.stringify(e)),null===(t=this._monitor)||void 0===t||t.report("rtc_decode_error",e)}));const i=async()=>{this._stats=await this._getRemoteStreamStats(this._stream,this._preReports,!1),this._destroyed||(this._timer=setTimeout(i,Qg("STATS_LOOP_INTERVAL")))};i()}async setRemoteStreamStatsEvtInterval(e,t){if(this._isReportStarted)return;this.logger.info("setRemoteStreamStatsEvtInterval","invoke"),this._isReportStarted=!0,this.setVar(t),this._destroyed=!1;const i={audio:{},video:{}},o=async()=>{const t=await this._getRemoteStreamStats(this._stream,i,!0);e(t),this._destroyed||(this._reportTimer=setTimeout(o,2e3))};o()}getRemoteStreamStats(){return this._stats}async _getRemoteStreamStats(e,t,i){var o,r,s;const n=null===(o=e.videoTrack)||void 0===o?void 0:o.originTrack,a=null===(r=e.audioTrack)||void 0===r?void 0:r.originTrack;var d;0===Object.keys(t.audio).length&&0===Object.keys(t.video).length&&(await this.getRemoteAudioStats(a,t,null===(d=this._stream.audioTrack)||void 0===d?void 0:d.getAudioLevel(),i),await this.getRemoteVideoStats(n,t,i),await qy(150));return{audioStats:await this.getRemoteAudioStats(a,t,null===(s=this._stream.audioTrack)||void 0===s?void 0:s.getAudioLevel(),i),videoStats:await this.getRemoteVideoStats(n,t,i),isScreen:e.isScreen,userId:e.userId,streamId:e.streamId}}unsubscribe(){this.logger.info("unsubscribe","invoke"),super.stopReport("unsubscribe"),this._stream.stopAudioStallObserve()}async getRemoteAudioStats(e,t,i,o){var r,s,n,a;const d={},c={},{streamId:l,userId:u,isScreen:h,audioMid:_,subMediaType:m,_attributes:p,virtual:v,audioTrack:f}=this._stream,S={media_type:"audio",is_screen:!!h,direction:"down",stream_id:l,stream_user_id:u,vid:_,audio_mux:v,connection_status:navigator.onLine,track_enabled:null==e?void 0:e.enabled,mute_state:rb(m)?"mute_state_off":"mute_state_on",remote_user_capture_state:p.localaudio?"capture_state_on":"capture_state_off",remote_user_mute_state:p.localaudio&&p.audiostream?"mute_state_off":"mute_state_on",thermal_status:bP.state};if(f&&(S.playback_volume=f.getVolume()),!e||!this.handler)return d;const g=await(null===(r=this.handler.peer)||void 0===r?void 0:r.getStatsWithLowFrequency(e,!1,null===(s=this._stream.audioTransceiver)||void 0===s?void 0:s.receiver));if(!g.length)return d;g.forEach((e=>{let{type:t,packetsLost:o,packetsReceived:r,bytesReceived:s,jitterBufferDelay:n,jitterBufferEmittedCount:a,clockRate:u,channels:h,totalSamplesReceived:_,concealedSamples:m,silentConcealedSamples:p,concealmentEvents:v,totalRoundTripTime:f,packetsDiscarded:g,state:y,currentRoundTripTime:b,audioLevel:T,totalAudioEnergy:I,totalSamplesDuration:E,mimeType:R,googDecodingNormal:C,googDecodingMuted:k,availableIncomingBitrate:A,availableOutgoingBitrate:P,bytesSent:N,nominated:w,id:O,writable:M,jitter:L,candidateType:x,ip:V,address:D,networkType:U,port:Z,protocol:W,audioOutputLevel:X,requestsReceived:G,responsesReceived:F,requestsSent:H,consentRequestsSent:Y,responsesSent:K,ssrc:B,nackCount:J,lastPacketReceivedTimestamp:j,concealmentevents:z,fecPacketsReceived:Q}=e;if("inbound-rtp"===t)c.packetsLost=o,c.packetsReceived=r,S.packetsLost=o,S.packetsReceived=r,S.packetsDiscarded=g,S.nackCount=J,S.lastPacketReceivedTimestamp=j,S.concealmentevents=z,c.bytesReceived=s,void 0!==n&&(d.jitterBufferDelay=n/a*1e3,S.average_jitter_buffer_delay_ms=d.jitterBufferDelay),void 0!==_&&(c.totalSamplesReceived=_,d.concealedSamples=m,c.concealedSamples=m,c.silentConcealedSamples=p,S.concealedSamples=m,d.concealmentEvents=v,S.totalSamplesReceived=_),void 0!==Q&&(S.fec_packets_received=Q,c.fecPacketsReceived=Q),S.jitter=1e3*L,S.ssrc=B,void 0!==T&&0!==T?(S.audio_level=T?-10*Math.log10(Math.pow(T,2)):T,S.volume=255*T):(S.volume=null!=i?i:255*T,S.audio_level=i?-10*Math.log10(Math.pow(i/255,2)):i),void 0!==I&&(S.total_audio_energy=I),void 0!==E&&(S.totalAudioDuration=E);else if("codec"===t)d.recordSampleRate=u,h&&(d.numChannels=h),S.codecName=R,d.codecType=R;else if("candidate-pair"===t){var q;S.ice_available_incoming_bitrate=A,S.ice_available_outgoing_bitrate=P,S.ice_bytes_received=s,S.ice_bytes_sent=N,S.ice_nominated=Number(w),S.ice_pair_id=O,S.ice_pair_rtt=b,S.rtt=1e3*b,S.rtt&&null!==(q=this._context.streamRTT)&&void 0!==q&&null!==(q=q[l])&&void 0!==q&&q.audio&&(S.total_rtt_ms=Math.round(S.rtt+this._context.streamRTT[l].audio)),S.ice_pair_state=y,S.ice_pair_writable=M,S.recv_ping_requests=G,S.recv_ping_responses=F,S.sent_ping_requests_before_first_response=H,S.sent_ping_requests_total=H+(Y||0),S.sent_ping_responses=K,"succeeded"===y&&(d.rtt=1e3*b,d.total_rtt=1e3*f)}else"track"===t&&void 0!==T?(0===T&&0!==i?(S.volume=i,S.audio_level=i?-10*Math.log10(Math.pow(i/255,2)):i):(S.audio_level=T?-10*Math.log10(Math.pow(T,2)):T,S.volume=255*T),S.total_audio_energy=I,S.totalAudioDuration=E):"ssrc"===t?(S.decodingNormal=C,S.recvAudioLevel=X,S.decodingMuted=k):"local-candidate"===t?(S.local_candidate_type=x,S.local_ip=V||D,S.local_network_type=U,S.local_port=Z,S.protocol=W):"remote-candidate"===t&&(S.remote_candidate_type=x,S.remote_ip=V||D,S.remote_port=Z)}));const{audio:y}=t;if(!y.timestamp)return c.timestamp=Date.now(),t.audio=c,this.filterIllegal(d);let b;var T;(void 0!==c.concealedSamples&&(S.interval_concealed_samples=c.concealedSamples-y.concealedSamples,S.interval_samples_received=c.totalSamplesReceived-y.totalSamplesReceived,S.interval_silent_concealed_samples=c.silentConcealedSamples-y.silentConcealedSamples,b=await this._stream.updateAudioStallInfo(S,d,c)),c.timestamp=Date.now(),d.audioLossRate=Math.max(0,c.packetsLost-y.packetsLost)/(c.packetsReceived-y.packetsReceived+(c.packetsLost-y.packetsLost)),d.audioLossRate=Number.isNaN(d.audioLossRate)?0:d.audioLossRate,S.fraction_lost=d.audioLossRate,d.statsInterval=c.timestamp-y.timestamp,S.stats_interval=d.statsInterval,d.receivedKBitrate=(c.bytesReceived-y.bytesReceived||0)/d.statsInterval*8,S.bandwidth=Math.round(1e3*d.receivedKBitrate/1024),void 0!==c.concealedSamples&&(d.receivedSampleRate=1e3*S.interval_samples_received/d.statsInterval),void 0!==c.fecPacketsReceived&&(S.fecBitratebps=(c.fecPacketsReceived-y.fecPacketsReceived||0)/d.statsInterval),S.average_jitter_buffer_delay_ms&&S.total_rtt_ms&&(d.e2eDelay=S.average_jitter_buffer_delay_ms+S.total_rtt_ms),null!==(n=this._context.streamRTT)&&void 0!==n&&null!==(n=n[l])&&void 0!==n&&n.audio&&(d.totalRtt=(S.rtt?S.rtt:0)+this._context.streamRTT[l].audio),t.audio=c,S.vendor_mode=this._stream.vendorCode||0,S.pc_session_id=null===(a=this.handler)||void 0===a?void 0:a.peerConnectionId,o)&&(null===(T=this._monitor)||void 0===T||T.report("rtc_media_statistics",S,b));return this.filterIllegal(d)}async getRemoteVideoStats(e,t,i){var o,r,s,n,a;const d={},c={timestamp:Date.now()},{streamId:l,userId:u,isScreen:h,subMediaType:_,_attributes:m}=this._stream,p=Fu({media_type:"video",is_screen:!!h,direction:"down",stream_id:l,stream_user_id:u,vid:this._stream.videoMid,connection_status:navigator.onLine,track_enabled:null==e?void 0:e.enabled,mute_state:sb(_)?"mute_state_off":"mute_state_on",remote_user_capture_state:m.localvideo?"capture_state_on":"capture_state_off",remote_user_mute_state:m.localvideo&&m.videostream?"mute_state_off":"mute_state_on",is_intersecting:JSON.stringify(null===(o=this._stream.videoTrack)||void 0===o?void 0:o.intersection()),thermal_status:bP.state},this._stream.getVideoRenderInfo());if(!e||!this.handler)return d;d.isScreen=h;const v=await(null===(r=this.handler.peer)||void 0===r?void 0:r.getStatsWithLowFrequency(e,!1,null===(s=this._stream.videoTransceiver)||void 0===s?void 0:s.receiver));if(!v.length)return d;v.forEach((e=>{let{type:t,frameHeight:i,frameWidth:o,packetsLost:r,packetsReceived:s,bytesReceived:n,framesDecoded:a,jitterBufferDelay:u,jitterBufferEmittedCount:h,mimeType:_,firCount:m,availableIncomingBitrate:v,availableOutgoingBitrate:f,bytesSent:S,nominated:g,id:y,currentRoundTripTime:b,state:T,writable:I,candidateType:E,ip:R,address:C,networkType:k,port:A,nackCount:P,pliCount:N,protocol:w,requestsReceived:O,responsesReceived:M,requestsSent:L,consentRequestsSent:x,responsesSent:V,ssrc:D,jitter:U,framesReceived:Z,keyFramesDecoded:W,totalDecodeTime:X,decoderImplementation:G,lastPacketReceivedTimestamp:F,framesDropped:H}=e;if("inbound-rtp"===t)c.packetsLost=r,p.packetsLost=r,c.packetsReceived=s,p.packetsReceived=s,c.bytesReceived=n,p.bytes=n,c.framesDecoded=a,c.totalDecodeTime=X,void 0!==u&&(c.jitterBufferDelay=u/h*1e3,p.average_jitter_buffer_delay_ms=c.jitterBufferDelay),p.fir_count=m,p.nackCount=P,c.nackCount=P,p.pli_count=N,p.ssrc=D,p.framesDropped=H,p.jitter=1e3*U,p.framesReceived=Z,c.framesReceived=Z,p.framesDecoded=a,p.key_frames_decoded=W,p.decoder_name=G,d.decoderName=G,p.last_packet_received_timestamp=F,void 0!==o&&(d.width=o,p.frame_size_width=o,d.height=i,p.frame_size_height=i);else if("track"===t&&void 0!==o)d.width=o,p.frame_size_width=o,d.height=i,p.frame_size_height=i,void 0!==Z&&(p.framesReceived=Z,c.framesReceived=Z);else if("codec"===t)p.codecName=_,d.codecType=_;else if("candidate-pair"===t){var Y;p.ice_available_incoming_bitrate=v,p.ice_available_outgoing_bitrate=f,p.ice_bytes_received=n,p.ice_bytes_sent=S,p.ice_nominated=Number(g),p.ice_pair_id=y,p.ice_pair_rtt=b,p.rtt=1e3*b,p.rtt&&null!==(Y=this._context.streamRTT)&&void 0!==Y&&null!==(Y=Y[l])&&void 0!==Y&&Y.video&&(p.total_rtt_ms=Math.round(p.rtt+(this._context.streamRTT[l].video||0))),d.rtt=p.rtt,p.ice_pair_state=T,p.ice_pair_writable=I,p.recv_ping_requests=O,p.recv_ping_responses=M,p.sent_ping_requests_before_first_response=L,p.sent_ping_requests_total=L+(x||0),p.sent_ping_responses=V}else"local-candidate"===t?(p.local_candidate_type=E,p.local_ip=R||C,p.local_network_type=k,p.local_port=A,p.protocol=w):"remote-candidate"===t&&(p.remote_candidate_type=E,p.remote_ip=R||C,p.remote_port=A)}));const{video:f}=t;if(!f.timestamp)return t.video=c,this.filterIllegal(d);const S=Math.max(0,c.packetsLost-f.packetsLost),g=c.packetsReceived-f.packetsReceived;if(d.videoLossRate=S/(g+S),d._receivePackets=c.packetsReceived,d._receivePacketsLost=c.packetsLost,f.totalDecodeTime&&f.framesDecoded&&c.framesDecoded!==f.framesDecoded){const e=c.totalDecodeTime-f.totalDecodeTime,t=c.framesDecoded-f.framesDecoded;p.decode_elapse_per_frame=Number((e/t*1e3).toFixed(2))}var y;(d._retransmittedRate=(c.nackCount-f.nackCount)/(g+S),d.videoLossRate=Number.isNaN(d.videoLossRate)?0:d.videoLossRate,p.fraction_lost=d.videoLossRate,d.statsInterval=c.timestamp-f.timestamp,p.stats_interval=d.statsInterval,d.receivedKBitrate=(c.bytesReceived-f.bytesReceived||0)/d.statsInterval*8,p.bitrate=Math.round(1e3*d.receivedKBitrate),p.bandwidth=Math.round(p.bitrate/1024),d.decoderOutputFrameRate=1e3*(c.framesDecoded-f.framesDecoded)/d.statsInterval,d.receivedFrameRate=1e3*(c.framesReceived-f.framesReceived)/d.statsInterval,p.frame_rate_decoded=Math.round(d.decoderOutputFrameRate),p.frame_rate_received=Math.round(d.receivedFrameRate),p.average_jitter_buffer_delay_ms&&p.total_rtt_ms&&(d.e2eDelay=p.average_jitter_buffer_delay_ms+p.total_rtt_ms),null!==(n=this._context.streamRTT)&&void 0!==n&&null!==(n=n[l])&&void 0!==n&&n.video&&(d.totalRtt=(p.rtt?p.rtt:0)+(this._context.streamRTT[l].video||0)),t.video=c,this._stream.updateVideoStallInfo(p,d,i),p.vendor_mode=this._stream.vendorCode||0,p.pc_session_id=null===(a=this.handler)||void 0===a?void 0:a.peerConnectionId,d.frameSizeWidth=p.frame_size_width,d.frameSizeHeight=p.frame_size_height,d.decoderName=p.decoder_name,i)?null===(y=this._monitor)||void 0===y||y.report("rtc_media_statistics",p):this.statsMonitor.setRemoteVideoStats(p,e);return this.filterIllegal(d)}destroy(){super.destroy(),super.stopReport("destroy"),this._stream.stopAudioStallObserve(),this.statsMonitor.destroy()}}class wP{constructor(e,t){Xu(this,"_removeHandler",void 0),Xu(this,"_remotePauseHandler",void 0),Xu(this,"_prePts",void 0),Xu(this,"_stallList",void 0),Xu(this,"_videoInWaiting",!1),Xu(this,"_videoInWaitingCallback",!1),Xu(this,"_videoInWaiting100ms",!1),Xu(this,"_isPaused",void 0),Xu(this,"_pauseStart",0),Xu(this,"_pauseDuration",0),Xu(this,"_requestVideoFrameCallbackTimer",void 0),Xu(this,"_logger",void 0),Xu(this,"_player",void 0),Xu(this,"_recentVideoInfo",void 0),Xu(this,"_stallTimeThreshold",void 0),Xu(this,"_openVideoStall100ms",jg.VIDEO_STALL_100MS);const i=e?1500:ZS||US?550:500;this._stallTimeThreshold={report:i,callback:Math.max(jg.VIDEO_STALL_DATA,i)},this._logger=new LS("VideoStallObserver",1,t)}start(e){if(this._logger.print("start","invoke"),this._player=e,Ag())e.domElement&&(this._requestVideoFrameCallbackTimer=e.domElement.requestVideoFrameCallback(this._onVideoRefresh.bind(this)),this._removeHandler=()=>{var t;this._requestVideoFrameCallbackTimer&&(null===(t=e.domElement)||void 0===t||t.cancelVideoFrameCallback(this._requestVideoFrameCallbackTimer))});else{const t=t=>this._onVideoTimeupdate(t,e);e.on("playback_event",t),this._removeHandler=()=>e.off("playback_event",t)}const t=e=>this._onVideoPause(e);e.on("playback_event",t),this._remotePauseHandler=()=>e.off("playback_event",t)}getRecentRenderInfo4Report(){const e={};return this._recentVideoInfo&&Object.keys(this._recentVideoInfo).forEach((t=>{var i;const o=t.replace(/[a-z]{1}[A-Z]{1}/g,(e=>"".concat(e[0],"_").concat(e[1].toLowerCase())));e["video_".concat(o)]=null===(i=this._recentVideoInfo)||void 0===i?void 0:i[t]})),e}stop(){var e,t;this._logger.print("stop","invoke"),delete this._player,null===(e=this._removeHandler)||void 0===e||e.call(this),delete this._removeHandler,null===(t=this._remotePauseHandler)||void 0===t||t.call(this),delete this._remotePauseHandler,delete this._stallList,delete this._prePts,delete this._recentVideoInfo,this._videoInWaiting=!1,this._videoInWaitingCallback=!1,this._videoInWaiting100ms=!1}destroy(){this.stop()}getStallInfo(e){let{interval:t,frameRateReceived:i,frameRateDecoded:o,bitrate:r}=e;const s={pts:0,report:{stallCount:0,stallDuration:0,list:[]},callback:{stallCount:0,stallDuration:0},pauseDuration:this._getPauseDuration()};if(this._stallList){(ZS||US)&&(0===r||(o||1/0)<=1||(i||1/0)<=1)||0===this._stallList.length?(s.report.stallDuration=s.callback.stallDuration=2e3,s.report.stallCount=s.callback.stallCount=this._videoInWaiting?0:1,this._openVideoStall100ms&&(s.stall100ms={count:this._videoInWaiting100ms?0:1,duration:2e3}),this._videoInWaiting=!0,this._videoInWaitingCallback=!0,this._videoInWaiting100ms=!0):this._stallList.forEach(((e,i)=>{let o=e.timeUpdateInterval;0===i&&this._videoInWaiting&&(o=Math.round(e.timeUpdateInterval%t));const r=e.timeUpdateInterval>this._stallTimeThreshold.report;r&&(s.report.list.push(e.timeUpdateInterval),s.report.stallDuration+=o,this._videoInWaiting||s.report.stallCount++),this._videoInWaiting=r,e.timeUpdateInterval>this._stallTimeThreshold.callback?(s.callback.stallDuration+=o,this._videoInWaitingCallback||s.callback.stallCount++,this._videoInWaitingCallback=!0):this._videoInWaitingCallback=!1,this._openVideoStall100ms&&(s.stall100ms||(s.stall100ms={count:0,duration:0}),e.timeUpdateInterval>100?(s.stall100ms.duration+=o,this._videoInWaiting100ms||s.stall100ms.count++,this._videoInWaiting100ms=!0):this._videoInWaiting100ms=!1),s.pts=e.playTime})),this._stallList=[]}return s}_getPauseDuration(){let e=this._pauseDuration;if(this._pauseDuration=0,this._isPaused){const t=jy(),i=t-(this._pauseStart||0);i>500&&(this._pauseStart=t,e+=i)}return e}_onVideoPause(e){if("pause"===e.eventName)this._isPaused=!0,this._pauseStart=jy();else if("play"===e.eventName&&this._isPaused){this._isPaused=!1;const e=jy()-this._pauseStart;e>500&&(this._pauseDuration+=e)}}_onVideoTimeupdate(e,t){if("timeupdate"===e.eventName){const e=t.domElement;if(!e||0===e.currentTime)return;if(void 0===this._prePts)return void(this._prePts=e.currentTime);if(this._stallList||(this._stallList=[]),e.currentTime>this._prePts){const t=e.currentTime-this._prePts;this._stallList.push({playTime:e.currentTime,timeUpdateInterval:Math.round(1e3*t)})}this._prePts=e.currentTime}}_onVideoRefresh(e,t){var i;if(this._stallList||(this._stallList=[]),this._prePts){const e=t.presentationTime-this._prePts;this._stallList.push({playTime:t.presentationTime,timeUpdateInterval:Math.round(e)})}this._recentVideoInfo=t,this._prePts=t.presentationTime,null===(i=this._player)||void 0===i||null===(i=i.domElement)||void 0===i||i.requestVideoFrameCallback(this._onVideoRefresh.bind(this))}}class OP{constructor(e){Xu(this,"_audioStallTimer",void 0),Xu(this,"_preSample",void 0),Xu(this,"_isStallInPreCallbackEnd",!1),Xu(this,"_isStallInPreReportEnd",!1),Xu(this,"_stallList",[]),this._stream=e}static setAudioStallConfig(e){OP.interval=((null==e?void 0:e.audio_stall_interval)||200)/2,OP.ratio=(null==e?void 0:e.audio_stall_ratio)||.6}start(e,t){this.stop(),jg.AUDIO_STALL&&OP.interval>0&&"number"==typeof e&&"number"==typeof t&&(this._preSample={ts:jy(),concealedSamples:e,totalSamplesReceived:t},this._startStallCountInterval())}stop(){this._stallList=[],this._audioStallTimer&&(clearTimeout(this._audioStallTimer),delete this._audioStallTimer)}destroy(){this.stop()}async getAudioStallInfo(){const e={stats_count:this._stallList.filter((e=>!!e.get_stats_cost)).length,stall_list:[...this._stallList]};try{await this._audioStallCount()}catch(r){}const t=MP(this._stallList,2,this._isStallInPreReportEnd);this._isStallInPreReportEnd=t.isStallInEnd;const i=jg.AUDIO_STALL_DATA/OP.interval,o=MP(this._stallList,i,this._isStallInPreCallbackEnd);return this._isStallInPreCallbackEnd=o.isStallInEnd,this.stop(),this._startStallCountInterval(),{report:{stall_count:t.stall_count,stall_duration:t.stall_duration,list:t.list},callback:{stall_count:o.stall_count,stall_duration:o.stall_duration,list:o.list},extra:e}}_startStallCountInterval(){const e=async()=>{clearTimeout(this._audioStallTimer),delete this._audioStallTimer,await this._audioStallCount(),this._audioStallTimer||(this._audioStallTimer=setTimeout(e,OP.interval))};this._audioStallTimer=setTimeout(e,OP.interval)}async _audioStallCount(){if(!this._preSample||jy()-this._preSample.ts<.5*OP.interval)return;const{hasAudio:e,subAudio:t,virtual:i,virtualOccupy:o,removeTrack:r,audioTrack:s}=this._stream;if(r||!s)return clearTimeout(this._audioStallTimer),void delete this._audioStallTimer;const n=e&&t;if(!n||i&&!o)this._preSample.ts=jy(),this._stallList.push({reason:n?"virtual: ".concat(i,", virtualOccupy: ").concat(o):"hasAudio: ".concat(e,", subAudio: ").concat(t)});else{const e=jy();let t,i,o=0;try{var a;const e=await(null===(a=this._stream.audioTransceiver)||void 0===a?void 0:a.receiver.getStats());null==e||e.forEach((e=>{"inbound-rtp"===e.type&&(t=e),o++}))}catch(d){i=d.message||JSON.stringify(d)}const r=jy(),s=jy(),n=s-this._preSample.ts;if(t){const{concealedSamples:i,totalSamplesReceived:o}=t,a=i-this._preSample.concealedSamples,d=o-this._preSample.totalSamplesReceived,c=a>=0&&d>=0&&a>=OP.ratio*d;this._stallList.push({concealed:a,received:d,diff:n,start:this._preSample.ts,end:s,get_stats_cost:r-e,get_stats_start:e,get_stats_end:r,is_stall:c}),this._preSample.concealedSamples=i,this._preSample.totalSamplesReceived=o,this._preSample.ts=s}else this._stallList.push({diff:n,start:this._preSample.ts,end:s,get_stats_cost:r-e,get_stats_start:e,get_stats_end:r,reason:o?i||"no inbound-rtp":"no report"})}}}Xu(OP,"interval",100),Xu(OP,"ratio",.6);const MP=(e,t,i)=>{var o;const r={stall_count:0,stall_duration:0,isStallInEnd:!1,list:[]};let s=0,n=0;for(let a=0;a<e.length;a++){const i=e[a];i.is_stall&&(s++,n+=i.diff||0);const o=a===e.length-1;if(!i.is_stall||o){let i=s>=t;const d=a+t-s-1;if(!i&&s>2){let o=0;e.slice(a+1,d+1).forEach((e=>{e.is_stall&&(o+=e.diff||0)})),i=n+o>OP.interval*t*OP.ratio,i&&(a=d,n+=o)}i&&(r.stall_count++,r.stall_duration+=n,r.list.push(n)),o&&(r.isStallInEnd=i),s=n=0}}return!0===(null===(o=e[0])||void 0===o?void 0:o.is_stall)&&i&&r.stall_count>0&&r.stall_count--,r};var LP=(e=>(e[e.CAPTURE=0]="CAPTURE",e[e.PRE_PROCESSING=1]="PRE_PROCESSING",e[e.ENCODE=2]="ENCODE",e[e.TRANSFER=3]="TRANSFER",e[e.POST_PROCESSING=4]="POST_PROCESSING",e[e.DECODE=5]="DECODE",e[e.RENDERING=6]="RENDERING",e))(LP||{}),xP=(e=>(e[e.STREAM_INDEX_MAIN=0]="STREAM_INDEX_MAIN",e[e.STREAM_INDEX_SCREEN=1]="STREAM_INDEX_SCREEN",e))(xP||{});class VP{constructor(e){Xu(this,"_plugins",new Map),this.id=e}register(e){const t=this._plugins.get(e.type)||[];if(t.findIndex((t=>t.name===e.name))>-1)throw new Error("Failed to register ".concat(e.name,": name is repeated."));t.push(e),this._plugins.set(e.type,t)}getPluginsByType(e){return this._plugins.get(e)||[]}getPluginByName(e,t){return(this._plugins.get(e)||[]).find((e=>e.name===t))}async getPreProcessingTrack(e){const t=this._plugins.get(1)||[];let i=e.mediaTrack;for(const o of t)i=await o.effect(e,i);return i}destroy(){this._plugins.forEach((e=>{e.forEach((e=>e.destroy()))})),this._plugins.clear()}}const DP=new LS("InternalEventBus",1);var UP=(e=>(e.ON_IOS_INTERRUPTION_START="ON_IOS_INTERRUPTION_START",e.ON_IOS_INTERRUPTION_END="ON_IOS_INTERRUPTION_END",e.ON_IOS_LOCAL_TRACK_MUTE="ON_IOS_LOCAL_TRACK_MUTE",e.ON_IOS_LOCAL_TRACK_UNMUTE="ON_IOS_LOCAL_TRACK_UNMUTE",e))(UP||{});class ZP extends EI.EventEmitter{emit(e){DP.info(e);for(var t=arguments.length,i=new Array(t>1?t-1:0),o=1;o<t;o++)i[o-1]=arguments[o];return super.emit(e,...i)}}const WP=new ZP;var XP="data:application/javascript;base64,Y2xhc3MgRHVtcEF1ZGlvRGF0YSBleHRlbmRzIEF1ZGlvV29ya2xldFByb2Nlc3NvciB7CiAgcHJvY2VzcyhpbnB1dHMpIHsKICAgIHRoaXMucG9ydC5wb3N0TWVzc2FnZSh7CiAgICAgIGRhdGE6IGlucHV0c1swXSwKICAgICAgY2hhbm5lbENvdW50OiBpbnB1dHNbMF0ubGVuZ3RoLAogICAgICBzYW1wbGVSYXRlLAogICAgfSk7CiAgICByZXR1cm4gdHJ1ZTsKICB9Cn0KCnJlZ2lzdGVyUHJvY2Vzc29yKCdkdW1wLWF1ZGlvLWRhdGEnLCBEdW1wQXVkaW9EYXRhKTsK";const GP=new LS("AudioContext",1);class FP{constructor(e){Xu(this,"_ctx",void 0),Xu(this,"_analyserNode",void 0),Xu(this,"_audioSource",void 0),Xu(this,"currentTrackId",void 0),this.currentTrackId=e.id;const t=YP.getAudioContextInstance();if(e instanceof MediaStreamTrack){const i=new MediaStream;i.addTrack(e),this._audioSource=t.createMediaStreamSource(i)}else this._audioSource=t.createMediaElementSource(e),this._audioSource.connect(t.destination);const i=t.createAnalyser();this._audioSource.connect(i),this._analyserNode=i,this._ctx=t}getAudioLevel(){var e;"suspended"===(null===(e=this._ctx)||void 0===e?void 0:e.state)&&this._ctx.resume();const t=new Uint8Array(2048);this._analyserNode.getByteTimeDomainData(t);let i=0;t.forEach((e=>i=Math.max(i,Math.abs(e-128))));const o=i/128*255;return o>2?o:0}async resume(){var e;await(null===(e=this._ctx)||void 0===e?void 0:e.resume())}destroy(){this._audioSource.disconnect(),this._analyserNode.disconnect()}}class HP extends EI.EventEmitter{constructor(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:YP.getAudioContextInstance(),o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:YP.isWorkletReady;var r;(super(),Xu(this,"_ctx",void 0),Xu(this,"_worklet",void 0),Xu(this,"_source",void 0),Xu(this,"_buffers",[]),Xu(this,"_bufferLength",0),Xu(this,"_sampleRate",void 0),Xu(this,"_channelCount",void 0),Xu(this,"_frameSize",void 0),e instanceof MediaStreamTrack)?this._channelCount=null!==(r=e.getSettings().channelCount)&&void 0!==r?r:1:this._channelCount=e.channelCount;this._ctx=i,this._frameSize=t,null==o||o.then((()=>{this._worklet=new AudioWorkletNode(this._ctx,"dump-audio-data"),e instanceof MediaStreamTrack?this._source=this._ctx.createMediaStreamSource(new MediaStream([e])):this._source=e,this._source.connect(this._worklet),this._initWorkletEventListener(this._worklet)})).catch()}_initWorkletEventListener(e){e.port.onmessage=this._handleWorkletMessage.bind(this)}_handleWorkletMessage(e){const{data:t,sampleRate:i}=e.data;if(this._bufferLength>=this._frameSize||this._sampleRate!==i){if(this._sampleRate){const e=1===this._channelCount||1===t.length?1:2;this.emit("data",{channels:[...this._buffers],sampleRate:this._sampleRate,channelCount:e})}this._sampleRate=i,this._buffers=new Array(this._channelCount).fill(0).map((()=>new Float32Array(this._frameSize))),this._bufferLength=0}for(let o=0;o<this._channelCount;o++)this._buffers[o].set(t[o],this._bufferLength);this._bufferLength=this._bufferLength+t[0].length}setFrameSize(e){this._frameSize=e}destroy(){var e,t,i;this.removeAllListeners("data"),this._worklet&&(null===(e=this._source)||void 0===e||e.disconnect(this._worklet)),null===(t=this._worklet)||void 0===t||t.disconnect(),null===(i=this._worklet)||void 0===i||i.port.close(),this._buffers=[],delete this._source,delete this._worklet}}const YP=new class{constructor(){Xu(this,"isWorkletReady",void 0),Xu(this,"_audioContextInstance",void 0),Xu(this,"_previousState",""),Xu(this,"_currentState",""),Xu(this,"_contextStuckAt",0);let e=0;xS()||setInterval((()=>{if(this._audioContextInstance){const t=this._audioContextInstance.currentTime;this._contextStuckAt?this._contextStuckAt!==t&&(this._contextStuckAt=0,GP.info("currentTime resume"),cS("currentTime resume","")):t&&e===t&&(this._contextStuckAt=t,GP.warn("currentTime stuck",this._contextStuckAt),this._audioContextInstance.suspend(),this._audioContextInstance.resume(),cS("AudioContext currentTime stuck",this._contextStuckAt)),e=t}}),3e3)}getAudioContextInstance(){if(!this._audioContextInstance){const t=window.AudioContext||window.webkitAudioContext;this._audioContextInstance=_E?new t:new t({sampleRate:44100});try{this.isWorkletReady=this._audioContextInstance.audioWorklet.addModule(XP),this.isWorkletReady.catch((e=>{dS("initial AudioWorklet error in promise",-1,"".concat(e.name,"-").concat(e.message)),GP.error("isWorkletReady",e),this.isWorkletReady=null}))}catch(e){dS("initial AudioWorklet error in catch",-1,"".concat(e.name,"-").concat(e.message)),GP.error("isWorkletReady",e),this.isWorkletReady=null}this._audioContextInstance.onstatechange=()=>{var e,t,i;GP.warn("state change",null===(e=this._audioContextInstance)||void 0===e?void 0:e.state),this._previousState=this._currentState,this._currentState=(null===(t=this._audioContextInstance)||void 0===t?void 0:t.state)||"","interrupted"===(null===(i=this._audioContextInstance)||void 0===i?void 0:i.state)&&this._audioContextInstance.resume(),(qS||JS)&&("running"===this._previousState&&"interrupted"===this._currentState&&WP.emit(UP.ON_IOS_INTERRUPTION_START),"interrupted"===this._previousState&&"running"===this._currentState&&WP.emit(UP.ON_IOS_INTERRUPTION_END))}}return this._audioContextInstance}},KP=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const i=document.createElement(e);return t.id&&(i.id=t.id),t.classList&&t.classList.forEach((e=>{i.classList.add(e)})),t.style&&Object.assign(i.style,t.style),t.attributes&&Object.entries(t.attributes).forEach((e=>{let[t,o]=e;"muted"===t?i.muted=!0:i.setAttribute(t,o)})),i};const BP=new class extends kI{constructor(){var e;super(),Xu(this,"deviceMap",{audioinput:new Map,audiooutput:new Map,videoinput:new Map}),Xu(this,"checkDeviceChangeTimer",null),Xu(this,"isSupportedPermissionsQuery",!1),Xu(this,"isGrantedMicrophonePermission",!1),Xu(this,"isGrantedCameraPermission",!1),this.isSupportedPermissionsQuery=!xS()&&!(null===(e=navigator)||void 0===e||null===(e=e.permissions)||void 0===e||!e.query),this._handleDeviceChange=this._handleDeviceChange.bind(this),!xS()&&this.initListener().then((()=>{this.updateDeviceListInSilent()}))}async refreshDevices(){let e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"audio";if(!navigator.mediaDevices)return;if(US)try{e="audio"===t?await navigator.mediaDevices.getUserMedia({audio:!0}):await navigator.mediaDevices.getUserMedia({video:!0})}catch(o){}const i=await navigator.mediaDevices.enumerateDevices();e&&e.getTracks().forEach((e=>e.stop())),i.forEach((e=>{var t;e.deviceId&&(null===(t=this.deviceMap[e.kind])||void 0===t||t.set(e.deviceId,e))}))}async initListener(){var e,t;if(void 0!==(null===(e=navigator.mediaDevices)||void 0===e?void 0:e.ondevicechange)&&"function"==typeof(null===(t=navigator.mediaDevices)||void 0===t?void 0:t.addEventListener)?navigator.mediaDevices.addEventListener("devicechange",(()=>{this._handleDeviceChange(),setTimeout((()=>{this._handleDeviceChange()}),300)})):this.checkDeviceChangeTimer=window.setInterval((()=>{this._handleDeviceChange()}),3e3),this.isSupportedPermissionsQuery){try{const e=await navigator.permissions.query({name:"microphone"});this.isGrantedMicrophonePermission="granted"===e.state,e.addEventListener("change",(()=>{this.isGrantedMicrophonePermission="granted"===e.state}))}catch(i){}try{const e=await navigator.permissions.query({name:"camera"});this.isGrantedCameraPermission="granted"===e.state,e.addEventListener("change",(()=>{this.isGrantedCameraPermission="granted"===e.state}))}catch(o){}}}async _handleDeviceChange(){if(!navigator.mediaDevices)return;let e;US&&(e=await navigator.mediaDevices.getUserMedia({audio:!0}));let t=await navigator.mediaDevices.enumerateDevices();t=t.filter((e=>!!e.deviceId)),e&&e.getTracks().forEach((e=>e.stop()));const i=Array.from([...this.deviceMap.audioinput.values(),...this.deviceMap.videoinput.values(),...this.deviceMap.audiooutput.values()]);(QS||JS)&&!i.length&&t.length&&t.forEach((e=>{var t;null===(t=this.deviceMap[e.kind])||void 0===t||t.set(e.deviceId,e)})),t.forEach((e=>{const t=this.deviceMap[e.kind].get(e.deviceId);this.deviceMap[e.kind].set(e.deviceId,e),t||(e.kind.includes("video")?this.emit(xh.onVideoDeviceStateChanged,{mediaDeviceInfo:e,deviceState:"active"}):e.kind.includes("audio")&&this.emit(xh.onAudioDeviceStateChanged,{mediaDeviceInfo:e,deviceState:"active"}))})),i.forEach((e=>{t.find((t=>t.deviceId===e.deviceId&&t.kind===e.kind))||(this.deviceMap[e.kind].delete(e.deviceId),e.kind.includes("video")?this.emit(xh.onVideoDeviceStateChanged,{mediaDeviceInfo:e,deviceState:"inactive"}):e.kind.includes("audio")&&this.emit(xh.onAudioDeviceStateChanged,{mediaDeviceInfo:e,deviceState:"inactive"}))}))}async getUserMedia(e){const t=await navigator.mediaDevices.getUserMedia(e);return null!=e&&e.audio&&(this.isGrantedMicrophonePermission=!0),null!=e&&e.video&&(this.isGrantedCameraPermission=!0),null!=e&&e.video?this.refreshDevices("video"):this.refreshDevices("audio"),t}async checkPermissionsByDevices(){const e={audio:!1,video:!1};if(!navigator.mediaDevices)return e;const t=await navigator.mediaDevices.enumerateDevices();return e.audio=t.filter((e=>"audioinput"===e.kind&&e.label&&e.deviceId)).length>0,e.video=t.filter((e=>"videoinput"===e.kind&&e.label&&e.deviceId)).length>0,e}async getPermissions(){var e;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{audio:i,video:o}=t;const{force:r}=t;i||o||(i=!0,o=!0);const s={audio:!1,video:!1,reason:void 0};if(!r)if(this.isSupportedPermissionsQuery){if(i&&o){if(this.isGrantedMicrophonePermission&&this.isGrantedCameraPermission)return s.audio=!0,s.video=!0,s}else if(i&&this.isGrantedMicrophonePermission||o&&this.isGrantedCameraPermission)return s.audio=this.isGrantedMicrophonePermission,s.video=this.isGrantedCameraPermission,s}else{const e=await this.checkPermissionsByDevices();if(i&&o){if(e.audio&&e.video)return e}else if(i&&e.audio||o&&e.video)return e}if(null!==(e=navigator.mediaDevices)&&void 0!==e&&e.getUserMedia)try{const e=await navigator.mediaDevices.getUserMedia({audio:i,video:o});e&&(e.getTracks().forEach((e=>e.stop())),i&&(s.audio=!0,this.isGrantedMicrophonePermission=!0),o&&(s.video=!0,this.isGrantedCameraPermission=!0))}catch(d){if(s.reason=d,this.isSupportedPermissionsQuery){var n,a;if(i)s.audio="granted"===(null===(n=await navigator.permissions.query({name:"microphone"}).catch((()=>{})))||void 0===n?void 0:n.state);if(o)s.video="granted"===(null===(a=await navigator.permissions.query({name:"camera"}).catch((()=>{})))||void 0===a?void 0:a.state)}}return i?await this.refreshDevices("audio"):await this.refreshDevices("video"),s}async updateDeviceListInSilent(){this.isGrantedCameraPermission&&this.isGrantedMicrophonePermission&&this.refreshDevices("audio")}async enumerateDevices(){return await this.getPermissions(),await this.refreshDevices(),Array.from([...this.deviceMap.audioinput.values(),...this.deviceMap.videoinput.values(),...this.deviceMap.audiooutput.values()])}async enumerateAudioCaptureDevices(){return await this.getPermissions({audio:!0}),await this.refreshDevices(),Array.from(this.deviceMap.audioinput.values())}async enumerateVideoCaptureDevices(){return await this.getPermissions({video:!0}),await this.refreshDevices("video"),Array.from(this.deviceMap.videoinput.values())}async enumerateAudioPlaybackDevices(){return await this.getPermissions({audio:!0}),await this.refreshDevices("audio"),Array.from(this.deviceMap.audiooutput.values())}async getAudioPlaybackDeviceById(e){return(await this.enumerateAudioPlaybackDevices()).find((t=>t.deviceId===e))}};hb&&(window.__rtc_dd__=BP);var JP=(e=>(e[e.AUTOPLAY_FAILED=-1e3]="AUTOPLAY_FAILED",e[e.TRACK_ERROR=-1001]="TRACK_ERROR",e[e.Fetch_MODIFY=-1002]="Fetch_MODIFY",e[e.BLACK_BROWSER=-1003]="BLACK_BROWSER",e[e.DC_SEND_ERROR=-1004]="DC_SEND_ERROR",e[e.DUPLICATE_DOM=-1005]="DUPLICATE_DOM",e))(JP||{});const jP=new LS("VideoSnapshot",1),zP=async(e,t)=>{const i=document.createElement("canvas"),o=i.getContext("2d");if(!o)throw new Error("canvas.getContext error");const r=(e,t,r)=>(t=t||e.width,r=r||e.height,i.width=t,i.height=r,o.setTransform(1,0,0,1,0,0),o.drawImage(e,0,0,t,r),o.getImageData(0,0,t,r)),s=Date.now(),n=(e=>{const t=null==e?void 0:e.domElement;if(t&&!t.paused&&4===t.readyState)return t})(t);if(n){jP.info("takeSnapshot","VideoPlayer already set.");const e=await r(n,n.videoWidth,n.videoHeight);return jP.info("takeSnapshot","success, cost ".concat(Date.now()-s,"ms")),e}if(window.ImageCapture){const t=new window.ImageCapture(e);if("live"===t.track.readyState&&t.track.enabled&&!t.track.muted){jP.info("takeSnapshot","use ImageCapture");const e=await r(await t.grabFrame());return jP.info("takeSnapshot","success, cost ".concat(Date.now()-s,"ms")),e}}return jP.info("takeSnapshot","use temp video"),new Promise(((t,i)=>{const o=new MediaStream([e]),n=document.createElement("video");n.setAttribute("playsinline",""),n.muted=!0,document.body.appendChild(n),n.onplaying=()=>{const i=r(n,n.videoWidth,n.videoHeight);jP.info("takeSnapshot","success, cost ".concat(Date.now()-s,"ms")),t(i),o.removeTrack(e),n.srcObject=null,n.load()},n.onerror=i,n.srcObject=o,n.play()}))},QP=Symbol("default");var qP=(e=>(e.START_STALL_OBSERVE="start_stall_observe",e.STOP_STALL_OBSERVE="stop_stall_observe",e))(qP||{});class $P extends FI{constructor(e,t,i){super(e,t,Fu(Fu({},i),{},{mediaType:WI.VIDEO})),Xu(this,"resolution",void 0),Xu(this,"videoPlayers",new Map),this.resolution={width:0,height:0}}intersection(){const e={};return this.videoPlayers.forEach(((t,i)=>{e[i.toString()]=t.isIntersecting})),e}async updateVideoCaptureConfig(e){this.logger.info("updateVideoEncoderConfig","update localVideoTrack: ",e);const t=Fu({},e);delete t.contentHint,US&&this.trackInfo.streamIndex===XI.MAIN&&(t.frameRate={ideal:30,max:30}),await this.originTrack.applyConstraints(t);const i=this.originTrack.getSettings();(i.width&&i.width!==this.resolution.width||i.height&&i.height!==this.resolution.height)&&(this.resolution={width:i.width,height:i.height},this.emit("resolution-change",this.resolution))}setContentHint(e){"contentHint"in this.originTrack&&["text","motion","detail"].includes(e)&&(this.originTrack.contentHint=e)}setTrack(e,t){this._originTrack=e,this.trackInfo=Fu(Fu({},this.trackInfo),t),this.isTrackReady=this.generatePreProcessingTrack()}setPlayer(e,t,i,o){var r;const s=null!==(r=e.playerId)&&void 0!==r?r:QP;let n=this.videoPlayers.get(s);return e.player!==n&&(n=e.player,this.videoPlayers.set(s,n),o(n,this.isPublic,this.streamIndex)),this.mirror(!!t),this.dummy||i===Sh.PLAY_MANUALLY||this.play(s),n.domElement}setUserId(e){this.trackInfo.streamUserId=e,this.videoPlayers.forEach((t=>{t.userId=e}))}snapshot(){let e;for(const t of this.videoPlayers.values())if(t.played){e=t;break}return zP(this.preprocessingTrack,e)}setRenderMode(e,t){var i;return null===(i=this.videoPlayers.get(e))||void 0===i?void 0:i.setRenderMode(t)}mirror(e){this.videoPlayers.forEach((t=>{t.mirror(e)}))}removePlayerTrack(){this.videoPlayers.forEach(((e,t)=>{var i;null===(i=this.videoPlayers.get(t))||void 0===i||i.removeTrack()}))}play(e){const t=this.videoPlayers.get(e);return null!=t&&t.played?t.manuallyPlay():null==t?void 0:t.playVideo(this)}playAll(){this.videoPlayers.forEach(((e,t)=>{this.play(t)}))}manuallyPlay(e){var t;return null===(t=this.videoPlayers.get(e))||void 0===t?void 0:t.manuallyPlay()}pause(e){var t;null===(t=this.videoPlayers.get(e))||void 0===t||t.manuallyPause()}stop(e){var t;return null===(t=this.videoPlayers.get(e))||void 0===t?void 0:t.stop()}stopAll(){return this.videoPlayers.forEach(((e,t)=>{this.stop(t)}))}destroy(){this.videoPlayers.forEach(((e,t)=>{this.stop(t),e.removeAllListeners(),this.videoPlayers.delete(t)})),super.destroy()}}class eN extends HI{constructor(e,t,i,o){super(e,t,Fu(Fu({},o),{},{mediaType:WI.VIDEO})),Xu(this,"videoPlayers",new Map),Xu(this,"_stream",void 0),Xu(this,"_observingPlayer",void 0),this._stream=i}get observingPlayerId(){var e;return null===(e=this._observingPlayer)||void 0===e?void 0:e.playerId}getSizeByPlayer(){let e=0,t=0;return this.videoPlayers.forEach((i=>{var o;null!==(o=i.domElement)&&void 0!==o&&o.videoWidth&&i.domElement.videoHeight&&(e=i.domElement.videoWidth,t=i.domElement.videoHeight)})),{width:e,height:t}}intersection(){const e={};return this.videoPlayers.forEach(((t,i)=>{e[i.toString()]=t.isIntersecting})),e}setPlayer(e,t,i,o){var r,s;const n=null!==(r=t.playerId)&&void 0!==r?r:QP;let a=this.videoPlayers.get(n);if(t.player!==a){var d;if(a=t.player,!ab(this.streamIndex))a.mirror(this._ctx.getRemoteMirrorType(null!==(d=this.trackInfo.streamUserId)&&void 0!==d?d:"",this.streamIndex));this.videoPlayers.set(n,a),this._handlePlayerStallEvent(a),o(a,this.isPublic,this.streamIndex)}return this.dummy||this.play(n),null===(s=a)||void 0===s?void 0:s.domElement}mirror(e){this.videoPlayers.forEach((t=>{t.mirror(e)}))}dangerousGetPlayer(e){return this.videoPlayers.get(e)}snapshot(){let e;for(const t of this.videoPlayers.values())if(t.played){e=t;break}return zP(this.preprocessingTrack,e)}stop(e){var t;null===(t=this.videoPlayers.get(e))||void 0===t||t.stop()}stopAll(){this.videoPlayers.forEach(((e,t)=>{this.stop(t)}))}play(e){if(this._ctx.autoPlayPolicy===Sh.PLAY_MANUALLY)return;const t=this.videoPlayers.get(e);return null==t?void 0:t.playVideo(this)}manuallyPlay(e){const t=this.videoPlayers.get(e);return null!=t&&t.played?t.manuallyPlay():null==t?void 0:t.playVideo(this)}pause(e){var t;return null===(t=this.videoPlayers.get(e))||void 0===t?void 0:t.manuallyPause()}_handlePlayerStallEvent(e){e.on("start_stall_observe",(()=>{!this._observingPlayer&&e&&(this._observingPlayer=e,this._stream.startVideoStallObserve(this._observingPlayer))})),e.on("stop_stall_observe",(()=>{this._observingPlayer===e&&(this._stream.stopVideoStallObserve(),this._observingPlayer=void 0,this.videoPlayers.forEach((e=>{!this._observingPlayer&&e.played&&(this._observingPlayer=e,this._stream.startVideoStallObserve(e))})))}))}destroy(){this.videoPlayers.forEach(((e,t)=>{this.stop(t),e.removeAllListeners(),this.videoPlayers.delete(t)})),super.destroy()}}const tN=["play","playing","pause","ended","error","seeking","seeked","waiting","canplay","canplaythrough","durationchange","volumechange","loadedmetadata","loadeddata","loadstart","timeupdate"],iN={playsinline:"","webkit-playsinline":""},oN={playsinline:"","webkit-playsinline":"","x5-playsinline":"","x5-video-player-type":"h5","x-webkit-airplay":"allow",preload:"",muted:""};class rN extends EI.EventEmitter{constructor(e,t,i){super(),Xu(this,"_containerDom",void 0),Xu(this,"_videoDom",void 0),Xu(this,"userId",void 0),Xu(this,"renderMode",void 0),Xu(this,"mirrorType",sh.MIRROR_TYPE_NONE),Xu(this,"isScreen",void 0),Xu(this,"isLocal",void 0),Xu(this,"played",!1),Xu(this,"_needLoad",!1),Xu(this,"_emitPlayFailed",!1),Xu(this,"_videoContainer",void 0),Xu(this,"_safari15VideoTimer",void 0),Xu(this,"_monitor",void 0),Xu(this,"logger",void 0),Xu(this,"_onLocalTrackMute",void 0),Xu(this,"_onInterruptionEnd",void 0),Xu(this,"_needResume",!1),Xu(this,"_rotate",0),Xu(this,"_rotateDom",void 0),Xu(this,"_resizeObserver",void 0),Xu(this,"_hasManuallyPaused",!1),Xu(this,"isIntersecting",void 0),Xu(this,"intersectionObserver",void 0),Xu(this,"hasStartPlaying",!1),Xu(this,"emitVideoEvent",(e=>{var t,i;const o={type:"video",rawEvent:e,readyState:(null===(t=this._videoDom)||void 0===t?void 0:t.readyState)||0,userId:this.userId,eventName:e.type,currentTime:(null===(i=this._videoDom)||void 0===i?void 0:i.currentTime)||0,isScreen:this.isScreen};switch(this.emit("playback_event",o),e.type){case"canplay":this.refreshRenderSize("the video started playing."),this._internalPlay();break;case"loadeddata":this._internalPlay();break;case"playing":this.logger.info("VideoPlayerPlaying","[userId-".concat(this.userId,"] video element playing"));break;case"pause":this.logger.info("VideoPlayerPause","[userId-".concat(this.userId,"] video element pause")),this._needResume?(this.logger.info("VideoPlayerPause","[userId-".concat(this.userId,"] video element resume")),this._internalPlay(),this._needResume=!1):this._hasManuallyPaused||(this.logger.info("VideoPlayerPause","[userId-".concat(this.userId,"] video element resume")),this._internalPlay())}})),Xu(this,"_internalPlay",(()=>{var e,t;if(fS(this.engineId,"video _internalPlay",{paused:null===(e=this._videoDom)||void 0===e?void 0:e.paused,hasManuallyPaused:this._hasManuallyPaused}),this._hasManuallyPaused||null===(t=this._videoDom)||void 0===t||!t.paused)return;const i=this._videoDom.play();null!=i&&i.then&&i.then((()=>{var e;this.isLocal&&XS&&!this._needLoad&&(null===(e=this._videoDom)||void 0===e||e.load(),this._needLoad=!0)})).catch((e=>{var t,i,o,r;this._emitPlayFailed||("AbortError"!==e.name?(this._emitPlayFailed=!0,null===(t=this._monitor)||void 0===t||t.report("rtc_error",{message:"video autoplay failed, userId: ".concat(this.userId,", ").concat(e.name),error_code:JP.AUTOPLAY_FAILED}),this.emit("playback_event",{type:"video",rawEvent:e,readyState:(null===(i=this._videoDom)||void 0===i?void 0:i.readyState)||0,userId:this.userId,eventName:"autoplay-error",currentTime:(null===(o=this._videoDom)||void 0===o?void 0:o.currentTime)||0,isScreen:this.isScreen})):null===(r=this._monitor)||void 0===r||r.report("rtc_error",{message:"video autoplay failed, userId: ".concat(this.userId,", ").concat(e.name),error_code:JP.AUTOPLAY_FAILED}))}))})),this.engineId=e,this.playerId=t;const o=i.renderDom;this._monitor=uS(e),this.logger=new LS("Player",0,e);const{userId:r}=i,s=i.isScreen?qu.RENDER_MODE_FIT:qu.RENDER_MODE_HIDDEN;this.renderMode=void 0!==i.renderMode?i.renderMode:s,this._rotate=Number(i.rotation||0);const n="string"==typeof o?document.getElementById(o):o;if(!n)throw new Cg(Eg.CANT_FIND_DOM,"can't find dom");this._videoContainer=document.createElement("div"),this._videoContainer.style.width="100%",this._videoContainer.style.height="100%",this._videoContainer.style.position="relative",this._videoContainer.style.overflow="hidden",this._containerDom=n,this.userId=r,this.isLocal=!!i.isLocal,this.isScreen=!!i.isScreen,this._initVideo(),!this.isLocal||15!==(null==lg?void 0:lg[0])&&15!==ag||(this._safari15VideoTimer=setTimeout((()=>{try{this._videoContainer.style.display="block",setTimeout((()=>{this._videoContainer.style.display="flex"}),500)}catch(wZ){}}),1e3))}_initVideo(){this._videoDom||(this._videoDom=KP("video",{style:{width:"100%",height:"100%"},attributes:oN}),this._videoDom.id="".concat(this.userId,"_").concat(Jy()),this.setRenderMode(this.renderMode),this.mirror(this.mirrorType===sh.MIRROR_TYPE_RENDER)),this._containerDom.appendChild(this._videoContainer),[90,270].indexOf(this._rotate)>-1?(this._rotateDom=this._createRotationDiv(),this._rotateDom.appendChild(this._videoDom),this._videoContainer.appendChild(this._rotateDom)):(180===this._rotate&&(this._videoContainer.style.transform="rotate(180deg)"),this._videoContainer.appendChild(this._videoDom)),this._initInterSectionObserver(),this._initListeners(),this._onLocalTrackMute=()=>{this._needResume=!0},this._onInterruptionEnd=()=>{this.logger.warn("resume player after iOS interruption"),this._internalPlay()},WP.on(UP.ON_IOS_LOCAL_TRACK_MUTE,this._onLocalTrackMute),WP.on(UP.ON_IOS_LOCAL_TRACK_UNMUTE,this._onInterruptionEnd),WP.on(UP.ON_IOS_INTERRUPTION_END,this._onInterruptionEnd)}_initInterSectionObserver(){!this.intersectionObserver&&"undefined"!=typeof IntersectionObserver&&this._videoDom&&(this.intersectionObserver=new IntersectionObserver((e=>{e[0]&&(this.isIntersecting=e[0].isIntersecting)}),{}),this.intersectionObserver.observe(this._videoDom))}_closeIntersectionObserver(){this.intersectionObserver&&this._videoDom&&(this.intersectionObserver.disconnect(),this.intersectionObserver.unobserve(this._videoDom),delete this.intersectionObserver)}_createRotationDiv(){const e=document.createElement("div");return e.style.transform="rotate(".concat(this._rotate,"deg)"),180!==this._rotate&&(e.style.position="absolute",this.refreshRenderSize("init"),window.ResizeObserver&&(this._resizeObserver=new ResizeObserver((()=>{this.refreshRenderSize("the container size has changed.")})),this._resizeObserver.observe(this._containerDom))),e}refreshRenderSize(e){if(this._rotateDom){var t,i;this.logger.print("refreshRenderSize","Because ".concat(e));const o=Number(window.getComputedStyle(this._containerDom).width.replace("px","")),r=Number(window.getComputedStyle(this._containerDom).height.replace("px","")),s=null===(t=this._videoDom)||void 0===t?void 0:t.videoWidth,n=null===(i=this._videoDom)||void 0===i?void 0:i.videoHeight;if(o&&r&&n&&s){let e,t;if(this.renderMode===qu.RENDER_MODE_FILL)e=r,t=o;else{const i=this.renderMode===qu.RENDER_MODE_HIDDEN?Math.max(o/n,r/s):Math.min(o/n,r/s);e=s*i,t=n*i}this._rotateDom.style.width="".concat(e,"px"),this._rotateDom.style.height="".concat(t,"px"),this._rotateDom.style.left="".concat((o-e)/2,"px"),this._rotateDom.style.top="".concat((r-t)/2,"px")}}}_initListeners(){this._videoDom&&tN.forEach((e=>{var t;null===(t=this._videoDom)||void 0===t||t.addEventListener(e,this.emitVideoEvent)}))}_removeListeners(){this._videoDom&&tN.forEach((e=>{var t;null===(t=this._videoDom)||void 0===t||t.removeEventListener(e,this.emitVideoEvent)}))}setRenderMode(e){this.renderMode=e,this._videoDom&&(this.renderMode===qu.RENDER_MODE_FIT?this._videoDom.style.objectFit="contain":this.renderMode===qu.RENDER_MODE_FILL?this._videoDom.style.objectFit="fill":this._videoDom.style.objectFit="cover")}async playVideo(e){var t,i;let o=this._videoDom;if(this.logger.info("playVideo","play video track: ".concat(this.userId)),o&&o.srcObject instanceof MediaStream&&o.srcObject.getTrackById(null===(t=e.preprocessingTrack)||void 0===t?void 0:t.id)){try{fS(this.engineId,"playVideo","play video repeatedly",0,this.userId)}catch(wZ){}return}o||(this._initVideo(),o=this._videoDom),this.logger.info("playVideo","play video by dom: ".concat(null===(i=o)||void 0===i?void 0:i.id));const r=new MediaStream;r.addTrack(e.preprocessingTrack),o.srcObject=r,o&&!this._containerDom.contains(this._videoContainer)&&this._containerDom.appendChild(this._videoContainer),o&&!this._videoContainer.contains(o)&&this._videoContainer.appendChild(o),setTimeout((()=>this._internalPlay())),jg.VIDEO_STALL&&this.emit(qP.START_STALL_OBSERVE),this.played=!0,this.hasStartPlaying=!1}updateSrcObject(e){const t=e.preprocessingTrack;if(!t||!this._videoDom)return;const i=new MediaStream;i.addTrack(t),this._videoDom.srcObject=i}removeTrack(){var e;const t=null===(e=this._videoDom)||void 0===e?void 0:e.srcObject;if(t){const e=t.getVideoTracks();null!=e&&e.length&&e.forEach((e=>{t.removeTrack(e)}))}}manuallyPlay(){if(this.logger.info("Invoke VideoPlayer.manuallyPlay",this.userId,this.isScreen),this._emitPlayFailed=!1,this._hasManuallyPaused=!1,!this._videoDom)throw new Cg(Eg.INVALID_PARAMS,"Player not found");return 0!==this._videoDom.readyState||zS?this._videoDom.play():Promise.resolve()}manuallyPause(){if(this.logger.print("Invoke VideoPlayer.manuallyPause",this.userId,this.isScreen),this.played){if(this._hasManuallyPaused=!0,!this._videoDom)throw new Cg(Eg.INVALID_PARAMS,"Player not found");return this._videoDom.pause()}}mirror(e){this.logger.info("mirror","".concat(this.userId," set mirror: ").concat(e)),this.mirrorType=e?sh.MIRROR_TYPE_RENDER:sh.MIRROR_TYPE_NONE,this._videoDom&&(this._videoDom.style.transform=e?"rotateY(180deg)":"")}stop(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];const{_containerDom:t}=this;var i,o;(this.logger.info("stop","stop video track: ".concat(this.userId," ").concat(this.playerId.toString())),this._videoDom)&&(e||(this._videoDom.srcObject=null),null!=t&&t.contains(this._videoContainer)&&t.removeChild(this._videoContainer),null===(i=this._videoContainer)||void 0===i||i.childNodes.forEach((e=>{e!==this._videoDom&&e!==this._rotateDom||this._videoContainer.removeChild(e)})),null!==(o=this._rotateDom)&&void 0!==o&&o.contains(this._videoDom)&&this._rotateDom.removeChild(this._videoDom));this._hasManuallyPaused=!1,this.played=!1,this.hasStartPlaying=!1,jg.VIDEO_STALL&&this.emit(qP.STOP_STALL_OBSERVE),this._closeIntersectionObserver()}destroy(){var e;let t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this.logger.info("destroy","video player: ".concat(this.userId)),this.stop(t),null===(e=this._resizeObserver)||void 0===e||e.disconnect(),super.removeAllListeners(),this._removeListeners(),WP.off(UP.ON_IOS_LOCAL_TRACK_MUTE,this._onLocalTrackMute),WP.off(UP.ON_IOS_LOCAL_TRACK_UNMUTE,this._onInterruptionEnd),WP.off(UP.ON_IOS_INTERRUPTION_END,this._onInterruptionEnd),this._videoDom&&delete this._videoDom,this._safari15VideoTimer&&(window.clearInterval(this._safari15VideoTimer),this._safari15VideoTimer=void 0)}get domElement(){return this._videoDom}}class sN extends EI.EventEmitter{constructor(e,t){let{divId:i,muted:o,isScreen:r}=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{divId:void 0,muted:!1,isScreen:!1};if(super(),Xu(this,"_containerDom",void 0),Xu(this,"_audioDom",void 0),Xu(this,"_fakeAudioDom",void 0),Xu(this,"userId",void 0),Xu(this,"muted",!1),Xu(this,"_emitPlayFailed",!1),Xu(this,"played",!1),Xu(this,"isScreen",void 0),Xu(this,"_wechatTimer",void 0),Xu(this,"_edgeTimer",void 0),Xu(this,"_monitor",void 0),Xu(this,"logger",void 0),Xu(this,"_pasued",!0),Xu(this,"hasStartPlaying",!1),Xu(this,"emitAudioEvent",(e=>{var t,i;const o={type:"audio",rawEvent:e,readyState:(null===(t=this._audioDom)||void 0===t?void 0:t.readyState)||0,userId:this.userId,eventName:e.type,currentTime:(null===(i=this._audioDom)||void 0===i?void 0:i.currentTime)||0};var r;("playing"===e.type&&this.logger.info("AudioPlayerPlaying","[userId-".concat(this.userId,"] audio element playing")),"pause"===e.type)&&(this.logger.info("AudioPlayerPause","[userId-".concat(this.userId,"] audio element pause")),!this._pasued&&null!==(r=this._audioDom)&&void 0!==r&&null!==(r=r.srcObject)&&void 0!==r&&r.active&&this._internalPlay());$S&&zS&&("canplay"===e.type?(clearTimeout(this._wechatTimer),this._wechatTimer=setTimeout((()=>{this._autoPlayError("wechat")}),500)):"playing"===e.type&&clearTimeout(this._wechatTimer)),QS&&YS&&"error"===e.type&&(clearTimeout(this._edgeTimer),this._edgeTimer=setTimeout((()=>{var e;0===(null===(e=this._audioDom)||void 0===e?void 0:e.currentTime)&&this._autoPlayError("edge")}),500)),this.emit("playback_event",o)})),Xu(this,"_internalPlay",(()=>{var e,t;if(fS(this.engineId,"audio _internalPlay",{paused:null===(e=this._audioDom)||void 0===e?void 0:e.paused,userId:this.userId,screen:this.isScreen}),null!==(t=this._audioDom)&&void 0!==t&&t.paused)try{var i;let e=this._audioDom.play();const t=YP.getAudioContextInstance();if("suspended"===t.state){const e=t.resume(),i=setTimeout((()=>{var e;"suspended"===t.state&&(this._autoPlayError("AudioContext cannot resume"),null===(e=this._monitor)||void 0===e||e.report("rtc_error",{message:"audio autoplay failed, userId: ".concat(this.userId,": Cannot resume the AudioContext - timeout"),error_code:JP.AUTOPLAY_FAILED}));clearTimeout(i)}));e.catch((e=>{var t;this._autoPlayError("AudioContext cannot resume"),null===(t=this._monitor)||void 0===t||t.report("rtc_error",{message:"audio autoplay failed, userId: ".concat(this.userId,": Cannot resume the AudioContext - rejected by: [").concat(null==e?void 0:e.name,"]").concat(null==e?void 0:e.message),error_code:JP.AUTOPLAY_FAILED})})).finally((()=>{clearTimeout(i)}))}null!==(i=e)&&void 0!==i&&i.then&&($S&&QS&&(e=e.then((()=>new Promise((e=>{setTimeout((async()=>{var t;null===(t=this._audioDom)||void 0===t||t.pause(),this._audioDom.volume=1,await this._audioDom.play(),e()}),500)}))))),e.then((()=>{fS(this.engineId,"_internalPlay successfully",{userId:this.userId,screen:this.isScreen}),this._pasued=!1})).catch((e=>{var t;this._autoPlayError(e),null===(t=this._monitor)||void 0===t||t.report("rtc_error",{message:"audio autoplay failed, userId: ".concat(this.userId,": ").concat(e.message," ").concat(e.name),error_code:JP.AUTOPLAY_FAILED})})))}catch(r){var o;this._autoPlayError(r),null===(o=this._monitor)||void 0===o||o.report("rtc_error",{message:"audio autoplay failed, userId: ".concat(this.userId,": ").concat(r.message," ").concat(r.name),error_code:JP.AUTOPLAY_FAILED})}})),this.engineId=e,i){const e=document.getElementById(i);if(!e)throw new Cg(Eg.CANT_FIND_DOM,"can't find dom");this._containerDom=e}else this._containerDom=document.body;this.userId=t,this.muted=o,this.isScreen=r,this._monitor=uS(e),this.logger=new LS("Player",0,e),this._initAudio()}_initAudio(){this._audioDom||(this._audioDom=KP("audio",{style:{display:"none"},attributes:iN}),this._audioDom.volume=this.muted?0:1,this._audioDom.muted=this.muted,this._audioDom.id="".concat(this.userId,"_").concat(Jy()),this._containerDom.appendChild(this._audioDom)),this._initListeners()}_initListeners(){this._audioDom&&tN.forEach((e=>{var t;null===(t=this._audioDom)||void 0===t||t.addEventListener(e,this.emitAudioEvent)}))}_removeListeners(){this._audioDom&&(tN.forEach((e=>{var t;null===(t=this._audioDom)||void 0===t||t.removeEventListener(e,this.emitAudioEvent)})),this._audioDom.removeEventListener("canplay",this._internalPlay),this._audioDom.removeEventListener("loadeddata",this._internalPlay))}async playAudio(e){var t,i,o;this.logger.info("playAudio","play audio track: ".concat(this.userId));let r=this._audioDom;if(r&&r.srcObject instanceof MediaStream&&r.srcObject.getTrackById(null===(t=e.preprocessingTrack)||void 0===t?void 0:t.id))return;r||(this._initAudio(),r=this._audioDom);const s=new MediaStream;e instanceof dN?(this._fakeAudioDom=new Audio,this._fakeAudioDom.muted=!0,this._fakeAudioDom.srcObject=new MediaStream([e.originTrack]),s.addTrack(e.preprocessingTrack)):s.addTrack(e.preprocessingTrack),$S&&QS&&(this._audioDom.volume=0),r.srcObject=s,null===(i=r)||void 0===i||i.addEventListener("canplay",this._internalPlay),null===(o=r)||void 0===o||o.addEventListener("loadeddata",this._internalPlay),setTimeout((()=>this._internalPlay())),this.played=!0,this.hasStartPlaying=!1}_autoPlayError(e){var t,i;this._emitPlayFailed||(this._emitPlayFailed=!0,this.emit("playback_event",{type:"audio",rawEvent:e,readyState:(null===(t=this._audioDom)||void 0===t?void 0:t.readyState)||0,userId:this.userId,eventName:"autoplay-error",currentTime:(null===(i=this._audioDom)||void 0===i?void 0:i.currentTime)||0}))}pause(){if(!this._audioDom)throw new Cg(Eg.INVALID_PARAMS,"Player not found");this._pasued=!0,this._audioDom.pause(),this.hasStartPlaying=!1}manuallyPause(){return this.pause()}manuallyPlay(){var e;if(this.logger.info("Invoke AudioPlayer.manuallyPlay"),this._emitPlayFailed=!1,!this._audioDom)throw new Cg(Eg.INVALID_PARAMS,"Player not found");if(!this.played)return Promise.resolve();this._audioDom.volume=1,this._audioDom.muted=!1,null===(e=this._fakeAudioDom)||void 0===e||e.play();const t=[],i=this._audioDom.play();null!=i&&i.then&&t.push(i);const o=YP.getAudioContextInstance();if("suspended"===o.state){const e=o.resume();null!=e&&e.then&&t.push(e)}const r=t.length>0?Promise.all(t):Promise.resolve(i);return r.then((()=>{this._pasued=!1})),r}async setPlaybackDevice(e){this.logger.info("setPlaybackDevice","setPlaybackDevice: ".concat(e));(await BP.enumerateAudioPlaybackDevices()).map((e=>e.deviceId)).includes(e)&&this._audioDom&&this._audioDom.setSinkId&&await this._audioDom.setSinkId(e)}stop(){const{_containerDom:e}=this;this.logger.info("stopAudio","stop audio track: ".concat(this.userId)),this._audioDom&&(this._audioDom.srcObject=null,null!=e&&e.contains(this._audioDom)&&e.removeChild(this._audioDom)),this._fakeAudioDom&&(this._fakeAudioDom.srcObject=null,this._fakeAudioDom=void 0),this.played=!1,this.hasStartPlaying=!1}get domElement(){return this._audioDom}destroy(){this.logger.info("destroy","audio player: ".concat(this.userId)),this.stop(),super.removeAllListeners(),this._removeListeners(),this._audioDom&&(this._audioDom.srcObject=null,delete this._audioDom),this._edgeTimer&&clearTimeout(this._edgeTimer)}}class nN{constructor(){Xu(this,"_ac",void 0),Xu(this,"_sourceNode",void 0),Xu(this,"_gainNode",void 0),Xu(this,"_destNode",void 0),this._ac=YP.getAudioContextInstance(),this._gainNode=this._ac.createGain(),this._destNode=this._ac.createMediaStreamDestination(),this._gainNode.connect(this._destNode)}setVolume(e){this._gainNode.gain.value=e/100}getVolume(){return Math.round(100*this._gainNode.gain.value)}updateInputTrack(e){this._sourceNode&&(this._sourceNode.mediaStream.getTracks().forEach((e=>{e.stop()})),delete this._sourceNode);const t=new MediaStream;t.addTrack(e),this._sourceNode=this._ac.createMediaStreamSource(t),this._sourceNode.connect(this._gainNode)}getOutputTrack(){return this._destNode.stream.getTracks()[0]}destroy(){var e,t;null===(e=this._sourceNode)||void 0===e||e.mediaStream.getTracks().forEach((e=>{e.stop()})),13!==ag&&this._destNode.stream.getTracks().forEach((e=>{e.stop()})),null===(t=this._sourceNode)||void 0===t||t.disconnect(),this._gainNode.disconnect(),delete this._sourceNode}}class aN extends FI{constructor(e,t,i){super(e,t,Fu(Fu({},i),{},{mediaType:WI.AUDIO})),Xu(this,"audioCaptureConfig",void 0),Xu(this,"_ap",void 0),Xu(this,"mixedAudioTrack",void 0),Xu(this,"mixType",Oh.PLAYOUT_AND_PUBLISH),Xu(this,"_audioFetchMap",new Map),Xu(this,"_audioDataFetcher",void 0),Xu(this,"_localPlaybackTrack",void 0),Xu(this,"notSupportedWebAudio",!1)}get withWebAudio(){return!!this._ap}getAudioLevel(){var e;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:ah.MICROPHONE;const i=t===ah.AUDIOMIXING&&this.mixType!==Oh.PLAYOUT&&null!==(e=this.mixedAudioTrack)&&void 0!==e?e:this.preprocessingTrack;let o=this._audioFetchMap.get(t);var r;o&&o.currentTrackId===i.id||(null===(r=o)||void 0===r||r.destroy(),o=new FP(i),this._audioFetchMap.set(t,o));return o.getAudioLevel()}async updateAudioCaptureConfig(){this.audioCaptureConfig&&(this.logger.print("updateAudioCaptureConfig","update localAudioTrack: ",this.audioCaptureConfig),await this.originTrack.applyConstraints(this.audioCaptureConfig))}setVolume(e){const t=!Qg("SKIP_WEB_AUDIO_IN_TRACK")&&(nE()||Qg("ENFORCE_WEB_AUDIO_SUPPORTED"));t||(this.notSupportedWebAudio=!0);const i=!this.withWebAudio&&100!==e;try{t&&i&&(this.logger.print("Create AudioProcess"),this._ap=new nN,this._ap.updateInputTrack(this.originTrack),this.mediaTrack=this._ap.getOutputTrack())}catch(r){this.logger.warn("WebAudio may not supported, quired return"),this.notSupportedWebAudio=!0}var o;this.notSupportedWebAudio||(null===(o=this._ap)||void 0===o||o.setVolume(e));t&&i&&this.emit("needReplaceTrack",this)}getVolume(){return this._ap?this._ap.getVolume():100}setUserId(e){this.trackInfo.streamUserId=e}setDataFetcher(e,t){this.logger.info("setDataFetcher","frameSize %s",e),null!==YP.isWorkletReady?this._audioDataFetcher?this._audioDataFetcher.setFrameSize(e):(this._audioDataFetcher=new HP(this.preprocessingTrack,e),this._audioDataFetcher.on("data",t)):this.logger.info("setDataFetcher","audioContextManager.isWorkletReady is null")}stopDataFetcher(){var e,t;null===(e=this._audioDataFetcher)||void 0===e||e.removeAllListeners("data"),null===(t=this._audioDataFetcher)||void 0===t||t.destroy(),this._audioDataFetcher=void 0}play(e){var t,i;this._localPlaybackTrack&&this.stop();const o=e===Ah.AFTER_CAPTURE?this.originTrack:e===Ah.AFTER_PROCESS?this.preprocessingTrack:void 0;if(!o)return void this.logger.error("play()","no target track for %s",e);this._localPlaybackTrack=new dN(this._ctx,o.clone(),Fu({},this.trackInfo));const r=this._ctx.earMonitorSettings[null!==(t=this.streamIndex)&&void 0!==t?t:$u.STREAM_INDEX_MAIN].volume;this.setPlaybackVolume(r);const s=new sN(this._ctx.id,null!==(i=this.trackInfo.streamUserId)&&void 0!==i?i:"",{isScreen:this.streamIndex===$u.STREAM_INDEX_SCREEN,muted:!1});return s.on("playback_event",(e=>{var t;"autoplay-error"===e.eventName&&this.emit("autoplay-error",{kind:"audio",streamIndex:null!==(t=this.streamIndex)&&void 0!==t?t:$u.STREAM_INDEX_MAIN,mediaType:WI.AUDIO})})),this._localPlaybackTrack.setPlayer(s),this._localPlaybackTrack.play()}stop(){var e;null===(e=this._localPlaybackTrack)||void 0===e||e.destroy(),this._localPlaybackTrack=void 0}setPlaybackVolume(e){var t;return null===(t=this._localPlaybackTrack)||void 0===t?void 0:t.setVolume(e)}destroy(){var e,t;this._audioFetchMap.forEach((e=>e.destroy())),this._audioFetchMap.clear(),null===(e=this._ap)||void 0===e||e.destroy(),null===(t=this._audioDataFetcher)||void 0===t||t.destroy(),this._audioDataFetcher=void 0,this.stop(),super.destroy()}}class dN extends HI{constructor(e,t,i){super(e,t,Fu(Fu({},i),{},{mediaType:WI.AUDIO})),Xu(this,"_ap",void 0),Xu(this,"_audioPlayer",void 0),Xu(this,"_audioLevelFetcher",void 0),Xu(this,"_audioDataFetcher",void 0),Xu(this,"notSupportedWebAudio",!1)}get withWebAudio(){return!!this._ap}getAudioLevel(){return this._audioLevelFetcher||(this._audioLevelFetcher=new FP(this.originTrack)),this._audioLevelFetcher.getAudioLevel()}setVolume(e){const t=!Qg("SKIP_WEB_AUDIO_IN_TRACK")&&(nE()||Qg("ENFORCE_WEB_AUDIO_SUPPORTED"));t||(this.notSupportedWebAudio=!0);const i=!this.withWebAudio&&100!==e;try{t&&i&&(this.logger.print("Create AudioProcess"),this._ap=new nN,this._ap.updateInputTrack(this.originTrack),this.mediaTrack=this._ap.getOutputTrack())}catch(n){this.logger.warn("WebAudio may not supported, quite return"),this.notSupportedWebAudio=!0}if(this.notSupportedWebAudio){var o;const t=null===(o=this._audioPlayer)||void 0===o?void 0:o.domElement;t&&(t.volume=Math.min(e/100,1))}else{var r;null===(r=this._ap)||void 0===r||r.setVolume(e)}var s;t&&i&&(this.emit("needReplaceTrack",this),null===(s=this._audioPlayer)||void 0===s||s.playAudio(this))}getVolume(){var e,t;return this.notSupportedWebAudio?100*(null!==(e=null===(t=this._audioPlayer)||void 0===t||null===(t=t.domElement)||void 0===t?void 0:t.volume)&&void 0!==e?e:1):this._ap?this._ap.getVolume():100}setPlaybackDevice(e){var t;return null===(t=this._audioPlayer)||void 0===t?void 0:t.setPlaybackDevice(e)}setPlayer(e){this._audioPlayer=e,this._wechatAutoplayWorkaround(e)}havePlayer(){return!!this._audioPlayer}bindPlayerEvent(e){var t;this._audioPlayer&&e(this._audioPlayer,this.isPublic,null!==(t=this.streamIndex)&&void 0!==t?t:$u.STREAM_INDEX_MAIN)}pause(){var e;return null===(e=this._audioPlayer)||void 0===e?void 0:e.pause()}play(){var e;return null===(e=this._audioPlayer)||void 0===e?void 0:e.playAudio(this)}manuallyPlay(){var e,t,i;return null!==(e=this._audioPlayer)&&void 0!==e&&e.played?null===(t=this._audioPlayer)||void 0===t?void 0:t.manuallyPlay():null===(i=this._audioPlayer)||void 0===i?void 0:i.playAudio(this)}manuallyPause(){var e;return null===(e=this._audioPlayer)||void 0===e?void 0:e.manuallyPause()}stop(){var e;return null===(e=this._audioPlayer)||void 0===e?void 0:e.stop()}setDataFetcher(e,t){this.logger.info("setDataFetcher","frameSize %s",e),null!==YP.isWorkletReady?this._audioDataFetcher?this._audioDataFetcher.setFrameSize(e):(this._audioDataFetcher=new HP(this.originTrack,e),this._audioDataFetcher.on("data",t)):this.logger.warn("setDataFetcher","audioContextManager.isWorkletReady is null")}stopDataFetcher(){var e;this.logger.info("stopDataFetcher"),null===(e=this._audioDataFetcher)||void 0===e||e.destroy(),this._audioDataFetcher=void 0}destroy(){var e,t,i;null===(e=this._audioLevelFetcher)||void 0===e||e.destroy(),null===(t=this._audioDataFetcher)||void 0===t||t.destroy(),this._audioDataFetcher=void 0,this._ap&&this._ap.destroy(),null===(i=this._audioPlayer)||void 0===i||i.destroy(),this._audioPlayer=void 0,super.destroy()}_wechatAutoplayWorkaround(e){if(zS){let t;e.on("playback_event",(e=>{const i=YP.getAudioContextInstance();"autoplay-error"===e.eventName?i&&"running"===i.state&&(t=i.createMediaStreamSource(new MediaStream([this.originTrack])),t.connect(i.destination),fS(this._ctx.id,"wechatAutoplayWorkaround.connect",{userId:this.trackInfo.streamUserId,streamIndex:this.streamIndex,contextState:i.state,trackInfo:this.trackInfo})):"playing"===e.eventName&&t&&(t.disconnect(),t=void 0,fS(this._ctx.id,"wechatAutoplayWorkaround.disconnect",{userId:this.trackInfo.streamUserId,streamIndex:this.streamIndex,contextState:i.state,trackInfo:this.trackInfo}))}))}}}const cN=new LS("VERTC",0);let lN,uN=null;function hN(){if(uN)return uN;try{uN=window.require("electron");const{ipcRenderer:e}=uN;return lN={getSources:t=>e.invoke("DESKTOP_CAPTURER_GET_SOURCES",t)},uN}catch(e){return null}}async function _N(e,t,i){let o;return t||(t={width:1920,height:1080,frameRate:15}),o=i?{audio:{mandatory:{chromeMediaSource:"desktop"}},video:{mandatory:{chromeMediaSource:"desktop",maxHeight:t.height,maxWidth:t.width,maxFrameRate:t.frameRate}}}:{audio:!1,video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:e,maxHeight:t.height,maxWidth:t.width,maxFrameRate:t.frameRate}}},cN.info("getUserMediaConfig",JSON.stringify(o)),await navigator.mediaDevices.getUserMedia(o)}async function mN(e){let t=["window","screen"];"window"===e&&(t=["window"]),"screen"===e&&(t=["screen"]);if(!hN())throw new Cg(Eg.ERR_ELECTRON_IS_NULL,"Unable to get Electron object");let i=null;try{i=lN.getSources({types:t})}catch(o){i=null}i&&i.then||(i=new Promise(((e,i)=>{lN.getSources({types:t},((t,o)=>{t?i(t):e(o)}))})));try{return await i}catch(r){throw new Cg(Eg.ERR_ELECTRON_IS_NULL,r.toString())}}async function pN(e,t){const i=await mN(),o=await function(e){return new Promise(((t,i)=>{const o=document.createElement("div");o.innerText="share screen",o.setAttribute("style","text-align: center; height: 25px; line-height: 25px; border-radius: 4px 4px 0 0; background: #D4D2D4; border-bottom:  solid 1px #B9B8B9;");const r=document.createElement("div");r.setAttribute("style","width: 100%; height: 500px; padding: 15px 25px ; box-sizing: border-box;");const s=document.createElement("div");s.innerText="Web Screensharing wants to share the contents of your screen. Choose what you'd like to share.",s.setAttribute("style","height: 12%;");const n=document.createElement("div");n.setAttribute("style","width: 100%; height: 80%; background: #FFF; border:  solid 1px #CBCBCB; display: flex; flex-wrap: wrap; justify-content: space-around; overflow-y: scroll; padding: 0 15px; box-sizing: border-box;");const a=document.createElement("div");a.setAttribute("style","text-align: right; padding: 16px 0;");const d=document.createElement("button");d.innerHTML="cancel",d.setAttribute("style","width: 85px;"),d.onclick=()=>{document.body.removeChild(c);const e=new Error("NotAllowedError");e.name="NotAllowedError",i(e)},a.appendChild(d),r.appendChild(s),r.appendChild(n),r.appendChild(a);const c=document.createElement("div");c.setAttribute("style","position: fixed; z-index: 99999999; top: 50%; left: 50%; width: 620px; height: 525px; background: #ECECEC; border-radius: 4px; -webkit-transform: translate(-50%,-50%); transform: translate(-50%,-50%);"),c.appendChild(o),c.appendChild(r),document.body.appendChild(c),e.map((e=>{if(e.id){const i=document.createElement("div");i.setAttribute("style","width: 30%; height: 160px; padding: 20px 0; text-align: center;box-sizing: content-box;"),i.innerHTML="<div style='height: 120px; display: table-cell; vertical-align: middle;'> \n          <img style='width: 100%; background: #333333; box-shadow: 1px 1px 1px 1px rgba(0, 0, 0, 0.2);' src=\n          ".concat(e.thumbnail.toDataURL(),"\n           />\n          </div>\n          <span style='\theight: 40px; line-height: 40px; display: inline-block; width: 70%; word-break: keep-all; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;'>\n          ").concat(e.name,"\n          </span>"),i.onclick=()=>{document.body.removeChild(c),t(e.id)},n.appendChild(i)}}))}))}(i);return await _N(o,e,t)}async function vN(e,t){var i;let o;const r=(null===(i=(t=t||e.videoProfile.getCaptureConfig()).deviceId)||void 0===i?void 0:i.exact)||"default",s=sm(),n=new LS("TrackFactory",0,e.id);try{var a,d,c;n.info("createCameraVideoTrack","constraints:",t),null===(a=e.monitor)||void 0===a||a.report("rtc_video_capture_event",{event_type:"start",media_device_id:r,capture_session_id:s});const i=jy();US&&(t.frameRate={ideal:30,max:30}),o=await BP.getUserMedia({video:t}),null===(d=e.monitor)||void 0===d||d.report("rtc_video_capture_event",{event_type:"start_capture_result",media_device_id:r,media_device_name:(null===(c=o.getVideoTracks()[0])||void 0===c?void 0:c.label)||"",reason:"success",elapse:jy()-i,capture_session_id:s})}catch(wZ){var l;throw null===(l=e.monitor)||void 0===l||l.report("rtc_video_capture_event",{event_type:"running_failed",media_device_id:r,error_code:wZ.code,reason:wZ.name+wZ.message,capture_session_id:s}),new Cg(Eg.GET_VIDEO_TRACK_FAILED,"throw error from getUserMedia. [".concat(wZ.name||"unknown name","]: ").concat(wZ.message||"unknown message","."),wZ)}const u=o.getVideoTracks()[0],h=new $P(e,u,{streamIndex:XI.MAIN,sourceType:ZI.INTERNAL,captureSessionId:s});return await h.isTrackReady,h}async function fN(e,t){var i;let o;new LS("TrackFactory",0,e.id).info("createMicrophoneAudioTrack","constraints:",t);const r=(null===(i=t.deviceId)||void 0===i?void 0:i.exact)||"default",s=sm();try{var n,a,d;null===(n=e.monitor)||void 0===n||n.report("rtc_audio_device_event",{device_type:"audio_record",event_type:"start_begin",media_device_id:r,event_session_id:s});const i=jy();e.extensionManager.getPluginByName(LP.PRE_PROCESSING,"RTCAIAnsExtension")&&(t.autoGainControl=!0,t.noiseSuppression=!1),o=await BP.getUserMedia({audio:t}),null===(a=e.monitor)||void 0===a||a.report("rtc_audio_device_event",{device_type:"audio_record",event_type:"start_result",media_device_id:r,media_device_name:(null===(d=o.getAudioTracks()[0])||void 0===d?void 0:d.label)||"",reason:"success",elapse:jy()-i,event_session_id:s})}catch(wZ){var c;throw null===(c=e.monitor)||void 0===c||c.report("rtc_audio_device_event",{device_type:"audio_record",event_type:"start_end",media_device_id:r,error_code:wZ.code,reason:wZ.name+wZ.message,event_session_id:s}),new Cg(Eg.GET_AUDIO_TRACK_FAILED,"throw error from getUserMedia. [".concat(wZ.name||"unknown name","]: ").concat(wZ.message||"unknown message","."),wZ)}const l=o.getAudioTracks()[0],u=new aN(e,l,{streamIndex:XI.MAIN,sourceType:ZI.INTERNAL,captureSessionId:s});return await u.isTrackReady,u}async function SN(e,t){const i=new LS("TrackFactory",0,e.id);let o,r=e.videoProfile.getScreenEncodeConfig();i.info("createScreenTracks","screenConfig: %o, constraints: %o",t,r);const s=sm(),{enableAudio:n=!1,displaySurface:a,systemAudio:d,surfaceSwitching:c,selfBrowserSurface:l,sourceId:u}=t,h={};a&&["monitor","browser","window"].includes(a)&&(r?r.displaySurface=a:r={displaySurface:a}),d&&["include","exclude"].includes(d)&&(h.systemAudio=d),c&&["include","exclude"].includes(c)&&(h.surfaceSwitching=c),l&&["include","exclude"].includes(l)&&(h.selfBrowserSurface=l);try{var _,m,p,v;null===(_=e.monitor)||void 0===_||_.report("rtc_video_capture_event",{event_type:"start",media_device_id:"screen",capture_session_id:s});const t=jy();o=hN()?u?await _N(u,r,n):await pN(r,n):await navigator.mediaDevices.getDisplayMedia(Fu({video:!(r&&(!ZS||"16.1"!==cg))||r,audio:!!n&&{channelCount:2,noiseSuppression:!1,echoCancellation:!0,autoGainControl:!1}},h)),null===(m=e.monitor)||void 0===m||m.report("rtc_video_capture_event",{event_type:"start_capture_result",media_device_id:"screen",media_device_name:"".concat((null===(p=o.getVideoTracks()[0])||void 0===p?void 0:p.label)||"",", ").concat((null===(v=o.getAudioTracks()[0])||void 0===v?void 0:v.label)||""),reason:"success",elapse:jy()-t,capture_session_id:s})}catch(wZ){var f;throw null===(f=e.monitor)||void 0===f||f.report("rtc_video_capture_event",{event_type:"running_failed",media_device_id:"screen",error_code:wZ.code,reason:wZ.name+wZ.message,capture_session_id:s}),new Cg(Eg.GET_SCREEN_TRACK_FAILED,"throw error from getDisplayMedia",wZ)}const S=o.getVideoTracks()[0],g=new $P(e,S,{streamIndex:XI.SCREEN,sourceType:ZI.INTERNAL,captureSessionId:s}),y=o.getAudioTracks()[0];if(o.getAudioTracks().length){const t=new aN(e,y,{streamIndex:XI.SCREEN,sourceType:ZI.INTERNAL,captureSessionId:s});return await Promise.all([g.isTrackReady,t.isTrackReady]),[g,t]}return await g.isTrackReady,[g,void 0]}function gN(e,t,i){return new dN(e,t,Fu({},i))}const yN="IWZ1bmN0aW9uKCl7InVzZSBzdHJpY3QiO3ZhciB0PSJ1bmRlZmluZWQiIT10eXBlb2YgZ2xvYmFsVGhpcz9nbG9iYWxUaGlzOiJ1bmRlZmluZWQiIT10eXBlb2Ygd2luZG93P3dpbmRvdzoidW5kZWZpbmVkIiE9dHlwZW9mIGdsb2JhbD9nbG9iYWw6InVuZGVmaW5lZCIhPXR5cGVvZiBzZWxmP3NlbGY6e307ZnVuY3Rpb24gZSh0KXtyZXR1cm4gdCYmdC5fX2VzTW9kdWxlJiZPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwodCwiZGVmYXVsdCIpP3QuZGVmYXVsdDp0fXZhciBuPXtleHBvcnRzOnt9fSxyPWZ1bmN0aW9uKHQpe3JldHVybiB0JiZ0Lk1hdGg9PT1NYXRoJiZ0fSxvPXIoIm9iamVjdCI9PXR5cGVvZiBnbG9iYWxUaGlzJiZnbG9iYWxUaGlzKXx8cigib2JqZWN0Ij09dHlwZW9mIHdpbmRvdyYmd2luZG93KXx8cigib2JqZWN0Ij09dHlwZW9mIHNlbGYmJnNlbGYpfHxyKCJvYmplY3QiPT10eXBlb2YgdCYmdCl8fHIoIm9iamVjdCI9PXR5cGVvZiB0JiZ0KXx8ZnVuY3Rpb24oKXtyZXR1cm4gdGhpc30oKXx8RnVuY3Rpb24oInJldHVybiB0aGlzIikoKSxpPWZ1bmN0aW9uKHQpe3RyeXtyZXR1cm4hIXQoKX1jYXRjaChlKXtyZXR1cm4hMH19LHU9IWkoKGZ1bmN0aW9uKCl7dmFyIHQ9ZnVuY3Rpb24oKXt9LmJpbmQoKTtyZXR1cm4iZnVuY3Rpb24iIT10eXBlb2YgdHx8dC5oYXNPd25Qcm9wZXJ0eSgicHJvdG90eXBlIil9KSksYT11LGM9RnVuY3Rpb24ucHJvdG90eXBlLHM9Yy5hcHBseSxmPWMuY2FsbCxsPSJvYmplY3QiPT10eXBlb2YgUmVmbGVjdCYmUmVmbGVjdC5hcHBseXx8KGE/Zi5iaW5kKHMpOmZ1bmN0aW9uKCl7cmV0dXJuIGYuYXBwbHkocyxhcmd1bWVudHMpfSkseT11LHA9RnVuY3Rpb24ucHJvdG90eXBlLGg9cC5jYWxsLGc9eSYmcC5iaW5kLmJpbmQoaCxoKSxkPXk/ZzpmdW5jdGlvbih0KXtyZXR1cm4gZnVuY3Rpb24oKXtyZXR1cm4gaC5hcHBseSh0LGFyZ3VtZW50cyl9fSxiPWQsdj1iKHt9LnRvU3RyaW5nKSxtPWIoIiIuc2xpY2UpLFM9ZnVuY3Rpb24odCl7cmV0dXJuIG0odih0KSw4LC0xKX0sdz1TLE89ZCxMPWZ1bmN0aW9uKHQpe2lmKCJGdW5jdGlvbiI9PT13KHQpKXJldHVybiBPKHQpfSxqPSJvYmplY3QiPT10eXBlb2YgZG9jdW1lbnQmJmRvY3VtZW50LmFsbCxBPXZvaWQgMD09PWomJnZvaWQgMCE9PWo/ZnVuY3Rpb24odCl7cmV0dXJuImZ1bmN0aW9uIj09dHlwZW9mIHR8fHQ9PT1qfTpmdW5jdGlvbih0KXtyZXR1cm4iZnVuY3Rpb24iPT10eXBlb2YgdH0sUD17fSxJPSFpKChmdW5jdGlvbigpe3JldHVybiA3IT09T2JqZWN0LmRlZmluZVByb3BlcnR5KHt9LDEse2dldDpmdW5jdGlvbigpe3JldHVybiA3fX0pWzFdfSkpLEU9dSxUPUZ1bmN0aW9uLnByb3RvdHlwZS5jYWxsLGs9RT9ULmJpbmQoVCk6ZnVuY3Rpb24oKXtyZXR1cm4gVC5hcHBseShULGFyZ3VtZW50cyl9LHg9e30sRj17fS5wcm9wZXJ0eUlzRW51bWVyYWJsZSxDPU9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IsTj1DJiYhRi5jYWxsKHsxOjJ9LDEpO3guZj1OP2Z1bmN0aW9uKHQpe3ZhciBlPUModGhpcyx0KTtyZXR1cm4hIWUmJmUuZW51bWVyYWJsZX06Rjt2YXIgTSxSLFU9ZnVuY3Rpb24odCxlKXtyZXR1cm57ZW51bWVyYWJsZTohKDEmdCksY29uZmlndXJhYmxlOiEoMiZ0KSx3cml0YWJsZTohKDQmdCksdmFsdWU6ZX19LEQ9aSxfPVMsRz1PYmplY3QsSD1kKCIiLnNwbGl0KSxCPUQoKGZ1bmN0aW9uKCl7cmV0dXJuIUcoInoiKS5wcm9wZXJ0eUlzRW51bWVyYWJsZSgwKX0pKT9mdW5jdGlvbih0KXtyZXR1cm4iU3RyaW5nIj09PV8odCk/SCh0LCIiKTpHKHQpfTpHLFY9ZnVuY3Rpb24odCl7cmV0dXJuIG51bGw9PXR9LFc9Vix6PVR5cGVFcnJvcixLPWZ1bmN0aW9uKHQpe2lmKFcodCkpdGhyb3cgbmV3IHooIkNhbid0IGNhbGwgbWV0aG9kIG9uICIrdCk7cmV0dXJuIHR9LHE9QixKPUssWT1mdW5jdGlvbih0KXtyZXR1cm4gcShKKHQpKX0sWD1BLCQ9ZnVuY3Rpb24odCl7cmV0dXJuIm9iamVjdCI9PXR5cGVvZiB0P251bGwhPT10OlgodCl9LFE9e30sWj1RLHR0PW8sZXQ9QSxudD1mdW5jdGlvbih0KXtyZXR1cm4gZXQodCk/dDp2b2lkIDB9LHJ0PWZ1bmN0aW9uKHQsZSl7cmV0dXJuIGFyZ3VtZW50cy5sZW5ndGg8Mj9udChaW3RdKXx8bnQodHRbdF0pOlpbdF0mJlpbdF1bZV18fHR0W3RdJiZ0dFt0XVtlXX0sb3Q9ZCh7fS5pc1Byb3RvdHlwZU9mKSxpdD1vLm5hdmlnYXRvcix1dD1pdCYmaXQudXNlckFnZW50LGF0PW8sY3Q9dXQ/U3RyaW5nKHV0KToiIixzdD1hdC5wcm9jZXNzLGZ0PWF0LkRlbm8sbHQ9c3QmJnN0LnZlcnNpb25zfHxmdCYmZnQudmVyc2lvbix5dD1sdCYmbHQudjg7eXQmJihSPShNPXl0LnNwbGl0KCIuIikpWzBdPjAmJk1bMF08ND8xOisoTVswXStNWzFdKSksIVImJmN0JiYoIShNPWN0Lm1hdGNoKC9FZGdlXC8oXGQrKS8pKXx8TVsxXT49NzQpJiYoTT1jdC5tYXRjaCgvQ2hyb21lXC8oXGQrKS8pKSYmKFI9K01bMV0pO3ZhciBwdD1SLGh0PXB0LGd0PWksZHQ9by5TdHJpbmcsYnQ9ISFPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzJiYhZ3QoKGZ1bmN0aW9uKCl7dmFyIHQ9U3ltYm9sKCJzeW1ib2wgZGV0ZWN0aW9uIik7cmV0dXJuIWR0KHQpfHwhKE9iamVjdCh0KWluc3RhbmNlb2YgU3ltYm9sKXx8IVN5bWJvbC5zaGFtJiZodCYmaHQ8NDF9KSksdnQ9YnQmJiFTeW1ib2wuc2hhbSYmInN5bWJvbCI9PXR5cGVvZiBTeW1ib2wuaXRlcmF0b3IsbXQ9cnQsU3Q9QSx3dD1vdCxPdD1PYmplY3QsTHQ9dnQ/ZnVuY3Rpb24odCl7cmV0dXJuInN5bWJvbCI9PXR5cGVvZiB0fTpmdW5jdGlvbih0KXt2YXIgZT1tdCgiU3ltYm9sIik7cmV0dXJuIFN0KGUpJiZ3dChlLnByb3RvdHlwZSxPdCh0KSl9LGp0PVN0cmluZyxBdD1mdW5jdGlvbih0KXt0cnl7cmV0dXJuIGp0KHQpfWNhdGNoKGUpe3JldHVybiJPYmplY3QifX0sUHQ9QSxJdD1BdCxFdD1UeXBlRXJyb3IsVHQ9ZnVuY3Rpb24odCl7aWYoUHQodCkpcmV0dXJuIHQ7dGhyb3cgbmV3IEV0KEl0KHQpKyIgaXMgbm90IGEgZnVuY3Rpb24iKX0sa3Q9VHQseHQ9VixGdD1rLEN0PUEsTnQ9JCxNdD1UeXBlRXJyb3IsUnQ9e2V4cG9ydHM6e319LFV0PW8sRHQ9T2JqZWN0LmRlZmluZVByb3BlcnR5LF90PW8sR3Q9ZnVuY3Rpb24odCxlKXt0cnl7RHQoVXQsdCx7dmFsdWU6ZSxjb25maWd1cmFibGU6ITAsd3JpdGFibGU6ITB9KX1jYXRjaChuKXtVdFt0XT1lfXJldHVybiBlfSxIdD0iX19jb3JlLWpzX3NoYXJlZF9fIixCdD1SdC5leHBvcnRzPV90W0h0XXx8R3QoSHQse30pOyhCdC52ZXJzaW9uc3x8KEJ0LnZlcnNpb25zPVtdKSkucHVzaCh7dmVyc2lvbjoiMy4zOS4wIixtb2RlOiJwdXJlIixjb3B5cmlnaHQ6IsKpIDIwMTQtMjAyNCBEZW5pcyBQdXNoa2FyZXYgKHpsb2lyb2NrLnJ1KSIsbGljZW5zZToiaHR0cHM6Ly9naXRodWIuY29tL3psb2lyb2NrL2NvcmUtanMvYmxvYi92My4zOS4wL0xJQ0VOU0UiLHNvdXJjZToiaHR0cHM6Ly9naXRodWIuY29tL3psb2lyb2NrL2NvcmUtanMifSk7dmFyIFZ0PVJ0LmV4cG9ydHMsV3Q9VnQsenQ9ZnVuY3Rpb24odCxlKXtyZXR1cm4gV3RbdF18fChXdFt0XT1lfHx7fSl9LEt0PUsscXQ9T2JqZWN0LEp0PWZ1bmN0aW9uKHQpe3JldHVybiBxdChLdCh0KSl9LFl0PUp0LFh0PWQoe30uaGFzT3duUHJvcGVydHkpLCR0PU9iamVjdC5oYXNPd258fGZ1bmN0aW9uKHQsZSl7cmV0dXJuIFh0KFl0KHQpLGUpfSxRdD1kLFp0PTAsdGU9TWF0aC5yYW5kb20oKSxlZT1RdCgxLi50b1N0cmluZyksbmU9ZnVuY3Rpb24odCl7cmV0dXJuIlN5bWJvbCgiKyh2b2lkIDA9PT10PyIiOnQpKyIpXyIrZWUoKytadCt0ZSwzNil9LHJlPXp0LG9lPSR0LGllPW5lLHVlPWJ0LGFlPXZ0LGNlPW8uU3ltYm9sLHNlPXJlKCJ3a3MiKSxmZT1hZT9jZS5mb3J8fGNlOmNlJiZjZS53aXRob3V0U2V0dGVyfHxpZSxsZT1mdW5jdGlvbih0KXtyZXR1cm4gb2Uoc2UsdCl8fChzZVt0XT11ZSYmb2UoY2UsdCk/Y2VbdF06ZmUoIlN5bWJvbC4iK3QpKSxzZVt0XX0seWU9ayxwZT0kLGhlPUx0LGdlPWZ1bmN0aW9uKHQsZSl7dmFyIG49dFtlXTtyZXR1cm4geHQobik/dm9pZCAwOmt0KG4pfSxkZT1mdW5jdGlvbih0LGUpe3ZhciBuLHI7aWYoInN0cmluZyI9PT1lJiZDdChuPXQudG9TdHJpbmcpJiYhTnQocj1GdChuLHQpKSlyZXR1cm4gcjtpZihDdChuPXQudmFsdWVPZikmJiFOdChyPUZ0KG4sdCkpKXJldHVybiByO2lmKCJzdHJpbmciIT09ZSYmQ3Qobj10LnRvU3RyaW5nKSYmIU50KHI9RnQobix0KSkpcmV0dXJuIHI7dGhyb3cgbmV3IE10KCJDYW4ndCBjb252ZXJ0IG9iamVjdCB0byBwcmltaXRpdmUgdmFsdWUiKX0sYmU9VHlwZUVycm9yLHZlPWxlKCJ0b1ByaW1pdGl2ZSIpLG1lPWZ1bmN0aW9uKHQsZSl7aWYoIXBlKHQpfHxoZSh0KSlyZXR1cm4gdDt2YXIgbixyPWdlKHQsdmUpO2lmKHIpe2lmKHZvaWQgMD09PWUmJihlPSJkZWZhdWx0Iiksbj15ZShyLHQsZSksIXBlKG4pfHxoZShuKSlyZXR1cm4gbjt0aHJvdyBuZXcgYmUoIkNhbid0IGNvbnZlcnQgb2JqZWN0IHRvIHByaW1pdGl2ZSB2YWx1ZSIpfXJldHVybiB2b2lkIDA9PT1lJiYoZT0ibnVtYmVyIiksZGUodCxlKX0sU2U9THQsd2U9ZnVuY3Rpb24odCl7dmFyIGU9bWUodCwic3RyaW5nIik7cmV0dXJuIFNlKGUpP2U6ZSsiIn0sT2U9JCxMZT1vLmRvY3VtZW50LGplPU9lKExlKSYmT2UoTGUuY3JlYXRlRWxlbWVudCksQWU9ZnVuY3Rpb24odCl7cmV0dXJuIGplP0xlLmNyZWF0ZUVsZW1lbnQodCk6e319LFBlPUFlLEllPSFJJiYhaSgoZnVuY3Rpb24oKXtyZXR1cm4gNyE9PU9iamVjdC5kZWZpbmVQcm9wZXJ0eShQZSgiZGl2IiksImEiLHtnZXQ6ZnVuY3Rpb24oKXtyZXR1cm4gN319KS5hfSkpLEVlPUksVGU9ayxrZT14LHhlPVUsRmU9WSxDZT13ZSxOZT0kdCxNZT1JZSxSZT1PYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yO1AuZj1FZT9SZTpmdW5jdGlvbih0LGUpe2lmKHQ9RmUodCksZT1DZShlKSxNZSl0cnl7cmV0dXJuIFJlKHQsZSl9Y2F0Y2gobil7fWlmKE5lKHQsZSkpcmV0dXJuIHhlKCFUZShrZS5mLHQsZSksdFtlXSl9O3ZhciBVZT1pLERlPUEsX2U9LyN8XC5wcm90b3R5cGVcLi8sR2U9ZnVuY3Rpb24odCxlKXt2YXIgbj1CZVtIZSh0KV07cmV0dXJuIG49PT1XZXx8biE9PVZlJiYoRGUoZSk/VWUoZSk6ISFlKX0sSGU9R2Uubm9ybWFsaXplPWZ1bmN0aW9uKHQpe3JldHVybiBTdHJpbmcodCkucmVwbGFjZShfZSwiLiIpLnRvTG93ZXJDYXNlKCl9LEJlPUdlLmRhdGE9e30sVmU9R2UuTkFUSVZFPSJOIixXZT1HZS5QT0xZRklMTD0iUCIsemU9R2UsS2U9VHQscWU9dSxKZT1MKEwuYmluZCksWWU9ZnVuY3Rpb24odCxlKXtyZXR1cm4gS2UodCksdm9pZCAwPT09ZT90OnFlP0plKHQsZSk6ZnVuY3Rpb24oKXtyZXR1cm4gdC5hcHBseShlLGFyZ3VtZW50cyl9fSxYZT17fSwkZT1JJiZpKChmdW5jdGlvbigpe3JldHVybiA0MiE9PU9iamVjdC5kZWZpbmVQcm9wZXJ0eSgoZnVuY3Rpb24oKXt9KSwicHJvdG90eXBlIix7dmFsdWU6NDIsd3JpdGFibGU6ITF9KS5wcm90b3R5cGV9KSksUWU9JCxaZT1TdHJpbmcsdG49VHlwZUVycm9yLGVuPWZ1bmN0aW9uKHQpe2lmKFFlKHQpKXJldHVybiB0O3Rocm93IG5ldyB0bihaZSh0KSsiIGlzIG5vdCBhbiBvYmplY3QiKX0sbm49SSxybj1JZSxvbj0kZSx1bj1lbixhbj13ZSxjbj1UeXBlRXJyb3Isc249T2JqZWN0LmRlZmluZVByb3BlcnR5LGZuPU9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IsbG49ImVudW1lcmFibGUiLHluPSJjb25maWd1cmFibGUiLHBuPSJ3cml0YWJsZSI7WGUuZj1ubj9vbj9mdW5jdGlvbih0LGUsbil7aWYodW4odCksZT1hbihlKSx1bihuKSwiZnVuY3Rpb24iPT10eXBlb2YgdCYmInByb3RvdHlwZSI9PT1lJiYidmFsdWUiaW4gbiYmcG4gaW4gbiYmIW5bcG5dKXt2YXIgcj1mbih0LGUpO3ImJnJbcG5dJiYodFtlXT1uLnZhbHVlLG49e2NvbmZpZ3VyYWJsZTp5biBpbiBuP25beW5dOnJbeW5dLGVudW1lcmFibGU6bG4gaW4gbj9uW2xuXTpyW2xuXSx3cml0YWJsZTohMX0pfXJldHVybiBzbih0LGUsbil9OnNuOmZ1bmN0aW9uKHQsZSxuKXtpZih1bih0KSxlPWFuKGUpLHVuKG4pLHJuKXRyeXtyZXR1cm4gc24odCxlLG4pfWNhdGNoKHIpe31pZigiZ2V0ImluIG58fCJzZXQiaW4gbil0aHJvdyBuZXcgY24oIkFjY2Vzc29ycyBub3Qgc3VwcG9ydGVkIik7cmV0dXJuInZhbHVlImluIG4mJih0W2VdPW4udmFsdWUpLHR9O3ZhciBobj1YZSxnbj1VLGRuPUk/ZnVuY3Rpb24odCxlLG4pe3JldHVybiBobi5mKHQsZSxnbigxLG4pKX06ZnVuY3Rpb24odCxlLG4pe3JldHVybiB0W2VdPW4sdH0sYm49byx2bj1sLG1uPUwsU249QSx3bj1QLmYsT249emUsTG49USxqbj1ZZSxBbj1kbixQbj0kdCxJbj1mdW5jdGlvbih0KXt2YXIgZT1mdW5jdGlvbihuLHIsbyl7aWYodGhpcyBpbnN0YW5jZW9mIGUpe3N3aXRjaChhcmd1bWVudHMubGVuZ3RoKXtjYXNlIDA6cmV0dXJuIG5ldyB0O2Nhc2UgMTpyZXR1cm4gbmV3IHQobik7Y2FzZSAyOnJldHVybiBuZXcgdChuLHIpfXJldHVybiBuZXcgdChuLHIsbyl9cmV0dXJuIHZuKHQsdGhpcyxhcmd1bWVudHMpfTtyZXR1cm4gZS5wcm90b3R5cGU9dC5wcm90b3R5cGUsZX0sRW49ZnVuY3Rpb24odCxlKXt2YXIgbixyLG8saSx1LGEsYyxzLGYsbD10LnRhcmdldCx5PXQuZ2xvYmFsLHA9dC5zdGF0LGg9dC5wcm90byxnPXk/Ym46cD9ibltsXTpibltsXSYmYm5bbF0ucHJvdG90eXBlLGQ9eT9MbjpMbltsXXx8QW4oTG4sbCx7fSlbbF0sYj1kLnByb3RvdHlwZTtmb3IoaSBpbiBlKXI9IShuPU9uKHk/aTpsKyhwPyIuIjoiIyIpK2ksdC5mb3JjZWQpKSYmZyYmUG4oZyxpKSxhPWRbaV0sciYmKGM9dC5kb250Q2FsbEdldFNldD8oZj13bihnLGkpKSYmZi52YWx1ZTpnW2ldKSx1PXImJmM/YzplW2ldLChufHxofHx0eXBlb2YgYSE9dHlwZW9mIHUpJiYocz10LmJpbmQmJnI/am4odSxibik6dC53cmFwJiZyP0luKHUpOmgmJlNuKHUpP21uKHUpOnUsKHQuc2hhbXx8dSYmdS5zaGFtfHxhJiZhLnNoYW0pJiZBbihzLCJzaGFtIiwhMCksQW4oZCxpLHMpLGgmJihQbihMbixvPWwrIlByb3RvdHlwZSIpfHxBbihMbixvLHt9KSxBbihMbltvXSxpLHUpLHQucmVhbCYmYiYmKG58fCFiW2ldKSYmQW4oYixpLHUpKSl9LFRuPUVuLGtuPUkseG49WGUuZjtUbih7dGFyZ2V0OiJPYmplY3QiLHN0YXQ6ITAsZm9yY2VkOk9iamVjdC5kZWZpbmVQcm9wZXJ0eSE9PXhuLHNoYW06IWtufSx7ZGVmaW5lUHJvcGVydHk6eG59KTt2YXIgRm49US5PYmplY3QsQ249bi5leHBvcnRzPWZ1bmN0aW9uKHQsZSxuKXtyZXR1cm4gRm4uZGVmaW5lUHJvcGVydHkodCxlLG4pfTtGbi5kZWZpbmVQcm9wZXJ0eS5zaGFtJiYoQ24uc2hhbT0hMCk7dmFyIE5uPWUobi5leHBvcnRzKSxNbj1TLFJuPUFycmF5LmlzQXJyYXl8fGZ1bmN0aW9uKHQpe3JldHVybiJBcnJheSI9PT1Nbih0KX0sVW49TWF0aC5jZWlsLERuPU1hdGguZmxvb3IsX249TWF0aC50cnVuY3x8ZnVuY3Rpb24odCl7dmFyIGU9K3Q7cmV0dXJuKGU+MD9EbjpVbikoZSl9LEduPWZ1bmN0aW9uKHQpe3ZhciBlPSt0O3JldHVybiBlIT1lfHwwPT09ZT8wOl9uKGUpfSxIbj1HbixCbj1NYXRoLm1pbixWbj1mdW5jdGlvbih0KXt2YXIgZT1Ibih0KTtyZXR1cm4gZT4wP0JuKGUsOTAwNzE5OTI1NDc0MDk5MSk6MH0sV249ZnVuY3Rpb24odCl7cmV0dXJuIFZuKHQubGVuZ3RoKX0sem49VHlwZUVycm9yLEtuPUkscW49WGUsSm49VSxZbj17fTtZbltsZSgidG9TdHJpbmdUYWciKV09InoiO3ZhciBYbj0iW29iamVjdCB6XSI9PT1TdHJpbmcoWW4pLCRuPVhuLFFuPUEsWm49Uyx0cj1sZSgidG9TdHJpbmdUYWciKSxlcj1PYmplY3QsbnI9IkFyZ3VtZW50cyI9PT1abihmdW5jdGlvbigpe3JldHVybiBhcmd1bWVudHN9KCkpLHJyPSRuP1puOmZ1bmN0aW9uKHQpe3ZhciBlLG4scjtyZXR1cm4gdm9pZCAwPT09dD8iVW5kZWZpbmVkIjpudWxsPT09dD8iTnVsbCI6InN0cmluZyI9PXR5cGVvZihuPWZ1bmN0aW9uKHQsZSl7dHJ5e3JldHVybiB0W2VdfWNhdGNoKG4pe319KGU9ZXIodCksdHIpKT9uOm5yP1puKGUpOiJPYmplY3QiPT09KHI9Wm4oZSkpJiZRbihlLmNhbGxlZSk/IkFyZ3VtZW50cyI6cn0sb3I9QSxpcj1WdCx1cj1kKEZ1bmN0aW9uLnRvU3RyaW5nKTtvcihpci5pbnNwZWN0U291cmNlKXx8KGlyLmluc3BlY3RTb3VyY2U9ZnVuY3Rpb24odCl7cmV0dXJuIHVyKHQpfSk7dmFyIGFyPWlyLmluc3BlY3RTb3VyY2UsY3I9ZCxzcj1pLGZyPUEsbHI9cnIseXI9YXIscHI9ZnVuY3Rpb24oKXt9LGhyPXJ0KCJSZWZsZWN0IiwiY29uc3RydWN0IiksZ3I9L15ccyooPzpjbGFzc3xmdW5jdGlvbilcYi8sZHI9Y3IoZ3IuZXhlYyksYnI9IWdyLnRlc3QocHIpLHZyPWZ1bmN0aW9uKHQpe2lmKCFmcih0KSlyZXR1cm4hMTt0cnl7cmV0dXJuIGhyKHByLFtdLHQpLCEwfWNhdGNoKGUpe3JldHVybiExfX0sbXI9ZnVuY3Rpb24odCl7aWYoIWZyKHQpKXJldHVybiExO3N3aXRjaChscih0KSl7Y2FzZSJBc3luY0Z1bmN0aW9uIjpjYXNlIkdlbmVyYXRvckZ1bmN0aW9uIjpjYXNlIkFzeW5jR2VuZXJhdG9yRnVuY3Rpb24iOnJldHVybiExfXRyeXtyZXR1cm4gYnJ8fCEhZHIoZ3IseXIodCkpfWNhdGNoKGUpe3JldHVybiEwfX07bXIuc2hhbT0hMDt2YXIgU3I9IWhyfHxzcigoZnVuY3Rpb24oKXt2YXIgdDtyZXR1cm4gdnIodnIuY2FsbCl8fCF2cihPYmplY3QpfHwhdnIoKGZ1bmN0aW9uKCl7dD0hMH0pKXx8dH0pKT9tcjp2cix3cj1SbixPcj1TcixMcj0kLGpyPWxlKCJzcGVjaWVzIiksQXI9QXJyYXksUHI9ZnVuY3Rpb24odCl7dmFyIGU7cmV0dXJuIHdyKHQpJiYoZT10LmNvbnN0cnVjdG9yLChPcihlKSYmKGU9PT1Bcnx8d3IoZS5wcm90b3R5cGUpKXx8THIoZSkmJm51bGw9PT0oZT1lW2pyXSkpJiYoZT12b2lkIDApKSx2b2lkIDA9PT1lP0FyOmV9LElyPWZ1bmN0aW9uKHQsZSl7cmV0dXJuIG5ldyhQcih0KSkoMD09PWU/MDplKX0sRXI9aSxUcj1wdCxrcj1sZSgic3BlY2llcyIpLHhyPUVuLEZyPWksQ3I9Um4sTnI9JCxNcj1KdCxScj1XbixVcj1mdW5jdGlvbih0KXtpZih0PjkwMDcxOTkyNTQ3NDA5OTEpdGhyb3cgem4oIk1heGltdW0gYWxsb3dlZCBpbmRleCBleGNlZWRlZCIpO3JldHVybiB0fSxEcj1mdW5jdGlvbih0LGUsbil7S24/cW4uZih0LGUsSm4oMCxuKSk6dFtlXT1ufSxfcj1JcixHcj1mdW5jdGlvbih0KXtyZXR1cm4gVHI+PTUxfHwhRXIoKGZ1bmN0aW9uKCl7dmFyIGU9W107cmV0dXJuKGUuY29uc3RydWN0b3I9e30pW2tyXT1mdW5jdGlvbigpe3JldHVybntmb286MX19LDEhPT1lW3RdKEJvb2xlYW4pLmZvb30pKX0sSHI9cHQsQnI9bGUoImlzQ29uY2F0U3ByZWFkYWJsZSIpLFZyPUhyPj01MXx8IUZyKChmdW5jdGlvbigpe3ZhciB0PVtdO3JldHVybiB0W0JyXT0hMSx0LmNvbmNhdCgpWzBdIT09dH0pKSxXcj1mdW5jdGlvbih0KXtpZighTnIodCkpcmV0dXJuITE7dmFyIGU9dFtCcl07cmV0dXJuIHZvaWQgMCE9PWU/ISFlOkNyKHQpfTt4cih7dGFyZ2V0OiJBcnJheSIscHJvdG86ITAsYXJpdHk6MSxmb3JjZWQ6IVZyfHwhR3IoImNvbmNhdCIpfSx7Y29uY2F0OmZ1bmN0aW9uKHQpe3ZhciBlLG4scixvLGksdT1Ncih0aGlzKSxhPV9yKHUsMCksYz0wO2ZvcihlPS0xLHI9YXJndW1lbnRzLmxlbmd0aDtlPHI7ZSsrKWlmKFdyKGk9LTE9PT1lP3U6YXJndW1lbnRzW2VdKSlmb3Iobz1ScihpKSxVcihjK28pLG49MDtuPG87bisrLGMrKyluIGluIGkmJkRyKGEsYyxpW25dKTtlbHNlIFVyKGMrMSksRHIoYSxjKyssaSk7cmV0dXJuIGEubGVuZ3RoPWMsYX19KTt2YXIgenI9cnIsS3I9U3RyaW5nLHFyPWZ1bmN0aW9uKHQpe2lmKCJTeW1ib2wiPT09enIodCkpdGhyb3cgbmV3IFR5cGVFcnJvcigiQ2Fubm90IGNvbnZlcnQgYSBTeW1ib2wgdmFsdWUgdG8gYSBzdHJpbmciKTtyZXR1cm4gS3IodCl9LEpyPXt9LFlyPUduLFhyPU1hdGgubWF4LCRyPU1hdGgubWluLFFyPVksWnI9ZnVuY3Rpb24odCxlKXt2YXIgbj1Zcih0KTtyZXR1cm4gbjwwP1hyKG4rZSwwKTokcihuLGUpfSx0bz1Xbixlbz1mdW5jdGlvbih0KXtyZXR1cm4gZnVuY3Rpb24oZSxuLHIpe3ZhciBvPVFyKGUpLGk9dG8obyk7aWYoMD09PWkpcmV0dXJuIXQmJi0xO3ZhciB1LGE9WnIocixpKTtpZih0JiZuIT1uKXtmb3IoO2k+YTspaWYoKHU9b1thKytdKSE9dSlyZXR1cm4hMH1lbHNlIGZvcig7aT5hO2ErKylpZigodHx8YSBpbiBvKSYmb1thXT09PW4pcmV0dXJuIHR8fGF8fDA7cmV0dXJuIXQmJi0xfX0sbm89e2luY2x1ZGVzOmVvKCEwKSxpbmRleE9mOmVvKCExKX0scm89e30sb289JHQsaW89WSx1bz1uby5pbmRleE9mLGFvPXJvLGNvPWQoW10ucHVzaCksc289ZnVuY3Rpb24odCxlKXt2YXIgbixyPWlvKHQpLG89MCxpPVtdO2ZvcihuIGluIHIpIW9vKGFvLG4pJiZvbyhyLG4pJiZjbyhpLG4pO2Zvcig7ZS5sZW5ndGg+bzspb28ocixuPWVbbysrXSkmJih+dW8oaSxuKXx8Y28oaSxuKSk7cmV0dXJuIGl9LGZvPVsiY29uc3RydWN0b3IiLCJoYXNPd25Qcm9wZXJ0eSIsImlzUHJvdG90eXBlT2YiLCJwcm9wZXJ0eUlzRW51bWVyYWJsZSIsInRvTG9jYWxlU3RyaW5nIiwidG9TdHJpbmciLCJ2YWx1ZU9mIl0sbG89c28seW89Zm8scG89T2JqZWN0LmtleXN8fGZ1bmN0aW9uKHQpe3JldHVybiBsbyh0LHlvKX0saG89SSxnbz0kZSxibz1YZSx2bz1lbixtbz1ZLFNvPXBvO0pyLmY9aG8mJiFnbz9PYmplY3QuZGVmaW5lUHJvcGVydGllczpmdW5jdGlvbih0LGUpe3ZvKHQpO2Zvcih2YXIgbixyPW1vKGUpLG89U28oZSksaT1vLmxlbmd0aCx1PTA7aT51Oyliby5mKHQsbj1vW3UrK10scltuXSk7cmV0dXJuIHR9O3ZhciB3byxPbz1ydCgiZG9jdW1lbnQiLCJkb2N1bWVudEVsZW1lbnQiKSxMbz1uZSxqbz16dCgia2V5cyIpLEFvPWZ1bmN0aW9uKHQpe3JldHVybiBqb1t0XXx8KGpvW3RdPUxvKHQpKX0sUG89ZW4sSW89SnIsRW89Zm8sVG89cm8sa289T28seG89QWUsRm89InByb3RvdHlwZSIsQ289InNjcmlwdCIsTm89QW8oIklFX1BST1RPIiksTW89ZnVuY3Rpb24oKXt9LFJvPWZ1bmN0aW9uKHQpe3JldHVybiI8IitDbysiPiIrdCsiPC8iK0NvKyI+In0sVW89ZnVuY3Rpb24odCl7dC53cml0ZShSbygiIikpLHQuY2xvc2UoKTt2YXIgZT10LnBhcmVudFdpbmRvdy5PYmplY3Q7cmV0dXJuIHQ9bnVsbCxlfSxEbz1mdW5jdGlvbigpe3RyeXt3bz1uZXcgQWN0aXZlWE9iamVjdCgiaHRtbGZpbGUiKX1jYXRjaChvKXt9dmFyIHQsZSxuO0RvPSJ1bmRlZmluZWQiIT10eXBlb2YgZG9jdW1lbnQ/ZG9jdW1lbnQuZG9tYWluJiZ3bz9Vbyh3byk6KGU9eG8oImlmcmFtZSIpLG49ImphdmEiK0NvKyI6IixlLnN0eWxlLmRpc3BsYXk9Im5vbmUiLGtvLmFwcGVuZENoaWxkKGUpLGUuc3JjPVN0cmluZyhuKSwodD1lLmNvbnRlbnRXaW5kb3cuZG9jdW1lbnQpLm9wZW4oKSx0LndyaXRlKFJvKCJkb2N1bWVudC5GPU9iamVjdCIpKSx0LmNsb3NlKCksdC5GKTpVbyh3byk7Zm9yKHZhciByPUVvLmxlbmd0aDtyLS07KWRlbGV0ZSBEb1tGb11bRW9bcl1dO3JldHVybiBEbygpfTtUb1tOb109ITA7dmFyIF9vPU9iamVjdC5jcmVhdGV8fGZ1bmN0aW9uKHQsZSl7dmFyIG47cmV0dXJuIG51bGwhPT10PyhNb1tGb109UG8odCksbj1uZXcgTW8sTW9bRm9dPW51bGwsbltOb109dCk6bj1EbygpLHZvaWQgMD09PWU/bjpJby5mKG4sZSl9LEdvPXt9LEhvPXNvLEJvPWZvLmNvbmNhdCgibGVuZ3RoIiwicHJvdG90eXBlIik7R28uZj1PYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lc3x8ZnVuY3Rpb24odCl7cmV0dXJuIEhvKHQsQm8pfTt2YXIgVm89e30sV289ZChbXS5zbGljZSksem89UyxLbz1ZLHFvPUdvLmYsSm89V28sWW89Im9iamVjdCI9PXR5cGVvZiB3aW5kb3cmJndpbmRvdyYmT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXM/T2JqZWN0LmdldE93blByb3BlcnR5TmFtZXMod2luZG93KTpbXTtWby5mPWZ1bmN0aW9uKHQpe3JldHVybiBZbyYmIldpbmRvdyI9PT16byh0KT9mdW5jdGlvbih0KXt0cnl7cmV0dXJuIHFvKHQpfWNhdGNoKGUpe3JldHVybiBKbyhZbyl9fSh0KTpxbyhLbyh0KSl9O3ZhciBYbz17fTtYby5mPU9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHM7dmFyICRvPWRuLFFvPWZ1bmN0aW9uKHQsZSxuLHIpe3JldHVybiByJiZyLmVudW1lcmFibGU/dFtlXT1uOiRvKHQsZSxuKSx0fSxabz1YZSx0aT17fSxlaT1sZTt0aS5mPWVpO3ZhciBuaSxyaSxvaSxpaT1RLHVpPSR0LGFpPXRpLGNpPVhlLmYsc2k9ZnVuY3Rpb24odCl7dmFyIGU9aWkuU3ltYm9sfHwoaWkuU3ltYm9sPXt9KTt1aShlLHQpfHxjaShlLHQse3ZhbHVlOmFpLmYodCl9KX0sZmk9ayxsaT1ydCx5aT1sZSxwaT1RbyxoaT1mdW5jdGlvbigpe3ZhciB0PWxpKCJTeW1ib2wiKSxlPXQmJnQucHJvdG90eXBlLG49ZSYmZS52YWx1ZU9mLHI9eWkoInRvUHJpbWl0aXZlIik7ZSYmIWVbcl0mJnBpKGUsciwoZnVuY3Rpb24odCl7cmV0dXJuIGZpKG4sdGhpcyl9KSx7YXJpdHk6MX0pfSxnaT1ycixkaT1Ybj97fS50b1N0cmluZzpmdW5jdGlvbigpe3JldHVybiJbb2JqZWN0ICIrZ2kodGhpcykrIl0ifSxiaT1Ybix2aT1YZS5mLG1pPWRuLFNpPSR0LHdpPWRpLE9pPWxlKCJ0b1N0cmluZ1RhZyIpLExpPWZ1bmN0aW9uKHQsZSxuLHIpe3ZhciBvPW4/dDp0JiZ0LnByb3RvdHlwZTtvJiYoU2kobyxPaSl8fHZpKG8sT2kse2NvbmZpZ3VyYWJsZTohMCx2YWx1ZTplfSksciYmIWJpJiZtaShvLCJ0b1N0cmluZyIsd2kpKX0samk9QSxBaT1vLldlYWtNYXAsUGk9amkoQWkpJiYvbmF0aXZlIGNvZGUvLnRlc3QoU3RyaW5nKEFpKSksSWk9byxFaT0kLFRpPWRuLGtpPSR0LHhpPVZ0LEZpPUFvLENpPXJvLE5pPSJPYmplY3QgYWxyZWFkeSBpbml0aWFsaXplZCIsTWk9SWkuVHlwZUVycm9yLFJpPUlpLldlYWtNYXA7aWYoUGl8fHhpLnN0YXRlKXt2YXIgVWk9eGkuc3RhdGV8fCh4aS5zdGF0ZT1uZXcgUmkpO1VpLmdldD1VaS5nZXQsVWkuaGFzPVVpLmhhcyxVaS5zZXQ9VWkuc2V0LG5pPWZ1bmN0aW9uKHQsZSl7aWYoVWkuaGFzKHQpKXRocm93IG5ldyBNaShOaSk7cmV0dXJuIGUuZmFjYWRlPXQsVWkuc2V0KHQsZSksZX0scmk9ZnVuY3Rpb24odCl7cmV0dXJuIFVpLmdldCh0KXx8e319LG9pPWZ1bmN0aW9uKHQpe3JldHVybiBVaS5oYXModCl9fWVsc2V7dmFyIERpPUZpKCJzdGF0ZSIpO0NpW0RpXT0hMCxuaT1mdW5jdGlvbih0LGUpe2lmKGtpKHQsRGkpKXRocm93IG5ldyBNaShOaSk7cmV0dXJuIGUuZmFjYWRlPXQsVGkodCxEaSxlKSxlfSxyaT1mdW5jdGlvbih0KXtyZXR1cm4ga2kodCxEaSk/dFtEaV06e319LG9pPWZ1bmN0aW9uKHQpe3JldHVybiBraSh0LERpKX19dmFyIF9pPXtzZXQ6bmksZ2V0OnJpLGhhczpvaSxlbmZvcmNlOmZ1bmN0aW9uKHQpe3JldHVybiBvaSh0KT9yaSh0KTpuaSh0LHt9KX0sZ2V0dGVyRm9yOmZ1bmN0aW9uKHQpe3JldHVybiBmdW5jdGlvbihlKXt2YXIgbjtpZighRWkoZSl8fChuPXJpKGUpKS50eXBlIT09dCl0aHJvdyBuZXcgTWkoIkluY29tcGF0aWJsZSByZWNlaXZlciwgIit0KyIgcmVxdWlyZWQiKTtyZXR1cm4gbn19fSxHaT1ZZSxIaT1CLEJpPUp0LFZpPVduLFdpPUlyLHppPWQoW10ucHVzaCksS2k9ZnVuY3Rpb24odCl7dmFyIGU9MT09PXQsbj0yPT09dCxyPTM9PT10LG89ND09PXQsaT02PT09dCx1PTc9PT10LGE9NT09PXR8fGk7cmV0dXJuIGZ1bmN0aW9uKGMscyxmLGwpe2Zvcih2YXIgeSxwLGg9QmkoYyksZz1IaShoKSxkPVZpKGcpLGI9R2kocyxmKSx2PTAsbT1sfHxXaSxTPWU/bShjLGQpOm58fHU/bShjLDApOnZvaWQgMDtkPnY7disrKWlmKChhfHx2IGluIGcpJiYocD1iKHk9Z1t2XSx2LGgpLHQpKWlmKGUpU1t2XT1wO2Vsc2UgaWYocClzd2l0Y2godCl7Y2FzZSAzOnJldHVybiEwO2Nhc2UgNTpyZXR1cm4geTtjYXNlIDY6cmV0dXJuIHY7Y2FzZSAyOnppKFMseSl9ZWxzZSBzd2l0Y2godCl7Y2FzZSA0OnJldHVybiExO2Nhc2UgNzp6aShTLHkpfXJldHVybiBpPy0xOnJ8fG8/bzpTfX0scWk9e2ZvckVhY2g6S2koMCksbWFwOktpKDEpLGZpbHRlcjpLaSgyKSxzb21lOktpKDMpLGV2ZXJ5OktpKDQpLGZpbmQ6S2koNSksZmluZEluZGV4OktpKDYpLGZpbHRlclJlamVjdDpLaSg3KX0sSmk9RW4sWWk9byxYaT1rLCRpPWQsUWk9SSxaaT1idCx0dT1pLGV1PSR0LG51PW90LHJ1PWVuLG91PVksaXU9d2UsdXU9cXIsYXU9VSxjdT1fbyxzdT1wbyxmdT1HbyxsdT1Wbyx5dT1YbyxwdT1QLGh1PVhlLGd1PUpyLGR1PXgsYnU9UW8sdnU9ZnVuY3Rpb24odCxlLG4pe3JldHVybiBaby5mKHQsZSxuKX0sbXU9enQsU3U9cm8sd3U9bmUsT3U9bGUsTHU9dGksanU9c2ksQXU9aGksUHU9TGksSXU9X2ksRXU9cWkuZm9yRWFjaCxUdT1BbygiaGlkZGVuIiksa3U9IlN5bWJvbCIseHU9InByb3RvdHlwZSIsRnU9SXUuc2V0LEN1PUl1LmdldHRlckZvcihrdSksTnU9T2JqZWN0W3h1XSxNdT1ZaS5TeW1ib2wsUnU9TXUmJk11W3h1XSxVdT1ZaS5SYW5nZUVycm9yLER1PVlpLlR5cGVFcnJvcixfdT1ZaS5RT2JqZWN0LEd1PXB1LmYsSHU9aHUuZixCdT1sdS5mLFZ1PWR1LmYsV3U9JGkoW10ucHVzaCksenU9bXUoInN5bWJvbHMiKSxLdT1tdSgib3Atc3ltYm9scyIpLHF1PW11KCJ3a3MiKSxKdT0hX3V8fCFfdVt4dV18fCFfdVt4dV0uZmluZENoaWxkLFl1PWZ1bmN0aW9uKHQsZSxuKXt2YXIgcj1HdShOdSxlKTtyJiZkZWxldGUgTnVbZV0sSHUodCxlLG4pLHImJnQhPT1OdSYmSHUoTnUsZSxyKX0sWHU9UWkmJnR1KChmdW5jdGlvbigpe3JldHVybiA3IT09Y3UoSHUoe30sImEiLHtnZXQ6ZnVuY3Rpb24oKXtyZXR1cm4gSHUodGhpcywiYSIse3ZhbHVlOjd9KS5hfX0pKS5hfSkpP1l1Okh1LCR1PWZ1bmN0aW9uKHQsZSl7dmFyIG49enVbdF09Y3UoUnUpO3JldHVybiBGdShuLHt0eXBlOmt1LHRhZzp0LGRlc2NyaXB0aW9uOmV9KSxRaXx8KG4uZGVzY3JpcHRpb249ZSksbn0sUXU9ZnVuY3Rpb24odCxlLG4pe3Q9PT1OdSYmUXUoS3UsZSxuKSxydSh0KTt2YXIgcj1pdShlKTtyZXR1cm4gcnUobiksZXUoenUscik/KG4uZW51bWVyYWJsZT8oZXUodCxUdSkmJnRbVHVdW3JdJiYodFtUdV1bcl09ITEpLG49Y3Uobix7ZW51bWVyYWJsZTphdSgwLCExKX0pKTooZXUodCxUdSl8fEh1KHQsVHUsYXUoMSxjdShudWxsKSkpLHRbVHVdW3JdPSEwKSxYdSh0LHIsbikpOkh1KHQscixuKX0sWnU9ZnVuY3Rpb24odCxlKXtydSh0KTt2YXIgbj1vdShlKSxyPXN1KG4pLmNvbmNhdChyYShuKSk7cmV0dXJuIEV1KHIsKGZ1bmN0aW9uKGUpe1FpJiYhWGkodGEsbixlKXx8UXUodCxlLG5bZV0pfSkpLHR9LHRhPWZ1bmN0aW9uKHQpe3ZhciBlPWl1KHQpLG49WGkoVnUsdGhpcyxlKTtyZXR1cm4hKHRoaXM9PT1OdSYmZXUoenUsZSkmJiFldShLdSxlKSkmJighKG58fCFldSh0aGlzLGUpfHwhZXUoenUsZSl8fGV1KHRoaXMsVHUpJiZ0aGlzW1R1XVtlXSl8fG4pfSxlYT1mdW5jdGlvbih0LGUpe3ZhciBuPW91KHQpLHI9aXUoZSk7aWYobiE9PU51fHwhZXUoenUscil8fGV1KEt1LHIpKXt2YXIgbz1HdShuLHIpO3JldHVybiFvfHwhZXUoenUscil8fGV1KG4sVHUpJiZuW1R1XVtyXXx8KG8uZW51bWVyYWJsZT0hMCksb319LG5hPWZ1bmN0aW9uKHQpe3ZhciBlPUJ1KG91KHQpKSxuPVtdO3JldHVybiBFdShlLChmdW5jdGlvbih0KXtldSh6dSx0KXx8ZXUoU3UsdCl8fFd1KG4sdCl9KSksbn0scmE9ZnVuY3Rpb24odCl7dmFyIGU9dD09PU51LG49QnUoZT9LdTpvdSh0KSkscj1bXTtyZXR1cm4gRXUobiwoZnVuY3Rpb24odCl7IWV1KHp1LHQpfHxlJiYhZXUoTnUsdCl8fFd1KHIsenVbdF0pfSkpLHJ9O1ppfHwoTXU9ZnVuY3Rpb24oKXtpZihudShSdSx0aGlzKSl0aHJvdyBuZXcgRHUoIlN5bWJvbCBpcyBub3QgYSBjb25zdHJ1Y3RvciIpO3ZhciB0PWFyZ3VtZW50cy5sZW5ndGgmJnZvaWQgMCE9PWFyZ3VtZW50c1swXT91dShhcmd1bWVudHNbMF0pOnZvaWQgMCxlPXd1KHQpLG49ZnVuY3Rpb24odCl7dmFyIHI9dm9pZCAwPT09dGhpcz9ZaTp0aGlzO3I9PT1OdSYmWGkobixLdSx0KSxldShyLFR1KSYmZXUocltUdV0sZSkmJihyW1R1XVtlXT0hMSk7dmFyIG89YXUoMSx0KTt0cnl7WHUocixlLG8pfWNhdGNoKGkpe2lmKCEoaSBpbnN0YW5jZW9mIFV1KSl0aHJvdyBpO1l1KHIsZSxvKX19O3JldHVybiBRaSYmSnUmJlh1KE51LGUse2NvbmZpZ3VyYWJsZTohMCxzZXQ6bn0pLCR1KGUsdCl9LGJ1KFJ1PU11W3h1XSwidG9TdHJpbmciLChmdW5jdGlvbigpe3JldHVybiBDdSh0aGlzKS50YWd9KSksYnUoTXUsIndpdGhvdXRTZXR0ZXIiLChmdW5jdGlvbih0KXtyZXR1cm4gJHUod3UodCksdCl9KSksZHUuZj10YSxodS5mPVF1LGd1LmY9WnUscHUuZj1lYSxmdS5mPWx1LmY9bmEseXUuZj1yYSxMdS5mPWZ1bmN0aW9uKHQpe3JldHVybiAkdShPdSh0KSx0KX0sUWkmJnZ1KFJ1LCJkZXNjcmlwdGlvbiIse2NvbmZpZ3VyYWJsZTohMCxnZXQ6ZnVuY3Rpb24oKXtyZXR1cm4gQ3UodGhpcykuZGVzY3JpcHRpb259fSkpLEppKHtnbG9iYWw6ITAsY29uc3RydWN0b3I6ITAsd3JhcDohMCxmb3JjZWQ6IVppLHNoYW06IVppfSx7U3ltYm9sOk11fSksRXUoc3UocXUpLChmdW5jdGlvbih0KXtqdSh0KX0pKSxKaSh7dGFyZ2V0Omt1LHN0YXQ6ITAsZm9yY2VkOiFaaX0se3VzZVNldHRlcjpmdW5jdGlvbigpe0p1PSEwfSx1c2VTaW1wbGU6ZnVuY3Rpb24oKXtKdT0hMX19KSxKaSh7dGFyZ2V0OiJPYmplY3QiLHN0YXQ6ITAsZm9yY2VkOiFaaSxzaGFtOiFRaX0se2NyZWF0ZTpmdW5jdGlvbih0LGUpe3JldHVybiB2b2lkIDA9PT1lP2N1KHQpOlp1KGN1KHQpLGUpfSxkZWZpbmVQcm9wZXJ0eTpRdSxkZWZpbmVQcm9wZXJ0aWVzOlp1LGdldE93blByb3BlcnR5RGVzY3JpcHRvcjplYX0pLEppKHt0YXJnZXQ6Ik9iamVjdCIsc3RhdDohMCxmb3JjZWQ6IVppfSx7Z2V0T3duUHJvcGVydHlOYW1lczpuYX0pLEF1KCksUHUoTXUsa3UpLFN1W1R1XT0hMDt2YXIgb2E9YnQmJiEhU3ltYm9sLmZvciYmISFTeW1ib2wua2V5Rm9yLGlhPUVuLHVhPXJ0LGFhPSR0LGNhPXFyLHNhPXp0LGZhPW9hLGxhPXNhKCJzdHJpbmctdG8tc3ltYm9sLXJlZ2lzdHJ5IikseWE9c2EoInN5bWJvbC10by1zdHJpbmctcmVnaXN0cnkiKTtpYSh7dGFyZ2V0OiJTeW1ib2wiLHN0YXQ6ITAsZm9yY2VkOiFmYX0se2ZvcjpmdW5jdGlvbih0KXt2YXIgZT1jYSh0KTtpZihhYShsYSxlKSlyZXR1cm4gbGFbZV07dmFyIG49dWEoIlN5bWJvbCIpKGUpO3JldHVybiBsYVtlXT1uLHlhW25dPWUsbn19KTt2YXIgcGE9RW4saGE9JHQsZ2E9THQsZGE9QXQsYmE9b2EsdmE9enQoInN5bWJvbC10by1zdHJpbmctcmVnaXN0cnkiKTtwYSh7dGFyZ2V0OiJTeW1ib2wiLHN0YXQ6ITAsZm9yY2VkOiFiYX0se2tleUZvcjpmdW5jdGlvbih0KXtpZighZ2EodCkpdGhyb3cgbmV3IFR5cGVFcnJvcihkYSh0KSsiIGlzIG5vdCBhIHN5bWJvbCIpO2lmKGhhKHZhLHQpKXJldHVybiB2YVt0XX19KTt2YXIgbWE9Um4sU2E9QSx3YT1TLE9hPXFyLExhPWQoW10ucHVzaCksamE9RW4sQWE9cnQsUGE9bCxJYT1rLEVhPWQsVGE9aSxrYT1BLHhhPUx0LEZhPVdvLENhPWZ1bmN0aW9uKHQpe2lmKFNhKHQpKXJldHVybiB0O2lmKG1hKHQpKXtmb3IodmFyIGU9dC5sZW5ndGgsbj1bXSxyPTA7cjxlO3IrKyl7dmFyIG89dFtyXTsic3RyaW5nIj09dHlwZW9mIG8/TGEobixvKToibnVtYmVyIiE9dHlwZW9mIG8mJiJOdW1iZXIiIT09d2EobykmJiJTdHJpbmciIT09d2Eobyl8fExhKG4sT2EobykpfXZhciBpPW4ubGVuZ3RoLHU9ITA7cmV0dXJuIGZ1bmN0aW9uKHQsZSl7aWYodSlyZXR1cm4gdT0hMSxlO2lmKG1hKHRoaXMpKXJldHVybiBlO2Zvcih2YXIgcj0wO3I8aTtyKyspaWYobltyXT09PXQpcmV0dXJuIGV9fX0sTmE9YnQsTWE9U3RyaW5nLFJhPUFhKCJKU09OIiwic3RyaW5naWZ5IiksVWE9RWEoLy4vLmV4ZWMpLERhPUVhKCIiLmNoYXJBdCksX2E9RWEoIiIuY2hhckNvZGVBdCksR2E9RWEoIiIucmVwbGFjZSksSGE9RWEoMS4udG9TdHJpbmcpLEJhPS9bXHVEODAwLVx1REZGRl0vZyxWYT0vXltcdUQ4MDAtXHVEQkZGXSQvLFdhPS9eW1x1REMwMC1cdURGRkZdJC8semE9IU5hfHxUYSgoZnVuY3Rpb24oKXt2YXIgdD1BYSgiU3ltYm9sIikoInN0cmluZ2lmeSBkZXRlY3Rpb24iKTtyZXR1cm4iW251bGxdIiE9PVJhKFt0XSl8fCJ7fSIhPT1SYSh7YTp0fSl8fCJ7fSIhPT1SYShPYmplY3QodCkpfSkpLEthPVRhKChmdW5jdGlvbigpe3JldHVybiciXFx1ZGYwNlxcdWQ4MzQiJyE9PVJhKCJcdWRmMDZcdWQ4MzQiKXx8JyJcXHVkZWFkIichPT1SYSgiXHVkZWFkIil9KSkscWE9ZnVuY3Rpb24odCxlKXt2YXIgbj1GYShhcmd1bWVudHMpLHI9Q2EoZSk7aWYoa2Eocil8fHZvaWQgMCE9PXQmJiF4YSh0KSlyZXR1cm4gblsxXT1mdW5jdGlvbih0LGUpe2lmKGthKHIpJiYoZT1JYShyLHRoaXMsTWEodCksZSkpLCF4YShlKSlyZXR1cm4gZX0sUGEoUmEsbnVsbCxuKX0sSmE9ZnVuY3Rpb24odCxlLG4pe3ZhciByPURhKG4sZS0xKSxvPURhKG4sZSsxKTtyZXR1cm4gVWEoVmEsdCkmJiFVYShXYSxvKXx8VWEoV2EsdCkmJiFVYShWYSxyKT8iXFx1IitIYShfYSh0LDApLDE2KTp0fTtSYSYmamEoe3RhcmdldDoiSlNPTiIsc3RhdDohMCxhcml0eTozLGZvcmNlZDp6YXx8S2F9LHtzdHJpbmdpZnk6ZnVuY3Rpb24odCxlLG4pe3ZhciByPUZhKGFyZ3VtZW50cyksbz1QYSh6YT9xYTpSYSxudWxsLHIpO3JldHVybiBLYSYmInN0cmluZyI9PXR5cGVvZiBvP0dhKG8sQmEsSmEpOm99fSk7dmFyIFlhPVhvLFhhPUp0O0VuKHt0YXJnZXQ6Ik9iamVjdCIsc3RhdDohMCxmb3JjZWQ6IWJ0fHxpKChmdW5jdGlvbigpe1lhLmYoMSl9KSl9LHtnZXRPd25Qcm9wZXJ0eVN5bWJvbHM6ZnVuY3Rpb24odCl7dmFyIGU9WWEuZjtyZXR1cm4gZT9lKFhhKHQpKTpbXX19KSxzaSgiYXN5bmNJdGVyYXRvciIpLHNpKCJoYXNJbnN0YW5jZSIpLHNpKCJpc0NvbmNhdFNwcmVhZGFibGUiKSxzaSgiaXRlcmF0b3IiKSxzaSgibWF0Y2giKSxzaSgibWF0Y2hBbGwiKSxzaSgicmVwbGFjZSIpLHNpKCJzZWFyY2giKSxzaSgic3BlY2llcyIpLHNpKCJzcGxpdCIpO3ZhciAkYT1oaTtzaSgidG9QcmltaXRpdmUiKSwkYSgpO3ZhciBRYT1ydCxaYT1MaTtzaSgidG9TdHJpbmdUYWciKSxaYShRYSgiU3ltYm9sIiksIlN5bWJvbCIpLHNpKCJ1bnNjb3BhYmxlcyIpLExpKG8uSlNPTiwiSlNPTiIsITApO3ZhciB0YyxlYyxuYyxyYz1RLlN5bWJvbCxvYz17fSxpYz1JLHVjPSR0LGFjPUZ1bmN0aW9uLnByb3RvdHlwZSxjYz1pYyYmT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcixzYz11YyhhYywibmFtZSIpLGZjPXtFWElTVFM6c2MsUFJPUEVSOnNjJiYic29tZXRoaW5nIj09PWZ1bmN0aW9uKCl7fS5uYW1lLENPTkZJR1VSQUJMRTpzYyYmKCFpY3x8aWMmJmNjKGFjLCJuYW1lIikuY29uZmlndXJhYmxlKX0sbGM9IWkoKGZ1bmN0aW9uKCl7ZnVuY3Rpb24gdCgpe31yZXR1cm4gdC5wcm90b3R5cGUuY29uc3RydWN0b3I9bnVsbCxPYmplY3QuZ2V0UHJvdG90eXBlT2YobmV3IHQpIT09dC5wcm90b3R5cGV9KSkseWM9JHQscGM9QSxoYz1KdCxnYz1sYyxkYz1BbygiSUVfUFJPVE8iKSxiYz1PYmplY3QsdmM9YmMucHJvdG90eXBlLG1jPWdjP2JjLmdldFByb3RvdHlwZU9mOmZ1bmN0aW9uKHQpe3ZhciBlPWhjKHQpO2lmKHljKGUsZGMpKXJldHVybiBlW2RjXTt2YXIgbj1lLmNvbnN0cnVjdG9yO3JldHVybiBwYyhuKSYmZSBpbnN0YW5jZW9mIG4/bi5wcm90b3R5cGU6ZSBpbnN0YW5jZW9mIGJjP3ZjOm51bGx9LFNjPWksd2M9QSxPYz0kLExjPV9vLGpjPW1jLEFjPVFvLFBjPWxlKCJpdGVyYXRvciIpLEljPSExO1tdLmtleXMmJigibmV4dCJpbihuYz1bXS5rZXlzKCkpPyhlYz1qYyhqYyhuYykpKSE9PU9iamVjdC5wcm90b3R5cGUmJih0Yz1lYyk6SWM9ITApO3ZhciBFYz0hT2ModGMpfHxTYygoZnVuY3Rpb24oKXt2YXIgdD17fTtyZXR1cm4gdGNbUGNdLmNhbGwodCkhPT10fSkpO3djKCh0Yz1FYz97fTpMYyh0YykpW1BjXSl8fEFjKHRjLFBjLChmdW5jdGlvbigpe3JldHVybiB0aGlzfSkpO3ZhciBUYz17SXRlcmF0b3JQcm90b3R5cGU6dGMsQlVHR1lfU0FGQVJJX0lURVJBVE9SUzpJY30sa2M9VGMuSXRlcmF0b3JQcm90b3R5cGUseGM9X28sRmM9VSxDYz1MaSxOYz1vYyxNYz1mdW5jdGlvbigpe3JldHVybiB0aGlzfSxSYz1FbixVYz1rLERjPWZjLF9jPWZ1bmN0aW9uKHQsZSxuLHIpe3ZhciBvPWUrIiBJdGVyYXRvciI7cmV0dXJuIHQucHJvdG90eXBlPXhjKGtjLHtuZXh0OkZjKCshcixuKX0pLENjKHQsbywhMSwhMCksTmNbb109TWMsdH0sR2M9bWMsSGM9TGksQmM9UW8sVmM9b2MsV2M9VGMsemM9RGMuUFJPUEVSLEtjPVdjLkJVR0dZX1NBRkFSSV9JVEVSQVRPUlMscWM9bGUoIml0ZXJhdG9yIiksSmM9ImtleXMiLFljPSJ2YWx1ZXMiLFhjPSJlbnRyaWVzIiwkYz1mdW5jdGlvbigpe3JldHVybiB0aGlzfSxRYz1mdW5jdGlvbih0LGUsbixyLG8saSx1KXtfYyhuLGUscik7dmFyIGEsYyxzLGY9ZnVuY3Rpb24odCl7aWYodD09PW8mJmcpcmV0dXJuIGc7aWYoIUtjJiZ0JiZ0IGluIHApcmV0dXJuIHBbdF07c3dpdGNoKHQpe2Nhc2UgSmM6Y2FzZSBZYzpjYXNlIFhjOnJldHVybiBmdW5jdGlvbigpe3JldHVybiBuZXcgbih0aGlzLHQpfX1yZXR1cm4gZnVuY3Rpb24oKXtyZXR1cm4gbmV3IG4odGhpcyl9fSxsPWUrIiBJdGVyYXRvciIseT0hMSxwPXQucHJvdG90eXBlLGg9cFtxY118fHBbIkBAaXRlcmF0b3IiXXx8byYmcFtvXSxnPSFLYyYmaHx8ZihvKSxkPSJBcnJheSI9PT1lJiZwLmVudHJpZXN8fGg7aWYoZCYmKGE9R2MoZC5jYWxsKG5ldyB0KSkpIT09T2JqZWN0LnByb3RvdHlwZSYmYS5uZXh0JiYoSGMoYSxsLCEwLCEwKSxWY1tsXT0kYyksemMmJm89PT1ZYyYmaCYmaC5uYW1lIT09WWMmJih5PSEwLGc9ZnVuY3Rpb24oKXtyZXR1cm4gVWMoaCx0aGlzKX0pLG8paWYoYz17dmFsdWVzOmYoWWMpLGtleXM6aT9nOmYoSmMpLGVudHJpZXM6ZihYYyl9LHUpZm9yKHMgaW4gYykoS2N8fHl8fCEocyBpbiBwKSkmJkJjKHAscyxjW3NdKTtlbHNlIFJjKHt0YXJnZXQ6ZSxwcm90bzohMCxmb3JjZWQ6S2N8fHl9LGMpO3JldHVybiB1JiZwW3FjXSE9PWcmJkJjKHAscWMsZyx7bmFtZTpvfSksVmNbZV09ZyxjfSxaYz1mdW5jdGlvbih0LGUpe3JldHVybnt2YWx1ZTp0LGRvbmU6ZX19LHRzPVksZXM9b2MsbnM9X2k7WGUuZjt2YXIgcnM9UWMsb3M9WmMsaXM9IkFycmF5IEl0ZXJhdG9yIix1cz1ucy5zZXQsYXM9bnMuZ2V0dGVyRm9yKGlzKTtycyhBcnJheSwiQXJyYXkiLChmdW5jdGlvbih0LGUpe3VzKHRoaXMse3R5cGU6aXMsdGFyZ2V0OnRzKHQpLGluZGV4OjAsa2luZDplfSl9KSwoZnVuY3Rpb24oKXt2YXIgdD1hcyh0aGlzKSxlPXQudGFyZ2V0LG49dC5pbmRleCsrO2lmKCFlfHxuPj1lLmxlbmd0aClyZXR1cm4gdC50YXJnZXQ9bnVsbCxvcyh2b2lkIDAsITApO3N3aXRjaCh0LmtpbmQpe2Nhc2Uia2V5cyI6cmV0dXJuIG9zKG4sITEpO2Nhc2UidmFsdWVzIjpyZXR1cm4gb3MoZVtuXSwhMSl9cmV0dXJuIG9zKFtuLGVbbl1dLCExKX0pLCJ2YWx1ZXMiKSxlcy5Bcmd1bWVudHM9ZXMuQXJyYXk7dmFyIGNzPXtDU1NSdWxlTGlzdDowLENTU1N0eWxlRGVjbGFyYXRpb246MCxDU1NWYWx1ZUxpc3Q6MCxDbGllbnRSZWN0TGlzdDowLERPTVJlY3RMaXN0OjAsRE9NU3RyaW5nTGlzdDowLERPTVRva2VuTGlzdDoxLERhdGFUcmFuc2Zlckl0ZW1MaXN0OjAsRmlsZUxpc3Q6MCxIVE1MQWxsQ29sbGVjdGlvbjowLEhUTUxDb2xsZWN0aW9uOjAsSFRNTEZvcm1FbGVtZW50OjAsSFRNTFNlbGVjdEVsZW1lbnQ6MCxNZWRpYUxpc3Q6MCxNaW1lVHlwZUFycmF5OjAsTmFtZWROb2RlTWFwOjAsTm9kZUxpc3Q6MSxQYWludFJlcXVlc3RMaXN0OjAsUGx1Z2luOjAsUGx1Z2luQXJyYXk6MCxTVkdMZW5ndGhMaXN0OjAsU1ZHTnVtYmVyTGlzdDowLFNWR1BhdGhTZWdMaXN0OjAsU1ZHUG9pbnRMaXN0OjAsU1ZHU3RyaW5nTGlzdDowLFNWR1RyYW5zZm9ybUxpc3Q6MCxTb3VyY2VCdWZmZXJMaXN0OjAsU3R5bGVTaGVldExpc3Q6MCxUZXh0VHJhY2tDdWVMaXN0OjAsVGV4dFRyYWNrTGlzdDowLFRvdWNoTGlzdDowfSxzcz1vLGZzPUxpLGxzPW9jO2Zvcih2YXIgeXMgaW4gY3MpZnMoc3NbeXNdLHlzKSxsc1t5c109bHMuQXJyYXk7dmFyIHBzPXJjLGhzPWxlLGdzPVhlLmYsZHM9aHMoIm1ldGFkYXRhIiksYnM9RnVuY3Rpb24ucHJvdG90eXBlO3ZvaWQgMD09PWJzW2RzXSYmZ3MoYnMsZHMse3ZhbHVlOm51bGx9KSxzaSgiYXN5bmNEaXNwb3NlIiksc2koImRpc3Bvc2UiKSxzaSgibWV0YWRhdGEiKTt2YXIgdnM9cHMsbXM9ZCxTcz1ydCgiU3ltYm9sIiksd3M9U3Mua2V5Rm9yLE9zPW1zKFNzLnByb3RvdHlwZS52YWx1ZU9mKSxMcz1Tcy5pc1JlZ2lzdGVyZWRTeW1ib2x8fGZ1bmN0aW9uKHQpe3RyeXtyZXR1cm4gdm9pZCAwIT09d3MoT3ModCkpfWNhdGNoKGUpe3JldHVybiExfX07RW4oe3RhcmdldDoiU3ltYm9sIixzdGF0OiEwfSx7aXNSZWdpc3RlcmVkU3ltYm9sOkxzfSk7Zm9yKHZhciBqcz16dCxBcz1ydCxQcz1kLElzPUx0LEVzPWxlLFRzPUFzKCJTeW1ib2wiKSxrcz1Ucy5pc1dlbGxLbm93blN5bWJvbCx4cz1BcygiT2JqZWN0IiwiZ2V0T3duUHJvcGVydHlOYW1lcyIpLEZzPVBzKFRzLnByb3RvdHlwZS52YWx1ZU9mKSxDcz1qcygid2tzIiksTnM9MCxNcz14cyhUcyksUnM9TXMubGVuZ3RoO05zPFJzO05zKyspdHJ5e3ZhciBVcz1Nc1tOc107SXMoVHNbVXNdKSYmRXMoVXMpfWNhdGNoKGJmKXt9dmFyIERzPWZ1bmN0aW9uKHQpe2lmKGtzJiZrcyh0KSlyZXR1cm4hMDt0cnl7Zm9yKHZhciBlPUZzKHQpLG49MCxyPXhzKENzKSxvPXIubGVuZ3RoO248bztuKyspaWYoQ3NbcltuXV09PWUpcmV0dXJuITB9Y2F0Y2goYmYpe31yZXR1cm4hMX07RW4oe3RhcmdldDoiU3ltYm9sIixzdGF0OiEwLGZvcmNlZDohMH0se2lzV2VsbEtub3duU3ltYm9sOkRzfSksc2koImN1c3RvbU1hdGNoZXIiKSxzaSgib2JzZXJ2YWJsZSIpLEVuKHt0YXJnZXQ6IlN5bWJvbCIsc3RhdDohMCxuYW1lOiJpc1JlZ2lzdGVyZWRTeW1ib2wifSx7aXNSZWdpc3RlcmVkOkxzfSksRW4oe3RhcmdldDoiU3ltYm9sIixzdGF0OiEwLG5hbWU6ImlzV2VsbEtub3duU3ltYm9sIixmb3JjZWQ6ITB9LHtpc1dlbGxLbm93bjpEc30pLHNpKCJtYXRjaGVyIiksc2koIm1ldGFkYXRhS2V5Iiksc2koInBhdHRlcm5NYXRjaCIpLHNpKCJyZXBsYWNlQWxsIik7dmFyIF9zPWUodnMpLEdzPWQsSHM9R24sQnM9cXIsVnM9SyxXcz1HcygiIi5jaGFyQXQpLHpzPUdzKCIiLmNoYXJDb2RlQXQpLEtzPUdzKCIiLnNsaWNlKSxxcz1mdW5jdGlvbih0KXtyZXR1cm4gZnVuY3Rpb24oZSxuKXt2YXIgcixvLGk9QnMoVnMoZSkpLHU9SHMobiksYT1pLmxlbmd0aDtyZXR1cm4gdTwwfHx1Pj1hP3Q/IiI6dm9pZCAwOihyPXpzKGksdSkpPDU1Mjk2fHxyPjU2MzE5fHx1KzE9PT1hfHwobz16cyhpLHUrMSkpPDU2MzIwfHxvPjU3MzQzP3Q/V3MoaSx1KTpyOnQ/S3MoaSx1LHUrMik6by01NjMyMCsoci01NTI5Njw8MTApKzY1NTM2fX0sSnM9e2NvZGVBdDpxcyghMSksY2hhckF0OnFzKCEwKX0uY2hhckF0LFlzPXFyLFhzPV9pLCRzPVFjLFFzPVpjLFpzPSJTdHJpbmcgSXRlcmF0b3IiLHRmPVhzLnNldCxlZj1Ycy5nZXR0ZXJGb3IoWnMpOyRzKFN0cmluZywiU3RyaW5nIiwoZnVuY3Rpb24odCl7dGYodGhpcyx7dHlwZTpacyxzdHJpbmc6WXModCksaW5kZXg6MH0pfSksKGZ1bmN0aW9uKCl7dmFyIHQsZT1lZih0aGlzKSxuPWUuc3RyaW5nLHI9ZS5pbmRleDtyZXR1cm4gcj49bi5sZW5ndGg/UXModm9pZCAwLCEwKToodD1KcyhuLHIpLGUuaW5kZXgrPXQubGVuZ3RoLFFzKHQsITEpKX0pKTt2YXIgbmY9ZSh0aS5mKCJpdGVyYXRvciIpKTtmdW5jdGlvbiByZih0KXtyZXR1cm4ocmY9ImZ1bmN0aW9uIj09dHlwZW9mIF9zJiYic3ltYm9sIj09dHlwZW9mIG5mP2Z1bmN0aW9uKHQpe3JldHVybiB0eXBlb2YgdH06ZnVuY3Rpb24odCl7cmV0dXJuIHQmJiJmdW5jdGlvbiI9PXR5cGVvZiBfcyYmdC5jb25zdHJ1Y3Rvcj09PV9zJiZ0IT09X3MucHJvdG90eXBlPyJzeW1ib2wiOnR5cGVvZiB0fSkodCl9dmFyIG9mPWUodGkuZigidG9QcmltaXRpdmUiKSk7ZnVuY3Rpb24gdWYodCl7dmFyIGU9ZnVuY3Rpb24odCxlKXtpZigib2JqZWN0IiE9cmYodCl8fCF0KXJldHVybiB0O3ZhciBuPXRbb2ZdO2lmKHZvaWQgMCE9PW4pe3ZhciByPW4uY2FsbCh0LGV8fCJkZWZhdWx0Iik7aWYoIm9iamVjdCIhPXJmKHIpKXJldHVybiByO3Rocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIil9cmV0dXJuKCJzdHJpbmciPT09ZT9TdHJpbmc6TnVtYmVyKSh0KX0odCwic3RyaW5nIik7cmV0dXJuInN5bWJvbCI9PXJmKGUpP2U6ZSsiIn1mdW5jdGlvbiBhZih0LGUsbil7cmV0dXJuKGU9dWYoZSkpaW4gdD9Obih0LGUse3ZhbHVlOm4sZW51bWVyYWJsZTohMCxjb25maWd1cmFibGU6ITAsd3JpdGFibGU6ITB9KTp0W2VdPW4sdH1jb25zdCBjZj17Z2V0TkFMVW5pdHModCl7bGV0IGU9YXJndW1lbnRzLmxlbmd0aD4xJiZ2b2lkIDAhPT1hcmd1bWVudHNbMV0mJmFyZ3VtZW50c1sxXTtpZih0Lmxlbmd0aC10LnBvc2l0aW9uPDQpcmV0dXJuW107Y29uc3R7cG9zaXRpb246bn09dDtyZXR1cm4gMT09PXQuZ2V0SW50MzIobil8fDA9PT10LmdldEludDE2KG4pJiYxPT09dC5nZXRJbnQ4KG4rMik/Y2YuZ2V0QW5uZXhiTmFscyh0LGUpOmNmLmdldEF2Y2NOYWxzKHQsZSl9LGdldEFubmV4Yk5hbHModCxlKXtjb25zdCBuPVtdO2xldCByPWNmLmdldEhlYWRlclBvc2l0aW9uQW5uZXhCKHQpLG89ci5wb3MsaT1vO2Zvcig7bzx0Lmxlbmd0aC00Oyl7Y29uc3QgdT1uZXcgVWludDhBcnJheSh0LmJ1ZmZlci5zbGljZShvLG8rci5oZWFkZXJMZW5ndGgpKTtyLnBvcz09PXQucG9zaXRpb24mJnQuc2tpcChyLmhlYWRlckxlbmd0aCkscj1jZi5nZXRIZWFkZXJQb3NpdGlvbkFubmV4Qih0KSxpPXIucG9zO2NvbnN0IGE9e2hlYWRlcjp1LGJvZHk6bmV3IFVpbnQ4QXJyYXkodC5idWZmZXIuc2xpY2Uobyt1LmJ5dGVMZW5ndGgsaSkpLHR5cGU6LTF9O2U/Y2YuYW5hbHlzZUgyNjVOYWwoYSk6Y2YuYW5hbHlzZU5hbChhKSwoYS50eXBlPD05fHxlJiZhLnR5cGU8PTQwKSYmMCE9PWEudHlwZSYmbi5wdXNoKGEpLHQuc2tpcChpLXQucG9zaXRpb24pLG89aX1yZXR1cm4gbn0sZ2V0QXZjY05hbHModCxlKXtjb25zdCBuPVtdO2Zvcig7dC5wb3NpdGlvbjx0Lmxlbmd0aC00Oyl7Y29uc3Qgcj10LmdldEludDMyKHQucG9zaXRpb24pO2lmKCEodC5sZW5ndGgtdC5wb3NpdGlvbj49cikpYnJlYWs7e2NvbnN0IG89bmV3IFVpbnQ4QXJyYXkodC5idWZmZXIuc2xpY2UodC5wb3NpdGlvbix0LnBvc2l0aW9uKzQpKTt0LnNraXAoNCk7Y29uc3QgaT1uZXcgVWludDhBcnJheSh0LmJ1ZmZlci5zbGljZSh0LnBvc2l0aW9uLHQucG9zaXRpb24rcikpO3Quc2tpcChyKTtjb25zdCB1PXtoZWFkZXI6byxib2R5OmksdHlwZTotMX07ZT9jZi5hbmFseXNlSDI2NU5hbCh1KTpjZi5hbmFseXNlTmFsKHUpLHUudHlwZTw9OSYmMCE9PXUudHlwZSYmbi5wdXNoKHUpfX1yZXR1cm4gbn0sYW5hbHlzZU5hbCh0KXtjb25zdCBlPTMxJnQuYm9keVswXTtzd2l0Y2godC50eXBlPWUsZSl7Y2FzZSAxOnQubmRyPSEwO2JyZWFrO2Nhc2UgNTp0Lmlkcj0hMDticmVhaztjYXNlIDY6dC5zZWk9ITA7YnJlYWs7Y2FzZSA3OnQuc3BzPSEwO2JyZWFrO2Nhc2UgODp0LnBwcz0hMH19LGFuYWx5c2VIMjY1TmFsKHQpe2NvbnN0IGU9KDEyNiZ0LmJvZHlbMF0pPj4xO3N3aXRjaCh0LnR5cGU9ZSxlKXtjYXNlIDM5OmNhc2UgNDA6dC5zZWk9ITB9fSxnZXRIZWFkZXJQb3NpdGlvbkFubmV4Qih0KXtsZXQgZT10LnBvc2l0aW9uLG49MDtjb25zdCByPXQubGVuZ3RoO2Zvcig7MyE9PW4mJjQhPT1uJiZlPHItNDspMD09PXQuZ2V0SW50MTYoZSk/MT09PXQuZ2V0SW50MTYoZSsyKT9uPTQ6MT09PXQuZ2V0SW50OChlKzIpP249MzplKys6ZSsrO3JldHVybiBlPT09ci00JiYoMD09PXQuZ2V0SW50MTYoZSk/MT09PXQuZ2V0SW50MTYoZSsyKT9uPTQ6ZT1yOihlKyssMD09PXQuZ2V0SW50MTYoZSkmJjE9PT10LmdldEludDgoZSk/bj0zOmU9cikpLHtwb3M6ZSxoZWFkZXJMZW5ndGg6bn19LGlzSDI2NVZpZGVvRnJhbWUodCl7dmFyIGU7cmV0dXJuKChudWxsPT09KGU9dC5nZXRNZXRhZGF0YSl8fHZvaWQgMD09PWV8fG51bGw9PT0oZT1lLmNhbGwodCkpfHx2b2lkIDA9PT1lP3ZvaWQgMDplLm1pbWVUeXBlKXx8IiIpLnRvTG93ZXJDYXNlKCkuaW5jbHVkZXMoImgyNjUiKX19LHNmPW5ldyBVaW50OEFycmF5KFsxMDksMTY3LDUzLDE5MCwxMDMsOTAsNzIsMSwxNzAsODksNjMsMTY0LDE5NCwxOTksMTksODVdKSxmZj1uZXcgVWludDhBcnJheShbMTA5LDE2Nyw1MywxOTAsMTAzLDkwLDcyLDEsMTcwLDg5LDYzLDE2NCwxOTQsMTk5LDE5LDg0XSksbGY9bmV3IFVpbnQ4QXJyYXkoWzMxLDIzOSwzLDUwLDI0MiwxMjAsNzYsODUsMTY5LDQyLDE2MSw5MSw3NSwxODYsMjJdKTtmdW5jdGlvbiB5Zih0KXtjb25zdCBlPVtdO2Zvcig7dD49MjU1Oyl0LT0yNTUsZS5wdXNoKDI1NSk7cmV0dXJuIGUucHVzaCh0KSxuZXcgVWludDhBcnJheShlKX1mdW5jdGlvbiBwZih0KXtsZXQgZT1hcmd1bWVudHMubGVuZ3RoPjEmJnZvaWQgMCE9PWFyZ3VtZW50c1sxXT9hcmd1bWVudHNbMV06MCxuPTA7Zm9yKDsyNTU9PT10W2VdJiZlPHQuYnl0ZUxlbmd0aDspZSsrLG4rPTI1NTtyZXR1cm4gZTx0LmJ5dGVMZW5ndGgmJihuKz10W2UrK10pLFtuLGVdfWNvbnN0IGhmPW5ldyBVaW50OEFycmF5KFs4MCwxXSk7Y2xhc3MgZ2Z7c3RhdGljIGdlbmVyYXRlU0VJKHQsZSl7bGV0IG49YXJndW1lbnRzLmxlbmd0aD4yJiZ2b2lkIDAhPT1hcmd1bWVudHNbMl0mJmFyZ3VtZW50c1syXTtjb25zdCByPW5ldyBVaW50OEFycmF5KFswLDAsMCwxXSksbz1lP2hmOm5ldyBVaW50OEFycmF5KFs2XSksaT1uZXcgVWludDhBcnJheShbNV0pLHU9Z2YuX191dWlkfHwobj9zZjpmZiksYT15Zih0LmJ5dGVMZW5ndGgrdS5ieXRlTGVuZ3RoKSxjPSh0PT57Y29uc3QgZT1bXTtsZXQgbj0wO2Zvcihjb25zdCByIG9mIHQpbj49MiYmcjw9MyYmKGUucHVzaCgzKSxuPTApLDA9PT1yP24rKzpuPTAsZS5wdXNoKHIpO3JldHVybiBuZXcgVWludDhBcnJheShlKX0pKHQpO3JldHVybiBuZXcgVWludDhBcnJheShbLi4uciwuLi5vLC4uLmksLi4uYSwuLi51LC4uLmMsMTI4XSl9c3RhdGljIGRlY29kZVNFSUJvZHkodCxlKXtjb25zdCBuPSh0PT57Y29uc3QgZT1bXTtmb3IobGV0IG49MDtuPHQubGVuZ3RoO24rKyl0W25dPD0zJiYwPT09dFtuLTFdJiYwPT09dFtuLTJdfHxlLnB1c2godFtuXSk7cmV0dXJuIG5ldyBVaW50OEFycmF5KGUpfSkodD10LnNsaWNlKDAsdC5sZW5ndGgtMSkpO2lmKG4uYnl0ZUxlbmd0aDwyKXJldHVybjtsZXQgcj0wO2NvbnN0IG89ZT8yOjE7aWYoNSE9PW5bb10mJjEwMCE9PW5bb10pcmV0dXJuO3IrPTErbztjb25zdFtpLHVdPXBmKG4scik7cj11O2xldCBhPTI7Y29uc3QgYz1yK2k7bi5ieXRlTGVuZ3RoPj1mZi5ieXRlTGVuZ3RoJiZpPj1mZi5ieXRlTGVuZ3RoJiYobi5zbGljZShyLHIrZmYuYnl0ZUxlbmd0aCkudG9TdHJpbmcoKT09PWZmLnRvU3RyaW5nKCl8fG4uc2xpY2UocixyK2xmLmJ5dGVMZW5ndGgpLnRvU3RyaW5nKCk9PT1sZi50b1N0cmluZygpKT8ocis9ZmYuYnl0ZUxlbmd0aCxhPTEpOm4uYnl0ZUxlbmd0aD49ZmYuYnl0ZUxlbmd0aCYmaT49ZmYuYnl0ZUxlbmd0aCYmbi5zbGljZShyLHIrc2YuYnl0ZUxlbmd0aCkudG9TdHJpbmcoKT09PXNmLnRvU3RyaW5nKCkmJihyKz1zZi5ieXRlTGVuZ3RoLGE9MCk7cmV0dXJue3R5cGU6YSxwYXlsb2FkOm4uc2xpY2UocixjKX19c3RhdGljIHBhcnNlSW50ZXJuYWxTRUkodCl7Y29uc3QgZT1uZXcgTWFwO2xldCBuPTA7aWYoMD09PXQudHlwZSl7Zm9yKDt0LnBheWxvYWQuYnl0ZUxlbmd0aC1uPj0yOyl7Y29uc3RbcixvXT1wZih0LnBheWxvYWQsbik7bj1vO2NvbnN0W2ksdV09cGYodC5wYXlsb2FkLG4pO2lmKG49dSxlLmdldChyKXx8IShpPD10LnBheWxvYWQuYnl0ZUxlbmd0aC1uKSlicmVhaztlLnNldChyLHQucGF5bG9hZC5zbGljZShuLG4raSkpLG4rPWl9cmV0dXJuIGV9fXN0YXRpYyBtYWtlSW50ZXJuYWxTZWkodCl7Y29uc3QgZT1bXTtmb3IoY29uc3RbbyxpXW9mIHQpe2NvbnN0IHQ9eWYobyksbj15ZihpLmJ5dGVMZW5ndGgpO2UucHVzaCh0LG4saSl9Y29uc3Qgbj1lLnJlZHVjZSgoKHQsZSk9PnQrZS5ieXRlTGVuZ3RoKSwwKSxyPW5ldyBVaW50OEFycmF5KG4pO3JldHVybiBlLnJlZHVjZSgoKHQsZSk9PihyLnNldChlLHQpLHQrZS5ieXRlTGVuZ3RoKSksMCkscn19YWYoZ2YsIl9fdXVpZCIsdm9pZCAwKTtjbGFzcyBkZntjb25zdHJ1Y3Rvcih0KXthZih0aGlzLCJzZWlMaXN0IixbXSksYWYodGhpcywibWF4U0VJQ291bnQiLDEpLHRoaXMubWF4U0VJQ291bnQ9dC5tYXhTRUlDb3VudH1zZW5kU0VJVHJhbnNmb3JtKHQsZSl7Y29uc3R7bWF4U0VJQ291bnQ6bixzZWlMaXN0OnJ9PXRoaXM7aWYoIXRoaXMuc2VpTGlzdC5sZW5ndGgpcmV0dXJuIHZvaWQgZS5lbnF1ZXVlKHQpO2NvbnN0IG89W107bGV0IGk9MDtmb3IoY29uc3QgYyBvZiByKXtpZihvLmxlbmd0aD49bilicmVhaztjb25zdCBlPWdmLmdlbmVyYXRlU0VJKGMuY29udGVudCxjZi5pc0gyNjVWaWRlb0ZyYW1lKHQpKTtpKz1lLmJ5dGVMZW5ndGgsYy5yZXBlYXRDb3VudC0tLG8ucHVzaChlKX10aGlzLnNlaUxpc3Q9ci5maWx0ZXIoKHQ9PnQucmVwZWF0Q291bnQ+MCkpO2NvbnN0IHU9bmV3IFVpbnQ4QXJyYXkoaSt0LmRhdGEuYnl0ZUxlbmd0aCk7dS5zZXQobmV3IFVpbnQ4QXJyYXkodC5kYXRhKSk7bGV0IGE9dC5kYXRhLmJ5dGVMZW5ndGg7by5mb3JFYWNoKCh0PT57dS5zZXQodCxhKSxhKz10LmJ5dGVMZW5ndGh9KSksdC5kYXRhPXUuYnVmZmVyLGUuZW5xdWV1ZSh0KX1wdXNoU0VJKHQpe3RoaXMuc2VpTGlzdC5wdXNoKHQpfXJldm9rZVNFSSh0KXtjb25zdCBlPXRoaXMuc2VpTGlzdC5maW5kSW5kZXgoKGU9PmUudXVpZD09PXQpKTtyZXR1cm4tMSE9PWUmJih0aGlzLnNlaUxpc3Quc3BsaWNlKGUsMSksITApfX0idW5kZWZpbmVkIiE9dHlwZW9mIHNlbGYmJiJEZWRpY2F0ZWRXb3JrZXJHbG9iYWxTY29wZSI9PT1zZWxmLmNvbnN0cnVjdG9yLm5hbWUmJnNlbGYuYWRkRXZlbnRMaXN0ZW5lcigicnRjdHJhbnNmb3JtIiwodD0+e2NvbnN0e3RyYW5zZm9ybWVyOmV9PXQse21heFNFSUNvdW50Om59PWUub3B0aW9ucyxyPW5ldyBkZih7bWF4U0VJQ291bnQ6bn0pLG89bmV3IFRyYW5zZm9ybVN0cmVhbSh7dHJhbnNmb3JtOnIuc2VuZFNFSVRyYW5zZm9ybS5iaW5kKHIpfSk7c2VsZi5hZGRFdmVudExpc3RlbmVyKCJtZXNzYWdlIiwodD0+e2xldHtkYXRhOmV9PXQ7Y29uc3R7dHlwZTpuLGNvbnRlbnQ6b309ZTtpZigicHVzaCI9PT1uKXIucHVzaFNFSShvKTtlbHNlIGlmKCJyZXZva2UiPT09bil7Y29uc3QgdD1yLnJldm9rZVNFSShvKTtyZXR1cm4gc2VsZi5wb3N0TWVzc2FnZSh7dHlwZToicmV2b2tlLWFjayIsY29udGVudDp7dXVpZDpvLGlzTm90U2VuZDp0fX0pfX0pKSxlLnJlYWRhYmxlLnBpcGVUaHJvdWdoKG8pLnBpcGVUbyhlLndyaXRhYmxlKX0pKX0oKTsK",bN="undefined"!=typeof window&&window.Blob&&new Blob([atob(yN)],{type:"text/javascript;charset=utf-8"});function TN(){let e;try{if(e=bN&&(gP||window.webkitURL).createObjectURL(bN),!e)throw"";return new Worker(e)}catch(t){return new Worker("data:application/javascript;base64,"+yN)}finally{!("undefined"!=typeof window&&navigator.userAgent.indexOf("Trident/")>0)&&e&&(gP||window.webkitlRL).revokeObjectURL(e)}}const IN={getNALUnits(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(e.length-e.position<4)return[];const{position:i}=e;return 1===e.getInt32(i)||0===e.getInt16(i)&&1===e.getInt8(i+2)?IN.getAnnexbNals(e,t):IN.getAvccNals(e,t)},getAnnexbNals(e,t){const i=[];let o=IN.getHeaderPositionAnnexB(e),r=o.pos,s=r;for(;r<e.length-4;){const n=new Uint8Array(e.buffer.slice(r,r+o.headerLength));o.pos===e.position&&e.skip(o.headerLength),o=IN.getHeaderPositionAnnexB(e),s=o.pos;const a={header:n,body:new Uint8Array(e.buffer.slice(r+n.byteLength,s)),type:-1};t?IN.analyseH265Nal(a):IN.analyseNal(a),(a.type<=9||t&&a.type<=40)&&0!==a.type&&i.push(a),e.skip(s-e.position),r=s}return i},getAvccNals(e,t){const i=[];for(;e.position<e.length-4;){const o=e.getInt32(e.position);if(!(e.length-e.position>=o))break;{const r=new Uint8Array(e.buffer.slice(e.position,e.position+4));e.skip(4);const s=new Uint8Array(e.buffer.slice(e.position,e.position+o));e.skip(o);const n={header:r,body:s,type:-1};t?IN.analyseH265Nal(n):IN.analyseNal(n),n.type<=9&&0!==n.type&&i.push(n)}}return i},analyseNal(e){const t=31&e.body[0];switch(e.type=t,t){case 1:e.ndr=!0;break;case 5:e.idr=!0;break;case 6:e.sei=!0;break;case 7:e.sps=!0;break;case 8:e.pps=!0}},analyseH265Nal(e){const t=(126&e.body[0])>>1;switch(e.type=t,t){case 39:case 40:e.sei=!0}},getHeaderPositionAnnexB(e){let t=e.position,i=0;const o=e.length;for(;3!==i&&4!==i&&t<o-4;)0===e.getInt16(t)?1===e.getInt16(t+2)?i=4:1===e.getInt8(t+2)?i=3:t++:t++;return t===o-4&&(0===e.getInt16(t)?1===e.getInt16(t+2)?i=4:t=o:(t++,0===e.getInt16(t)&&1===e.getInt8(t)?i=3:t=o)),{pos:t,headerLength:i}},isH265VideoFrame(e){var t;return((null===(t=e.getMetadata)||void 0===t||null===(t=t.call(e))||void 0===t?void 0:t.mimeType)||"").toLowerCase().includes("h265")}};class EN{constructor(e){Xu(this,"_position",0),Xu(this,"_dataview",void 0),this._dataview=new DataView(e)}get length(){return this.buffer.byteLength}get buffer(){return this._dataview.buffer}set position(e){this._position=e}get position(){return this._position}back(e){this.position-=e}getUint8(e){return this._dataview.getUint8(e)}getInt8(e){return this._dataview.getInt8(e)}getInt16(e){return this._dataview.getInt16(e)}getUint16(e){return this._dataview.getUint16(e)}getUint32(e){return this._dataview.getUint32(e)}getInt32(e){return this._dataview.getInt32(e)}skip(e){const t=Math.floor(e/4),i=e%4;for(let o=0;o<t;o++)EN.readByte(this,4);i>0&&EN.readByte(this,i)}static readByte(e,t,i){let o;switch(t){case 1:o=i?e.getInt8(e.position):e.getUint8(e.position);break;case 2:o=i?e.getInt16(e.position):e.getUint16(e.position);break;case 3:if(i)throw new Error("not supported for readByte 3");o=e.getUint8(e.position)<<16,o|=e.getUint8(e.position+1)<<8,o|=e.getUint8(e.position+2);break;case 4:o=i?e.getInt32(e.position):e.getUint32(e.position);break;case 8:if(i)throw new Error("not supported for readBody 8");o=e.getUint32(e.position)<<32,o|=e.getUint32(e.position+4);break;default:o=""}return e.position+=t,o}readUint8(){return EN.readByte(this,1)}readUint16(){return EN.readByte(this,2)}readUint24(){return EN.readByte(this,3)}readUint32(){return EN.readByte(this,4)}readUint64(){return EN.readByte(this,8)}readInt8(){return EN.readByte(this,1,!0)}readInt16(){return EN.readByte(this,2,!0)}readInt32(){return EN.readByte(this,4,!0)}writeUint32(e){return new Uint8Array([e>>>24&255,e>>>16&255,e>>>8&255,255&e])}}function RN(e){let{postMessage:t,skipFilter:i}=e;return new TransformStream({transform(e,o){const r=IN.isH265VideoFrame(e);IN.getNALUnits(new EN(e.data),r).forEach((e=>{if(e.sei){const o=TE.decodeSEIBody(e.body,r);o&&(i||o.type===pE.external)&&t(o)}})),o.enqueue(e)}})}"undefined"!=typeof self&&"DedicatedWorkerGlobalScope"===self.constructor.name&&self.addEventListener("rtctransform",(e=>{const{transformer:t}=e,{streamId:i,skipFilter:o}=t.options,r=RN({postMessage:e=>{self.postMessage({streamId:i,msg:e},[e.payload.buffer])},skipFilter:o});t.readable.pipeThrough(r).pipeTo(e.transformer.writable)}));class CN{constructor(e){Xu(this,"seiList",[]),Xu(this,"maxSEICount",1),this.maxSEICount=e.maxSEICount}sendSEITransform(e,t){const{maxSEICount:i,seiList:o}=this;if(!this.seiList.length)return void t.enqueue(e);const r=[];let s=0;for(const d of o){if(r.length>=i)break;const t=TE.generateSEI(d.content,IN.isH265VideoFrame(e));s+=t.byteLength,d.repeatCount--,r.push(t)}this.seiList=o.filter((e=>e.repeatCount>0));const n=new Uint8Array(s+e.data.byteLength);n.set(new Uint8Array(e.data));let a=e.data.byteLength;r.forEach((e=>{n.set(e,a),a+=e.byteLength})),e.data=n.buffer,t.enqueue(e)}pushSEI(e){this.seiList.push(e)}revokeSEI(e){const t=this.seiList.findIndex((t=>t.uuid===e));return-1!==t&&(this.seiList.splice(t,1),!0)}}"undefined"!=typeof self&&"DedicatedWorkerGlobalScope"===self.constructor.name&&self.addEventListener("rtctransform",(e=>{const{transformer:t}=e,{maxSEICount:i}=t.options,o=new CN({maxSEICount:i}),r=new TransformStream({transform:o.sendSEITransform.bind(o)});self.addEventListener("message",(e=>{let{data:t}=e;const{type:i,content:r}=t;if("push"===i)o.pushSEI(r);else if("revoke"===i){const e=o.revokeSEI(r);return self.postMessage({type:"revoke-ack",content:{uuid:r,isNotSend:e}})}})),t.readable.pipeThrough(r).pipeTo(t.writable)}));class kN extends kI{constructor(e){super(),Xu(this,"isScreen",!1),Xu(this,"audioMid",void 0),Xu(this,"videoMid",void 0),Xu(this,"audioMLine",void 0),Xu(this,"videoMLine",void 0),Xu(this,"videoTransceiver",void 0),Xu(this,"audioTransceiver",void 0),Xu(this,"vendorHandler",void 0),Xu(this,"vendorCode",0),Xu(this,"engineId",void 0),Xu(this,"logger",void 0),Xu(this,"__seiHelper",TE),Xu(this,"logName","StreamBase"),this._ctx=e,this.engineId=e.id,this.logger=new LS(this.constructor.name,2,e.id)}stopReport(e){this.statsReport.stopReport(e)}destroy(){var e,t;delete this.audioMid,delete this.videoMid,this.statsReport.destroy(),null===(e=this.observer)||void 0===e||e.reset(),delete this.videoTransceiver,delete this.audioTransceiver,null===(t=this.vendorHandler)||void 0===t||t.destroy(),this.vendorCode=0,delete this.vendorHandler}}var AN=(e=>(e[e.INIT=0]="INIT",e[e.SUB_ING=1]="SUB_ING",e[e.SUB_ED=2]="SUB_ED",e))(AN||{});class PN extends kN{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:xP.STREAM_INDEX_MAIN;super(e),Xu(this,"id",void 0),Xu(this,"stream",void 0),Xu(this,"streamId",void 0),Xu(this,"videoTrack",void 0),Xu(this,"audioTrack",void 0),Xu(this,"subVideoDescriptions",[]),Xu(this,"observer",void 0),Xu(this,"statsReport",void 0),Xu(this,"pubAudio",!1),Xu(this,"pubVideo",!1),Xu(this,"blackFrameRenderInterval",void 0),Xu(this,"blackFrameLifetimeInterval",void 0),Xu(this,"pubAttributes",void 0),Xu(this,"pcSessionId",void 0),Xu(this,"maxSeiCount",1),Xu(this,"preReports",{audio:{},video:{}}),Xu(this,"remoteSdp",void 0),Xu(this,"currentVideoCodec",void 0),Xu(this,"_changeCodecs",[]),Xu(this,"_videoCaps",[]),Xu(this,"_sendSEIHandler",void 0),Xu(this,"_trackMatchingTimer",void 0),Xu(this,"logName","LocalStream"),this.stream=new MediaStream,this.id=sm(),this.pubAttributes={localaudio:!1,localvideo:!1,videostream:!1,audiostream:!1,extvideo:!1,extaudio:!1,videoDescriptions:[],videoType:UI.NORMAL},this.isScreen=t===xP.STREAM_INDEX_SCREEN,this.statsReport=new PP(e,this);const i=Qg("SEI_COUNT_FPS");"number"==typeof i&&i<=10&&(this.maxSeiCount=i),this._trackMatchingTimer=setInterval(this._checkTrackMatching.bind(this),5e3)}get enableSimulcast(){return!this.isScreen&&this._ctx.videoProfile.getSimulcastMode()}get videoEncodeConfig(){return this.isScreen?[this._ctx.videoProfile.getScreenEncodeConfig()]:this._ctx.videoProfile.getVideoEncodeConfig()}get audioHasCapture(){return this.pubAttributes.localaudio}get audioHasPublish(){return this.pubAttributes.audiostream}get videoHasCapture(){return this.pubAttributes.localvideo}get videoHasPublish(){return this.pubAttributes.videostream}get isEmptyStream(){return!this.audioTrack&&!this.videoTrack}get initStreamId(){return this.stream.id}async getSelectedCodec(){var e;const t=this._changeCodecs.length>0?this._changeCodecs:this._videoCaps.length>0?this._videoCaps:await KI(),i=this._ctx.videoProfile.getPreferCodec(this.isScreen),o=this.isScreen?this._ctx.targetScreenCodec:this._ctx.targetCodec;if(i&&i!==rh.AUTO){if(i===rh.H264&&t.includes(YI.H264))return YI.H264;if(i===rh.VP8&&t.includes(YI.VP8))return YI.VP8;if(i===rh.ByteVC1&&t.includes(YI.ByteVC1))return YI.ByteVC1}if(null!==(e=this._ctx.serverConfig)&&void 0!==e&&e.videoCodec&&t.includes(this._ctx.serverConfig.videoCodec))return this._ctx.serverConfig.videoCodec;if(i===rh.AUTO&&t.length>0)return t[0];if(o&&t.includes(o))return o;if(t.includes(YI.H264))return YI.H264;if(t.includes(YI.VP8))return YI.VP8;throw new Error("no available codec")}startReport(e,t){this.statsReport.setLocalStreamStatsEvtInterval(e,t)}getLocalStreamStats(){return this.statsReport.getLocalStats()}initVideoEncodedTransform(){if(Qg("DISABLE_ENCODED_TRANSFORM"))return void this.logger.warn("initVideoEncodedTransform","DISABLE_ENCODED_TRANSFORM");if(!this.videoTransceiver||!this.videoTransceiver.sender)return void this.logger.warn("initVideoEncodedTransform","no sender found when trying to bind encodedTransform");const{sender:e}=this.videoTransceiver;if(this._ctx.pcKillSwitch.ctor_encodedinsetablestream_add&&sE()){const{readable:t,writable:i}=e.createEncodedStreams();if(window.__createDecodeError__)t.pipeThrough(new TransformStream({transform:(e,t)=>{const i=e.data,o=new DataView(i,16);o.setInt16(4,10),o.setInt16(11,20),t.enqueue(e)}})).pipeTo(i);else{const e=new CN({maxSEICount:this.maxSeiCount}),o=new TransformStream({transform:e.sendSEITransform.bind(e)});t.pipeThrough(o).pipeTo(i),this._sendSEIHandler=e}}else if(rE()){const e=new TN;this.videoTransceiver.sender.transform=new RTCRtpScriptTransform(e,{maxSEICount:this.maxSeiCount}),this._sendSEIHandler={pushSEI:t=>{e.postMessage({type:"push",content:t},[t.content.buffer])},revokeSEI:async t=>(e.postMessage({type:"revoke",content:t}),new Promise((i=>{e.addEventListener("message",(e=>{let{data:o}=e;const{type:r,content:s}=o,{uuid:n,isNotSend:a}=s;"revoke-ack"===r&&n===t&&i(a)}))})))}}}initAudioEncodedTransform(){if(Qg("DISABLE_ENCODED_TRANSFORM"))return void this.logger.warn("initAudioEncodedTransform","DISABLE_ENCODED_TRANSFORM");if(!this.audioTransceiver||!this.audioTransceiver.sender)return void this.logger.warn("initAudioEncodedTransform","no sender found when trying to bind encodedTransform");if(!this._ctx.pcKillSwitch.ctor_encodedinsetablestream_add)return void this.logger.warn("initAudioEncodedTransform","legacy EncodedTransform is not supported");if(!sE())return void this.logger.warn("initAudioEncodedTransform","legacy EncodedTransform is not supported");const{sender:e}=this.audioTransceiver,{readable:t,writable:i}=e.createEncodedStreams();t.pipeThrough(new TransformStream({transform:(e,t)=>{t.enqueue(e)}})).pipeTo(i)}clean(){fS(this.engineId,"localstream_clean","".concat((new Error).stack),0,this.streamId||""),super.destroy(),this.subVideoDescriptions=[],clearTimeout(this.blackFrameLifetimeInterval),clearInterval(this.blackFrameRenderInterval)}switchTrackEnableState(e,t){var i;let o;"audio"===e?o=this.audioTrack:"video"===e&&(o=this.videoTrack);const r=null===(i=o)||void 0===i?void 0:i.mediaTrack;return!(!r||(null==r?void 0:r.enabled)===t)&&(r.enabled=t,!0)}resetStream(){this.stream=new MediaStream}genBlackFrame(){var e,t;this.logger.info("genBlackFrame()");const i=null!==(e=this.videoEncodeConfig[0])&&void 0!==e&&e.frameRate?lb(null===(t=this.videoEncodeConfig[0])||void 0===t?void 0:t.frameRate):15,o=Math.ceil(1e3/i),r=document.createElement("canvas"),s=r.getContext("2d");r.width=16,r.height=16;const n=e=>{e.fillRect(0,0,16,16)};s&&(s.fillStyle="#000",n(s),this.blackFrameRenderInterval=window.setInterval((()=>{n(s)}),o),this.refreshBlackFrameLifetime());return r.captureStream(i).getVideoTracks()[0]}stopBlackFrame(){this.logger.info("stopBlackFrame()"),clearTimeout(this.blackFrameLifetimeInterval),clearInterval(this.blackFrameRenderInterval),delete this.blackFrameRenderInterval}refreshBlackFrameLifetime(){this.logger.info("refreshBlackFrameLifetime()"),this.blackFrameRenderInterval&&(clearTimeout(this.blackFrameLifetimeInterval),this.blackFrameLifetimeInterval=setTimeout((()=>{clearInterval(this.blackFrameRenderInterval),delete this.blackFrameRenderInterval,this.emit("black-frame-ended")}),jg.BLACK_FRAME_LIFETIME))}setChangeCodecs(e){this._changeCodecs=e}setVideoCaps(e){if(!e)return;const t=e.split(",").map((e=>{const t=z_(e).call(e).toUpperCase();return{H264:YI.H264,VP8:YI.VP8,BYTEVC1:YI.ByteVC1}[t]||null})).filter((e=>null!==e));this._videoCaps=t}sendSEIMessage(e){var t;this.logger.info("sendSEIMessage"),null===(t=this._sendSEIHandler)||void 0===t||t.pushSEI(e)}async revokeSEIMessage(e){var t;return this.logger.info("revokeSEIMessage"),this._sendSEIHandler?null===(t=this._sendSEIHandler)||void 0===t?void 0:t.revokeSEI(e):(this.logger.warn("revokeSEIMessage","no sei handler found"),!1)}destroy(){clearInterval(this._trackMatchingTimer),super.removeAllListeners(),super.destroy()}_checkTrackMatching(){var e,t,i,o;const r=null===(e=this.audioTrack)||void 0===e?void 0:e.preprocessingTrack.id,s=null===(t=this.videoTrack)||void 0===t?void 0:t.preprocessingTrack.id,n=null===(i=this.audioTransceiver)||void 0===i||null===(i=i.sender.track)||void 0===i?void 0:i.id,a=null===(o=this.videoTransceiver)||void 0===o||null===(o=o.sender.track)||void 0===o?void 0:o.id;var d,c;this.pubAudio&&r!==n&&(this.logger.error("_checkTrackMatching","audio track id: ".concat(r," not matching transceiver track id ").concat(n,", streamId: ").concat(this.streamId)),null===(d=this._ctx.monitor)||void 0===d||d.report("rtc_error",{message:"audio track id: ".concat(r," not matching transceiver track id ").concat(n),error_code:-1,stream_id:this.streamId}));this.pubVideo&&s!==a&&(this.logger.error("_checkTrackMatching","video track id: ".concat(s," not matching transceiver track id ").concat(a,", streamId: ").concat(this.streamId)),null===(c=this._ctx.monitor)||void 0===c||c.report("rtc_error",{message:"video track id: ".concat(s," not matching transceiver track id ").concat(a),error_code:-1,stream_id:this.streamId}))}}class NN extends kN{constructor(e,t,i,o,r,s){super(e),Xu(this,"streamId",void 0),Xu(this,"userId",void 0),Xu(this,"isPublic",void 0),Xu(this,"hasVideo",void 0),Xu(this,"hasAudio",void 0),Xu(this,"_attributes",void 0),Xu(this,"streamState",void 0),Xu(this,"removeTrack",!1),Xu(this,"observer",void 0),Xu(this,"statsReport",void 0),Xu(this,"subVideo",void 0),Xu(this,"subAudio",void 0),Xu(this,"subMediaType",void 0),Xu(this,"subLayer",void 0),Xu(this,"_sequenceId",void 0),Xu(this,"stream",void 0),Xu(this,"videoTrack",void 0),Xu(this,"audioTrack",void 0),Xu(this,"recordedVideoFrames",void 0),Xu(this,"stillExist",void 0),Xu(this,"originalMediaType",void 0),Xu(this,"priority",void 0),Xu(this,"remoteSessionId",""),Xu(this,"originalStreamIndex",0),Xu(this,"virtual",void 0),Xu(this,"pcSessionId",void 0),Xu(this,"_virtualOccupy",void 0),Xu(this,"_videoStallObserver",void 0),Xu(this,"_audioStallObserver",void 0),Xu(this,"preReports",{audio:{},video:{}}),Xu(this,"_installInfo",void 0),Xu(this,"_seiWorkerHandler",void 0),this.virtual=!1,this._virtualOccupy=!1,this.userId=t,this.isScreen=o,this.isPublic=r,this.streamId=i,this.logName="RemoteStream-".concat(i),this.hasAudio=s.audiostream&&s.localaudio,this.hasVideo=s.videostream&&s.localvideo,this._attributes=s,this.vendorCode=(null==s?void 0:s.vendorCode)||0,this.subVideo=!1,this.subAudio=!1,this._sequenceId=0,this.subMediaType=Hg.NONE,this.subLayer={spatialLayer:0,spatialSubLayer:-1},this.streamState=0,this.statsReport=new NP(e,this),this.enableVendorMode&&(this.pcSessionId=sm())}get vendor(){return this._attributes.vendorCode}get audioHasCapture(){return this._attributes.localaudio}get audioHasPublish(){return this._attributes.audiostream}get videoHasCapture(){return this._attributes.localvideo}get videoHasPublish(){return this._attributes.videostream}get sequenceId(){return this._sequenceId||-1}set sequenceId(e){"number"==typeof e&&(this._sequenceId=e)}get enableVendorMode(){return"number"==typeof this.attributes.vendorCode&&0!==this.attributes.vendorCode}get hasSubscribed(){return 2===this.streamState}get attributes(){return this._attributes}set attributes(e){this.hasVideo=e.localvideo&&e.videostream,this.hasAudio=e.localaudio&&e.audiostream,this._attributes=e,this.vendorCode=e.vendorCode||0}get virtualOccupy(){return this._virtualOccupy}set virtualOccupy(e){var t;if(this._virtualOccupy&&!e)null===(t=this.observer)||void 0===t||t.setPushTrack(!1);else if(!this._virtualOccupy&&e){var i;null===(i=this.observer)||void 0===i||i.setPushTrack(!0)}this._virtualOccupy=e}startReport(e,t){this.statsReport.setRemoteStreamStatsEvtInterval(e,t)}getRemoteStreamStats(){return this.statsReport.getRemoteStreamStats()}initVideoEncodedTransform(){if(Qg("DISABLE_ENCODED_TRANSFORM"))this.logger.warn("initVideoEncodedTransform","DISABLE_ENCODED_TRANSFORM");else if(this.videoTransceiver&&this.videoTransceiver.receiver){if(this._ctx.pcKillSwitch.ctor_encodedinsetablestream_add&&sE()){var e;null===(e=this._ctx.monitor)||void 0===e||e.report("rtc_invoke_status",{sdk_api_name:"initVideoEncodedTransform",message:"using legacy EncodedTransform",error_code:0,stream_id:this.streamId,elapse:0});const{receiver:t}=this.videoTransceiver,{readable:i,writable:o}=t.createEncodedStreams();i.pipeThrough(RN({postMessage:e=>{this.safeEmit("onSEIMessage",e.payload)},skipFilter:!!Qg("SKIP_SEI_FILTER")})).pipeTo(o)}else if(rE()){var t;null===(t=this._ctx.monitor)||void 0===t||t.report("rtc_invoke_status",{sdk_api_name:"initVideoEncodedTransform",message:"using standard EncodedTransform",error_code:0,stream_id:this.streamId,elapse:0});const e=this._ctx.receiveSEIWorker;this.videoTransceiver.receiver.transform=new RTCRtpScriptTransform(e,{streamId:this.streamId,skipFilter:!!Qg("SKIP_SEI_FILTER")}),this._seiWorkerHandler=e=>{e.data.streamId===this.streamId&&this.safeEmit("onSEIMessage",e.data.msg.payload)},e.addEventListener("message",this._seiWorkerHandler)}}else this.logger.warn("no receiver found when trying to bind encodedTransform")}initAudioEncodedTransform(){if(Qg("DISABLE_ENCODED_TRANSFORM"))return void this.logger.warn("initVideoEncodedTransform","DISABLE_ENCODED_TRANSFORM");if(!this.audioTransceiver||!this.audioTransceiver.receiver)return void this.logger.warn("no receiver found when trying to bind encodedTransform");if(!this._ctx.pcKillSwitch.ctor_encodedinsetablestream_add)return void this.logger.warn("legacy EncodedTransform is not supported");if(!sE())return void this.logger.warn("legacy EncodedTransform is not supported");const{receiver:e}=this.audioTransceiver,{readable:t,writable:i}=e.createEncodedStreams();t.pipeThrough(new TransformStream({transform:(e,t)=>{e.data.byteLength<=1e3?t.enqueue(e):this.logger.print("too large audio frame",e.data.byteLength)}})).pipeTo(i)}ontrack(e){var t;try{fS(this.engineId,"Stream.ontrack",JSON.stringify({uid:this.userId,streamId:this.streamId,streams:e.streams.reduce(((e,t)=>e+dm(t)),""),transceiver:um(e.transceiver),track:am(e.track)}),0,this.streamId||"")}catch(wZ){}if(this.enableVendorMode||null!==(t=e.streams)&&void 0!==t&&null!==(t=t[0])&&void 0!==t&&null!==(t=t.id)&&void 0!==t&&t.includes(this.streamId)){var i;const{track:t}=e;"video"===(null==t?void 0:t.kind)?this._setVideoTrack(t):"audio"===(null===(i=e.track)||void 0===i?void 0:i.kind)&&this._setAudioTrack(t),this._setStream(e.streams[0])}this.safeEmit("ontrack",e)}startVideoStallObserve(e){this.logger.info("startVideoStallObserve","invoke",e.playerId),this._videoStallObserver||(this._videoStallObserver=new wP(this.isScreen,this.engineId)),this._videoStallObserver.start(e)}stopVideoStallObserve(){var e;this.logger.info("stopVideoStallObserve","invoke"),null===(e=this._videoStallObserver)||void 0===e||e.stop()}updateVideoStallInfo(e,t,i){let o;var r;i?(o=null===(r=this._videoStallObserver)||void 0===r?void 0:r.getStallInfo({interval:e.stats_interval||0,bitrate:e.bitrate,frameRateDecoded:e.frame_rate_decoded,frameRateReceived:e.frame_rate_received}),this._installInfo=o):o=this._installInfo;if(o){const r=Math.min(o.report.stallDuration,e.stats_interval||0);if(e.play_time=o.pts,e.stall_count=o.report.stallCount,e.is_screen?e.stuck_length=r:e.stall_duration=r,e.pause_duration=Math.min(r,o.pauseDuration),t.stallCount=o.callback.stallCount,t.stallDuration=o.callback.stallDuration,o.stall100ms){const i=Math.min(o.stall100ms.duration,e.stats_interval||0);e.stall_duration_100ms=i,e.stall_count_100ms=o.stall100ms.count,t.stallDuration100MS=i,t.stallCount100MS=o.stall100ms.count}var s;if(0!==o.report.stallCount||0!==o.report.stallDuration)this.logger.print("video_stall_report",this.userId,null===(s=this.videoTrack)||void 0===s?void 0:s.observingPlayerId,JSON.stringify(o.report),i)}}getVideoRenderInfo(){var e;return(null===(e=this._videoStallObserver)||void 0===e?void 0:e.getRecentRenderInfo4Report())||{}}stopAudioStallObserve(){var e;this.logger.info("stopAudioStallObserve","invoke"),null===(e=this._audioStallObserver)||void 0===e||e.stop()}async updateAudioStallInfo(e,t,i){if(this._audioStallObserver){const i=await this._audioStallObserver.getAudioStallInfo();return e.concealedSamples===e.interval_concealed_samples&&e.totalSamplesReceived===e.interval_samples_received?(e.stall_count=0,e.stall_duration=0,t.stallCount=0,t.stallDuration=0):(e.stall_count=i.report.stall_count,e.stall_duration=i.report.stall_duration,t.stallCount=i.callback.stall_count,t.stallDuration=i.callback.stall_duration),0===i.report.stall_count&&0===i.report.stall_duration||this.logger.print("audio_stall_report",this.userId,JSON.stringify(Fu(Fu({},i.report),{},{callbackList:i.callback.list}))),i.extra}this._audioStallObserver=new OP(this),this._audioStallObserver.start(i.concealedSamples,i.totalSamplesReceived),this.logger.print("startAduioObserver","start")}resetStream(){var e,t;null===(e=this.audioTransceiver)||void 0===e||e.stop(),null===(t=this.videoTransceiver)||void 0===t||t.stop(),this.audioTransceiver=void 0,this.videoTransceiver=void 0}clean(){var e,t;this.logger.info("clean","exec stream.clean ".concat(this.streamId," ").concat(this.userId)),fS(this.engineId,"remotestream_clean","".concat((new Error).stack),0,this.streamId),super.destroy(),this.subAudio=!1,this.subVideo=!1,this.sequenceId=0,null===(e=this.videoTrack)||void 0===e||e.destroy(),this.videoTrack=void 0,null===(t=this.audioTrack)||void 0===t||t.destroy(),this.audioTrack=void 0,this.stream=void 0,this.recordedVideoFrames=void 0,delete this.priority,this._seiWorkerHandler&&this._ctx.receiveSEIWorker.removeEventListener("message",this._seiWorkerHandler)}destroy(){var e,t;this.clean(),null===(e=this._audioStallObserver)||void 0===e||e.destroy(),delete this._audioStallObserver,null===(t=this._videoStallObserver)||void 0===t||t.destroy(),delete this._videoStallObserver,this.attributes={audiostream:!1,localaudio:!1,localvideo:!1,videostream:!1,extvideo:!1,extaudio:!1,videoDescriptions:[]},super.removeAllListeners()}resetHasSubscribed(){this.streamState=0}_setStream(e){this.stream=e,e.onaddtrack=e=>{"video"===e.track.kind?this._setVideoTrack(e.track):"audio"===e.track.kind&&this._setAudioTrack(e.track)}}_setAudioTrack(e){var t;if((null===(t=this.audioTrack)||void 0===t||null===(t=t.preprocessingTrack)||void 0===t?void 0:t.id)!==e.id){this.audioTrack=gN(this._ctx,e,{streamIndex:this.isPublic?XI.PUBLIC:this.virtual?XI.VIRTUAL:this.isScreen?XI.SCREEN:XI.MAIN,streamUserId:this.userId});const t=this._ctx._remoteAudioTrackDumpConfig[this.isScreen?xP.STREAM_INDEX_SCREEN:xP.STREAM_INDEX_MAIN].get(this.userId);var i;if(null!=t&&t.callback&&null!=t&&t.frameSize)null===(i=this.audioTrack)||void 0===i||i.setDataFetcher(t.frameSize,(e=>{var i;this.audioHasCapture&&this.audioHasPublish&&(null===(i=t.callback)||void 0===i||i.call(t,e))}));this.emit("ontrack",this.audioTrack)}}_setVideoTrack(e){var t;(null===(t=this.videoTrack)||void 0===t||null===(t=t.preprocessingTrack)||void 0===t?void 0:t.id)!==e.id&&(this.videoTrack=function(e,t,i,o){return new eN(e,t,i,Fu({},o))}(this._ctx,e,this,{streamIndex:this.isPublic?XI.PUBLIC:this.virtual?XI.VIRTUAL:this.isScreen?XI.SCREEN:XI.MAIN,streamUserId:this.userId}),this.emit("ontrack",this.videoTrack))}}var wN=(e=>(e.RESUBSCRIBE="resubscribe",e.STREAM_FAILED="stream_failed",e.SUBSCRIBE_PUSH_TRACK="subscribe_push_track",e.REMOVE_PUSH_TRACK="remove_push_track",e.VIDEO_FIRST_FRAME="video_first_frame",e.ON_USER_PUBLISH_STATE_CHANGE="on_user_publish_state_change",e.ON_USER_START_AUDIO_CAPTURE="on_user_start_audio_capture",e.ON_USER_STOP_AUDIO_CAPTURE="on_user_stop_audio_capture",e.ON_USER_START_VIDEO_CAPTURE="on_user_start_video_capture",e.ON_USER_STOP_VIDEO_CAPTURE="on_user_stop_video_capture",e.ON_SEI_MESSAGED_RECEIVED="on_sei_messaged_received",e.ON_PUBLISH_RESULT="on_publish_result",e.ON_SUBSCRIBE_RESULT="ON_SUBSCRIBE_RESULT",e.ON_UPDATE_TOKEN_SUCCESS="on_update_token_success",e.ON_REMOTE_STREAM_STATS="ON_REMOTE_STREAM_STATS",e.ON_LOCAL_STREAM_STATS="ON_LOCAL_STREAM_STATS",e.ON_USER_LEAVE="on_user_leave",e.ON_ROOM_ERROR="on_room_error",e.ON_NETWORK_QUALITY="on_network_quality",e.ON_SIMULCAST_SUBSCRIBE_FALLBACK="on_simulcast_subscribe_fallback",e.ON_REMOTE_VIDEO_SIZE_CHANGED="on_remote_video_size_changed",e.ON_SUBTITLE_STATE_CHANGED="ON_SUBTITLE_STATE_CHANGED",e.ON_SUBTITLE_MESSAGE_RECEIVED="ON_SUBTITLE_MESSAGE_RECEIVED",e.ON_VIDEO_STREAM_BANNED="ON_VIDEO_STREAM_BANNED",e.ON_AUDIO_STREAM_BANNED="ON_AUDIO_STREAM_BANNED",e.ON_FORWARD_STREAM_ERROR="ON_FORWARD_STREAM_ERROR",e.ON_REJOIN_WITH_TCP="ON_REJOIN_WITH_TCP",e.PUB_RETRY="PUB_RETRY",e.SUB_RETRY="SUB_RETRY",e.VIDEO_TYPE_CHANGE="VIDEO_TYPE_CHANGE",e.JOIN_SUCCESS="JOIN_SUCCESS",e.UPDATE_PUBLISH="UPDATE_PUBLISH",e))(wN||{}),ON=(e=>(e[e.START=1]="START",e[e.START_SUCCESS=2]="START_SUCCESS",e[e.START_FAILED=3]="START_FAILED",e[e.UPDATE=4]="UPDATE",e[e.UPDATE_SUCCESS=5]="UPDATE_SUCCESS",e[e.UPDATE_FAILED=6]="UPDATE_FAILED",e[e.STOP=7]="STOP",e[e.STOP_SUCCESS=8]="STOP_SUCCESS",e[e.STOP_FAILED=9]="STOP_FAILED",e))(ON||{}),MN=(e=>(e[e.PUB=0]="PUB",e[e.UNPUB=1]="UNPUB",e))(MN||{});const LN=async(e,t,i,o)=>{try{var r,s,n,a;let h="",_=-1;const m="video"===t?null==i||null===(r=i.videoTrack)||void 0===r?void 0:r.originTrack:null==i||null===(s=i.audioTrack)||void 0===s?void 0:s.originTrack,p="video"===t?null==i||null===(n=i.videoTransceiver)||void 0===n?void 0:n.receiver:null==i||null===(a=i.audioTransceiver)||void 0===a?void 0:a.receiver;try{var d,c;const i=await(null===(d=e.peerConnection)||void 0===d?void 0:d.getStatsWithLowFrequency(m,!0,p)),o=(i||[]).find((e=>"inbound-rtp"===e.type)),r=await(null==p?void 0:p.getStats()),s=[];let n;var l;if(null==r||r.forEach((e=>s.push(e.type))),0===(null==i?void 0:i.length)&&0!==s.length)n=await(null===(l=e.peerConnection)||void 0===l?void 0:l.getStatsWithLowFrequency(void 0,void 0,p));h=JSON.stringify({type:t,reports:i.map((e=>e.type)),reports2:s,pc:(null===(c=e.peerConnection)||void 0===c?void 0:c.getOriginRTCPeerConnection())||null,track:(null==m?void 0:m.id)||null,bytes:null==o?void 0:o.bytesReceived,framesReceived:null==o?void 0:o.framesReceived,packetsReceived:null==o?void 0:o.packetsReceived,allReports:n})}catch(u){_=-999,h=u.mseeage||JSON.stringify(u)}null==o||o.report("rtc_invoke_status",{sdk_api_name:"first_frame_recv_timeout",error_code:_,message:h,stream_id:(null==i?void 0:i.streamId)||"",stream_user_id:null==i?void 0:i.userId,elapse:0})}catch(u){}},xN=async(e,t,i,o)=>{try{var r,s,n,a;let h="",_=-1;const m="video"===t?null==i||null===(r=i.videoTrack)||void 0===r?void 0:r.preprocessingTrack:null==i||null===(s=i.audioTrack)||void 0===s?void 0:s.preprocessingTrack,p="video"===t?null==i||null===(n=i.videoTransceiver)||void 0===n?void 0:n.sender:null==i||null===(a=i.audioTransceiver)||void 0===a?void 0:a.sender;try{var d,c;const i=await(null===(d=e.peerConnection)||void 0===d?void 0:d.getStatsWithLowFrequency(m,!0,p)),o=(i||[]).find((e=>"outbound-rtp"===e.type)),r=await(null==p?void 0:p.getStats()),s=[];let n;var l;if(null==r||r.forEach((e=>s.push(e.type))),0===i.length&&0!==s.length)n=await(null===(l=e.peerConnection)||void 0===l?void 0:l.getStatsWithLowFrequency(void 0,void 0,p));h=JSON.stringify({type:t,reports:i.map((e=>e.type)),reports2:s,pc:(null===(c=e.peerConnection)||void 0===c?void 0:c.getOriginRTCPeerConnection())||null,track:(null==m?void 0:m.id)||null,bytes:null==o?void 0:o.bytesSent,framesSent:null==o?void 0:o.framesSent,packetsSent:null==o?void 0:o.packetsSent,allReports:n})}catch(u){_=-999,h=u.mseeage||JSON.stringify(u)}null==o||o.report("rtc_invoke_status",{sdk_api_name:"first_frame_send_timeout",error_code:_,message:h,stream_id:(null==i?void 0:i.streamId)||"",stream_user_id:null==i?void 0:i.userId,elapse:0})}catch(u){}};class VN extends EI.EventEmitter{constructor(e,t){super(),Xu(this,"_audioEventSessionId",eb()),Xu(this,"_videoEventSessionId",eb()),Xu(this,"_stream",void 0),Xu(this,"_firstAudioFrameTimer",void 0),Xu(this,"_firstVideoFrameTimer",void 0),Xu(this,"_transportDelayInterval",void 0),Xu(this,"_transportDelay",void 0),Xu(this,"_firstVideoFrameInterval",void 0),Xu(this,"_firstAudioFrameInterval",void 0),Xu(this,"_isScreen",!1),Xu(this,"_audioFirstFrameState",0),Xu(this,"_videoFirstFrameState",0),Xu(this,"_timeout",1e4),Xu(this,"_currentAudioRecv",{startTime:0,eventSessionId:0,type:"login"}),Xu(this,"_currentVideoRecv",{startTime:0,eventSessionId:0,type:"login"}),Xu(this,"_login",!1),Xu(this,"_unMuteAudio",!1),Xu(this,"_enableAudio",!1),Xu(this,"_unMuteVideo",!1),Xu(this,"_enableVideo",!1),Xu(this,"_remoteUnmuteAudio",!1),Xu(this,"_remoteUnmuteVideo",!1),Xu(this,"_audioExternal",!1),Xu(this,"_pushAudio",!1),Xu(this,"_videoExternal",!1),Xu(this,"_pushVideo",!1),Xu(this,"_autoSubscribeVideo",!1),Xu(this,"_autoSubscribeAudio",!1),Xu(this,"_autoSubscribe",!1),Xu(this,"_publishVideo",!1),Xu(this,"_publishAudio",!1),Xu(this,"_subscribeAudio",!1),Xu(this,"_subscribeVideo",!1),Xu(this,"_subscribe",!1),Xu(this,"_pushTrack",!1),Xu(this,"_multiChatMode",!1),Xu(this,"_monitor",void 0),Xu(this,"logger",void 0),this._ctx=e,this._stream=t,this.getTransportDelay(),this._monitor=uS(t.engineId),this.logger=new LS("RecvFrameObserver",0,t.engineId)}async beginRecvFrame(e,t){await this.getTransportDelay();let i=this._transportDelay,o=!0;if(["login","unmute","subscribe","push_track"].indexOf(t)>=0&&(i=0,o=!1),"audio"===e){var r,s,n,a,d,c,l,u;o||this._audioEventSessionId++,this._currentAudioRecv={startTime:Date.now(),eventSessionId:this._audioEventSessionId,type:t};const h={media_type:e,event_type:"begin_recv",type:t,is_screen:!(null===(r=this._stream)||void 0===r||!r.isScreen),start:null===(s=this._currentAudioRecv)||void 0===s?void 0:s.startTime,event_session_id:this._audioEventSessionId,stream_user_id:null===(n=this._stream)||void 0===n?void 0:n.userId,transport_delay:i,vendor_mode:(null===(a=this._stream)||void 0===a?void 0:a.vendorCode)||0,pc_session_id:(null===(d=this._stream)||void 0===d?void 0:d.pcSessionId)||(null===(c=this._ctx.peerConnection)||void 0===c?void 0:c.getConnectionId()),remote_rtc_session_id:null===(l=this._stream)||void 0===l?void 0:l.remoteSessionId};this._firstAudioFrameTimer&&window.clearTimeout(this._firstAudioFrameTimer),this._firstAudioFrameTimer=setTimeout((()=>{LN(this._ctx,"audio",this._stream,this._monitor),this.stopRecvFrame("audio","timeout"),this._firstAudioFrameInterval&&window.clearInterval(this._firstAudioFrameInterval)}),this._timeout),this.logger.info("rtcFirstFrameRecv",JSON.stringify(h)),null===(u=this._monitor)||void 0===u||u.report("rtc_first_frame",h),this._watchForFirstAudioFrameRecv(),this._audioFirstFrameState=1,this._login=!0,this._unMuteAudio=!0,this._enableAudio=!0,this._remoteUnmuteAudio=!0}else if("video"===e){var h,_,m,p,v,f,S,g;o||this._videoEventSessionId++,this._currentVideoRecv={startTime:Date.now(),eventSessionId:this._videoEventSessionId,type:t};const r={media_type:e,event_type:"begin_recv",type:t,is_screen:!(null===(h=this._stream)||void 0===h||!h.isScreen),start:null===(_=this._currentVideoRecv)||void 0===_?void 0:_.startTime,event_session_id:this._videoEventSessionId,stream_user_id:null===(m=this._stream)||void 0===m?void 0:m.userId,transport_delay:i,vendor_mode:(null===(p=this._stream)||void 0===p?void 0:p.vendorCode)||0,pc_session_id:(null===(v=this._stream)||void 0===v?void 0:v.pcSessionId)||(null===(f=this._ctx.peerConnection)||void 0===f?void 0:f.getConnectionId()),remote_rtc_session_id:null===(S=this._stream)||void 0===S?void 0:S.remoteSessionId};this._firstVideoFrameTimer&&window.clearTimeout(this._firstVideoFrameTimer),this._firstVideoFrameTimer=setTimeout((()=>{LN(this._ctx,"video",this._stream,this._monitor),this.stopRecvFrame("video","timeout"),this._firstVideoFrameInterval&&window.clearInterval(this._firstVideoFrameInterval)}),this._timeout),this._watchForFirstVideoFrameRecv(),this.logger.info("rtcFirstFrameRecv",JSON.stringify(r)),null===(g=this._monitor)||void 0===g||g.report("rtc_first_frame",r),this._videoFirstFrameState=1,this._login=!0,this._unMuteVideo=!0,this._enableVideo=!0,this._remoteUnmuteVideo=!0}}stopRecvFrame(e,t){if("audio"===e){var i,o,r,s,n,a,d,c,l;if(1!==this._audioFirstFrameState)return;const u={event_type:"recv_end",media_type:e,is_screen:!(null===(i=this._stream)||void 0===i||!i.isScreen),start:null===(o=this._currentAudioRecv)||void 0===o?void 0:o.startTime,reason:t,result:!1,stream_user_id:null===(r=this._stream)||void 0===r?void 0:r.userId,event_session_id:this._audioEventSessionId,type:null===(s=this._currentAudioRecv)||void 0===s?void 0:s.type,vendor_mode:(null===(n=this._stream)||void 0===n?void 0:n.vendorCode)||0,pc_session_id:(null===(a=this._stream)||void 0===a?void 0:a.pcSessionId)||(null===(d=this._ctx.peerConnection)||void 0===d?void 0:d.getConnectionId()),remote_rtc_session_id:null===(c=this._stream)||void 0===c?void 0:c.remoteSessionId};this._firstAudioFrameTimer&&window.clearTimeout(this._firstAudioFrameTimer),delete this._currentAudioRecv,this.logger.info("rtcFirstFrameRecv",JSON.stringify(u)),null===(l=this._monitor)||void 0===l||l.report("rtc_first_frame",u),this._audioFirstFrameState=2}else if("video"===e){var u,h,_,m,p,v,f,S,g,y,b,T,I,E,R,C,k,A,P;if(1!==this._videoFirstFrameState)return;const i={event_type:"recv_end",media_type:e,is_screen:!(null===(u=this._stream)||void 0===u||!u.isScreen),start:null===(h=this._currentVideoRecv)||void 0===h?void 0:h.startTime,reason:t,result:!1,stream_user_id:null===(_=this._stream)||void 0===_?void 0:_.userId,event_session_id:this._videoEventSessionId,type:null===(m=this._currentVideoRecv)||void 0===m?void 0:m.type,vendor_mode:(null===(p=this._stream)||void 0===p?void 0:p.vendorCode)||0,pc_session_id:(null===(v=this._stream)||void 0===v?void 0:v.pcSessionId)||(null===(f=this._ctx.peerConnection)||void 0===f?void 0:f.getConnectionId()),remote_rtc_session_id:null===(S=this._stream)||void 0===S?void 0:S.remoteSessionId,codec:null===(g=this._stream)||void 0===g||null===(g=g.getRemoteStreamStats())||void 0===g||null===(g=g.videoStats)||void 0===g?void 0:g.codecType,stats_frame_size_width:null===(y=this._stream)||void 0===y||null===(y=y.getRemoteStreamStats())||void 0===y||null===(y=y.videoStats)||void 0===y?void 0:y.frame_size_width,stats_frame_size_height:null===(b=this._stream)||void 0===b||null===(b=b.getRemoteStreamStats())||void 0===b||null===(b=b.videoStats)||void 0===b?void 0:b.frame_size_height,stats_frame_rate_decode:null===(T=this._stream)||void 0===T||null===(T=T.getRemoteStreamStats())||void 0===T||null===(T=T.videoStats)||void 0===T?void 0:T.decoderOutputFrameRate,stats_frame_rate_receive:null===(I=this._stream)||void 0===I||null===(I=I.getRemoteStreamStats())||void 0===I||null===(I=I.videoStats)||void 0===I?void 0:I.receivedFrameRate,stats_frame_decoder_name:null===(E=this._stream)||void 0===E||null===(E=E.getRemoteStreamStats())||void 0===E||null===(E=E.videoStats)||void 0===E?void 0:E.decoderName,stats_gpu_url:jg.GPU_URL||(null===(R=fb())||void 0===R?void 0:R.renderer),track_frame_size_width:null===(C=this._stream)||void 0===C||null===(C=C.videoTrack)||void 0===C||null===(C=C.originTrack.getSettings())||void 0===C?void 0:C.width,track_frame_size_height:null===(k=this._stream)||void 0===k||null===(k=k.videoTrack)||void 0===k||null===(k=k.originTrack.getSettings())||void 0===k?void 0:k.height,track_frame_rate:null===(A=this._stream)||void 0===A||null===(A=A.videoTrack)||void 0===A||null===(A=A.originTrack.getSettings())||void 0===A?void 0:A.frameRate};this._firstVideoFrameTimer&&window.clearTimeout(this._firstVideoFrameTimer),delete this._currentVideoRecv,this.logger.info("rtcFirstFrameRecv",JSON.stringify(i)),null===(P=this._monitor)||void 0===P||P.report("rtc_first_frame",i),this._videoFirstFrameState=2,setTimeout((()=>{var i,o,r,s,n,a,d,c,l,u,h,_,m,p,v,f,S,g,y;const b={event_type:"recv_end",media_type:e,is_screen:!(null===(i=this._stream)||void 0===i||!i.isScreen),start:null===(o=this._currentVideoRecv)||void 0===o?void 0:o.startTime,reason:t,result:!1,stream_user_id:null===(r=this._stream)||void 0===r?void 0:r.userId,event_session_id:this._videoEventSessionId,type:null===(s=this._currentVideoRecv)||void 0===s?void 0:s.type,vendor_mode:(null===(n=this._stream)||void 0===n?void 0:n.vendorCode)||0,pc_session_id:(null===(a=this._stream)||void 0===a?void 0:a.pcSessionId)||(null===(d=this._ctx.peerConnection)||void 0===d?void 0:d.getConnectionId()),remote_rtc_session_id:null===(c=this._stream)||void 0===c?void 0:c.remoteSessionId,codec:null===(l=this._stream)||void 0===l||null===(l=l.getRemoteStreamStats())||void 0===l||null===(l=l.videoStats)||void 0===l?void 0:l.codecType,stats_frame_size_width:null===(u=this._stream)||void 0===u||null===(u=u.getRemoteStreamStats())||void 0===u||null===(u=u.videoStats)||void 0===u?void 0:u.frame_size_width,stats_frame_size_height:null===(h=this._stream)||void 0===h||null===(h=h.getRemoteStreamStats())||void 0===h||null===(h=h.videoStats)||void 0===h?void 0:h.frame_size_height,stats_frame_rate_decode:null===(_=this._stream)||void 0===_||null===(_=_.getRemoteStreamStats())||void 0===_||null===(_=_.videoStats)||void 0===_?void 0:_.decoderOutputFrameRate,stats_frame_rate_receive:null===(m=this._stream)||void 0===m||null===(m=m.getRemoteStreamStats())||void 0===m||null===(m=m.videoStats)||void 0===m?void 0:m.receivedFrameRate,stats_frame_decoder_name:null===(p=this._stream)||void 0===p||null===(p=p.getRemoteStreamStats())||void 0===p||null===(p=p.videoStats)||void 0===p?void 0:p.decoderName,stats_gpu_url:jg.GPU_URL||(null===(v=fb())||void 0===v?void 0:v.renderer),track_frame_size_width:null===(f=this._stream)||void 0===f||null===(f=f.videoTrack)||void 0===f||null===(f=f.originTrack.getSettings())||void 0===f?void 0:f.width,track_frame_size_height:null===(S=this._stream)||void 0===S||null===(S=S.videoTrack)||void 0===S||null===(S=S.originTrack.getSettings())||void 0===S?void 0:S.height,track_frame_rate:null===(g=this._stream)||void 0===g||null===(g=g.videoTrack)||void 0===g||null===(g=g.originTrack.getSettings())||void 0===g?void 0:g.frameRate};this.logger.info("rtc_first_frame_statistics",JSON.stringify(b)),null===(y=this._monitor)||void 0===y||y.report("rtc_first_frame_statistics",b)}),8e3)}}async recvFrameFinish(e){await this.getTransportDelay();let t=this._transportDelay;if("audio"===e){var i,o,r,s,n,a,d;if(1!==this._audioFirstFrameState)return;if(!this._currentAudioRecv)return;const{type:c,startTime:l}=this._currentAudioRecv;["login","unmute","subscribe","push_track"].indexOf(c)>=0&&(t=0);const u={event_type:"recv_end",media_type:e,start:l,result:!0,is_screen:!(null===(i=this._stream)||void 0===i||!i.isScreen),stream_user_id:null===(o=this._stream)||void 0===o?void 0:o.userId,event_session_id:this._audioEventSessionId,type:c,transport_delay:t,vendor_mode:(null===(r=this._stream)||void 0===r?void 0:r.vendorCode)||0,pc_session_id:(null===(s=this._stream)||void 0===s?void 0:s.pcSessionId)||(null===(n=this._ctx.peerConnection)||void 0===n?void 0:n.getConnectionId()),remote_rtc_session_id:null===(a=this._stream)||void 0===a?void 0:a.remoteSessionId};delete this._currentAudioRecv,this._firstAudioFrameTimer&&window.clearTimeout(this._firstAudioFrameTimer),this.logger.info("rtcFirstFrameRecv",JSON.stringify(u)),null===(d=this._monitor)||void 0===d||d.report("rtc_first_frame",u),this.emit("recvAudioFirstFrame"),this._audioFirstFrameState=3}else if("video"===e){var c,l,u,h,_,m,p,v,f,S,g,y,b,T,I,E,R;if(1!==this._videoFirstFrameState)return;if(!this._currentVideoRecv)return;const{type:i,startTime:o}=this._currentVideoRecv;["login","unmute","subscribe","push_track"].indexOf(i)>=0&&(t=0);const r={event_type:"recv_end",media_type:e,is_screen:!(null===(c=this._stream)||void 0===c||!c.isScreen),start:o,result:!0,stream_user_id:null===(l=this._stream)||void 0===l?void 0:l.userId,event_session_id:this._videoEventSessionId,type:i,transport_delay:t,vendor_mode:(null===(u=this._stream)||void 0===u?void 0:u.vendorCode)||0,pc_session_id:(null===(h=this._stream)||void 0===h?void 0:h.pcSessionId)||(null===(_=this._ctx.peerConnection)||void 0===_?void 0:_.getConnectionId()),remote_rtc_session_id:null===(m=this._stream)||void 0===m?void 0:m.remoteSessionId,codec:null===(p=this._stream)||void 0===p||null===(p=p.getRemoteStreamStats())||void 0===p||null===(p=p.videoStats)||void 0===p?void 0:p.codecType,stats_frame_size_width:null===(v=this._stream)||void 0===v||null===(v=v.getRemoteStreamStats())||void 0===v||null===(v=v.videoStats)||void 0===v?void 0:v.frameSizeWidth,stats_frame_size_height:null===(f=this._stream)||void 0===f||null===(f=f.getRemoteStreamStats())||void 0===f||null===(f=f.videoStats)||void 0===f?void 0:f.frameSizeHeight,stats_frame_rate_decode:null===(S=this._stream)||void 0===S||null===(S=S.getRemoteStreamStats())||void 0===S||null===(S=S.videoStats)||void 0===S?void 0:S.decoderOutputFrameRate,stats_frame_rate_receive:null===(g=this._stream)||void 0===g||null===(g=g.getRemoteStreamStats())||void 0===g||null===(g=g.videoStats)||void 0===g?void 0:g.receivedFrameRate,stats_frame_decoder_name:null===(y=this._stream)||void 0===y||null===(y=y.getRemoteStreamStats())||void 0===y||null===(y=y.videoStats)||void 0===y?void 0:y.decoderName,stats_gpu_url:jg.GPU_URL||(null===(b=fb())||void 0===b?void 0:b.renderer),track_frame_size_width:null===(T=this._stream)||void 0===T||null===(T=T.videoTrack)||void 0===T||null===(T=T.originTrack.getSettings())||void 0===T?void 0:T.width,track_frame_size_height:null===(I=this._stream)||void 0===I||null===(I=I.videoTrack)||void 0===I||null===(I=I.originTrack.getSettings())||void 0===I?void 0:I.height,track_frame_rate:null===(E=this._stream)||void 0===E||null===(E=E.videoTrack)||void 0===E||null===(E=E.originTrack.getSettings())||void 0===E?void 0:E.frameRate};delete this._currentVideoRecv,this._firstVideoFrameTimer&&window.clearTimeout(this._firstVideoFrameTimer),this.logger.info("rtcFirstFrameRecv",JSON.stringify(r)),null===(R=this._monitor)||void 0===R||R.report("rtc_first_frame",r),this.emit("recvVideoFirstFrame"),this._videoFirstFrameState=3,setTimeout((()=>{var r,s,n,a,d,c,l,u,h,_,m,p,v,f,S,g,y;const b={event_type:"recv_end",media_type:e,is_screen:!(null===(r=this._stream)||void 0===r||!r.isScreen),start:o,result:!0,stream_user_id:null===(s=this._stream)||void 0===s?void 0:s.userId,event_session_id:this._videoEventSessionId,type:i,transport_delay:t,vendor_mode:(null===(n=this._stream)||void 0===n?void 0:n.vendorCode)||0,pc_session_id:(null===(a=this._stream)||void 0===a?void 0:a.pcSessionId)||(null===(d=this._ctx.peerConnection)||void 0===d?void 0:d.getConnectionId()),remote_rtc_session_id:null===(c=this._stream)||void 0===c?void 0:c.remoteSessionId,codec:null===(l=this._stream)||void 0===l||null===(l=l.getRemoteStreamStats())||void 0===l||null===(l=l.videoStats)||void 0===l?void 0:l.codecType,stats_frame_size_width:null===(u=this._stream)||void 0===u||null===(u=u.getRemoteStreamStats())||void 0===u||null===(u=u.videoStats)||void 0===u?void 0:u.frameSizeWidth,stats_frame_size_height:null===(h=this._stream)||void 0===h||null===(h=h.getRemoteStreamStats())||void 0===h||null===(h=h.videoStats)||void 0===h?void 0:h.frameSizeHeight,stats_frame_rate_decode:null===(_=this._stream)||void 0===_||null===(_=_.getRemoteStreamStats())||void 0===_||null===(_=_.videoStats)||void 0===_?void 0:_.decoderOutputFrameRate,stats_frame_rate_receive:null===(m=this._stream)||void 0===m||null===(m=m.getRemoteStreamStats())||void 0===m||null===(m=m.videoStats)||void 0===m?void 0:m.receivedFrameRate,stats_frame_decoder_name:null===(p=this._stream)||void 0===p||null===(p=p.getRemoteStreamStats())||void 0===p||null===(p=p.videoStats)||void 0===p?void 0:p.decoderName,stats_gpu_url:jg.GPU_URL||(null===(v=fb())||void 0===v?void 0:v.renderer),track_frame_size_width:null===(f=this._stream)||void 0===f||null===(f=f.videoTrack)||void 0===f||null===(f=f.originTrack.getSettings())||void 0===f?void 0:f.width,track_frame_size_height:null===(S=this._stream)||void 0===S||null===(S=S.videoTrack)||void 0===S||null===(S=S.originTrack.getSettings())||void 0===S?void 0:S.height,track_frame_rate:null===(g=this._stream)||void 0===g||null===(g=g.videoTrack)||void 0===g||null===(g=g.originTrack.getSettings())||void 0===g?void 0:g.frameRate};this.logger.info("rtc_first_frame_statistics",JSON.stringify(b)),null===(y=this._monitor)||void 0===y||y.report("rtc_first_frame_statistics",b)}),8e3)}}setLogin(e){var t,i,o,r;let s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{audio:!0,video:!0};this._login!==e&&(this._login=e,e&&null!==(t=this._stream)&&void 0!==t&&t.hasAudio&&s.audio&&this.beginRecvFrame("audio","login"),e&&null!==(i=this._stream)&&void 0!==i&&i.hasVideo&&s.video&&this.beginRecvFrame("video","login"),!e&&null!==(o=this._stream)&&void 0!==o&&o.hasAudio&&this.stopRecvFrame("audio","leave_room"),!e&&null!==(r=this._stream)&&void 0!==r&&r.hasVideo&&this.stopRecvFrame("video","leave_room"))}setUnmuteAudio(e){var t,i,o;if(this._unMuteAudio===e)return;this._unMuteAudio=e;const r=!(null===(t=this._stream)||void 0===t||!t.hasAudio);null!==(i=this._stream)&&void 0!==i&&i.audioHasCapture&&null!==(o=this._stream)&&void 0!==o&&o.audioHasPublish&&(this._unMuteAudio&&r?this.beginRecvFrame("audio","unmute"):r&&this.stopRecvFrame("audio","mute"))}setRemoteUnmuteAudio(e){this._remoteUnmuteAudio!==e&&(this._remoteUnmuteAudio=e,this._remoteUnmuteAudio?this.beginRecvFrame("audio","remote_unmute"):this.stopRecvFrame("audio","remote_mute"))}setEnableAudio(e){this._enableAudio!==e&&(this._enableAudio=e,this._enableAudio?this.beginRecvFrame("audio","enable"):this.stopRecvFrame("audio","disable"))}setUnmuteVideo(e){var t,i,o;if(this._unMuteVideo===e)return;this._unMuteVideo=e;const r=!(null===(t=this._stream)||void 0===t||!t.hasVideo);null!==(i=this._stream)&&void 0!==i&&i.videoHasCapture&&null!==(o=this._stream)&&void 0!==o&&o.videoHasPublish&&(this._unMuteVideo&&r?this.beginRecvFrame("video","unmute"):r&&this.stopRecvFrame("video","mute"))}setRemoteUnmuteVideo(e){this._remoteUnmuteVideo!==e&&(this._remoteUnmuteVideo=e,this._remoteUnmuteVideo?this.beginRecvFrame("video","remote_unmute"):this.stopRecvFrame("video","remote_mute"))}setEnableVideo(e){this._enableVideo!==e&&(this._enableVideo=e,this._enableVideo?this.beginRecvFrame("video","enable"):this.stopRecvFrame("video","disable"))}setExternalAudioSource(e){this._audioExternal=e}setPushAudio(e){var t;this._audioExternal&&this._pushAudio!==e&&(this._pushAudio=e),this._pushAudio&&this.beginRecvFrame("audio","push"),!e&&null!==(t=this._stream)&&void 0!==t&&t.hasAudio&&this.stopRecvFrame("audio","stop_push")}setExternalVideoSource(e){this._videoExternal=e}setPushVideo(e){var t;this._videoExternal&&this._pushVideo!==e&&(this._pushVideo=e),this._pushVideo&&this.beginRecvFrame("video","push"),!e&&null!==(t=this._stream)&&void 0!==t&&t.hasVideo&&this.stopRecvFrame("video","stop_push")}setPublishVideo(e){var t;this._publishVideo!==e&&(this._publishVideo=e),this._publishVideo&&this.beginRecvFrame("video","publish"),!e&&null!==(t=this._stream)&&void 0!==t&&t.hasVideo&&this.stopRecvFrame("video","unpublish")}setPublishAudio(e){var t;this._publishAudio!==e&&(this._publishAudio=e),this._publishAudio&&this.beginRecvFrame("audio","publish"),!e&&null!==(t=this._stream)&&void 0!==t&&t.hasAudio&&this.stopRecvFrame("audio","unpublish")}setAutoSubscribe(e){this._autoSubscribe=e}setAutoSubscribeVideo(e){this._autoSubscribeVideo=e}setAutoSubscribeAudio(e){this._autoSubscribeAudio=e}setSubscribeAudio(e){var t,i;this._autoSubscribeAudio||this._subscribeAudio===e||(this._subscribe=e,e&&null!==(i=this._stream)&&void 0!==i&&i.hasAudio&&this.beginRecvFrame("audio","subscribe"));!e&&null!==(t=this._stream)&&void 0!==t&&t.hasAudio&&this.stopRecvFrame("audio","unsubscribe")}setSubscribeVideo(e){var t,i;this._autoSubscribeVideo||this._subscribeVideo===e||(this._subscribeVideo=e,e&&null!==(i=this._stream)&&void 0!==i&&i.hasVideo&&this.beginRecvFrame("video","subscribe"));!e&&null!==(t=this._stream)&&void 0!==t&&t.hasVideo&&this.stopRecvFrame("video","unsubscribe")}setPushTrack(e){var t;this._pushTrack!==e&&(this._pushTrack=e,e&&!this._isScreen&&this.beginRecvFrame("audio","push_track"),!e&&null!==(t=this._stream)&&void 0!==t&&t.hasAudio&&this.stopRecvFrame("audio","remove_track"))}setMultiChatMode(e){this._multiChatMode=e}setTimeout(e){this._timeout=e}_watchForFirstVideoFrameRecv(){let e=-1,t=-1;this._firstVideoFrameInterval&&window.clearInterval(this._firstVideoFrameInterval),this._firstVideoFrameInterval=window.setInterval((async()=>{var i,o,r;const s=null!==(i=null===(o=this._stream)||void 0===o||null===(o=o.vendorHandler)||void 0===o?void 0:o.peer)&&void 0!==i?i:this._ctx.peerConnection;if(s&&null!==(r=this._stream)&&void 0!==r&&null!==(r=r.videoTrack)&&void 0!==r&&r.preprocessingTrack){var n,a;const i=null===(n=this._stream.videoTransceiver)||void 0===n?void 0:n.receiver,o=(await s.getStatsWithLowFrequency(null===(a=this._stream)||void 0===a||null===(a=a.videoTrack)||void 0===a?void 0:a.preprocessingTrack,!0,i)).find((e=>"inbound-rtp"===e.type));if(o&&(o.framesReceived>e||o.packetsReceived>t)){if(-1===e&&-1===t)return e=o.framesReceived,void(t=o.packetsReceived);this.recvFrameFinish("video"),window.clearInterval(this._firstVideoFrameInterval)}}}),200)}_watchForFirstAudioFrameRecv(){let e=-1,t=-1;this._firstAudioFrameInterval&&window.clearInterval(this._firstAudioFrameInterval),this._firstAudioFrameInterval=window.setInterval((async()=>{var i,o,r;const s=null!==(i=null===(o=this._stream)||void 0===o||null===(o=o.vendorHandler)||void 0===o?void 0:o.peer)&&void 0!==i?i:this._ctx.peerConnection;if(s&&null!==(r=this._stream)&&void 0!==r&&null!==(r=r.audioTrack)&&void 0!==r&&r.originTrack){var n;const i=(await s.getStatsWithLowFrequency(null===(n=this._stream)||void 0===n||null===(n=n.audioTrack)||void 0===n?void 0:n.originTrack)).find((e=>"inbound-rtp"===e.type));if(i&&(i.totalSamplesReceived>e||i.packetsReceived>t)){if(-1===e&&-1===t)return e=i.totalSamplesReceived,void(t=i.packetsReceived);this.recvFrameFinish("audio"),window.clearInterval(this._firstAudioFrameInterval)}}}),200)}async getTransportDelay(){await this.getTransportDelayIntl(),window.clearInterval(this._transportDelayInterval),this._transportDelayInterval=window.setInterval((async()=>{await this.getTransportDelayIntl()}),2e3)}async getTransportDelayIntl(){const e=this._ctx.peerConnection;if(e){var t;const i=null===(t=this._stream)||void 0===t||null===(t=t.videoTransceiver)||void 0===t?void 0:t.receiver,o=await e.getStatsWithLowFrequency(void 0,!0,i),r=o.find((e=>"transport"===e.type&&"connected"===e.dtlsState)),s=o.find((e=>"candidate-pair"===e.type&&"succeeded"===e.state&&e.id===(null==r?void 0:r.selectedCandidatePairId)));s&&(this._transportDelay=Math.round(1e3*s.currentRoundTripTime/2))}}setDisconnect(){this.stopRecvFrame("audio","connection_lost"),this.stopRecvFrame("video","connection_lost"),this.reset()}reset(){this._currentAudioRecv={startTime:0,eventSessionId:0,type:"login"},this._currentVideoRecv={startTime:0,eventSessionId:0,type:"login"},this._login=!1,this._unMuteAudio=!1,this._enableAudio=!1,this._unMuteVideo=!1,this._remoteUnmuteAudio=!1,this._remoteUnmuteVideo=!1,this._enableVideo=!1,this._audioExternal=!1,this._pushAudio=!1,this._videoExternal=!1,this._pushVideo=!1,this._autoSubscribeVideo=!1,this._autoSubscribeAudio=!1,this._autoSubscribe=!1,this._subscribeAudio=!1,this._subscribeVideo=!1,this._subscribe=!1,this._pushTrack=!1,this._multiChatMode=!1,this._firstAudioFrameTimer&&window.clearTimeout(this._firstAudioFrameTimer),this._firstVideoFrameTimer&&window.clearTimeout(this._firstVideoFrameTimer),this._firstAudioFrameInterval&&window.clearInterval(this._firstAudioFrameInterval),this._firstVideoFrameInterval&&window.clearInterval(this._firstVideoFrameInterval),this._transportDelayInterval&&window.clearInterval(this._transportDelayInterval)}get audioFirstFrameReceived(){return 3===this._audioFirstFrameState}get FirstFrameReceived(){return 3===this._audioFirstFrameState}}class DN{constructor(e,t){Xu(this,"_audioEventSessionId",eb()),Xu(this,"_videoEventSessionId",eb()),Xu(this,"_pcSessionId",void 0),Xu(this,"_firstAudioFrameTimer",void 0),Xu(this,"_firstVideoFrameTimer",void 0),Xu(this,"_stream",void 0),Xu(this,"_firstVideoFrameInterval",void 0),Xu(this,"_firstAudioFrameInterval",void 0),Xu(this,"_currentAudioSend",{startTime:0,eventSessionId:0,type:"login"}),Xu(this,"_currentVideoSend",{startTime:0,eventSessionId:0,type:"login"}),Xu(this,"_login",!1),Xu(this,"_publisher",!1),Xu(this,"_unMuteAudio",!1),Xu(this,"_enableAudio",!1),Xu(this,"_unMuteVideo",!1),Xu(this,"_enableVideo",!1),Xu(this,"_audioExternal",!1),Xu(this,"_pushAudio",!1),Xu(this,"_videoExternal",!1),Xu(this,"_pushVideo",!1),Xu(this,"_autoPublish",!1),Xu(this,"_publish",!1),Xu(this,"_timeout",1e4),Xu(this,"_audioFirstFrameState",0),Xu(this,"_videoFirstFrameState",0),Xu(this,"_monitor",void 0),Xu(this,"logger",void 0),this._ctx=e,this._stream=t,this._monitor=uS(t.engineId),this.logger=new LS("SendFrameObserver",0,t.engineId)}beginSendFrame(e,t){if("audio"===e){var i,o,r,s,n,a;this._audioEventSessionId++,this._currentAudioSend={startTime:Date.now(),eventSessionId:this._audioEventSessionId,type:t};const d={event_type:"begin_send",media_type:e,is_screen:!(null===(i=this._stream)||void 0===i||!i.isScreen),type:t,start:this._currentAudioSend.startTime,event_session_id:this._audioEventSessionId,vendor_mode:(null===(o=this._stream)||void 0===o?void 0:o.vendorCode)||0,pc_session_id:(null===(r=this._stream)||void 0===r?void 0:r.pcSessionId)||(null===(s=this._ctx.peerConnection)||void 0===s?void 0:s.getConnectionId()),capture_session_id:null===(n=this._stream)||void 0===n||null===(n=n.audioTrack)||void 0===n?void 0:n.captureSessionId};this._firstAudioFrameTimer&&window.clearTimeout(this._firstAudioFrameTimer),this._firstAudioFrameTimer=setTimeout((()=>{xN(this._ctx,"audio",this._stream,this._monitor),this.stopSendFrame("audio","timeout"),this._firstAudioFrameInterval&&window.clearInterval(this._firstAudioFrameInterval)}),this._timeout),this.logger.info("rtcFirstFrameSend",JSON.stringify(d)),null===(a=this._monitor)||void 0===a||a.report("rtc_first_frame",d),this._watchForFirstAudioFrameSend(),this._audioFirstFrameState=1,this._login=!0,this._publisher=!0,this._publish=!0,this._unMuteAudio=!0,this._pushAudio||(this._enableAudio=!0)}else if("video"===e){var d,c,l,u,h,_;this._videoEventSessionId++,this._currentVideoSend={startTime:Date.now(),eventSessionId:this._videoEventSessionId,type:t};const i={event_type:"begin_send",media_type:e,is_screen:!(null===(d=this._stream)||void 0===d||!d.isScreen),type:t,start:this._currentVideoSend.startTime,event_session_id:this._videoEventSessionId,vendor_mode:(null===(c=this._stream)||void 0===c?void 0:c.vendorCode)||0,pc_session_id:(null===(l=this._stream)||void 0===l?void 0:l.pcSessionId)||(null===(u=this._ctx.peerConnection)||void 0===u?void 0:u.getConnectionId()),capture_session_id:null===(h=this._stream)||void 0===h||null===(h=h.videoTrack)||void 0===h?void 0:h.captureSessionId};this._firstVideoFrameTimer&&window.clearTimeout(this._firstVideoFrameTimer),this._firstVideoFrameTimer=setTimeout((()=>{xN(this._ctx,"video",this._stream,this._monitor),this.stopSendFrame("video","timeout"),this._firstVideoFrameInterval&&window.clearInterval(this._firstVideoFrameInterval)}),this._timeout),this._watchForFirstVideoFrameSend(),this.logger.info("rtcFirstFrameSend",JSON.stringify(i)),null===(_=this._monitor)||void 0===_||_.report("rtc_first_frame",i),this._videoFirstFrameState=1,this._login=!0,this._publisher=!0,this._publish=!0,this._unMuteVideo=!0,this._pushVideo||(this._enableVideo=!0)}}stopSendFrame(e,t){if("audio"===e){var i,o,r,s,n,a,d,c;if(1!==this._audioFirstFrameState)return;const l={event_type:"sent_end",media_type:e,is_screen:!(null===(i=this._stream)||void 0===i||!i.isScreen),start:null===(o=this._currentAudioSend)||void 0===o?void 0:o.startTime,reason:t,result:!1,event_session_id:this._audioEventSessionId,type:null===(r=this._currentAudioSend)||void 0===r?void 0:r.type,vendor_mode:(null===(s=this._stream)||void 0===s?void 0:s.vendorCode)||0,pc_session_id:(null===(n=this._stream)||void 0===n?void 0:n.pcSessionId)||(null===(a=this._ctx.peerConnection)||void 0===a?void 0:a.getConnectionId()),capture_session_id:null===(d=this._stream)||void 0===d||null===(d=d.audioTrack)||void 0===d?void 0:d.captureSessionId};this._firstAudioFrameTimer&&window.clearTimeout(this._firstAudioFrameTimer),delete this._currentAudioSend,this.logger.info("rtcFirstFrameSend",JSON.stringify(l)),null===(c=this._monitor)||void 0===c||c.report("rtc_first_frame",l),this._audioFirstFrameState=2}else if("video"===e){var l,u,h,_,m,p,v,f,S,g,y,b,T,I,E,R,C,k,A;if(1!==this._videoFirstFrameState)return;const i={event_type:"sent_end",media_type:e,start:null===(l=this._currentVideoSend)||void 0===l?void 0:l.startTime,is_screen:!(null===(u=this._stream)||void 0===u||!u.isScreen),reason:t,result:!1,event_session_id:this._videoEventSessionId,type:null===(h=this._currentVideoSend)||void 0===h?void 0:h.type,vendor_mode:(null===(_=this._stream)||void 0===_?void 0:_.vendorCode)||0,pc_session_id:(null===(m=this._stream)||void 0===m?void 0:m.pcSessionId)||(null===(p=this._ctx.peerConnection)||void 0===p?void 0:p.getConnectionId()),capture_session_id:null===(v=this._stream)||void 0===v||null===(v=v.videoTrack)||void 0===v?void 0:v.captureSessionId,codec:null===(f=this._stream)||void 0===f?void 0:f.currentVideoCodec,track_frame_size_width:null===(S=this._stream)||void 0===S||null===(S=S.videoTrack)||void 0===S||null===(S=S.originTrack)||void 0===S?void 0:S.getSettings().width,track_frame_size_height:null===(g=this._stream)||void 0===g||null===(g=g.videoTrack)||void 0===g||null===(g=g.originTrack)||void 0===g?void 0:g.getSettings().height,track_frame_rate:null===(y=this._stream)||void 0===y||null===(y=y.videoTrack)||void 0===y||null===(y=y.originTrack)||void 0===y?void 0:y.getSettings().frameRate,stats_frame_size_width:null===(b=this._stream)||void 0===b||null===(b=b.getLocalStreamStats())||void 0===b||null===(b=b.videoStats)||void 0===b?void 0:b.frame_size_width,stats_frame_size_height:null===(T=this._stream)||void 0===T||null===(T=T.getLocalStreamStats())||void 0===T||null===(T=T.videoStats)||void 0===T?void 0:T.frame_size_height,stats_frame_rate_input:null===(I=this._stream)||void 0===I||null===(I=I.getLocalStreamStats())||void 0===I||null===(I=I.videoStats)||void 0===I?void 0:I.inputFrameRate,stats_frame_rate_sent:null===(E=this._stream)||void 0===E||null===(E=E.getLocalStreamStats())||void 0===E||null===(E=E.videoStats)||void 0===E?void 0:E.sentFrameRate,stats_frame_rate_encode:null===(R=this._stream)||void 0===R||null===(R=R.getLocalStreamStats())||void 0===R||null===(R=R.videoStats)||void 0===R?void 0:R.encoderOutputFrameRate,stats_frame_encoder_name:null===(C=this._stream)||void 0===C||null===(C=C.getLocalStreamStats())||void 0===C||null===(C=C.videoStats)||void 0===C?void 0:C.encoderName,stats_is_hardware_encoder_enabled:jg.H264_HW_ENCODER,stats_gpu_url:jg.GPU_URL||(null===(k=fb())||void 0===k?void 0:k.renderer)};this._firstVideoFrameTimer&&window.clearTimeout(this._firstVideoFrameTimer),delete this._currentVideoSend,this.logger.info("rtcFirstFrameSend",JSON.stringify(i)),null===(A=this._monitor)||void 0===A||A.report("rtc_first_frame",i),this._videoFirstFrameState=2,setTimeout((()=>{var i,o,r,s,n,a,d,c,l,u,h,_,m,p,v,f,S,g,y;const b={event_type:"sent_end",media_type:e,start:null===(i=this._currentVideoSend)||void 0===i?void 0:i.startTime,is_screen:!(null===(o=this._stream)||void 0===o||!o.isScreen),reason:t,result:!1,event_session_id:this._videoEventSessionId,type:null===(r=this._currentVideoSend)||void 0===r?void 0:r.type,vendor_mode:(null===(s=this._stream)||void 0===s?void 0:s.vendorCode)||0,pc_session_id:(null===(n=this._stream)||void 0===n?void 0:n.pcSessionId)||(null===(a=this._ctx.peerConnection)||void 0===a?void 0:a.getConnectionId()),capture_session_id:null===(d=this._stream)||void 0===d||null===(d=d.videoTrack)||void 0===d?void 0:d.captureSessionId,codec:null===(c=this._stream)||void 0===c?void 0:c.currentVideoCodec,track_frame_size_width:null===(l=this._stream)||void 0===l||null===(l=l.videoTrack)||void 0===l||null===(l=l.originTrack)||void 0===l?void 0:l.getSettings().width,track_frame_size_height:null===(u=this._stream)||void 0===u||null===(u=u.videoTrack)||void 0===u||null===(u=u.originTrack)||void 0===u?void 0:u.getSettings().height,track_frame_rate:null===(h=this._stream)||void 0===h||null===(h=h.videoTrack)||void 0===h||null===(h=h.originTrack)||void 0===h?void 0:h.getSettings().frameRate,stats_frame_size_width:null===(_=this._stream)||void 0===_||null===(_=_.getLocalStreamStats())||void 0===_||null===(_=_.videoStats)||void 0===_?void 0:_.frame_size_width,stats_frame_size_height:null===(m=this._stream)||void 0===m||null===(m=m.getLocalStreamStats())||void 0===m||null===(m=m.videoStats)||void 0===m?void 0:m.frame_size_height,stats_frame_rate_input:null===(p=this._stream)||void 0===p||null===(p=p.getLocalStreamStats())||void 0===p||null===(p=p.videoStats)||void 0===p?void 0:p.inputFrameRate,stats_frame_rate_sent:null===(v=this._stream)||void 0===v||null===(v=v.getLocalStreamStats())||void 0===v||null===(v=v.videoStats)||void 0===v?void 0:v.sentFrameRate,stats_frame_rate_encode:null===(f=this._stream)||void 0===f||null===(f=f.getLocalStreamStats())||void 0===f||null===(f=f.videoStats)||void 0===f?void 0:f.encoderOutputFrameRate,stats_frame_encoder_name:null===(S=this._stream)||void 0===S||null===(S=S.getLocalStreamStats())||void 0===S||null===(S=S.videoStats)||void 0===S?void 0:S.encoderName,stats_is_hardware_encoder_enabled:jg.H264_HW_ENCODER,stats_gpu_url:jg.GPU_URL||(null===(g=fb())||void 0===g?void 0:g.renderer)};this.logger.info("rtc_first_frame_statistics",JSON.stringify(b)),null===(y=this._monitor)||void 0===y||y.report("rtc_first_frame_statistics",b)}),8e3)}}sendFrameFinish(e){if("audio"===e){var t,i,o,r,s,n;if(1!==this._audioFirstFrameState)return;if(!this._currentAudioSend)return;const{type:a,startTime:d}=this._currentAudioSend,c={event_type:"sent_end",media_type:e,is_screen:!(null===(t=this._stream)||void 0===t||!t.isScreen),start:d,result:!0,event_session_id:this._audioEventSessionId,type:a,vendor_mode:(null===(i=this._stream)||void 0===i?void 0:i.vendorCode)||0,pc_session_id:(null===(o=this._stream)||void 0===o?void 0:o.pcSessionId)||(null===(r=this._ctx.peerConnection)||void 0===r?void 0:r.getConnectionId()),capture_session_id:null===(s=this._stream)||void 0===s||null===(s=s.audioTrack)||void 0===s?void 0:s.captureSessionId};delete this._currentAudioSend,this._firstAudioFrameTimer&&window.clearTimeout(this._firstAudioFrameTimer),this.logger.info("rtcFirstFrameSend",JSON.stringify(c)),null===(n=this._monitor)||void 0===n||n.report("rtc_first_frame",c),this._audioFirstFrameState=3}else if("video"===e){var a,d,c,l,u,h,_,m,p,v,f,S,g,y,b,T,I;if(1!==this._videoFirstFrameState)return;if(!this._currentVideoSend)return;const{type:t,startTime:i}=this._currentVideoSend,o={event_type:"sent_end",media_type:e,is_screen:!(null===(a=this._stream)||void 0===a||!a.isScreen),start:i,result:!0,event_session_id:this._videoEventSessionId,type:t,vendor_mode:(null===(d=this._stream)||void 0===d?void 0:d.vendorCode)||0,pc_session_id:(null===(c=this._stream)||void 0===c?void 0:c.pcSessionId)||(null===(l=this._ctx.peerConnection)||void 0===l?void 0:l.getConnectionId()),capture_session_id:null===(u=this._stream)||void 0===u||null===(u=u.videoTrack)||void 0===u?void 0:u.captureSessionId,codec:null===(h=this._stream)||void 0===h?void 0:h.currentVideoCodec,track_frame_size_width:null===(_=this._stream)||void 0===_||null===(_=_.videoTrack)||void 0===_||null===(_=_.originTrack)||void 0===_?void 0:_.getSettings().width,track_frame_size_height:null===(m=this._stream)||void 0===m||null===(m=m.videoTrack)||void 0===m||null===(m=m.originTrack)||void 0===m?void 0:m.getSettings().height,track_frame_rate:null===(p=this._stream)||void 0===p||null===(p=p.videoTrack)||void 0===p||null===(p=p.originTrack)||void 0===p?void 0:p.getSettings().frameRate,stats_frame_size_width:null===(v=this._stream)||void 0===v||null===(v=v.getLocalStreamStats())||void 0===v||null===(v=v.videoStats)||void 0===v?void 0:v._captureResolutionWidth,stats_frame_size_height:null===(f=this._stream)||void 0===f||null===(f=f.getLocalStreamStats())||void 0===f||null===(f=f.videoStats)||void 0===f?void 0:f._captureResolutionHeight,stats_frame_rate_input:null===(S=this._stream)||void 0===S||null===(S=S.getLocalStreamStats())||void 0===S||null===(S=S.videoStats)||void 0===S?void 0:S.inputFrameRate,stats_frame_rate_sent:null===(g=this._stream)||void 0===g||null===(g=g.getLocalStreamStats())||void 0===g||null===(g=g.videoStats)||void 0===g?void 0:g.sentFrameRate,stats_frame_rate_encode:null===(y=this._stream)||void 0===y||null===(y=y.getLocalStreamStats())||void 0===y||null===(y=y.videoStats)||void 0===y?void 0:y.encoderOutputFrameRate,stats_frame_encoder_name:null===(b=this._stream)||void 0===b||null===(b=b.getLocalStreamStats())||void 0===b||null===(b=b.videoStats)||void 0===b?void 0:b.encoderName,stats_is_hardware_encoder_enabled:jg.H264_HW_ENCODER,stats_gpu_url:jg.GPU_URL||(null===(T=fb())||void 0===T?void 0:T.renderer)};delete this._currentVideoSend,this._firstVideoFrameTimer&&window.clearTimeout(this._firstVideoFrameTimer),this.logger.info("rtcFirstFrameSend",JSON.stringify(o)),null===(I=this._monitor)||void 0===I||I.report("rtc_first_frame",o),this._videoFirstFrameState=3,setTimeout((()=>{var o,r,s,n,a,d,c,l,u,h,_,m,p,v,f,S,g;const y={event_type:"sent_end",media_type:e,is_screen:!(null===(o=this._stream)||void 0===o||!o.isScreen),start:i,result:!0,event_session_id:this._videoEventSessionId,type:t,vendor_mode:(null===(r=this._stream)||void 0===r?void 0:r.vendorCode)||0,pc_session_id:(null===(s=this._stream)||void 0===s?void 0:s.pcSessionId)||(null===(n=this._ctx.peerConnection)||void 0===n?void 0:n.getConnectionId()),capture_session_id:null===(a=this._stream)||void 0===a||null===(a=a.videoTrack)||void 0===a?void 0:a.captureSessionId,codec:null===(d=this._stream)||void 0===d?void 0:d.currentVideoCodec,track_frame_size_width:null===(c=this._stream)||void 0===c||null===(c=c.videoTrack)||void 0===c||null===(c=c.originTrack)||void 0===c?void 0:c.getSettings().width,track_frame_size_height:null===(l=this._stream)||void 0===l||null===(l=l.videoTrack)||void 0===l||null===(l=l.originTrack)||void 0===l?void 0:l.getSettings().height,track_frame_rate:null===(u=this._stream)||void 0===u||null===(u=u.videoTrack)||void 0===u||null===(u=u.originTrack)||void 0===u?void 0:u.getSettings().frameRate,stats_frame_size_width:null===(h=this._stream)||void 0===h||null===(h=h.getLocalStreamStats())||void 0===h||null===(h=h.videoStats)||void 0===h?void 0:h._captureResolutionWidth,stats_frame_size_height:null===(_=this._stream)||void 0===_||null===(_=_.getLocalStreamStats())||void 0===_||null===(_=_.videoStats)||void 0===_?void 0:_._captureResolutionHeight,stats_frame_rate_input:null===(m=this._stream)||void 0===m||null===(m=m.getLocalStreamStats())||void 0===m||null===(m=m.videoStats)||void 0===m?void 0:m.inputFrameRate,stats_frame_rate_sent:null===(p=this._stream)||void 0===p||null===(p=p.getLocalStreamStats())||void 0===p||null===(p=p.videoStats)||void 0===p?void 0:p.sentFrameRate,stats_frame_rate_encode:null===(v=this._stream)||void 0===v||null===(v=v.getLocalStreamStats())||void 0===v||null===(v=v.videoStats)||void 0===v?void 0:v.encoderOutputFrameRate,stats_frame_encoder_name:null===(f=this._stream)||void 0===f||null===(f=f.getLocalStreamStats())||void 0===f||null===(f=f.videoStats)||void 0===f?void 0:f.encoderName,stats_is_hardware_encoder_enabled:jg.H264_HW_ENCODER,stats_gpu_url:jg.GPU_URL||(null===(S=fb())||void 0===S?void 0:S.renderer)};this.logger.info("rtc_first_frame_statistics",JSON.stringify(y)),null===(g=this._monitor)||void 0===g||g.report("rtc_first_frame_statistics",y)}),8e3)}}setLogin(e){if(this._login!==e){var t,i;if(this._login=e,e)null!==(t=this._stream)&&void 0!==t&&t.videoTrack&&this._stream.pubVideo&&this.beginSendFrame("video","login"),null!==(i=this._stream)&&void 0!==i&&i.audioTrack&&this._stream.pubAudio&&this.beginSendFrame("audio","login");!e&&this._audioSending&&this.stopSendFrame("audio","leave_room"),!e&&this._videoSending&&this.stopSendFrame("video","leave_room")}}setPublish(e){if(this._publish!==e){var t,i;if(this._publish=e,e)(null===(t=this._stream)||void 0===t?void 0:t.videoTrack)&&this._stream.pubVideo&&this.beginSendFrame("video","publish"),(null===(i=this._stream)||void 0===i?void 0:i.audioTrack)&&this._stream.pubAudio&&this.beginSendFrame("audio","publish");!e&&this._audioSending&&this.stopSendFrame("audio","unpublish"),!e&&this._videoSending&&this.stopSendFrame("video","unpublish")}}setUnmuteAudio(e){var t;this._unMuteAudio!==e&&(this._unMuteAudio=e,null!==(t=this._stream)&&void 0!==t&&t.audioHasCapture&&(e&&this.beginSendFrame("audio","unmute"),!e&&this._audioSending&&this.stopSendFrame("audio","mute")))}setEnableAudio(e){var t;this._enableAudio!==e&&null!==(t=this._stream)&&void 0!==t&&t.pubAudio&&(this._enableAudio=e,e&&this.beginSendFrame("audio","enable"),!e&&this._audioSending&&this.stopSendFrame("audio","disable"))}setUnmuteVideo(e){var t;this._unMuteVideo!==e&&(this._unMuteVideo=e,null!==(t=this._stream)&&void 0!==t&&t.videoHasCapture&&(e&&this.beginSendFrame("video","unmute"),!e&&this._videoSending&&this.stopSendFrame("video","mute")))}setEnableVideo(e){var t;this._enableVideo!==e&&null!==(t=this._stream)&&void 0!==t&&t.pubVideo&&(this._enableVideo=e,e&&this.beginSendFrame("video","enable"),!e&&this._videoSending&&this.stopSendFrame("video","disable"))}setPushAudio(e){this._pushAudio!==e&&(this._pushAudio=e,e&&this.beginSendFrame("audio","push"),!e&&this._audioSending&&this.stopSendFrame("audio","stop_push"))}setPushVideo(e){this._pushVideo!==e&&(this._pushVideo=e,e&&this.beginSendFrame("video","push"),!e&&this._videoSending&&this.stopSendFrame("video","stop_push"))}setAutoPublish(e){this._autoPublish=e}setPublisher(e){this._publisher!==e&&(this._publisher=e,!e&&this._audioSending&&this.stopSendFrame("audio","audience"),!e&&this._videoSending&&this.stopSendFrame("video","audience"))}setDisconnect(){this._audioSending&&this.stopSendFrame("audio","connection_lost"),this._videoSending&&this.stopSendFrame("video","connection_lost"),this.reset()}setTimeout(e){this._timeout=e}setPCSessionId(e){this._pcSessionId=e}async _getFirstVideoFrameStats(){var e,t,i,o;const r=null===(e=this._stream)||void 0===e||null===(e=e.videoTrack)||void 0===e?void 0:e.preprocessingTrack,s=null===(t=this._stream)||void 0===t||null===(t=t.videoTransceiver)||void 0===t?void 0:t.sender,n=null!==(i=null===(o=this._stream)||void 0===o||null===(o=o.vendorHandler)||void 0===o?void 0:o.peer)&&void 0!==i?i:this._ctx.peerConnection;if(n&&r){return(await n.getStatsWithLowFrequency(r,!0,s)).filter((e=>"outbound-rtp"===e.type))}}async _getFirstAudioFrameStats(){var e,t,i,o;const r=null===(e=this._stream)||void 0===e||null===(e=e.audioTrack)||void 0===e?void 0:e.preprocessingTrack,s=null===(t=this._stream)||void 0===t||null===(t=t.audioTransceiver)||void 0===t?void 0:t.sender,n=null!==(i=null===(o=this._stream)||void 0===o||null===(o=o.vendorHandler)||void 0===o?void 0:o.peer)&&void 0!==i?i:this._ctx.peerConnection;if(n&&r){return(await n.getStatsWithLowFrequency(r,!0,s)).find((e=>"outbound-rtp"===e.type))}}_watchForFirstVideoFrameSend(){let e=-1,t=-1;this._firstVideoFrameInterval&&window.clearInterval(this._firstVideoFrameInterval),this._firstVideoFrameInterval=window.setInterval((async()=>{const i=await this._getFirstVideoFrameStats();let o=0,r=0;if(null==i||i.map((e=>{o+=e.framesSent,r+=e.packetsSent})),i&&i.length>0&&(o>e||r>t)){if(-1===e&&-1===t)return e=o,void(t=r);this.sendFrameFinish("video"),window.clearInterval(this._firstVideoFrameInterval)}}),100)}_watchForFirstAudioFrameSend(){let e=-1;this._firstAudioFrameInterval&&window.clearInterval(this._firstAudioFrameInterval),this._firstAudioFrameInterval=window.setInterval((async()=>{const t=await this._getFirstAudioFrameStats();if(t&&t.packetsSent>e){if(-1===e)return void(e=t.packetsSent);this.sendFrameFinish("audio"),window.clearInterval(this._firstAudioFrameInterval)}}),100)}reset(){this._login=!1,this._publisher=!1,this._unMuteAudio=!1,this._enableAudio=!1,this._unMuteVideo=!1,this._enableVideo=!1,this._audioExternal=!1,this._pushAudio=!1,this._videoExternal=!1,this._pushVideo=!1,this._autoPublish=!1,this._publish=!1,this._audioFirstFrameState=0,this._videoFirstFrameState=0,this._currentAudioSend={startTime:0,eventSessionId:0,type:"login"},this._currentVideoSend={startTime:0,eventSessionId:0,type:"login"},window.clearTimeout(this._firstAudioFrameTimer),window.clearTimeout(this._firstVideoFrameTimer),window.clearInterval(this._firstAudioFrameInterval),window.clearInterval(this._firstVideoFrameInterval)}destroy(){this.reset(),delete this._stream}get _audioSending(){return 1===this._audioFirstFrameState}get _videoSending(){return 1===this._videoFirstFrameState}}const UN={audio:{delay:1200,stallRadio:.3},video:{delay:1200,stallRadio:.6},screen_audio:{delay:1600,stallRadio:.8},screen_video:{delay:1600,stallRadio:.8}};class ZN{constructor(e){Xu(this,"_preUplinkStats",new Map),Xu(this,"_preDownlinkStats",new Map),Xu(this,"_timer",void 0),Xu(this,"_delayTimer",void 0),Xu(this,"reportor",void 0),this._ctx=e}updateUplinkStats(e,t){const{audioStats:i,videoStats:o,isScreen:r}=e;if(i.sendKBitrate>0&&i.rtt){const e=r?"screen_audio":"audio",{rtt:t,_fractionLost:o,_retransmittedRate:s}=i,n=this._getQosLevel(t,o||0,s||0),a=this._preUplinkStats.get(e)||[n];this._preUplinkStats.set(e,[...a,n].slice(-2))}if(o.sentKBitrate>0&&o.rtt){const i=r?"screen_video":"video";let{_fractionLost:s}=o;const{rtt:n,_sendBandWidth:a,_retransmittedRate:d}=o;0===a&&(s=Math.max(.65,s));const c=this._getQosLevel(n,s||0,d||0),l=this._getUplinkVideoQoE(e,t),u=this._getVideoUplinkNetworkQuality(c,l),h=this._preUplinkStats.get(i)||[u];this._preUplinkStats.set(i,[...h,u].slice(-2))}this._startNetworkQualityReport()}updateDownlinkStats(e,t){if(!t)return;const{audioActive:i,videoActive:o}=this._getStreamActiveState(t),{audioStats:r,videoStats:s,isScreen:n,userId:a}=e;let d,c,l=!0,u=!0;if(i)if(0===r.receivedKBitrate)l=!1;else{const{rtt:e,audioLossRate:t,stallDuration:i,statsInterval:o,e2eDelay:a}=r,c=i/o,l=n?"screen_audio":"audio",u=this._getQosLevel(e,t||0,s._retransmittedRate||0),h=this._getDownlinkQoE(l,c,a);d=this._getNetworkQuality(u,h)}if(o)if(0===s.receivedKBitrate||0===s.rtt)u=!1;else{const{rtt:e,videoLossRate:t,stallDuration:i,statsInterval:o,e2eDelay:r,_retransmittedRate:a}=s,d=i/o,l=n?"screen_video":"video",u=this._getQosLevel(e,t||0,a||0),h=this._getDownlinkQoE(l,d,r);c=this._getNetworkQuality(u,h)}const h="".concat(a).concat(n?"_screen":"");if(!l&&!u)return void this._preDownlinkStats.delete(h);const _=d&&c?Math.ceil((d+c)/2):d||c;if(_){const e=this._preDownlinkStats.get(h)||[_];this._preDownlinkStats.set(h,[...e,_].slice(-2)),this._startNetworkQualityReport()}}destroy(){this._timer&&(window.clearInterval(this._timer),delete this._timer),this._delayTimer&&(window.clearTimeout(this._delayTimer),delete this._delayTimer),this._preUplinkStats.clear(),this._preDownlinkStats.clear()}_startNetworkQualityReport(){this._delayTimer||this._timer||(this._preUplinkStats.size>0||this._preDownlinkStats.size>0)&&(this._delayTimer=setTimeout((()=>{delete this._delayTimer,this._reportNetworkQuality(),this._timer=window.setInterval((()=>{this._reportNetworkQuality()}),2e3)}),300))}_reportNetworkQuality(){var e;let t,i;if(["connected","connecting"].includes(null===(e=this._ctx.handler)||void 0===e?void 0:e.getConnectionState())){const e=this._getBetterQualityAndRemoveOldest("audio","up"),o=this._getBetterQualityAndRemoveOldest("video","up");t=e&&o?Math.ceil((e+o)/2):e||o||this._getBetterQualityAndRemoveOldest("screen_video","up")||this._getBetterQualityAndRemoveOldest("screen_audio","up")||mh.EXCELLENT;const r=Array.from(this._preDownlinkStats.keys()).map((e=>this._getBetterQualityAndRemoveOldest(e,"down"))).filter((e=>e));i=Math.ceil(r.reduce(((e,t)=>t+e),0)/r.length)||mh.UNKNOWN}else t=i=mh.DOWN;navigator.onLine||(t=mh.DOWN,i=mh.DOWN),"function"==typeof this.reportor&&this.reportor(t,i)}_getNetworkQuality(e,t){return 1===t?Math.max(e-2,1):2===t?e:Math.min(e+1,5)}_getVideoUplinkNetworkQuality(e,t){return 1===t||0===t?e:2===t?Math.min(e+1,5):Math.min(e+2,5)}_getQosLevel(e,t,i){let o;return o=(!e||e<=250)&&t<=.15?1:(!e||e<=500)&&t<=.3?2:(!e||e<=750)&&t<=.45?3:(!e||e<=1e3)&&t<=.6?4:5,i>.5?o=Math.max(o,4):i>.35?o=Math.max(o,3):i>.15&&(o=Math.max(o,2)),o}_getUplinkQoE(e,t){let i=0;switch(e){case"audio":case"video":i=t<.05?1:t<.1?2:3;break;case"screen_video":case"screen_audio":i=t<.04?1:t<.08?2:3}return i}_getUplinkVideoQoE(e,t){var i;const o=(null==e||null===(i=e.videoStats)||void 0===i?void 0:i.rid)||"0";if(!t)return 0;const r=t.pubAttributes.videoDescriptions[o],s=e.videoStats,n=s.encodedFrameWidth*s.encodedFrameHeight/(r.width*r.height),a=s.sentFrameRate/r.framerate;let d=0,c=0;return"number"!=typeof n||Number.isNaN(n)||(d=n>=.9?1:n<.9&&n>=.8?2:3),"number"!=typeof a||Number.isNaN(a)||(c=a>=.8?1:a<.8&&a>=.6?2:3),Math.max(0,d,c)}_getDownlinkQoE(e,t,i){const o=UN[e];return t>o.stallRadio||i>o.delay||t>o.stallRadio/2&&i>o.delay/2?3:(t>o.stallRadio/2||o.delay,2)}_getBetterQualityAndRemoveOldest(e,t){let i=mh.UNKNOWN;const o="up"===t?this._preUplinkStats:this._preDownlinkStats,r=o.get(e);if(r){const t=r.filter((e=>e));t.length>0&&(i=Math.min(...t)),r.shift(),0===r.length&&o.delete(e)}return i}_getStreamActiveState(e){let{subMediaType:t,_attributes:i,subVideo:o,subAudio:r}=e;return{audioActive:r&&rb(t)&&i.localaudio&&i.audiostream,videoActive:o&&sb(t)&&i.localvideo&&i.videostream}}}class WN{constructor(e){Xu(this,"_timer",void 0),Xu(this,"_remoteVideoSizeCache",{}),Xu(this,"_remoteScreenSizeCache",{}),Xu(this,"onchange",void 0),this._room=e,this._start()}destroy(){this._timer&&(window.clearInterval(this._timer),delete this._timer),this._remoteVideoSizeCache={},this._remoteScreenSizeCache={}}_start(){this._timer||(this._timer=window.setInterval((()=>{const e={},t={};this._room.remoteStreams.forEach(((i,o)=>{i.forEach((i=>{var r;const s=null===(r=i.videoTrack)||void 0===r?void 0:r.preprocessingTrack;if(s){const r=i.isScreen?this._remoteScreenSizeCache:this._remoteVideoSizeCache,{width:d=0,height:c=0}=r[o]||{};let l=0,u=0;if(US){var n,a;({width:l,height:u}=null!==(n=null==i||null===(a=i.videoTrack)||void 0===a?void 0:a.getSizeByPlayer())&&void 0!==n?n:{width:0,height:0})}else{const e=s.getSettings();l=e.width||0,u=e.height||0}c===u&&d===l||"function"==typeof this.onchange&&this.onchange(o,i.isScreen,l,u),delete r[o],(i.isScreen?t:e)[o]={width:l,height:u}}}))})),Object.keys(this._remoteVideoSizeCache).forEach((e=>{"function"==typeof this.onchange&&this.onchange(e,!1,0,0)})),Object.keys(this._remoteScreenSizeCache).forEach((e=>{"function"==typeof this.onchange&&this.onchange(e,!0,0,0)})),this._remoteVideoSizeCache=e,this._remoteScreenSizeCache=t}),1e3))}}const XN=Array.from((new TextEncoder).encode("subt")),GN={1:Eg.SUBTITLE_ERR_POSTPROCESS,2:Eg.SUBTITLE_ERR_CONNECTION_ERROR,3:Eg.SUBTITLE_ERR_PROCESS_ERROR},FN=new LS("SubtitleTool",1);class HN{constructor(e,t){Xu(this,"_taskId",void 0),Xu(this,"_sourceLanguage","zh"),Xu(this,"_updating",!1),Xu(this,"onEvent",void 0),Xu(this,"onMessage",void 0),Xu(this,"_preConfig",void 0),Xu(this,"_timer",void 0),this._ctx=e,this._roomConf=t;const{extraInfo:i}=t.userInfo;if(i)try{const e=JSON.parse(i);e.source_language&&(this._sourceLanguage=e.source_language)}catch(o){}}async start(e){FN.info("start","Invoke config: %o",e),wg(e.mode,"mode",[bh.ASR_ONLY,bh.ASR_AND_TRANSLATION]);const t=Array.isArray(e.targetLanguage)?e.targetLanguage:[e.targetLanguage||""];if(e.mode===bh.ASR_AND_TRANSLATION&&t.findIndex((e=>-1===KN.indexOf(e)))>-1)throw new Cg(Eg.INVALID_PARAMS,"Invalid targetLanguage.");if(this._taskId)throw new Cg(Eg.SUBTITLE_ALREADY_ON,"Already turned on subtitle");this._preConfig={targetLanguage:t,mode:e.mode},this._taskId=(Date.now().toString()+this._roomConf.roomId+this._roomConf.userId).substring(0,20),await this._sendSubtitleSignalingWithRetry(e,this._taskId)}async update(e){if(FN.info("update","Invoke config: %o",e),!this._taskId)throw new Cg(Eg.SUBTITLE_NOT_TURNED_ON,"Start subtitle first.");this._sourceLanguage=e.sourceLanguage,this._updating=!0;try{await this._ctx.signalingManager.sendSignaling("controlMessage",this._genChangeSubtitleLanguageSignaling(e,this._taskId))}catch(t){throw this._updating=!1,t}}stop(){FN.info("stop","Invoke"),this._taskId&&this._ctx.signalingManager.sendSignaling("controlMessage",{type:"subtitle",action:"stopped",appId:this._ctx.appId,roomId:this._roomConf.roomId,userId:this._roomConf.userId,taskId:this._taskId}).finally((()=>{var e;delete this._taskId,null===(e=this.onEvent)||void 0===e||e.call(this,{event:Th.STOPPED}),this._clearTimer()}))}async reconnect(){this._taskId&&this._preConfig&&(await this._ctx.signalingManager.sendSignaling("controlMessage",{type:"subtitle",action:"stopped",appId:this._ctx.appId,roomId:this._roomConf.roomId,userId:this._roomConf.userId,taskId:this._taskId}),delete this._taskId,this.start(this._preConfig))}getConfig(){return this._preConfig}destroy(){FN.info("destroy","Invoke"),this.stop(),delete this._preConfig,delete this._taskId}onResult(e){const{error:t,errorMessage:i,eventType:o}=e.body;if(0!==t){var r;const e=new Cg(GN[t]||Eg.SUBTITLE_ERR_UNKNOWN,i||"");null===(r=this.onEvent)||void 0===r||r.call(this,{event:Th.ERROR,errorCode:e.code,errorMessage:e.message}),this._clearTimer()}else if("SubtitleStarted"===o){var s;null===(s=this.onEvent)||void 0===s||s.call(this,{event:Th.STARTED}),this._clearTimer()}else if(this._updating&&"LanguageChanged"===o){var n;this._updating=!1,null===(n=this.onEvent)||void 0===n||n.call(this,{event:Th.UPDATED})}}onMessageRecv(e){if(arguments.length>1&&void 0!==arguments[1]&&arguments[1]||this._taskId&&this._preConfig){const i=YN(e);if(!i||0===i.length)return!1;if(this._taskId&&this._preConfig){const{mode:e,targetLanguage:o}=this._preConfig,r=[];var t;if(i.forEach((t=>{if(e===bh.ASR_ONLY)t.mode===e&&r.push(t);else{const e=o.includes(t.language);(e||t.mode===bh.ASR_ONLY)&&r.push(t),t.mode===bh.ASR_ONLY&&e&&r.push(Fu(Fu({},t),{},{mode:bh.ASR_AND_TRANSLATION}))}})),r.length>0)null===(t=this.onMessage)||void 0===t||t.call(this,r)}return!0}return!1}async _sendSubtitleSignalingWithRetry(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;await this._ctx.signalingManager.sendSignaling("controlMessage",this._genSubtitleSignaling(e,t)),this._timer=self.setTimeout((()=>{var o;2===i?(null===(o=this.onEvent)||void 0===o||o.call(this,{event:Th.ERROR,errorCode:Eg.TIME_OUT,errorMessage:"start subtitle timeout."}),delete this._timer,this.stop()):this._sendSubtitleSignalingWithRetry(e,t,i+1)}),HN.retryIntervel)}_genSubtitleSignaling(e,t){return{taskId:t,type:"subtitle",action:"started",roomId:this._roomConf.roomId,appId:this._ctx.appId,userId:this._roomConf.userId,subtitleMeta:{subtitleConfig:{mode:e.mode,usersConfig:[{userId:this._roomConf.userId,targetLanguages:Array.isArray(e.targetLanguage)?e.targetLanguage:[e.targetLanguage||""]}]},vendorConfig:{type:0}}}}_genChangeSubtitleLanguageSignaling(e,t){return{taskId:t,type:"subtitle",action:"subtitleUpdated",roomId:this._roomConf.roomId,appId:this._ctx.appId,userId:this._roomConf.userId,subtitleMeta:{protocol:1,languageConfig:{sourceLanguages:[{userId:this._roomConf.userId,languageCode:[e.sourceLanguage]}]}}}}_clearTimer(){this._timer&&(self.clearTimeout(this._timer),delete this._timer)}}Xu(HN,"retryIntervel",3e4);const YN=e=>{let{message:t}=e;if(t instanceof ArrayBuffer&&t.byteLength>8)try{const e=new DataView(t,0);let i=0;if(XN.every((t=>e.getUint8(i++)===t))){const o=e.getUint32(i);if(i+=4,o===e.byteLength-8){const e=Qy.ab2str(t.slice(8)),{data:i,type:o}=JSON.parse(e);if("subtitle"===o)return i}}}catch(i){}return!1},KN=["zh","zh-Hant","tn","vi","iu","it","id","hi","en","ho","he","es","el","uk","ur","tk","tr","ti","ty","tl","to","th","ta","te","sl","sk","ss","eo","sm","sg","st","sv","ja","tw","qu","pt","pa","no","nb","nr","my","bn","mn","mh","mk","ml","mr","ms","lu","ro","lt","lv","lo","kj","hr","kn","ki","cs","ca","nl","ko","ht","gu","ka","kl","km","lg","kg","fi","fj","fr","ru","ng","de","tt","da","ts","cv","fa","bs","pl","bi","nd","ba","bg","az","ar","af","sq","ab","os","ee","et","ay","lzh","am","ckb","cy","gl","ha","hy","ig","kmr","ln","nso","ny","om","sn","so","sr","sw","xh","yo","zu"];function BN(e,t){return Fu(Fu({},e),t)}function JN(e){const t={};return Object.keys(e).forEach((i=>{const o=e[i];try{Array.isArray(o)?t[i]=o.map((e=>null!==e&&"object"==typeof e?JN(e):e)):t[i]=null!==o&&"object"==typeof o?JN(o):o}catch(r){}})),t}function jN(e){return null===e?[]:Object.keys(e).map((t=>e[t]))}const zN=new LS("Locker",2);let QN=1;class qN{constructor(e){Xu(this,"lockingPromise",Promise.resolve()),Xu(this,"locks",0),Xu(this,"name",""),Xu(this,"lockId",void 0),Xu(this,"closeReason",void 0),this.lockId=QN++,e&&(this.name=e),zN.info("lock-".concat(this.name,"-").concat(this.lockId),"is created.")}get isLocked(){return this.locks>0}lock(){let e;this.locks+=1,zN.info("lock-".concat(this.name,"-").concat(this.lockId),"locked, current queue ".concat(this.locks,"."));const t=new Promise((t=>{e=()=>{this.locks-=1,zN.info("lock-".concat(this.name,"-").concat(this.lockId),"unlocked, current queue ".concat(this.locks,".")),t()}})),i=this.lockingPromise.then((()=>e));return this.lockingPromise=this.lockingPromise.then((()=>t)),i}}var $N=(e=>(e[e.SEND=0]="SEND",e[e.FEEDBACK=1]="FEEDBACK",e))($N||{}),ew=(e=>(e[e.P2P=0]="P2P",e[e.SIGNAL=1]="SIGNAL",e[e.BROADCAST=2]="BROADCAST",e[e.BUSINESS_SERVER=3]="BUSINESS_SERVER",e))(ew||{}),tw=(e=>(e[e.SUCCESS=0]="SUCCESS",e[e.TIMEOUT=1]="TIMEOUT",e[e.BROKEN=2]="BROKEN",e[e.NO_RECEIVER=3]="NO_RECEIVER",e[e.NO_RELAYPATH=4]="NO_RELAYPATH",e[e.EXCEED_QPS=5]="EXCEED_QPS",e[e.SEND_TO_SERVER_ERROR=17]="SEND_TO_SERVER_ERROR",e[e.SERVER_RESPONSE_ERROR=18]="SERVER_RESPONSE_ERROR",e[e.NOT_JOIN=100]="NOT_JOIN",e[e.NOT_LOGIN=105]="NOT_LOGIN",e[e.SERVER_PARAMS_NOTSET=106]="SERVER_PARAMS_NOTSET",e[e.UNKNOWN=1e3]="UNKNOWN",e))(tw||{});const iw={0:[0,"success"],1:[Eg.USER_MESSAGE_TIMEOUT,"timeout, failed to send."],2:[Eg.USER_MESSAGE_BROKEN,"dataChannel broken, failed to send."],3:[Eg.USER_MESSAGE_NO_RECEIVER,"cannot find the receiver."],4:[Eg.USER_MESSAGE_NO_RECEIVER,"cannot find relay path."],5:[Eg.USER_MESSAGE_EXCEED_QPS,"cannot find relay path."],17:[Eg.USER_MESSAGE_SEND_TO_SERVER_ERROR,"failed to send to business server."],18:[Eg.USER_MESSAGE_SERVER_RESPONSE_ERROR,"business server response error."],100:[Eg.USER_MESSAGE_NOT_JOIN,"not join room"],105:[Eg.USER_MESSAGE_NOT_LOGIN,"not login."],106:[Eg.USER_MESSAGE_SERVER_PARAMS_NOTSET,"server param is not set."],1e3:[Eg.USER_MESSAGE_UNKNOWN,"unknown."]},ow=["msg"],rw=[],sw=[OI.ENGINE_CONTROL_MESSAGE];var nw=(e=>(e[e.C2S=0]="C2S",e[e.C2C=1]="C2C",e[e.C2GW=2]="C2GW",e[e.C2CDirect=3]="C2CDirect",e[e.C2RTM=4]="C2RTM",e))(nw||{});class aw extends EI.EventEmitter{constructor(e,t,i){super(),Xu(this,"_singlingCache",new Map),Xu(this,"_p2pCache",new Map),Xu(this,"_rttIds",{}),Xu(this,"_p2pMessageId",new ub),Xu(this,"_clearDataChannelListener",void 0),Xu(this,"_monitor",void 0),Xu(this,"logger",void 0),this.id=e,this._dataChannel=t,this.connectionIds=i,this._clearDataChannelListener=this._handleHandler(),this._monitor=uS(e),this.logger=new LS("DataChannelSignaling",3,e)}destroy(){this._clearDataChannelListener(),delete this._dataChannel,this._singlingCache.forEach(((e,t)=>{e.error(new Cg(Eg.OPERATION_CANCEL,"disconnect")),this._singlingCache.delete(t)})),this._singlingCache.clear(),this._p2pCache.clear(),this._rttIds={}}sendSignaling(e,t,i){let o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:6e4;return new Promise(((r,s)=>{var n;const a=this._genHeader(i);a.id=$y();const d=a.id.join("-"),c=Fu({error_code:0,message:JSON.stringify(t),signaling_event:"call-".concat(e),signaling_type:"Send",stream_id:t.streamId,stream_user_id:t.streamUserId,direction:"up",event_session_id:d},this.connectionIds);null===(n=this._monitor)||void 0===n||n.report("rtc_signaling",c);const l="customMessage"===e;l&&Qf(this.id,Number(a.id.join("")),t);const u=setTimeout((()=>{this._singlingCache.delete(d),s(new Cg(Eg.TIME_OUT,"".concat(e," message time out"))),l&&$f(this.id,t,999)}),o);this._singlingCache.set(d,{start:jy(),signalingType:e,success:e=>{clearTimeout(u),r(e),l&&$f(this.id,t,0)},error:e=>{clearTimeout(u),s(e),l&&$f(this.id,t,e.code)},id:d}),this.logger.info("Signal",">>>>>> [".concat(e,"{").concat(a.functionType,"}][").concat(d,"]"),t),this._sendMessage(e,a,t)}))}sendPingSignaling(){return this.sendSignaling("CheckConnectivity",{ts:Date.now()},{functionType:2})}async sendP2PMessage(e,t){let{msg:i}=e,o=kf(e,ow);const r=i instanceof ArrayBuffer;return this._sendP2PMessage(Jf(this.id,Fu(Fu({ver:1,id:this._p2pMessageId.getMessageId(),time:Date.now(),dir:$N.SEND,type:ew.P2P,err:tw.SUCCESS},o),{},{binary:r,msg:r?await Qy.ab2b64str(i):i})),t)}_sendP2PMessage(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const i=this._genHeader(Fu(Fu({needAck:!0,functionType:1},t),{},{id:$y()}));return tb(e.msg)?this._rttIds[e.id]=e.id:e.dir===$N.SEND&&this.logger.info("_sendP2PMessage [DC Signaling p2p{".concat(i.functionType,"} >>]"),JSON.stringify(e)),new Promise(((t,o)=>{if(e.dir===$N.SEND){const i=setTimeout((()=>{this._p2pCache.delete(e.id),o(new Cg(Eg.USER_MESSAGE_TIMEOUT,"P2P message timeout")),zf(this.id,e,999)}),12e3);this._p2pCache.set(e.id,{success:(o,r)=>{clearTimeout(i),t(r),zf(this.id,e,0)},error:t=>{clearTimeout(i),zf(this.id,e,t.err);const[r,s]=iw[t.err]||[Eg.USER_MESSAGE_UNKNOWN,"err: ".concat(t.err,", msg: ").concat(t.msg)];o({err:t.err,code:r,message:t.msg||s})}})}try{this._sendMessage("p2p",i,e)}catch(r){throw r.code===Eg.NOT_CONNECTED_YET&&(r.code=Eg.USER_MESSAGE_BROKEN),r}}))}_sendMessage(e,t,i){if(!this._dataChannel||"open"!==this._dataChannel.readyState)throw new Cg(Eg.NOT_CONNECTED_YET,"DataChannel not open");const o=Qg("SIGNAL_COMPRESSION")||t.zip,r=t.version+(Number(o)<<4)+(Number(t.encrypt)<<5),s=Number(t.needAck)+(Number(t.direction)<<1)+(Number(t.functionType)<<2)+(Number(t.binary)<<6),n=Qy.str2ab(JSON.stringify([e,i])),a=zy(Uint8Array,[r,s,...t.id||[]],o||t.zip?rf.deflate(new Uint8Array(n)):new Uint8Array(n));try{this._dataChannel.send(a.buffer)}catch(c){var d;throw null===(d=this._monitor)||void 0===d||d.report("rtc_error",{message:"datachannel send error: ".concat(c.message),error_code:JP.DC_SEND_ERROR}),c}"p2p"===e?jf(this.id,i,a.buffer.byteLength):"customMessage"===e&&eS(this.id,i,a.buffer.byteLength)}_dispartData(e){const t=new Uint8Array(e);let i=0;const o=t[i++],r=t[i++],s={version:15&o,zip:!(16&~o),encrypt:!(32&~o),needAck:!(1&~r),direction:(2&r)>>1,functionType:(60&r)>>2,binary:!(64&~r)};if(s.needAck||1===s.direction){for(;i<=6;i++)if(128&~t[i]){i++;break}s.id=Array.from(t.slice(2,i))}return{header:s,data:t.slice(i)}}_feedbackSignaling(e,t,i){const o=this._genHeader({needAck:!0,direction:1,id:e.split("-").map((e=>Number(e)))});rw.includes(t)||this.logger.info("Signal",">>>>>> [".concat(t,"-res][").concat(e,"]")),this._sendMessage("".concat(t,"-res"),o,i)}async _handleMessage(e){const t=Date.now(),{byteLength:i}=e,o=this._dispartData(e);let{data:r}=o;const{header:s}=o;if(s.zip){const e=new rf.Inflate;e.push(r,!0),r=e.result}const n=Qy.ab2str(r);let a=[];try{a=JSON.parse(n)}catch(c){var d;if(c instanceof Error)null===(d=this._monitor)||void 0===d||d.report("rtc_signaling_msg_error",Fu({error_code:-1,message:c.message,reason:"message parse failed"},this.connectionIds));return}switch(s.functionType){case 0:case 4:this.C2S(s,a,n,i,t);break;case 1:this.C2C(a,i,t);break;case 2:this.C2GW(s,a,n)}}async C2S(e,t,i,o,r){var s;const n=(null===(s=e.id)||void 0===s?void 0:s.join("-"))||"";if(1===e.direction)this._handleAckMessage(n,t[0]||{},i,e.functionType);else if(Array.isArray(t)){var a;const s=t[0];t=t[1],rw.includes(s)||this.logger.info("Signal","<<<<<< ".concat(s,"{").concat(e.functionType,"}"),t,n),sw.includes(s)||this._feedbackSignaling(n,s,s===OI.ON_CUSTOM_MESSAGE?Fu(Fu({},t),{},{message:""}):""),t.binary&&"string"==typeof t.message&&(t.message=await Qy.b64str2ab(t.message,this._monitor));const d=Date.now();this.emit(s,Fu({},t)),s===OI.ON_CUSTOM_MESSAGE&&tS(this.id,t,{msg_size:o,recv_msg_ts:r,fwd_msg_ts:d}),null===(a=this._monitor)||void 0===a||a.report("rtc_signaling",Fu({error_code:0,message:i,signaling_event:"on-".concat(s),signaling_type:"Recv",stream_id:t.streamId,stream_user_id:t.clientId,direction:"down"},this.connectionIds))}}async C2C(e,t,i){var o,r,s,n;Array.isArray(e)&&(e=e[1]);const a=null===(o=e)||void 0===o?void 0:o.id;switch(this._rttIds[a]||(null===(r=e)||void 0===r?void 0:r.dir)===$N.FEEDBACK||tb(null===(s=e)||void 0===s?void 0:s.msg)?delete this._rttIds[a]:this.logger.info("Signal","<<<<<< p2p response",e),e.dir){case $N.SEND:const o=Date.now();if(!tb(null===(n=e)||void 0===n?void 0:n.msg)){const{binary:t,msg:i,room:o,to:r,from:s}=e,n=""===o?t?OI.USER_BINARY_MESSAGE_RECEIVED_OUTSIDE_ROOM:OI.USER_MESSAGE_RECEIVED_OUTSIDE_ROOM:t?OI.USER_BINARY_MESSAGE_RECEIVED:OI.USER_MESSAGE_RECEIVED;r?this.emit(n,Fu(Fu({},e),{},{msg:t?await Qy.b64str2ab(i,this._monitor):i})):this.emit(OI.ON_CUSTOM_MESSAGE,{clientId:s,binary:t,message:t?await Qy.b64str2ab(i,this._monitor):i})}this._sendP2PMessage(Fu(Fu({},e),{},{dir:$N.FEEDBACK,msg:""})),qf(this.id,e,{msg_size:t,recv_msg_ts:i,fwd_msg_ts:o});break;case $N.FEEDBACK:this._handleP2PMsgFeedback(e)}}C2GW(e,t,i){if(1===e.direction){var o;const r=(null===(o=e.id)||void 0===o?void 0:o.join("-"))||"";this._handleAckMessage(r,t[0]||{},i,e.functionType)}else{const[o,n={}]=t;if("RXMediaMsg"===o){var r;const{type:e,data:t}=n;switch(null===(r=this._monitor)||void 0===r||r.report("rtc_signaling",Fu({error_code:0,message:i,signaling_event:"on-".concat(e),signaling_type:"Recv",stream_id:"",stream_user_id:"",direction:"down"},this.connectionIds)),e){case"RSCP":try{const i=JSON.parse(t);Array.isArray(i)&&this.emit(e,i)}catch(s){}break;case"RTT":try{const i=JSON.parse(t);i.length&&this.emit(e,i[0])}catch(s){}break;case"SSC":try{const i=JSON.parse(t);i.length&&(this.logger.info("Signal","<<<<<< ".concat(e),i),this.emit(e,i[0]))}catch(s){}}}else"engineControlMessage"===o&&this.C2S(e,t,i,0,0)}}_handleHandler(){const e=e=>{this.logger.warn("_handleHandler","dataChannel close",e)},t=e=>{this.logger.error("_handleHandler","dataChannel error",e)},i=e=>{this._handleMessage(e.data)};return this._dataChannel.addEventListener("close",e),this._dataChannel.addEventListener("error",t),this._dataChannel.addEventListener("message",i),()=>{const o=this._dataChannel;null==o||o.removeEventListener("close",e),null==o||o.removeEventListener("error",t),null==o||o.removeEventListener("message",i)}}_genHeader(){return Fu({version:2,zip:!1,encrypt:!1,needAck:!0,direction:0,functionType:0,binary:!1},arguments.length>0&&void 0!==arguments[0]?arguments[0]:{})}_handleAckMessage(e,t,i,o){var r;const s=this._singlingCache.get(e);s&&(this._singlingCache.delete(e),200===t.code?s.success(t):s.error(t),this.logger.info("Signal","<<<<<< [".concat(s.signalingType,"{").concat(o,"}-ack] ").concat(e),t));const n=Fu({error_code:0,message:i,signaling_event:null==s?void 0:s.signalingType,signaling_type:"Ack",stream_id:"",stream_user_id:"",direction:"down",elapse:s?jy()-s.start:0},this.connectionIds);null!=s&&s.id&&(n.event_session_id=s.id),null===(r=this._monitor)||void 0===r||r.report("rtc_signaling",n)}_handleP2PMsgFeedback(e){const t=this._p2pCache.get(e.id);t&&(this._p2pCache.delete(e.id),e.err===tw.SUCCESS?t.success(e.id,e):t.error(e))}}class dw{constructor(e,t){Xu(this,"roomId",void 0),Xu(this,"userInfo",void 0),Xu(this,"userId",void 0),Xu(this,"sessionId",sm()),Xu(this,"token",void 0),Xu(this,"rtcVid",void 0),Xu(this,"joinPromise",void 0),Xu(this,"startJoinTimestamp",void 0),Xu(this,"_liveControlMessage",void 0),Xu(this,"_userStreamMap",new Map),Xu(this,"_roomConfig",{isAutoPublish:!0,isAutoSubscribeAudio:!0,isAutoSubscribeVideo:!0,roomProfileType:vh.communication}),Xu(this,"_vendorConfig",{enableMultiVendor:!1,vendorCode:0}),Xu(this,"_roomAttr",{multiChatMode:!1,bigRoomMode:!1}),Xu(this,"_tokenPublishPrivilegeExpired",!1),Xu(this,"_tokenSubscribePrivilegeExpired",!1),Xu(this,"_streamQueueMap",new Map),Xu(this,"_monitor",void 0),this._ctx=t,this.roomId=e.roomId,this.userInfo=e.userInfo,this.userId=e.userInfo.userId,this.token=e.token,this._monitor=uS(t.id)}async checkJoinRoom(){await this.joinPromise}get vendorConfig(){return this._vendorConfig}setVendorConfig(e){this._vendorConfig=e}updateRoomAttributes(e){this._roomAttr=Fu(Fu({},this._roomAttr),e)}setLiveControlMessage(e){this._liveControlMessage=e}getLiveControlMessage(){return this._liveControlMessage}isMultiChatMode(){return this._roomAttr.multiChatMode}updateRoomConfig(e){return this._roomConfig=BN(this._roomConfig,e),this._roomConfig}get isAutoPublish(){return!this.isRTSOnlyRoom()&&this._roomConfig.isAutoPublish}get isAutoSubscribeAudio(){return!this.isRTSOnlyRoom()&&this._roomConfig.isAutoSubscribeAudio}get isAutoSubscribeVideo(){return!this.isRTSOnlyRoom()&&this._roomConfig.isAutoSubscribeVideo}get remoteVideoConfig(){return this._roomConfig.remoteVideoConfig}get roomProfileType(){return this._roomConfig.roomProfileType||vh.communication}isRTSOnlyRoom(){return this._roomConfig.roomMode===Ph.ROOM_MODE_RTS_ONLY}get rtsOnlySignalHeader(){return this.isRTSOnlyRoom()?{functionType:nw.C2RTM}:void 0}updateUserPubInfo(e){const t=this._userStreamMap.get(e.clientId)||{};e.screen?(t.screenAudio=e.attributes.audiostream,t.screenVideo=e.attributes.videostream):(t.audio=e.attributes.audiostream,t.video=e.attributes.videostream),this._userStreamMap.set(e.clientId,t)}getUserPubInfo(e){return Fu({audio:!1,video:!1,screenAudio:!1,screenVideo:!1},this._userStreamMap.get(e)||{})}resetUserPubInfo(){this._userStreamMap.clear()}get tokenPublishPrivilegeExpired(){return this._tokenPublishPrivilegeExpired}get tokenSubscribePrivilegeExpired(){return this._tokenSubscribePrivilegeExpired}setTokenPublishPrivilegeExpired(e){this._tokenPublishPrivilegeExpired=e}setTokenSubscribePrivilegeExpired(e){this._tokenSubscribePrivilegeExpired=e}getStayRoomDuration(){return this.startJoinTimestamp?jy()-this.startJoinTimestamp:0}getStreamQueueLock(e){let t=this._streamQueueMap.get(e);return t||(t=new qN(e),this._streamQueueMap.set(e,t)),t}report(e,t,i){var o;null===(o=this._monitor)||void 0===o||o.report(e,Fu({room_id:this.roomId,user_id:this.userId,rtc_session_id:this.sessionId,rtc_vid:this.rtcVid},t),i)}}const cw=6e4,lw=(e,t,i)=>{i.info(e,"userId: %o, subAudio: %o, subVideo: %o, audioMid: %o, videoMid: %o, sequenceId: %o",t.userId,t.subAudio,t.subVideo,t.audioMid,t.videoMid,t.sequenceId)};function uw(e,t,i){const o=i.value;return i.value=async function(){if(!this._ctx.signalingManager.isConnected())throw new Cg(Eg.NOT_CONNECTED_YET,"error in ".concat(t,": try again after connect"));try{await(this._roomConf||this.config).checkJoinRoom()}catch(s){throw new Cg(Eg.JOIN_ROOM_FAILED,"error in ".concat(t,": try again after joined"))}for(var e=arguments.length,i=new Array(e),r=0;r<e;r++)i[r]=arguments[r];return o.apply(this,i)},i}function hw(e,t,i){const o=i.value;return i.value=async function(){const e=this._roomConf,i=this._logger;for(var r=arguments.length,s=new Array(r),n=0;n<r;n++)s[n]=arguments[n];const a=s[0];if(null==a||!a.streamId)return null==o?void 0:o.apply(this,s);const{streamId:d}=a;i.info("streamQueue","lock stream %o, task %o",d.slice(-5),t);const c=await e.getStreamQueueLock(d).lock();try{return await(null==o?void 0:o.apply(this,s))}finally{i.info("streamQueue","unlock stream %o, task %o",d.slice(-5),t),c()}},i}var _w=Object.defineProperty,mw=Object.getOwnPropertyDescriptor,pw=(e,t,i,o)=>{for(var r,s=o>1?void 0:o?mw(t,i):t,n=e.length-1;n>=0;n--)(r=e[n])&&(s=(o?r(t,i,s):r(s))||s);return o&&s&&_w(t,i,s),s};class vw extends kI{constructor(e,t){super(),Xu(this,"_forwardDstRooms",new Map),Xu(this,"forwardStreamState","stopped"),this._ctx=e,this._roomConf=t}async startForwardStream2Rooms(e){if("running"===this.forwardStreamState||"paused"===this.forwardStreamState)throw new Cg(Eg.UNEXPECTED_INVOKE_FORWARD_STREAM,"should not invoke startForwardStreamToRooms in state: ".concat(this.forwardStreamState));const t=await this._sendForwardStreamSignaling("start",this._roomConf.roomId,e);this._updateDstRooms(e,t);const i=this._transformForwardStreamResult(t);return this.forwardStreamState="running",i}async updateForwardStream2Rooms(e){if("stopped"===this.forwardStreamState)throw new Cg(Eg.UNEXPECTED_INVOKE_FORWARD_STREAM,"should not invoke updateForwardStreamToRooms in state: ".concat(this.forwardStreamState));let t=this._mockForwardStreamResult(e);"running"===this.forwardStreamState&&(t=await this._sendForwardStreamSignaling("update",this._roomConf.roomId,e)),this._updateDstRooms(e,t);return this._transformForwardStreamResult(t)}async stopForwardStream2Rooms(){if("stopped"===this.forwardStreamState)throw new Cg(Eg.UNEXPECTED_INVOKE_FORWARD_STREAM,"should not invoke stopForwardStreamToRooms in state: ".concat(this.forwardStreamState));let e=this._mockForwardStreamResult([]);if("running"===this.forwardStreamState&&(e=await this._sendForwardStreamSignaling("stop",this._roomConf.roomId)),this._updateDstRooms([],e),[...this._forwardDstRooms.keys()].length>0)throw new Cg(Eg.UNEXPECTED_ERROR,"stopforwardstream failed: ".concat(JSON.stringify(e)));const t=this._transformForwardStreamResult(e);return this.forwardStreamState="stopped",t}async pauseForwardStream2AllRooms(){if("paused"===this.forwardStreamState||"stopped"===this.forwardStreamState)throw new Cg(Eg.UNEXPECTED_INVOKE_FORWARD_STREAM,"should not invoke pauseForwardStreamToAllRooms in state: ".concat(this.forwardStreamState));const e=await this._sendForwardStreamSignaling("stop",this._roomConf.roomId),t=this._transformForwardStreamResult(e);return this.forwardStreamState="paused",t}async resumeForwardStream2AllRooms(){if(!(arguments.length>0&&void 0!==arguments[0]&&arguments[0])&&["running","stopped"].includes(this.forwardStreamState))throw new Cg(Eg.UNEXPECTED_INVOKE_FORWARD_STREAM,"should not invoke resumeForwardStreamToAllRooms in state: ".concat(this.forwardStreamState));const e=this._getDstRooms(),t=await this._sendForwardStreamSignaling("start",this._roomConf.roomId,e);this._updateDstRooms(e,t);const i=this._transformForwardStreamResult(t);return this.forwardStreamState="running",i}resumeFromReconnect(){"running"===this.forwardStreamState&&this.resumeForwardStream2AllRooms(!0).then((e=>{e.forEach((e=>{e.state===Ih.FORWARD_STREAM_STATE_FAILURE&&this.safeEmit(wN.ON_FORWARD_STREAM_ERROR,e)}))}))}onForwardDstRoomUserKick(e){const t=[{dstRoomId:e.dstRoomId,code:200,forwardStreamType:"stop"}];this._updateDstRooms([],t),this.safeEmit(wN.ON_FORWARD_STREAM_ERROR,{roomId:e.dstRoomId,state:Ih.FORWARD_STREAM_STATE_FAILURE,error:Eh.FORWARD_STREAM_ERROR_REMOTE_KICKED})}destoy(){super.removeAllListeners(),this._forwardDstRooms.clear(),this.forwardStreamState="stopped"}_mockForwardStreamResult(e){const t=[];return this._forwardDstRooms.forEach(((e,i)=>{t.push({dstRoomId:i,forwardStreamType:"stop",code:200})})),e.forEach((e=>{const i=t.findIndex((t=>t.dstRoomId===e.roomId));-1===i?t.push({dstRoomId:e.roomId,forwardStreamType:"start",code:e.roomId===this._roomConf.roomId?400:200}):t[i].forwardStreamType="update"})),t}_transformForwardStreamResult(e){e||(e=[]);const t=[];for(const{dstRoomId:i,code:o}of e){const e={roomId:i,state:Ih.FORWARD_STREAM_STATE_SUCCESS,error:Eh.FORWARD_STREAM_ERROR_OK};200===o||(400===o?(e.state=Ih.FORWARD_STREAM_STATE_FAILURE,e.error=Eh.FORWARD_STREAM_ERROR_REMOTE_KICKED):o>=700&&o<800?(e.state=Ih.FORWARD_STREAM_STATE_FAILURE,e.error=Eh.FORWARD_STREAM_ERROR_INVALID_TOKEN):(e.state=Ih.FORWARD_STREAM_STATE_FAILURE,e.error=Eh.FORWARD_STREAM_ERROR_RESPONSE)),t.push(e)}return t}_updateDstRooms(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];0===t.length&&this._forwardDstRooms.clear(),t.forEach((t=>{let{dstRoomId:i,code:o,forwardStreamType:r}=t;if(200===o)if("stop"===r)this._forwardDstRooms.delete(i);else{var s;const t=e.find((e=>e.roomId===i));if(!t&&!this._forwardDstRooms.has(i))throw new Cg(Eg.UNEXPECTED_ERROR,"unknow roomid ".concat(i," in signaling return"));let o=null!==(s=this._forwardDstRooms.get(i))&&void 0!==s?s:{token:void 0};o=Object.assign(o,t),this._forwardDstRooms.set(i,o)}else this._forwardDstRooms.has(i)&&this._forwardDstRooms.delete(i)}))}_getDstRooms(){const e=[];return this._forwardDstRooms.forEach(((t,i)=>{e.push({roomId:i,token:t.token})})),e}async _sendForwardStreamSignaling(e,t,i){const o="".concat(eb());if("stop"!==e){const e=i.map((e=>e.roomId));this._roomConf.report("rtc_forward_stream",{type:"begin",dst_rooms:"{ ".concat(e.map((e=>'"'.concat(e,'"'))).join(",")," }"),event_session_id:o})}const r={forwardStreamType:e,roomId:t};("start"===e||"update"===e)&&(r.dstRoomInfos=null==i?void 0:i.map((e=>({dstRoomId:e.roomId,dstToken:Qy.token2auth(this._ctx.appId,e.roomId,this._roomConf.userId,e.token)}))));const s=await this._ctx.signalingManager.sendSignaling("forwardStream",r),n=[];if(200!==(null==s?void 0:s.code))throw"stop"!==e&&(null==i||i.forEach((e=>{n.push({dst_room_id:e.roomId,result:"server error ".concat(null==s?void 0:s.code)})})),this._roomConf.report("rtc_forward_stream",{type:"end",dst_rooms:JSON.stringify(n),event_session_id:o})),new Cg(Eg.UNEXPECTED_ERROR,"server side internal error, error code: ".concat(s));var a,d;"stop"!==e&&(null===(a=s.forwardStreamResults)||void 0===a||a.forEach((e=>{n.push({dst_room_id:e.dstRoomId,result:"dst room lost"})})),null===(d=s.forwardStreamResults)||void 0===d||d.forEach((e=>{const t=n.find((t=>t.dst_room_id===e.dstRoomId));t&&(200===e.code?"update"===e.forwardStreamType?t.result="update":t.result="success":t.result="server error ".concat(e.code))})),this._roomConf.report("rtc_forward_stream",{type:"end",dst_rooms:JSON.stringify(n),event_session_id:o}));return s.forwardStreamResults}}pw([uw],vw.prototype,"startForwardStream2Rooms",1),pw([uw],vw.prototype,"updateForwardStream2Rooms",1),pw([uw],vw.prototype,"stopForwardStream2Rooms",1),pw([uw],vw.prototype,"pauseForwardStream2AllRooms",1),pw([uw],vw.prototype,"resumeForwardStream2AllRooms",1);const fw=[{maxLayers:3,totalPixels:2073600},{maxLayers:3,totalPixels:921600},{maxLayers:3,totalPixels:518400},{maxLayers:2,totalPixels:230400},{maxLayers:2,totalPixels:129600},{maxLayers:1,totalPixels:57600},{maxLayers:1,totalPixels:0}];function Sw(e,t,i){var o;const r=e?null===(o=i.find((t=>t.rid===e)))||void 0===o?void 0:o.maxkbps:i[0].maxkbps;return Math.min(null!=r?r:Number.POSITIVE_INFINITY,t)}const gw=(e,t)=>{var i,o,r,s;let n=0,a=-1;const{videoDescriptions:d,subVideoDescriptions:c}=(null==t?void 0:t.attributes)||{},l=Array.isArray(c)?c:d;let u=-1;const h=e.width*e.height;for(let v=0;v<(null==l?void 0:l.length);v++){var _,m;if(h>=(null===(_=l[v])||void 0===_?void 0:_.width)*(null===(m=l[v])||void 0===m?void 0:m.height)){u=v;break}}let p=l[0];if(-1===u)u=l.length-1,p=l[u];else if(0!==u){const e=l[u-1].width*l[u-1].height,t=(e-h)/(e-l[u].width*l[u].height);p=t<.1?l[u-1]:l[u],u=t<.1?u-1:u}return a=null!==(i=null===(o=p)||void 0===o?void 0:o.sub_index)&&void 0!==i?i:-1,n=null!==(r=null===(s=p)||void 0===s?void 0:s.video_index)&&void 0!==r?r:u,{spatialLayer:n,spatialSubLayer:a}},yw=e=>({width:lb(e.width),height:lb(e.height),frameRate:lb(e.frameRate),maxKbps:e.maxKbps}),bw=e=>{let{width:t,height:i}=e;return lb(t)*lb(i)},Tw=(e,t)=>{const i=lb(e.width)/lb(t.width)||1,o=lb(e.height)/lb(t.height)||1;Math.floor(i)===i&&Math.floor(o)===o||cb("setLocalSimulcastMode: The resolution setting needs to be an integer multiple")};class Iw{constructor(e){Xu(this,"_roomId",void 0),Xu(this,"_constraints",{}),Xu(this,"_profile",void 0),Xu(this,"_customMaxBitrate",0),this._appId=e}setRoomId(e){this._roomId=e}setAudioProfile(e){this._profile=e,this._customMaxBitrate=0}get customMaxBitrate(){return this._customMaxBitrate}setCustomMaxBitrate(e){const{audio_encode:t}=bg.getEngineWebConfig(this._appId,this._roomId||"");this._customMaxBitrate=null!=t&&t.bitrate?0:1e3*e}getOpusConfigStr(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";const{audio_encode:t}=bg.getEngineWebConfig(this._appId,this._roomId||""),{sampleRate:i,channelCount:o}=this.getConstraints(),r="number"==typeof i?i:null==i?void 0:i.exact,s="number"==typeof o?o:null==o?void 0:o.exact,n={};e.split(";").forEach((e=>{const[t,i]=e.split("=");t&&i&&(n[t]=i)}));const a=(null==t?void 0:t.bitrate)||this._customMaxBitrate||this._getConfigByAudioProfile().bitrate;a&&(n.maxaveragebitrate=a);const d=(null==t?void 0:t.enc_sample_rate)||r;d&&(n["sprop-maxcapturerate"]=d);const c=(null==t?void 0:t.playback_rate)||r;return c&&(n.maxplaybackrate=c),(s&&s>1||null!=t&&t.stereo)&&(n["sprop-stereo"]=1,n.stereo=1),null!=t&&t.dtx&&(n.usedtx=1),Object.keys(n).map((e=>"".concat(e,"=").concat(n[e]))).join(";")}updateConstraints(e){this._constraints=Fu(Fu({},this._constraints),e)}getConstraints(){const e=Fu({},this._constraints),{audio_capture:t}=bg.getEngineWebConfig(this._appId,this._roomId||"");ab(null==t?void 0:t.sample_rate)||(e.sampleRate=t.sample_rate),ab(null==t?void 0:t.channel)||(e.channelCount=t.channel),ab(null==t?void 0:t.agc)||(e.autoGainControl=t.agc),ab(null==t?void 0:t.ans)||(e.noiseSuppression=t.ans),ab(null==t?void 0:t.aec)||(e.echoCancellation=t.aec);const{sampleRate:i,channel:o}=this._getConfigByAudioProfile();return ab(e.sampleRate)&&!ab(i)&&(e.sampleRate=i),ab(e.channelCount)&&!ab(o)&&(e.channelCount=o),e}_getConfigByAudioProfile(){const e={};switch(this._profile){case fh.fluent:e.sampleRate=16e3,e.bitrate=24e3;break;case fh.standard:e.sampleRate=48e3,e.bitrate=48e3;break;case fh.hd:e.sampleRate=48e3,e.bitrate=128e3,e.channel=2;break;case fh.standardStereo:e.sampleRate=48e3,e.bitrate=8e4,e.channel=2;break;case fh.hdMono:e.sampleRate=48e3,e.bitrate=128e3}return e}}const Ew={start_interval:100,multiplier:2,max_interval:3e4};class Rw{constructor(){Xu(this,"_times",0),Xu(this,"_config",Ew),Xu(this,"initTs",jy())}getRetryDelay(){return Math.min(this._config.max_interval,Math.pow(this._config.multiplier,this._times++)*this._config.start_interval)}setConfig(e){this._config=e}reset(){this._times=0}}class Cw{constructor(e){Xu(this,"_logger",void 0),Xu(this,"_monitor",void 0),this._ctx=e;const t=bg.getServerConfig(this._ctx.appId);this._logger=new LS("DecisionConfig",1,this._ctx.id),this._monitor=uS(this._ctx.id),setTimeout((()=>{this.updateConfig(t,!0)}),0)}updateConfig(e,t){!t&&bg.setServerConfig(this._ctx.appId,e),e.rts_report&&Gf(e.rts_report),this._ctx.joinRoomConfig.setServerConfig(e.web_join_room),this._setRtsConfig(e.rts_config),this._setRtsQpsConfig(e.rts_qps),this._preConnect(e),this._getServerConfigExecutor(e,t)}_setRtsConfig(e){null!=e&&e.rts_mode&&e.rts_mode!==this._ctx.rtsMode&&(this._logger.print("_setRtsConfig","setRtsMode to %o",e.rts_mode),this._ctx.setRTSMode(e.rts_mode===DI.NORMAL_MODE?DI.NORMAL_MODE:DI.LIMIT_MODE))}_setRtsQpsConfig(e){this._logger.print("_setRtsQpsConfig",JSON.stringify(e)),this._ctx.setRtsQpsConf(e),Object.keys(this._ctx.rtsLimiter).length>0&&fS(this._ctx.id,"setRtsQpsConf",JSON.stringify(e))}_getServerConfigExecutor(e,t){var i,o,r,s,n,a,d,c,l,u,h;const{upload_console_length_cut:_,upload_report_limit:m}=(null==e?void 0:e.web_rtc_config)||{};if(fm.setParameter("UPLOAD_CONSOLE_ON",!(null==e||null===(i=e.web_rtc_config)||void 0===i||!i.upload_console_on)),_&&fm.setParameter("UPLOAD_CONSOLE_LENGTH_CUT",_),m&&fm.setParameter("UPLOAD_REPORT_LIMIT",m),fm.setParameter("ENABLE_REPORT_IDB_BUFFER",!(null==e||null===(o=e.web_rtc_config)||void 0===o||!o.enable_report_idb_buffer)),!1===(null==e||null===(r=e.web_rtc_config)||void 0===r?void 0:r.sdk_codec_negotiation)&&zg("SDK_CODEC_NEGOTIATION",!1),void 0!==(null==e||null===(s=e.web_rtc_config)||void 0===s?void 0:s.ainr_enable_dump)&&zg("AINR_ENABLE_DUMP",e.web_rtc_config.ainr_enable_dump),void 0!==(null==e||null===(n=e.web_rtc_config)||void 0===n?void 0:n.ainr_overload_threshold)&&zg("AINR_OVERLOAD_THRESHOLD",e.web_rtc_config.ainr_overload_threshold),void 0!==(null==e||null===(a=e.web_rtc_config)||void 0===a?void 0:a.ainr_urls))try{zg("AINR_URLS",JSON.parse(e.web_rtc_config.ainr_urls))}catch(f){this._logger.warn("_getServerConfigExecutor","parse AINR_URLS error %o",f)}var p,v;(void 0!==(null==e||null===(d=e.web_rtc_config)||void 0===d?void 0:d.ainr_cache_time)&&zg("AINR_CACHE_TIME",e.web_rtc_config.ainr_cache_time),void 0!==(null==e||null===(c=e.web_rtc_config)||void 0===c?void 0:c.ainr_dump_time)&&zg("AINR_DUMP_TIME",e.web_rtc_config.ainr_dump_time),null!=e&&null!==(l=e.web_rtc_config)&&void 0!==l&&l.web_pc_killswitch&&(this._logger.print("web_pc_killswitch update: ",JSON.stringify(e.web_rtc_config.web_pc_killswitch)),this._ctx.pcKillSwitch=Fu(Fu({},this._ctx.pcKillSwitch),e.web_rtc_config.web_pc_killswitch)),"boolean"==typeof(null==e||null===(u=e.web_rtc_config)||void 0===u?void 0:u.fallback))&&(!1===(null==e?void 0:e.web_rtc_config.fallback)?this._ctx.enableFallbackHandler=!1:Array.isArray(null==e||null===(p=e.web_rtc_config)||void 0===p?void 0:p.fallback_ua_reg)?this._ctx.enableFallbackHandler=null==e?void 0:e.web_rtc_config.fallback_ua_reg.every((e=>"string"==typeof e&&new RegExp(e).test(navigator.userAgent))):this._ctx.enableFallbackHandler=!1);"boolean"==typeof(null==e||null===(h=e.web_rtc_config)||void 0===h?void 0:h.standard)&&(!1===(null==e?void 0:e.web_rtc_config.standard)?this._ctx.enableStandardHandler=!1:Array.isArray(null==e||null===(v=e.web_rtc_config)||void 0===v?void 0:v.standard_ua_reg)?this._ctx.enableStandardHandler=null==e?void 0:e.web_rtc_config.standard_ua_reg.every((e=>"string"==typeof e&&new RegExp(e).test(navigator.userAgent))):this._ctx.enableStandardHandler=!1)}_preConnect(e){var t;let i=Qg("PRE_ICE");var o;("boolean"==typeof(null==e||null===(t=e.web_rtc_config)||void 0===t?void 0:t.pre_ice)&&(i=e.web_rtc_config.pre_ice),i)&&(this._logger.print("preConnect","start pre ice connection."),this._ctx.signalingManager.connect(),null===(o=this._monitor)||void 0===o||o.set({pre_connection:!0}),this._ctx.isPreConnection=!0)}}class kw{constructor(e){Xu(this,"_reconnectTimer",void 0),Xu(this,"_retryFunc",void 0),Xu(this,"_abortControllers",[]),Xu(this,"_monitor",void 0),Xu(this,"logger",void 0),Xu(this,"_groupConfigId",Jy()),Xu(this,"_retryLimiter",new Rw),Xu(this,"_timer",void 0),Xu(this,"_destroyed",!1),Xu(this,"_onlineListener",(()=>{this._reconnectTimer&&this._retryFunc&&(clearTimeout(this._reconnectTimer),this._retryFunc())})),Xu(this,"_decisionConfig",void 0),this._ctx=e,this._monitor=uS(e.id),this.logger=new LS("ICERequest",4,e.id),this._decisionConfig=new Cw(e),window.addEventListener("online",this._onlineListener)}async getICENode(e){let t;this.logger.info("getICENode","invoke");try{if(t=await this._getAccessWithRetry(e),0===t.length)throw new Error("server return empty nodes.")}catch(i){throw this._reportRtcInvokeStatus("es.join.getNodeFailed",i),new Cg(Eg.ICE_SERVER_WRONG,"get ICE config failed: ".concat(i.message),i)}return this.logger.success("getICENode","success"),this._reportRtcInvokeStatus("es.join.getNodeSuccess",t),t}_getAccessWithRetry(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return 0!==t&&this.logger.info("_getAccessWithRetry()","invoke feedbackInfo: %o, 201count: %o",e,t),new Promise(((i,o)=>{this._getAccessNode(e).then((e=>{this._retryLimiter.reset(),i(e)})).catch((r=>{if(this._destroyed)return;if(Array.isArray(r)&&r.length>0){if(r.findIndex((e=>400<=e.code&&e.code<500))>-1)return this._retryLimiter.reset(),o(new Error("HTTP request failed(4xx)"));if(r.every((e=>{var t;return 201===e.code||201===(null===(t=e.error)||void 0===t?void 0:t.code)}))&&t++,3===t)return this._retryLimiter.reset(),o(new Error("HTTP request failed(201)"))}const s=this._retryLimiter.getRetryDelay();this.logger.warn("_getAccessWithRetry()","_getAccessWithRetry error, will retry after ".concat(s,"ms"),r),this._retryFunc=()=>{this._getAccessWithRetry(e,t).then(i).catch(o)},this._reconnectTimer=self.setTimeout(this._retryFunc,s)}))}))}async _getAccessNode(e){return new Promise(((t,i)=>{const o=bg.getAccessNode(this._ctx.appId);if(o){const i=(Array.isArray(o)?o:[o]).map((e=>(e.cache_status=!0,e)));this.logger.info("getAccessNode","use cache node."),t(i),this._timer=setTimeout((()=>{this._getAccessNodeFromServer(e),this._reportRtcInvokeStatus("es.R.node.cache",o),delete this._timer}),0)}else this._getAccessNodeFromServer(e).then(t).catch(i)}))}async _getAccessNodeFromServer(e){const{urls:t,needFallback:i}=this._getAccessUrls();return this.getICEConfigFromServer(t,e).then((e=>{const{nodes:t,decisionConfig:i}=e;return!this._ctx.useCloudProxy&&(null==t?void 0:t.length)>0&&bg.setAccessNode(this._ctx.appId,t,e.ttl||11200),i&&this._decisionConfig.updateConfig(i,!1),e.dispatchDomains&&!this._ctx.useCloudProxy&&bg.setAccessUrls(e.dispatchDomains),t})).catch((t=>{if(i)return this._reportRtcInvokeStatus("es.R.req.fallback",""),bg.clearAccessUrls(),this._getAccessNodeFromServer(e);throw t}))}_getAccessUrls(){let e=bg.getAccessUrls()||[],t=!0;return 0!==e.length?this._reportRtcInvokeStatus("es.R.req.cache.urls",e):(t=!1,e=jg.ICE_CONFIG_REQUEST_URLS,0!==e.length?this._reportRtcInvokeStatus("es.R.req.external.urls",e):(e=jg.ICE_CONFIG_REQUEST_URLS_INTERNAL,this._reportRtcInvokeStatus("es.R.req.internal.urls",e))),{urls:e,needFallback:t}}async getICEConfigFromServer(e,t){var i;const o={appID:this._ctx.appId,deviceID:bg.getDeviceId(),os:"web",sdkVersion:jg.VERSION,isOversea:jg.OVERSEA,expectedAddr:Qg("EXPECTED_ADDR"),productPlatform:"VolcEngine",enableCloudProxy:this._ctx.useCloudProxy,expectedIDC:this._ctx.expectedIDC,decisionKeys:["rts_report","web_join_room","web_rtc_config","rts_qps","rts_config"],accessParams:JSON.stringify({requireICEUfragV2:!0}),userAgent:null===(i=navigator)||void 0===i?void 0:i.userAgent};var r;t&&(o.feedbackInfo=t,"ICE_FAILED"!==(null===(r=t[0])||void 0===r||null===(r=r.feedbackReason)||void 0===r?void 0:r.type)&&delete o.expectedAddr);"AREA_CODE_US_OPCO"===Qg("AREA_CODE")&&(o.mediaArea=JSON.stringify([{AreaList:["GEO:US_OPCO"],Attribute:"include"}]),o.accessArea=JSON.stringify([{AreaList:["GEO:US_OPCO"],Attribute:"include"}]));return(e=>new Promise(((t,i)=>{let o=(e=Array.isArray(e)?e:[]).length;const r=[];0===o?i([]):e.forEach((e=>{e.then((e=>{t(e)}),(e=>{o--,r.push(e),0===o&&i(r)}))}))})))(e.map((e=>this._httpRequest(e,o))))}async _httpRequest(e,t){var i;const o=Jy();t.connectSessionID=o;const r=Date.now();null===(i=this._monitor)||void 0===i||i.report("rtc_get_access",{error_code:0,message:JSON.stringify(t),elapse:0,type:"request",host:e,config_id:o,group_config_id:this._groupConfigId});const s=new AbortController;let n;this._abortControllers.push(s);try{var a;try{n=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},mode:"cors",body:JSON.stringify(t),signal:s.signal})}catch(u){var d;if(l=fetch,!Function.prototype.toString.call(l).includes("[native code]"))null===(d=this._monitor)||void 0===d||d.report("rtc_error",{error_code:JP.Fetch_MODIFY,message:"get access failed, possibly due to modifying the browser's Fetch API."},{origin_error:u});throw u}if(this._abortControllers=this._abortControllers.filter((e=>e!==s)),200!==n.status)throw{message:n.statusText,code:n.status};const i=await n.json();if(200!==i.code)throw i;return null===(a=this._monitor)||void 0===a||a.report("rtc_get_access",{error_code:200,message:JSON.stringify(i),elapse:Date.now()-r,type:"response",host:e,config_id:o,group_config_id:this._groupConfigId}),i}catch(h){var c;throw null===(c=this._monitor)||void 0===c||c.report("rtc_get_access",{error_code:Number((null==h?void 0:h.code)||(null==h?void 0:h.server_code)),message:null==h?void 0:h.message,elapse:Date.now()-r,type:"response",host:e,config_id:o,group_config_id:this._groupConfigId},{error:JSON.stringify(h)}),h}var l}destroy(){this._destroyed=!0,window.removeEventListener("online",this._onlineListener),this._abortControllers.forEach((e=>e.abort("engine destroy"))),this._reconnectTimer&&(window.clearTimeout(this._reconnectTimer),delete this._reconnectTimer),this._timer&&(window.clearTimeout(this._timer),delete this._timer)}_reportRtcInvokeStatus(e,t){var i;null===(i=this._monitor)||void 0===i||i.report("rtc_invoke_status",{sdk_api_name:e,message:t,error_code:0,stream_id:"",elapse:0,group_config_id:this._groupConfigId})}}var Aw={},Pw={},Nw={exports:{}},ww=Nw.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(e){return e.encoding?"rtpmap:%d %s/%s/%s":e.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(e){return null!=e.address?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%s trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(e){return null!=e.subtype?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(e){return"extmap:%d"+(e.direction?"/%s":"%v")+(e["encrypt-uri"]?" %s":"%v")+" %s"+(e.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(e){return null!=e.sessionConfig?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(e){var t="candidate:%s %d %s %d %s %d typ %s";return t+=null!=e.raddr?" raddr %s rport %d":"%v%v",t+=null!=e.tcptype?" tcptype %s":"%v",null!=e.generation&&(t+=" generation %d"),t+=null!=e["network-id"]?" network-id %d":"%v",t+=null!=e["network-cost"]?" network-cost %d":"%v"}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(e){var t="ssrc:%d";return null!=e.attribute&&(t+=" %s",null!=e.value&&(t+=":%s")),t}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(e){return null!=e.maxMessageSize?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(e){return e.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(e){return"imageattr:%s %s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(e){return"simulcast:%s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(e){return"ts-refclk:%s"+(null!=e.clksrcExt?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(e){var t="mediaclk:";return t+=null!=e.id?"id=%s %s":"%v%s",t+=null!=e.mediaClockValue?"=%s":"",t+=null!=e.rateNumerator?" rate=%s":"",t+=null!=e.rateDenominator?"/%s":""}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{push:"invalid",names:["value"]}]};Object.keys(ww).forEach((function(e){ww[e].forEach((function(e){e.reg||(e.reg=/(.*)/),e.format||(e.format="%s")}))}));var Ow=Nw.exports;!function(e){var t=function(e){return String(Number(e))===e?Number(e):e},i=function(e,i,o){var r=e.name&&e.names;e.push&&!i[e.push]?i[e.push]=[]:r&&!i[e.name]&&(i[e.name]={});var s=e.push?{}:r?i[e.name]:i;!function(e,i,o,r){if(r&&!o)i[r]=t(e[1]);else for(var s=0;s<o.length;s+=1)null!=e[s+1]&&(i[o[s]]=t(e[s+1]))}(o.match(e.reg),s,e.names,e.name),e.push&&i[e.push].push(s)},o=Ow,r=RegExp.prototype.test.bind(/^([a-z])=(.*)/);e.parse=function(e){var t={},s=[],n=t;return e.split(/(\r\n|\r|\n)/).filter(r).forEach((function(e){var t=e[0],r=e.slice(2);"m"===t&&(s.push({rtp:[],fmtp:[]}),n=s[s.length-1]);for(var a=0;a<(o[t]||[]).length;a+=1){var d=o[t][a];if(d.reg.test(r))return i(d,n,r)}})),t.media=s,t};var s=function(e,i){var o=i.split(/=(.+)/,2);return 2===o.length?e[o[0]]=t(o[1]):1===o.length&&i.length>1&&(e[o[0]]=void 0),e};e.parseParams=function(e){return e.split(/;\s?/).reduce(s,{})},e.parseFmtpConfig=e.parseParams,e.parsePayloads=function(e){return e.toString().split(" ").map(Number)},e.parseRemoteCandidates=function(e){for(var i=[],o=e.split(" ").map(t),r=0;r<o.length;r+=3)i.push({component:o[r],ip:o[r+1],port:o[r+2]});return i},e.parseImageAttributes=function(e){return e.split(" ").map((function(e){return e.substring(1,e.length-1).split(",").reduce(s,{})}))},e.parseSimulcastStreamList=function(e){return e.split(";").map((function(e){return e.split(",").map((function(e){var i,o=!1;return"~"!==e[0]?i=t(e):(i=t(e.substring(1,e.length)),o=!0),{scid:i,paused:o}}))}))}}(Pw);var Mw=Ow,Lw=/%[sdv%]/g,xw=function(e){var t=1,i=arguments,o=i.length;return e.replace(Lw,(function(e){if(t>=o)return e;var r=i[t];switch(t+=1,e){case"%%":return"%";case"%s":return String(r);case"%d":return Number(r);case"%v":return""}}))},Vw=function(e,t,i){var o=[e+"="+(t.format instanceof Function?t.format(t.push?i:i[t.name]):t.format)];if(t.names)for(var r=0;r<t.names.length;r+=1){var s=t.names[r];t.name?o.push(i[t.name][s]):o.push(i[t.names[r]])}else o.push(i[t.name]);return xw.apply(null,o)},Dw=["v","o","s","i","u","e","p","c","b","t","r","z","a"],Uw=["i","c","b","a"],Zw=Pw,Ww=function(e,t){t=t||{},null==e.version&&(e.version=0),null==e.name&&(e.name=" "),e.media.forEach((function(e){null==e.payloads&&(e.payloads="")}));var i=t.outerOrder||Dw,o=t.innerOrder||Uw,r=[];return i.forEach((function(t){Mw[t].forEach((function(i){i.name in e&&null!=e[i.name]?r.push(Vw(t,i,e)):i.push in e&&null!=e[i.push]&&e[i.push].forEach((function(e){r.push(Vw(t,i,e))}))}))})),e.media.forEach((function(e){r.push(Vw("m",Mw.m[0],e)),o.forEach((function(t){Mw[t].forEach((function(i){i.name in e&&null!=e[i.name]?r.push(Vw(t,i,e)):i.push in e&&null!=e[i.push]&&e[i.push].forEach((function(e){r.push(Vw(t,i,e))}))}))}))})),r.join("\r\n")+"\r\n"},Xw=Ow;Aw.grammar=Xw,Aw.write=Ww,Aw.parse=Zw.parse,Aw.parseParams=Zw.parseParams,Aw.parseFmtpConfig=Zw.parseFmtpConfig,Aw.parsePayloads=Zw.parsePayloads,Aw.parseRemoteCandidates=Zw.parseRemoteCandidates,Aw.parseImageAttributes=Zw.parseImageAttributes,Aw.parseSimulcastStreamList=Zw.parseSimulcastStreamList;const Gw=new LS("FirefoxHandler",3),Fw=Math.pow(2,32),Hw="kp34Za0H+aVf862l";function Yw(e){return e>Fw-18?(Gw.warn("generateAllSsrc","reset start id",e),Yw(e=e-Fw+1e4+18)):{audio:e,audioFec:e+1,audioRtx:e+2,video:e+3,videoFec:e+4,videoRtx:e+5,next:e+18}}const Kw=function(e,t,i){return[{id:i,attribute:"cname",value:arguments.length>3&&void 0!==arguments[3]?arguments[3]:"o/i14u9pJrxRKAsu"},{id:i,attribute:"msid",value:"".concat(e," ").concat(e,"-").concat(t)},{id:i,attribute:"mslabel",value:"".concat(e)},{id:i,attribute:"label",value:"".concat(e,"-").concat(t)}]},Bw=function(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const o=t.video,r=t.videoRtx,s=t.videoFec,n=[o,r],{cname:a,flexfec:d}=i;d&&n.push(s);const c=n.reduce(((t,i)=>t.concat(Kw(e,"video",i,a))),[]),l=[{semantics:"FID",ssrcs:"".concat(o," ").concat(r)}];return d&&l.push({semantics:"FEC-FR",ssrcs:"".concat(o," ").concat(s)}),{ssrcs:c,ssrcGroups:l}};function Jw(e){return e.direction="inactive",e.port=0,delete e.ext,delete e.ssrcs,delete e.ssrcGroups,delete e.simulcast,delete e.simulcast_03,delete e.rids,delete e.extmapAllowMixed,delete e.msid,delete e.bundleOnly,e}const jw=function(e,t,i){let o=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];const r=Fu(Fu({},e),{},{media:[]});return o&&(r.invalid=[{value:"realx-exts:rscp"}]),t&&r.media.push(JN(t)),i&&r.media.push(JN(i)),delete r.groups,delete r.msidSemantic,nO(r)};function zw(e){const t={},{publicIPs:i,certFingerprint:o,iceParams:r,iceConfig:s}=e;return t.fingerprint={type:"sha-256",hash:o},t.icePwd=r.serverIcePwd,t.iceUfrag=Qw(r.serverIceUfrag),t.candidates=function(e,t){if(!Array.isArray(e))return[];let i=0;const o=2130706431,r=[];return e.forEach((e=>{const s={component:1,ip:e.ip,type:"host",generation:e.generation};e.udpPorts&&!t.tcpOnly&&e.udpPorts.forEach((e=>{r.push(Fu(Fu({},s),{},{foundation:i++,transport:"udp",port:e,priority:o}))})),e.tcpPorts&&e.tcpPorts.forEach((e=>{r.push(Fu(Fu({},s),{},{foundation:i++,transport:"tcp",port:e,tcptype:"passive",priority:o-1e3}))}))})),r}(i,s),t.setup="active",t.iceOptions="renomination",t}const Qw=e=>{const t=(new TextEncoder).encode("PREC"),i=_b(e),o=new Uint8Array(4);crypto.getRandomValues(o);const r=new Uint8Array(2);r[0]=0,r[1]=1;return mb(zy(Uint8Array,t,i,o,r))};var qw=(e=>(e[e.kICEConfigTypeSrtpDtlsType=0]="kICEConfigTypeSrtpDtlsType",e[e.kICEConfigTypeRenominationType=1]="kICEConfigTypeRenominationType",e[e.kICEConfigTypeTcpType=2]="kICEConfigTypeTcpType",e[e.kICEConfigTypeMultiSendType=3]="kICEConfigTypeMultiSendType",e[e.kICEConfigTypeKcpType=4]="kICEConfigTypeKcpType",e[e.kICEConfigTypeSrtpSdesType=5]="kICEConfigTypeSrtpSdesType",e))(qw||{});function $w(e){let{random:t,serverUfrag:i,serverPwd:o,clientPwd:r,options:s}=e,n=0;const a=(new TextEncoder).encode("WPRE");n+=4,t||(t=new Uint8Array(4),crypto.getRandomValues(t)),n+=4;const d=_b(i);n+=1,n+=d.byteLength;const c=pb(_b(r),_b(o).subarray(0,16),_b(i).subarray(0,16));n+=1,n+=c.byteLength;const l=new Uint8Array(Object.keys(s).reduce(((e,t)=>{const i=Number(t);return e.push(i),e.push(s[i]?1:0),e}),[]));n+=l.byteLength;let u=zy(Uint8Array,a,t,[d.byteLength],d,[c.byteLength],c,l);u.byteLength%3!=0&&(u=zy(Uint8Array,u,new Uint8Array(3-u.byteLength%3).fill(255)));return[mb(u),mb(zy(Uint8Array,t,d.subarray(0,20)))]}const eO=(e,t)=>{if(!Array.isArray(e.fmtp)||!Array.isArray(e.rtp))return;for(let o=0;o<e.rtp.length;o++){if(e.rtp[o].codec.toUpperCase()===t.toUpperCase()){e.rtp.unshift(e.rtp.splice(o,1)[0]);break}}const i=[];e.rtp.forEach((e=>i.push(e.payload))),e.payloads=i.join(" ")},tO=(e,t)=>{let i=0;if(!Array.isArray(e.fmtp)||!Array.isArray(e.rtp))return;for(const r of e.fmtp)if(r.config.includes("level-asymmetry-allowed=1")&&r.config.includes("packetization-mode=1")&&r.config.includes("profile-level-id=42e0")){i=r.payload;break}for(let r=0;r<e.rtp.length;r++){const o=e.rtp[r];if("H264"===t){if(o.payload===i){e.rtp.unshift(e.rtp.splice(r,1)[0]);break}}else if(o.codec===t){e.rtp.unshift(e.rtp.splice(r,1)[0]);break}}const o=[];e.rtp.forEach((e=>o.push(e.payload))),e.payloads=o.join(" ")},iO=e=>{e.media.forEach((e=>{"audio"!==e.type&&"video"!==e.type||e.rtp.forEach((t=>{e.rtcpFb||(e.rtcpFb=[]),e.rtcpFb.find((e=>e.payload===t.payload&&"rrtr"===e.type))||e.rtcpFb.push({payload:t.payload,type:"rrtr"})}))}))},oO=function(e,t,i){let o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{rrtr:!1};const r={},s={};let n=-1;const a=[];return Array.isArray(e.fmtp)&&e.fmtp.forEach((e=>{let{payload:t,config:i}=e;if(i.startsWith("apt=")){const e=i.slice(4);r[t]=e}else i.includes("42e0")&&i.includes("packetization-mode=1")&&(n=t)})),Array.isArray(e.rtp)&&(e.rtp=e.rtp.filter((e=>{const i=e.codec,o=e.payload;let d;switch(i){case"H264":return d=!1,t.map((e=>{"H264"===e&&o===n&&(s[o]=o,a.push(o),d=!0)})),d;case"rtx":return!!s[r[o]]&&(s[o]=o,!0);case"red":case"ulpfec":case"flexfec-03":return s[o]=o,!0;default:return d=!1,t.map((e=>{e===i&&(s[o]=o,a.push(o),d=!0)})),d}}))),Array.isArray(e.fmtp)&&(e.fmtp=e.fmtp.filter((e=>s[e.payload]))),Array.isArray(e.rtcpFb)?e.rtcpFb=e.rtcpFb.filter((e=>s[e.payload])):e.rtcpFb=[],o.rrtr&&a.forEach((t=>{var i;null===(i=e.rtcpFb)||void 0===i||i.push({payload:t,type:"rrtr"})})),sO(e,i),Array.isArray(e.ext)&&(e.ext=e.ext.filter((e=>{if("http://www.webrtc.org/experiments/rtp-hdrext/video-content-type"!==e.uri&&"http://www.webrtc.org/experiments/rtp-hdrext/video-timing"!==e.uri&&"http://www.webrtc.org/experiments/rtp-hdrext/color-space"!==e.uri)return e}))),"string"==typeof e.payloads&&(e.payloads=e.payloads.split(" ").filter((e=>s[e])).join(" ")),e},rO=function(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{rrtr:!1};const o={};if(Array.isArray(e.rtp)&&(e.rtp=e.rtp.filter((e=>{const t=e.codec,i=e.payload;return("opus"===t||"red"===t)&&(o[i]=i,!0)}))),Array.isArray(e.rtcpFb)||(e.rtcpFb=[]),i.rrtr&&Object.keys(o).forEach((t=>{var i;null===(i=e.rtcpFb)||void 0===i||i.push({payload:Number(t),type:"rrtr"})})),sO(e,t),"string"==typeof e.payloads){const t=[];e.payloads.split(" ").forEach((e=>{o[e]&&t.push(e)})),e.payloads=t.join(" ")}return e},sO=(e,t)=>{e.iceOptions&&delete e.iceOptions,e.icePwd&&(t.icePwd=e.icePwd,delete e.icePwd),e.iceUfrag&&(t.iceUfrag=e.iceUfrag,delete e.iceUfrag),e.fingerprint&&(t.fingerprint=e.fingerprint,delete e.fingerprint)},nO=e=>aO(e,"H265","ByteVC1"),aO=(e,t,i)=>{const o="string"==typeof e?Aw.parse(e):e;return o.media=o.media.map((e=>("video"===e.type&&(e.rtp=e.rtp.map((e=>(e.codec===t&&(e.codec=i),e)))),e))),Aw.write(o)};function dO(e,t){const i=(new Error).stack;dS("[DCHECK FAILED] ".concat(t),-1,{stack:i})}const cO=sE(),lO={iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require"};var uO=(e=>(e[e.DC_ERROR=0]="DC_ERROR",e[e.DC_CLOSE=1]="DC_CLOSE",e[e.ICE_FAILED=2]="ICE_FAILED",e[e.DESTROY=3]="DESTROY",e[e.TIMEOUT=4]="TIMEOUT",e))(uO||{});let hO=0;class _O extends kI{constructor(e,t){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];super(),Xu(this,"uuid",(hO++).toString()),Xu(this,"_peerConnectionId",""),Xu(this,"audioTrack4ff",void 0),Xu(this,"_pc",void 0),Xu(this,"_dc",void 0),Xu(this,"_iceNode",void 0),Xu(this,"_initSctpEvents",!1),Xu(this,"_monitor",void 0),Xu(this,"_offerIce",{}),Xu(this,"_answerIce",{}),Xu(this,"_offerSession",void 0),Xu(this,"_answerSession",void 0),Xu(this,"_offerMlines",[]),Xu(this,"_answerMlines",[]),Xu(this,"_connectReject",void 0),Xu(this,"_logger",void 0),Xu(this,"_destroyed",!1),Xu(this,"_reportTimer",void 0),Xu(this,"_onLineCheckerTimer",void 0),Xu(this,"_clearPeerListeners",void 0),Xu(this,"_peerConfig",void 0),Xu(this,"_iceStartTs",0),Xu(this,"_icePreStepTs",0),this._ctx=e,this._groupConnectionId=t,this._isReconnect=i,this._monitor=uS(e.id),this._logger=new LS("PeerConnection_".concat(this.uuid),4,e.id),this._ctx.enableFallbackHandler&&this._logger.warn("ctor","PeerConnection running in fallback mode"),this._peerConfig=mO(e),this._pc=new RTCPeerConnection(this._peerConfig),this._pc.ontrack=e=>{var t;const i=null===(t=e.streams)||void 0===t||null===(t=t[0])||void 0===t?void 0:t.id;this._print("pc.ontrack","".concat(e.track.kind," ").concat(e.track.id," ").concat(i)),"ff-stream"===i&&(this.audioTrack4ff=e.track),this.emit("ontrack",e)},this._pc.onconnectionstatechange=()=>{this._print("onconnectionstatechange","".concat(this._pc.connectionState,". ice -> ").concat(this._pc.iceConnectionState)),"failed"!==this._pc.iceConnectionState&&"closed"!==this._pc.iceConnectionState&&"failed"!==this._pc.connectionState||this.emit("disconnect",pO.ICE_FAILED),"disconnected"===this._pc.connectionState&&(navigator.onLine?this.emit("disconnect",pO.ICE_FAILED):this._onLineCheckerTimer=setInterval((()=>{navigator.onLine&&(clearInterval(this._onLineCheckerTimer),this.emit("disconnect",pO.ICE_FAILED))}),1e3)),"connecting"!==this._pc.connectionState&&"connected"!==this._pc.connectionState||clearInterval(this._onLineCheckerTimer)},this._pc.oniceconnectionstatechange=()=>{const e=this._pc.iceConnectionState;this._report("rtc_pre_ice_state",{message:e,ice_state:e.toUpperCase()}),this.emit("ice_state",e)}}static checkSupported(){if(!RTCPeerConnection)throw new Cg(Eg.NOT_SUPPORTED,"missing RTCPeerConnection API.");["addTransceiver","createDataChannel","createOffer","setLocalDescription","setRemoteDescription"].forEach((e=>{var t;if(null===(t=RTCPeerConnection)||void 0===t||null===(t=t.prototype)||void 0===t||!t[e])throw new Cg(Eg.NOT_SUPPORTED,"missing peer.".concat(e," API."))}))}getOriginRTCPeerConnection(){return this._pc}getConnectionId(){return this._peerConnectionId}getGroupConnectionId(){return this._groupConnectionId}getIceConnectionState(){return this._pc.iceConnectionState}async createOfferSdp(){let{sdp:e}=await this._pc.createOffer();return e}async startIceConnect(e){if(this._ctx.enableStandardHandler)return this.startIceConnectStandard(e);this._print("connect","invoke. %o",e),this._iceNode=e;const t=this._pc.createDataChannel("signaling",{negotiated:!0,id:100});t.binaryType="arraybuffer",this._dc=t;const{offerIce:i,answerIce:o}=this._genIceInfo(e);this._offerIce=i,this._answerIce=o,US&&dg<138&&(this._pc.addTransceiver("audio",{direction:"recvonly"}),this._pc.addTransceiver("video",{direction:"recvonly"}));const r=await this.createOfferSdp();if(!r)throw new Cg(Eg.NOT_SUPPORTED,"create offer sdp failed.");const s=Aw.parse(r);this._peerConnectionId=o.iceUfrag||"";const n=!i.iceUfrag&&!i.icePwd;if(n){var a,d;const t="renomination"===(null===(a=s.media[0])||void 0===a?void 0:a.iceOptions);t||(delete i.iceOptions,delete o.iceOptions),delete i.iceUfrag,delete i.icePwd;const[r,n]=$w({serverUfrag:e.iceParams.serverIceUfrag,serverPwd:e.iceParams.serverIcePwd,clientPwd:null===(d=s.media[0])||void 0===d?void 0:d.icePwd,options:{[qw.kICEConfigTypeSrtpDtlsType]:!0,[qw.kICEConfigTypeRenominationType]:t}});this._peerConnectionId=n,o.iceUfrag=r,this._logger.info("use serverUfrag v2",JSON.stringify({dtls:!0,renomination:t}))}this.reportRtcPreIce("ice_start");const[c]=s.media;if(this._offerIce.fingerprint=s.fingerprint||c.fingerprint,US||this._ctx.enableFallbackHandler){s.media=s.media.map((e=>{const t=Fu(Fu({},e),this._offerIce);var i,o,r,s;"video"===t.type&&(dE?(t.ext=null===(i=t.ext)||void 0===i?void 0:i.filter((e=>-1===e.uri.indexOf("abs-send-time"))),t.rtcpFb=null===(o=t.rtcpFb)||void 0===o?void 0:o.filter((e=>"goog-remb"!==e.type))):(t.rtcpFb=null===(r=t.rtcpFb)||void 0===r?void 0:r.filter((e=>"transport-cc"!==e.type)),t.ext=null===(s=t.ext)||void 0===s?void 0:s.filter((e=>-1===e.uri.indexOf("transport")))));return t})),cE&&iO(s);const e=Fu({},s);e.fingerprint=this._answerIce.fingerprint,e.media=e.media.map((e=>(delete(e=Fu(Fu({},e),this._answerIce)).bundleOnly,e.port=9,"application"===e.type?e.sctpmap={sctpmapNumber:5e3,app:"webrtc-datachannel",maxMessageSize:262144}:("audio"===e.type&&(e.msid="ff-stream ff-stream-audio"),e.direction="sendonly"),e))),cE&&iO(e),this._ctx.enableFallbackHandler?await this.setLocalDescription(r):await this.setLocalDescription(Aw.write(s)),await this.setRemoteDescription(Aw.write(e))}else{delete s.media,this._offerSession=Fu({},s),this._answerSession=Fu({},s),this._answerSession.fingerprint&&(this._answerSession.fingerprint=this._answerIce.fingerprint);const e=0;n&&(this._offerIce.iceUfrag=c.iceUfrag,this._offerIce.icePwd=c.icePwd),this._offerMlines=[Fu(Fu(Fu({},c),this._offerIce),{},{mid:"".concat(e)})],this._answerMlines=[Fu(Fu(Fu({},c),this._answerIce),{},{sctpmap:{sctpmapNumber:5e3,app:"webrtc-datachannel",maxMessageSize:262144},mid:"".concat(e)})],this.setDescription()}return this._reportTransportStats(),await new Promise(((e,i)=>{this._connectReject=i;const o=setTimeout((()=>{var e;this.reportRtcPreIce("timeout"),null===(e=this._connectReject)||void 0===e||e.call(this,{code:4,message:"connect timeout"}),delete this._connectReject}),8e3),r=()=>{this._print("connect","dataChannel open"),this._reportRtcInvokeStatus("es.dc.open",""),this.reportRtcPreIce("datachannel_opened"),clearTimeout(o),e(""),delete this._connectReject},s=e=>{var t,i,r,s;this._report("rtc_signaling_msg_error",{error_code:null==e||null===(t=e.error)||void 0===t?void 0:t.sdpLineNumber,message:null==e||null===(i=e.error)||void 0===i?void 0:i.errorDetail,reason:"invalid data"}),this._reportRtcInvokeStatus("es.dc.error",""),null===(r=this._connectReject)||void 0===r||r.call(this,{message:"dc.onerror, ".concat(null===(s=e.error)||void 0===s?void 0:s.errorDetail),code:0}),this.emit("disconnect",pO.DC_ERROR),delete this._connectReject,clearTimeout(o)},n=()=>{var e;this._reportRtcInvokeStatus("es.dc.close",""),null===(e=this._connectReject)||void 0===e||e.call(this,{message:"dc.onclose",code:1}),this.reportRtcPreIce("datachannel_closed"),this.emit("disconnect",pO.DC_CLOSE),delete this._connectReject,clearTimeout(o)},a=()=>{"connected"===this._pc.iceConnectionState?this.reportRtcPreIce("ice_connected"):"failed"!==this._pc.iceConnectionState&&"closed"!==this._pc.iceConnectionState||this.reportRtcPreIce("ice_failed")},d=()=>{var e;"failed"!==this._pc.iceConnectionState&&"closed"!==this._pc.iceConnectionState&&"failed"!==this._pc.connectionState||(null===(e=this._connectReject)||void 0===e||e.call(this,{message:"pc.connectionstatechange -> ".concat(this._pc.connectionState,", ice -> ").concat(this._pc.iceConnectionState),code:2}),delete this._connectReject,clearTimeout(o))};t.addEventListener("open",r),t.addEventListener("error",s),t.addEventListener("close",n),this._pc.addEventListener("iceconnectionstatechange",a),this._pc.addEventListener("connectionstatechange",d),this._clearPeerListeners=()=>{t.removeEventListener("open",r),t.removeEventListener("error",s),t.removeEventListener("close",n),this._pc.removeEventListener("iceconnectionstatechange",a),this._pc.removeEventListener("connectionstatechange",d)}})),this._print("connect","dataChannel establish success"),t}async startIceConnectStandard(e){this._print("connect","standard invoke. %o",e),this._iceNode=e;const t=this._pc.createDataChannel("signaling",{negotiated:!0,id:100});t.binaryType="arraybuffer",this._dc=t;const{offerIce:i,answerIce:o}=this._genIceInfo(e);this._offerIce=i,this._answerIce=o,US&&dg<138&&(this._pc.addTransceiver("audio",{direction:"recvonly"}),this._pc.addTransceiver("video",{direction:"recvonly"}));const r=await this.createOfferSdp();if(!r)throw new Cg(Eg.NOT_SUPPORTED,"create offer sdp failed.");const s=Aw.parse(r);this._answerSession=Fu({},s),this._answerSession.fingerprint&&(this._answerSession.fingerprint=this._answerIce.fingerprint);const n=s.media.find((e=>"application"===e.type));this._peerConnectionId=o.iceUfrag||"";if(!i.iceUfrag&&!i.icePwd){const t="renomination"===(null==n?void 0:n.iceOptions);t||(delete i.iceOptions,delete o.iceOptions),delete i.iceUfrag,delete i.icePwd;const[r,s]=$w({serverUfrag:e.iceParams.serverIceUfrag,serverPwd:e.iceParams.serverIcePwd,clientPwd:null==n?void 0:n.icePwd,options:{[qw.kICEConfigTypeSrtpDtlsType]:!0,[qw.kICEConfigTypeRenominationType]:t}});this._peerConnectionId=s,o.iceUfrag=r,this._logger.info("use serverUfrag v2",JSON.stringify({dtls:!0,renomination:t}))}this.reportRtcPreIce("ice_start"),this._offerIce.fingerprint=s.fingerprint||n.fingerprint;const a=Fu({},s);return a.fingerprint=this._answerIce.fingerprint,a.media=a.media.map((e=>{if("application"===(e=Fu(Fu({},e),this._answerIce)).type&&(e.sctpmap={sctpmapNumber:5e3,app:"webrtc-datachannel",maxMessageSize:262144}),US)if(delete e.bundleOnly,e.port=9,"audio"===e.type)e.msid="ff-stream ff-stream-audio",e.direction="sendonly";else if("video"===e.type){var t,i,o,r;if(dE)e.ext=null===(t=e.ext)||void 0===t?void 0:t.filter((e=>-1===e.uri.indexOf("abs-send-time"))),e.rtcpFb=null===(i=e.rtcpFb)||void 0===i?void 0:i.filter((e=>"goog-remb"!==e.type));else e.rtcpFb=null===(o=e.rtcpFb)||void 0===o?void 0:o.filter((e=>"transport-cc"!==e.type)),e.ext=null===(r=e.ext)||void 0===r?void 0:r.filter((e=>-1===e.uri.indexOf("transport")));e.direction="sendonly"}return e})),"v1"===this.getIceVersion()?(s.media=s.media.map((e=>e=Fu(Fu({},e),this._offerIce))),await this.setLocalDescription(Aw.write(s))):await this.setLocalDescription(r),await this.setRemoteDescription(Aw.write(a)),this._reportTransportStats(),await new Promise(((e,i)=>{this._connectReject=i;const o=setTimeout((()=>{var e;this.reportRtcPreIce("timeout"),null===(e=this._connectReject)||void 0===e||e.call(this,{code:4,message:"connect timeout"}),delete this._connectReject}),8e3),r=()=>{this._print("connect","dataChannel open"),this._reportRtcInvokeStatus("es.dc.open",""),this.reportRtcPreIce("datachannel_opened"),clearTimeout(o),e(""),delete this._connectReject},s=e=>{var t,i,r,s;this._report("rtc_signaling_msg_error",{error_code:null==e||null===(t=e.error)||void 0===t?void 0:t.sdpLineNumber,message:null==e||null===(i=e.error)||void 0===i?void 0:i.errorDetail,reason:"invalid data"}),this._reportRtcInvokeStatus("es.dc.error",""),null===(r=this._connectReject)||void 0===r||r.call(this,{message:"dc.onerror, ".concat(null===(s=e.error)||void 0===s?void 0:s.errorDetail),code:0}),this.emit("disconnect",pO.DC_ERROR),delete this._connectReject,clearTimeout(o)},n=()=>{var e;this._reportRtcInvokeStatus("es.dc.close",""),null===(e=this._connectReject)||void 0===e||e.call(this,{message:"dc.onclose",code:1}),this.reportRtcPreIce("datachannel_closed"),this.emit("disconnect",pO.DC_CLOSE),delete this._connectReject,clearTimeout(o)},a=()=>{"connected"===this._pc.iceConnectionState?this.reportRtcPreIce("ice_connected"):"failed"!==this._pc.iceConnectionState&&"closed"!==this._pc.iceConnectionState||this.reportRtcPreIce("ice_failed")},d=()=>{var e;"failed"!==this._pc.iceConnectionState&&"closed"!==this._pc.iceConnectionState&&"failed"!==this._pc.connectionState||(null===(e=this._connectReject)||void 0===e||e.call(this,{message:"pc.connectionstatechange -> ".concat(this._pc.connectionState,", ice -> ").concat(this._pc.iceConnectionState),code:2}),delete this._connectReject,clearTimeout(o))};t.addEventListener("open",r),t.addEventListener("error",s),t.addEventListener("close",n),this._pc.addEventListener("iceconnectionstatechange",a),this._pc.addEventListener("connectionstatechange",d),this._clearPeerListeners=()=>{t.removeEventListener("open",r),t.removeEventListener("error",s),t.removeEventListener("close",n),this._pc.removeEventListener("iceconnectionstatechange",a),this._pc.removeEventListener("connectionstatechange",d)}})),this._print("connect","dataChannel establish success"),t}async setDescription(e){this._print("setDescription","invoke."),this._offerSession.media=this._offerMlines,this._answerSession.media=this._answerMlines;const t=[];this._offerMlines.forEach((e=>{"inactive"!==e.direction&&e.mid&&t.push(e.mid)})),this._offerSession.groups&&this._answerSession.groups&&(this._offerSession.groups[0].mids=t.join(" "),this._answerSession.groups[0].mids=t.join(" "));const i=jy();e&&this._report("rtc_begin_create_offer",{direction:"local"===e.streamUserId?"up":"down",stream_id:e.streamId,stream_user_id:e.streamUserId,pc_session_id:this._peerConnectionId,vendor_mode:0}),e&&this._report("rtc_create_offer",{error_code:0,direction:"local"===e.streamUserId?"up":"down",stream_id:e.streamId,stream_user_id:e.streamUserId,elapse:jy()-i}),await this.setLocalDescription(Aw.write(this._offerSession),e),await this.setRemoteDescription(Aw.write(this._answerSession),e)}async setLocalDescription(e,t){const i=jy();try{if(await this._pc.setLocalDescription({type:"offer",sdp:e}),this._report("rtc_set_description",{error_code:0,message:e,is_local:"1",direction:"local"===(null==t?void 0:t.streamUserId)?"up":"down",stream_id:(null==t?void 0:t.streamId)||"",stream_user_id:(null==t?void 0:t.streamUserId)||"",elapse:jy()-i},{type:"offer"}),!this._initSctpEvents){var o;this._initSctpEvents=!0;const e=null===(o=this._pc)||void 0===o?void 0:o.sctp;e&&(e.onstatechange=()=>{this._reportRtcInvokeStatus("sctp","sctp state change TO: ".concat(e.state))},e.transport&&(e.transport.onstatechange=()=>{var t;this._reportRtcInvokeStatus("dtls","dtls state change TO: ".concat(null==e||null===(t=e.transport)||void 0===t?void 0:t.state))}))}}catch(r){throw console.error("setLocal",r),this._report("rtc_set_description",{error_code:-1,message:r.message+e,is_local:"1",direction:"local"===(null==t?void 0:t.streamUserId)?"up":"down",stream_id:"",stream_user_id:"",elapse:jy()-i},{type:"offer"}),r}}async setRemoteDescription(e,t){const i=jy();try{e=(e=>aO(e,"ByteVC1","H265"))(e),await this._pc.setRemoteDescription({type:"answer",sdp:e}),this._report("rtc_set_description",{error_code:0,message:e,is_local:"0",direction:"local"===(null==t?void 0:t.streamUserId)?"up":"down",stream_id:(null==t?void 0:t.streamId)||"",stream_user_id:(null==t?void 0:t.streamUserId)||"",elapse:jy()-i},{type:"answer"})}catch(o){throw console.error("setRemote",o),this._report("rtc_set_description",{error_code:-1,message:o.message+e,is_local:"0",direction:"local"===(null==t?void 0:t.streamUserId)?"up":"down",stream_id:(null==t?void 0:t.streamId)||"",stream_user_id:(null==t?void 0:t.streamUserId)||"",elapse:jy()-i},{type:"answer"}),o}}closeIceConnect(){var e,t,i,o,r;null===(e=this._connectReject)||void 0===e||e.call(this,{code:3,message:"invoke destroy()"}),delete this._connectReject,null===(t=this._pc)||void 0===t||t.close(),null===(i=this._dc)||void 0===i||i.close(),delete this._dc,this._pc.ontrack=null,this._pc.onconnectionstatechange=null,this._pc.oniceconnectionstatechange=null,r=this._pc,IP.has(r)&&IP.delete(r),null===(o=this._clearPeerListeners)||void 0===o||o.call(this),delete this._clearPeerListeners}reportRtcPreIce(e){var t;const i=jy();"ice_start"===e&&(this._iceStartTs=i,this._icePreStepTs=i),this._report("rtc_pre_ice",{connect_event:e,message:e,elapse:i-this._icePreStepTs,total_elapse:i-this._iceStartTs,cache_status:!(null===(t=this._iceNode)||void 0===t||!t.cache_status),is_reconnect:this._isReconnect}),this._icePreStepTs=i}getStatsWithLowFrequency(e,t,i){return(async(e,t,i,o)=>{const r=null==t?void 0:t.id;if(!(e instanceof RTCPeerConnection))return[];if(US||ZS){const i=[];try{(o?await o.getStats():await e.getStats(t)).forEach((e=>{i.push(e)}))}catch(d){}return i}let s=IP.get(e);(!s||Date.now()-s.timestamp>150)&&(s={timestamp:Date.now(),statsPromise:CP(e),extraStatsPromise:RP(e)},IP.set(e,s));const n=await s.statsPromise;let a=(r?n[r]:n.all)||[];if(!i){const e=await s.extraStatsPromise;a=a.concat((r?e.getTrackStats(r):e.all)||[])}return a})(this._pc,e,t,i)}getIceVersion(){var e,t;return null!==(e=this._iceNode)&&void 0!==e&&e.iceParams.clientIceUfrag||null!==(t=this._iceNode)&&void 0!==t&&t.iceParams.clientIcePwd?"v1":"v2"}createAnswerSdp(e,t){dO(this._answerSession,"_answerSession should be existed");const i=Fu({},this._answerSession);i.media=e,i.groups=t;return Aw.write(i)}destroy(){this._print("destroy",this._peerConnectionId),super.removeAllListeners(),this.closeIceConnect(),this._destroyed=!0,this._reportTimer&&(clearTimeout(this._reportTimer),delete this._reportTimer),this._onLineCheckerTimer&&(clearInterval(this._onLineCheckerTimer),delete this._onLineCheckerTimer),delete this._pc}_genIceInfo(e){var t,i;return{offerIce:{iceUfrag:null===(t=e.iceParams)||void 0===t?void 0:t.clientIceUfrag,icePwd:null===(i=e.iceParams)||void 0===i?void 0:i.clientIcePwd,iceOptions:"renomination"},answerIce:zw(e)}}async _reportTransportStats(){const e=await this.getStatsWithLowFrequency(),t={};var i;(e.forEach((e=>{"transport"===e.type?(t.dtls_state=e.dtlsState,t.bytes_received=e.bytesReceived,t.bytes_sent=e.bytesSent,t.ice_state=e.iceState,t.packets_received=e.packetsReceived,t.packets_sent=e.packetsSent,t.selected_candidate_pair_changes=e.selectedCandidatePairChanges):"local-candidate"===e.type||"remote-candidate"===e.type?t.candidates_info=[...t.candidates_info||[],{id:e.id,is_remote:e.isRemote,port:e.port,protocol:e.protocol,candidate_type:e.candidateType,priority:e.priority,network_type:e.networkType,candidate_ip:e.ip}]:"candidate-pair"===e.type&&(t.candidatePairsInfo={},t.candidatePairsInfo.candidate_state=e.state,t.candidatePairsInfo.writable_state=e.writable,t.candidatePairsInfo.sent_ping_requests_total=e.requestsSent,t.candidatePairsInfo.recv_ping_requests=e.requestsReceived,t.candidatePairsInfo.sent_ping_responses=e.responsesSent,t.candidatePairsInfo.recv_ping_responses=e.responsesReceived,t.candidatePairsInfo.current_rtt=e.currentRoundTripTime,t.candidatePairsInfo.total_rtt=e.totalRoundTripTime,["localCandidateId","remoteCandidateId","bytesSent","bytesReceived","availableOutgoingBitrate","availableIncomingBitrate","bytesDiscardedOnSend","consentRequestsSent","packetsDiscardedOnSend","lastPacketReceivedTimestamp","lastPacketSentTimestamp"].forEach((i=>{var o;void 0!==e[i]&&(t.candidatePairsInfo[(o=i,o.replace(/[A-Z]/g,(e=>"_".concat(e.toLowerCase()))))]=e[i])})))})),Object.keys(t).length>0)&&(null===(i=this._monitor)||void 0===i||i.report("rtc_transport_statistics",t));if(!this._destroyed){const e="connected"===this._pc.iceConnectionState&&"connected"===this._pc.connectionState;this._reportTimer=setTimeout((()=>{this._reportTransportStats()}),e?5e3:1e3)}}_print(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),o=1;o<t;o++)i[o-1]=arguments[o];this._logger.info("".concat(e),...i)}_report(e,t,i){var o,r,s;null===(o=this._monitor)||void 0===o||o.report(e,Fu(Fu({},t),{},{connection_id:this._peerConnectionId,group_connection_id:this._groupConnectionId}),Fu(Fu({},i),{},{tcp_only:null===(r=this._iceNode)||void 0===r?void 0:r.iceConfig.tcpOnly,ms_addr:JSON.stringify((null===(s=this._iceNode)||void 0===s?void 0:s.publicIPs.map((e=>({ip:e.ip,tcp:e.tcpPorts,udp:e.udpPorts}))))||[])}))}_reportRtcInvokeStatus(e,t){this._report("rtc_invoke_status",{sdk_api_name:e,message:t,error_code:0,stream_id:"",elapse:0})}}const mO=e=>{const t=Fu({},lO);return e.pcKillSwitch.ctor_sdpsemantics_add&&(t.sdpSemantics="unified-plan"),e.pcKillSwitch.ctor_encodedinsetablestream_add&&cO&&!Qg("DISABLE_ENCODED_TRANSFORM")&&(t.encodedInsertableStreams=!0),t};var pO=(e=>(e.ICE_FAILED="ice failed",e.DC_ERROR="datachannel onerror",e.DC_CLOSE="datachannel onclose",e.NODE_CHANGE="recv nodeChange signaling",e.NOTIFY_RECONNECT="recv notifyReconnect signaling",e.JOIN_TIMEOUT="joinRoom timeout, retry with tcp only",e))(pO||{});class vO extends kI{constructor(e){super(),Xu(this,"id",void 0),Xu(this,"_monitor",void 0),Xu(this,"logger",void 0),Xu(this,"_getAccessManager",void 0),Xu(this,"_connectionPool",new Map),Xu(this,"_curConnection",void 0),Xu(this,"_hasReportBrowerWarning",!1),Xu(this,"_reconnectTimer",void 0),Xu(this,"_connecting",!1),Xu(this,"_isFirstTimeConnected",!0),Xu(this,"_feedbackNodes",[]),Xu(this,"_preIceStartTime",-1),Xu(this,"_tcpOnlyTimer",void 0),Xu(this,"_destroyed",!1),this._ctx=e,this.id=e.id,this._monitor=uS(this.id),this.logger=new LS("ConnectionManager",3,this.id),this.logger.info("constructor","invoke"),this._getAccessManager=new kw(e)}startup(){this.logger.info("connect","invoke");try{_O.checkSupported()}catch(e){this.asyncEmit("disconnected",e)}this._connecting||(this._onConnectStart(),Promise.resolve().then((()=>this.emit("__onGetIceConfigHook"))),this._getAccess())}async reconnectByNodeChange(e){var t,i,o;this.logger.info("reconnectByNodeChange","invoke %o",e);const{nodes:r,reason:s}=e;null===(t=this._monitor)||void 0===t||t.report("rtc_node_change",{error_code:0,message:JSON.stringify(e),reason:JSON.stringify(s)}),bg.clearAccessNode(this._ctx.appId),null===(i=this._curConnection)||void 0===i||i.pc.reportRtcPreIce("node_change");const n=(null===(o=this._curConnection)||void 0===o||null===(o=o.node.publicIPs[0])||void 0===o?void 0:o.ip)||"";this._closeCurrentConnection(),this._clearConnectionPool(),this._clearReconnectTimer(),this._onConnectStart("recv nodeChange signaling"),Array.isArray(r)&&r.length>0?this._startIceConnect(r):this._getAccess([{feedbackIP:n,feedbackReason:{type:"NODE_CHANGED",reason:s}}])}async reconnect(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.logger.info("reconnect","invoke. ".concat(t?"ICE over TCP":"")),this._closeCurrentConnection(),this._clearConnectionPool(),this._clearReconnectTimer(),this._onConnectStart(e),this._getAccess(void 0,t)}shotdown(){this.logger.info("destroy","invoke"),this._destroyed=!0,this.asyncEmit("disconnected",new Cg(Eg.OPERATION_CANCEL,"destroy")).then((()=>{super.removeAllListeners()})),this._clearReconnectTimer(),this._clearConnectionPool(),this._getAccessManager.destroy(),this._closeCurrentConnection()}_getAccess(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this._getAccessManager.getICENode(e).then((e=>{this.emit("__onGetIceSuccessHook",e),this._startIceConnect(e,t)})).catch((e=>{this.asyncEmit("disconnected",e)})).finally((()=>{this._feedbackNodes=[]}))}_startIceConnect(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this._destroyed)return;this.logger.info("_startIceConnect","invoke");const i=sm();this._preIceStartTime=jy();const o=this._ctx.joinRoomConfig.useTcpJoin,r=this._ctx.joinRoomConfig.useTcpJoinDelay,s=async o=>{t&&((o=JN(o)).iceConfig.tcpOnly=!0);const r={node:o};try{const t=new _O(this._ctx,i,!this._isFirstTimeConnected);r.pc=t,this._connectionPool.set(t.uuid,r);const s=await t.startIceConnect(o),n=new aw(this.id,s,{connection_id:t.getConnectionId(),group_connection_id:i});r.signaling=n,t.reportRtcPreIce("datachannel_send_ping"),await n.sendPingSignaling(),t.reportRtcPreIce("datachannel_recv_pong"),this._onConnectSuccess({node:o,pc:t,signaling:n,dc:s}),this.safeEmit("__onConnectSuccessHook",e.length)}catch(s){this._onConnectionFailed(r,s)}};this.emit("__onIceConnectStartHook"),e.forEach(s),o&&!t&&(this.logger.info("_startIceConnect","tcp-only will try after ".concat(r,"ms")),this._tcpOnlyTimer=setTimeout((()=>{this.emit("connectWidthTcp"),e.forEach((e=>{(e=JN(e)).iceConfig.tcpOnly=!0,s(e)})),delete this._tcpOnlyTimer}),r))}_onConnectSuccess(e){var t;(this.logger.info("connect","peer_%s connect success.",e.pc.uuid),this.emit("__onIceConnectSuccessHook",e),this._curConnection)?(e.pc.destroy(),e.signaling.destroy(),this._connectionPool.delete(e.pc.uuid)):(this._curConnection=e,this._addConnectionHandler(e.pc),null===(t=this._monitor)||void 0===t||t.set({connection_id:e.pc.getConnectionId()}),this._connectionPool.delete(e.pc.uuid),this._feedbackNodes.forEach((e=>this._feedbackBySignaling(e))),this._feedbackNodes=[],this._onConnectEnded(e))}_onConnectionFailed(e,t){var i,o;(this.logger.info("connect","peer_%s connect failed. %s",(null===(i=e.pc)||void 0===i?void 0:i.uuid)||"",t.message),this.emit("__onIceConnectFailedHook",e),t.code!==uO.DESTROY&&t.code!==Eg.OPERATION_CANCEL)&&(this._curConnection?this._feedbackBySignaling(e.node):this._feedbackNodes.push(e.node),this.logger.info("connect","remove cache node"),bg.deleteAccessNode(this._ctx.appId,e.node),e.pc&&(this._connectionPool.delete(e.pc.uuid),e.pc.destroy()),null===(o=e.signaling)||void 0===o||o.destroy(),0!==this._connectionPool.size||this._curConnection||this._destroyed||(this.logger.error("connect","establish peerConnection failed"),this._checkBrowserUA(),jy()-this._preIceStartTime<1e3?(this._clearReconnectTimer(),this._reconnectTimer=setTimeout((()=>{delete this._reconnectTimer,this._reconnectWithIceFailed(this._feedbackNodes)}),1e3)):this._reconnectWithIceFailed(this._feedbackNodes)))}_feedbackBySignaling(e){var t;null===(t=this._curConnection)||void 0===t||t.signaling.sendSignaling("scheduleMessage",{type:"feedback",body:{feedbackIP:e.publicIPs[0].ip,feedbackReason:{type:"ICE_FAILED",reason:{}}}})}async _reconnectWithIceFailed(e){this._onConnectStart("ice failed"),this.logger.warn("reconnect","because of ice failed"),this._getAccess(e.map((e=>({feedbackIP:e.publicIPs[0].ip,feedbackReason:{type:"ICE_FAILED",reason:{}}}))))}_checkBrowserUA(){var e;!this._hasReportBrowerWarning&&this._ctx.joinRoomConfig.isBlackBrower()&&(this._hasReportBrowerWarning=!0,null===(e=this._monitor)||void 0===e||e.report("rtc_error",{error_code:JP.BLACK_BROWSER,message:"failed to establish data-channel, and the current browser is on the browser blacklist."}))}_onConnectStart(e){var t;this.logger.info("_onConnectStart","invoke, reason: ".concat(e||"init")),this._connecting=!0,e?this.asyncEmit("reconnecting",e):this.asyncEmit("connecting");const i=sm();var o;(null===(t=this._monitor)||void 0===t||t.set({connect_session_id:i}),this._isFirstTimeConnected)||(null===(o=this._monitor)||void 0===o||o.report("rtc_reconnect",{error_code:1002,message:"peerconnection reconnecting",reconnect_id:i,reconnect_type:"peerconnection"},{reason:e}))}_onConnectEnded(e){var t;(this.logger.info("_onConnectEnded","invoke"),this._connecting=!1,this._isFirstTimeConnected)||(null===(t=this._monitor)||void 0===t||t.report("rtc_reconnected",{message:"peerconnection reconnected",reconnect_type:"peerconnection"}));this._isFirstTimeConnected=!1,this.asyncEmit("connected",e),e.node.iceConfig.tcpOnly&&(this.logger.info("_onConnectEnded","use tcp only"),fS(this._ctx.id,"connected_with_tcp_only",JSON.stringify(e.node))),this._tcpOnlyTimer&&(window.clearTimeout(this._tcpOnlyTimer),delete this._tcpOnlyTimer),this._clearConnectionPool()}_addConnectionHandler(e){e.on("disconnect",(e=>{this._closeCurrentConnection(),this._clearReconnectTimer(),navigator.onLine?this.reconnect(e):this._reconnectTimer=setTimeout((()=>this.reconnect(e)),3e3)}))}_closeCurrentConnection(){var e,t;null===(e=this._curConnection)||void 0===e||e.pc.destroy(),null===(t=this._curConnection)||void 0===t||t.signaling.destroy(),delete this._curConnection}_clearConnectionPool(){this._connectionPool.forEach(((e,t)=>{var i,o;null===(i=e.signaling)||void 0===i||i.destroy(),null===(o=e.pc)||void 0===o||o.destroy(),this._connectionPool.delete(t)}))}_clearReconnectTimer(){this._reconnectTimer&&(window.clearTimeout(this._reconnectTimer),delete this._reconnectTimer)}}var fO=i(cr.f("asyncIterator")),SO=tt,gO=xd,yO=k,bO=ei,TO=q,IO=gi,EO=Error,RO=f("".replace),CO=String(new EO("zxcasd").stack),kO=/\n\s*at [^:]*:[^\n]*/,AO=kO.test(CO),PO=U,NO=!n((function(){var e=new Error("a");return!("stack"in e)||(Object.defineProperty(e,"stack",PO(1,7)),7!==e.stack)})),wO=gi,OO=function(e,t){if(AO&&"string"==typeof e&&!EO.prepareStackTrace)for(;t--;)e=RO(e,kO,"");return e},MO=NO,LO=Error.captureStackTrace,xO=$t,VO=w,DO=si,UO=ke,ZO=YC,WO=Fi,XO=se,GO=eR,FO=BE,HO=ZC,YO=TypeError,KO=function(e,t){this.stopped=e,this.result=t},BO=KO.prototype,JO=function(e,t,i){var o,r,s,n,a,d,c,l=i&&i.that,u=!(!i||!i.AS_ENTRIES),h=!(!i||!i.IS_RECORD),_=!(!i||!i.IS_ITERATOR),m=!(!i||!i.INTERRUPTED),p=xO(t,l),v=function(e){return o&&HO(o,"normal",e),new KO(!0,e)},f=function(e){return u?(DO(e),m?p(e[0],e[1],v):p(e[0],e[1])):m?p(e,v):p(e)};if(h)o=e.iterator;else if(_)o=e;else{if(!(r=FO(e)))throw new YO(UO(e)+" is not iterable");if(ZO(r)){for(s=0,n=WO(e);n>s;s++)if((a=f(e[s]))&&XO(BO,a))return a;return new KO(!1)}o=GO(e,r)}for(d=h?e.next:o.next;!(c=VO(d,o)).done;){try{a=f(c.value)}catch(wZ){HO(o,"throw",wZ)}if("object"==typeof a&&a&&XO(BO,a))return a}return new KO(!1)},jO=bo,zO=wi,QO=se,qO=Xc,$O=pl,eM=function(e,t,i){for(var o=gO(t),r=bO.f,s=yO.f,n=0;n<o.length;n++){var a=o[n];SO(e,a)||i&&SO(i,a)||r(e,a,s(t,a))}},tM=Bo,iM=gi,oM=U,rM=function(e,t){TO(t)&&"cause"in t&&IO(e,"cause",t.cause)},sM=function(e,t,i,o){MO&&(LO?LO(e,t):wO(e,"stack",OO(i,o)))},nM=JO,aM=function(e,t){return void 0===e?arguments.length<2?"":t:jO(e)},dM=pt("toStringTag"),cM=Error,lM=[].push,uM=function(e,t){var i,o=QO(hM,this);$O?i=$O(new cM,o?qO(this):hM):(i=o?this:tM(hM),iM(i,dM,"Error")),void 0!==t&&iM(i,"message",aM(t)),sM(i,uM,i.stack,1),arguments.length>2&&rM(i,arguments[2]);var r=[];return nM(e,lM,{that:r}),iM(i,"errors",r),i};$O?$O(uM,cM):eM(uM,cM,{name:!0});var hM=uM.prototype=tM(cM.prototype,{constructor:oM(1,uM),message:oM(1,""),name:oM(1,"AggregateError")});zO({global:!0,constructor:!0,arity:2},{AggregateError:uM});var _M,mM,pM,vM,fM=s,SM=de,gM=b,yM=function(e){return SM.slice(0,e.length)===e},bM=yM("Bun/")?"BUN":yM("Cloudflare-Workers")?"CLOUDFLARE":yM("Deno/")?"DENO":yM("Node.js/")?"NODE":fM.Bun&&"string"==typeof Bun.version?"BUN":fM.Deno&&"object"==typeof Deno.version?"DENO":"process"===gM(fM.process)?"NODE":fM.window&&fM.document?"BROWSER":"REST",TM="NODE"===bM,IM=re,EM=dr,RM=A,CM=pt("species"),kM=_s,AM=ke,PM=TypeError,NM=si,wM=function(e){if(kM(e))return e;throw new PM(AM(e)+" is not a constructor")},OM=H,MM=pt("species"),LM=function(e,t){var i,o=NM(e).constructor;return void 0===o||OM(i=NM(o)[MM])?t:wM(i)},xM=/(?:ipad|iphone|ipod).*applewebkit/i.test(de),VM=s,DM=h,UM=$t,ZM=C,WM=tt,XM=n,GM=No,FM=qo,HM=Pt,YM=iR,KM=xM,BM=TM,JM=VM.setImmediate,jM=VM.clearImmediate,zM=VM.process,QM=VM.Dispatch,qM=VM.Function,$M=VM.MessageChannel,eL=VM.String,tL=0,iL={},oL="onreadystatechange";XM((function(){_M=VM.location}));var rL=function(e){if(WM(iL,e)){var t=iL[e];delete iL[e],t()}},sL=function(e){return function(){rL(e)}},nL=function(e){rL(e.data)},aL=function(e){VM.postMessage(eL(e),_M.protocol+"//"+_M.host)};JM&&jM||(JM=function(e){YM(arguments.length,1);var t=ZM(e)?e:qM(e),i=FM(arguments,1);return iL[++tL]=function(){DM(t,void 0,i)},mM(tL),tL},jM=function(e){delete iL[e]},BM?mM=function(e){zM.nextTick(sL(e))}:QM&&QM.now?mM=function(e){QM.now(sL(e))}:$M&&!KM?(vM=(pM=new $M).port2,pM.port1.onmessage=nL,mM=UM(vM.postMessage,vM)):VM.addEventListener&&ZM(VM.postMessage)&&!VM.importScripts&&_M&&"file:"!==_M.protocol&&!XM(aL)?(mM=aL,VM.addEventListener("message",nL,!1)):mM=oL in HM("script")?function(e){GM.appendChild(HM("script"))[oL]=function(){GM.removeChild(this),rL(e)}}:function(e){setTimeout(sL(e),0)});var dL={set:JM,clear:jM},cL=function(){this.head=null,this.tail=null};cL.prototype={add:function(e){var t={item:e,next:null},i=this.tail;i?i.next=t:this.head=t,this.tail=t},get:function(){var e=this.head;if(e)return null===(this.head=e.next)&&(this.tail=null),e.item}};var lL,uL,hL,_L,mL,pL=cL,vL=/ipad|iphone|ipod/i.test(de)&&"undefined"!=typeof Pebble,fL=/web0s(?!.*chrome)/i.test(de),SL=s,gL=ME,yL=$t,bL=dL.set,TL=pL,IL=xM,EL=vL,RL=fL,CL=TM,kL=SL.MutationObserver||SL.WebKitMutationObserver,AL=SL.document,PL=SL.process,NL=SL.Promise,wL=gL("queueMicrotask");if(!wL){var OL=new TL,ML=function(){var e,t;for(CL&&(e=PL.domain)&&e.exit();t=OL.get();)try{t()}catch(wZ){throw OL.head&&lL(),wZ}e&&e.enter()};IL||CL||RL||!kL||!AL?!EL&&NL&&NL.resolve?((_L=NL.resolve(void 0)).constructor=NL,mL=yL(_L.then,_L),lL=function(){mL(ML)}):CL?lL=function(){PL.nextTick(ML)}:(bL=yL(bL,SL),lL=function(){bL(ML)}):(uL=!0,hL=AL.createTextNode(""),new kL(ML).observe(hL,{characterData:!0}),lL=function(){hL.data=uL=!uL}),wL=function(e){OL.head||lL(),OL.add(e)}}var LL=wL,xL=function(e){try{return{error:!1,value:e()}}catch(wZ){return{error:!0,value:wZ}}},VL=s.Promise,DL=s,UL=VL,ZL=C,WL=jt,XL=es,GL=pt,FL=bM,HL=pe,YL=UL&&UL.prototype,KL=GL("species"),BL=!1,JL=ZL(DL.PromiseRejectionEvent),jL={CONSTRUCTOR:WL("Promise",(function(){var e=XL(UL),t=e!==String(UL);if(!t&&66===HL)return!0;if(!YL.catch||!YL.finally)return!0;if(!HL||HL<51||!/native code/.test(e)){var i=new UL((function(e){e(1)})),o=function(e){e((function(){}),(function(){}))};if((i.constructor={})[KL]=o,!(BL=i.then((function(){}))instanceof o))return!0}return!(t||"BROWSER"!==FL&&"DENO"!==FL||JL)})),REJECTION_EVENT:JL,SUBCLASSING:BL},zL={},QL=we,qL=TypeError,$L=function(e){var t,i;this.promise=new e((function(e,o){if(void 0!==t||void 0!==i)throw new qL("Bad Promise constructor");t=e,i=o})),this.resolve=QL(t),this.reject=QL(i)};zL.f=function(e){return new $L(e)};var ex,tx,ix=wi,ox=TM,rx=s,sx=w,nx=nr,ax=Or,dx=function(e){var t=IM(e);RM&&t&&!t[CM]&&EM(t,CM,{configurable:!0,get:function(){return this}})},cx=we,lx=C,ux=q,hx=XE,_x=LM,mx=dL.set,px=LL,vx=function(e,t){try{1===arguments.length?console.error(e):console.error(e,t)}catch(wZ){}},fx=xL,Sx=pL,gx=Jr,yx=VL,bx=jL,Tx=zL,Ix="Promise",Ex=bx.CONSTRUCTOR,Rx=bx.REJECTION_EVENT,Cx=gx.getterFor(Ix),kx=gx.set,Ax=yx&&yx.prototype,Px=yx,Nx=Ax,wx=rx.TypeError,Ox=rx.document,Mx=rx.process,Lx=Tx.f,xx=Lx,Vx=!!(Ox&&Ox.createEvent&&rx.dispatchEvent),Dx="unhandledrejection",Ux=function(e){var t;return!(!ux(e)||!lx(t=e.then))&&t},Zx=function(e,t){var i,o,r,s=t.value,n=1===t.state,a=n?e.ok:e.fail,d=e.resolve,c=e.reject,l=e.domain;try{a?(n||(2===t.rejection&&Hx(t),t.rejection=1),!0===a?i=s:(l&&l.enter(),i=a(s),l&&(l.exit(),r=!0)),i===e.promise?c(new wx("Promise-chain cycle")):(o=Ux(i))?sx(o,i,d,c):d(i)):c(s)}catch(wZ){l&&!r&&l.exit(),c(wZ)}},Wx=function(e,t){e.notified||(e.notified=!0,px((function(){for(var i,o=e.reactions;i=o.get();)Zx(i,e);e.notified=!1,t&&!e.rejection&&Gx(e)})))},Xx=function(e,t,i){var o,r;Vx?((o=Ox.createEvent("Event")).promise=t,o.reason=i,o.initEvent(e,!1,!0),rx.dispatchEvent(o)):o={promise:t,reason:i},!Rx&&(r=rx["on"+e])?r(o):e===Dx&&vx("Unhandled promise rejection",i)},Gx=function(e){sx(mx,rx,(function(){var t,i=e.facade,o=e.value;if(Fx(e)&&(t=fx((function(){ox?Mx.emit("unhandledRejection",o,i):Xx(Dx,i,o)})),e.rejection=ox||Fx(e)?2:1,t.error))throw t.value}))},Fx=function(e){return 1!==e.rejection&&!e.parent},Hx=function(e){sx(mx,rx,(function(){var t=e.facade;ox?Mx.emit("rejectionHandled",t):Xx("rejectionhandled",t,e.value)}))},Yx=function(e,t,i){return function(o){e(t,o,i)}},Kx=function(e,t,i){e.done||(e.done=!0,i&&(e=i),e.value=t,e.state=2,Wx(e,!0))},Bx=function(e,t,i){if(!e.done){e.done=!0,i&&(e=i);try{if(e.facade===t)throw new wx("Promise can't be resolved itself");var o=Ux(t);o?px((function(){var i={done:!1};try{sx(o,t,Yx(Bx,i,e),Yx(Kx,i,e))}catch(wZ){Kx(i,wZ,e)}})):(e.value=t,e.state=1,Wx(e,!1))}catch(wZ){Kx({done:!1},wZ,e)}}};Ex&&(Nx=(Px=function(e){hx(this,Nx),cx(e),sx(ex,this);var t=Cx(this);try{e(Yx(Bx,t),Yx(Kx,t))}catch(wZ){Kx(t,wZ)}}).prototype,(ex=function(e){kx(this,{type:Ix,done:!1,notified:!1,parent:!1,reactions:new Sx,rejection:!1,state:0,value:null})}).prototype=nx(Nx,"then",(function(e,t){var i=Cx(this),o=Lx(_x(this,Px));return i.parent=!0,o.ok=!lx(e)||e,o.fail=lx(t)&&t,o.domain=ox?Mx.domain:void 0,0===i.state?i.reactions.add(o):px((function(){Zx(o,i)})),o.promise})),tx=function(){var e=new ex,t=Cx(e);this.promise=e,this.resolve=Yx(Bx,t),this.reject=Yx(Kx,t)},Tx.f=Lx=function(e){return e===Px||undefined===e?new tx(e):xx(e)}),ix({global:!0,constructor:!0,wrap:!0,forced:Ex},{Promise:Px}),ax(Px,Ix,!1,!0),dx(Ix);var Jx=pt("iterator"),jx=!1;try{var zx=0,Qx={next:function(){return{done:!!zx++}},return:function(){jx=!0}};Qx[Jx]=function(){return this},Array.from(Qx,(function(){throw 2}))}catch(wZ){}var qx=VL,$x=jL.CONSTRUCTOR||!function(e,t){try{if(!t&&!jx)return!1}catch(wZ){return!1}var i=!1;try{var o={};o[Jx]=function(){return{next:function(){return{done:i=!0}}}},e(o)}catch(wZ){}return i}((function(e){qx.all(e).then(void 0,(function(){}))})),eV=w,tV=we,iV=zL,oV=xL,rV=JO;wi({target:"Promise",stat:!0,forced:$x},{all:function(e){var t=this,i=iV.f(t),o=i.resolve,r=i.reject,s=oV((function(){var i=tV(t.resolve),s=[],n=0,a=1;rV(e,(function(e){var d=n++,c=!1;a++,eV(i,t,e).then((function(e){c||(c=!0,s[d]=e,--a||o(s))}),r)})),--a||o(s)}));return s.error&&r(s.value),i.promise}});var sV=wi,nV=jL.CONSTRUCTOR;VL&&VL.prototype,sV({target:"Promise",proto:!0,forced:nV,real:!0},{catch:function(e){return this.then(void 0,e)}});var aV=w,dV=we,cV=zL,lV=xL,uV=JO;wi({target:"Promise",stat:!0,forced:$x},{race:function(e){var t=this,i=cV.f(t),o=i.reject,r=lV((function(){var r=dV(t.resolve);uV(e,(function(e){aV(r,t,e).then(i.resolve,o)}))}));return r.error&&o(r.value),i.promise}});var hV=zL;wi({target:"Promise",stat:!0,forced:jL.CONSTRUCTOR},{reject:function(e){var t=hV.f(this);return(0,t.reject)(e),t.promise}});var _V=si,mV=q,pV=zL,vV=function(e,t){if(_V(e),mV(t)&&t.constructor===e)return t;var i=pV.f(e);return(0,i.resolve)(t),i.promise},fV=wi,SV=VL,gV=jL.CONSTRUCTOR,yV=vV,bV=re("Promise"),TV=!gV;fV({target:"Promise",stat:!0,forced:true},{resolve:function(e){return yV(TV&&this===bV?SV:this,e)}});var IV=w,EV=we,RV=zL,CV=xL,kV=JO;wi({target:"Promise",stat:!0,forced:$x},{allSettled:function(e){var t=this,i=RV.f(t),o=i.resolve,r=i.reject,s=CV((function(){var i=EV(t.resolve),r=[],s=0,n=1;kV(e,(function(e){var a=s++,d=!1;n++,IV(i,t,e).then((function(e){d||(d=!0,r[a]={status:"fulfilled",value:e},--n||o(r))}),(function(e){d||(d=!0,r[a]={status:"rejected",reason:e},--n||o(r))}))})),--n||o(r)}));return s.error&&r(s.value),i.promise}});var AV=w,PV=we,NV=re,wV=zL,OV=xL,MV=JO,LV="No one promise resolved";wi({target:"Promise",stat:!0,forced:$x},{any:function(e){var t=this,i=NV("AggregateError"),o=wV.f(t),r=o.resolve,s=o.reject,n=OV((function(){var o=PV(t.resolve),n=[],a=0,d=1,c=!1;MV(e,(function(e){var l=a++,u=!1;d++,AV(o,t,e).then((function(e){u||c||(c=!0,r(e))}),(function(e){u||c||(u=!0,n[l]=e,--d||s(new i(n,LV)))}))})),--d||s(new i(n,LV))}));return n.error&&s(n.value),o.promise}});var xV=wi,VV=h,DV=qo,UV=zL,ZV=we,WV=xL,XV=s.Promise,GV=!1;xV({target:"Promise",stat:!0,forced:!XV||!XV.try||WV((function(){XV.try((function(e){GV=8===e}),8)})).error||!GV},{try:function(e){var t=arguments.length>1?DV(arguments,1):[],i=UV.f(this),o=WV((function(){return VV(ZV(e),void 0,t)}));return(o.error?i.reject:i.resolve)(o.value),i.promise}});var FV=zL;wi({target:"Promise",stat:!0},{withResolvers:function(){var e=FV.f(this);return{promise:e.promise,resolve:e.resolve,reject:e.reject}}});var HV=wi,YV=VL,KV=n,BV=re,JV=C,jV=LM,zV=vV,QV=YV&&YV.prototype;HV({target:"Promise",proto:!0,real:!0,forced:!!YV&&KV((function(){QV.finally.call({then:function(){}},(function(){}))}))},{finally:function(e){var t=jV(this,BV("Promise")),i=JV(e);return this.then(i?function(i){return zV(t,e()).then((function(){return i}))}:e,i?function(i){return zV(t,e()).then((function(){throw i}))}:e)}});var qV=i($.Promise);function $V(e){function t(e){if(Object(e)!==e)return qV.reject(new TypeError(e+" is not an object."));var t=e.done;return qV.resolve(e.value).then((function(e){return{value:e,done:t}}))}return($V=function(e){this.s=e,this.n=e.next}).prototype={s:null,n:null,next:function(){return t(this.n.apply(this.s,arguments))},return:function(e){var i=this.s.return;return void 0===i?qV.resolve({value:e,done:!0}):t(i.apply(this.s,arguments))},throw:function(e){var i=this.s.return;return void 0===i?qV.reject(e):t(i.apply(this.s,arguments))}},new $V(e)}class eD extends EI.EventEmitter{constructor(e,t){super(),Xu(this,"_context",void 0),Xu(this,"peerConnectionMode",0),Xu(this,"id",void 0),Xu(this,"_monitor",void 0),Xu(this,"logger",void 0),Xu(this,"_nextSsrc",Math.floor(Math.random()*Fw+1e4)),Xu(this,"_aSendonlyAnswerTpl",void 0),Xu(this,"_vSendonlyAnswerTpl",void 0),Xu(this,"_enableSubFlexfec",!1),Xu(this,"audioTrack4ff",void 0),Xu(this,"setLocalDescription",void 0),Xu(this,"setRemoteDescription",void 0),this.peer=t,this.id=e.id,this._monitor=uS(this.id),this.logger=new LS("BasicHandler",3,e.id),this.setLocalDescription=t.setLocalDescription.bind(t),this.setRemoteDescription=t.setRemoteDescription.bind(t),this._context=e,this.peer.on("ontrack",(e=>{this.emit("ontrack",e)}))}destroy(){this.logger.info("destroy",this.peerConnectionId||""),super.removeAllListeners()}get _peerConnection(){return this.peer.getOriginRTCPeerConnection()}getTransceivers(){return this._peerConnection.getTransceivers()}getConnectionState(){return this._peerConnection.connectionState}internalPublish(e){const{stream:t,videoTrack:i,audioTrack:o,pubAudio:r,pubVideo:s}=e,n={direction:"sendonly",streams:[t]},a={direction:"sendonly",streams:[t]},{sendEncodings:d,videoDescriptions:c,subVideoDescriptions:l,activeSimulcastStreams:u}=this._context.videoProfile.genVideoDescriptions(e);a.sendEncodings=d,this._context.videoProfile.activeSimStreams=u,this.logger.info("publish videoTransceiverInit videoDescriptions","",a,c);let h=null==o?void 0:o.preprocessingTrack;(null==o?void 0:o.mixType)!==Oh.PLAYOUT&&null!=o&&o.mixedAudioTrack&&(h=null==o?void 0:o.mixedAudioTrack),h=r&&h?h:"audio";let _=null==i?void 0:i.preprocessingTrack;_=s&&_?_:"video";try{this._reportRtcInvokeStatus("Handler.internalPublish",JSON.stringify({aTrack:am(h),vTrack:am(_),audioTransceiverInit:n,videoTransceiverInit:a}))}catch(wZ){}return{semantics:"unified-plan",videoDescriptions:c,subVideoDescriptions:l,audioTransceiverInit:{track:h,init:n},videoTransceiverInit:{track:_,init:a}}}async setCurrentDescription(){}createAVMlineAnswerTpl(e){const t=Aw.parse(e);t.media.forEach((e=>{if("audio"===e.type){if("sendonly"===e.direction){const t=null==e?void 0:e.rtp.find((e=>"opus"===e.codec));if(t&&null!=e&&e.fmtp){const i=null==e?void 0:e.fmtp.find((e=>e.payload===t.payload));i&&this._context&&(i.config+=";stereo=1;sprop-stereo=1")}this._aSendonlyAnswerTpl=e}}else"video"===e.type&&("sendonly"===e.direction&&(this._vSendonlyAnswerTpl=e),Array.isArray(e.rtp)&&e.rtp.forEach((e=>{var t;null!==(t=e.codec)&&void 0!==t&&t.includes("flexfec")&&(this._enableSubFlexfec=!0)})))})),cE&&iO(t)}get peerConnectionId(){return this.peer.getConnectionId()||""}addBitrateLimit(e,t){null==e||e.rtp.forEach((i=>{let{codec:o,payload:r}=i;if(["vp8","h264"].includes(o.toLocaleLowerCase())){const i=e.fmtp.find((e=>e.payload===r));i?i.config=[...i.config.split(";"),"x-google-min-bitrate=100","x-google-start-bitrate=".concat(t)].join(";"):e.fmtp.push({payload:r,config:"x-google-min-bitrate=100;x-google-start-bitrate=".concat(t)})}}))}_report(e,t,i){var o;null===(o=this._monitor)||void 0===o||o.report(e,Fu(Fu({},t),{},{connection_id:this.peer.getConnectionId(),group_connection_id:this.peer.getGroupConnectionId()}),i)}_reportRtcInvokeStatus(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"",r=arguments.length>4?arguments[4]:void 0;this._report("rtc_invoke_status",{sdk_api_name:e,message:t,error_code:i,stream_id:o,elapse:0},r)}}const tD=new LS("queue",4);var iD=(e=>(e[e.ADD=0]="ADD",e[e.CLOSE=1]="CLOSE",e))(iD||{}),oD=(e=>(e.publish="publish",e.unpublish="unpublish",e.subscribe="subscribe",e.unsubscribe="unsubscribe",e.pushtrack="pushtrack",e.removetrack="removetrack",e))(oD||{});const rD={publish:"unpublish",subscribe:"unsubscribe",pushtrack:"removetrack"},sD={publish:0,subscribe:0,pushtrack:0,unpublish:1,unsubscribe:1,removetrack:1};class nD extends RI{constructor(){super(),Xu(this,"_queue",void 0),this._queue=[]}get queue(){return this._queue}enqueue(e){const t=this._queue.length;let i="";return this._queue=this._queue.filter((t=>t.streamId!==e.streamId||e.action!==rD[t.action]||(i=t.streamId,tD.info("offsetStreamId",i),!1))),this._queue.length===t&&this._queue.push(e),this.emit("start"),i}dequeue(){if(!this._queue.length)return null;let e=this._queue.length;WS&&_g>=86&&_g<=92&&(e=Math.min(this._queue.length,5));const t=sD[this._queue[0].action];for(let i=1;i<e;i++)if(sD[this._queue[i].action]!==t)return{sdpStrategy:t,items:this._queue.splice(0,i)};return{sdpStrategy:t,items:this._queue.splice(0,e)}}destroy(){this._queue=[]}}const aD=sE()||rE();class dD extends eD{constructor(e,t){var i;super(e,t),Xu(this,"name","chrome"),Xu(this,"_queueBusy",!1),Xu(this,"_sdpQueue",void 0),Xu(this,"_aSendonlyOfferTpl",void 0),Xu(this,"_vSendonlyOfferTpl",void 0),Xu(this,"_aRecvonlyOfferTpl",void 0),Xu(this,"_vRecvonlyOfferTpl",void 0),Xu(this,"_mid",10),Xu(this,"_inactiveMlineIndex",[]),Xu(this,"setDescription",void 0),this.logger=new LS("ChromeHandler",3,e.id),this.setDescription=t.setDescription.bind(t),this._sdpQueue=new nD,this._sdpQueue.on("start",(()=>{this._queueBusy||"stable"!==this._peerConnection.signalingState||(this.logger.info("dequeue start"),this.dequeue())})),null===(i=this._context.monitor)||void 0===i||i.set({handler_mode:"chrome"})}destroy(){super.destroy(),this._sdpQueue.destroy()}async publish(e){var t;const{stream:i,enableSimulcast:o}=e,{videoDescriptions:r,subVideoDescriptions:s,audioTransceiverInit:n,videoTransceiverInit:a}=super.internalPublish(e),d=Yw(this._nextSsrc);this._nextSsrc=d.next;const c="".concat(this._mid++),l="".concat(this._mid++),u=Fu(Fu(Fu({},this._aSendonlyOfferTpl),this.peer._offerIce),{},{mid:c,msid:"".concat(i.id," ").concat(i.id,"-audio"),ssrcs:Kw(i.id,"audio",d.audio,Hw)}),h=Fu(Fu(Fu({},this._vSendonlyOfferTpl),this.peer._offerIce),{},{mid:l,msid:"".concat(i.id," ").concat(i.id,"-video")});if(o){this.logger.info("subVideoDesc","desc: %o ",s),delete h.ssrcGroups,delete h.ssrcs;const e=[];h.rids=r.map((t=>{let{rid:i}=t;return e.unshift(i),{id:i,direction:"send"}})),h.simulcast={dir1:"send",list1:e.join(";")}}else{const{ssrcs:e,ssrcGroups:t}=Bw(i.id,d,{cname:Hw});h.ssrcs=e,h.ssrcGroups=t}if(null!==(t=this._context.serverConfig)&&void 0!==t&&t.audioRed&&Array.isArray(u.rtp)){const e=u.rtp.findIndex((e=>"red"===e.codec));if(-1!==e){const[t]=u.rtp.splice(e,1);u.rtp.unshift(t)}const t=[];u.rtp.forEach((e=>t.push(e.payload))),u.payloads=t.join(" ")}Array.isArray(h.ext)&&(Qg("IOS_SAFARI_ORIENTATION")||!ZS&&!qS||(h.ext=h.ext.filter((e=>{var t;return!(null!=e&&null!==(t=e.uri)&&void 0!==t&&t.includes("video-orientation"))}))),h.ext=h.ext.filter((e=>{var t;return!(null!=e&&null!==(t=e.uri)&&void 0!==t&&t.includes("framemarking"))})));const _=null==u?void 0:u.rtp.find((e=>"opus"===e.codec));if(_&&u.fmtp){const e=u.fmtp.find((e=>e.payload===_.payload));e&&this._context.audioProfileManager&&(e.config=this._context.audioProfileManager.getOpusConfigStr(e.config))}return o||ZS||this.addBitrateLimit(h,e.videoEncodeConfig[0].maxKbps),e.audioMLine=u,e.videoMLine=h,{partialSdp:jw(this.peer._offerSession,u,h),audioMid:c,videoMid:l,type:"incroffer",semantics:"unified-plan",videoDescriptions:r,subVideoDescriptions:s,audioTransceiverInit:n,videoTransceiverInit:a,peerConnectionMode:this.peerConnectionMode}}async subscribe(e,t){var i,o;this.logger.info("subscribe");if(!this._aRecvonlyOfferTpl||!this._vRecvonlyOfferTpl){const e=await this._genOfferSdp();await this.createAVMlineOfferTpl(e)}let r,s,n,a,d="",c="",l=!1,u=!1;e.audioMLine=r,e.videoMLine=s,e.virtual?(d="".concat(this._mid++),l=!0):t.multiChatMode?(d="".concat(this._mid++),c="".concat(this._mid++),u=!0):(l=!0,u=!0,d="".concat(this._mid++),c="".concat(this._mid++)),d&&(r=Fu(Fu({},JN(this._aRecvonlyOfferTpl)),{},{mid:d})),l&&(e.audioMLine=r,n={track:"audio",init:{direction:"recvonly"}}),c&&(s=Fu(Fu({},JN(this._vRecvonlyOfferTpl)),{},{mid:c})),u&&(e.videoMLine=s,a={track:"video",init:{direction:"recvonly"}});const h=jw(this.peer._offerSession,r,s);let _,m;if(!e.enableVendorMode&&!t.multiChatMode&&!e.virtual&&this._aSendonlyAnswerTpl&&this._vSendonlyAnswerTpl){var p;_=Yw(this._nextSsrc),this._nextSsrc=_.next;const t=Fu(Fu(Fu({},this._aSendonlyAnswerTpl),this.peer._answerIce),{},{mid:d,msid:"".concat(e.streamId).concat(this._context.avSync?"":"-audio"," ").concat(e.streamId,"-audio"),ssrcs:Kw(e.streamId,"audio",_.audio)}),i=Fu(Fu(Fu({},this._vSendonlyAnswerTpl),this.peer._answerIce),{},{mid:c,msid:"".concat(e.streamId).concat(this._context.avSync?"":"-video"," ").concat(e.streamId,"-video")},Bw(e.streamId,_,{flexfec:this._enableSubFlexfec}));m={sdp:Aw.write(Fu(Fu({},this.peer._answerSession),{},{media:[t,i]})),sequenceId:e.sequenceId?++e.sequenceId:0},null===(p=_)||void 0===p||delete p.next}const v=null===(i=r)||void 0===i?void 0:i.rtp.find((e=>"opus"===e.codec));if(v&&null!==(o=r)&&void 0!==o&&o.fmtp){var f;const e=null===(f=r)||void 0===f?void 0:f.fmtp.find((e=>e.payload===v.payload));e&&this._context&&(e.config+=";stereo=1;sprop-stereo=1")}if(e.isPublic&&_g>=86){var S,g;const e=null===(S=s)||void 0===S?void 0:S.rtp.filter((e=>"H264"===e.codec));var y;if(null!=e&&e.length&&null!==(g=s)&&void 0!==g&&g.fmtp)null===(y=s)||void 0===y||y.fmtp.forEach((t=>{e.find((e=>e.payload===t.payload))&&(t.config+=";sps-pps-idr-in-keyframe=1")}))}return{partialSdp:h,audioMid:d,videoMid:c,type:"incroffer",semantics:"unified-plan",audioTransceiverInit:n,videoTransceiverInit:a,allSsrc:_,peerConnectionMode:this.peerConnectionMode,signalingAck:m}}async handleAck(e){return this.logger.info("handleAck()","item: %o",e),this._sdpQueue.enqueue(e)}async dequeue(){this._queueBusy=!0;const e=this._sdpQueue.dequeue();if(this.logger.info("dequeue()","ret: %o",e),!e)return void(this._queueBusy=!1);const t=[];try{const{items:_,sdpStrategy:m}=e,p=[],v=[],f=[];if(m===iD.ADD){delete Fu({},this.peer._answerIce).candidates;var i,o=!1,r=!1;try{for(var s,n=function(e){var t,i,o,r=2;for(void 0!==gu&&(i=fO,o=Du);r--;){if(i&&null!=(t=e[i]))return t.call(e);if(o&&null!=(t=e[o]))return new $V(t.call(e));i="@@asyncIterator",o="@@iterator"}throw new TypeError("Object is not async iterable")}(_);o=!(s=await n.next()).done;o=!1){const e=s.value;{var a;const{audioMid:i,videoMid:o,action:r,audioTransceiverInit:s,videoTransceiverInit:n,signalingAck:l,stream:u,videoCodec:h,onSuccess:_,onFail:m}=e,S=u instanceof NN;if(_&&f.push(_),m&&t.push(m),S&&l.sequenceId<u.sequenceId)break;const g=Aw.parse(l.sdp);if(!Array.isArray(g.media))break;TI(a=g.media).call(a,((e,t)=>{var i;return null==e||null===(i=e.type)||void 0===i?void 0:i.localeCompare(null==t?void 0:t.type)}));const y=g.media.find((e=>"audio"===e.type)),b=g.media.find((e=>"video"===e.type));if(!y||!b)break;const T=Fu(Fu(Fu({},y),this.peer._answerIce),{},{mid:i}),I=Fu(Fu(Fu({},b),this.peer._answerIce),{},{mid:o}),{audioMLine:E,videoMLine:R,audioTransceiver:C,videoTransceiver:k}=u;if(E){let e=this.peer._offerMlines.findIndex((e=>e.mid===i));var d;if(C){if(this._reportRtcInvokeStatus("chromeHandler.updateTrack",JSON.stringify({audioStreamTrack:am(null===(d=u.audioTrack)||void 0===d?void 0:d.preprocessingTrack)})),-1===e){this.logger.error("dequeue","audio mid not found when update sdp, %s from %o",i,this.peer._offerMlines);continue}}else s&&E&&(u.audioTransceiver=this._peerConnection.addTransceiver(s.track,s.init),this._reportRtcInvokeStatus("chromeHandler.addTrack",JSON.stringify({audioStreamTrack:am(s.track)})),e=this._inactiveMlineIndex.shift(),e||(e=this.peer._offerMlines.length),aD&&u.initAudioEncodedTransform());r===oD.publish&&"OPUS"!==Qg("AUDIO_CODEC")&&(eO(E,Qg("AUDIO_CODEC")),eO(T,Qg("AUDIO_CODEC"))),this.peer._offerMlines[e]=Fu({},E),this.peer._answerMlines[e]=Fu({},T)}if(R){let e=this.peer._offerMlines.findIndex((e=>e.mid===o));var c;if(k){if(this._reportRtcInvokeStatus("chromeHandler.updateTrack",JSON.stringify({audioStreamTrack:am(null===(c=u.videoTrack)||void 0===c?void 0:c.preprocessingTrack)})),-1===e){this.logger.error("dequeue","video mid not found when update sdp, %s from %o",o,this.peer._offerMlines);continue}}else n&&R&&(u.videoTransceiver=this._peerConnection.addTransceiver(n.track,n.init),this._reportRtcInvokeStatus("chromeHandler.addTrack",JSON.stringify({videoStreamTrack:am(n.track)})),e=this._inactiveMlineIndex.shift(),e||(e=this.peer._offerMlines.length),aD&&u.initVideoEncodedTransform());this.peer._offerMlines[e]=Fu({},R),r===oD.publish&&h&&(tO(R,h),tO(I,h)),this.peer._answerMlines[e]=I}p.push(u.streamId||""),v.push(S?u.userId:"local"),S&&(u.sequenceId=l.sequenceId)}}}catch(u){r=!0,i=u}finally{try{o&&null!=n.return&&await n.return()}finally{if(r)throw i}}}else{var l;const e={};_.forEach((t=>{const{audioMid:i,videoMid:o,action:r}=t;e[i]=i,r!==oD.removetrack&&(e[o]=o),e[i]=i})),this.peer._offerMlines=this.peer._offerMlines.map(((t,i)=>(t.mid&&e[t.mid]&&(t=Jw(t),this._inactiveMlineIndex.push(i)),t))),TI(l=this._inactiveMlineIndex).call(l,((e,t)=>e-t)),this.peer._answerMlines=this.peer._answerMlines.map((t=>(t.mid&&e[t.mid]&&(t=Jw(t)),t)))}try{await this.peer.getOriginRTCPeerConnection().createOffer(),await this.setDescription(p.length?{streamId:p.join(","),streamUserId:v.join(",")}:void 0)}catch(h){throw"have-local-offer"===this._peerConnection.signalingState&&await this._peerConnection.setLocalDescription({type:"rollback"}),h}try{f.forEach((e=>e()))}catch(wZ){}this.logger.info("dequeue","loop")}catch(u){this.logger.error("dequeue","unknown error: %o",u),t.forEach((e=>e(u)))}finally{this.dequeue()}}async getDefaultSdp(){const e=await this._genOfferSdp();this.createAVMlineOfferTpl(e);const t=Aw.parse(e),i=[];return t.media=t.media.filter((e=>"recvonly"===e.direction&&(Array.isArray(e.ext)&&(e.ext=e.ext.filter((e=>"urn:ietf:params:rtp-hdrext:sdes:rtp-stream-id"!==e.uri))),i.push("".concat(e.mid)),!0))),t.groups=[{mids:i.join(" "),type:"BUNDLE"}],cE&&iO(t),{sdp:Aw.write(t),semantics:"unified-plan",type:"incroffer"}}async rollback(e){let{stream:t}=e;delete t.audioMLine,delete t.videoMLine}createAVMlineOfferTpl(e){const t=Aw.parse(e);t.media.forEach((e=>{e.icePwd=this.peer._offerIce.icePwd,e.iceUfrag=this.peer._offerIce.iceUfrag,"audio"===e.type?"sendonly"===e.direction?this._aSendonlyOfferTpl=e:(Array.isArray(e.ext)&&(e.ext=e.ext.filter((e=>"urn:ietf:params:rtp-hdrext:sdes:rtp-stream-id"!==e.uri))),this._aRecvonlyOfferTpl=e):"video"===e.type&&("sendonly"===e.direction?this._vSendonlyOfferTpl=e:(Array.isArray(e.ext)&&(e.ext=e.ext.filter((e=>"urn:ietf:params:rtp-hdrext:sdes:rtp-stream-id"!==e.uri))),this._vRecvonlyOfferTpl=e))})),cE&&iO(t)}async _genOfferSdp(){let e;try{if(e=await async function(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(ib)return ib;const t=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan"});t.createDataChannel("default"),t.addTransceiver("audio",{direction:"recvonly"}),t.addTransceiver("video",{direction:"recvonly"}),e&&(t.addTransceiver("audio",{direction:"sendonly"}),t.addTransceiver("video",{direction:"sendonly"}));const i=await t.createOffer();return t.close(),ib=i.sdp,i.sdp}(!0),!e)throw"pc.createOffer() return empty."}catch(t){const e="Get offer Error. ".concat(t.message|t);throw new Cg(Eg.NOT_SUPPORTED,e)}return e}}class cD extends eD{constructor(e,t){var i;super(e,t),Xu(this,"name","firefox"),Xu(this,"_aRecvonlyOfferTpl",void 0),this.logger=new LS("FirefoxHandler",3,e.id),null===(i=this._context.monitor)||void 0===i||i.set({handler_mode:"firefox"})}async publish(e){var t,i;const{videoDescriptions:o,subVideoDescriptions:r,audioTransceiverInit:s,videoTransceiverInit:n}=super.internalPublish(e);e.audioTransceiver=this._peerConnection.addTransceiver(s.track,s.init),Array.isArray(n.init.sendEncodings)&&1===n.init.sendEncodings.length&&(n.init.sendEncodings=n.init.sendEncodings.map((e=>(delete e.rid,e)))),e.videoTransceiver=this._peerConnection.addTransceiver(n.track,n.init);const a=jy();this._report("rtc_begin_create_offer",{direction:"up",stream_id:"",stream_user_id:"",pc_session_id:this.peerConnectionId,vendor_mode:0});const d=await this.peer.createOfferSdp();this._report("rtc_create_offer",{direction:"up",error_code:0,stream_id:"",stream_user_id:"",elapse:jy()-a});const c=Aw.parse(d);c.media=null===(t=c.media)||void 0===t?void 0:t.map((e=>Fu(Fu({},e),this.peer._offerIce))),iO(c),await this.setLocalDescription(Aw.write(c));const l=e.audioTransceiver.mid,u=e.videoTransceiver.mid;let h=null,_=null;return c.media=null===(i=c.media)||void 0===i?void 0:i.map((e=>{if("".concat(e.mid)===l){var t;h=e;const o=null===(t=h)||void 0===t?void 0:t.rtp.find((e=>"opus"===e.codec));if(o&&h.fmtp){var i;const e=h.fmtp.find((e=>e.payload===o.payload));e&&null!==(i=this._context)&&void 0!==i&&i.audioProfileManager&&(e.config=this._context.audioProfileManager.getOpusConfigStr(e.config))}}else"".concat(e.mid)===u&&(_=e);return e})),this.addBitrateLimit(_,e.videoEncodeConfig[0].maxKbps),await this.setLocalDescription(Aw.write(c)),e.initVideoEncodedTransform(),e.initAudioEncodedTransform(),{partialSdp:jw(c,h,_),audioMid:l,videoMid:u,type:"incroffer",semantics:"unified-plan",videoDescriptions:o,subVideoDescriptions:r,audioTransceiverInit:s,videoTransceiverInit:n,peerConnectionMode:this.peerConnectionMode}}async _internalChangePubCodec(){const{localDescription:e}=this._peerConnection;e&&(await this.peer.createOfferSdp(),await this._peerConnection.setLocalDescription(e))}async subscribe(e,t){var i,o,r,s;this.logger.info("subscribe()");let n,a,d="",c="",l=!1,u=!1;e.virtual?l=!0:(t.multiChatMode||(l=!0),u=!0),l&&(e.audioTransceiver=this._peerConnection.addTransceiver("audio",{direction:"recvonly"})),u&&(e.videoTransceiver=this._peerConnection.addTransceiver("video",{direction:"recvonly"}));const h=jy();this._report("rtc_begin_create_offer",{direction:"up",stream_id:e.streamId,stream_user_id:e.userId,pc_session_id:this.peerConnectionId,vendor_mode:0});const _=await this.peer.createOfferSdp();this._report("rtc_create_offer",{error_code:0,direction:"up",stream_id:e.streamId,stream_user_id:e.userId,elapse:jy()-h});const m=Aw.parse(_);let p,v;if(m.media=null===(i=m.media)||void 0===i?void 0:i.map((e=>Fu(Fu({},e),this.peer._offerIce))),m.media.map((e=>{var t,i,o,r;"video"===e.type&&(dE?(e.ext=null===(t=e.ext)||void 0===t?void 0:t.filter((e=>-1===e.uri.indexOf("abs-send-time"))),e.rtcpFb=null===(i=e.rtcpFb)||void 0===i?void 0:i.filter((e=>"goog-remb"!==e.type))):(e.rtcpFb=null===(o=e.rtcpFb)||void 0===o?void 0:o.filter((e=>"transport-cc"!==e.type)),e.ext=null===(r=e.ext)||void 0===r?void 0:r.filter((e=>-1===e.uri.indexOf("transport")))))})),cE&&iO(m),await this.setLocalDescription(Aw.write(m),{streamId:e.streamId||"",streamUserId:e.userId}),d=null===(o=e.audioTransceiver)||void 0===o?void 0:o.mid,c=null===(r=e.videoTransceiver)||void 0===r?void 0:r.mid,null===(s=m.media)||void 0===s||s.forEach((e=>{"".concat(e.mid)===d?n=e:"".concat(e.mid)===c&&(a=e)})),d&&n||(d="audio_".concat(c),n=Fu(Fu({},this._aRecvonlyOfferTpl),{},{mid:d})),e.audioMid=d,e.videoMid=c,!t.multiChatMode&&!e.virtual&&this._aSendonlyAnswerTpl&&this._aSendonlyAnswerTpl){var f,S,g;p=Yw(this._nextSsrc),this._nextSsrc=p.next;const t=Fu(Fu(Fu({},this._aSendonlyAnswerTpl),this.peer._answerIce),{},{mid:d,msid:"".concat(e.streamId).concat(null!==(f=this._context)&&void 0!==f&&f.avSync?"":"-audio"," ").concat(e.streamId,"-audio"),ssrcs:Kw(e.streamId,"audio",p.audio)}),i=Fu(Fu(Fu({},this._vSendonlyAnswerTpl),this.peer._answerIce),{},{mid:c,msid:"".concat(e.streamId).concat(null!==(S=this._context)&&void 0!==S&&S.avSync?"":"-video"," ").concat(e.streamId,"-video")},Bw(e.streamId,p,{flexfec:this._enableSubFlexfec}));v={sdp:Aw.write(Fu(Fu({},this.peer._answerSession),{},{media:[t,i]})),sequenceId:e.sequenceId?++e.sequenceId:0},null===(g=p)||void 0===g||delete g.next}return e.initVideoEncodedTransform(),e.initAudioEncodedTransform(),{partialSdp:jw(m,n,a,!1),audioMid:d,videoMid:c,type:"incroffer",semantics:"unified-plan",audioTransceiverInit:e.audioTransceiver?{track:"audio",init:{direction:"recvonly"}}:void 0,videoTransceiverInit:e.videoTransceiver?{track:"video",init:{direction:"recvonly"}}:void 0,allSsrc:p,peerConnectionMode:this.peerConnectionMode,signalingAck:v}}async handleAck(e){const{stream:t,action:i}=e;if(i===oD.removetrack)return"";if(i===oD.unpublish||i===oD.unsubscribe){try{await this.close(t),"function"==typeof e.onSuccess&&e.onSuccess()}catch(n){"function"==typeof e.onFail&&e.onFail(n)}return t.streamId||""}const{signalingAck:o,videoCodec:r}=e,s=Aw.parse(o.sdp);try{await this._internalSetRemoteDescription(s.media,t,r),"function"==typeof e.onSuccess&&e.onSuccess()}catch(n){"function"==typeof e.onFail&&e.onFail(n)}return""}async _internalSetRemoteDescription(e,t,i){var o,r;const s={},n=Aw.parse(null===(o=this._peerConnection.remoteDescription)||void 0===o?void 0:o.sdp);n.media.forEach((e=>{void 0!==e.mid&&(s[e.mid]=e)})),e.forEach((e=>{if("audio"===(e=Fu(Fu({},e),this.peer._answerIce)).type&&(t.audioMid?(e.mid=t.audioMid,s[t.audioMid]=e):s[e.mid]=e),"video"===e.type){if(t instanceof PN&&dg<=87){const t={};Array.isArray(e.rtp)&&(e.rtp=e.rtp.filter((e=>"rtx"!==e.codec||(t[e.payload]=e.payload,!1)))),"string"==typeof e.payloads&&(e.payloads=e.payloads.split(" ").filter((e=>!t[e])).join(" ")),Array.isArray(e.fmtp)&&(e.fmtp=e.fmtp.filter((e=>!t[e.payload]))),Array.isArray(e.rtcpFb)&&(e.fmtp=e.fmtp.filter((e=>!t[e.payload])))}i&&tO(e,i),t.videoMid?(e.mid=t.videoMid,s[t.videoMid]=e):s[e.mid]=e}}));const a=Aw.parse(null===(r=this._peerConnection.localDescription)||void 0===r?void 0:r.sdp),d=a.media.map((e=>{const t=s[e.mid];return"inactive"===e.direction?e:t}));n.groups=a.groups,n.media=d,n.media.map((e=>{if("video"===e.type){var t,i,o,r,s;if(dE)e.ext=null===(t=e.ext)||void 0===t?void 0:t.filter((e=>-1===e.uri.indexOf("abs-send-time"))),e.rtcpFb=null===(i=e.rtcpFb)||void 0===i?void 0:i.filter((e=>"goog-remb"!==e.type));else e.rtcpFb=null===(o=e.rtcpFb)||void 0===o?void 0:o.filter((e=>"transport-cc"!==e.type)),e.ext=null===(r=e.ext)||void 0===r?void 0:r.filter((e=>-1===e.uri.indexOf("transport")));if(dg>=138)e.ext=null===(s=e.ext)||void 0===s?void 0:s.filter((e=>!e.uri.includes("sdes:mid")))}})),cE&&iO(n),await this.setRemoteDescription(Aw.write(n))}async getDefaultSdp(){const e=new RTCPeerConnection;e.addTransceiver("audio",{direction:"recvonly"}),e.addTransceiver("video",{direction:"recvonly"});const t=await e.createOffer(),i=Aw.parse(t.sdp);this.createAVMlineOfferTpl(t.sdp);const o=[];return i.media=i.media.filter((e=>{if("recvonly"===e.direction){const t="template_".concat(e.type);return e.mid=t,o.push(t),!0}return!1})),cE&&iO(i),i.groups=[{mids:o.join(" "),type:"BUNDLE"}],e.close(),{sdp:Aw.write(i),semantics:"unified-plan",type:"incroffer"}}async rollback(e){let{msid:t,stream:i,audioMid:o,videoMid:r}=e;return this.logger.warn("rollback()"),this.close(i,o,r)}async close(e,t,i){var o;this.logger.info("close()");const r=e.audioMid||t,s=e.videoMid||i,n={};e.audioTransceiver&&r&&(e.audioTransceiver.stop(),n[r]=r),e.videoTransceiver&&s&&(e.videoTransceiver.stop(),n[s]=s);const a=[],d=await this.peer.createOfferSdp(),c=Aw.parse(d);c.media=c.media.map((e=>(n[e.mid]&&(e=Jw(e)),"inactive"!==e.direction&&a.push(e.mid),Fu(Fu({},e),this.peer._offerIce))));const l=Aw.parse(null===(o=this._peerConnection.remoteDescription)||void 0===o?void 0:o.sdp),u={};l.media.forEach((e=>{void 0!==e.mid&&(u[e.mid]=e)})),l.media=c.media.map((e=>"inactive"===e.direction?e:u[e.mid])),c.groups&&l.groups&&(c.groups[0].mids=a.join(" "),l.groups[0].mids=a.join(" ")),await this.setLocalDescription(Aw.write(c)),await this.setRemoteDescription(Aw.write(l))}async setCurrentDescription(){await this.peer.createOfferSdp(),this._peerConnection.localDescription&&this._peerConnection.remoteDescription&&(await this._peerConnection.setLocalDescription(this._peerConnection.localDescription),await this._peerConnection.setRemoteDescription(this._peerConnection.remoteDescription))}createAVMlineOfferTpl(e){const t=Aw.parse(e);t.media.forEach((e=>{"audio"===e.type&&(this._aRecvonlyOfferTpl=e)})),cE&&iO(t)}}class lD extends eD{constructor(e,t){var i,o;super(e,t),Xu(this,"name","fallback"),Xu(this,"_aRecvonlyOfferTpl",void 0),this.logger=new LS("FallbackHandler",3,e.id),this.logger.warn("ctor","using fallback handler"),null===(i=this._context.monitor)||void 0===i||i.report("rtc_error",{message:"using fallback handler",error_code:-1}),null===(o=this._context.monitor)||void 0===o||o.set({handler_mode:"fallback"})}async publish(e){var t;const{videoDescriptions:i,subVideoDescriptions:o,audioTransceiverInit:r,videoTransceiverInit:s}=super.internalPublish(e);e.audioTransceiver=this._peerConnection.addTransceiver(r.track,r.init),Array.isArray(s.init.sendEncodings)&&1===s.init.sendEncodings.length&&(s.init.sendEncodings=s.init.sendEncodings.map((e=>(delete e.rid,e)))),e.videoTransceiver=this._peerConnection.addTransceiver(s.track,s.init);const n=jy();this._report("rtc_begin_create_offer",{direction:"up",stream_id:"",stream_user_id:"",pc_session_id:this.peerConnectionId,vendor_mode:0});const a=await this.peer.createOfferSdp();this._report("rtc_create_offer",{direction:"up",error_code:0,stream_id:"",stream_user_id:"",elapse:jy()-n});const d=Aw.parse(a);await this.setLocalDescription(a);const c=e.audioTransceiver.mid,l=e.videoTransceiver.mid;let u=null,h=null;return d.media=null===(t=d.media)||void 0===t?void 0:t.map((e=>("".concat(e.mid)===c?u=e:"".concat(e.mid)===l&&(h=e),e))),e.initVideoEncodedTransform(),e.initAudioEncodedTransform(),{partialSdp:jw(d,u,h),audioMid:c,videoMid:l,type:"incroffer",semantics:"unified-plan",videoDescriptions:i,subVideoDescriptions:o,audioTransceiverInit:r,videoTransceiverInit:s,peerConnectionMode:this.peerConnectionMode}}async _internalChangePubCodec(){const{localDescription:e}=this._peerConnection;e&&(await this.peer.createOfferSdp(),await this._peerConnection.setLocalDescription(e))}async subscribe(e,t){var i,o,r;this.logger.info("subscribe()");let s,n,a="",d="",c=!1,l=!1;e.virtual?c=!0:(t.multiChatMode||(c=!0),l=!0),c&&(e.audioTransceiver=this._peerConnection.addTransceiver("audio",{direction:"recvonly"})),l&&(e.videoTransceiver=this._peerConnection.addTransceiver("video",{direction:"recvonly"}));const u=jy();this._report("rtc_begin_create_offer",{direction:"up",stream_id:e.streamId,stream_user_id:e.userId,pc_session_id:this.peerConnectionId,vendor_mode:0});const h=await this.peer.createOfferSdp();this._report("rtc_create_offer",{error_code:0,direction:"up",stream_id:e.streamId,stream_user_id:e.userId,elapse:jy()-u});const _=Aw.parse(h);let m,p;if(await this.setLocalDescription(h,{streamId:e.streamId||"",streamUserId:e.userId}),a=null===(i=e.audioTransceiver)||void 0===i?void 0:i.mid,d=null===(o=e.videoTransceiver)||void 0===o?void 0:o.mid,null===(r=_.media)||void 0===r||r.forEach((e=>{"".concat(e.mid)===a?s=e:"".concat(e.mid)===d&&(n=e)})),a&&s||(a="audio_".concat(d),s=Fu(Fu({},this._aRecvonlyOfferTpl),{},{mid:a})),e.audioMid=a,e.videoMid=d,!t.multiChatMode&&!e.virtual&&this._aSendonlyAnswerTpl&&this._aSendonlyAnswerTpl){var v,f,S;m=Yw(this._nextSsrc),this._nextSsrc=m.next;const t=Fu(Fu(Fu({},this._aSendonlyAnswerTpl),this.peer._answerIce),{},{mid:a,msid:"".concat(e.streamId).concat(null!==(v=this._context)&&void 0!==v&&v.avSync?"":"-audio"," ").concat(e.streamId,"-audio"),ssrcs:Kw(e.streamId,"audio",m.audio)}),i=Fu(Fu(Fu({},this._vSendonlyAnswerTpl),this.peer._answerIce),{},{mid:d,msid:"".concat(e.streamId).concat(null!==(f=this._context)&&void 0!==f&&f.avSync?"":"-video"," ").concat(e.streamId,"-video")},Bw(e.streamId,m,{flexfec:this._enableSubFlexfec}));p={sdp:Aw.write(Fu(Fu({},this.peer._answerSession),{},{media:[t,i]})),sequenceId:e.sequenceId?++e.sequenceId:0},null===(S=m)||void 0===S||delete S.next}return e.initVideoEncodedTransform(),e.initAudioEncodedTransform(),{partialSdp:jw(_,s,n,!1),audioMid:a,videoMid:d,type:"incroffer",semantics:"unified-plan",audioTransceiverInit:e.audioTransceiver?{track:"audio",init:{direction:"recvonly"}}:void 0,videoTransceiverInit:e.videoTransceiver?{track:"video",init:{direction:"recvonly"}}:void 0,allSsrc:m,peerConnectionMode:this.peerConnectionMode,signalingAck:p}}async handleAck(e){const{stream:t,action:i}=e;if(i===oD.removetrack)return"";if(i===oD.unpublish||i===oD.unsubscribe){try{await this.close(t),"function"==typeof e.onSuccess&&e.onSuccess()}catch(n){"function"==typeof e.onFail&&e.onFail(n)}return t.streamId||""}const{signalingAck:o,videoCodec:r}=e,s=Aw.parse(o.sdp);try{await this._internalSetRemoteDescription(s.media,t,r),"function"==typeof e.onSuccess&&e.onSuccess()}catch(n){"function"==typeof e.onFail&&e.onFail(n)}return""}async _internalSetRemoteDescription(e,t,i){var o,r;const s={},n=Aw.parse(null===(o=this._peerConnection.remoteDescription)||void 0===o?void 0:o.sdp);n.media.forEach((e=>{void 0!==e.mid&&(s[e.mid]=e)})),e.forEach((e=>{"audio"===(e=Fu(Fu({},e),this.peer._answerIce)).type&&(t.audioMid?(e.mid=t.audioMid,s[t.audioMid]=e):s[e.mid]=e),"video"===e.type&&(i&&tO(e,i),t.videoMid?(e.mid=t.videoMid,s[t.videoMid]=e):s[e.mid]=e)}));const a=Aw.parse(null===(r=this._peerConnection.localDescription)||void 0===r?void 0:r.sdp),d=a.media.map((e=>{const t=s[e.mid];return"inactive"===e.direction?e:t}));n.groups=a.groups,n.media=d,n.media.map((e=>{var t,i,o,r;"video"===e.type&&(dE?(e.ext=null===(t=e.ext)||void 0===t?void 0:t.filter((e=>-1===e.uri.indexOf("abs-send-time"))),e.rtcpFb=null===(i=e.rtcpFb)||void 0===i?void 0:i.filter((e=>"goog-remb"!==e.type))):(e.rtcpFb=null===(o=e.rtcpFb)||void 0===o?void 0:o.filter((e=>"transport-cc"!==e.type)),e.ext=null===(r=e.ext)||void 0===r?void 0:r.filter((e=>-1===e.uri.indexOf("transport")))))})),await this.setRemoteDescription(Aw.write(n))}async getDefaultSdp(){const e=new RTCPeerConnection;e.addTransceiver("audio",{direction:"recvonly"}),e.addTransceiver("video",{direction:"recvonly"});const t=await e.createOffer(),i=Aw.parse(t.sdp);this.createAVMlineOfferTpl(t.sdp);const o=[];return i.media=i.media.filter((e=>{if("recvonly"===e.direction){const t="template_".concat(e.type);return e.mid=t,o.push(t),!0}return!1})),i.groups=[{mids:o.join(" "),type:"BUNDLE"}],e.close(),{sdp:Aw.write(i),semantics:"unified-plan",type:"incroffer"}}async rollback(e){let{msid:t,stream:i,audioMid:o,videoMid:r}=e;return this.logger.warn("rollback()"),this.close(i,o,r)}async close(e,t,i){var o;this.logger.info("close()");const r=e.audioMid||t,s=e.videoMid||i,n={};e.audioTransceiver&&r&&(e.audioTransceiver.stop(),n[r]=r),e.videoTransceiver&&s&&(e.videoTransceiver.stop(),n[s]=s);const a=[],d=await this.peer.createOfferSdp(),c=Aw.parse(d);c.media=c.media.map((e=>(n[e.mid]&&(e=Jw(e)),"inactive"!==e.direction&&a.push(e.mid),Fu(Fu({},e),this.peer._offerIce))));const l=Aw.parse(null===(o=this._peerConnection.remoteDescription)||void 0===o?void 0:o.sdp),u={};l.media.forEach((e=>{void 0!==e.mid&&(u[e.mid]=e)})),l.media=c.media.map((e=>"inactive"===e.direction?e:u[e.mid])),c.groups&&l.groups&&(c.groups[0].mids=a.join(" "),l.groups[0].mids=a.join(" ")),await this.setLocalDescription(d),await this.setRemoteDescription(Aw.write(l))}async setCurrentDescription(){await this.peer.createOfferSdp(),this._peerConnection.localDescription&&this._peerConnection.remoteDescription&&(await this._peerConnection.setLocalDescription(this._peerConnection.localDescription),await this._peerConnection.setRemoteDescription(this._peerConnection.remoteDescription))}createAVMlineOfferTpl(e){Aw.parse(e).media.forEach((e=>{"audio"===e.type&&(this._aRecvonlyOfferTpl=e)}))}}var uD=Object.defineProperty,hD=Object.getOwnPropertyDescriptor,_D=(e,t,i,o)=>{for(var r,s=o>1?void 0:o?hD(t,i):t,n=e.length-1;n>=0;n--)(r=e[n])&&(s=(o?r(t,i,s):r(s))||s);return o&&s&&uD(t,i,s),s};class mD{constructor(e){Xu(this,"_queue",[]),Xu(this,"_runningTask",[]),Xu(this,"executor",void 0),Xu(this,"busy",!1),this.executor=e}add(e){const{promise:t,resolve:i,reject:o}=gD();return this._queue.push({item:e,resolve:i,reject:o}),this.busy||this._emit(),t}destroy(){[...this._queue,...this._runningTask].forEach((e=>{let{reject:t}=e;t(new Cg(Eg.OPERATION_CANCEL,"queue close"))})),this.busy=!1,this._queue=[]}async _emit(){const e=this._queue;if(this._runningTask=e,this._queue=[],0===e.length)return void(this.busy=!1);const t=e.map((e=>e.item)),i=e.map((e=>e.resolve)),o=e.map((e=>e.reject));try{this.busy=!0;const e=await this.executor(t);i.forEach((t=>t(e)))}catch(r){o.forEach((e=>e(r)))}this._runningTask=[],setTimeout((()=>{this._emit()}))}}function pD(){return sE()||rE()}class vD extends eD{constructor(e,t){var i;super(e,t),Xu(this,"name","standard"),Xu(this,"_applyQueue",new mD(this.apply.bind(this))),Xu(this,"_createQueue",new mD(this.create.bind(this))),Xu(this,"_pqueue",new SD),Xu(this,"_midMap",new Map),Xu(this,"_aRecvonlyOfferTpl",void 0),this.logger=new LS("StandardHandler",3,e.id),this.logger.warn("ctor","using standard handler"),null===(i=this._context.monitor)||void 0===i||i.set({handler_mode:"standard"})}async publish(e){var t;this.logger.info("publish()","streamId: ".concat(e.streamId));const{videoDescriptions:i,subVideoDescriptions:o,audioTransceiverInit:r,videoTransceiverInit:s}=super.internalPublish(e);e.audioTransceiver=this._peerConnection.addTransceiver(r.track,Fu(Fu({},r.init),{},{direction:"sendonly"})),Array.isArray(s.init.sendEncodings)&&1===s.init.sendEncodings.length&&(s.init.sendEncodings=s.init.sendEncodings.map((e=>(delete e.rid,e)))),e.videoTransceiver=this._peerConnection.addTransceiver(s.track,Fu(Fu({},s.init),{},{direction:"sendonly"}));const n=jy();this._report("rtc_begin_create_offer",{direction:"up",stream_id:"",stream_user_id:"",pc_session_id:this.peerConnectionId,vendor_mode:0});const a=await this._createQueue.add();this._report("rtc_create_offer",{direction:"up",error_code:0,stream_id:"",stream_user_id:"",elapse:jy()-n});const d=e.audioTransceiver.mid,c=e.videoTransceiver.mid;dO(0,"Transceiver not return MID after setLocalDescription"),e.audioMid=d,e.videoMid=c;let l=null,u=null;const h=Aw.parse(a);return h.media=null===(t=h.media)||void 0===t?void 0:t.map((e=>("".concat(e.mid)===d?l=e:"".concat(e.mid)===c&&(u=e),e))),pD()&&(e.initVideoEncodedTransform(),e.initAudioEncodedTransform()),{partialSdp:jw(h,l,u),audioMid:d,videoMid:c,type:"incroffer",semantics:"unified-plan",videoDescriptions:i,subVideoDescriptions:o,audioTransceiverInit:r,videoTransceiverInit:s,peerConnectionMode:this.peerConnectionMode}}async subscribe(e,t){var i,o,r,s,n;this.logger.info("subscribe()","streamId: ".concat(e.streamId));let a,d,c=!1,l=!1;e.virtual?c=!0:(t.multiChatMode||(c=!0),l=!0),c&&(e.audioTransceiver=this._peerConnection.addTransceiver("audio",{direction:"recvonly"})),l&&(e.videoTransceiver=this._peerConnection.addTransceiver("video",{direction:"recvonly"}));const u=jy();this._report("rtc_begin_create_offer",{direction:"up",stream_id:e.streamId,stream_user_id:e.userId,pc_session_id:this.peerConnectionId,vendor_mode:0});const h=await this._createQueue.add();this._report("rtc_create_offer",{error_code:0,direction:"up",stream_id:e.streamId,stream_user_id:e.userId,elapse:jy()-u});let _=null!==(i=null===(o=e.audioTransceiver)||void 0===o?void 0:o.mid)&&void 0!==i?i:void 0;const m=null!==(r=null===(s=e.videoTransceiver)||void 0===s?void 0:s.mid)&&void 0!==r?r:void 0,p=Aw.parse(h);let v,f;if(null===(n=p.media)||void 0===n||n.forEach((e=>{"".concat(e.mid)===_?a=e:"".concat(e.mid)===m&&(d=e)})),_&&a||(_="audio_".concat(m),a=Fu(Fu({},this._aRecvonlyOfferTpl),{},{mid:_})),e.audioMid=_,e.videoMid=m,!t.multiChatMode&&!e.virtual&&this._aSendonlyAnswerTpl&&this._aSendonlyAnswerTpl){var S,g,y;v=this._generateAllSsrc();const t=Fu(Fu(Fu({},this._aSendonlyAnswerTpl),this.peer._answerIce),{},{mid:_,msid:"".concat(e.streamId).concat(null!==(S=this._context)&&void 0!==S&&S.avSync?"":"-audio"," ").concat(e.streamId,"-audio"),ssrcs:Kw(e.streamId,"audio",v.audio)}),i=Fu(Fu(Fu({},this._vSendonlyAnswerTpl),this.peer._answerIce),{},{mid:m,msid:"".concat(e.streamId).concat(null!==(g=this._context)&&void 0!==g&&g.avSync?"":"-video"," ").concat(e.streamId,"-video")},Bw(e.streamId,v,{flexfec:this._enableSubFlexfec}));f={sdp:Aw.write(Fu(Fu({},this.peer._answerSession),{},{media:[t,i]})),sequenceId:e.sequenceId?++e.sequenceId:0},null===(y=v)||void 0===y||delete y.next}return pD()&&(e.initVideoEncodedTransform(),e.initAudioEncodedTransform()),{partialSdp:jw(p,a,d,!1),audioMid:_,videoMid:m||"",type:"incroffer",semantics:"unified-plan",audioTransceiverInit:e.audioTransceiver?{track:"audio",init:{direction:"recvonly"}}:void 0,videoTransceiverInit:e.videoTransceiver?{track:"video",init:{direction:"recvonly"}}:void 0,allSsrc:v,peerConnectionMode:this.peerConnectionMode,signalingAck:f}}async handleAck(e){const{stream:t,action:i}=e;if(i===oD.removetrack)return"";if(i===oD.unpublish||i===oD.unsubscribe){try{await this.close(t),"function"==typeof e.onSuccess&&e.onSuccess()}catch(n){"function"==typeof e.onFail&&e.onFail(n)}return t.streamId||""}const{signalingAck:o,videoCodec:r}=e,s=Aw.parse(o.sdp);try{await this._internalSetRemoteDescription(s.media,t,r),"function"==typeof e.onSuccess&&e.onSuccess()}catch(n){"function"==typeof e.onFail&&e.onFail(n)}return""}async _internalSetRemoteDescription(e,t,i){e.forEach((e=>{"audio"===(e=Fu(Fu({},e),this.peer._answerIce)).type&&(t.audioMid?(e.mid=t.audioMid,this._midMap.set(t.audioMid,e)):this._midMap.set(e.mid,e)),"video"===e.type&&(i&&tO(e,i),t.videoMid?(e.mid=t.videoMid,this._midMap.set(t.videoMid,e)):this._midMap.set(e.mid,e))}));t instanceof PN?this.handlePublishAction({stream:t,videoCodec:i}):this.handleSubscribeAction({stream:t}),await this._applyQueue.add()}handlePublishAction(e){var t;const{videoCodec:i,stream:o}=e,r=o.audioMid?this._midMap.get(o.audioMid):void 0,s=o.videoMid?this._midMap.get(o.videoMid):void 0;this._context.pcKillSwitch.sld_rtcpfb_rrtr_add&&cE&&(fD.addRRTR(r),fD.addRRTR(s));const n=null!==(t=this._context.serverConfig)&&void 0!==t&&t.audioRed?"RED":Qg("AUDIO_CODEC");"OPUS"!==n&&r&&eO(r,n),this._context.pcKillSwitch.sld_fmtp_opus_add&&fD.decorateOpusConfig(r,this._context.audioProfileManager),US&&dg<=87&&fD.removeRtxInMLine(s),i&&s&&tO(s,i),this._context.pcKillSwitch.sld_ext_sdesmid_remove&&US&&dg>=138&&fD.removeExtSdesMid(s),this._context.pcKillSwitch.sld_fmtp_bitrate_add&&(o.enableSimulcast||ZS||!s||this.addBitrateLimit(s,o.videoEncodeConfig[0].maxKbps)),US&&fD.selectCC(s,dE?"tcc":"remb"),o.audioMid&&r&&this._midMap.set(o.audioMid,r),o.videoMid&&s&&this._midMap.set(o.videoMid,s)}handleSubscribeAction(e){const{stream:t}=e,i=t.audioMid?this._midMap.get(t.audioMid):void 0,o=t.videoMid?this._midMap.get(t.videoMid):void 0;US||(fD.removeRtpStreamId(i),fD.removeRtpStreamId(o)),this._context.pcKillSwitch.sld_rtcpfb_rrtr_add&&cE&&(fD.addRRTR(i),fD.addRRTR(o)),this._context.pcKillSwitch.sld_fmtp_opus_add&&fD.decorateOpusConfig(i),Qg("IOS_SAFARI_ORIENTATION")||!ZS&&!qS||fD.removeExtVideoOrientation(o),this._context.pcKillSwitch.sld_fmtp_sps_add&&t.isPublic&&WS&&_g>=86&&fD.decorateSpsPpsIdrInKeyframe(o),t.audioMid&&i&&this._midMap.set(t.audioMid,i),t.videoMid&&o&&this._midMap.set(t.videoMid,o)}async getDefaultSdp(){const e=new RTCPeerConnection;e.addTransceiver("audio",{direction:"recvonly"}),e.addTransceiver("video",{direction:"recvonly"});const t=await e.createOffer(),i=Aw.parse(t.sdp);this.createAVMlineOfferTpl(t.sdp);const o=[];return i.media=i.media.filter((e=>{if("recvonly"===e.direction){const t="template_".concat(e.type);return e.mid=t,o.push(t),!0}return!1})),cE&&iO(i),i.groups=[{mids:o.join(" "),type:"BUNDLE"}],e.close(),{sdp:Aw.write(i),semantics:"unified-plan",type:"incroffer"}}async rollback(e){let{msid:t,stream:i,audioMid:o,videoMid:r}=e;return this.logger.warn("rollback()"),this.close(i,o,r)}async close(e,t,i){this.logger.info("close()");const o=e.audioMid||t,r=e.videoMid||i;if(e.audioTransceiver&&o)try{e.audioTransceiver.stop(),delete e.audioTransceiver}catch(a){}if(e.videoTransceiver&&r)try{e.videoTransceiver.stop(),delete e.videoTransceiver}catch(d){}const s=o?this._midMap.get(o):void 0,n=r?this._midMap.get(r):void 0;s&&Jw(s),n&&Jw(n),o&&s&&this._midMap.set(o,s),r&&n&&this._midMap.set(r,n),await this._applyQueue.add()}async setCurrentDescription(){await this._applyQueue.add()}createAVMlineOfferTpl(e){Aw.parse(e).media.forEach((e=>{"audio"===e.type&&(this._aRecvonlyOfferTpl=e)}))}_generateAllSsrc(){const e=Yw(this._nextSsrc);return this._nextSsrc=e.next,e}async create(){this.logger.info("RTCPeerConnection create");const e=await this.peer.createOfferSdp();return dO(0,"RTCPeerConnection not return SDP"),await this.peer.setLocalDescription(e),e}async apply(){this.logger.info("RTCPeerConnection apply");let e=await this.peer.createOfferSdp();dO(0,"RTCPeerConnection not return SDP");const t=Aw.parse(e);e=this.generateOffer(t,e);const i=this.generateAnswer(t);await this.setLocalDescription(e),await this.setRemoteDescription(i)}generateOffer(e,t){let i=!1;return"v1"===this.peer.getIceVersion()&&US&&(e.media=e.media.map((e=>Fu(Fu({},e),this.peer._offerIce))),i=!0),this._context.pcKillSwitch.sld_fmtp_opus_add&&(e.media=e.media.map((e=>{if("audio"===e.type){const t="sendonly"===e.direction;fD.decorateOpusConfig(e,t?this._context.audioProfileManager:void 0)}return e})),i=!0),this._context.pcKillSwitch.sld_rtcpfb_rrtr_add&&(e.media=e.media.map((e=>(!cE||"audio"!==e.type&&"video"!==e.type||fD.addRRTR(e),e))),i=!0),i?Aw.write(e):t}generateAnswer(e){const t=[];return e.media.forEach((e=>{if("application"===e.type){dO(e.mid,"should always have mid in mline");let i=this._midMap.get(e.mid);return i||(i=this.generateDCAnswer(e),this._midMap.set(e.mid,i)),void t.push(Fu({},i))}const i="".concat(e.mid);dO(0,"No MID in offer m-line: ".concat(e));let o=this._midMap.get(i);o||(this.logger.info("generateInactiveAnswerMLine","mid: %o, mLine: %o",e.mid,e),o=this.generateInactiveAnswerMLine(e)),t.push(o)})),this.peer.createAnswerSdp(t,e.groups)}generateInactiveAnswerMLine(e){return Fu(Fu(Fu({},e),this.peer._answerIce),{},{direction:"inactive"})}generateDCAnswer(e){const t=Fu(Fu(Fu({},e),this.peer._answerIce),{},{sctpmap:{sctpmapNumber:5e3,app:"webrtc-datachannel",maxMessageSize:262144}});return US&&(delete t.bundleOnly,t.port=9),t}destroy(){super.destroy(),this._pqueue.destroy(),this._applyQueue.destroy(),this._createQueue.destroy()}}_D([function(e,t,i){const o=i.value;return i.value=async function(){const e=this.logger;e.info("SDP Lock","pending task %o",t);const i=await this._pqueue.enqueue(0);e.info("SDP Lock","running task %o",t);try{for(var r=arguments.length,s=new Array(r),n=0;n<r;n++)s[n]=arguments[n];return await(null==o?void 0:o.apply(this,s))}finally{e.info("SDP Lock","unlocking by task %o",t),i()}},i}],vD.prototype,"create",1),_D([function(e,t,i){const o=i.value;return i.value=async function(){const e=this.logger;e.info("SDP Lock","pending task %o",t);const i=await this._pqueue.enqueue(1);e.info("SDP Lock","running task %o",t);try{for(var r=arguments.length,s=new Array(r),n=0;n<r;n++)s[n]=arguments[n];return await(null==o?void 0:o.apply(this,s))}finally{e.info("SDP Lock","unlocking by task %o",t),i()}},i}],vD.prototype,"apply",1);const fD={decorateOpusConfig(e,t){if(!e)return;const i=null==e?void 0:e.rtp.find((e=>"opus"===e.codec));if(!i||!e.fmtp)return;const o=e.fmtp.find((e=>e.payload===i.payload));o&&(t&&(o.config=t.getOpusConfigStr(o.config)),o.config=yD(o.config))},removeRtxInMLine(e){var t;if(!e)return;const i=[];e.rtp=e.rtp.filter((e=>("rtx"===e.codec&&i.push(e.payload),"rtx"!==e.codec))),e.fmtp=e.fmtp.filter((e=>i.includes(e.payload))),e.payloads=null===(t=e.payloads)||void 0===t?void 0:t.split(" ").filter((e=>!i.includes(parseInt(e)))).join(" ")},removeExtSdesMid(e){var t;e&&(e.ext=null===(t=e.ext)||void 0===t?void 0:t.filter((e=>!e.uri.includes("sdes:mid"))))},selectCC(e,t){var i,o;if(e)if("tcc"===t)e.ext=null===(i=e.ext)||void 0===i?void 0:i.filter((e=>-1===e.uri.indexOf("abs-send-time"))),e.rtcpFb=null===(o=e.rtcpFb)||void 0===o?void 0:o.filter((e=>"goog-remb"!==e.type));else if("remb"===t){var r,s;e.rtcpFb=null===(r=e.rtcpFb)||void 0===r?void 0:r.filter((e=>"transport-cc"!==e.type)),e.ext=null===(s=e.ext)||void 0===s?void 0:s.filter((e=>-1===e.uri.indexOf("transport")))}},addRRTR(e){e&&e.rtp.forEach((t=>{e.rtcpFb||(e.rtcpFb=[]),e.rtcpFb.find((e=>e.payload===t.payload&&"rrtr"===e.type))||e.rtcpFb.push({payload:t.payload,type:"rrtr"})}))},removeRtpStreamId(e){e&&Array.isArray(e.ext)&&(e.ext=e.ext.filter((e=>"urn:ietf:params:rtp-hdrext:sdes:rtp-stream-id"!==e.uri)))},decorateSpsPpsIdrInKeyframe(e){if(!e)return;const t=e.rtp.filter((e=>"H264"===e.codec));t.length&&e.fmtp&&e.fmtp.forEach((e=>{t.find((t=>t.payload===e.payload))&&(e.config+=";sps-pps-idr-in-keyframe=1")}))},removeExtVideoOrientation(e){e&&Array.isArray(e.ext)&&(e.ext=e.ext.filter((e=>!e.uri.includes("video-orientation"))))},removeExtFramemarking(e){e&&Array.isArray(e.ext)&&(e.ext=e.ext.filter((e=>!e.uri.includes("framemarking"))))}};class SD{constructor(){Xu(this,"queue",[]),Xu(this,"processing",!1)}async enqueue(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;const{promise:t,resolve:i}=gD(),o={priority:e,resolve:i},r=this.queue.findIndex((t=>t.priority>e));return-1===r?this.queue.push(o):this.queue.splice(r,0,o),this.tryProcess(),await t,this.processing=!0,()=>{this.processing=!1,this.tryProcess()}}destroy(){this.queue.forEach((e=>{let{resolve:t}=e;t()})),this.queue=[],this.processing=!1}tryProcess(){if(this.processing)return;const e=this.queue.shift();e&&e.resolve()}}function gD(){let e,t;const i=new Promise(((i,o)=>{e=i,t=o}));if(!e||!t)throw Error("Broken Implement of Promise");return{promise:i,resolve:e,reject:t}}const yD=e=>{const t={};return e.split(";").forEach((e=>{const[i,o]=e.split("=");i&&o&&(t[i]=o)})),t["sprop-stereo"]=1,t.stereo=1,Object.keys(t).map((e=>"".concat(e,"=").concat(t[e]))).join(";")},bD={[pO.ICE_FAILED]:oh.ICE_FAILED,[pO.DC_ERROR]:oh.ICE_FAILED,[pO.DC_CLOSE]:oh.ICE_FAILED,[pO.NODE_CHANGE]:oh.NODE_CHANGE,[pO.NOTIFY_RECONNECT]:oh.NOTIFY_RECONNECT,[pO.JOIN_TIMEOUT]:oh.JOIN_TIMEOUT};class TD extends kI{constructor(e){super(),Xu(this,"_connectionManager",void 0),Xu(this,"_dataChannelSignal",void 0),Xu(this,"_state",void 0),Xu(this,"_connectionLostTimer",void 0),Xu(this,"_isReconnecting",!1),Xu(this,"logger",void 0),this._ctx=e,this.logger=new LS("SignalingManager",1,e.id),this.logger.info("constructor","invoke"),this._connectionManager=new vO(e),this._addConnectorHandler()}connect(){return this.isConnected()?Promise.resolve():new Promise(((e,t)=>{this._connectionManager.once("connected",(()=>e())),this._connectionManager.once("disconnected",t),this._connectionManager.startup()}))}reconnect(e,t){this._connectionManager.reconnect(e,t)}sendSignaling(e,t,i,o){if(!this._dataChannelSignal)throw new Cg(Eg.NOT_CONNECTED_YET,"signaling channel is not connected");return this._dataChannelSignal.sendSignaling(e,t,i,o)}sendP2PMessage(e,t){if(!this._dataChannelSignal)throw new Cg(Eg.NOT_CONNECTED_YET,"signaling channel is not connected");return this._dataChannelSignal.sendP2PMessage(e,t)}destroy(){var e,t;this.logger.info("destroy()"),this._clearConnectionLostTimer(),this._connectionManager.shotdown(),null===(e=this._ctx.handler)||void 0===e||e.destroy(),this._ctx.handler=void 0,null===(t=this._dataChannelSignal)||void 0===t||t.destroy(),this._state&&this._setState(ih.CONNECTION_STATE_DISCONNECTED),this.removeAllListeners()}isConnected(){return this._state===ih.CONNECTION_STATE_CONNECTED||this._state===ih.CONNECTION_STATE_RECONNECTED}isReconnecting(){return this._state===ih.CONNECTION_STATE_CONNECTING||this._state===ih.CONNECTION_STATE_RECONNECTING}_setState(e,t){if(this._state===e)return;this._state=e;const i={state:e};t&&(i.reason=bD[t]||oh.ICE_FAILED),this.safeEmit(LI.ON_CONNECTION_STATE_CHANGE,i)}_addConnectorHandler(){var e=this;this._connectionManager.on("connected",(e=>{var t,i,o;this.logger.info("connectStateChange","connected"),this._clearConnectionLostTimer(),null===(t=this._dataChannelSignal)||void 0===t||t.destroy(),this._ctx.peerConnection=e.pc,this._ctx.handler=(i=this._ctx,o=e.pc,i.enableFallbackHandler?new lD(i,o):i.enableStandardHandler?new vD(i,o):US?new cD(i,o):new dD(i,o)),this._dataChannelSignal=e.signaling,this._addSignalEventHandler(),this._setState(this._isReconnecting?ih.CONNECTION_STATE_RECONNECTED:ih.CONNECTION_STATE_CONNECTED)})),this._connectionManager.on("disconnected",(e=>{this._clearConnectionLostTimer(),this._setState(ih.CONNECTION_STATE_DISCONNECTED),this.logger.error("connectStateChange","disconnected. %o",e.message),this._isReconnecting&&this.safeEmit(LI.ON_RECONNECT_FAILED)})),this._connectionManager.on("connecting",(()=>{this._isReconnecting=!1,this._ctx.handler=void 0,this._setState(ih.CONNECTION_STATE_CONNECTING),this.logger.info("connectStateChange","connecting")})),this._connectionManager.on("reconnecting",(e=>{this._setState(ih.CONNECTION_STATE_DISCONNECTED,e),this._connectionLostTimer||(this._connectionLostTimer=setTimeout((()=>{this.safeEmit(LI.ON_CONNECTION_STATE_CHANGE,{state:ih.CONNECTION_STATE_LOST})}),1e4)),this._isReconnecting=!0,this._ctx.handler=void 0,this._setState(ih.CONNECTION_STATE_RECONNECTING,e),this.logger.warn("connectStateChange","reconnecting")})),this._connectionManager.on("connectWidthTcp",(()=>{this.safeEmit(LI.CONNECT_WITH_TCP)})),["__onGetIceConfigHook","__onIceConnectSuccessHook","__onConnectSuccessHook"].forEach((t=>{this._connectionManager.on(t,(function(){for(var i=arguments.length,o=new Array(i),r=0;r<i;r++)o[r]=arguments[r];return e.emit(t,...o)}))}))}_clearConnectionLostTimer(){this._connectionLostTimer&&(clearTimeout(this._connectionLostTimer),delete this._connectionLostTimer)}_addSignalEventHandler(){var e,t;[OI.ON_ADD_STREAM,OI.ON_ADD_STREAM_LIST,OI.ON_REMOVE_STREAM,OI.ON_REMOVE_STREAM_LIST,OI.USER_CONNECTION,OI.USER_CONNECTION_LIST,OI.USER_DISCONNECTION,OI.USER_DISCONNECTION_LIST,OI.ON_UPDATE_STREAM_ATTRIBUTES,OI.ON_UPDATE_ROOM_ATTRIBUTES,OI.ON_PUSH_TRACK,OI.ON_REMOVE_TRACK,OI.ON_CUSTOM_MESSAGE,OI.USER_MESSAGE_RECEIVED_OUTSIDE_ROOM,OI.USER_BINARY_MESSAGE_RECEIVED_OUTSIDE_ROOM,OI.USER_MESSAGE_RECEIVED,OI.USER_BINARY_MESSAGE_RECEIVED,OI.POST_PROCESSING_MESSAGE,OI.ON_USER_TOKEN_WILL_EXPIRE,OI.ON_TOKEN_PUBLISH_PRIVILEGE_WILL_EXPIRE,OI.ON_TOKEN_PUBLISH_PRIVILEGE_DID_EXPIRED,OI.ON_TOKEN_SUBSCRIBE_PRIVILEGE_WILL_EXPIRE,OI.ON_TOKEN_SUBSCRIBE_PRIVILEGE_DID_EXPIRED,OI.STREAM_CONTROL_MESSAGE,OI.ENGINE_CONTROL_MESSAGE,OI.ON_UPDATE_USER_ATTRIBUTES,OI.ON_SPEAKER_CHANGE,OI.ON_STREAM_FAILED,OI.ON_FORWARD_DST_ROOM_USER_KICK,OI.ON_STREAM_PULL_STATE_CHANGED,OI.ON_STREAM_PUSHED_BY_OTHER,MI.RSCP,MI.RTT,MI.SSC].forEach((e=>{var t;null===(t=this._dataChannelSignal)||void 0===t||t.on(e,(t=>{this.safeEmit(e,t)}))})),null===(e=this._dataChannelSignal)||void 0===e||e.on(OI.NODE_CHANGE,(e=>{this._connectionManager.reconnectByNodeChange(e)})),null===(t=this._dataChannelSignal)||void 0===t||t.on(OI.ON_NOTIFY_RECONNECT,(()=>{this._connectionManager.reconnect(pO.NOTIFY_RECONNECT)}))}}var ID=(e=>(e.NORMAL_USER="normalUser",e.SILENT_USER="silentUser",e))(ID||{});const ED=["preferCodecName"];class RD{constructor(e){Xu(this,"_captureDeviceId",void 0),Xu(this,"_contentHint",void 0),Xu(this,"_videoCaptureConf",Fu({},iy)),Xu(this,"_mainPreferCodec",void 0),Xu(this,"_screenPreferCodec",void 0),Xu(this,"_remoteVideoConfig",new Map),Xu(this,"_remoteSimulcastStreamType",new Map),Xu(this,"_simulcastMode",Ch.VIDEO_ONLY_ONE),Xu(this,"_highVideoEncodeConf",yw(iy)),Xu(this,"_midVideoEncodeConf",void 0),Xu(this,"_lowVideoEncodeConf",void 0),Xu(this,"_screenEncodeConfig",oy),Xu(this,"_invalidVideoEncodeConf",void 0),Xu(this,"activeSimStreams",[]),Xu(this,"_logger",void 0),Xu(this,"_apiVersion",void 0),this._ctx=e,this._logger=new LS("EngineVideoProfile",1,e.id)}setCaptureDeviceId(e){this._captureDeviceId=e}setCaptureConfig(e){this._videoCaptureConf=Fu(Fu({},this._videoCaptureConf),e)}getCaptureConfig(e){e=e||this._captureDeviceId;const t=Fu({},this._videoCaptureConf);return"user"===e||"environment"===e||"left"===e||"right"===e?(delete t.deviceId,t.facingMode=e):e&&(!KS||qS?t.deviceId={exact:e}:delete t.deviceId),t}getContentHint(){return this._contentHint}getPreferCodec(e){return e?this._screenPreferCodec:this._mainPreferCodec}setRemoteUserVideoConfig(e,t){"object"==typeof t?this._remoteVideoConfig.set(e,t):this._remoteSimulcastStreamType.set(e,t)}getSubLayer(e,t){const i=this._remoteSimulcastStreamType.get(e.userId),o=this._remoteVideoConfig.get(e.userId);if(i){var r,s,n,a,d,c;const{videoDescriptions:t,subVideoDescriptions:o}=e.attributes||{},l=Array.isArray(o)?o:t;let u;return 1===l.length?u=0:2===l.length?u=i===kh.VIDEO_STREAM_HIGH?0:1:l.length>=3&&(u={[kh.VIDEO_STREAM_HIGH]:0,[kh.VIDEO_STREAM_MID]:1,[kh.VIDEO_STREAM_LOW]:2}[i]),{spatialLayer:null!==(r=null!==(s=u&&(null===(n=l[u])||void 0===n?void 0:n.video_index))&&void 0!==s?s:u)&&void 0!==r?r:0,spatialSubLayer:null!==(a=null!==(d=u&&(null===(c=l[u])||void 0===c?void 0:c.sub_index))&&void 0!==d?d:u)&&void 0!==a?a:-1}}return o?gw(o,e):t?gw(t,e):void 0}getSimulcastMode(){return this._simulcastMode}async setSimulcastMode(e,t){if(US||BS||14===(null==lg?void 0:lg[0]))throw new Cg(Eg.NOT_SUPPORTED,"Simulcast is not supported");if(this._simulcastMode!==e){if(null!=t&&t.hasPublished){var i,o;if(null!==(i=t.localStream)&&void 0!==i&&i.videoHasPublish||null!==(o=t.localStream)&&void 0!==o&&o.audioHasPublish)throw new Cg(Eg.SET_SIMULCAST_FAILED,"Cannot change simulcast mode after publishing the video streams");this._logger.print("setSimulcastMode()","change simulcast mode and unpublish."),await t.unpublish()}this._simulcastMode=e,e!==Ch.VIDEO_ONLY_ONE&&this._autoGenerateSubVideoEncodeConfig()}}closeSimulcast(){this._simulcastMode=Ch.VIDEO_ONLY_ONE}async setVideoEncodeConfigPolyfill(e){if(Array.isArray(e)){Gg(e);const[t,...i]=e;this.setVideoEncodeConfig(t),await this.setSubVideoEncodeConfig(Hh(i).call(i))}else this.setVideoEncodeConfig(e)}setVideoEncodeConfig(e){Gg([e]);const t=this._midVideoEncodeConf||this._lowVideoEncodeConf;t&&bw(t)>=bw(e)?(this._logger.warn("setVideoEncodeConfig","smaller then substream"),this._invalidVideoEncodeConf=yw(e),e=t):delete this._invalidVideoEncodeConf;const i=Fu({},e),{preferCodecName:o}=i,r=kf(i,ED);xg(r),this._logger.print("setVideoEncodeConfig","update encode config",e),this._highVideoEncodeConf=yw(e),this._contentHint=r.contentHint,this._mainPreferCodec=o,this._logger.print("setVideoEncodeConfig","update capture config",r),this._videoCaptureConf=r}async setSubVideoEncodeConfig(e,t,i){if(this._logger.print("setSubVideoEncodeConfig","%o, published=%s",e,null==t?void 0:t.hasPublished),e&&e.length>0){Gg(e),TI(e).call(e,((e,t)=>bw(e)-bw(t)));const s=this._invalidVideoEncodeConf||this._highVideoEncodeConf,n=e[e.length-1];if(bw(n)>=bw(s))throw new Cg(Eg.SET_SIMULCAST_FAILED,"The resolution cannot exceed the mainstream");if(null!=t&&t.hasPublished&&e.length!==this._getSubLayers().length){var o,r;if(null!==(o=t.localStream)&&void 0!==o&&o.videoHasPublish||null!==(r=t.localStream)&&void 0!==r&&r.audioHasPublish)throw new Cg(Eg.SET_SIMULCAST_FAILED,"Cannot change the number of substreams after publishing the video streams");await t.unpublish()}e.length>2&&(fS(this._ctx.id,"simulcast_over_limit","setLocalSimulcastMode: You can set parameters for up to 2 streams"),cb("setLocalSimulcastMode: You can set parameters for up to 2 streams"));const[a,d]=e;a&&(Tw(s,a),this._lowVideoEncodeConf=yw(a)),d&&(Tw(s,d),this._midVideoEncodeConf=yw(d)),this._invalidVideoEncodeConf&&(this.setVideoEncodeConfig(this._invalidVideoEncodeConf),await(null==i?void 0:i.updateVideoCaptureConfig(this._ctx.videoProfile.getCaptureConfig())))}else this._autoGenerateSubVideoEncodeConfig()}genVideoDescriptions(e){var t,i;const o=[];let r=[];const s=[],n=[];let{width:a,height:d,frameRate:c,maxKbps:l}=e.videoEncodeConfig[0];a=lb(a),d=lb(d);const u=null===(t=e.videoTrack)||void 0===t?void 0:t.preprocessingTrack,{width:h,height:_,frameRate:m}=null!==(i=null==u?void 0:u.getSettings())&&void 0!==i?i:{};h&&(a=Math.floor(h)),_&&(d=Math.floor(_)),m&&(c=Math.floor(m)),("number"!=typeof c||Number.isNaN(c))&&(c=30),o.push({width:a,height:d,framerate:c,maxkbps:l,rid:"0"}),s.unshift({maxBitrate:1e3*l,rid:"0",maxFramerate:c});const{serverConfig:p}=this._ctx;if(!(e.isScreen||this._simulcastMode===Ch.VIDEO_ONLY_ONE||US&&"VP8"!==(null==p?void 0:p.videoCodec))){const e=((e,t)=>{const i=fw.findIndex((i=>e*t>=i.totalPixels)),o=e*t;if(0===i)return fw[i].maxLayers;const r=fw[i-1].totalPixels;return(r-o)/(r-fw[i].totalPixels)<.1?fw[i-1].maxLayers:fw[i].maxLayers})(a,d);if(e>1){const t=this._getSubVideoEncodeConfig(e,{width:a,height:d});this._logger.info("simulcast() ","simulcastLayers: %o",t),n.push(!0),t.forEach(((e,t)=>{const i={maxBitrate:1e3*e.maxkbps,scaleResolutionDownBy:e.scaleResolutionDownBy,rid:"".concat(t+1),maxFramerate:e.frameRate};s.unshift(i),o.push({width:e.width,height:e.height,framerate:e.frameRate,maxkbps:e.maxkbps,rid:"".concat(t+1)}),n.push(!0)})),null!=p&&p.simulcastOnDemand&&(r=o.map(((e,t)=>Fu(Fu({},e),{},{video_index:t,sub_index:t}))))}}return null!=p&&p.e2eFeedback&&(r=o.map(((e,t)=>Fu(Fu({},e),{},{video_index:t,sub_index:t})))),{videoDescriptions:o,subVideoDescriptions:r,sendEncodings:s,activeSimulcastStreams:n}}getVideoEncodeConfig(){return[this._highVideoEncodeConf,this._midVideoEncodeConf,this._lowVideoEncodeConf].filter((e=>e))}setScreenEncodeConfig(e){this._screenEncodeConfig=e}getScreenEncodeConfig(){return this._screenEncodeConfig}checkSimulcastApiVersion(e){if(this._apiVersion){if(this._apiVersion!==e){const e="mixing old and new apis, please use ".concat("new"===this._apiVersion?"setLocalSimulcastMode/setRemoteSimulcastStreamType":"enableSimulcastMode/setRemoteVideoConfig"," instead.");throw fS(this._ctx.id,"mixingOldAndNewApis",e),new Cg(Eg.MIXING_OLD_AND_NEW_APIS,e)}}else this._apiVersion=e}destroy(){this._videoCaptureConf=iy,this._highVideoEncodeConf=yw(iy),delete this._invalidVideoEncodeConf,this._remoteVideoConfig.clear(),this._remoteSimulcastStreamType.clear()}_autoGenerateSubVideoEncodeConfig(){this._logger.print("_autoGenerateSubVideoEncodeConfig()","generate low stream.");const e=this._highVideoEncodeConf,t=lb(e.width),i=lb(e.height),o=Math.min(t,i)/90;this._lowVideoEncodeConf={width:Math.floor(t/o),height:Math.floor(i/o),maxKbps:100,frameRate:10}}_getSubLayers(){const e=[];return this._midVideoEncodeConf&&e.push(this._midVideoEncodeConf),this._lowVideoEncodeConf&&e.push(this._lowVideoEncodeConf),e}_getSubVideoEncodeConfig(e,t){return this._getSubLayers().slice(1-e).map((e=>{if(e.width>e.height&&t.width<t.height||e.width<e.height&&t.width>t.height){const t=e.width;e.width=e.height,e.height=t}const i=lb(e.width),o=lb(e.height),r=Math.max(t.width/i,t.height/o);return{width:Math.floor(t.width/r),height:Math.floor(t.height/r),scaleResolutionDownBy:r,frameRate:lb(e.frameRate)||15,maxkbps:e.maxKbps||600}}))}__autoResetVideoEncoderConfig(e){const t=ty(this.getVideoEncodeConfig(),e);t&&(this.setVideoEncodeConfigPolyfill(t),this._logger.print("autoResetVideoEncoderConfig() result",JSON.stringify(t)),fS(this._ctx.id,"autoResetVideoEncoderConfig",JSON.stringify(t)))}}class CD{constructor(e){Xu(this,"_sendTimes",[]),Xu(this,"_bufferSizeLimit",void 0),Xu(this,"_totalSizeLimitPerSecond",void 0),Xu(this,"_limitModeInterval",void 0),Xu(this,"_limitModeQPS",void 0),Xu(this,"_interval",void 0),Xu(this,"_qps",void 0),this.setLimitMode(e)}setLimitMode(e){e===DI.LIMIT_MODE?(this._bufferSizeLimit=1,this._totalSizeLimitPerSecond=30720,this._limitModeInterval=1e3,this._limitModeQPS=60):(this._bufferSizeLimit=64,delete this._totalSizeLimitPerSecond,delete this._limitModeInterval,delete this._limitModeQPS)}setQPS(e,t){this._interval=e,this._qps=t}check(e){var t,i;const o=Date.now(),r=function(e){var t,i;let o,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:64;if(!e||0===(null==e?void 0:e.byteLength))throw new Cg(Eg.INVALID_PARAMS,"The message cannot be empty");if(e instanceof ArrayBuffer)o=e;else{if("string"!=typeof e)throw new Cg(Eg.INVALID_PARAMS,"The message must be string or ArrayBuffer");o=Qy.str2ab(e)}if((null===(t=o)||void 0===t?void 0:t.byteLength)>1024*r)throw new Cg(Eg.INVALID_PARAMS,"The message length must be less than ".concat(r,"KB"));return null!==(i=o.byteLength)&&void 0!==i?i:0}(e,this._bufferSizeLimit);if("number"==typeof this._totalSizeLimitPerSecond){if(this._sendTimes.reduce(((e,t)=>o-t.ts<1e3?e+t.size:e),0)+r>this._totalSizeLimitPerSecond)throw new Cg(Eg.USER_MESSAGE_EXCEED_QPS,"user message exceed total size(".concat(this._totalSizeLimitPerSecond,")"))}const s=null!==(t=this._limitModeInterval)&&void 0!==t?t:this._interval,n=null!==(i=this._limitModeQPS)&&void 0!==i?i:this._qps;if("number"==typeof s&&"number"==typeof n)if(this._sendTimes.length<n)this._sendTimes.push({ts:o,size:r});else{if(o-this._sendTimes[0].ts<s)throw new Cg(Eg.USER_MESSAGE_EXCEED_QPS,"user message exceed qps(".concat(n,")"));this._sendTimes.splice(0,1),this._sendTimes.push({ts:o,size:r})}}}const kD="IWZ1bmN0aW9uKCl7InVzZSBzdHJpY3QiO2NvbnN0IHQ9e2dldE5BTFVuaXRzKGUpe2xldCByPWFyZ3VtZW50cy5sZW5ndGg+MSYmdm9pZCAwIT09YXJndW1lbnRzWzFdJiZhcmd1bWVudHNbMV07aWYoZS5sZW5ndGgtZS5wb3NpdGlvbjw0KXJldHVybltdO2NvbnN0e3Bvc2l0aW9uOm59PWU7cmV0dXJuIDE9PT1lLmdldEludDMyKG4pfHwwPT09ZS5nZXRJbnQxNihuKSYmMT09PWUuZ2V0SW50OChuKzIpP3QuZ2V0QW5uZXhiTmFscyhlLHIpOnQuZ2V0QXZjY05hbHMoZSxyKX0sZ2V0QW5uZXhiTmFscyhlLHIpe2NvbnN0IG49W107bGV0IG89dC5nZXRIZWFkZXJQb3NpdGlvbkFubmV4QihlKSxpPW8ucG9zLGE9aTtmb3IoO2k8ZS5sZW5ndGgtNDspe2NvbnN0IHU9bmV3IFVpbnQ4QXJyYXkoZS5idWZmZXIuc2xpY2UoaSxpK28uaGVhZGVyTGVuZ3RoKSk7by5wb3M9PT1lLnBvc2l0aW9uJiZlLnNraXAoby5oZWFkZXJMZW5ndGgpLG89dC5nZXRIZWFkZXJQb3NpdGlvbkFubmV4QihlKSxhPW8ucG9zO2NvbnN0IGM9e2hlYWRlcjp1LGJvZHk6bmV3IFVpbnQ4QXJyYXkoZS5idWZmZXIuc2xpY2UoaSt1LmJ5dGVMZW5ndGgsYSkpLHR5cGU6LTF9O3I/dC5hbmFseXNlSDI2NU5hbChjKTp0LmFuYWx5c2VOYWwoYyksKGMudHlwZTw9OXx8ciYmYy50eXBlPD00MCkmJjAhPT1jLnR5cGUmJm4ucHVzaChjKSxlLnNraXAoYS1lLnBvc2l0aW9uKSxpPWF9cmV0dXJuIG59LGdldEF2Y2NOYWxzKGUscil7Y29uc3Qgbj1bXTtmb3IoO2UucG9zaXRpb248ZS5sZW5ndGgtNDspe2NvbnN0IG89ZS5nZXRJbnQzMihlLnBvc2l0aW9uKTtpZighKGUubGVuZ3RoLWUucG9zaXRpb24+PW8pKWJyZWFrO3tjb25zdCBpPW5ldyBVaW50OEFycmF5KGUuYnVmZmVyLnNsaWNlKGUucG9zaXRpb24sZS5wb3NpdGlvbis0KSk7ZS5za2lwKDQpO2NvbnN0IGE9bmV3IFVpbnQ4QXJyYXkoZS5idWZmZXIuc2xpY2UoZS5wb3NpdGlvbixlLnBvc2l0aW9uK28pKTtlLnNraXAobyk7Y29uc3QgdT17aGVhZGVyOmksYm9keTphLHR5cGU6LTF9O3I/dC5hbmFseXNlSDI2NU5hbCh1KTp0LmFuYWx5c2VOYWwodSksdS50eXBlPD05JiYwIT09dS50eXBlJiZuLnB1c2godSl9fXJldHVybiBufSxhbmFseXNlTmFsKHQpe2NvbnN0IGU9MzEmdC5ib2R5WzBdO3N3aXRjaCh0LnR5cGU9ZSxlKXtjYXNlIDE6dC5uZHI9ITA7YnJlYWs7Y2FzZSA1OnQuaWRyPSEwO2JyZWFrO2Nhc2UgNjp0LnNlaT0hMDticmVhaztjYXNlIDc6dC5zcHM9ITA7YnJlYWs7Y2FzZSA4OnQucHBzPSEwfX0sYW5hbHlzZUgyNjVOYWwodCl7Y29uc3QgZT0oMTI2JnQuYm9keVswXSk+PjE7c3dpdGNoKHQudHlwZT1lLGUpe2Nhc2UgMzk6Y2FzZSA0MDp0LnNlaT0hMH19LGdldEhlYWRlclBvc2l0aW9uQW5uZXhCKHQpe2xldCBlPXQucG9zaXRpb24scj0wO2NvbnN0IG49dC5sZW5ndGg7Zm9yKDszIT09ciYmNCE9PXImJmU8bi00OykwPT09dC5nZXRJbnQxNihlKT8xPT09dC5nZXRJbnQxNihlKzIpP3I9NDoxPT09dC5nZXRJbnQ4KGUrMik/cj0zOmUrKzplKys7cmV0dXJuIGU9PT1uLTQmJigwPT09dC5nZXRJbnQxNihlKT8xPT09dC5nZXRJbnQxNihlKzIpP3I9NDplPW46KGUrKywwPT09dC5nZXRJbnQxNihlKSYmMT09PXQuZ2V0SW50OChlKT9yPTM6ZT1uKSkse3BvczplLGhlYWRlckxlbmd0aDpyfX0saXNIMjY1VmlkZW9GcmFtZSh0KXt2YXIgZTtyZXR1cm4oKG51bGw9PT0oZT10LmdldE1ldGFkYXRhKXx8dm9pZCAwPT09ZXx8bnVsbD09PShlPWUuY2FsbCh0KSl8fHZvaWQgMD09PWU/dm9pZCAwOmUubWltZVR5cGUpfHwiIikudG9Mb3dlckNhc2UoKS5pbmNsdWRlcygiaDI2NSIpfX07dmFyIGU9InVuZGVmaW5lZCIhPXR5cGVvZiBnbG9iYWxUaGlzP2dsb2JhbFRoaXM6InVuZGVmaW5lZCIhPXR5cGVvZiB3aW5kb3c/d2luZG93OiJ1bmRlZmluZWQiIT10eXBlb2YgZ2xvYmFsP2dsb2JhbDoidW5kZWZpbmVkIiE9dHlwZW9mIHNlbGY/c2VsZjp7fTtmdW5jdGlvbiByKHQpe3JldHVybiB0JiZ0Ll9fZXNNb2R1bGUmJk9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbCh0LCJkZWZhdWx0Iik/dC5kZWZhdWx0OnR9dmFyIG49e2V4cG9ydHM6e319LG89ZnVuY3Rpb24odCl7cmV0dXJuIHQmJnQuTWF0aD09PU1hdGgmJnR9LGk9bygib2JqZWN0Ij09dHlwZW9mIGdsb2JhbFRoaXMmJmdsb2JhbFRoaXMpfHxvKCJvYmplY3QiPT10eXBlb2Ygd2luZG93JiZ3aW5kb3cpfHxvKCJvYmplY3QiPT10eXBlb2Ygc2VsZiYmc2VsZil8fG8oIm9iamVjdCI9PXR5cGVvZiBlJiZlKXx8bygib2JqZWN0Ij09dHlwZW9mIGUmJmUpfHxmdW5jdGlvbigpe3JldHVybiB0aGlzfSgpfHxGdW5jdGlvbigicmV0dXJuIHRoaXMiKSgpLGE9ZnVuY3Rpb24odCl7dHJ5e3JldHVybiEhdCgpfWNhdGNoKGUpe3JldHVybiEwfX0sdT0hYSgoZnVuY3Rpb24oKXt2YXIgdD1mdW5jdGlvbigpe30uYmluZCgpO3JldHVybiJmdW5jdGlvbiIhPXR5cGVvZiB0fHx0Lmhhc093blByb3BlcnR5KCJwcm90b3R5cGUiKX0pKSxjPXUscz1GdW5jdGlvbi5wcm90b3R5cGUsZj1zLmFwcGx5LGw9cy5jYWxsLHA9Im9iamVjdCI9PXR5cGVvZiBSZWZsZWN0JiZSZWZsZWN0LmFwcGx5fHwoYz9sLmJpbmQoZik6ZnVuY3Rpb24oKXtyZXR1cm4gbC5hcHBseShmLGFyZ3VtZW50cyl9KSx5PXUsZD1GdW5jdGlvbi5wcm90b3R5cGUsZz1kLmNhbGwsaD15JiZkLmJpbmQuYmluZChnLGcpLGI9eT9oOmZ1bmN0aW9uKHQpe3JldHVybiBmdW5jdGlvbigpe3JldHVybiBnLmFwcGx5KHQsYXJndW1lbnRzKX19LHY9YixtPXYoe30udG9TdHJpbmcpLHc9digiIi5zbGljZSksUz1mdW5jdGlvbih0KXtyZXR1cm4gdyhtKHQpLDgsLTEpfSxPPVMsaj1iLEE9ZnVuY3Rpb24odCl7aWYoIkZ1bmN0aW9uIj09PU8odCkpcmV0dXJuIGoodCl9LEw9Im9iamVjdCI9PXR5cGVvZiBkb2N1bWVudCYmZG9jdW1lbnQuYWxsLFA9dm9pZCAwPT09TCYmdm9pZCAwIT09TD9mdW5jdGlvbih0KXtyZXR1cm4iZnVuY3Rpb24iPT10eXBlb2YgdHx8dD09PUx9OmZ1bmN0aW9uKHQpe3JldHVybiJmdW5jdGlvbiI9PXR5cGVvZiB0fSxJPXt9LGs9IWEoKGZ1bmN0aW9uKCl7cmV0dXJuIDchPT1PYmplY3QuZGVmaW5lUHJvcGVydHkoe30sMSx7Z2V0OmZ1bmN0aW9uKCl7cmV0dXJuIDd9fSlbMV19KSksVD11LEU9RnVuY3Rpb24ucHJvdG90eXBlLmNhbGwsVT1UP0UuYmluZChFKTpmdW5jdGlvbigpe3JldHVybiBFLmFwcGx5KEUsYXJndW1lbnRzKX0sRj17fSx4PXt9LnByb3BlcnR5SXNFbnVtZXJhYmxlLE49T2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcixNPU4mJiF4LmNhbGwoezE6Mn0sMSk7Ri5mPU0/ZnVuY3Rpb24odCl7dmFyIGU9Tih0aGlzLHQpO3JldHVybiEhZSYmZS5lbnVtZXJhYmxlfTp4O3ZhciBfLFIsQj1mdW5jdGlvbih0LGUpe3JldHVybntlbnVtZXJhYmxlOiEoMSZ0KSxjb25maWd1cmFibGU6ISgyJnQpLHdyaXRhYmxlOiEoNCZ0KSx2YWx1ZTplfX0sQz1hLEQ9UyxHPU9iamVjdCxIPWIoIiIuc3BsaXQpLFY9QygoZnVuY3Rpb24oKXtyZXR1cm4hRygieiIpLnByb3BlcnR5SXNFbnVtZXJhYmxlKDApfSkpP2Z1bmN0aW9uKHQpe3JldHVybiJTdHJpbmciPT09RCh0KT9IKHQsIiIpOkcodCl9OkcsVz1mdW5jdGlvbih0KXtyZXR1cm4gbnVsbD09dH0sej1XLEs9VHlwZUVycm9yLEo9ZnVuY3Rpb24odCl7aWYoeih0KSl0aHJvdyBuZXcgSygiQ2FuJ3QgY2FsbCBtZXRob2Qgb24gIit0KTtyZXR1cm4gdH0scT1WLFk9SixYPWZ1bmN0aW9uKHQpe3JldHVybiBxKFkodCkpfSwkPVAsUT1mdW5jdGlvbih0KXtyZXR1cm4ib2JqZWN0Ij09dHlwZW9mIHQ/bnVsbCE9PXQ6JCh0KX0sWj17fSx0dD1aLGV0PWkscnQ9UCxudD1mdW5jdGlvbih0KXtyZXR1cm4gcnQodCk/dDp2b2lkIDB9LG90PWZ1bmN0aW9uKHQsZSl7cmV0dXJuIGFyZ3VtZW50cy5sZW5ndGg8Mj9udCh0dFt0XSl8fG50KGV0W3RdKTp0dFt0XSYmdHRbdF1bZV18fGV0W3RdJiZldFt0XVtlXX0saXQ9Yih7fS5pc1Byb3RvdHlwZU9mKSxhdD1pLm5hdmlnYXRvcix1dD1hdCYmYXQudXNlckFnZW50LGN0PWksc3Q9dXQ/U3RyaW5nKHV0KToiIixmdD1jdC5wcm9jZXNzLGx0PWN0LkRlbm8scHQ9ZnQmJmZ0LnZlcnNpb25zfHxsdCYmbHQudmVyc2lvbix5dD1wdCYmcHQudjg7eXQmJihSPShfPXl0LnNwbGl0KCIuIikpWzBdPjAmJl9bMF08ND8xOisoX1swXStfWzFdKSksIVImJnN0JiYoIShfPXN0Lm1hdGNoKC9FZGdlXC8oXGQrKS8pKXx8X1sxXT49NzQpJiYoXz1zdC5tYXRjaCgvQ2hyb21lXC8oXGQrKS8pKSYmKFI9K19bMV0pO3ZhciBkdD1SLGd0PWR0LGh0PWEsYnQ9aS5TdHJpbmcsdnQ9ISFPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzJiYhaHQoKGZ1bmN0aW9uKCl7dmFyIHQ9U3ltYm9sKCJzeW1ib2wgZGV0ZWN0aW9uIik7cmV0dXJuIWJ0KHQpfHwhKE9iamVjdCh0KWluc3RhbmNlb2YgU3ltYm9sKXx8IVN5bWJvbC5zaGFtJiZndCYmZ3Q8NDF9KSksbXQ9dnQmJiFTeW1ib2wuc2hhbSYmInN5bWJvbCI9PXR5cGVvZiBTeW1ib2wuaXRlcmF0b3Isd3Q9b3QsU3Q9UCxPdD1pdCxqdD1PYmplY3QsQXQ9bXQ/ZnVuY3Rpb24odCl7cmV0dXJuInN5bWJvbCI9PXR5cGVvZiB0fTpmdW5jdGlvbih0KXt2YXIgZT13dCgiU3ltYm9sIik7cmV0dXJuIFN0KGUpJiZPdChlLnByb3RvdHlwZSxqdCh0KSl9LEx0PVN0cmluZyxQdD1mdW5jdGlvbih0KXt0cnl7cmV0dXJuIEx0KHQpfWNhdGNoKGUpe3JldHVybiJPYmplY3QifX0sSXQ9UCxrdD1QdCxUdD1UeXBlRXJyb3IsRXQ9ZnVuY3Rpb24odCl7aWYoSXQodCkpcmV0dXJuIHQ7dGhyb3cgbmV3IFR0KGt0KHQpKyIgaXMgbm90IGEgZnVuY3Rpb24iKX0sVXQ9RXQsRnQ9Vyx4dD1VLE50PVAsTXQ9USxfdD1UeXBlRXJyb3IsUnQ9e2V4cG9ydHM6e319LEJ0PWksQ3Q9T2JqZWN0LmRlZmluZVByb3BlcnR5LER0PWksR3Q9ZnVuY3Rpb24odCxlKXt0cnl7Q3QoQnQsdCx7dmFsdWU6ZSxjb25maWd1cmFibGU6ITAsd3JpdGFibGU6ITB9KX1jYXRjaChyKXtCdFt0XT1lfXJldHVybiBlfSxIdD0iX19jb3JlLWpzX3NoYXJlZF9fIixWdD1SdC5leHBvcnRzPUR0W0h0XXx8R3QoSHQse30pOyhWdC52ZXJzaW9uc3x8KFZ0LnZlcnNpb25zPVtdKSkucHVzaCh7dmVyc2lvbjoiMy4zOS4wIixtb2RlOiJwdXJlIixjb3B5cmlnaHQ6IsKpIDIwMTQtMjAyNCBEZW5pcyBQdXNoa2FyZXYgKHpsb2lyb2NrLnJ1KSIsbGljZW5zZToiaHR0cHM6Ly9naXRodWIuY29tL3psb2lyb2NrL2NvcmUtanMvYmxvYi92My4zOS4wL0xJQ0VOU0UiLHNvdXJjZToiaHR0cHM6Ly9naXRodWIuY29tL3psb2lyb2NrL2NvcmUtanMifSk7dmFyIFd0PVJ0LmV4cG9ydHMsenQ9V3QsS3Q9ZnVuY3Rpb24odCxlKXtyZXR1cm4genRbdF18fCh6dFt0XT1lfHx7fSl9LEp0PUoscXQ9T2JqZWN0LFl0PWZ1bmN0aW9uKHQpe3JldHVybiBxdChKdCh0KSl9LFh0PVl0LCR0PWIoe30uaGFzT3duUHJvcGVydHkpLFF0PU9iamVjdC5oYXNPd258fGZ1bmN0aW9uKHQsZSl7cmV0dXJuICR0KFh0KHQpLGUpfSxadD1iLHRlPTAsZWU9TWF0aC5yYW5kb20oKSxyZT1adCgxLi50b1N0cmluZyksbmU9ZnVuY3Rpb24odCl7cmV0dXJuIlN5bWJvbCgiKyh2b2lkIDA9PT10PyIiOnQpKyIpXyIrcmUoKyt0ZStlZSwzNil9LG9lPUt0LGllPVF0LGFlPW5lLHVlPXZ0LGNlPW10LHNlPWkuU3ltYm9sLGZlPW9lKCJ3a3MiKSxsZT1jZT9zZS5mb3J8fHNlOnNlJiZzZS53aXRob3V0U2V0dGVyfHxhZSxwZT1mdW5jdGlvbih0KXtyZXR1cm4gaWUoZmUsdCl8fChmZVt0XT11ZSYmaWUoc2UsdCk/c2VbdF06bGUoIlN5bWJvbC4iK3QpKSxmZVt0XX0seWU9VSxkZT1RLGdlPUF0LGhlPWZ1bmN0aW9uKHQsZSl7dmFyIHI9dFtlXTtyZXR1cm4gRnQocik/dm9pZCAwOlV0KHIpfSxiZT1mdW5jdGlvbih0LGUpe3ZhciByLG47aWYoInN0cmluZyI9PT1lJiZOdChyPXQudG9TdHJpbmcpJiYhTXQobj14dChyLHQpKSlyZXR1cm4gbjtpZihOdChyPXQudmFsdWVPZikmJiFNdChuPXh0KHIsdCkpKXJldHVybiBuO2lmKCJzdHJpbmciIT09ZSYmTnQocj10LnRvU3RyaW5nKSYmIU10KG49eHQocix0KSkpcmV0dXJuIG47dGhyb3cgbmV3IF90KCJDYW4ndCBjb252ZXJ0IG9iamVjdCB0byBwcmltaXRpdmUgdmFsdWUiKX0sdmU9VHlwZUVycm9yLG1lPXBlKCJ0b1ByaW1pdGl2ZSIpLHdlPWZ1bmN0aW9uKHQsZSl7aWYoIWRlKHQpfHxnZSh0KSlyZXR1cm4gdDt2YXIgcixuPWhlKHQsbWUpO2lmKG4pe2lmKHZvaWQgMD09PWUmJihlPSJkZWZhdWx0Iikscj15ZShuLHQsZSksIWRlKHIpfHxnZShyKSlyZXR1cm4gcjt0aHJvdyBuZXcgdmUoIkNhbid0IGNvbnZlcnQgb2JqZWN0IHRvIHByaW1pdGl2ZSB2YWx1ZSIpfXJldHVybiB2b2lkIDA9PT1lJiYoZT0ibnVtYmVyIiksYmUodCxlKX0sU2U9QXQsT2U9ZnVuY3Rpb24odCl7dmFyIGU9d2UodCwic3RyaW5nIik7cmV0dXJuIFNlKGUpP2U6ZSsiIn0samU9USxBZT1pLmRvY3VtZW50LExlPWplKEFlKSYmamUoQWUuY3JlYXRlRWxlbWVudCksUGU9ZnVuY3Rpb24odCl7cmV0dXJuIExlP0FlLmNyZWF0ZUVsZW1lbnQodCk6e319LEllPVBlLGtlPSFrJiYhYSgoZnVuY3Rpb24oKXtyZXR1cm4gNyE9PU9iamVjdC5kZWZpbmVQcm9wZXJ0eShJZSgiZGl2IiksImEiLHtnZXQ6ZnVuY3Rpb24oKXtyZXR1cm4gN319KS5hfSkpLFRlPWssRWU9VSxVZT1GLEZlPUIseGU9WCxOZT1PZSxNZT1RdCxfZT1rZSxSZT1PYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yO0kuZj1UZT9SZTpmdW5jdGlvbih0LGUpe2lmKHQ9eGUodCksZT1OZShlKSxfZSl0cnl7cmV0dXJuIFJlKHQsZSl9Y2F0Y2gocil7fWlmKE1lKHQsZSkpcmV0dXJuIEZlKCFFZShVZS5mLHQsZSksdFtlXSl9O3ZhciBCZT1hLENlPVAsRGU9LyN8XC5wcm90b3R5cGVcLi8sR2U9ZnVuY3Rpb24odCxlKXt2YXIgcj1WZVtIZSh0KV07cmV0dXJuIHI9PT16ZXx8ciE9PVdlJiYoQ2UoZSk/QmUoZSk6ISFlKX0sSGU9R2Uubm9ybWFsaXplPWZ1bmN0aW9uKHQpe3JldHVybiBTdHJpbmcodCkucmVwbGFjZShEZSwiLiIpLnRvTG93ZXJDYXNlKCl9LFZlPUdlLmRhdGE9e30sV2U9R2UuTkFUSVZFPSJOIix6ZT1HZS5QT0xZRklMTD0iUCIsS2U9R2UsSmU9RXQscWU9dSxZZT1BKEEuYmluZCksWGU9ZnVuY3Rpb24odCxlKXtyZXR1cm4gSmUodCksdm9pZCAwPT09ZT90OnFlP1llKHQsZSk6ZnVuY3Rpb24oKXtyZXR1cm4gdC5hcHBseShlLGFyZ3VtZW50cyl9fSwkZT17fSxRZT1rJiZhKChmdW5jdGlvbigpe3JldHVybiA0MiE9PU9iamVjdC5kZWZpbmVQcm9wZXJ0eSgoZnVuY3Rpb24oKXt9KSwicHJvdG90eXBlIix7dmFsdWU6NDIsd3JpdGFibGU6ITF9KS5wcm90b3R5cGV9KSksWmU9USx0cj1TdHJpbmcsZXI9VHlwZUVycm9yLHJyPWZ1bmN0aW9uKHQpe2lmKFplKHQpKXJldHVybiB0O3Rocm93IG5ldyBlcih0cih0KSsiIGlzIG5vdCBhbiBvYmplY3QiKX0sbnI9ayxvcj1rZSxpcj1RZSxhcj1ycix1cj1PZSxjcj1UeXBlRXJyb3Isc3I9T2JqZWN0LmRlZmluZVByb3BlcnR5LGZyPU9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IsbHI9ImVudW1lcmFibGUiLHByPSJjb25maWd1cmFibGUiLHlyPSJ3cml0YWJsZSI7JGUuZj1ucj9pcj9mdW5jdGlvbih0LGUscil7aWYoYXIodCksZT11cihlKSxhcihyKSwiZnVuY3Rpb24iPT10eXBlb2YgdCYmInByb3RvdHlwZSI9PT1lJiYidmFsdWUiaW4gciYmeXIgaW4gciYmIXJbeXJdKXt2YXIgbj1mcih0LGUpO24mJm5beXJdJiYodFtlXT1yLnZhbHVlLHI9e2NvbmZpZ3VyYWJsZTpwciBpbiByP3JbcHJdOm5bcHJdLGVudW1lcmFibGU6bHIgaW4gcj9yW2xyXTpuW2xyXSx3cml0YWJsZTohMX0pfXJldHVybiBzcih0LGUscil9OnNyOmZ1bmN0aW9uKHQsZSxyKXtpZihhcih0KSxlPXVyKGUpLGFyKHIpLG9yKXRyeXtyZXR1cm4gc3IodCxlLHIpfWNhdGNoKG4pe31pZigiZ2V0ImluIHJ8fCJzZXQiaW4gcil0aHJvdyBuZXcgY3IoIkFjY2Vzc29ycyBub3Qgc3VwcG9ydGVkIik7cmV0dXJuInZhbHVlImluIHImJih0W2VdPXIudmFsdWUpLHR9O3ZhciBkcj0kZSxncj1CLGhyPWs/ZnVuY3Rpb24odCxlLHIpe3JldHVybiBkci5mKHQsZSxncigxLHIpKX06ZnVuY3Rpb24odCxlLHIpe3JldHVybiB0W2VdPXIsdH0sYnI9aSx2cj1wLG1yPUEsd3I9UCxTcj1JLmYsT3I9S2UsanI9WixBcj1YZSxMcj1ocixQcj1RdCxJcj1mdW5jdGlvbih0KXt2YXIgZT1mdW5jdGlvbihyLG4sbyl7aWYodGhpcyBpbnN0YW5jZW9mIGUpe3N3aXRjaChhcmd1bWVudHMubGVuZ3RoKXtjYXNlIDA6cmV0dXJuIG5ldyB0O2Nhc2UgMTpyZXR1cm4gbmV3IHQocik7Y2FzZSAyOnJldHVybiBuZXcgdChyLG4pfXJldHVybiBuZXcgdChyLG4sbyl9cmV0dXJuIHZyKHQsdGhpcyxhcmd1bWVudHMpfTtyZXR1cm4gZS5wcm90b3R5cGU9dC5wcm90b3R5cGUsZX0sa3I9ZnVuY3Rpb24odCxlKXt2YXIgcixuLG8saSxhLHUsYyxzLGYsbD10LnRhcmdldCxwPXQuZ2xvYmFsLHk9dC5zdGF0LGQ9dC5wcm90byxnPXA/YnI6eT9icltsXTpicltsXSYmYnJbbF0ucHJvdG90eXBlLGg9cD9qcjpqcltsXXx8THIoanIsbCx7fSlbbF0sYj1oLnByb3RvdHlwZTtmb3IoaSBpbiBlKW49IShyPU9yKHA/aTpsKyh5PyIuIjoiIyIpK2ksdC5mb3JjZWQpKSYmZyYmUHIoZyxpKSx1PWhbaV0sbiYmKGM9dC5kb250Q2FsbEdldFNldD8oZj1TcihnLGkpKSYmZi52YWx1ZTpnW2ldKSxhPW4mJmM/YzplW2ldLChyfHxkfHx0eXBlb2YgdSE9dHlwZW9mIGEpJiYocz10LmJpbmQmJm4/QXIoYSxicik6dC53cmFwJiZuP0lyKGEpOmQmJndyKGEpP21yKGEpOmEsKHQuc2hhbXx8YSYmYS5zaGFtfHx1JiZ1LnNoYW0pJiZMcihzLCJzaGFtIiwhMCksTHIoaCxpLHMpLGQmJihQcihqcixvPWwrIlByb3RvdHlwZSIpfHxMcihqcixvLHt9KSxMcihqcltvXSxpLGEpLHQucmVhbCYmYiYmKHJ8fCFiW2ldKSYmTHIoYixpLGEpKSl9LFRyPWtyLEVyPWssVXI9JGUuZjtUcih7dGFyZ2V0OiJPYmplY3QiLHN0YXQ6ITAsZm9yY2VkOk9iamVjdC5kZWZpbmVQcm9wZXJ0eSE9PVVyLHNoYW06IUVyfSx7ZGVmaW5lUHJvcGVydHk6VXJ9KTt2YXIgRnI9Wi5PYmplY3QseHI9bi5leHBvcnRzPWZ1bmN0aW9uKHQsZSxyKXtyZXR1cm4gRnIuZGVmaW5lUHJvcGVydHkodCxlLHIpfTtGci5kZWZpbmVQcm9wZXJ0eS5zaGFtJiYoeHIuc2hhbT0hMCk7dmFyIE5yPXIobi5leHBvcnRzKSxNcj1TLF9yPUFycmF5LmlzQXJyYXl8fGZ1bmN0aW9uKHQpe3JldHVybiJBcnJheSI9PT1Ncih0KX0sUnI9TWF0aC5jZWlsLEJyPU1hdGguZmxvb3IsQ3I9TWF0aC50cnVuY3x8ZnVuY3Rpb24odCl7dmFyIGU9K3Q7cmV0dXJuKGU+MD9CcjpScikoZSl9LERyPWZ1bmN0aW9uKHQpe3ZhciBlPSt0O3JldHVybiBlIT1lfHwwPT09ZT8wOkNyKGUpfSxHcj1EcixIcj1NYXRoLm1pbixWcj1mdW5jdGlvbih0KXt2YXIgZT1Hcih0KTtyZXR1cm4gZT4wP0hyKGUsOTAwNzE5OTI1NDc0MDk5MSk6MH0sV3I9ZnVuY3Rpb24odCl7cmV0dXJuIFZyKHQubGVuZ3RoKX0senI9VHlwZUVycm9yLEtyPWssSnI9JGUscXI9QixZcj17fTtZcltwZSgidG9TdHJpbmdUYWciKV09InoiO3ZhciBYcj0iW29iamVjdCB6XSI9PT1TdHJpbmcoWXIpLCRyPVhyLFFyPVAsWnI9Uyx0bj1wZSgidG9TdHJpbmdUYWciKSxlbj1PYmplY3Qscm49IkFyZ3VtZW50cyI9PT1acihmdW5jdGlvbigpe3JldHVybiBhcmd1bWVudHN9KCkpLG5uPSRyP1pyOmZ1bmN0aW9uKHQpe3ZhciBlLHIsbjtyZXR1cm4gdm9pZCAwPT09dD8iVW5kZWZpbmVkIjpudWxsPT09dD8iTnVsbCI6InN0cmluZyI9PXR5cGVvZihyPWZ1bmN0aW9uKHQsZSl7dHJ5e3JldHVybiB0W2VdfWNhdGNoKHIpe319KGU9ZW4odCksdG4pKT9yOnJuP1pyKGUpOiJPYmplY3QiPT09KG49WnIoZSkpJiZRcihlLmNhbGxlZSk/IkFyZ3VtZW50cyI6bn0sb249UCxhbj1XdCx1bj1iKEZ1bmN0aW9uLnRvU3RyaW5nKTtvbihhbi5pbnNwZWN0U291cmNlKXx8KGFuLmluc3BlY3RTb3VyY2U9ZnVuY3Rpb24odCl7cmV0dXJuIHVuKHQpfSk7dmFyIGNuPWFuLmluc3BlY3RTb3VyY2Usc249Yixmbj1hLGxuPVAscG49bm4seW49Y24sZG49ZnVuY3Rpb24oKXt9LGduPW90KCJSZWZsZWN0IiwiY29uc3RydWN0IiksaG49L15ccyooPzpjbGFzc3xmdW5jdGlvbilcYi8sYm49c24oaG4uZXhlYyksdm49IWhuLnRlc3QoZG4pLG1uPWZ1bmN0aW9uKHQpe2lmKCFsbih0KSlyZXR1cm4hMTt0cnl7cmV0dXJuIGduKGRuLFtdLHQpLCEwfWNhdGNoKGUpe3JldHVybiExfX0sd249ZnVuY3Rpb24odCl7aWYoIWxuKHQpKXJldHVybiExO3N3aXRjaChwbih0KSl7Y2FzZSJBc3luY0Z1bmN0aW9uIjpjYXNlIkdlbmVyYXRvckZ1bmN0aW9uIjpjYXNlIkFzeW5jR2VuZXJhdG9yRnVuY3Rpb24iOnJldHVybiExfXRyeXtyZXR1cm4gdm58fCEhYm4oaG4seW4odCkpfWNhdGNoKGUpe3JldHVybiEwfX07d24uc2hhbT0hMDt2YXIgU249IWdufHxmbigoZnVuY3Rpb24oKXt2YXIgdDtyZXR1cm4gbW4obW4uY2FsbCl8fCFtbihPYmplY3QpfHwhbW4oKGZ1bmN0aW9uKCl7dD0hMH0pKXx8dH0pKT93bjptbixPbj1fcixqbj1TbixBbj1RLExuPXBlKCJzcGVjaWVzIiksUG49QXJyYXksSW49ZnVuY3Rpb24odCl7dmFyIGU7cmV0dXJuIE9uKHQpJiYoZT10LmNvbnN0cnVjdG9yLChqbihlKSYmKGU9PT1Qbnx8T24oZS5wcm90b3R5cGUpKXx8QW4oZSkmJm51bGw9PT0oZT1lW0xuXSkpJiYoZT12b2lkIDApKSx2b2lkIDA9PT1lP1BuOmV9LGtuPWZ1bmN0aW9uKHQsZSl7cmV0dXJuIG5ldyhJbih0KSkoMD09PWU/MDplKX0sVG49YSxFbj1kdCxVbj1wZSgic3BlY2llcyIpLEZuPWtyLHhuPWEsTm49X3IsTW49USxfbj1ZdCxSbj1XcixCbj1mdW5jdGlvbih0KXtpZih0PjkwMDcxOTkyNTQ3NDA5OTEpdGhyb3cgenIoIk1heGltdW0gYWxsb3dlZCBpbmRleCBleGNlZWRlZCIpO3JldHVybiB0fSxDbj1mdW5jdGlvbih0LGUscil7S3I/SnIuZih0LGUscXIoMCxyKSk6dFtlXT1yfSxEbj1rbixHbj1mdW5jdGlvbih0KXtyZXR1cm4gRW4+PTUxfHwhVG4oKGZ1bmN0aW9uKCl7dmFyIGU9W107cmV0dXJuKGUuY29uc3RydWN0b3I9e30pW1VuXT1mdW5jdGlvbigpe3JldHVybntmb286MX19LDEhPT1lW3RdKEJvb2xlYW4pLmZvb30pKX0sSG49ZHQsVm49cGUoImlzQ29uY2F0U3ByZWFkYWJsZSIpLFduPUhuPj01MXx8IXhuKChmdW5jdGlvbigpe3ZhciB0PVtdO3JldHVybiB0W1ZuXT0hMSx0LmNvbmNhdCgpWzBdIT09dH0pKSx6bj1mdW5jdGlvbih0KXtpZighTW4odCkpcmV0dXJuITE7dmFyIGU9dFtWbl07cmV0dXJuIHZvaWQgMCE9PWU/ISFlOk5uKHQpfTtGbih7dGFyZ2V0OiJBcnJheSIscHJvdG86ITAsYXJpdHk6MSxmb3JjZWQ6IVdufHwhR24oImNvbmNhdCIpfSx7Y29uY2F0OmZ1bmN0aW9uKHQpe3ZhciBlLHIsbixvLGksYT1fbih0aGlzKSx1PURuKGEsMCksYz0wO2ZvcihlPS0xLG49YXJndW1lbnRzLmxlbmd0aDtlPG47ZSsrKWlmKHpuKGk9LTE9PT1lP2E6YXJndW1lbnRzW2VdKSlmb3Iobz1SbihpKSxCbihjK28pLHI9MDtyPG87cisrLGMrKylyIGluIGkmJkNuKHUsYyxpW3JdKTtlbHNlIEJuKGMrMSksQ24odSxjKyssaSk7cmV0dXJuIHUubGVuZ3RoPWMsdX19KTt2YXIgS249bm4sSm49U3RyaW5nLHFuPWZ1bmN0aW9uKHQpe2lmKCJTeW1ib2wiPT09S24odCkpdGhyb3cgbmV3IFR5cGVFcnJvcigiQ2Fubm90IGNvbnZlcnQgYSBTeW1ib2wgdmFsdWUgdG8gYSBzdHJpbmciKTtyZXR1cm4gSm4odCl9LFluPXt9LFhuPURyLCRuPU1hdGgubWF4LFFuPU1hdGgubWluLFpuPVgsdG89ZnVuY3Rpb24odCxlKXt2YXIgcj1Ybih0KTtyZXR1cm4gcjwwPyRuKHIrZSwwKTpRbihyLGUpfSxlbz1Xcixybz1mdW5jdGlvbih0KXtyZXR1cm4gZnVuY3Rpb24oZSxyLG4pe3ZhciBvPVpuKGUpLGk9ZW8obyk7aWYoMD09PWkpcmV0dXJuIXQmJi0xO3ZhciBhLHU9dG8obixpKTtpZih0JiZyIT1yKXtmb3IoO2k+dTspaWYoKGE9b1t1KytdKSE9YSlyZXR1cm4hMH1lbHNlIGZvcig7aT51O3UrKylpZigodHx8dSBpbiBvKSYmb1t1XT09PXIpcmV0dXJuIHR8fHV8fDA7cmV0dXJuIXQmJi0xfX0sbm89e2luY2x1ZGVzOnJvKCEwKSxpbmRleE9mOnJvKCExKX0sb289e30saW89UXQsYW89WCx1bz1uby5pbmRleE9mLGNvPW9vLHNvPWIoW10ucHVzaCksZm89ZnVuY3Rpb24odCxlKXt2YXIgcixuPWFvKHQpLG89MCxpPVtdO2ZvcihyIGluIG4pIWlvKGNvLHIpJiZpbyhuLHIpJiZzbyhpLHIpO2Zvcig7ZS5sZW5ndGg+bzspaW8obixyPWVbbysrXSkmJih+dW8oaSxyKXx8c28oaSxyKSk7cmV0dXJuIGl9LGxvPVsiY29uc3RydWN0b3IiLCJoYXNPd25Qcm9wZXJ0eSIsImlzUHJvdG90eXBlT2YiLCJwcm9wZXJ0eUlzRW51bWVyYWJsZSIsInRvTG9jYWxlU3RyaW5nIiwidG9TdHJpbmciLCJ2YWx1ZU9mIl0scG89Zm8seW89bG8sZ289T2JqZWN0LmtleXN8fGZ1bmN0aW9uKHQpe3JldHVybiBwbyh0LHlvKX0saG89ayxibz1RZSx2bz0kZSxtbz1ycix3bz1YLFNvPWdvO1luLmY9aG8mJiFibz9PYmplY3QuZGVmaW5lUHJvcGVydGllczpmdW5jdGlvbih0LGUpe21vKHQpO2Zvcih2YXIgcixuPXdvKGUpLG89U28oZSksaT1vLmxlbmd0aCxhPTA7aT5hOyl2by5mKHQscj1vW2ErK10sbltyXSk7cmV0dXJuIHR9O3ZhciBPbyxqbz1vdCgiZG9jdW1lbnQiLCJkb2N1bWVudEVsZW1lbnQiKSxBbz1uZSxMbz1LdCgia2V5cyIpLFBvPWZ1bmN0aW9uKHQpe3JldHVybiBMb1t0XXx8KExvW3RdPUFvKHQpKX0sSW89cnIsa289WW4sVG89bG8sRW89b28sVW89am8sRm89UGUseG89InByb3RvdHlwZSIsTm89InNjcmlwdCIsTW89UG8oIklFX1BST1RPIiksX289ZnVuY3Rpb24oKXt9LFJvPWZ1bmN0aW9uKHQpe3JldHVybiI8IitObysiPiIrdCsiPC8iK05vKyI+In0sQm89ZnVuY3Rpb24odCl7dC53cml0ZShSbygiIikpLHQuY2xvc2UoKTt2YXIgZT10LnBhcmVudFdpbmRvdy5PYmplY3Q7cmV0dXJuIHQ9bnVsbCxlfSxDbz1mdW5jdGlvbigpe3RyeXtPbz1uZXcgQWN0aXZlWE9iamVjdCgiaHRtbGZpbGUiKX1jYXRjaChvKXt9dmFyIHQsZSxyO0NvPSJ1bmRlZmluZWQiIT10eXBlb2YgZG9jdW1lbnQ/ZG9jdW1lbnQuZG9tYWluJiZPbz9CbyhPbyk6KGU9Rm8oImlmcmFtZSIpLHI9ImphdmEiK05vKyI6IixlLnN0eWxlLmRpc3BsYXk9Im5vbmUiLFVvLmFwcGVuZENoaWxkKGUpLGUuc3JjPVN0cmluZyhyKSwodD1lLmNvbnRlbnRXaW5kb3cuZG9jdW1lbnQpLm9wZW4oKSx0LndyaXRlKFJvKCJkb2N1bWVudC5GPU9iamVjdCIpKSx0LmNsb3NlKCksdC5GKTpCbyhPbyk7Zm9yKHZhciBuPVRvLmxlbmd0aDtuLS07KWRlbGV0ZSBDb1t4b11bVG9bbl1dO3JldHVybiBDbygpfTtFb1tNb109ITA7dmFyIERvPU9iamVjdC5jcmVhdGV8fGZ1bmN0aW9uKHQsZSl7dmFyIHI7cmV0dXJuIG51bGwhPT10Pyhfb1t4b109SW8odCkscj1uZXcgX28sX29beG9dPW51bGwscltNb109dCk6cj1DbygpLHZvaWQgMD09PWU/cjprby5mKHIsZSl9LEdvPXt9LEhvPWZvLFZvPWxvLmNvbmNhdCgibGVuZ3RoIiwicHJvdG90eXBlIik7R28uZj1PYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lc3x8ZnVuY3Rpb24odCl7cmV0dXJuIEhvKHQsVm8pfTt2YXIgV289e30sem89YihbXS5zbGljZSksS289UyxKbz1YLHFvPUdvLmYsWW89em8sWG89Im9iamVjdCI9PXR5cGVvZiB3aW5kb3cmJndpbmRvdyYmT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXM/T2JqZWN0LmdldE93blByb3BlcnR5TmFtZXMod2luZG93KTpbXTtXby5mPWZ1bmN0aW9uKHQpe3JldHVybiBYbyYmIldpbmRvdyI9PT1Lbyh0KT9mdW5jdGlvbih0KXt0cnl7cmV0dXJuIHFvKHQpfWNhdGNoKGUpe3JldHVybiBZbyhYbyl9fSh0KTpxbyhKbyh0KSl9O3ZhciAkbz17fTskby5mPU9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHM7dmFyIFFvPWhyLFpvPWZ1bmN0aW9uKHQsZSxyLG4pe3JldHVybiBuJiZuLmVudW1lcmFibGU/dFtlXT1yOlFvKHQsZSxyKSx0fSx0aT0kZSxlaT17fSxyaT1wZTtlaS5mPXJpO3ZhciBuaSxvaSxpaSxhaT1aLHVpPVF0LGNpPWVpLHNpPSRlLmYsZmk9ZnVuY3Rpb24odCl7dmFyIGU9YWkuU3ltYm9sfHwoYWkuU3ltYm9sPXt9KTt1aShlLHQpfHxzaShlLHQse3ZhbHVlOmNpLmYodCl9KX0sbGk9VSxwaT1vdCx5aT1wZSxkaT1abyxnaT1mdW5jdGlvbigpe3ZhciB0PXBpKCJTeW1ib2wiKSxlPXQmJnQucHJvdG90eXBlLHI9ZSYmZS52YWx1ZU9mLG49eWkoInRvUHJpbWl0aXZlIik7ZSYmIWVbbl0mJmRpKGUsbiwoZnVuY3Rpb24odCl7cmV0dXJuIGxpKHIsdGhpcyl9KSx7YXJpdHk6MX0pfSxoaT1ubixiaT1Ycj97fS50b1N0cmluZzpmdW5jdGlvbigpe3JldHVybiJbb2JqZWN0ICIraGkodGhpcykrIl0ifSx2aT1YcixtaT0kZS5mLHdpPWhyLFNpPVF0LE9pPWJpLGppPXBlKCJ0b1N0cmluZ1RhZyIpLEFpPWZ1bmN0aW9uKHQsZSxyLG4pe3ZhciBvPXI/dDp0JiZ0LnByb3RvdHlwZTtvJiYoU2kobyxqaSl8fG1pKG8samkse2NvbmZpZ3VyYWJsZTohMCx2YWx1ZTplfSksbiYmIXZpJiZ3aShvLCJ0b1N0cmluZyIsT2kpKX0sTGk9UCxQaT1pLldlYWtNYXAsSWk9TGkoUGkpJiYvbmF0aXZlIGNvZGUvLnRlc3QoU3RyaW5nKFBpKSksa2k9aSxUaT1RLEVpPWhyLFVpPVF0LEZpPVd0LHhpPVBvLE5pPW9vLE1pPSJPYmplY3QgYWxyZWFkeSBpbml0aWFsaXplZCIsX2k9a2kuVHlwZUVycm9yLFJpPWtpLldlYWtNYXA7aWYoSWl8fEZpLnN0YXRlKXt2YXIgQmk9Rmkuc3RhdGV8fChGaS5zdGF0ZT1uZXcgUmkpO0JpLmdldD1CaS5nZXQsQmkuaGFzPUJpLmhhcyxCaS5zZXQ9Qmkuc2V0LG5pPWZ1bmN0aW9uKHQsZSl7aWYoQmkuaGFzKHQpKXRocm93IG5ldyBfaShNaSk7cmV0dXJuIGUuZmFjYWRlPXQsQmkuc2V0KHQsZSksZX0sb2k9ZnVuY3Rpb24odCl7cmV0dXJuIEJpLmdldCh0KXx8e319LGlpPWZ1bmN0aW9uKHQpe3JldHVybiBCaS5oYXModCl9fWVsc2V7dmFyIENpPXhpKCJzdGF0ZSIpO05pW0NpXT0hMCxuaT1mdW5jdGlvbih0LGUpe2lmKFVpKHQsQ2kpKXRocm93IG5ldyBfaShNaSk7cmV0dXJuIGUuZmFjYWRlPXQsRWkodCxDaSxlKSxlfSxvaT1mdW5jdGlvbih0KXtyZXR1cm4gVWkodCxDaSk/dFtDaV06e319LGlpPWZ1bmN0aW9uKHQpe3JldHVybiBVaSh0LENpKX19dmFyIERpPXtzZXQ6bmksZ2V0Om9pLGhhczppaSxlbmZvcmNlOmZ1bmN0aW9uKHQpe3JldHVybiBpaSh0KT9vaSh0KTpuaSh0LHt9KX0sZ2V0dGVyRm9yOmZ1bmN0aW9uKHQpe3JldHVybiBmdW5jdGlvbihlKXt2YXIgcjtpZighVGkoZSl8fChyPW9pKGUpKS50eXBlIT09dCl0aHJvdyBuZXcgX2koIkluY29tcGF0aWJsZSByZWNlaXZlciwgIit0KyIgcmVxdWlyZWQiKTtyZXR1cm4gcn19fSxHaT1YZSxIaT1WLFZpPVl0LFdpPVdyLHppPWtuLEtpPWIoW10ucHVzaCksSmk9ZnVuY3Rpb24odCl7dmFyIGU9MT09PXQscj0yPT09dCxuPTM9PT10LG89ND09PXQsaT02PT09dCxhPTc9PT10LHU9NT09PXR8fGk7cmV0dXJuIGZ1bmN0aW9uKGMscyxmLGwpe2Zvcih2YXIgcCx5LGQ9VmkoYyksZz1IaShkKSxoPVdpKGcpLGI9R2kocyxmKSx2PTAsbT1sfHx6aSx3PWU/bShjLGgpOnJ8fGE/bShjLDApOnZvaWQgMDtoPnY7disrKWlmKCh1fHx2IGluIGcpJiYoeT1iKHA9Z1t2XSx2LGQpLHQpKWlmKGUpd1t2XT15O2Vsc2UgaWYoeSlzd2l0Y2godCl7Y2FzZSAzOnJldHVybiEwO2Nhc2UgNTpyZXR1cm4gcDtjYXNlIDY6cmV0dXJuIHY7Y2FzZSAyOktpKHcscCl9ZWxzZSBzd2l0Y2godCl7Y2FzZSA0OnJldHVybiExO2Nhc2UgNzpLaSh3LHApfXJldHVybiBpPy0xOm58fG8/bzp3fX0scWk9e2ZvckVhY2g6SmkoMCksbWFwOkppKDEpLGZpbHRlcjpKaSgyKSxzb21lOkppKDMpLGV2ZXJ5OkppKDQpLGZpbmQ6SmkoNSksZmluZEluZGV4OkppKDYpLGZpbHRlclJlamVjdDpKaSg3KX0sWWk9a3IsWGk9aSwkaT1VLFFpPWIsWmk9ayx0YT12dCxlYT1hLHJhPVF0LG5hPWl0LG9hPXJyLGlhPVgsYWE9T2UsdWE9cW4sY2E9QixzYT1EbyxmYT1nbyxsYT1HbyxwYT1Xbyx5YT0kbyxkYT1JLGdhPSRlLGhhPVluLGJhPUYsdmE9Wm8sbWE9ZnVuY3Rpb24odCxlLHIpe3JldHVybiB0aS5mKHQsZSxyKX0sd2E9S3QsU2E9b28sT2E9bmUsamE9cGUsQWE9ZWksTGE9ZmksUGE9Z2ksSWE9QWksa2E9RGksVGE9cWkuZm9yRWFjaCxFYT1QbygiaGlkZGVuIiksVWE9IlN5bWJvbCIsRmE9InByb3RvdHlwZSIseGE9a2Euc2V0LE5hPWthLmdldHRlckZvcihVYSksTWE9T2JqZWN0W0ZhXSxfYT1YaS5TeW1ib2wsUmE9X2EmJl9hW0ZhXSxCYT1YaS5SYW5nZUVycm9yLENhPVhpLlR5cGVFcnJvcixEYT1YaS5RT2JqZWN0LEdhPWRhLmYsSGE9Z2EuZixWYT1wYS5mLFdhPWJhLmYsemE9UWkoW10ucHVzaCksS2E9d2EoInN5bWJvbHMiKSxKYT13YSgib3Atc3ltYm9scyIpLHFhPXdhKCJ3a3MiKSxZYT0hRGF8fCFEYVtGYV18fCFEYVtGYV0uZmluZENoaWxkLFhhPWZ1bmN0aW9uKHQsZSxyKXt2YXIgbj1HYShNYSxlKTtuJiZkZWxldGUgTWFbZV0sSGEodCxlLHIpLG4mJnQhPT1NYSYmSGEoTWEsZSxuKX0sJGE9WmkmJmVhKChmdW5jdGlvbigpe3JldHVybiA3IT09c2EoSGEoe30sImEiLHtnZXQ6ZnVuY3Rpb24oKXtyZXR1cm4gSGEodGhpcywiYSIse3ZhbHVlOjd9KS5hfX0pKS5hfSkpP1hhOkhhLFFhPWZ1bmN0aW9uKHQsZSl7dmFyIHI9S2FbdF09c2EoUmEpO3JldHVybiB4YShyLHt0eXBlOlVhLHRhZzp0LGRlc2NyaXB0aW9uOmV9KSxaaXx8KHIuZGVzY3JpcHRpb249ZSkscn0sWmE9ZnVuY3Rpb24odCxlLHIpe3Q9PT1NYSYmWmEoSmEsZSxyKSxvYSh0KTt2YXIgbj1hYShlKTtyZXR1cm4gb2EocikscmEoS2Esbik/KHIuZW51bWVyYWJsZT8ocmEodCxFYSkmJnRbRWFdW25dJiYodFtFYV1bbl09ITEpLHI9c2Eocix7ZW51bWVyYWJsZTpjYSgwLCExKX0pKToocmEodCxFYSl8fEhhKHQsRWEsY2EoMSxzYShudWxsKSkpLHRbRWFdW25dPSEwKSwkYSh0LG4scikpOkhhKHQsbixyKX0sdHU9ZnVuY3Rpb24odCxlKXtvYSh0KTt2YXIgcj1pYShlKSxuPWZhKHIpLmNvbmNhdChvdShyKSk7cmV0dXJuIFRhKG4sKGZ1bmN0aW9uKGUpe1ppJiYhJGkoZXUscixlKXx8WmEodCxlLHJbZV0pfSkpLHR9LGV1PWZ1bmN0aW9uKHQpe3ZhciBlPWFhKHQpLHI9JGkoV2EsdGhpcyxlKTtyZXR1cm4hKHRoaXM9PT1NYSYmcmEoS2EsZSkmJiFyYShKYSxlKSkmJighKHJ8fCFyYSh0aGlzLGUpfHwhcmEoS2EsZSl8fHJhKHRoaXMsRWEpJiZ0aGlzW0VhXVtlXSl8fHIpfSxydT1mdW5jdGlvbih0LGUpe3ZhciByPWlhKHQpLG49YWEoZSk7aWYociE9PU1hfHwhcmEoS2Esbil8fHJhKEphLG4pKXt2YXIgbz1HYShyLG4pO3JldHVybiFvfHwhcmEoS2Esbil8fHJhKHIsRWEpJiZyW0VhXVtuXXx8KG8uZW51bWVyYWJsZT0hMCksb319LG51PWZ1bmN0aW9uKHQpe3ZhciBlPVZhKGlhKHQpKSxyPVtdO3JldHVybiBUYShlLChmdW5jdGlvbih0KXtyYShLYSx0KXx8cmEoU2EsdCl8fHphKHIsdCl9KSkscn0sb3U9ZnVuY3Rpb24odCl7dmFyIGU9dD09PU1hLHI9VmEoZT9KYTppYSh0KSksbj1bXTtyZXR1cm4gVGEociwoZnVuY3Rpb24odCl7IXJhKEthLHQpfHxlJiYhcmEoTWEsdCl8fHphKG4sS2FbdF0pfSkpLG59O3RhfHwoX2E9ZnVuY3Rpb24oKXtpZihuYShSYSx0aGlzKSl0aHJvdyBuZXcgQ2EoIlN5bWJvbCBpcyBub3QgYSBjb25zdHJ1Y3RvciIpO3ZhciB0PWFyZ3VtZW50cy5sZW5ndGgmJnZvaWQgMCE9PWFyZ3VtZW50c1swXT91YShhcmd1bWVudHNbMF0pOnZvaWQgMCxlPU9hKHQpLHI9ZnVuY3Rpb24odCl7dmFyIG49dm9pZCAwPT09dGhpcz9YaTp0aGlzO249PT1NYSYmJGkocixKYSx0KSxyYShuLEVhKSYmcmEobltFYV0sZSkmJihuW0VhXVtlXT0hMSk7dmFyIG89Y2EoMSx0KTt0cnl7JGEobixlLG8pfWNhdGNoKGkpe2lmKCEoaSBpbnN0YW5jZW9mIEJhKSl0aHJvdyBpO1hhKG4sZSxvKX19O3JldHVybiBaaSYmWWEmJiRhKE1hLGUse2NvbmZpZ3VyYWJsZTohMCxzZXQ6cn0pLFFhKGUsdCl9LHZhKFJhPV9hW0ZhXSwidG9TdHJpbmciLChmdW5jdGlvbigpe3JldHVybiBOYSh0aGlzKS50YWd9KSksdmEoX2EsIndpdGhvdXRTZXR0ZXIiLChmdW5jdGlvbih0KXtyZXR1cm4gUWEoT2EodCksdCl9KSksYmEuZj1ldSxnYS5mPVphLGhhLmY9dHUsZGEuZj1ydSxsYS5mPXBhLmY9bnUseWEuZj1vdSxBYS5mPWZ1bmN0aW9uKHQpe3JldHVybiBRYShqYSh0KSx0KX0sWmkmJm1hKFJhLCJkZXNjcmlwdGlvbiIse2NvbmZpZ3VyYWJsZTohMCxnZXQ6ZnVuY3Rpb24oKXtyZXR1cm4gTmEodGhpcykuZGVzY3JpcHRpb259fSkpLFlpKHtnbG9iYWw6ITAsY29uc3RydWN0b3I6ITAsd3JhcDohMCxmb3JjZWQ6IXRhLHNoYW06IXRhfSx7U3ltYm9sOl9hfSksVGEoZmEocWEpLChmdW5jdGlvbih0KXtMYSh0KX0pKSxZaSh7dGFyZ2V0OlVhLHN0YXQ6ITAsZm9yY2VkOiF0YX0se3VzZVNldHRlcjpmdW5jdGlvbigpe1lhPSEwfSx1c2VTaW1wbGU6ZnVuY3Rpb24oKXtZYT0hMX19KSxZaSh7dGFyZ2V0OiJPYmplY3QiLHN0YXQ6ITAsZm9yY2VkOiF0YSxzaGFtOiFaaX0se2NyZWF0ZTpmdW5jdGlvbih0LGUpe3JldHVybiB2b2lkIDA9PT1lP3NhKHQpOnR1KHNhKHQpLGUpfSxkZWZpbmVQcm9wZXJ0eTpaYSxkZWZpbmVQcm9wZXJ0aWVzOnR1LGdldE93blByb3BlcnR5RGVzY3JpcHRvcjpydX0pLFlpKHt0YXJnZXQ6Ik9iamVjdCIsc3RhdDohMCxmb3JjZWQ6IXRhfSx7Z2V0T3duUHJvcGVydHlOYW1lczpudX0pLFBhKCksSWEoX2EsVWEpLFNhW0VhXT0hMDt2YXIgaXU9dnQmJiEhU3ltYm9sLmZvciYmISFTeW1ib2wua2V5Rm9yLGF1PWtyLHV1PW90LGN1PVF0LHN1PXFuLGZ1PUt0LGx1PWl1LHB1PWZ1KCJzdHJpbmctdG8tc3ltYm9sLXJlZ2lzdHJ5IikseXU9ZnUoInN5bWJvbC10by1zdHJpbmctcmVnaXN0cnkiKTthdSh7dGFyZ2V0OiJTeW1ib2wiLHN0YXQ6ITAsZm9yY2VkOiFsdX0se2ZvcjpmdW5jdGlvbih0KXt2YXIgZT1zdSh0KTtpZihjdShwdSxlKSlyZXR1cm4gcHVbZV07dmFyIHI9dXUoIlN5bWJvbCIpKGUpO3JldHVybiBwdVtlXT1yLHl1W3JdPWUscn19KTt2YXIgZHU9a3IsZ3U9UXQsaHU9QXQsYnU9UHQsdnU9aXUsbXU9S3QoInN5bWJvbC10by1zdHJpbmctcmVnaXN0cnkiKTtkdSh7dGFyZ2V0OiJTeW1ib2wiLHN0YXQ6ITAsZm9yY2VkOiF2dX0se2tleUZvcjpmdW5jdGlvbih0KXtpZighaHUodCkpdGhyb3cgbmV3IFR5cGVFcnJvcihidSh0KSsiIGlzIG5vdCBhIHN5bWJvbCIpO2lmKGd1KG11LHQpKXJldHVybiBtdVt0XX19KTt2YXIgd3U9X3IsU3U9UCxPdT1TLGp1PXFuLEF1PWIoW10ucHVzaCksTHU9a3IsUHU9b3QsSXU9cCxrdT1VLFR1PWIsRXU9YSxVdT1QLEZ1PUF0LHh1PXpvLE51PWZ1bmN0aW9uKHQpe2lmKFN1KHQpKXJldHVybiB0O2lmKHd1KHQpKXtmb3IodmFyIGU9dC5sZW5ndGgscj1bXSxuPTA7bjxlO24rKyl7dmFyIG89dFtuXTsic3RyaW5nIj09dHlwZW9mIG8/QXUocixvKToibnVtYmVyIiE9dHlwZW9mIG8mJiJOdW1iZXIiIT09T3UobykmJiJTdHJpbmciIT09T3Uobyl8fEF1KHIsanUobykpfXZhciBpPXIubGVuZ3RoLGE9ITA7cmV0dXJuIGZ1bmN0aW9uKHQsZSl7aWYoYSlyZXR1cm4gYT0hMSxlO2lmKHd1KHRoaXMpKXJldHVybiBlO2Zvcih2YXIgbj0wO248aTtuKyspaWYocltuXT09PXQpcmV0dXJuIGV9fX0sTXU9dnQsX3U9U3RyaW5nLFJ1PVB1KCJKU09OIiwic3RyaW5naWZ5IiksQnU9VHUoLy4vLmV4ZWMpLEN1PVR1KCIiLmNoYXJBdCksRHU9VHUoIiIuY2hhckNvZGVBdCksR3U9VHUoIiIucmVwbGFjZSksSHU9VHUoMS4udG9TdHJpbmcpLFZ1PS9bXHVEODAwLVx1REZGRl0vZyxXdT0vXltcdUQ4MDAtXHVEQkZGXSQvLHp1PS9eW1x1REMwMC1cdURGRkZdJC8sS3U9IU11fHxFdSgoZnVuY3Rpb24oKXt2YXIgdD1QdSgiU3ltYm9sIikoInN0cmluZ2lmeSBkZXRlY3Rpb24iKTtyZXR1cm4iW251bGxdIiE9PVJ1KFt0XSl8fCJ7fSIhPT1SdSh7YTp0fSl8fCJ7fSIhPT1SdShPYmplY3QodCkpfSkpLEp1PUV1KChmdW5jdGlvbigpe3JldHVybiciXFx1ZGYwNlxcdWQ4MzQiJyE9PVJ1KCJcdWRmMDZcdWQ4MzQiKXx8JyJcXHVkZWFkIichPT1SdSgiXHVkZWFkIil9KSkscXU9ZnVuY3Rpb24odCxlKXt2YXIgcj14dShhcmd1bWVudHMpLG49TnUoZSk7aWYoVXUobil8fHZvaWQgMCE9PXQmJiFGdSh0KSlyZXR1cm4gclsxXT1mdW5jdGlvbih0LGUpe2lmKFV1KG4pJiYoZT1rdShuLHRoaXMsX3UodCksZSkpLCFGdShlKSlyZXR1cm4gZX0sSXUoUnUsbnVsbCxyKX0sWXU9ZnVuY3Rpb24odCxlLHIpe3ZhciBuPUN1KHIsZS0xKSxvPUN1KHIsZSsxKTtyZXR1cm4gQnUoV3UsdCkmJiFCdSh6dSxvKXx8QnUoenUsdCkmJiFCdShXdSxuKT8iXFx1IitIdShEdSh0LDApLDE2KTp0fTtSdSYmTHUoe3RhcmdldDoiSlNPTiIsc3RhdDohMCxhcml0eTozLGZvcmNlZDpLdXx8SnV9LHtzdHJpbmdpZnk6ZnVuY3Rpb24odCxlLHIpe3ZhciBuPXh1KGFyZ3VtZW50cyksbz1JdShLdT9xdTpSdSxudWxsLG4pO3JldHVybiBKdSYmInN0cmluZyI9PXR5cGVvZiBvP0d1KG8sVnUsWXUpOm99fSk7dmFyIFh1PSRvLCR1PVl0O2tyKHt0YXJnZXQ6Ik9iamVjdCIsc3RhdDohMCxmb3JjZWQ6IXZ0fHxhKChmdW5jdGlvbigpe1h1LmYoMSl9KSl9LHtnZXRPd25Qcm9wZXJ0eVN5bWJvbHM6ZnVuY3Rpb24odCl7dmFyIGU9WHUuZjtyZXR1cm4gZT9lKCR1KHQpKTpbXX19KSxmaSgiYXN5bmNJdGVyYXRvciIpLGZpKCJoYXNJbnN0YW5jZSIpLGZpKCJpc0NvbmNhdFNwcmVhZGFibGUiKSxmaSgiaXRlcmF0b3IiKSxmaSgibWF0Y2giKSxmaSgibWF0Y2hBbGwiKSxmaSgicmVwbGFjZSIpLGZpKCJzZWFyY2giKSxmaSgic3BlY2llcyIpLGZpKCJzcGxpdCIpO3ZhciBRdT1naTtmaSgidG9QcmltaXRpdmUiKSxRdSgpO3ZhciBadT1vdCx0Yz1BaTtmaSgidG9TdHJpbmdUYWciKSx0YyhadSgiU3ltYm9sIiksIlN5bWJvbCIpLGZpKCJ1bnNjb3BhYmxlcyIpLEFpKGkuSlNPTiwiSlNPTiIsITApO3ZhciBlYyxyYyxuYyxvYz1aLlN5bWJvbCxpYz17fSxhYz1rLHVjPVF0LGNjPUZ1bmN0aW9uLnByb3RvdHlwZSxzYz1hYyYmT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcixmYz11YyhjYywibmFtZSIpLGxjPXtFWElTVFM6ZmMsUFJPUEVSOmZjJiYic29tZXRoaW5nIj09PWZ1bmN0aW9uKCl7fS5uYW1lLENPTkZJR1VSQUJMRTpmYyYmKCFhY3x8YWMmJnNjKGNjLCJuYW1lIikuY29uZmlndXJhYmxlKX0scGM9IWEoKGZ1bmN0aW9uKCl7ZnVuY3Rpb24gdCgpe31yZXR1cm4gdC5wcm90b3R5cGUuY29uc3RydWN0b3I9bnVsbCxPYmplY3QuZ2V0UHJvdG90eXBlT2YobmV3IHQpIT09dC5wcm90b3R5cGV9KSkseWM9UXQsZGM9UCxnYz1ZdCxoYz1wYyxiYz1QbygiSUVfUFJPVE8iKSx2Yz1PYmplY3QsbWM9dmMucHJvdG90eXBlLHdjPWhjP3ZjLmdldFByb3RvdHlwZU9mOmZ1bmN0aW9uKHQpe3ZhciBlPWdjKHQpO2lmKHljKGUsYmMpKXJldHVybiBlW2JjXTt2YXIgcj1lLmNvbnN0cnVjdG9yO3JldHVybiBkYyhyKSYmZSBpbnN0YW5jZW9mIHI/ci5wcm90b3R5cGU6ZSBpbnN0YW5jZW9mIHZjP21jOm51bGx9LFNjPWEsT2M9UCxqYz1RLEFjPURvLExjPXdjLFBjPVpvLEljPXBlKCJpdGVyYXRvciIpLGtjPSExO1tdLmtleXMmJigibmV4dCJpbihuYz1bXS5rZXlzKCkpPyhyYz1MYyhMYyhuYykpKSE9PU9iamVjdC5wcm90b3R5cGUmJihlYz1yYyk6a2M9ITApO3ZhciBUYz0hamMoZWMpfHxTYygoZnVuY3Rpb24oKXt2YXIgdD17fTtyZXR1cm4gZWNbSWNdLmNhbGwodCkhPT10fSkpO09jKChlYz1UYz97fTpBYyhlYykpW0ljXSl8fFBjKGVjLEljLChmdW5jdGlvbigpe3JldHVybiB0aGlzfSkpO3ZhciBFYz17SXRlcmF0b3JQcm90b3R5cGU6ZWMsQlVHR1lfU0FGQVJJX0lURVJBVE9SUzprY30sVWM9RWMuSXRlcmF0b3JQcm90b3R5cGUsRmM9RG8seGM9QixOYz1BaSxNYz1pYyxfYz1mdW5jdGlvbigpe3JldHVybiB0aGlzfSxSYz1rcixCYz1VLENjPWxjLERjPWZ1bmN0aW9uKHQsZSxyLG4pe3ZhciBvPWUrIiBJdGVyYXRvciI7cmV0dXJuIHQucHJvdG90eXBlPUZjKFVjLHtuZXh0OnhjKCshbixyKX0pLE5jKHQsbywhMSwhMCksTWNbb109X2MsdH0sR2M9d2MsSGM9QWksVmM9Wm8sV2M9aWMsemM9RWMsS2M9Q2MuUFJPUEVSLEpjPXpjLkJVR0dZX1NBRkFSSV9JVEVSQVRPUlMscWM9cGUoIml0ZXJhdG9yIiksWWM9ImtleXMiLFhjPSJ2YWx1ZXMiLCRjPSJlbnRyaWVzIixRYz1mdW5jdGlvbigpe3JldHVybiB0aGlzfSxaYz1mdW5jdGlvbih0LGUscixuLG8saSxhKXtEYyhyLGUsbik7dmFyIHUsYyxzLGY9ZnVuY3Rpb24odCl7aWYodD09PW8mJmcpcmV0dXJuIGc7aWYoIUpjJiZ0JiZ0IGluIHkpcmV0dXJuIHlbdF07c3dpdGNoKHQpe2Nhc2UgWWM6Y2FzZSBYYzpjYXNlICRjOnJldHVybiBmdW5jdGlvbigpe3JldHVybiBuZXcgcih0aGlzLHQpfX1yZXR1cm4gZnVuY3Rpb24oKXtyZXR1cm4gbmV3IHIodGhpcyl9fSxsPWUrIiBJdGVyYXRvciIscD0hMSx5PXQucHJvdG90eXBlLGQ9eVtxY118fHlbIkBAaXRlcmF0b3IiXXx8byYmeVtvXSxnPSFKYyYmZHx8ZihvKSxoPSJBcnJheSI9PT1lJiZ5LmVudHJpZXN8fGQ7aWYoaCYmKHU9R2MoaC5jYWxsKG5ldyB0KSkpIT09T2JqZWN0LnByb3RvdHlwZSYmdS5uZXh0JiYoSGModSxsLCEwLCEwKSxXY1tsXT1RYyksS2MmJm89PT1YYyYmZCYmZC5uYW1lIT09WGMmJihwPSEwLGc9ZnVuY3Rpb24oKXtyZXR1cm4gQmMoZCx0aGlzKX0pLG8paWYoYz17dmFsdWVzOmYoWGMpLGtleXM6aT9nOmYoWWMpLGVudHJpZXM6ZigkYyl9LGEpZm9yKHMgaW4gYykoSmN8fHB8fCEocyBpbiB5KSkmJlZjKHkscyxjW3NdKTtlbHNlIFJjKHt0YXJnZXQ6ZSxwcm90bzohMCxmb3JjZWQ6SmN8fHB9LGMpO3JldHVybiBhJiZ5W3FjXSE9PWcmJlZjKHkscWMsZyx7bmFtZTpvfSksV2NbZV09ZyxjfSx0cz1mdW5jdGlvbih0LGUpe3JldHVybnt2YWx1ZTp0LGRvbmU6ZX19LGVzPVgscnM9aWMsbnM9RGk7JGUuZjt2YXIgb3M9WmMsaXM9dHMsYXM9IkFycmF5IEl0ZXJhdG9yIix1cz1ucy5zZXQsY3M9bnMuZ2V0dGVyRm9yKGFzKTtvcyhBcnJheSwiQXJyYXkiLChmdW5jdGlvbih0LGUpe3VzKHRoaXMse3R5cGU6YXMsdGFyZ2V0OmVzKHQpLGluZGV4OjAsa2luZDplfSl9KSwoZnVuY3Rpb24oKXt2YXIgdD1jcyh0aGlzKSxlPXQudGFyZ2V0LHI9dC5pbmRleCsrO2lmKCFlfHxyPj1lLmxlbmd0aClyZXR1cm4gdC50YXJnZXQ9bnVsbCxpcyh2b2lkIDAsITApO3N3aXRjaCh0LmtpbmQpe2Nhc2Uia2V5cyI6cmV0dXJuIGlzKHIsITEpO2Nhc2UidmFsdWVzIjpyZXR1cm4gaXMoZVtyXSwhMSl9cmV0dXJuIGlzKFtyLGVbcl1dLCExKX0pLCJ2YWx1ZXMiKSxycy5Bcmd1bWVudHM9cnMuQXJyYXk7dmFyIHNzPXtDU1NSdWxlTGlzdDowLENTU1N0eWxlRGVjbGFyYXRpb246MCxDU1NWYWx1ZUxpc3Q6MCxDbGllbnRSZWN0TGlzdDowLERPTVJlY3RMaXN0OjAsRE9NU3RyaW5nTGlzdDowLERPTVRva2VuTGlzdDoxLERhdGFUcmFuc2Zlckl0ZW1MaXN0OjAsRmlsZUxpc3Q6MCxIVE1MQWxsQ29sbGVjdGlvbjowLEhUTUxDb2xsZWN0aW9uOjAsSFRNTEZvcm1FbGVtZW50OjAsSFRNTFNlbGVjdEVsZW1lbnQ6MCxNZWRpYUxpc3Q6MCxNaW1lVHlwZUFycmF5OjAsTmFtZWROb2RlTWFwOjAsTm9kZUxpc3Q6MSxQYWludFJlcXVlc3RMaXN0OjAsUGx1Z2luOjAsUGx1Z2luQXJyYXk6MCxTVkdMZW5ndGhMaXN0OjAsU1ZHTnVtYmVyTGlzdDowLFNWR1BhdGhTZWdMaXN0OjAsU1ZHUG9pbnRMaXN0OjAsU1ZHU3RyaW5nTGlzdDowLFNWR1RyYW5zZm9ybUxpc3Q6MCxTb3VyY2VCdWZmZXJMaXN0OjAsU3R5bGVTaGVldExpc3Q6MCxUZXh0VHJhY2tDdWVMaXN0OjAsVGV4dFRyYWNrTGlzdDowLFRvdWNoTGlzdDowfSxmcz1pLGxzPUFpLHBzPWljO2Zvcih2YXIgeXMgaW4gc3MpbHMoZnNbeXNdLHlzKSxwc1t5c109cHMuQXJyYXk7dmFyIGRzPW9jLGdzPXBlLGhzPSRlLmYsYnM9Z3MoIm1ldGFkYXRhIiksdnM9RnVuY3Rpb24ucHJvdG90eXBlO3ZvaWQgMD09PXZzW2JzXSYmaHModnMsYnMse3ZhbHVlOm51bGx9KSxmaSgiYXN5bmNEaXNwb3NlIiksZmkoImRpc3Bvc2UiKSxmaSgibWV0YWRhdGEiKTt2YXIgbXM9ZHMsd3M9YixTcz1vdCgiU3ltYm9sIiksT3M9U3Mua2V5Rm9yLGpzPXdzKFNzLnByb3RvdHlwZS52YWx1ZU9mKSxBcz1Tcy5pc1JlZ2lzdGVyZWRTeW1ib2x8fGZ1bmN0aW9uKHQpe3RyeXtyZXR1cm4gdm9pZCAwIT09T3MoanModCkpfWNhdGNoKGUpe3JldHVybiExfX07a3Ioe3RhcmdldDoiU3ltYm9sIixzdGF0OiEwfSx7aXNSZWdpc3RlcmVkU3ltYm9sOkFzfSk7Zm9yKHZhciBMcz1LdCxQcz1vdCxJcz1iLGtzPUF0LFRzPXBlLEVzPVBzKCJTeW1ib2wiKSxVcz1Fcy5pc1dlbGxLbm93blN5bWJvbCxGcz1QcygiT2JqZWN0IiwiZ2V0T3duUHJvcGVydHlOYW1lcyIpLHhzPUlzKEVzLnByb3RvdHlwZS52YWx1ZU9mKSxOcz1Mcygid2tzIiksTXM9MCxfcz1GcyhFcyksUnM9X3MubGVuZ3RoO01zPFJzO01zKyspdHJ5e3ZhciBCcz1fc1tNc107a3MoRXNbQnNdKSYmVHMoQnMpfWNhdGNoKHZmKXt9dmFyIENzPWZ1bmN0aW9uKHQpe2lmKFVzJiZVcyh0KSlyZXR1cm4hMDt0cnl7Zm9yKHZhciBlPXhzKHQpLHI9MCxuPUZzKE5zKSxvPW4ubGVuZ3RoO3I8bztyKyspaWYoTnNbbltyXV09PWUpcmV0dXJuITB9Y2F0Y2godmYpe31yZXR1cm4hMX07a3Ioe3RhcmdldDoiU3ltYm9sIixzdGF0OiEwLGZvcmNlZDohMH0se2lzV2VsbEtub3duU3ltYm9sOkNzfSksZmkoImN1c3RvbU1hdGNoZXIiKSxmaSgib2JzZXJ2YWJsZSIpLGtyKHt0YXJnZXQ6IlN5bWJvbCIsc3RhdDohMCxuYW1lOiJpc1JlZ2lzdGVyZWRTeW1ib2wifSx7aXNSZWdpc3RlcmVkOkFzfSksa3Ioe3RhcmdldDoiU3ltYm9sIixzdGF0OiEwLG5hbWU6ImlzV2VsbEtub3duU3ltYm9sIixmb3JjZWQ6ITB9LHtpc1dlbGxLbm93bjpDc30pLGZpKCJtYXRjaGVyIiksZmkoIm1ldGFkYXRhS2V5IiksZmkoInBhdHRlcm5NYXRjaCIpLGZpKCJyZXBsYWNlQWxsIik7dmFyIERzPXIobXMpLEdzPWIsSHM9RHIsVnM9cW4sV3M9Six6cz1HcygiIi5jaGFyQXQpLEtzPUdzKCIiLmNoYXJDb2RlQXQpLEpzPUdzKCIiLnNsaWNlKSxxcz1mdW5jdGlvbih0KXtyZXR1cm4gZnVuY3Rpb24oZSxyKXt2YXIgbixvLGk9VnMoV3MoZSkpLGE9SHMociksdT1pLmxlbmd0aDtyZXR1cm4gYTwwfHxhPj11P3Q/IiI6dm9pZCAwOihuPUtzKGksYSkpPDU1Mjk2fHxuPjU2MzE5fHxhKzE9PT11fHwobz1LcyhpLGErMSkpPDU2MzIwfHxvPjU3MzQzP3Q/enMoaSxhKTpuOnQ/SnMoaSxhLGErMik6by01NjMyMCsobi01NTI5Njw8MTApKzY1NTM2fX0sWXM9e2NvZGVBdDpxcyghMSksY2hhckF0OnFzKCEwKX0uY2hhckF0LFhzPXFuLCRzPURpLFFzPVpjLFpzPXRzLHRmPSJTdHJpbmcgSXRlcmF0b3IiLGVmPSRzLnNldCxyZj0kcy5nZXR0ZXJGb3IodGYpO1FzKFN0cmluZywiU3RyaW5nIiwoZnVuY3Rpb24odCl7ZWYodGhpcyx7dHlwZTp0ZixzdHJpbmc6WHModCksaW5kZXg6MH0pfSksKGZ1bmN0aW9uKCl7dmFyIHQsZT1yZih0aGlzKSxyPWUuc3RyaW5nLG49ZS5pbmRleDtyZXR1cm4gbj49ci5sZW5ndGg/WnModm9pZCAwLCEwKToodD1ZcyhyLG4pLGUuaW5kZXgrPXQubGVuZ3RoLFpzKHQsITEpKX0pKTt2YXIgbmY9cihlaS5mKCJpdGVyYXRvciIpKTtmdW5jdGlvbiBvZih0KXtyZXR1cm4ob2Y9ImZ1bmN0aW9uIj09dHlwZW9mIERzJiYic3ltYm9sIj09dHlwZW9mIG5mP2Z1bmN0aW9uKHQpe3JldHVybiB0eXBlb2YgdH06ZnVuY3Rpb24odCl7cmV0dXJuIHQmJiJmdW5jdGlvbiI9PXR5cGVvZiBEcyYmdC5jb25zdHJ1Y3Rvcj09PURzJiZ0IT09RHMucHJvdG90eXBlPyJzeW1ib2wiOnR5cGVvZiB0fSkodCl9dmFyIGFmPXIoZWkuZigidG9QcmltaXRpdmUiKSk7ZnVuY3Rpb24gdWYodCl7dmFyIGU9ZnVuY3Rpb24odCxlKXtpZigib2JqZWN0IiE9b2YodCl8fCF0KXJldHVybiB0O3ZhciByPXRbYWZdO2lmKHZvaWQgMCE9PXIpe3ZhciBuPXIuY2FsbCh0LGV8fCJkZWZhdWx0Iik7aWYoIm9iamVjdCIhPW9mKG4pKXJldHVybiBuO3Rocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIil9cmV0dXJuKCJzdHJpbmciPT09ZT9TdHJpbmc6TnVtYmVyKSh0KX0odCwic3RyaW5nIik7cmV0dXJuInN5bWJvbCI9PW9mKGUpP2U6ZSsiIn1mdW5jdGlvbiBjZih0LGUscil7cmV0dXJuKGU9dWYoZSkpaW4gdD9Ocih0LGUse3ZhbHVlOnIsZW51bWVyYWJsZTohMCxjb25maWd1cmFibGU6ITAsd3JpdGFibGU6ITB9KTp0W2VdPXIsdH1jbGFzcyBzZntjb25zdHJ1Y3Rvcih0KXtjZih0aGlzLCJfcG9zaXRpb24iLDApLGNmKHRoaXMsIl9kYXRhdmlldyIsdm9pZCAwKSx0aGlzLl9kYXRhdmlldz1uZXcgRGF0YVZpZXcodCl9Z2V0IGxlbmd0aCgpe3JldHVybiB0aGlzLmJ1ZmZlci5ieXRlTGVuZ3RofWdldCBidWZmZXIoKXtyZXR1cm4gdGhpcy5fZGF0YXZpZXcuYnVmZmVyfXNldCBwb3NpdGlvbih0KXt0aGlzLl9wb3NpdGlvbj10fWdldCBwb3NpdGlvbigpe3JldHVybiB0aGlzLl9wb3NpdGlvbn1iYWNrKHQpe3RoaXMucG9zaXRpb24tPXR9Z2V0VWludDgodCl7cmV0dXJuIHRoaXMuX2RhdGF2aWV3LmdldFVpbnQ4KHQpfWdldEludDgodCl7cmV0dXJuIHRoaXMuX2RhdGF2aWV3LmdldEludDgodCl9Z2V0SW50MTYodCl7cmV0dXJuIHRoaXMuX2RhdGF2aWV3LmdldEludDE2KHQpfWdldFVpbnQxNih0KXtyZXR1cm4gdGhpcy5fZGF0YXZpZXcuZ2V0VWludDE2KHQpfWdldFVpbnQzMih0KXtyZXR1cm4gdGhpcy5fZGF0YXZpZXcuZ2V0VWludDMyKHQpfWdldEludDMyKHQpe3JldHVybiB0aGlzLl9kYXRhdmlldy5nZXRJbnQzMih0KX1za2lwKHQpe2NvbnN0IGU9TWF0aC5mbG9vcih0LzQpLHI9dCU0O2ZvcihsZXQgbj0wO248ZTtuKyspc2YucmVhZEJ5dGUodGhpcyw0KTtyPjAmJnNmLnJlYWRCeXRlKHRoaXMscil9c3RhdGljIHJlYWRCeXRlKHQsZSxyKXtsZXQgbjtzd2l0Y2goZSl7Y2FzZSAxOm49cj90LmdldEludDgodC5wb3NpdGlvbik6dC5nZXRVaW50OCh0LnBvc2l0aW9uKTticmVhaztjYXNlIDI6bj1yP3QuZ2V0SW50MTYodC5wb3NpdGlvbik6dC5nZXRVaW50MTYodC5wb3NpdGlvbik7YnJlYWs7Y2FzZSAzOmlmKHIpdGhyb3cgbmV3IEVycm9yKCJub3Qgc3VwcG9ydGVkIGZvciByZWFkQnl0ZSAzIik7bj10LmdldFVpbnQ4KHQucG9zaXRpb24pPDwxNixufD10LmdldFVpbnQ4KHQucG9zaXRpb24rMSk8PDgsbnw9dC5nZXRVaW50OCh0LnBvc2l0aW9uKzIpO2JyZWFrO2Nhc2UgNDpuPXI/dC5nZXRJbnQzMih0LnBvc2l0aW9uKTp0LmdldFVpbnQzMih0LnBvc2l0aW9uKTticmVhaztjYXNlIDg6aWYocil0aHJvdyBuZXcgRXJyb3IoIm5vdCBzdXBwb3J0ZWQgZm9yIHJlYWRCb2R5IDgiKTtuPXQuZ2V0VWludDMyKHQucG9zaXRpb24pPDwzMixufD10LmdldFVpbnQzMih0LnBvc2l0aW9uKzQpO2JyZWFrO2RlZmF1bHQ6bj0iIn1yZXR1cm4gdC5wb3NpdGlvbis9ZSxufXJlYWRVaW50OCgpe3JldHVybiBzZi5yZWFkQnl0ZSh0aGlzLDEpfXJlYWRVaW50MTYoKXtyZXR1cm4gc2YucmVhZEJ5dGUodGhpcywyKX1yZWFkVWludDI0KCl7cmV0dXJuIHNmLnJlYWRCeXRlKHRoaXMsMyl9cmVhZFVpbnQzMigpe3JldHVybiBzZi5yZWFkQnl0ZSh0aGlzLDQpfXJlYWRVaW50NjQoKXtyZXR1cm4gc2YucmVhZEJ5dGUodGhpcyw4KX1yZWFkSW50OCgpe3JldHVybiBzZi5yZWFkQnl0ZSh0aGlzLDEsITApfXJlYWRJbnQxNigpe3JldHVybiBzZi5yZWFkQnl0ZSh0aGlzLDIsITApfXJlYWRJbnQzMigpe3JldHVybiBzZi5yZWFkQnl0ZSh0aGlzLDQsITApfXdyaXRlVWludDMyKHQpe3JldHVybiBuZXcgVWludDhBcnJheShbdD4+PjI0JjI1NSx0Pj4+MTYmMjU1LHQ+Pj44JjI1NSwyNTUmdF0pfX12YXIgZmY9KHQ9Pih0W3QuaW50ZXJuYWw9MF09ImludGVybmFsIix0W3QuZXh0ZXJuYWw9MV09ImV4dGVybmFsIix0W3QuYnlwYXNzPTJdPSJieXBhc3MiLHQpKShmZnx8e30pO2NvbnN0IGxmPW5ldyBVaW50OEFycmF5KFsxMDksMTY3LDUzLDE5MCwxMDMsOTAsNzIsMSwxNzAsODksNjMsMTY0LDE5NCwxOTksMTksODVdKSxwZj1uZXcgVWludDhBcnJheShbMTA5LDE2Nyw1MywxOTAsMTAzLDkwLDcyLDEsMTcwLDg5LDYzLDE2NCwxOTQsMTk5LDE5LDg0XSkseWY9bmV3IFVpbnQ4QXJyYXkoWzMxLDIzOSwzLDUwLDI0MiwxMjAsNzYsODUsMTY5LDQyLDE2MSw5MSw3NSwxODYsMjJdKTtmdW5jdGlvbiBkZih0KXtjb25zdCBlPVtdO2Zvcig7dD49MjU1Oyl0LT0yNTUsZS5wdXNoKDI1NSk7cmV0dXJuIGUucHVzaCh0KSxuZXcgVWludDhBcnJheShlKX1mdW5jdGlvbiBnZih0KXtsZXQgZT1hcmd1bWVudHMubGVuZ3RoPjEmJnZvaWQgMCE9PWFyZ3VtZW50c1sxXT9hcmd1bWVudHNbMV06MCxyPTA7Zm9yKDsyNTU9PT10W2VdJiZlPHQuYnl0ZUxlbmd0aDspZSsrLHIrPTI1NTtyZXR1cm4gZTx0LmJ5dGVMZW5ndGgmJihyKz10W2UrK10pLFtyLGVdfWNvbnN0IGhmPW5ldyBVaW50OEFycmF5KFs4MCwxXSk7Y2xhc3MgYmZ7c3RhdGljIGdlbmVyYXRlU0VJKHQsZSl7bGV0IHI9YXJndW1lbnRzLmxlbmd0aD4yJiZ2b2lkIDAhPT1hcmd1bWVudHNbMl0mJmFyZ3VtZW50c1syXTtjb25zdCBuPW5ldyBVaW50OEFycmF5KFswLDAsMCwxXSksbz1lP2hmOm5ldyBVaW50OEFycmF5KFs2XSksaT1uZXcgVWludDhBcnJheShbNV0pLGE9YmYuX191dWlkfHwocj9sZjpwZiksdT1kZih0LmJ5dGVMZW5ndGgrYS5ieXRlTGVuZ3RoKSxjPSh0PT57Y29uc3QgZT1bXTtsZXQgcj0wO2Zvcihjb25zdCBuIG9mIHQpcj49MiYmbjw9MyYmKGUucHVzaCgzKSxyPTApLDA9PT1uP3IrKzpyPTAsZS5wdXNoKG4pO3JldHVybiBuZXcgVWludDhBcnJheShlKX0pKHQpO3JldHVybiBuZXcgVWludDhBcnJheShbLi4ubiwuLi5vLC4uLmksLi4udSwuLi5hLC4uLmMsMTI4XSl9c3RhdGljIGRlY29kZVNFSUJvZHkodCxlKXtjb25zdCByPSh0PT57Y29uc3QgZT1bXTtmb3IobGV0IHI9MDtyPHQubGVuZ3RoO3IrKyl0W3JdPD0zJiYwPT09dFtyLTFdJiYwPT09dFtyLTJdfHxlLnB1c2godFtyXSk7cmV0dXJuIG5ldyBVaW50OEFycmF5KGUpfSkodD10LnNsaWNlKDAsdC5sZW5ndGgtMSkpO2lmKHIuYnl0ZUxlbmd0aDwyKXJldHVybjtsZXQgbj0wO2NvbnN0IG89ZT8yOjE7aWYoNSE9PXJbb10mJjEwMCE9PXJbb10pcmV0dXJuO24rPTErbztjb25zdFtpLGFdPWdmKHIsbik7bj1hO2xldCB1PTI7Y29uc3QgYz1uK2k7ci5ieXRlTGVuZ3RoPj1wZi5ieXRlTGVuZ3RoJiZpPj1wZi5ieXRlTGVuZ3RoJiYoci5zbGljZShuLG4rcGYuYnl0ZUxlbmd0aCkudG9TdHJpbmcoKT09PXBmLnRvU3RyaW5nKCl8fHIuc2xpY2UobixuK3lmLmJ5dGVMZW5ndGgpLnRvU3RyaW5nKCk9PT15Zi50b1N0cmluZygpKT8obis9cGYuYnl0ZUxlbmd0aCx1PTEpOnIuYnl0ZUxlbmd0aD49cGYuYnl0ZUxlbmd0aCYmaT49cGYuYnl0ZUxlbmd0aCYmci5zbGljZShuLG4rbGYuYnl0ZUxlbmd0aCkudG9TdHJpbmcoKT09PWxmLnRvU3RyaW5nKCkmJihuKz1sZi5ieXRlTGVuZ3RoLHU9MCk7cmV0dXJue3R5cGU6dSxwYXlsb2FkOnIuc2xpY2UobixjKX19c3RhdGljIHBhcnNlSW50ZXJuYWxTRUkodCl7Y29uc3QgZT1uZXcgTWFwO2xldCByPTA7aWYoMD09PXQudHlwZSl7Zm9yKDt0LnBheWxvYWQuYnl0ZUxlbmd0aC1yPj0yOyl7Y29uc3RbbixvXT1nZih0LnBheWxvYWQscik7cj1vO2NvbnN0W2ksYV09Z2YodC5wYXlsb2FkLHIpO2lmKHI9YSxlLmdldChuKXx8IShpPD10LnBheWxvYWQuYnl0ZUxlbmd0aC1yKSlicmVhaztlLnNldChuLHQucGF5bG9hZC5zbGljZShyLHIraSkpLHIrPWl9cmV0dXJuIGV9fXN0YXRpYyBtYWtlSW50ZXJuYWxTZWkodCl7Y29uc3QgZT1bXTtmb3IoY29uc3RbbyxpXW9mIHQpe2NvbnN0IHQ9ZGYobykscj1kZihpLmJ5dGVMZW5ndGgpO2UucHVzaCh0LHIsaSl9Y29uc3Qgcj1lLnJlZHVjZSgoKHQsZSk9PnQrZS5ieXRlTGVuZ3RoKSwwKSxuPW5ldyBVaW50OEFycmF5KHIpO3JldHVybiBlLnJlZHVjZSgoKHQsZSk9PihuLnNldChlLHQpLHQrZS5ieXRlTGVuZ3RoKSksMCksbn19Y2YoYmYsIl9fdXVpZCIsdm9pZCAwKSwidW5kZWZpbmVkIiE9dHlwZW9mIHNlbGYmJiJEZWRpY2F0ZWRXb3JrZXJHbG9iYWxTY29wZSI9PT1zZWxmLmNvbnN0cnVjdG9yLm5hbWUmJnNlbGYuYWRkRXZlbnRMaXN0ZW5lcigicnRjdHJhbnNmb3JtIiwoZT0+e2NvbnN0e3RyYW5zZm9ybWVyOnJ9PWUse3N0cmVhbUlkOm4sc2tpcEZpbHRlcjpvfT1yLm9wdGlvbnMsaT1mdW5jdGlvbihlKXtsZXR7cG9zdE1lc3NhZ2U6cixza2lwRmlsdGVyOm59PWU7cmV0dXJuIG5ldyBUcmFuc2Zvcm1TdHJlYW0oe3RyYW5zZm9ybShlLG8pe2NvbnN0IGk9dC5pc0gyNjVWaWRlb0ZyYW1lKGUpO3QuZ2V0TkFMVW5pdHMobmV3IHNmKGUuZGF0YSksaSkuZm9yRWFjaCgodD0+e2lmKHQuc2VpKXtjb25zdCBlPWJmLmRlY29kZVNFSUJvZHkodC5ib2R5LGkpO2UmJihufHxlLnR5cGU9PT1mZi5leHRlcm5hbCkmJnIoZSl9fSkpLG8uZW5xdWV1ZShlKX19KX0oe3Bvc3RNZXNzYWdlOnQ9PntzZWxmLnBvc3RNZXNzYWdlKHtzdHJlYW1JZDpuLG1zZzp0fSxbdC5wYXlsb2FkLmJ1ZmZlcl0pfSxza2lwRmlsdGVyOm99KTtyLnJlYWRhYmxlLnBpcGVUaHJvdWdoKGkpLnBpcGVUbyhlLnRyYW5zZm9ybWVyLndyaXRhYmxlKX0pKX0oKTsK",AD="undefined"!=typeof window&&window.Blob&&new Blob([atob(kD)],{type:"text/javascript;charset=utf-8"});function PD(){let e;try{if(e=AD&&(gP||window.webkitURL).createObjectURL(AD),!e)throw"";return new Worker(e)}catch(t){return new Worker("data:application/javascript;base64,"+kD)}finally{!("undefined"!=typeof window&&navigator.userAgent.indexOf("Trident/")>0)&&e&&(gP||window.webkitlRL).revokeObjectURL(e)}}var ND=(e=>(e.RECONNECT="ice-reconnect",e.LEAVE="leave_room",e))(ND||{});const wD=DI.NORMAL_MODE;class OD{constructor(e,t,i){Xu(this,"engineDestroyed",!1),Xu(this,"avSync",!0),Xu(this,"callId",void 0),Xu(this,"streamRTT",{}),Xu(this,"useCloudProxy",!1),Xu(this,"videoProfile",void 0),Xu(this,"audioProfileManager",void 0),Xu(this,"extensionManager",void 0),Xu(this,"userPriority",new Map),Xu(this,"expectedIDC",void 0),Xu(this,"autoPlayPolicy",void 0),Xu(this,"joinRoomConfig",void 0),Xu(this,"signalingManager",void 0),Xu(this,"peerConnection",void 0),Xu(this,"pubSubLock",new qN("pubSubLock")),Xu(this,"pcKillSwitch",Fu({ctor_sdpsemantics_add:!0,ctor_encodedinsetablestream_add:!0,sld_rtcpfb_rrtr_add:!0,sld_ext_sdesmid_remove:!0,sld_fmtp_sps_add:!0,sld_fmtp_bitrate_add:!0,sld_fmtp_opus_add:!0},Qg("PC_KILLSWITCH"))),Xu(this,"visibility",!0),Xu(this,"rtsLimiter",{e2e:new CD(wD),e2s:new CD(wD),boradcast:new CD(wD),conf:void 0,rtsMode:wD}),Xu(this,"serverConfig",void 0),Xu(this,"mediaParams",void 0),Xu(this,"subscribeFallbackOption",void 0),Xu(this,"joinRoomParams",void 0),Xu(this,"isPreConnection",!1),Xu(this,"_handler",void 0),Xu(this,"monitor",void 0),Xu(this,"enableFallbackHandler",!!Qg("ENABLE_FALLBACK_HANDLER")),Xu(this,"enableStandardHandler",!!Qg("ENABLE_STANDARD_HANDLER")),Xu(this,"_businessId",void 0),Xu(this,"_userStreamConfig",new Map),Xu(this,"_localAudioTrackDumpConfig",{[$u.STREAM_INDEX_MAIN]:{callback:void 0,frameSize:void 0},[$u.STREAM_INDEX_SCREEN]:{callback:void 0,frameSize:void 0}}),Xu(this,"_remoteAudioTrackDumpConfig",{[$u.STREAM_INDEX_MAIN]:new Map,[$u.STREAM_INDEX_SCREEN]:new Map}),Xu(this,"_targetCodec",void 0),Xu(this,"_targetScreenCodec",void 0),Xu(this,"earMonitorSettings",{[$u.STREAM_INDEX_MAIN]:{position:Ah.NONE,volume:100},[$u.STREAM_INDEX_SCREEN]:{position:Ah.NONE,volume:100}}),Xu(this,"localVideoTrack",void 0),Xu(this,"localAudioTrack",void 0),Xu(this,"publicAudioVolume",new Map),Xu(this,"_receiveSEIWorker",void 0),this.id=e,this.appId=t,this.monitor=uS(e),this.expectedIDC=null==i?void 0:i.expectedIDC,this.autoPlayPolicy=null==i?void 0:i.autoPlayPolicy,this.audioProfileManager=new Iw(t),this.extensionManager=new VP(e),this.joinRoomConfig=new Ig(e),this.signalingManager=new TD(this),this.videoProfile=new RD(this)}set businessId(e){var t;this._businessId=e,null===(t=this.monitor)||void 0===t||t.set({rtc_business_id:e})}get businessId(){return this._businessId}set handler(e){var t;e&&this.resetPubSubLock("ice-reconnect"),null===(t=this._handler)||void 0===t||t.destroy(),this._handler=e}get handler(){return this._handler}get role(){return this.visibility?ID.NORMAL_USER:ID.SILENT_USER}set targetCodec(e){e&&[YI.H264,YI.VP8,YI.ByteVC1].forEach((t=>{e.toLowerCase()===t.toLowerCase()&&(this._targetCodec=t)}))}set targetScreenCodec(e){e&&[YI.H264,YI.VP8,YI.ByteVC1].forEach((t=>{e.toLowerCase()===t.toLowerCase()&&(this._targetScreenCodec=t)}))}get targetCodec(){return this._targetCodec}get targetScreenCodec(){return this._targetScreenCodec}resetPubSubLock(e){this.pubSubLock.closeReason=e,this.pubSubLock=new qN("pubSubLock")}setUserStreamConf(e,t,i){const o=this._userStreamConfig.get(e)||{},r=o[t]||{};o[t]=Fu(Fu({},r),i),this._userStreamConfig.set(e,o)}getRemoteMirrorType(e,t){var i;return!(null===(i=this._userStreamConfig.get(e))||void 0===i||null===(i=i[t])||void 0===i||!i.mirrorType)}get rtsMode(){return this.rtsLimiter.rtsMode}setRTSMode(e){this.rtsLimiter.e2e.setLimitMode(e),this.rtsLimiter.boradcast.setLimitMode(e),this.rtsLimiter.e2s.setLimitMode(e),this.rtsLimiter.rtsMode=e}setRtsQpsConf(e){this.rtsLimiter.e2e.setQPS(null==e?void 0:e.rts_qps_interval,null==e?void 0:e.rts_e2e_qps_value),this.rtsLimiter.boradcast.setQPS(null==e?void 0:e.rts_qps_interval,null==e?void 0:e.rts_broadcast_qps_value),this.rtsLimiter.e2s.setQPS(null==e?void 0:e.rts_qps_interval,null==e?void 0:e.rts_e2s_qps_value),this.rtsLimiter.conf=e}get receiveSEIWorker(){return this._receiveSEIWorker||(this._receiveSEIWorker=new PD),this._receiveSEIWorker}updatePCKillSwitch(e){this.pcKillSwitch=Fu(Fu({},this.pcKillSwitch),e)}destroy(){this.engineDestroyed=!0,this.signalingManager.destroy(),this.userPriority.clear(),this.avSync=!0,this._localAudioTrackDumpConfig={[$u.STREAM_INDEX_MAIN]:{callback:void 0,frameSize:void 0},[$u.STREAM_INDEX_SCREEN]:{callback:void 0,frameSize:void 0}},this._remoteAudioTrackDumpConfig[$u.STREAM_INDEX_MAIN].clear(),this._remoteAudioTrackDumpConfig[$u.STREAM_INDEX_SCREEN].clear(),this.extensionManager.destroy(),this.earMonitorSettings={[$u.STREAM_INDEX_MAIN]:{position:Ah.NONE,volume:100},[$u.STREAM_INDEX_SCREEN]:{position:Ah.NONE,volume:100}},this.publicAudioVolume.clear()}}function MD(e,t,i){const o=i.value;return i.value=async function(){var e,t;const i=await this._ctx.pubSubLock.lock();"chrome"!==(null===(e=this._ctx.handler)||void 0===e?void 0:e.name)&&"standard"!==(null===(t=this._ctx.handler)||void 0===t?void 0:t.name)||i();try{const{closeReason:e}=this._ctx.pubSubLock;if(e)throw new Cg(Eg.UNEXPECTED_ERROR,e);for(var r=arguments.length,s=new Array(r),n=0;n<r;n++)s[n]=arguments[n];return await o.apply(this,s)}finally{var a,d;"chrome"!==(null===(a=this._ctx.handler)||void 0===a?void 0:a.name)&&"standard"!==(null===(d=this._ctx.handler)||void 0===d?void 0:d.name)&&i()}},i}function LD(e,t,i){const o=i.value;return i.value=async function(){var e;if(null!==(e=this._room)&&void 0!==e&&e.config.isRTSOnlyRoom())throw new Cg(Eg.NOT_ALLOWED_IN_RTS_ROOM,"Engine.".concat(t,"() is not allowed in RTS room"));for(var i=arguments.length,r=new Array(i),s=0;s<i;s++)r[s]=arguments[s];return await o.apply(this,r)},i}const xD=sE()||rE();class VD extends eD{constructor(e,t){super(e,t),Xu(this,"_peerConnectionId",Jy()),Xu(this,"peerConnectionMode",1),Xu(this,"name","vendor"),Xu(this,"direction","up"),Xu(this,"stream",void 0),t.on("ice_state",(e=>{this._report("rtc_ice_state",{pc_session_id:this.peerConnectionId,direction:this.direction,error_code:0,ice_state:e.toUpperCase(),message:"",peer_connection_id:this.peerConnectionId,stream_id:"",stream_user_id:""})})),t.on("disconnect",(()=>{this.emit("disconnect")}))}async publish(e){this._context.videoProfile.closeSimulcast(),this.stream=e;const{videoDescriptions:t,subVideoDescriptions:i,audioTransceiverInit:o,videoTransceiverInit:r}=super.internalPublish(e);e.audioTransceiver=this._peerConnection.addTransceiver(o.track,o.init),e.videoTransceiver=this._peerConnection.addTransceiver(r.track,r.init),xD&&(e.initAudioEncodedTransform(),e.initVideoEncodedTransform()),this._report("rtc_begin_create_offer",{direction:"up",stream_id:"",stream_user_id:"",pc_session_id:this.peerConnectionId,vendor_mode:(null==e?void 0:e.vendorCode)||0});const s=await this.peer.createOfferSdp(),n=jy(),a=Aw.parse(s);Array.isArray(a.media)&&(a.media=a.media.map((e=>{if("video"===e.type)(ZS||qS)&&Array.isArray(e.ext)&&(e.ext=e.ext.filter((e=>{var t;return!(null!=e&&null!==(t=e.uri)&&void 0!==t&&t.includes("video-orientation"))}))),ZS||this.addBitrateLimit(e,this._context.videoProfile.getVideoEncodeConfig()[0].maxKbps);else if("audio"===e.type){const i=null==e?void 0:e.rtp.find((e=>"opus"===e.codec));if(i&&e.fmtp){var t;const o=e.fmtp.find((e=>e.payload===i.payload));o&&null!==(t=this._context)&&void 0!==t&&t.audioProfileManager&&(o.config=this._context.audioProfileManager.getOpusConfigStr(o.config))}}return e})));const d={type:"offer",sdp:Aw.write(a)};try{await this._peerConnection.setLocalDescription(d),this._report("rtc_set_description",{error_code:0,message:d.sdp||"",is_local:"1",direction:"up",stream_id:"",stream_user_id:"",elapse:jy()-n},{type:"offer"})}catch(c){throw this._report("rtc_set_description",{error_code:-1,message:c.message+d.sdp,is_local:"1",direction:"up",stream_id:"",stream_user_id:"",elapse:jy()-n},{type:"offer"}),c}return{partialSdp:d.sdp||"",audioMid:"0",videoMid:"1",type:"offer",semantics:"unified-plan",videoDescriptions:t,subVideoDescriptions:i,audioTransceiverInit:o,videoTransceiverInit:r,peerConnectionMode:this.peerConnectionMode,peerConnectionId:this.peerConnectionId}}async subscribe(e){this.stream=e,this.direction="down",e.audioTransceiver=this._peerConnection.addTransceiver("audio",{direction:"recvonly"}),e.videoTransceiver=this._peerConnection.addTransceiver("video",{direction:"recvonly"}),xD&&(e.initAudioEncodedTransform(),e.initVideoEncodedTransform()),this._report("rtc_begin_create_offer",{direction:"down",stream_id:e.streamId,stream_user_id:e.userId,pc_session_id:this.peerConnectionId,vendor_mode:e.vendorCode||0});const t=await this.peer.createOfferSdp(),i=jy(),o=Aw.parse(t);Array.isArray(o.media)&&(o.media=o.media.map((e=>{if("audio"===e.type){const t=null==e?void 0:e.rtp.find((e=>"opus"===e.codec));if(t&&null!=e&&e.fmtp){const i=null==e?void 0:e.fmtp.find((e=>e.payload===t.payload));i&&this._context&&(i.config+=";stereo=1;sprop-stereo=1")}}return e})));const r={type:"offer",sdp:Aw.write(o)};try{await this._peerConnection.setLocalDescription(r),this._report("rtc_set_description",{error_code:0,message:r.sdp||"",is_local:"1",direction:"down",stream_id:e.streamId,stream_user_id:e.userId,elapse:jy()-i},{type:"offer"})}catch(s){throw this._report("rtc_set_description",{error_code:-1,message:s.message+r.sdp,is_local:"1",direction:"down",stream_id:e.streamId,stream_user_id:e.userId,elapse:jy()-i},{type:"offer"}),s}return{partialSdp:r.sdp||"",audioMid:"0",videoMid:"1",type:"offer",semantics:"unified-plan",peerConnectionMode:this.peerConnectionMode,peerConnectionId:this.peerConnectionId}}async handleAck(e){if(e.action===oD.publish||e.action===oD.subscribe){const{signalingAck:n,videoMid:a,videoCodec:d}=e,{sdp:c}=n,l=Aw.parse(c);l.media=l.media.map((e=>(e.mid===a&&d&&tO(e,d),e)));const u={sdp:Aw.write(l),type:"answer"},h=jy();try{var t,i;await this._peerConnection.setRemoteDescription(u),this._report("rtc_set_description",{error_code:0,message:u.sdp||"",is_local:"1",direction:"down",stream_id:(null===(t=e.stream)||void 0===t?void 0:t.streamId)||"",stream_user_id:null===(i=e.stream)||void 0===i?void 0:i.userId,elapse:jy()-h},{type:"answer"})}catch(s){var o,r;throw this._report("rtc_set_description",{error_code:-1,message:s.message+u.sdp,is_local:"1",direction:"down",stream_id:(null===(o=e.stream)||void 0===o?void 0:o.streamId)||"",stream_user_id:null===(r=e.stream)||void 0===r?void 0:r.userId,elapse:jy()-h},{type:"offer"}),s}"function"==typeof e.onSuccess&&e.onSuccess()}else e.action!==oD.unpublish&&e.action!==oD.unsubscribe||this.destroy();return""}destroy(){this.peer.destroy(),super.destroy()}async getDefaultSdp(){return{sdp:"",type:"offer",semantics:""}}connect(){throw new Error("Method not implemented.")}async rollback(){try{this._peerConnection.close()}catch(e){}}get peerConnectionId(){return this._peerConnectionId}set peerConnectionId(e){this._peerConnectionId=e}}var DD=Object.defineProperty,UD=Object.getOwnPropertyDescriptor,ZD=(e,t,i,o)=>{for(var r,s=o>1?void 0:o?UD(t,i):t,n=e.length-1;n>=0;n--)(r=e[n])&&(s=(o?r(t,i,s):r(s))||s);return o&&s&&DD(t,i,s),s};class WD extends kI{constructor(e,t){super(),Xu(this,"_logger",void 0),Xu(this,"_pubBackOff",new Map),this._ctx=e,this._roomConf=t,this._logger=new LS("RoomPublisher",2,e.id)}async hasPublished(e){return!!e.audioMid&&!!e.videoMid}async publish(e){return this._publish(e)}async _publish(e){var t,i,o,r,s,n,a,d,c,l;this._logger.info("publish()","localStream: %o",e);const{videoTrack:u}=e,{audioTrack:h}=e,_=jy();let m,{handler:p}=this._ctx;this._roomConf.vendorConfig.enableMultiVendor?[p,m]=await this._getVendorPubSdpInfo(e):m=await this._ctx.handler.publish(e),this.emit("_test_pub_sdpInfo_",m);const{audioMid:v,videoMid:f}=m;e.pubAttributes={localaudio:!!h,localvideo:!!u,videostream:e.pubVideo,audiostream:e.pubAudio,extvideo:(null==u?void 0:u.sourceType)===ZI.EXTERNAL,extaudio:(null==h?void 0:h.sourceType)===ZI.EXTERNAL,videoDescriptions:m.videoDescriptions,videoType:UI.NORMAL};const S={attributes:Fu({},e.pubAttributes),audio:!0,video:!0,screen:e.isScreen,audioMid:v,videoMid:f,sdpInfo:{msid:e.stream.id,type:m.type,sdp:m.partialSdp,semantics:m.semantics},peerConnectionMode:null===(t=m)||void 0===t?void 0:t.peerConnectionMode,supportMultiVendor:!0},g=!this._roomConf.vendorConfig.enableMultiVendor&&e.enableSimulcast&&(null===(i=this._ctx.serverConfig)||void 0===i?void 0:i.simulcastOnDemand)&&(null===(o=m.subVideoDescriptions)||void 0===o?void 0:o.length);let y;(g||null!==(r=this._ctx.serverConfig)&&void 0!==r&&r.e2eFeedback)&&(S.attributes.subVideoDescriptions=m.subVideoDescriptions),null!==(s=m)&&void 0!==s&&s.peerConnectionId&&(S.peerConnectionId=m.peerConnectionId);try{this.emit("_test_pub_body_",S),y=await this._ctx.signalingManager.sendSignaling("publish",S)}catch(k){var b,T;if(this._logger.error("_publish",Sb(k)),null===(b=this._ctx.monitor)||void 0===b||b.report("rtc_error",{message:"[publisher._publish] ".concat(Sb(k)),error_code:-1}),k instanceof Error?this._roomConf.report("rtc_publish_stat",{result:"fail",is_screen:"0",start:_,message:"".concat(k.name,": ").concat(k.message)}):k instanceof Cg&&this._roomConf.report("rtc_publish_stat",{result:"fail",is_screen:"0",start:_,message:"".concat(k.code,": ").concat(k.message)}),await(null===(T=p)||void 0===T?void 0:T.rollback({msid:e.stream.id,stream:e,audioMid:v,videoMid:f})),k.code>=500&&k.code<600){this.emit("_test_pub_5xx_");const t=this._getPubBackOff(e.id);if(t.retryDuration<6e4)return this._logger.info("pubRetry",e.id,t.retryDuration),await new Promise((e=>setTimeout(e,t.interval))),t.retryDuration+=t.interval,t.interval=t.interval>4e3?8e3:2*t.interval,e.resetStream(),this.emit(wN.PUB_RETRY,{screen:e.isScreen}),this._publish(e);this._logger.info("pubRetry","end"),this._pubBackOff.delete(e.id)}else if(403===k.code)throw new Cg(Eg.TOKEN_NO_PUBLISH_PERMISSION,k.message||"token no publish permission");throw k}var I,E;(this._roomConf.report("rtc_recv_answer",{error_code:0,answer_type:null===(n=y)||void 0===n?void 0:n.relayMessage.type,sequence_id:(null===(a=y)||void 0===a||null===(a=a.relayMessage)||void 0===a?void 0:a.sequenceId)||0,message:null===(d=y)||void 0===d||null===(d=d.relayMessage)||void 0===d?void 0:d.sdp,direction:"up",stream_id:"",stream_user_id:"",pc_session_id:(null===(c=p)||void 0===c?void 0:c.peerConnectionId)||""}),e.isScreen)?e.setVideoCaps(null===(I=y.relayMessage.content)||void 0===I?void 0:I.screenCaps):e.setVideoCaps(null===(E=y.relayMessage.content)||void 0===E?void 0:E.videoCaps);e.streamId=y.streamId;const R=await e.getSelectedCodec();e.currentVideoCodec=R;const C=new Promise(((t,i)=>{var o,r,s,n,a;null===(o=p)||void 0===o||o.handleAck({action:oD.publish,streamId:y.streamId,audioMid:v,videoMid:f,audioTransceiverInit:null===(r=m)||void 0===r?void 0:r.audioTransceiverInit,videoTransceiverInit:null===(s=m)||void 0===s?void 0:s.videoTransceiverInit,signalingAck:{sdp:null===(n=y)||void 0===n||null===(n=n.relayMessage)||void 0===n?void 0:n.sdp,sequenceId:null===(a=y)||void 0===a||null===(a=a.relayMessage)||void 0===a?void 0:a.sequenceId},stream:e,videoCodec:R,onSuccess:()=>{this._logger.info("publish()","publish success"),t(0)},onFail:e=>{this._logger.info("publish()","publish fail"),i(e)}})}));!US&&await C,this.emit("___afterHandleAckInPub"),(g&&this._ctx.videoProfile.getSimulcastMode()===Ch.VIDEO_ON_DEMAND||null!==(l=this._ctx.serverConfig)&&void 0!==l&&l.e2eFeedback)&&this.emit(MI.RSCP,[{StreamIds:[e.stream.id],Metadata:{VideoIndex:0}}],!0),e.videoMid=f,e.audioMid=v,e.subVideoDescriptions=m.subVideoDescriptions,e.remoteSdp=y.relayMessage.sdp,this._roomConf.report("rtc_publish_stat",{result:"success",is_screen:"0",start:_,message:"unknown"})}async updatePubTrack(e){this._logger.info("updatePubTrack()","localStream: %o",e);const{videoTrack:t,audioTrack:i,pubAudio:o,pubVideo:r}=e,s=e.vendorHandler||this._ctx.handler;let n=null==i?void 0:i.preprocessingTrack;const a=null==t?void 0:t.preprocessingTrack;var d,c;r&&a?(e.stopBlackFrame(),await(null===(d=e.videoTransceiver)||void 0===d?void 0:d.sender.replaceTrack(a)),this._updateVideoDescriptions(e)):await(null===(c=e.videoTransceiver)||void 0===c?void 0:c.sender.replaceTrack(null));if(o&&n){var l;const{mixType:t,mixedAudioTrack:o}=i;o&&t!==Oh.PLAYOUT&&n.enabled&&(n=o),await(null===(l=e.audioTransceiver)||void 0===l?void 0:l.sender.replaceTrack(n))}else{var u;await(null===(u=e.audioTransceiver)||void 0===u?void 0:u.sender.replaceTrack(null)),fS(this._ctx.id,"MediaClient.updatePubTrack(audio)","null")}await this._updatePublishCodec(e),this.emit("___onAfterReplaceTrack");try{fS(this._ctx.id,"MediaClient.updatePubTrack",JSON.stringify({audioStreamTrack:am(n),videoStreamTrack:am(a)}))}catch(wZ){}const h={localaudio:!!i,localvideo:!!t,videostream:r,audiostream:o,extvideo:(null==t?void 0:t.sourceType)===ZI.EXTERNAL,extaudio:(null==i?void 0:i.sourceType)===ZI.EXTERNAL,videoType:t?UI.NORMAL:e.pubAttributes.videoType},_={};for(const[p,v]of Object.entries(h))v!==Reflect.get(e.pubAttributes,p)&&Reflect.set(_,p,v);if(!Object.keys(_).length)return;if(e.observer){const{observer:t}=e,{audiostream:i,videostream:o,localaudio:r,localvideo:s,extaudio:n,extvideo:a}=_;void 0!==s?void 0!==a?t.setPushVideo(a):t.setEnableVideo(s):void 0!==o&&t.setUnmuteVideo(o),void 0!==r?void 0!==n?t.setPushAudio(n):t.setEnableAudio(r):void 0!==i&&t.setUnmuteAudio(i)}e.pubAttributes=Fu(Fu({},e.pubAttributes),h),e.pubAttributes.videostream||e.stopBlackFrame();const m={roomId:this._roomConf.roomId,streamId:e.streamId,attributes:_};await this._ctx.signalingManager.sendSignaling("updateStreamAttributes",m),this.emit("___onAfterUpdateSignaling"),US&&await(null==s?void 0:s.setCurrentDescription())}async _updatePublishCodec(e){this._logger.info("updatePublishCodec()","localStream: %o",e);const{audioMid:t,videoMid:i,remoteSdp:o,streamId:r,currentVideoCodec:s}=e,n=await e.getSelectedCodec();if(this._logger.info("updatePublishCodec()","selectedCodec: %o",n),n!==s){if(e.currentVideoCodec=n,t&&i&&r&&o){var a;if(this._ctx.handler instanceof cD||this._ctx.handler instanceof lD)await(null===(a=this._ctx.handler)||void 0===a?void 0:a._internalChangePubCodec());return new Promise(((s,a)=>{var d;null===(d=this._ctx.handler)||void 0===d||d.handleAck({action:oD.publish,streamId:r,audioMid:t,videoMid:i,signalingAck:{sdp:o,sequenceId:-1},videoCodec:n,onSuccess:s,onFail:a,stream:e})}))}{const t=["audioMid","videoMid","streamId","remoteSdp"].filter((t=>!Reflect.get(e,t)));this._logger.warn("updatePublishCodec()","fast return, because params: %o",t)}}else this._logger.warn("updatePublishCodec()","selectedCodec is equal to currentVideoCodec")}async unpublish(e){this._logger.info("unpublish()","localStream: %o",e);const t={roomId:this._roomConf.roomId,initStreamId:e.initStreamId,streamId:e.streamId};this._ctx.signalingManager.sendSignaling("unpublish",t).catch((()=>{}));const i=e.vendorHandler||this._ctx.handler;e.stopBlackFrame(),await(null==i?void 0:i.handleAck({action:oD.unpublish,audioMid:e.audioMid,videoMid:e.videoMid,stream:e,streamId:e.streamId}))}async updatePubBlackFrame(e){var t;const i=e.genBlackFrame();i&&(null===(t=e.videoTransceiver)||void 0===t||null===(t=t.sender)||void 0===t||t.replaceTrack(i),e.pubAttributes.videoType=UI.BLACK,this._ctx.signalingManager.sendSignaling("updateStreamAttributes",{roomId:this._roomConf.roomId,streamId:e.streamId,attributes:{videoType:UI.BLACK}}),e.on("black-frame-ended",(()=>{var t;null===(t=e.videoTransceiver)||void 0===t||null===(t=t.sender)||void 0===t||t.replaceTrack(null),e.pubAttributes.videoType=UI.NORMAL,this._ctx.signalingManager.sendSignaling("updateStreamAttributes",{roomId:this._roomConf.roomId,streamId:e.streamId,attributes:{videoType:UI.NORMAL}})})))}async cleanStream(e){return this._logger.info("cleanStream()","localStream: %o",e),null==e?void 0:e.clean()}async destroyStream(e){return this._logger.info("destroyStream()","localStream: %o",e),null==e?void 0:e.destroy()}destroy(e){e.forEach((e=>{e&&(this.unpublish(e).catch((()=>{})),this.destroyStream(e).catch((()=>{})))})),this._pubBackOff.clear(),super.removeAllListeners()}async _updateVideoDescriptions(e){var t;const i=this._ctx.videoProfile.genVideoDescriptions(e),o=e.pubAttributes.videoDescriptions;if(o.length!==i.videoDescriptions.length)return;const r={};if(o.find(((e,t)=>{if(e.framerate!==i.videoDescriptions[t].framerate||e.maxkbps!==i.videoDescriptions[t].maxkbps||e.width!==i.videoDescriptions[t].width||e.height!==i.videoDescriptions[t].height)return r.videoDescriptions=i.videoDescriptions,!0})),null===(t=e.subVideoDescriptions)||void 0===t||t.find(((e,t)=>{if(e.framerate!==i.subVideoDescriptions[t].framerate||e.maxkbps!==i.subVideoDescriptions[t].maxkbps||e.width!==i.subVideoDescriptions[t].width||e.height!==i.subVideoDescriptions[t].height)return r.subVideoDescriptions=i.subVideoDescriptions,!0})),Object.keys(r).length>0){var s;this._ctx.signalingManager.sendSignaling("updateStreamAttributes",{roomId:this._roomConf.roomId,streamId:e.streamId,attributes:r});const t=null===(s=e.videoTransceiver)||void 0===s||null===(s=s.sender)||void 0===s?void 0:s.getParameters();var n;if(fS(this._ctx.id,"sender.getParameters",JSON.stringify(t),0,e.streamId),t&&Array.isArray(null==t?void 0:t.encodings))t.encodings=t.encodings.map(((e,o)=>{var r;return(null!==(r=e.rid)&&void 0!==r?r:1===t.encodings.length?"0":void 0)===i.sendEncodings[o].rid&&(e.maxBitrate=i.sendEncodings[o].maxBitrate,e.maxFramerate=i.sendEncodings[o].maxFramerate,e.scaleResolutionDownBy=i.sendEncodings[o].scaleResolutionDownBy),e})),this._logger.info("sender.setParameters()",JSON.stringify(t.encodings)),fS(this._ctx.id,"sender.setParameters",JSON.stringify(t),0,e.streamId),null===(n=e.videoTransceiver)||void 0===n||n.sender.setParameters(t),fS(this._ctx.id,"Handler.updateScaleResolutionDownBy",JSON.stringify(t.encodings))}}async _getVendorPubSdpInfo(e){const t=new _O(this._ctx,"");e.vendorHandler=new VD(this._ctx,t),e.pcSessionId&&(e.vendorHandler.peerConnectionId=e.pcSessionId);const i=await e.vendorHandler.publish(e),o=e.vendorHandler;return o.on("ice_state",(e=>{this.emit(LI.ON_VENDOR_CONNECTION_STATE_CHANGE,{state:{checking:ih.CONNECTION_STATE_CONNECTING,connected:ih.CONNECTION_STATE_CONNECTED,disconnected:ih.CONNECTION_STATE_RECONNECTING}[e],userId:this._roomConf.userId})})),o.once("disconnect",(async()=>{var t;o.removeAllListeners(),"connected"===(null===(t=this._ctx.peerConnection)||void 0===t?void 0:t.getIceConnectionState())?(await this.unpublish(e),await this.publish(e),e.vendorHandler&&e.statsReport.setVar(e.vendorHandler)):this._logger.info("vendor ice failed",e.streamId)})),[o,i]}_getPubBackOff(e){return this._pubBackOff.has(e)||this._pubBackOff.set(e,{interval:1e3,retryDuration:0}),this._pubBackOff.get(e)}}ZD([hw],WD.prototype,"hasPublished",1),ZD([hw,MD,uw],WD.prototype,"publish",1),ZD([hw,MD,uw],WD.prototype,"updatePubTrack",1),ZD([hw,MD,uw],WD.prototype,"unpublish",1),ZD([hw,uw],WD.prototype,"updatePubBlackFrame",1),ZD([hw],WD.prototype,"cleanStream",1),ZD([hw],WD.prototype,"destroyStream",1),ZD([uw],WD.prototype,"_updateVideoDescriptions",1);var XD=Object.defineProperty,GD=Object.getOwnPropertyDescriptor,FD=(e,t,i,o)=>{for(var r,s=o>1?void 0:o?GD(t,i):t,n=e.length-1;n>=0;n--)(r=e[n])&&(s=(o?r(t,i,s):r(s))||s);return o&&s&&XD(t,i,s),s};class HD extends kI{constructor(e,t){super(),Xu(this,"_logger",void 0),Xu(this,"_subBackOff",new Map),Xu(this,"_subResolves",{}),Xu(this,"_ontrackCallbackMap",new Map),this._ctx=e,this._roomConf=t,this._logger=new LS("RoomSubscriber",2,e.id)}async hasSubscribed(e){return e.streamState===AN.SUB_ED}async subscribe(e,t,i){if(e.streamState!==AN.SUB_ED)return this._subscribe(e,t,i);this._logger.warn("subscribe()","remoteStream ".concat(e.streamId," has been subscribed, silently return"))}async _subscribe(e,t,i){var o,r,s,n,a,d,c,l,u,h,_,m,p,v;this._logger.info("subscribe()","mediaType: %o",t),lw("subscribe()",e,this._logger),e.streamState=AN.SUB_ING;let f=!1,S=!1;if(rb(t)&&(S=!0),sb(t)&&(f=!0),!f&&this._roomConf.isMultiChatMode())return void(e.streamState=AN.INIT);const g=jy(),y=e.subVideo,b=[];this._subResolves[e.streamId]||(this._subResolves[e.streamId]=[]),b.push(new Promise(((t,i)=>{this._subResolves[e.streamId].push(t);const o=setTimeout((()=>i(new Cg(Eg.TIME_OUT,"wait video timeout for userId: ".concat(e.userId)))),cw),r=i=>{"video"===i.mediaType&&(this._logger.info("remoteStream ".concat(e.userId," received video track")),e.off("ontrack",r),clearTimeout(o),t(0))};e.on("ontrack",r)}))),this._roomConf.isMultiChatMode()||b.push(new Promise(((t,i)=>{this._subResolves[e.streamId].push(t);const o=setTimeout((()=>i(new Cg(Eg.TIME_OUT,"wait audio timeout for userId: ".concat(e.userId)))),cw),r=i=>{"audio"===i.mediaType&&(this._logger.info("remoteStream ".concat(e.userId," received audio track")),e.off("ontrack",r),clearTimeout(o),t(0))};e.on("ontrack",r)})));const T=t=>{e.ontrack(t)};null===(o=this._ctx.handler)||void 0===o||o.on("ontrack",T),this._ontrackCallbackMap.set(e,T);let I,{handler:E}=this._ctx;null!==(r=this._ctx.serverConfig)&&void 0!==r&&r.forceUniHandler||!e.enableVendorMode?I=await this._ctx.handler.subscribe(e,{multiChatMode:this._roomConf.isMultiChatMode()}):[E,I]=await this._getVendorSubSdpInfo(e,T);const{audioMid:R,videoMid:C}=I;e.subVideo=f;const k={spatialLayer:(null==i?void 0:i.spatialLayer)||0,temporalLayer:0,spatialSubLayer:(null==i?void 0:i.spatialSubLayer)||-1},A={audio:!this._roomConf.isMultiChatMode(),video:!0,data:!0,screen:e.isScreen,browser:"chrome-stable",videoMid:C,audioMid:R,sdpInfo:{sdp:null===(s=I)||void 0===s?void 0:s.partialSdp,semantics:null===(n=I)||void 0===n?void 0:n.semantics,type:null===(a=I)||void 0===a?void 0:a.type},streamUserId:e.userId,streamId:e.streamId,config:{enableMediaType:{audio:!!this._roomConf.isMultiChatMode()||S,video:f},qualityLayer:k},extra:{enableSendRTT:!0},peerConnectionMode:null===(d=I)||void 0===d?void 0:d.peerConnectionMode,supportMultiVendor:!0};null!==(c=I)&&void 0!==c&&c.peerConnectionId&&(A.peerConnectionId=I.peerConnectionId);const{subscribeFallbackOption:P,userPriority:N}=this._ctx;"number"==typeof P&&(A.config.fallbackOption=P),N.has(e.userId)&&(A.config.priority=N.get(e.userId)),null!==(l=I)&&void 0!==l&&l.allSsrc&&(A.extra.subscribeSSRC=I.allSsrc),this.emit("_test_before_ack_");const{signalingAck:w,audioTransceiverInit:O,videoTransceiverInit:M}=I;let L;w&&(e.videoMid=C,e.audioMid=R,await new Promise(((t,i)=>{var o;null===(o=E)||void 0===o||o.handleAck({action:oD.subscribe,streamId:e.streamId,audioMid:R,videoMid:C,audioTransceiverInit:O,videoTransceiverInit:M,signalingAck:w,stream:e,onSuccess:()=>{this._logger.info("ssrc","success"),t(0)},onFail:e=>{this._logger.info("ssrc","fail",e),i(e)}})})));try{this.emit("_test_sub_body_",A);const e=this._ctx.signalingManager.sendSignaling("subscribe",A);this.emit("_test_during_signaling_",A),L=await e}catch(H){var x,V;if(null===(x=this._ctx.monitor)||void 0===x||x.report("rtc_error",{message:"[subscriber._subscribe] ".concat(Sb(H)),error_code:-1}),e.streamState=AN.INIT,H instanceof Error&&this._roomConf.report("rtc_subscribe_stat",{result:"fail",start:g,message:H.message,stream_user_id:e.userId}),H.code>=500&&H.code<600){this.emit("_test_sub_5xx_");const o=this._getSubBackOff(e.streamId);var D;if(o.retryDuration<6e4)return this._logger.info("subRetry",e.streamId,o.retryDuration),await new Promise((e=>setTimeout(e,o.interval))),o.retryDuration+=o.interval,o.interval=o.interval>4e3?8e3:2*o.interval,this.emit(wN.SUB_RETRY,{screen:e.isScreen,userId:e.userId}),await(null===(D=E)||void 0===D?void 0:D.handleAck({action:oD.unsubscribe,streamId:e.streamId,audioMid:R,videoMid:C,stream:e})),e.resetStream(),this._subscribe(e,t,i);this._logger.info("subRetry","end",e.streamId),this._subBackOff.delete(e.streamId)}e.subVideo=y,await(null===(V=E)||void 0===V?void 0:V.rollback({msid:e.streamId,stream:e}));const o={roomId:this._roomConf.roomId,streamId:e.streamId,userId:e.userId};if(await this._ctx.signalingManager.sendSignaling("unsubscribe",o).catch((()=>{})),e.streamState=AN.INIT,403===H.code)throw new Cg(Eg.TOKEN_NO_SUBSCRIBE_PERMISSION,H.message||"token no subscribe permission");throw H}if(!L.relayMessage)throw this._roomConf.report("rtc_error",{error_code:-1009,message:"relayMessage is null"}),new Cg(Eg.UNEXPECTED_ERROR,"unable to subscribe");const{audioMid:U,videoMid:Z}=null!==(u=null===(h=L)||void 0===h?void 0:h.relayMessage)&&void 0!==u?u:{},W={[R]:U,[C]:Z};this._logger.info("sub midmap",e.userId,W),e.videoMid=C,e.audioMid=R,e.subMediaType=t,e.streamState=AN.SUB_ED,e.subLayer=k,this._roomConf.report("rtc_recv_answer",{error_code:0,answer_type:null===(_=L)||void 0===_||null===(_=_.relayMessage)||void 0===_?void 0:_.type,sequence_id:(null===(m=L)||void 0===m||null===(m=m.relayMessage)||void 0===m?void 0:m.sequenceId)||0,message:null===(p=L)||void 0===p||null===(p=p.relayMessage)||void 0===p?void 0:p.sdp,direction:"down",stream_id:e.streamId,stream_user_id:e.userId,pc_session_id:(null===(v=E)||void 0===v?void 0:v.peerConnectionId)||""});try{var X;null!==(X=I)&&void 0!==X&&X.signalingAck||await new Promise(((t,i)=>{var o,r,s,n,a;null===(o=E)||void 0===o||o.handleAck({action:oD.subscribe,streamId:e.streamId,audioMid:R,videoMid:C,audioTransceiverInit:null===(r=I)||void 0===r?void 0:r.audioTransceiverInit,videoTransceiverInit:null===(s=I)||void 0===s?void 0:s.videoTransceiverInit,signalingAck:{sdp:null===(n=L)||void 0===n||null===(n=n.relayMessage)||void 0===n?void 0:n.sdp,sequenceId:null===(a=L)||void 0===a||null===(a=a.relayMessage)||void 0===a?void 0:a.sequenceId},stream:e,onSuccess:()=>{this._logger.info("sub ack","success"),t(0)},onFail:e=>{this._logger.info("sub ack","fail",e),i(e)}})})),await Promise.all(b)}catch(H){var G,F;null===(G=this._ctx.monitor)||void 0===G||G.report("rtc_error",{message:"[subscriber._subscribe] ".concat(Sb(H)),error_code:-1}),H instanceof Error&&this._roomConf.report("rtc_subscribe_stat",{result:"fail",start:g,message:H.message,stream_user_id:e.userId});const t={roomId:this._roomConf.roomId,streamId:e.streamId,userId:e.userId};throw await this._ctx.signalingManager.sendSignaling("unsubscribe",t).catch((()=>{})),await(null===(F=E)||void 0===F?void 0:F.handleAck({action:oD.unsubscribe,streamId:e.streamId,audioMid:R,videoMid:C,stream:e})),e.streamState=AN.INIT,e.resetStream(),H}this._roomConf.isMultiChatMode()||(e.subAudio=S),this._roomConf.report("rtc_subscribe_stat",{result:"success",start:g,message:"unknown",stream_user_id:e.userId}),e.startReport((e=>this.emit("onRemoteStreamStats",e)),E)}async unsubscribe(e){var t,i;lw("unsubscribe()",e,this._logger);const o={roomId:this._roomConf.roomId,streamId:e.streamId,userId:e.userId},r=e.vendorHandler||this._ctx.handler;this._ctx.signalingManager.sendSignaling("unsubscribe",o).catch((()=>{})),e.streamState=AN.INIT,e.subVideo=!1,null===(t=e.observer)||void 0===t||t.setSubscribeVideo(!1),!this._roomConf.isMultiChatMode()&&(null===(i=e.observer)||void 0===i||i.setSubscribeAudio(!1));const s=await(null==r?void 0:r.handleAck({action:oD.unsubscribe,streamId:e.streamId,audioMid:e.audioMid,videoMid:e.videoMid,stream:e}));this._subResolves[s]&&this._subResolves[s].forEach((e=>e(0))),this._logger.info("unsubscribe","clean unsub ".concat(e.userId)),e.clean(),e.subMediaType=Hg.NONE,this._removeOnTrackListener(e),e.statsReport.unsubscribe()}async unsubscribe4removeTrack(e,t,i){var o,r,s,n;if(lw("unsubscribe4removeTrack()",e,this._logger),this._logger.info("unsubscribe4removeTrack()","sequenceId: ",t.sequenceId,"trackType: ",i),t.sequenceId<e.sequenceId)return void this._logger.warn("unsubscribe4removeTrack()","sequenceId return");const a=i+1,d=!!(a&eh.AUDIO),c=!!(a&eh.VIDEO);await(null===(o=this._ctx.handler)||void 0===o?void 0:o.handleAck({action:oD.removetrack,streamId:e.streamId,audioMid:e.audioMid,videoMid:e.videoMid,stream:e})),null===(r=e.observer)||void 0===r||r.setPushTrack(!1),null===(s=e.observer)||void 0===s||s.setUnmuteAudio(!d),e.subAudio=!d,null===(n=e.observer)||void 0===n||n.setUnmuteVideo(!c),e.subVideo=!c,e.subMediaType=e.subMediaType-(e.subMediaType&a),e.virtual&&(e.clean(),e.resetHasSubscribed(),e.statsReport.unsubscribe())}async handleRemoveStream(e){if(lw("handleRemoveStream()",e,this._logger),e.subVideo=!1,e.streamState!==AN.INIT)return this.unsubscribe(e)}_removeOnTrackListener(e){const t=this._ontrackCallbackMap.get(e);if(t){const i=e.vendorHandler||this._ctx.handler;null==i||i.off("ontrack",t),this._ontrackCallbackMap.delete(e)}}async _getVendorSubSdpInfo(e,t){const i=new _O(this._ctx,"");e.vendorHandler=new VD(this._ctx,i),e.pcSessionId&&(e.vendorHandler.peerConnectionId=e.pcSessionId);const o=e.vendorHandler;o.on("ontrack",t);const r=await e.vendorHandler.subscribe(e);return o.on("ice_state",(t=>{this.emit(LI.ON_VENDOR_CONNECTION_STATE_CHANGE,{state:{checking:ih.CONNECTION_STATE_CONNECTING,connected:ih.CONNECTION_STATE_CONNECTED,disconnected:ih.CONNECTION_STATE_RECONNECTING}[t],userId:e.userId})})),o.once("disconnect",(async()=>{var t;if(null==o||o.removeAllListeners(),"connected"!==(null===(t=this._ctx.peerConnection)||void 0===t?void 0:t.getIceConnectionState()))return void this._logger.info("vendor ice failed",e.streamId);const i=e.subMediaType;await this.unsubscribe(e),await this.subscribe(e,i),e.vendorHandler&&e.statsReport.setVar(e.vendorHandler),this.emit(wN.RESUBSCRIBE,{stream:e})})),[o,r]}async subscribe4pushTrack(e,t){var i,o,r;this._logger.info("subscribe4pushTrack()","streamInfo: %o",t),lw("subscribe4pushTrack()",e,this._logger),e.subAudio=!0;const s=await(null===(i=this._ctx.handler)||void 0===i?void 0:i.subscribe(e,{multiChatMode:this._roomConf.isMultiChatMode()}));if(!s)throw new Cg(Eg.ADD_TRANSCEIVER_FAILED,"add transceiver failed");const{audioMid:n}=s,{videoMid:a}=s,d=[];d.push(new Promise(((t,i)=>{const o=setTimeout((()=>i(new Cg(Eg.TIME_OUT,"wait audio timeout for userId: ".concat(e.userId)))),cw),r=i=>{"audio"===i.mediaType&&(this._logger.success("remoteStream ".concat(e.userId," received audio track")),e.off("ontrack",r),clearTimeout(o),t(0))};e.on("ontrack",r)})));const c=t=>{e.ontrack(t)};null===(o=this._ctx.handler)||void 0===o||o.on("ontrack",c),this._ontrackCallbackMap.set(e,c),await(null===(r=this._ctx.handler)||void 0===r?void 0:r.handleAck({action:oD.pushtrack,streamId:e.streamId,audioMid:n,videoMid:a,stream:e,audioTransceiverInit:null==s?void 0:s.audioTransceiverInit,videoTransceiverInit:null==s?void 0:s.videoTransceiverInit,signalingAck:null==t?void 0:t.message})),await Promise.all(d),e.videoMid=a,e.audioMid=n,e.startReport((e=>this.emit("onRemoteStreamStats",e)),this._ctx.handler)}async updateUserAttributes(e){this._logger.info("updateUserAttributes()","attributes: %o",e),await this._ctx.signalingManager.sendSignaling("updateUserAttributes",{roomId:this._roomConf.roomId,sessionId:this._roomConf.sessionId,attributes:e})}async updateSubTrackLayer(e,t){if(this._logger.info("updateSubTrack()","subLayer: %o",t),e.subLayer.spatialLayer===t.spatialLayer&&e.subLayer.spatialSubLayer===t.spatialSubLayer)return void this._logger.warn("updateSubTrack()","subLayer no change");const i={roomId:this._roomConf.roomId,streamList:[e.streamId],streamId:e.streamId,streamUserId:e.userId,config:{qualityLayer:t}};return await this._ctx.signalingManager.sendSignaling("updateSubscribe",i),this.emit("___afterUpdateSubscribeSend"),e.subLayer=t,e}async updateSubPriority(e,t){if(this._logger.info("updateSubPriority()","priority: %o",t),e.priority===t)return this._logger.warn("updateSubPriority()","priority no change"),e;const i={roomId:this._roomConf.roomId,streamList:[e.streamId],streamId:e.streamId,streamUserId:e.userId,config:{priority:t}};return await this._ctx.signalingManager.sendSignaling("updateSubscribe",i),e.priority=t,e}async updateSubMediaType(e,t){var i;let o=!1,r=!1;rb(t)&&(r=!0),sb(t)&&(o=!0);const s={roomId:this._roomConf.roomId,streamList:[e.streamId],config:{enableMediaType:{video:o,audio:!!this._roomConf.isMultiChatMode()||r}}};var n;(await this._ctx.signalingManager.sendSignaling("updateSubscribe",s),this._roomConf.isMultiChatMode())||(null===(n=e.observer)||void 0===n||n.setUnmuteAudio(r),e.subAudio=r);return null===(i=e.observer)||void 0===i||i.setUnmuteVideo(o),e.subVideo=o,e.subMediaType=t,e}async cleanStream(e){this._logger.info("cleanStream()","stream: %o",e),null==e||e.clean()}destroyStream(e){this._logger.info("destroyStream()","stream: %o",e),null==e||e.destroy()}destroy(e){var t;this._logger.info("destroy()","remoteStream: %o",e),e.forEach((e=>{this.unsubscribe(e).catch((()=>{})),this.destroyStream(e)})),this._subBackOff.clear(),this._ontrackCallbackMap.forEach(((e,t)=>{this._removeOnTrackListener(t),this._ontrackCallbackMap.delete(t)})),this._subResolves={},null===(t=this._ctx.handler)||void 0===t||t.removeAllListeners("ontrack"),super.removeAllListeners()}_getSubBackOff(e){return this._subBackOff.has(e)||this._subBackOff.set(e,{interval:1e3,retryDuration:0}),this._subBackOff.get(e)}}FD([hw],HD.prototype,"hasSubscribed",1),FD([hw,MD,uw],HD.prototype,"subscribe",1),FD([hw,MD,uw],HD.prototype,"unsubscribe",1),FD([hw,MD,uw],HD.prototype,"unsubscribe4removeTrack",1),FD([uw],HD.prototype,"handleRemoveStream",1),FD([hw,MD,uw],HD.prototype,"subscribe4pushTrack",1),FD([hw,uw],HD.prototype,"updateUserAttributes",1),FD([hw,uw],HD.prototype,"updateSubTrackLayer",1),FD([hw,uw],HD.prototype,"updateSubPriority",1),FD([hw],HD.prototype,"updateSubMediaType",1),FD([hw],HD.prototype,"cleanStream",1),FD([hw],HD.prototype,"destroyStream",1);const YD={[vh.communication]:[0],[vh.chat]:[0],[vh.chatRoom]:[1,"IES_chatroom"],[vh.coHost]:[1,"IES_PK"],[vh.meeting]:[16],[vh.classRoom]:[0]};class KD extends kI{constructor(e,t){super(),Xu(this,"_logger",void 0),Xu(this,"_authorization",void 0),Xu(this,"_joinRoom5xxTimer",void 0),Xu(this,"_joinTask",void 0),Xu(this,"_sdpInfo",void 0),this._ctx=e,this._roomConf=t,this._logger=new LS("RoomJoin",2,e.id),this._logger.info("constructor","invoke")}join(){let e,t,i=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this._logger.info("join()");const o=new Promise(((o,r)=>{e=o,t=r,this._callJoinRoom(i).catch((e=>{const t=Array.isArray(e)&&e.length>0?e[0]:e;this._joinRoomFailed(t.message)}))}));return this._joinTask&&i?this._joinTask.startTime=jy():(this._joinTask={startTime:jy(),success:e,fail:t},this._roomConf.joinPromise=o),this._reportJoinRoomStart(),o}async updateToken(e){if(this._logger.info("updateToken()","newToken: %o",e),!this._ctx.appId||!this._roomConf.userId||!this._roomConf.roomId)return;const t={roomId:this._roomConf.roomId,userId:this._roomConf.userId,appId:this._ctx.appId,token:"Bearer ".concat(e)};try{await this._ctx.signalingManager.sendSignaling("updateToken",t)}catch(i){throw new Cg(Eg.UPDATE_TOKEN_WITH_INVALID_TOKEN,"invoke updateToken with an invalid token")}}async leave(){this._logger.info("leave()"),this._stopJoinRoom5xxRetry(),this._joinRoomFailed("leave_room");const e={Authorization:this._authorization,roomId:this._roomConf.roomId,sessionId:this._roomConf.sessionId};if(await this._ready2join(),!this._ctx.signalingManager.isConnected())return Promise.reject(new Cg(Eg.NOT_CONNECTED_YET,"server not connected"));await this._ctx.signalingManager.sendSignaling("leaveRoom",e,this._roomConf.rtsOnlySignalHeader)}destroy(){this._logger.info("destroy()"),this._joinRoomFailed("leave_room"),this._authorization=void 0,this._stopJoinRoom5xxRetry(),this.removeAllListeners()}async _ready2join(){var e;(await this._ctx.signalingManager.connect(),this._sdpInfo)||(this._sdpInfo=await(null===(e=this._ctx.handler)||void 0===e?void 0:e.getDefaultSdp()));return KD.supportedCodecs||(KD.supportedCodecs=await KI()),{sdpInfo:this._sdpInfo,supportedCodecs:KD.supportedCodecs}}async _callJoinRoom(e){var t,i;this._logger.info("_callJoinRoom","invoke"),delete this._sdpInfo;const{appId:o,role:r,businessId:s,useCloudProxy:n,joinRoomParams:a,mediaParams:d}=this._ctx,{sdpInfo:c,supportedCodecs:l}=await this._ready2join(),u={Authorization:Qy.token2auth(o,this._roomConf.roomId,this._roomConf.userId,this._roomConf.token),sessionId:this._roomConf.sessionId,timestamp:Date.now(),controlMessage:this._roomConf.getLiveControlMessage(),userAttributes:{extra_info:this._roomConf.userInfo.extraInfo,role:r},sdpInfo:c,params:{supportedCodecs:l,userAgent:window.navigator.userAgent,sdkVersion:jg.VERSION,deviceId:bg.getDeviceId(),appId:o,roomId:this._roomConf.roomId,userId:this._roomConf.userId,businessId:s,enableCloudProxy:n,channelProfile:YD[this._roomConf.roomProfileType]?"".concat(YD[this._roomConf.roomProfileType][0]):"0",SDKCodecNegotiation:Qg("SDK_CODEC_NEGOTIATION"),sdkType:"rtc",joinRoomMode:this._roomConf.isRTSOnlyRoom()?2:1,deviceType:"web",platformType:2,rtsMode:this._ctx.rtsMode,mediaProcessingType:null!==(t=jg.MEDIA_PROCESSING_TYPE)&&void 0!==t?t:0},options:{supportCheckTokenPrivilege:!0,supportTokenExpireCallBack:!0,enableSceneConfigV2:!0,enableUnBundleMode:!0,enableAudioMux:!0,enableBigRoomMode:!0,needNegotiateSDP:!0,supportMultiVendor:!0},accessParams:JSON.stringify({requireICEUfragV2:!0})};if("AREA_CODE_US_OPCO"===Qg("AREA_CODE")&&(u.params.mediaArea=JSON.stringify([{AreaList:["GEO:US_OPCO"],Attribute:"include"}])),a)for(const[b,T]of Object.entries(a))u.params[b]=T;d&&(u.mediaParams=d);Qg("SIGNAL_CROP_JOINROOM")&&null!==(i=u.sdpInfo)&&void 0!==i&&i.sdp&&(u.sdpInfo.sdp=(e=>{const t=Aw.parse(e);return t.media=t.media.map((e=>"audio"===e.type?rO(e,t):oO(e,["H264","VP8","ByteVC1"],t))),Aw.write(t)})(u.sdpInfo.sdp)),Promise.resolve().then((()=>this.emit("onSendingJoinMessageHook")));try{var h,_,m,p;const t=e?"reconnected":"joinRoom",i=await this._joinRoomWithRetry(t,u);this._logger.success("join","send join message success");const{engine_WEB:o,_abtest_vid:r}=i.config||{};var v,f,S;if(this._authorization=u.Authorization,bg.setEngineWebConfig(this._ctx.appId,this._roomConf.roomId,o),this._ctx.serverConfig={videoCodec:null==o?void 0:o.video_codec,audioRed:!(null==o||!o.pub_audio_red),muteReplaceUnsub:!(null===(h=i.config)||void 0===h||!h.mute_replace_unsub),simulcastOnDemand:!(!1===(null===(_=i.config)||void 0===_||null===(_=_.engine_VPM)||void 0===_||null===(_=_.ondemand)||void 0===_?void 0:_.enable)),forceUniHandler:1===(null===(m=i.config)||void 0===m||null===(m=m.vendor_param)||void 0===m?void 0:m.vendor_stream_sub_mode),e2eFeedback:null==o?void 0:o.e2e_feedback},Qg("SDK_CODEC_NEGOTIATION"))this._ctx.targetCodec=null===(v=i.config)||void 0===v?void 0:v.targetCodec,this._ctx.targetScreenCodec=null===(f=i.config)||void 0===f?void 0:f.targetScreenCodec;if("boolean"==typeof(null==o?void 0:o.av_sync)&&(this._ctx.avSync=o.av_sync),this._roomConf.rtcVid=r,i.vendorConfig&&this._roomConf.setVendorConfig(i.vendorConfig),OP.setAudioStallConfig(o),null!==(p=i.relayMessage)&&void 0!==p&&p.sdp)null===(S=this._ctx.handler)||void 0===S||S.createAVMlineAnswerTpl(i.relayMessage.sdp);this.emit(wN.JOIN_SUCCESS,{joinRes:i,reconnect:e}),this._joinRoomSuccess(i)}catch(y){var g;null===(g=this._ctx.monitor)||void 0===g||g.report("rtc_error",{message:"[join._callJoinRoom] ".concat(Sb(y)),error_code:-1});const e={461:Eg.ROOM_FORBIDDEN,462:Eg.USER_FORBIDDEN};(null==y?void 0:y.code)>=700&&(null==y?void 0:y.code)<800?this._joinRoomFailed("token_error",Eg.INVALID_TOKEN):e[null==y?void 0:y.code]?this._joinRoomFailed((null==y?void 0:y.message)||e[null==y?void 0:y.code],e[null==y?void 0:y.code]):(null==y?void 0:y.code)===Eg.TIME_OUT&&this._ctx.joinRoomConfig.useTcpAfterJoinTimeout?(this._logger.error("join",pO.JOIN_TIMEOUT),this.safeEmit(wN.ON_REJOIN_WITH_TCP),this._ctx.signalingManager.reconnect(pO.JOIN_TIMEOUT,!0)):y.code===Eg.OPERATION_CANCEL&&this._ctx.signalingManager.isReconnecting()||this._joinRoomFailed((null==y?void 0:y.message)||"signaling_error")}}_joinRoomWithRetry(e,t,i){return new Promise(((o,r)=>{this._ctx.signalingManager.sendSignaling(e,t,this._roomConf.rtsOnlySignalHeader,1e4).then((e=>{this.emit("onJoinRoomAck",e),o(e)})).catch((s=>{if(i=i||new Rw,s.code>=500&&s.code<600&&jy()-i.initTs<6e4){const n=i.getRetryDelay();return this._logger.warn("_joinRoomWithRetry","joinRoom failed(code: ".concat(s.code,"), will retry after ").concat(n,"ms")),void(this._joinRoom5xxTimer=setTimeout((()=>{delete this._joinRoom5xxTimer,this._joinRoomWithRetry(e,t,i).then(o).catch(r)}),n))}r(s)}))}))}_stopJoinRoom5xxRetry(){this._joinRoom5xxTimer&&(clearTimeout(this._joinRoom5xxTimer),delete this._joinRoom5xxTimer)}_reportJoinRoomStart(){this._joinTask&&(this.emit("__joinRoomStartReport"),this._roomConf.report("join_room",{type:"begin",start:this._joinTask.startTime,result:!1,reason:""},{enable_cloud_proxy:this._ctx.useCloudProxy,expectedIDC:this._ctx.expectedIDC}))}_joinRoomSuccess(e){this._joinTask&&(this._joinTask.success(e),this.emit("__joinRoomSuccessReport"),this._roomConf.report("join_room",{type:"end",start:this._joinTask.startTime,result:!0,reason:""},{enable_cloud_proxy:this._ctx.useCloudProxy,expectedIDC:this._ctx.expectedIDC}),this._roomConf.report("rtc_join_room",{error_code:0,deviceModel:"web",deviceManufacturer:"web",elapse:jy()-this._joinTask.startTime}),delete this._joinTask,delete this._roomConf.joinPromise)}_joinRoomFailed(e,t){this._joinTask&&(this._joinTask.fail(new Cg(t||Eg.JOIN_ROOM_FAILED,e)),this.emit("__joinRoomFailedReport"),this._roomConf.report("join_room",{type:"end",start:this._joinTask.startTime,result:!1,reason:e},{enable_cloud_proxy:this._ctx.useCloudProxy,expectedIDC:this._ctx.expectedIDC}),delete this._joinTask,delete this._roomConf.joinPromise)}}Xu(KD,"supportedCodecs",void 0);var BD=Object.defineProperty,JD=Object.getOwnPropertyDescriptor,jD=(e,t,i,o)=>{for(var r,s=o>1?void 0:o?JD(t,i):t,n=e.length-1;n>=0;n--)(r=e[n])&&(s=(o?r(t,i,s):r(s))||s);return o&&s&&BD(t,i,s),s};class zD{constructor(e,t){Xu(this,"_logger",void 0),this._ctx=e,this._roomConf=t,this._logger=new LS("RoomMessage",2,e.id)}sendUserMessage(e,t){return this._ctx.signalingManager.sendP2PMessage({to:e,from:this._roomConf.userId,room:this._roomConf.roomId,app:this._ctx.appId,msg:t})}async sendRoomMessage(e,t){const i={clientId:this._roomConf.userId,binary:t,message:"",roomId:this._roomConf.roomId};return i.message=t?await Qy.ab2b64str(e):e,this._ctx.signalingManager.sendSignaling("customMessage",i,this._roomConf.rtsOnlySignalHeader)}async controlMessage(e){this._logger.info("controlMessage()","params: %o",e);const t=e;"transcode"===e.type&&(t.roomId=this._roomConf.roomId),await this._ctx.signalingManager.sendSignaling("controlMessage",t)}}jD([uw],zD.prototype,"sendUserMessage",1),jD([uw],zD.prototype,"sendRoomMessage",1),jD([uw],zD.prototype,"controlMessage",1);var QD=Object.defineProperty,qD=Object.getOwnPropertyDescriptor,$D=(e,t,i,o)=>{for(var r,s=o>1?void 0:o?qD(t,i):t,n=e.length-1;n>=0;n--)(r=e[n])&&(s=(o?r(t,i,s):r(s))||s);return o&&s&&QD(t,i,s),s};const eU={audiostream:!0,extaudio:!1,extvideo:!1,localaudio:!0,localvideo:!1,videoDescriptions:[],videostream:!1,publishTime:0};class tU extends kI{constructor(e,t){super(),Xu(this,"_localStream",void 0),Xu(this,"_localScreenStream",void 0),Xu(this,"_remoteUsers",new Map),Xu(this,"_remoteStreams",new Map),Xu(this,"_remoteStreamStreamIdUserIdMap",{}),Xu(this,"_virtualStreams",[]),Xu(this,"_serverConfig",void 0),Xu(this,"_userDuplicateLoginTimerMap",new Map),Xu(this,"_networkQualityManager",void 0),Xu(this,"_videoSizeObserver",void 0),Xu(this,"_hasPublished",!1),Xu(this,"_subtitleTool",void 0),Xu(this,"_csrcUserIdMap",{}),Xu(this,"_publishOnDemandItem",void 0),Xu(this,"_onceTriggerBySignal",!1),Xu(this,"_pubTransceiverReady",!1),Xu(this,"_publishOnDemandBusy",!1),Xu(this,"logger",void 0),Xu(this,"_forwardStreamManager",void 0),Xu(this,"_publisher",void 0),Xu(this,"_subscriber",void 0),Xu(this,"_roomJoin",void 0),Xu(this,"_roomMessage",void 0),Xu(this,"_clearSignalListeners",void 0),this.config=e,this._ctx=t,this.logger=new LS("Room",1,t.id),this.logger.info("constructor","invoke"),this._publisher=new WD(t,e),this._addPublisherListeners(),this._subscriber=new HD(t,e),this._addSubscriberListeners(),this._roomJoin=new KD(t,e),this._addJoinRoomHandler(),this._forwardStreamManager=new vw(t,e),this._addForwardStreamListeners(),this._roomMessage=new zD(t,e),this._networkQualityManager=new ZN(t),this._networkQualityManager.reportor=this._reportNetworkQuality.bind(this),this._videoSizeObserver=new WN(this),this._videoSizeObserver.onchange=this._emitVideoSizeChange.bind(this),this._addSignalListeners()}get remoteUsers(){return this._remoteUsers}get remoteStreams(){return this._remoteStreams}get localStream(){return this._localStream}get localScreenStream(){return this._localScreenStream}get virtualStreams(){return this._virtualStreams}_addSignalListeners(){const e={[OI.ON_ADD_STREAM]:this._onAddStream.bind(this),[OI.ON_ADD_STREAM_LIST]:e=>{e&&Array.isArray(e.streamList)&&e.streamList.forEach((e=>this._onAddStream(e)))},[OI.ON_REMOVE_STREAM]:this._onRemoveStream.bind(this),[OI.ON_REMOVE_STREAM_LIST]:e=>{e&&Array.isArray(e.streamList)&&e.streamList.forEach((e=>this._onRemoveStream(e)))},[OI.USER_CONNECTION]:this._onUserConnection.bind(this),[OI.USER_CONNECTION_LIST]:e=>{e&&Array.isArray(e.userList)&&e.userList.forEach((e=>this._onUserConnection(e)))},[OI.USER_DISCONNECTION]:this._onUserDisconnection.bind(this),[OI.USER_DISCONNECTION_LIST]:e=>{e&&Array.isArray(e.userList)&&e.userList.forEach((e=>this._onUserDisconnection(e)))},[OI.ON_UPDATE_ROOM_ATTRIBUTES]:this._onUpdateRoomAttributes.bind(this),[OI.ON_UPDATE_USER_ATTRIBUTES]:this._onUpdateUserAttributes.bind(this),[OI.ON_UPDATE_STREAM_ATTRIBUTES]:this._onUpdateStreamAttributes.bind(this),[OI.ON_PUSH_TRACK]:this._onPushTrack.bind(this),[OI.ON_REMOVE_TRACK]:this._onRemoveTrack.bind(this),[OI.ON_CUSTOM_MESSAGE]:this._onCustomMessage.bind(this),[OI.USER_MESSAGE_RECEIVED]:this._onUserMessageReceived.bind(this),[OI.USER_BINARY_MESSAGE_RECEIVED]:this._onUserBinaryMessageReceived.bind(this),[OI.POST_PROCESSING_MESSAGE]:this._onPostProcessingMessage.bind(this),[OI.ON_USER_TOKEN_WILL_EXPIRE]:this._onUserTokenWillExpire.bind(this),[OI.ON_TOKEN_PUBLISH_PRIVILEGE_WILL_EXPIRE]:this._onUserTokePublishPrivilegeWillExpire.bind(this),[OI.ON_TOKEN_PUBLISH_PRIVILEGE_DID_EXPIRED]:this._onUserTokenPublishPrivilegeDidExpire.bind(this),[OI.ON_TOKEN_SUBSCRIBE_PRIVILEGE_WILL_EXPIRE]:this._onUserTokeSubscribePrivilegeWillExpire.bind(this),[OI.ON_TOKEN_SUBSCRIBE_PRIVILEGE_DID_EXPIRED]:this._onUserTokenSubscribePrivilegeDidExpire.bind(this),[OI.STREAM_CONTROL_MESSAGE]:this._onStreamControlMessage.bind(this),[OI.ENGINE_CONTROL_MESSAGE]:this._onEngineControlMessage.bind(this),[OI.ON_STREAM_FAILED]:this._onStreamFailed.bind(this),[MI.RTT]:this._onRTT.bind(this),[MI.SSC]:this._onSSC.bind(this),[LI.ON_CONNECTION_STATE_CHANGE]:this._onConnectionStateChange.bind(this),[OI.ON_SPEAKER_CHANGE]:this._onMeetingSpeakerChange.bind(this),[OI.ON_FORWARD_DST_ROOM_USER_KICK]:this._forwardStreamManager.onForwardDstRoomUserKick.bind(this._forwardStreamManager),[MI.RSCP]:this._onRSCP.bind(this)};Object.keys(e).forEach((t=>{this._ctx.signalingManager.on(t,e[t])})),this._clearSignalListeners=()=>{Object.keys(e).forEach((t=>{this._ctx.signalingManager.off(t,e[t])}))}}_addPublisherListeners(){this._publisher.on(wN.PUB_RETRY,(e=>{this.emit(wN.PUB_RETRY,e)})),this._publisher.on(MI.RSCP,this._onRSCP.bind(this)),this._publisher.on(LI.ON_VENDOR_CONNECTION_STATE_CHANGE,(e=>this.emit(LI.ON_VENDOR_CONNECTION_STATE_CHANGE,e)))}_addSubscriberListeners(){this._subscriber.on(LI.ON_VENDOR_CONNECTION_STATE_CHANGE,(e=>this.emit(LI.ON_VENDOR_CONNECTION_STATE_CHANGE,e))),this._subscriber.on("onRemoteStreamStats",(e=>{this._networkQualityManager.updateDownlinkStats(e,this._findRemoteStreamByScreen(e.userId,e.isScreen)),Qg("HIDDEN_STATS")||(e=nb(e)),this.emit(wN.ON_REMOTE_STREAM_STATS,e)})),this._subscriber.on(wN.RESUBSCRIBE,(e=>{this.emit(wN.RESUBSCRIBE,e)})),this._subscriber.on(wN.SUB_RETRY,(e=>{this.emit(wN.SUB_RETRY,e)}))}_addJoinRoomHandler(){this._roomJoin.on(wN.JOIN_SUCCESS,this._onJoinSucc.bind(this)),this._roomJoin.on(wN.ON_REJOIN_WITH_TCP,(()=>{this.emit(wN.ON_REJOIN_WITH_TCP)}))}_addForwardStreamListeners(){this._forwardStreamManager.on(wN.ON_FORWARD_STREAM_ERROR,(e=>{this.safeEmit(wN.ON_FORWARD_STREAM_ERROR,e)}))}_onLocalStreamStats(e){const t=e.isScreen?this._localScreenStream:this.localStream;this._networkQualityManager.updateUplinkStats(e,t),Qg("HIDDEN_STATS")||(e=nb(e)),this.emit(wN.ON_LOCAL_STREAM_STATS,e)}async join(){this.logger.info("join()"),this.config.startJoinTimestamp=jy();try{var e;const t=await this._roomJoin.join();return this._ctx.callId=t.callId,null!==(e=t.roomAttributes)&&void 0!==e&&e.multiChatMode&&this._handleFFAudioTrack(),this._initSubtitleTool(),{users:t.clients,streams:t.streams}}catch(i){var t;if(null===(t=this._ctx.monitor)||void 0===t||t.report("rtc_error",{message:"[room.join] ".concat(Sb(i)),error_code:-1}),i.code!==Eg.OPERATION_CANCEL)throw i}}async hasScreenPublished(){return!!this._localScreenStream&&this._publisher.hasPublished(this._localScreenStream)}async hasPublished(){return!!this._localStream&&this._publisher.hasPublished(this._localStream)}async publishScreen(e,t,i,o){this.logger.info("publishScreen()"),this._localScreenStream||(this._localScreenStream=new PN(this._ctx,$u.STREAM_INDEX_SCREEN),this.config.vendorConfig.enableMultiVendor&&(this._localScreenStream.pcSessionId=sm()),this._localScreenStream.isScreen=!0,this._localScreenStream.observer=new DN(this._ctx,this._localScreenStream));let r=!1,s=!1,n=!1,a=!1;!this._localScreenStream.videoTrack&&e?(e.sourceType===ZI.EXTERNAL&&(s=!0),r=!0):this._localScreenStream.videoTrack&&!e&&(r=!1),!this._localScreenStream.audioTrack&&t?(t.sourceType===ZI.EXTERNAL&&(a=!0),n=!0):this._localScreenStream.audioTrack&&!t&&(n=!1),this._localScreenStream.videoTrack=e,this._localScreenStream.audioTrack=t,i&&(rb(i)&&(this._localScreenStream.pubAudio=o===MN.PUB),sb(i)&&(this._localScreenStream.pubVideo=o===MN.PUB),this.logger.info("publishScreen mediaType","pubAudio: %o, pubVideo: %o",this._localScreenStream.pubAudio,this._localScreenStream.pubVideo));const d=await this._publisher.hasPublished(this._localScreenStream);if(!this._localScreenStream.pubAudio&&!this._localScreenStream.pubVideo)return d?this.unpublishScreen():void 0;if(d){var c,l,u,h;if(s)null===(c=this._localScreenStream.observer)||void 0===c||c.setPushVideo(r);else null===(l=this._localScreenStream.observer)||void 0===l||l.setEnableVideo(r);if(a)null===(u=this._localScreenStream.observer)||void 0===u||u.setPushAudio(n);else null===(h=this._localScreenStream.observer)||void 0===h||h.setEnableAudio(n);await this.updatePubScreenTrack()}else{var _;null===(_=this._localScreenStream.observer)||void 0===_||_.setPublish(!0),await this._publisher.publish(this._localScreenStream)}this._localScreenStream.pubAudio||this._localScreenStream.pubVideo?this._ctx.handler&&this._localScreenStream.startReport(this._onLocalStreamStats.bind(this),this._localScreenStream.vendorHandler||this._ctx.handler):this._localScreenStream.stopReport("unpublish screen")}async updatePubScreenTrack(){this.logger.info("updatePubScreenTrack","Invoke updatePubScreenTrack"),this._localScreenStream&&await this._publisher.updatePubTrack(this._localScreenStream)}async unpublishScreen(){var e;(this.logger.info("unpublish","Invoke unpublishScreen"),this._localScreenStream)&&(null===(e=this._localScreenStream.observer)||void 0===e||e.setPublish(!1),await this._publisher.unpublish(this._localScreenStream),this._localScreenStream.stopReport("unpublish screen"),await this._publisher.cleanStream(this._localScreenStream),this._localScreenStream=void 0)}async liveControlMessage(e){var t;this.logger.info("controlMessage","Invoke controlMessage"),null===(t=e.transcodeMeta)||void 0===t||t.layout.regions.forEach((e=>{e.roomID=this.config.roomId})),this.config.setLiveControlMessage("stopped"===e.action?void 0:e);try{await this._roomMessage.controlMessage(e)}catch(i){if("stopped"!==e.action)throw i}}async publicStreamControlMessage(e){"stopped"===e.action&&delete e.publicStreamMeta,await this._roomMessage.controlMessage(e)}getLocalStreamStats(){var e;return null===(e=this.localStream)||void 0===e?void 0:e.getLocalStreamStats()}async updateUserAttributes(){this.logger.info("updateUserAttributes","Invoke updateUserAttributes"),await this._subscriber.updateUserAttributes({role:this._ctx.role})}async publish(e,t,i,o){let r=arguments.length>4&&void 0!==arguments[4]&&arguments[4];this.logger.info("publish","Invoke publish");let s=!1;this._localStream||(this._localStream=new PN(this._ctx),this.config.vendorConfig.enableMultiVendor&&(this._localStream.pcSessionId=sm()),this._localStream.observer=new DN(this._ctx,this._localStream),s=!0,this._localStream.vendorCode=this.config.vendorConfig.vendorCode||0),this._localStream.videoTrack=e,this._localStream.audioTrack=t;const{pubAudio:n,pubVideo:a}=this._localStream;i&&(rb(i)&&(this._localStream.pubAudio=o===MN.PUB),sb(i)&&(this._localStream.pubVideo=o===MN.PUB),this.logger.info("publish mediaType","pubAudio: %o, pubVideo: %o",this._localStream.pubAudio,this._localStream.pubVideo));if(await this._publisher.hasPublished(this._localStream))try{this.emit("___onMediaServerClientPublish"),await this.updatePubTrack()}catch(f){throw this._localStream.pubAudio=n,this._localStream.pubVideo=a,f}else{if(!this._localStream.pubAudio&&!this._localStream.pubVideo)return;try{var d;if(r)null===(d=this._localStream.observer)||void 0===d||d.setLogin(!0);else if(s){var c,l;const e=!!this._localStream.videoTrack,t=!!this._localStream.audioTrack,i=(null===(c=this._localStream.videoTrack)||void 0===c?void 0:c.sourceType)===ZI.EXTERNAL,o=(null===(l=this._localStream.audioTrack)||void 0===l?void 0:l.sourceType)===ZI.EXTERNAL;if(this.config.isAutoPublish&&!this._hasPublished){var u,h,_,m;if(e)if(i)null===(u=this._localStream.observer)||void 0===u||u.setPushVideo(!0);else null===(h=this._localStream.observer)||void 0===h||h.setEnableVideo(!0);if(t)if(o)null===(_=this._localStream.observer)||void 0===_||_.setPushAudio(!0);else null===(m=this._localStream.observer)||void 0===m||m.setEnableAudio(!0)}else{var p;null===(p=this._localStream.observer)||void 0===p||p.setPublish(!0)}}this.emit("___onMediaServerClientPublish"),await this._publisher.publish(this._localStream),this._hasPublished=!0,this.emit(wN.ON_PUBLISH_RESULT,{isScreen:!1,state:zu.PUBLISH_SUCC})}catch(f){var v;throw null===(v=this._ctx.monitor)||void 0===v||v.report("rtc_error",{message:"[room.publish] ".concat(Sb(f)),error_code:-1}),this.emit(wN.ON_PUBLISH_RESULT,{isScreen:!1,state:zu.PUBLISH_FAIL,errorCode:f.code}),delete this._localStream,f}}this._localStream.pubAudio||this._localStream.pubVideo?this._ctx.handler&&this._localStream.startReport(this._onLocalStreamStats.bind(this),this._localStream.vendorHandler||this._ctx.handler):this._localStream.stopReport("unpublish")}async updatePubTrack(){if(this.logger.info("updatePubTrack","Invoke updatePubTrack"),this._localStream)try{await this._publisher.updatePubTrack(this._localStream)}catch(t){var e;throw null===(e=this._ctx.monitor)||void 0===e||e.report("rtc_error",{message:"[room.updatePubTrack] ".concat(Sb(t)),error_code:-1}),t}}async unpublish(){if(this.logger.info("unpublish","Invoke unpublish"),this._localStream)try{await this._publisher.unpublish(this._localStream),this._localStream.stopReport("unpublish"),await this._publisher.cleanStream(this._localStream),this._localStream=void 0}catch(t){var e;throw null===(e=this._ctx.monitor)||void 0===e||e.report("rtc_error",{message:"[room.unpublish] ".concat(Sb(t)),error_code:-1}),t}}async subscribe(e,t){this.logger.info("subscribe","remoteStream %o",e);if(await this._subscriber.hasSubscribed(e)){const i=e.subMediaType|t;return i!==e.subMediaType?await this._subscriber.updateSubMediaType(e,i):void 0}const i=this._ctx.videoProfile.getSubLayer(e,this.config.remoteVideoConfig);try{await this._subscriber.subscribe(e,t,i)}catch(r){var o;throw null===(o=this._ctx.monitor)||void 0===o||o.report("rtc_error",{message:"[room.subscribe] ".concat(Sb(r)),error_code:-1}),r}}async updateSubVideoConfig(e){var t;const i=this._findRemoteStreamByScreen(e,!1);if(this.logger.info("updateSubVideoConfig","userId %s",e),!i)return;if(!(await this._subscriber.hasSubscribed(i))||(null===(t=i.attributes)||void 0===t||null===(t=t.videoDescriptions)||void 0===t?void 0:t.length)<=1)return;const o=this._ctx.videoProfile.getSubLayer(i);return o?(i.originalStreamIndex=o.spatialLayer,this._subscriber.updateSubTrackLayer(i,o)):void 0}async unsubscribe(e,t){this.logger.info("unsubscribe","Invoke unsubscribe");try{var i;if(!(await this._subscriber.hasSubscribed(e)))return;const o=e.subMediaType-(e.subMediaType&t);if((null===(i=this._ctx.serverConfig)||void 0===i||!i.muteReplaceUnsub)&&(o===Hg.NONE||this.config.isMultiChatMode()&&o===eh.AUDIO))return await this._subscriber.unsubscribe(e);await this._subscriber.updateSubMediaType(e,o)}catch(r){var o;throw null===(o=this._ctx.monitor)||void 0===o||o.report("rtc_error",{message:"[room.unsubscribe] ".concat(Sb(r)),error_code:-1}),r}}async startSubtitle(e){if(!this._subtitleTool)throw new Cg(Eg.INVOKED_BEFORE_JOIN_ROOM,"join first");await this._subtitleTool.start(e)}async updateSubtitleConfig(e){if(!this._subtitleTool)throw new Cg(Eg.INVOKED_BEFORE_JOIN_ROOM,"join first");await this._subtitleTool.update(e)}async stopSubtitle(){var e;null===(e=this._subtitleTool)||void 0===e||e.stop()}async startForwardStream2Rooms(e){return this._forwardStreamManager.startForwardStream2Rooms(e)}async updateForwardStream2Rooms(e){return this._forwardStreamManager.updateForwardStream2Rooms(e)}async stopForwardStream2Rooms(){return this._forwardStreamManager.stopForwardStream2Rooms()}async pauseForwardStream2AllRooms(){return this._forwardStreamManager.pauseForwardStream2AllRooms()}async resumeForwardStream2AllRooms(){return this._forwardStreamManager.resumeForwardStream2AllRooms()}async updateMediaParams(e){return this._ctx.signalingManager.sendSignaling("updateMediaParams",{roomId:this.config.roomId,mediaParams:e})}async leave(){var e;let t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this.logger.info("leave","Invoke leave"),null===(e=this._subtitleTool)||void 0===e||e.destroy(),delete this._subtitleTool;try{for(const e of this._remoteStreams.values())Array.isArray(e)&&e.forEach((e=>{var t;null===(t=e.observer)||void 0===t||t.setLogin(!1)}));var i;if(this._localStream)null===(i=this._localStream.observer)||void 0===i||i.setLogin(!1);await this._roomJoin.leave().catch((()=>{})),this.destroy(),this.config.report("rtc_leave_room",{error_code:0,message:"",elapse:this.config.getStayRoomDuration()})}catch(r){var o;if(null===(o=this._ctx.monitor)||void 0===o||o.report("rtc_error",{message:"[room.leave] ".concat(Sb(r)),error_code:-1}),r instanceof Error&&this.config.report("rtc_leave_room",{error_code:-1,message:r.message,elapse:this.config.getStayRoomDuration()}),t)throw r;this.destroy()}}updateRemoteUserPriority(e){var t;null===(t=this.remoteStreams.get(e))||void 0===t||t.forEach((t=>{const{userPriority:i}=this._ctx;t.hasSubscribed&&i.has(e)&&this._subscriber.updateSubPriority(t,i.get(e))}))}destroy(){var e,t,i;this.logger.info("destroy","Invoke destroy"),fS(this._ctx.id,"room_destroy","".concat((new Error).stack)),null===(e=this._subtitleTool)||void 0===e||e.destroy(),delete this._subtitleTool;const o=Om(t=Array.from(this._remoteStreams.values())).call(t);this._subscriber.destroy(o),this._subscriber.destroy(this._virtualStreams),this._publisher.destroy([this.localStream,this.localScreenStream]),this._roomJoin.destroy(),null===(i=this._clearSignalListeners)||void 0===i||i.call(this),this._remoteUsers=new Map,this._remoteStreams=new Map,this._localStream&&(this._localStream=void 0),this._localScreenStream&&(this._localScreenStream=void 0),this._userDuplicateLoginTimerMap.forEach((e=>{clearTimeout(e)})),this._userDuplicateLoginTimerMap.clear(),this._networkQualityManager.destroy(),this._videoSizeObserver.destroy(),this._csrcUserIdMap={},this._virtualStreams=[],this._remoteStreamStreamIdUserIdMap={},this._forwardStreamManager.destoy()}async updateToken(e){if(this.logger.info("updateToken","Invoke updateToken"),this.config.token=e,!this.config.isRTSOnlyRoom())try{await this._roomJoin.updateToken(e)}catch(t){throw this.safeEmit(wN.ON_ROOM_ERROR,{errorCode:Eg.UPDATE_TOKEN_WITH_INVALID_TOKEN}),t}}sendUserMessage(e,t){return this._ctx.rtsLimiter.e2e.check(t),this._roomMessage.sendUserMessage(e,t)}sendRoomMessage(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return this._ctx.rtsLimiter.boradcast.check(e),this._roomMessage.sendRoomMessage(e,t)}async maybeFillBackFrame2Stream(e){var t;e.refreshBlackFrameLifetime(),null!==(t=e.videoTransceiver)&&void 0!==t&&t.sender.track||this._publisher.updatePubBlackFrame(e)}_onJoinSucc(e){var t,i;let{joinRes:o,reconnect:r}=e;this.logger.info("_onJoinSucc()","invoke. ".concat(r?"[reconnect]":"")),this.emit(wN.JOIN_SUCCESS,r),this._serverConfig=o.config,this.config.updateRoomAttributes(o.roomAttributes);const s=[],n=[],a=[],d=[],c=[];this.config.isRTSOnlyRoom()&&Array.isArray(o.userInfos)&&(o.clientsDetail=o.userInfos.map((e=>({clientId:e.userId,clientJoinTime:e.userJoinTime})))),null===(t=o.clientsDetail)||void 0===t||t.forEach((e=>{if(e.attributes&&(e.attributes.serverMuteVideo&&this.safeEmit(wN.ON_VIDEO_STREAM_BANNED,{uid:e.clientId,banned:1===e.attributes.serverMuteVideo}),e.attributes.serverMuteAudio&&this.safeEmit(wN.ON_AUDIO_STREAM_BANNED,{uid:e.clientId,banned:1===e.attributes.serverMuteAudio})),e.clientId===o.clientId)return;const t=this._remoteUsers.get(e.clientId);t?t._stillExist=!0:s.push(e)}));for(const l of this._remoteUsers.values())l._stillExist||n.push({clientId:l.userId}),delete l._stillExist;null===(i=o.streams)||void 0===i||i.forEach((e=>{const t=this._findRemoteStreamByScreen(e.clientId,e.screen);this.config.updateUserPubInfo(e),t?(t.stillExist=!0,t.streamId=e.streamId,c.push(e)):d.push(e)}));for(const l of this._remoteStreams.values())Array.isArray(l)&&l.forEach((e=>{e.stillExist?delete e.stillExist:a.push({clientId:e.userId,streamId:e.streamId,message:PI.clientDisconnected})}));n.forEach((e=>this._onUserDisconnection(e))),s.forEach((e=>this._onUserConnection(e))),a.forEach((e=>this._onRemoveStream(e))),d.forEach((e=>this._onAddStream(e,{fromSignal:!1}))),c.forEach((e=>this._onUpdateStreamAttributes(e))),this.config.resetUserPubInfo(),r&&this._handleSendOrRecvStreamAfterReconnect(),this.emit("__joinSuccess")}_handleSendOrRecvStreamAfterReconnect(){var e;this._localStream&&(this._publisher.cleanStream(this._localStream).then((()=>{var e;this._localStream&&(this._localStream.vendorCode=this.config.vendorConfig.vendorCode||0,null===(e=this._localStream.observer)||void 0===e||e.setLogin(!0))})),this._publisher.publish(this._localStream).then((()=>{var e;this._ctx.handler&&(null===(e=this._localStream)||void 0===e||e.startReport(this._onLocalStreamStats.bind(this),this._localStream.vendorHandler||this._ctx.handler)),this.emit(wN.ON_PUBLISH_RESULT,{isScreen:!1,state:zu.PUBLISH_SUCC,retry:!0})})).catch((e=>{this.logger.error("failed repub error:".concat(e)),this.emit(wN.ON_PUBLISH_RESULT,{isScreen:!1,state:zu.PUBLISH_FAIL,errorCode:e.code,retry:!0})}))),this._localScreenStream&&(this._publisher.cleanStream(this._localScreenStream).then((()=>{var e;this._localScreenStream&&(null===(e=this._localScreenStream.observer)||void 0===e||e.setLogin(!0))})),this._publisher.publish(this._localScreenStream).then((()=>{var e;this._ctx.handler&&(null===(e=this._localScreenStream)||void 0===e||e.startReport(this._onLocalStreamStats.bind(this),this._localScreenStream.vendorHandler||this._ctx.handler)),this.emit(wN.ON_PUBLISH_RESULT,{isScreen:!0,state:zu.PUBLISH_SUCC,retry:!0})})).catch((e=>{this.logger.error("failed repub screen stream error:".concat(e)),this.emit(wN.ON_PUBLISH_RESULT,{isScreen:!0,state:zu.PUBLISH_FAIL,errorCode:e.code,retry:!0})})));for(const t of this._remoteStreams.values())Array.isArray(t)&&t.forEach((async e=>{if(e.hasSubscribed){e.resetHasSubscribed();try{var t,i;this.logger.info("start resubscribe ".concat(e.userId," with ").concat(e.subMediaType)),sb(e.subMediaType)&&(null===(t=e.observer)||void 0===t||t.setSubscribeVideo(!0)),rb(e.subMediaType)&&(null===(i=e.observer)||void 0===i||i.setSubscribeAudio(!0)),await this._subscriber.subscribe(e,e.subMediaType),this.logger.info("success resubscribe ".concat(e.userId," with ").concat(e.subMediaType)),this.safeEmit(wN.RESUBSCRIBE,{stream:e}),this.emit(wN.ON_SUBSCRIBE_RESULT,{state:ju.SUBSCRIBE_SUCC,userId:e.userId,isScreen:e.isScreen,retry:!0})}catch(wZ){if(this.emit(wN.ON_SUBSCRIBE_RESULT,{state:ju.SUBSCRIBE_FAIL,userId:e.userId,isScreen:e.isScreen,errorCode:wZ.code,retry:!0}),this.logger.error("failed resubscribe ".concat(e.userId," with ").concat(e.subMediaType,", error:").concat(wZ)),wZ.code===Eg.NOT_CONNECTED_YET)return void(e.streamState=AN.SUB_ED);await this._subscriber.cleanStream(e),e.resetHasSubscribed()}}}));null===(e=this._subtitleTool)||void 0===e||e.reconnect(),this._forwardStreamManager.resumeFromReconnect()}_handleFFAudioTrack(){var e,t;const i=null===(e=this._ctx.handler)||void 0===e?void 0:e.audioTrack4ff,o=null===(t=this._ctx.handler)||void 0===t?void 0:t.getTransceivers();if(i&&Array.isArray(o)){const e=o.find((e=>{var t;return(null==e||null===(t=e.receiver)||void 0===t?void 0:t.track)===i}));if(e){const t=new NN(this._ctx,"ff-stream","ff-stream",!1,!1,eU);t.virtual=!0,t.audioTransceiver=e,t.audioMid="0",t.audioTrack=gN(this._ctx,i,{streamIndex:XI.VIRTUAL}),this._virtualStreams.push(t),this.safeEmit(wN.SUBSCRIBE_PUSH_TRACK,{stream:t})}}}_findRemoteStream(e,t){const i=this._remoteStreams.get(e);return Array.isArray(i)?i.find((e=>e.streamId===t)):null}_findRemoteStreamByScreen(e,t){const i=this._remoteStreams.get(e);return Array.isArray(i)?i.find((e=>e.isScreen===t)):null}_onAddStream(e){let{needEmit:t=!0,fromSignal:i=!0,virtual:o=!1}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(e.clientId===this.config.userId)return;const{isAutoSubscribeAudio:r,isAutoSubscribeVideo:s}=this.config,n=this._findRemoteStreamByScreen(e.clientId,e.screen);if(n&&n.streamId!==e.streamId){var a;const t=null===(a=this._remoteStreams.get(e.clientId))||void 0===a?void 0:a.filter((e=>e.streamId!==n.streamId));this._subscriber.cleanStream(n),this._remoteStreams.set(e.clientId,t||[])}let d=this._findRemoteStream(e.clientId,e.streamId);if(this._remoteStreamStreamIdUserIdMap[e.streamId]=e.clientId,d)d.attributes=e.attributes;else if(d=new NN(this._ctx,e.clientId,e.streamId,e.screen,!1,e.attributes),d.virtual=o,this._initStreamListeners(d),!o){const t=this._remoteStreams.get(e.clientId);t?t.push(d):this._remoteStreams.set(e.clientId,[d])}if(d.remoteSessionId=e.remoteSessionId||"",d.observer=new VN(this._ctx,d),!d.isScreen&&s&&(i&&d.hasVideo&&(d.attributes.extvideo?(d.observer.setExternalVideoSource(!0),d.observer.setPushVideo(!0)):(d.observer.setExternalVideoSource(!1),d.observer.setPublishVideo(!0))),i&&d.hasAudio&&r&&!this.config.isMultiChatMode()&&(d.attributes.extaudio?(d.observer.setExternalAudioSource(!0),d.observer.setPushAudio(!0)):(d.observer.setExternalAudioSource(!1),d.observer.setPublishAudio(!0))),t&&!i)){const{isAutoSubscribeAudio:e,isAutoSubscribeVideo:t}=this.config;d.observer.setLogin(!0,{audio:!!e&&!this.config.isMultiChatMode(),video:!!t})}return t&&this.safeEmit(OI.ON_ADD_STREAM,{stream:d}),d}_onUserConnection(e){var t;if(e.clientId===this.config.userId)return;const i=this._userDuplicateLoginTimerMap.get(e.clientId);if("number"==typeof i)return this._userDuplicateLoginTimerMap.delete(e.clientId),void self.clearTimeout(i);const o={userId:e.clientId,extraInfo:null===(t=e.attributes)||void 0===t?void 0:t.extra_info};this._remoteUsers.set(e.clientId,Fu({},o)),this.safeEmit(OI.USER_CONNECTION,{userInfo:o,publishState:this.config.getUserPubInfo(o.userId)}),e.attributes&&(e.attributes.serverMuteVideo&&this.safeEmit(wN.ON_VIDEO_STREAM_BANNED,{uid:e.clientId,banned:1===e.attributes.serverMuteVideo}),e.attributes.serverMuteAudio&&this.safeEmit(wN.ON_AUDIO_STREAM_BANNED,{uid:e.clientId,banned:1===e.attributes.serverMuteAudio}))}_onUserDisconnection(e){let{clientId:t,tag:i,code:o,forbiddenTime:r}=e;if(t)if(t===this.config.userInfo.userId){let e=null;i===xI.kickedByAdmin?e=Eg.KICKED_OUT:i===xI.onUserTokenDidExpire?e=Eg.TOKEN_EXPIRED:i===xI.userDuplicateLogin&&(e=Eg.DUPLICATE_LOGIN),o===VI.roomDismissByAdmin&&(e=Eg.ROOM_DISMISS),e&&this.safeEmit(wN.ON_ROOM_ERROR,{errorCode:e,forbiddenTime:r})}else{let e=Ku.DROPPED;i===xI.userLeave?e=Ku.QUIT:i===xI.kickedByAdmin?e=Ku.KICKED_BY_ADMIN:i===xI.roleChanged&&(e=Ku.SWITCH_TO_INVISIBLE);const o=()=>{var i;this._remoteUsers.delete(t);const o=[];null===(i=this._remoteStreams.get(t))||void 0===i||i.forEach((e=>{o.push(this._onRemoveStream({clientId:e.userId,streamId:e.streamId,message:PI.clientDisconnected}))})),this._remoteStreams.delete(t),Promise.all(o).finally((()=>{this.safeEmit(wN.ON_USER_LEAVE,{userInfo:{userId:t},reason:e})}))};if(i===xI.userDuplicateLogin){const e=this._userDuplicateLoginTimerMap.get(t);e&&self.clearTimeout(e);const i=self.setTimeout(o,5e3);this._userDuplicateLoginTimerMap.set(t,i)}else o()}}async _onRemoveStream(e){if(e.clientId===this.config.userId)return;const t=this._remoteStreams.get(e.clientId);if(!t)return;const i=t.find((t=>t.streamId===e.streamId));if(!i)return;var o,r;i.hasVideo&&(null===(o=i.observer)||void 0===o||o.setPublishVideo(!1));i.hasAudio&&!this.config.isMultiChatMode()&&(null===(r=i.observer)||void 0===r||r.setPublishAudio(!1));const s=t.filter((t=>t.streamId!==e.streamId));this._remoteStreams.set(e.clientId,s);try{await this._subscriber.handleRemoveStream(i).then((()=>this._subscriber.cleanStream(i))).finally((()=>{this.safeEmit(OI.ON_REMOVE_STREAM,{stream:i,reason:e.message,callback:()=>{this._subscriber.destroyStream(i)}})}))}catch(n){console.error(n)}}_onUpdateUserAttributes(e){e.attributes&&(e.attributes.serverMuteVideo&&this.safeEmit(wN.ON_VIDEO_STREAM_BANNED,{uid:e.clientId,banned:1===e.attributes.serverMuteVideo}),e.attributes.serverMuteAudio&&this.safeEmit(wN.ON_AUDIO_STREAM_BANNED,{uid:e.clientId,banned:1===e.attributes.serverMuteAudio}))}_onUpdateRoomAttributes(e){var t;e.roomAttributes&&(this.config.updateRoomAttributes(e.roomAttributes),this._ctx&&(this._ctx.callId=e.roomAttributes.callId)),null!==(t=e.roomAttributes)&&void 0!==t&&t.multiChatMode&&this._handleFFAudioTrack()}_onUpdateStreamAttributes(e){const{isAutoSubscribeAudio:t,isAutoSubscribeVideo:i}=this.config,{clientId:o,streamId:r,attributes:s}=e,n=this._findRemoteStream(o,r);if(!n)return;const a=n.attributes,d=Fu(Fu({},a),s);let c=!1;const l=d.localaudio!==a.localaudio;let u=!1,h=!1;const _=d.localvideo!==a.localvideo;let m=!1,p=Hg.NONE,v=Hg.NONE;if(d.audiostream!==a.audiostream&&(c=d.localaudio,u=!!d.audiostream,d.audiostream?p|=eh.AUDIO:v|=eh.AUDIO),d.videostream!==a.videostream&&(h=d.localvideo,m=!!d.videostream,d.videostream?p|=eh.VIDEO:v|=eh.VIDEO),p&&this.safeEmit(wN.ON_USER_PUBLISH_STATE_CHANGE,{userId:o,mediaType:p,isScreen:n.isScreen,pubState:MN.PUB,remoteStream:n}),v&&this.safeEmit(wN.ON_USER_PUBLISH_STATE_CHANGE,{userId:o,mediaType:v,isScreen:n.isScreen,pubState:MN.UNPUB,remoteStream:n}),n.remoteSessionId=e.remoteSessionId||"",n.attributes=d,d.localaudio!==a.localaudio)if(d.localaudio){var f,S,g,y;if((t||n.subAudio)&&d.audiostream)if(d.extaudio)null===(f=n.observer)||void 0===f||f.setExternalAudioSource(!0),null===(S=n.observer)||void 0===S||S.setPushAudio(!0);else null===(g=n.observer)||void 0===g||g.setExternalAudioSource(!1),null===(y=n.observer)||void 0===y||y.setEnableAudio(!0);this.safeEmit(wN.ON_USER_START_AUDIO_CAPTURE,{userId:o},n)}else{var b,T,I,E;if(d.extaudio)null===(b=n.observer)||void 0===b||b.setExternalAudioSource(!0),null===(T=n.observer)||void 0===T||T.setPushAudio(!1);else null===(I=n.observer)||void 0===I||I.setExternalAudioSource(!1),null===(E=n.observer)||void 0===E||E.setEnableAudio(!1);!n.isScreen&&this.safeEmit(wN.ON_USER_STOP_AUDIO_CAPTURE,{userId:o})}if(d.localvideo!==a.localvideo)if(d.localvideo){var R,C,k,A;if((i||n.subVideo)&&d.videostream)if(d.extvideo)null===(R=n.observer)||void 0===R||R.setExternalVideoSource(!0),null===(C=n.observer)||void 0===C||C.setPushVideo(!0);else null===(k=n.observer)||void 0===k||k.setExternalVideoSource(!1),null===(A=n.observer)||void 0===A||A.setEnableVideo(!0);this.safeEmit(wN.ON_USER_START_VIDEO_CAPTURE,{userId:o})}else{var P,N,w,O;if(d.extvideo)null===(P=n.observer)||void 0===P||P.setExternalVideoSource(!0),null===(N=n.observer)||void 0===N||N.setPushVideo(!1);else null===(w=n.observer)||void 0===w||w.setExternalVideoSource(!1),null===(O=n.observer)||void 0===O||O.setEnableVideo(!1);!n.isScreen&&this.safeEmit(wN.ON_USER_STOP_VIDEO_CAPTURE,{userId:o})}var M,L;c&&!l&&t&&(null===(M=n.observer)||void 0===M||M.setRemoteUnmuteAudio(u));h&&!_&&i&&(null===(L=n.observer)||void 0===L||L.setRemoteUnmuteVideo(m));"number"==typeof d.videoType&&d.videoType!==a.videoType&&this.safeEmit(wN.VIDEO_TYPE_CHANGE,{userId:n.userId,isScreen:n.isScreen,type:d.videoType===UI.BLACK?AI.BLACK:AI.NORMAL})}_onPushTrack(e){var t;if(null===(t=e.streamId)||void 0===t||!t.startsWith("audio_mux"))return void this.config.report("rtc_error",{message:"onPushTrack, userId: ".concat(e.clientId,", ").concat(e.streamId),error_code:JP.TRACK_ERROR});const i=this._onAddStream(Fu(Fu({},e),{},{attributes:eU}),{needEmit:!1,fromSignal:!1,virtual:!0});i&&this._subscriber.subscribe4pushTrack(i,e).then((()=>{this.safeEmit(wN.SUBSCRIBE_PUSH_TRACK,{stream:i}),this._virtualStreams.push(i)})).catch((e=>{this.logger.error("subscribe","push track failed %o",e)}))}_onRemoveTrack(e){let{clientId:t,streamId:i,message:o,trackType:r}=e;this.logger.info("_onRemoveTrack","remove track: %o",t);const s=this._findRemoteStream(t,i);s&&(s.removeTrack=!0,this._subscriber.unsubscribe4removeTrack(s,o,r),this.emit(wN.REMOVE_PUSH_TRACK,{stream:s,mediaType:r+1}))}_onMeetingSpeakerChange(e){if(Array.isArray(null==e?void 0:e.speakerCsrcInfo)){const t={};null==e||e.speakerCsrcInfo.forEach((e=>{let{csrc:i,userId:o,isScreen:r}=e;r||(t[i]=o)})),this._csrcUserIdMap=t}Array.isArray(e.muxStreamInUse)&&this._virtualStreams.forEach((t=>{var i;null!==(i=e.muxStreamInUse)&&void 0!==i&&i.includes(t.streamId)?t.virtualOccupy=!0:t.virtualOccupy=!1}))}getActiveSpeakerInMultiChatMode(){const e=[];return this._virtualStreams.forEach((t=>{var i;const o=null===(i=t.audioTransceiver)||void 0===i?void 0:i.receiver;if(o){const[t]=o.getContributingSources()||[];if(t){const{audioLevel:i,source:o}=t;this._csrcUserIdMap[o]&&e.push({userId:this._csrcUserIdMap[o],audioLevel:i})}}})),e.length&&TI(e).call(e,((e,t)=>e.audioLevel-t.audioLevel)),e}_onReconnecting(){var e,t;for(const i of this._remoteStreams.values())Array.isArray(i)&&i.forEach((e=>{var t;null===(t=e.observer)||void 0===t||t.setDisconnect(),this._subscriber.cleanStream(e)}));this._virtualStreams.forEach((e=>{var t;this.emit(wN.REMOVE_PUSH_TRACK,{stream:e,mediaType:eh.AUDIO}),null===(t=e.observer)||void 0===t||t.setDisconnect(),this._subscriber.cleanStream(e)})),this._virtualStreams=[],null===(e=this.localStream)||void 0===e||null===(e=e.observer)||void 0===e||e.setDisconnect(),this._publisher.cleanStream(this.localStream),null===(t=this.localScreenStream)||void 0===t||null===(t=t.observer)||void 0===t||t.setDisconnect(),this._publisher.cleanStream(this.localScreenStream)}_onConnectionStateChange(e){e.state===ih.CONNECTION_STATE_RECONNECTING?this._onReconnecting():e.state===ih.CONNECTION_STATE_RECONNECTED&&this._roomJoin.join(!0)}_initStreamListeners(e){e.on("ontrack",(e=>{e.track})),e.on("onSEIMessage",(t=>{this.emit(wN.ON_SEI_MESSAGED_RECEIVED,{sei:t,remoteStreamKey:{userId:e.userId,roomId:this.config.roomId,streamIndex:e.isScreen?$u.STREAM_INDEX_SCREEN:$u.STREAM_INDEX_MAIN}})}))}_onCustomMessage(e){var t;null!==(t=this._subtitleTool)&&void 0!==t&&t.onMessageRecv(e)||this.safeEmit(OI.ON_CUSTOM_MESSAGE,e)}_onUserMessageReceived(e){this.safeEmit(OI.USER_MESSAGE_RECEIVED,{userId:e.from,message:e.msg})}_onUserBinaryMessageReceived(e){var t;const i={userId:e.from,message:e.msg};null!==(t=this._subtitleTool)&&void 0!==t&&t.onMessageRecv(i)||this.safeEmit(OI.USER_BINARY_MESSAGE_RECEIVED,i)}_initSubtitleTool(){this._subtitleTool=new HN(this._ctx,this.config),this._subtitleTool.onEvent=e=>{this.emit(wN.ON_SUBTITLE_STATE_CHANGED,e)},this._subtitleTool.onMessage=e=>{this.emit(wN.ON_SUBTITLE_MESSAGE_RECEIVED,e)}}_onPostProcessingMessage(e){if(!e.body)return;var t;if("subtitleCallback"===e.type)return void(null===(t=this._subtitleTool)||void 0===t||t.onResult(e));const i=e.body,o=i.error||0;let r=ON.START;const s=["success","parameter error","subscription timeout","ffmpeg error","cdn error","publish error"];if("2.0"===i.protocol){switch(i.eventType){case"TranscodeStarted":0!==i.error&&(r=ON.START_FAILED);break;case"TranscodeStateChanged":r=0!==i.error?ON.START_FAILED:ON.START_SUCCESS;break;case"TranscodeStopped":r=0!==i.error?ON.STOP_FAILED:ON.STOP_SUCCESS;break;case"TranscodeUpdated":r=0!==i.error?ON.UPDATE_FAILED:ON.UPDATE_SUCCESS}this.safeEmit(OI.POST_PROCESSING_MESSAGE,{code:o,protocol:i.protocol,error:i.error,eventType:r,message:s[o]})}this.safeEmit(OI.POST_PROCESSING_MESSAGE,{code:o,message:s[o],type:e.type})}_onUserTokenWillExpire(){this.safeEmit(OI.ON_USER_TOKEN_WILL_EXPIRE,null)}_onUserTokePublishPrivilegeWillExpire(){this.safeEmit(OI.ON_TOKEN_PUBLISH_PRIVILEGE_WILL_EXPIRE,null)}_onUserTokenPublishPrivilegeDidExpire(){this.safeEmit(OI.ON_TOKEN_PUBLISH_PRIVILEGE_DID_EXPIRED,null)}_onUserTokeSubscribePrivilegeWillExpire(){this.safeEmit(OI.ON_TOKEN_SUBSCRIBE_PRIVILEGE_WILL_EXPIRE,null)}_onUserTokenSubscribePrivilegeDidExpire(){this.safeEmit(OI.ON_TOKEN_SUBSCRIBE_PRIVILEGE_DID_EXPIRED,null)}async _onStreamFailed(e){if("publish"===e.type){var t,i;let o;if((null===(t=this.localStream)||void 0===t?void 0:t.streamId)===e.streamId?o=this.localStream:(null===(i=this.localScreenStream)||void 0===i?void 0:i.streamId)===e.streamId&&(o=this.localScreenStream),!o)return;await this._publisher.unpublish(o).catch((()=>{})),await this._publisher.cleanStream(o),await this._publisher.publish(o).catch((()=>{}))}else if("subscribe"===e.type){const t=this._remoteStreamStreamIdUserIdMap[e.streamId],i=this._findRemoteStream(t,e.streamId);if(i){const e=i.subMediaType,t=i.subLayer;await this._subscriber.unsubscribe(i),await this._subscriber.subscribe(i,e,t),this.safeEmit(wN.RESUBSCRIBE,{stream:i})}}}_onStreamControlMessage(e){var t,i;e.type===NI.PushLimitWarn&&(null!==(t=this._localStream)&&void 0!==t&&t.pubAudio||null!==(i=this._localStream)&&void 0!==i&&i.pubVideo||this.unpublish())}async _onPublishOnDemand(){var e,t,i;if(this._publishOnDemandItem&&!this._publishOnDemandBusy&&!1!==(null===(e=this._serverConfig)||void 0===e||null===(e=e.engine_VPM)||void 0===e||null===(e=e.ondemand)||void 0===e?void 0:e.enable)){if(null!==(t=this._localStream)&&void 0!==t&&t.videoTransceiver){this._publishOnDemandBusy=!0;const e=this._publishOnDemandItem;this._publishOnDemandItem=void 0;const t=[],i=this._localStream.stream.id,{sender:o}=this._localStream.videoTransceiver,r=o.getParameters();if(fS(this._ctx.id,"sender.getParameters",JSON.stringify(r),0,i),Array.isArray(r.encodings)&&Array.isArray(e)){const o={};this.logger.info("_onPublishOnDemand exec","usedDescriptions: %o",e),e.forEach((e=>{var t;if(null!==(t=e.StreamIds)&&void 0!==t&&t.includes(i)){var r,s,n;const t=null!==(r=null===(s=e.Metadata)||void 0===s?void 0:s.VideoIndex)&&void 0!==r?r:0;let i=0;var a,d;if(null!==(n=this._ctx.serverConfig)&&void 0!==n&&n.e2eFeedback)i=Math.max(...Object.keys(null!==(a=null===(d=e.Metadata)||void 0===d?void 0:d.VideoKbpsHist)&&void 0!==a?a:{}).map((e=>Number(e))),0);o[t]={kbps:i}}}));const s=[...this._localStream.pubAttributes.videoDescriptions];r.encodings=r.encodings.map((e=>{if(e.rid){if(o[e.rid]){var i;e.active=!0;const t=null===(i=o[e.rid])||void 0===i?void 0:i.kbps;t&&(e.maxBitrate=1e3*Sw(e.rid,t,s))}else e.active=!1;const r=Number(e.rid);t[r]=e.active}else{var r;const t=null===(r=o[0])||void 0===r?void 0:r.kbps;t&&(e.maxBitrate=1e3*Sw(void 0,t,s))}return e})),this.config.report("rtc_invoke_status",{sdk_api_name:"onPublishOnDemand",message:JSON.stringify(r.encodings),error_code:0,stream_id:i,elapse:0}),this._ctx.videoProfile.activeSimStreams=t}this.logger.info("sender.setParameters()",JSON.stringify(r.encodings)),fS(this._ctx.id,"sender.setParameters",JSON.stringify(r),0,i),await o.setParameters(r),this._publishOnDemandBusy=!1}else if(null===(i=this._localStream)||void 0===i||!i.videoTransceiver)return;this._onPublishOnDemand()}}_onRTT(e){const{StreamIds:t,Metadata:i}=e;if(null!=t&&t.length&&i){const e=t[0];this._ctx.streamRTT[e]={audio:i.audio_rtt,video:i.video_rtt}}}_onRSCP(e,t){!!e.find((e=>{var t,i;return null==e||null===(t=e.StreamIds)||void 0===t?void 0:t.includes(null===(i=this._localStream)||void 0===i||null===(i=i.stream)||void 0===i?void 0:i.id)}))&&(t?this._pubTransceiverReady=!0:this._onceTriggerBySignal=!0,t&&this._onceTriggerBySignal||(this._publishOnDemandItem=e),this._pubTransceiverReady&&this._onPublishOnDemand())}_onSSC(e){const{StreamIds:t,Metadata:i}=e,o=t[0],r=this._remoteStreamStreamIdUserIdMap[o],s=this._findRemoteStream(r,o),n={userId:r,isScreen:!!s&&s.isScreen,beforeVideoIndex:i.ssc_items[0].prev_layer_id,afterVideoIndex:i.ssc_items[0].cur_layer_id,beforeEnable:0!==i.ssc_items[0].prev_video_open,afterEnable:0!==i.ssc_items[0].cur_video_open,reason:i.ssc_items[0].change_reason};this.emit(wN.ON_SIMULCAST_SUBSCRIBE_FALLBACK,n)}_reportNetworkQuality(e,t){this.emit(wN.ON_NETWORK_QUALITY,e,t)}_emitVideoSizeChange(e,t,i,o){this.emit(wN.ON_REMOTE_VIDEO_SIZE_CHANGED,{roomId:this.config.roomId,userId:e,streamIndex:t?$u.STREAM_INDEX_SCREEN:$u.STREAM_INDEX_MAIN},{width:i,height:o})}async setAudioEncodeMaxBitrate(e,t){const i=e===$u.STREAM_INDEX_MAIN?this.localStream:this.localScreenStream;if(null!=i&&i.pubAudio){var o;const e=null===(o=i.audioTransceiver)||void 0===o?void 0:o.sender.getParameters();var r;if(fS(this._ctx.id,"sender.getParameters",JSON.stringify(e),0,i.streamId),null!=e&&e.encodings.length)e.encodings[0].maxBitrate=1e3*t,fS(this._ctx.id,"sender.setParameters",JSON.stringify(e),0,i.streamId),await(null===(r=i.audioTransceiver)||void 0===r?void 0:r.sender.setParameters(e))}}_onEngineControlMessage(e){let{type:t,body:i}=e;if(t===wI.CHANGE_CODEC){if(!Qg("SDK_CODEC_NEGOTIATION"))return void this.logger.info("_onEngineControlMessage","SDK_CODEC_NEGOTIATION is false, ignore");const{codec:e,media:t,streamId:n}=i;if(!t||"audio"===t)return;const a=e.split(",").map((e=>z_(e).call(e).toUpperCase()));let d;var o,r,s;if(this.logger.info("_onEngineControlMessage","changeCodec to %s",e),n)(null===(o=this.localStream)||void 0===o?void 0:o.streamId)===n?d=this.localStream:(null===(r=this.localScreenStream)||void 0===r?void 0:r.streamId)===n&&(d=this.localScreenStream),null===(s=d)||void 0===s||s.setChangeCodecs(a);else"video"===t?(d=this.localStream,this._ctx.targetCodec=a[0]):"screen"===t&&(d=this.localScreenStream,this._ctx.targetScreenCodec=a[0]);d&&this.emit(wN.UPDATE_PUBLISH,{streamIndex:d.isScreen?$u.STREAM_INDEX_SCREEN:$u.STREAM_INDEX_MAIN})}}}$D([uw],tU.prototype,"publishScreen",1),$D([uw],tU.prototype,"updatePubScreenTrack",1),$D([uw],tU.prototype,"unpublishScreen",1),$D([uw],tU.prototype,"liveControlMessage",1),$D([uw],tU.prototype,"publicStreamControlMessage",1),$D([uw],tU.prototype,"updateUserAttributes",1),$D([uw],tU.prototype,"publish",1),$D([uw],tU.prototype,"updatePubTrack",1),$D([uw],tU.prototype,"unpublish",1),$D([uw],tU.prototype,"subscribe",1),$D([uw],tU.prototype,"updateSubVideoConfig",1),$D([uw],tU.prototype,"unsubscribe",1),$D([uw],tU.prototype,"startSubtitle",1),$D([uw],tU.prototype,"stopSubtitle",1),$D([uw],tU.prototype,"startForwardStream2Rooms",1),$D([uw],tU.prototype,"updateForwardStream2Rooms",1),$D([uw],tU.prototype,"stopForwardStream2Rooms",1),$D([uw],tU.prototype,"pauseForwardStream2AllRooms",1),$D([uw],tU.prototype,"resumeForwardStream2AllRooms",1),$D([uw],tU.prototype,"updateMediaParams",1),$D([uw],tU.prototype,"updateRemoteUserPriority",1),$D([uw],tU.prototype,"updateToken",1),$D([uw],tU.prototype,"sendUserMessage",1),$D([uw],tU.prototype,"sendRoomMessage",1),$D([uw],tU.prototype,"maybeFillBackFrame2Stream",1);const iU=async(e,t)=>{const i=new Audio(gP.createObjectURL(new Blob([e],t)));try{return i.muted=!0,await i.play(),i.pause(),!0}catch(o){return!1}};var oU=Object.defineProperty,rU=Object.getOwnPropertyDescriptor,sU=(e,t,i,o)=>{for(var r,s=o>1?void 0:o?rU(t,i):t,n=e.length-1;n>=0;n--)(r=e[n])&&(s=(o?r(t,i,s):r(s))||s);return o&&s&&oU(t,i,s),s};class nU{constructor(e,t){Xu(this,"_sharedAudioContext",new AudioContext),Xu(this,"_workletReady",void 0),Xu(this,"_audioDestination",this._sharedAudioContext.createMediaStreamDestination()),Xu(this,"_localGainNode",this._sharedAudioContext.createGain()),Xu(this,"_bufferGainNode",this._sharedAudioContext.createGain()),Xu(this,"_audioBufferSource",void 0),Xu(this,"_localSource",void 0),Xu(this,"_context",void 0),Xu(this,"_failedAudioList",[]),Xu(this,"_startingIds",new Map),Xu(this,"_revokeURLs",new Set),Xu(this,"_audioFetchMap",new Map),Xu(this,"_audioFetchConfig",new Map),Xu(this,"mixingMap",new Map),Xu(this,"resourcesCache",new Map),Xu(this,"volumeConfig",new Map),Xu(this,"cachedBuffer",[]),Xu(this,"id","AudioMixingManager"),this.engineId=t,this._context=e;try{var i,o;this._workletReady=null===(i=this._sharedAudioContext.audioWorklet)||void 0===i||null===(o=i.addModule)||void 0===o?void 0:o.call(i,XP),this._workletReady.catch((()=>{this._workletReady=null}))}catch(r){this._workletReady=null}this._localGainNode.gain.value=1}mixMediaStream(e){this._localSource&&this._localSource.disconnect(this._localGainNode),this._localSource=this._sharedAudioContext.createMediaStreamSource(e),this._localSource.connect(this._localGainNode).connect(this._audioDestination)}async startAudioMixing(e,t,i){if(void 0!==this._startingIds.get(e))return void console.warn("AudioMixing task id: ".concat(e," is starting"));this._startingIds.set(e,e);const{playCount:o,type:r}=i;wg(r,"mixingType",jN(Oh));const s=this._context.getLocalAudioTrack();if(!s)return;const n=s.preprocessingTrack;n&&this.mixMediaStream(new MediaStream([n])),s.once("needReplaceTrack",(()=>{this.mixMediaStream(new MediaStream([s.preprocessingTrack]))}));const a=this.mixingMap.get(e);if(null!=a&&a.audioNode){a.audioNode.pause(),this._context.emitMessage({mixId:e,state:Mh.AUDIO_MIXING_STATE_STOPPED,error:Rg.AUDIO_MIXING_ERROR_OK});try{a.gainNode.disconnect(this._audioDestination),a.audioSource.disconnect(a.gainNode)}catch(_){}}let d;const c=this.resourcesCache.get(e);if(c&&c.filePath===t)d=c.getAudioNode();else{const i=await fetch(t,{mode:"cors"}).then((t=>{if(t.ok)return t.arrayBuffer();throw this._context.emitMessage({mixId:e,state:Mh.AUDIO_MIXING_STATE_FAILED,error:Rg.AUDIO_MIXING_ERROR_START_FAILED}),this._startingIds.delete(e),this.mixingMap.delete(e),new Cg(Eg.LOAD_RESOURCES_FAILED,t.statusText)}));let o;t.endsWith("mp3")?o={type:"audio/mpeg"}:t.endsWith("aac")&&(o={type:"audio/aac"});if(!(await iU(i,o)))throw this._context.emitMessage({mixId:e,state:Mh.AUDIO_MIXING_STATE_FAILED,error:Rg.AUDIO_MIXING_ERROR_START_FAILED}),this._startingIds.delete(e),this.mixingMap.delete(e),new Cg(Eg.LOAD_RESOURCES_FAILED,"invalid audio resource");d=new Audio,d.crossOrigin="anonymous",d.src=gP.createObjectURL(new Blob([i],o))}if(o<=0)d.loop=!0;else if(o>0){let t=o;d.onended=()=>{--t>0?d.play():(this.mixingMap.delete(e),this._context.emitMessage({mixId:e,state:Mh.AUDIO_MIXING_STATE_FINISHED,error:Rg.AUDIO_MIXING_ERROR_OK}))}}try{await d.play()}catch(_){console.error(_),this._failedAudioList.push(d),this._context.onAutoPlayFailed({userId:this.id,kind:"audio",streamIndex:$u.STREAM_INDEX_MAIN,mediaType:eh.AUDIO})}this._startingIds.delete(e);const l=this._sharedAudioContext.createMediaElementSource(d),u=this._sharedAudioContext.createGain(),h=this.volumeConfig.get(e);if(u.gain.value=h?h/100:1,l.connect(u).connect(this._audioDestination),this.mixingMap.set(e,{audioSource:l,audioNode:d,gainNode:u,type:"file"}),r===Oh.PUBLISH)try{u.disconnect(this._sharedAudioContext.destination)}catch(_){}else u.connect(this._sharedAudioContext.destination);this._context.updateLocalAudioTrack(this._audioDestination.stream.getAudioTracks()[0],i.type),this._context.emitMessage({mixId:e,state:Mh.AUDIO_MIXING_STATE_PLAYING,error:Rg.AUDIO_MIXING_ERROR_OK}),this.updateFetcher(e)}stopAudioMixing(e){const t=this.mixingMap.get(e);t&&"file"===t.type&&(this.mixingMap.delete(e),t.audioNode.pause(),t.audioSource.disconnect(t.gainNode),t.gainNode.disconnect(this._audioDestination),this.updateFetcher(e),this._context.emitMessage({mixId:e,state:Mh.AUDIO_MIXING_STATE_STOPPED,error:Rg.AUDIO_MIXING_ERROR_OK}))}pauseAudioMixing(e){const t=this.mixingMap.get(e);t&&(this._context.emitMessage({mixId:e,state:Mh.AUDIO_MIXING_STATE_PAUSED,error:Rg.AUDIO_MIXING_ERROR_OK}),t.audioNode.pause())}resumeAudioMixing(e){const t=this.mixingMap.get(e);t&&(this._context.emitMessage({mixId:e,state:Mh.AUDIO_MIXING_STATE_PLAYING,error:Rg.AUDIO_MIXING_ERROR_OK}),t.audioNode.play())}async preloadAudioMixing(e,t){this.stopAudioMixing(e);const i=await fetch(t,{mode:"cors"}).then((e=>{if(e.ok)return e.arrayBuffer();throw new Cg(Eg.LOAD_RESOURCES_FAILED,e.statusText)})).catch((t=>{if(this._context.emitMessage({mixId:e,state:Mh.AUDIO_MIXING_STATE_FAILED,error:Rg.AUDIO_MIXING_ERROR_PRELOAD_FAILED}),t instanceof Cg)throw t;throw new Cg(Eg.LOAD_RESOURCES_FAILED,"Load resources failed",t)}));let o;t.endsWith("mp3")?o={type:"audio/mpeg"}:t.endsWith("aac")&&(o={type:"audio/aac"});if(!(await iU(i,o)))throw this._context.emitMessage({mixId:e,state:Mh.AUDIO_MIXING_STATE_FAILED,error:Rg.AUDIO_MIXING_ERROR_PRELOAD_FAILED}),new Cg(Eg.LOAD_RESOURCES_FAILED,"Load resources failed");this._context.emitMessage({mixId:e,state:Mh.AUDIO_MIXING_STATE_PRELOADED,error:Rg.AUDIO_MIXING_ERROR_OK}),this.resourcesCache.set(e,{getAudioNode:()=>{const e=gP.createObjectURL(new Blob([i],o));return this._revokeURLs.add(e),new Audio(e)},filePath:t,duration:0}),await new Promise((t=>{const r=gP.createObjectURL(new Blob([i],o)),s=new Audio(r);s.addEventListener("durationchange",(()=>{const i=this.resourcesCache.get(e);i&&(i.duration=s.duration,this.resourcesCache.set(e,i)),gP.revokeObjectURL(r),t(null)}))}))}unloadAudioMixing(e){this.resourcesCache.has(e)&&this.resourcesCache.delete(e)}getAudioMixingVolume(e){const t=this.mixingMap.get(e);return t?100*t.gainNode.gain.value:0}setAudioMixingVolume(e,t){t<0?t=0:t>400&&(t=400),this.volumeConfig.set(e,t);const i=this.mixingMap.get(e);i&&(i.gainNode.gain.value=Number(t)/100)}getAudioMixingDuration(e){const t=this.mixingMap.get(e),i=this.resourcesCache.get(e);return t||i?t?1e3*t.audioNode.duration:i?1e3*i.duration:0:0}getAudioMixingCurrentPosition(e){const t=this.mixingMap.get(e);return t?1e3*t.audioNode.currentTime:0}setAudioMixingPosition(e,t){const i=this.mixingMap.get(e);i&&(i.audioNode.currentTime=t/1e3,i.audioNode.play())}setAudioFrameCallback(e,t){var i;let o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:4096;if(wg(o,"frameSize",[256,512,1024,2048,4096,8192,16384]),o=null!==(i=o)&&void 0!==i?i:4096,null===this._workletReady)throw new Cg(Eg.NOT_SUPPORTED,"Not support AudioWorklet");t?this._audioFetchConfig.set(e,{callback:t,frameSize:o}):this._audioFetchConfig.delete(e),this.updateFetcher(e)}updateFetcher(e){var t,i;const{callback:o,frameSize:r}=null!==(t=this._audioFetchConfig.get(e))&&void 0!==t?t:{},s=null===(i=this.mixingMap.get(e))||void 0===i?void 0:i.gainNode;if(s&&o&&r){let t=this._audioFetchMap.get(e);t?t.setFrameSize(r):t=new HP(s,r,this._sharedAudioContext,this._workletReady),t.on("data",o),this._audioFetchMap.set(e,t)}else{const t=this._audioFetchMap.get(e);null==t||t.removeAllListeners("data"),null==t||t.destroy(),this._audioFetchMap.delete(e)}}enableAudioMixingBuffer(e){wg(e,"type",jN(Oh));const t=this._context.getLocalAudioTrack();if(!t)return;const i=t.preprocessingTrack;if(i&&this.mixMediaStream(new MediaStream([i])),e===Oh.PUBLISH)try{this._bufferGainNode.disconnect(this._sharedAudioContext.destination)}catch(o){}else this._bufferGainNode.connect(this._sharedAudioContext.destination);this._context.updateLocalAudioTrack(this._audioDestination.stream.getAudioTracks()[0],e),this._bufferGainNode.connect(this._audioDestination),this._context.emitMessage({mixId:-1,state:Mh.AUDIO_MIXING_STATE_PCM_ENABLED,error:Rg.AUDIO_MIXING_ERROR_OK})}disableAudioMixingBuffer(){if(this.cachedBuffer=[],this._audioBufferSource){try{this._audioBufferSource.onended=null,this._audioBufferSource.disconnect(this._bufferGainNode),this._bufferGainNode.disconnect(this._audioDestination),this._bufferGainNode.disconnect(this._sharedAudioContext.destination)}catch(e){}finally{this._audioBufferSource=void 0}this._context.updateLocalAudioTrack(),this._context.emitMessage({mixId:-1,state:Mh.AUDIO_MIXING_STATE_PCM_DISABLED,error:Rg.AUDIO_MIXING_ERROR_OK})}}pushAudioMixingBuffer(e){if(!(this._audioBufferSource&&(this.cachedBuffer.push(e),this.cachedBuffer.length>0))){this._audioBufferSource=this._sharedAudioContext.createBufferSource(),this._audioBufferSource.buffer=e,this._audioBufferSource.connect(this._bufferGainNode);try{this._audioBufferSource.start()}catch(t){this._failedAudioList.push(this._audioBufferSource)}this._audioBufferSource.onended=()=>{var e;if(null===(e=this._audioBufferSource)||void 0===e||e.disconnect(this._bufferGainNode),this._audioBufferSource=void 0,this.cachedBuffer.length){const e=this.cachedBuffer.shift();e&&this.pushAudioMixingBuffer(e)}}}}stopAll(){if(this._localSource)try{this._localSource.disconnect(this._localGainNode),delete this._localSource}catch(e){}this.mixingMap.forEach(((e,t)=>{this.stopAudioMixing(t)}))}get mixTrack(){return this._audioDestination.stream.getAudioTracks()[0]}get sharedAudioContext(){return this._sharedAudioContext}async resumeLocalPlay(){const e=[];for(const i of this._failedAudioList)try{i instanceof HTMLAudioElement?(i.muted=!1,await i.play()):i.start()}catch(t){e.push(i),console.error(t),this._context.onAutoPlayFailed({userId:this.id,kind:"audio",streamIndex:$u.STREAM_INDEX_MAIN,mediaType:eh.AUDIO});break}this._failedAudioList=e}destroy(){const{_sharedAudioContext:e}=this;"closed"!==e.state&&"function"==typeof e.close&&e.close(),this.cachedBuffer=[],this.mixingMap.clear(),this.resourcesCache.clear(),this.volumeConfig.clear(),this._startingIds=new Map,this._revokeURLs.forEach((e=>{gP.revokeObjectURL(e)}))}}sU([mS(["id","filePath","options"])],nU.prototype,"startAudioMixing",1),sU([mS(["id"])],nU.prototype,"stopAudioMixing",1),sU([mS(["id"])],nU.prototype,"pauseAudioMixing",1),sU([mS(["id"])],nU.prototype,"resumeAudioMixing",1),sU([mS(["id"])],nU.prototype,"preloadAudioMixing",1),sU([mS(["id"])],nU.prototype,"unloadAudioMixing",1),sU([mS(["id"])],nU.prototype,"getAudioMixingVolume",1),sU([mS(["id","volume"])],nU.prototype,"setAudioMixingVolume",1),sU([mS(["id"])],nU.prototype,"getAudioMixingDuration",1),sU([mS(["id"])],nU.prototype,"getAudioMixingCurrentPosition",1),sU([mS(["id","position"])],nU.prototype,"setAudioMixingPosition",1),sU([mS(["id","callback","frameSize"])],nU.prototype,"setAudioFrameCallback",1),sU([mS(["type"])],nU.prototype,"enableAudioMixingBuffer",1),sU([mS()],nU.prototype,"disableAudioMixingBuffer",1),sU([mS(["buffer"])],nU.prototype,"pushAudioMixingBuffer",1);class aU extends EI.EventEmitter{constructor(e){super(),Xu(this,"_loginSessionId",null),Xu(this,"_userId",null),Xu(this,"_token",null),Xu(this,"_loginResolveCallback",void 0),Xu(this,"_loginRejectCallback",void 0),Xu(this,"_waitLoginToken",!1),Xu(this,"_serverParamsCache",void 0),Xu(this,"id",void 0),Xu(this,"logger",void 0),Xu(this,"_clearListeners",void 0),this._ctx=e,this.id=e.id,this.logger=new LS("RTSClient",1,e.id)}login(e,t){return new Promise(((i,o)=>{var r;if(this.logger.info("login","invoke login, token: %o, userId: %o",e,t),this._loginSessionId)throw new Cg(Eg.ALREADY_LOGIN,"Already logined");if(this._loginResolveCallback)throw new Cg(Eg.LOGIN_FAILED,"Is logging in, please try again later.");this._userId=t,this._token=e,null===(r=uS(this.id))||void 0===r||r.set({rtm_user_id:t}),this._loginResolveCallback=i,this._loginRejectCallback=o,this._ctx.signalingManager.connect().then((()=>{this._addSignalEventHandler(),this._login()}))}))}async logout(){if(!this._loginSessionId||!this._userId)throw new Cg(Eg.NOT_LOGIN,"login first");this._checkNotInLimitMode("logout"),await this._ctx.signalingManager.sendSignaling("logout",{loginSessionId:this._loginSessionId,userId:this._userId,appId:this._ctx.appId},{functionType:nw.C2RTM}).catch((()=>{})),this._clearState()}async updateLoginToken(e){return this._checkNotInLimitMode("updateLoginToken"),this._token=e,new Promise(((e,t)=>{this._waitLoginToken?(this._loginResolveCallback=e,this._loginRejectCallback=t,this._login()):e()}))}async getPeerOnlineStatus(e){if(!this._loginSessionId||!this._userId)throw new Cg(Eg.NOT_LOGIN,"login first");this._checkNotInLimitMode("getPeerOnlineStatus");const t=await this._ctx.signalingManager.sendSignaling("getPeerOnlineStatus",{loginSessionId:this._loginSessionId,userId:this._userId,appId:this._ctx.appId,peerUserId:e},{functionType:nw.C2RTM});return null==t?void 0:t.status}async sendUserMessageOutsideRoom(e,t){if(!this._loginSessionId||!this._userId)throw new Cg(Eg.NOT_LOGIN,"login first");return this._checkNotInLimitMode("sendUserMessageOutsideRoom"),this._ctx.rtsLimiter.e2e.check(t),this._ctx.signalingManager.sendP2PMessage({from:this._userId,app:this._ctx.appId,to:e,room:"",msg:t})}async setRTSMessageLimit(e){e&&this._ctx.signalingManager.sendSignaling("RTSMessageLimit",{appId:this._ctx.appId,interval:e.rts_qps_interval,broadcast:e.rts_broadcast_qps_value,one2one:e.rts_e2e_qps_value,e2bs:e.rts_e2s_qps_value},{functionType:nw.C2RTM}).catch((()=>{}))}async setServerParams(e,t){try{if(Ng(e,"signature"),Ng(t,"url"),!this._loginSessionId||!this._userId)throw new Cg(Eg.NOT_LOGIN,"login first");await this._ctx.signalingManager.sendSignaling("setServerParams",{loginSessionId:this._loginSessionId,userId:this._userId,appId:this._ctx.appId,signature:e,url:t},{functionType:nw.C2RTM}).catch((e=>{throw new Cg(Eg.UNEXPECTED_ERROR,e.msg)})),Xf(this.id,t),this._serverParamsCache={signature:e,url:t},this.emit("onServerParamsSetResult")}catch(i){throw this.emit("onServerParamsSetResult",i),i}}async sendServerMessage(e){if(!this._loginSessionId||!this._userId)throw new Cg(Eg.NOT_LOGIN,"login first");return this._checkNotInLimitMode("sendServerMessage"),this._ctx.rtsLimiter.e2s.check(e),this._ctx.signalingManager.sendP2PMessage({from:this._userId,app:this._ctx.appId,to:"",room:"",type:ew.BUSINESS_SERVER,msg:e})}destroy(){this.logger.info("destroy","invoke."),super.removeAllListeners(),this._loginResolveCallback&&this._loginRejectCallback&&(this._loginRejectCallback(new Cg(Eg.LOGIN_FAILED,"logout")),delete this._loginResolveCallback,delete this._loginRejectCallback),this._clearState(),delete this._serverParamsCache}_login(){var e;if(!this._userId)return;const t=Jy();try{this._checkNotInLimitMode("login")}catch(o){var i;null===(i=this._loginRejectCallback)||void 0===i||i.call(this,o)}this._ctx.signalingManager.sendSignaling("login",{Token:Qy.token2auth(this._ctx.appId,null,this._userId,this._token),timestamp:Date.now(),loginSessionId:t,params:{userAgent:window.navigator.userAgent,sdkVersion:jg.VERSION,deviceId:bg.getDeviceId(),appId:this._ctx.appId,userId:this._userId,deviceType:"web",platformType:2,rtsMode:this._ctx.rtsMode,mediaProcessingType:null!==(e=jg.MEDIA_PROCESSING_TYPE)&&void 0!==e?e:0},accessParams:JSON.stringify({requireICEUfragV2:!0})},{functionType:nw.C2RTM}).then((()=>{"function"==typeof this._loginResolveCallback&&this._loginResolveCallback(),this._loginSessionId=t,Ff(this.id,t),this._waitLoginToken=!1,this._serverParamsCache&&this.setServerParams(this._serverParamsCache.signature,this._serverParamsCache.url)})).catch((e=>{const{code:t,message:i}=e||{};let o,r;this._waitLoginToken=!1,t>=700&&t<800?708===t?(o=Eg.INVALID_PARAMS,r="Invalid userId"):(o=Eg.INVALID_TOKEN,r="Invalid token",this._waitLoginToken=!0,this._loginRejectCallback||this.emit("onRTMTokenError")):(o=Eg.LOGIN_FAILED,r="login failed"),"function"==typeof this._loginRejectCallback&&this._loginRejectCallback(new Cg(o,i||r))})).finally((()=>{delete this._loginResolveCallback,delete this._loginRejectCallback}))}_addSignalEventHandler(){const e=e=>{e.state===ih.CONNECTION_STATE_RECONNECTED&&this._login()},t=()=>this._clearState(),i=e=>{this.emit("onUserMessageReceivedOutsideRoom",{userId:e.from,message:e.msg})},o=e=>{this.emit("onUserBinaryMessageReceivedOutsideRoom",{userId:e.from,message:e.msg})},r=e=>{e.clientId!==this._userId||e.roomId||(this.emit("onUserDisconnection"),this._clearState())};this._ctx.signalingManager.on(LI.ON_CONNECTION_STATE_CHANGE,e),this._ctx.signalingManager.on(LI.ON_RECONNECT_FAILED,t),this._ctx.signalingManager.on(OI.USER_MESSAGE_RECEIVED_OUTSIDE_ROOM,i),this._ctx.signalingManager.on(OI.USER_BINARY_MESSAGE_RECEIVED_OUTSIDE_ROOM,o),this._ctx.signalingManager.on(OI.USER_DISCONNECTION,r),this._clearListeners=()=>{this._ctx.signalingManager.off(LI.ON_CONNECTION_STATE_CHANGE,e),this._ctx.signalingManager.off(LI.ON_RECONNECT_FAILED,t),this._ctx.signalingManager.off(OI.USER_MESSAGE_RECEIVED_OUTSIDE_ROOM,i),this._ctx.signalingManager.off(OI.USER_BINARY_MESSAGE_RECEIVED_OUTSIDE_ROOM,o),this._ctx.signalingManager.off(OI.USER_DISCONNECTION,r)}}_clearState(){var e;null===(e=this._clearListeners)||void 0===e||e.call(this),this._userId=null,this._token=null,this._loginSessionId=null,Ff(this.id,"")}_checkNotInLimitMode(e){if(this._ctx.rtsMode===DI.LIMIT_MODE)throw new Cg(Eg.NOT_ALLOWED_IN_RESTRICTED_MODE,"not allow to call ".concat(e," in rts restricted mode"))}}var dU=(e=>(e.onWTNPushStateChanged="onWTNPushStateChanged",e.onWTNPlayStateChanged="onWTNPlayStateChanged",e.onWTNRemoteAudioStateChanged="onWTNRemoteAudioStateChanged",e.onWTNRemoteVideoStateChanged="onWTNRemoteVideoStateChanged",e.onWTNRemoteVideoStats="onWTNRemoteVideoStats",e.onWTNRemoteAudioStats="onWTNRemoteAudioStats",e.onWTNFirstRemoteVideoFrameDecoded="onWTNFirstRemoteVideoFrameDecoded",e.onWTNSEIMessageReceived="onWTNSEIMessageReceived",e))(dU||{}),cU=(e=>(e[e.INIT=0]="INIT",e[e.START=1]="START",e[e.SUCCESS=2]="SUCCESS",e[e.STOP=3]="STOP",e[e.FAIL=4]="FAIL",e))(cU||{}),lU=(e=>(e[e.PUSH_SUCCESS=0]="PUSH_SUCCESS",e[e.START_PUSH=1]="START_PUSH",e[e.STOP_PUSH=2]="STOP_PUSH",e[e.IN_RETRY=3]="IN_RETRY",e[e.RETRY_FAIL=4]="RETRY_FAIL",e[e.NO_PUSH_PERMISSION=5]="NO_PUSH_PERMISSION",e[e.STREAM_PUSH_BY_OTHER=6]="STREAM_PUSH_BY_OTHER",e))(lU||{}),uU=(e=>(e[e.INIT=0]="INIT",e[e.START=1]="START",e[e.SUCCESS=2]="SUCCESS",e[e.STOP=3]="STOP",e[e.FAIL=4]="FAIL",e))(uU||{}),hU=(e=>(e[e.PLAY_SUCCESS=0]="PLAY_SUCCESS",e[e.START_PLAY=1]="START_PLAY",e[e.STOP_PLAY=2]="STOP_PLAY",e[e.REMOTE_STOP=3]="REMOTE_STOP",e[e.REMOTE_FAILURE=4]="REMOTE_FAILURE",e[e.STREAM_BANNED=5]="STREAM_BANNED",e[e.NO_PLAY_PERMISSION=6]="NO_PLAY_PERMISSION",e[e.STREAM_NOT_EXIST=7]="STREAM_NOT_EXIST",e[e.IN_RETRY=8]="IN_RETRY",e[e.RETRY_FAIL=9]="RETRY_FAIL",e[e.INTERNAL=10]="INTERNAL",e[e.OVER_CLIENT_SUBSCRIBE_STREAM_LIMIT=1310]="OVER_CLIENT_SUBSCRIBE_STREAM_LIMIT",e[e.OVER_STREAM_SUBSCRIBE_USER_LIMIT=1311]="OVER_STREAM_SUBSCRIBE_USER_LIMIT",e[e.OVER_STREAM_SUBSCRIBE_REQUES_TLIMIT=1312]="OVER_STREAM_SUBSCRIBE_REQUES_TLIMIT",e))(hU||{}),_U=(e=>(e[e.STOPED=0]="STOPED",e[e.STARTING=1]="STARTING",e[e.DECODING=2]="DECODING",e[e.FROZEN=3]="FROZEN",e[e.FAILED=4]="FAILED",e))(_U||{}),mU=(e=>(e[e.INTERNAL=0]="INTERNAL",e[e.NETWORK_CONGESTION=1]="NETWORK_CONGESTION",e[e.NETWORK_RECOVERY=2]="NETWORK_RECOVERY",e[e.UNMUTE=3]="UNMUTE",e[e.MUTE=4]="MUTE",e[e.REMOTE_START=5]="REMOTE_START",e[e.REMOTE_STOP=6]="REMOTE_STOP",e))(mU||{}),pU=(e=>(e[e.STOPED=0]="STOPED",e[e.STARTING=1]="STARTING",e[e.DECODING=2]="DECODING",e[e.FROZEN=3]="FROZEN",e[e.FAILED=4]="FAILED",e))(pU||{}),vU=(e=>(e[e.INTERNAL=0]="INTERNAL",e[e.NETWORK_CONGESTION=1]="NETWORK_CONGESTION",e[e.NETWORK_RECOVERY=2]="NETWORK_RECOVERY",e[e.UNMUTE=3]="UNMUTE",e[e.MUTE=4]="MUTE",e[e.REMOTE_START=5]="REMOTE_START",e[e.REMOTE_STOP=6]="REMOTE_STOP",e))(vU||{});const fU={interval:1e3,retryDuration:0};class SU extends PN{constructor(e,t,i){let o=arguments.length>3&&void 0!==arguments[3]&&arguments[3];super(i,xP.STREAM_INDEX_MAIN),Xu(this,"_state",cU.INIT),Xu(this,"_stateChangeTs",jy()),Xu(this,"streamId",void 0),Xu(this,"Authorization",void 0),Xu(this,"_backOff",fU),this.token=t,this.streamId=e,this.logName="WTNLocalStream-".concat(e),this.observer=new DN(this._ctx,this),this.Authorization=Qy.token2auth(i.appId,"",e,t),this._state=o?cU.FAIL:cU.INIT}setState(e,t){const i=this._state;if(i===e)return;this.logger.print("setState",e,t),this._state=e;const o=jy();this.safeEmit(dU.onWTNPushStateChanged,{streamId:this.streamId,oldState:i,newState:e,reason:t,elapse:o-this._stateChangeTs}),this._stateChangeTs=o}getPushBackOff(){return this._backOff}updatePushBackOff(){this._backOff.retryDuration+=this._backOff.interval,this._backOff.interval=this._backOff.interval>4e3?8e3:2*this._backOff.interval}resetPushBackOff(){this._backOff=fU}}class gU extends NN{constructor(e,t,i){let o=arguments.length>3&&void 0!==arguments[3]&&arguments[3];super(i,e,e,!1,!0,{audiostream:!0,localaudio:!0,videostream:!0,localvideo:!0,extaudio:!1,extvideo:!1,videoDescriptions:[]}),Xu(this,"_state",uU.INIT),Xu(this,"Authorization",void 0),Xu(this,"_stateChangeTs",jy()),Xu(this,"streamId",void 0),Xu(this,"_backOff",fU),Xu(this,"_audioState",_U.STOPED),Xu(this,"_videoState",pU.STOPED),this.token=t,this.streamId=e,this.logName="WTNRemoteStream-".concat(e),this.observer=new VN(this._ctx,this),this._initObserverEvent(o),this.Authorization=Qy.token2auth(i.appId,"",e,t),this._state=o?uU.FAIL:uU.INIT}setState(e,t){const i=this._state;if(i===e)return;this.logger.print("setState",e,t),this._state=e;const o=jy();this.safeEmit(dU.onWTNPlayStateChanged,{streamId:this.streamId,oldState:i,newState:e,reason:t,elapse:o-this._stateChangeTs}),this._stateChangeTs=o}get state(){return this._state}getPushBackOff(){return this._backOff}updatePushBackOff(){this._backOff.retryDuration+=this._backOff.interval,this._backOff.interval=this._backOff.interval>4e3?8e3:2*this._backOff.interval}resetPushBackOff(){this._backOff=fU}setVideoState(e,t){this._videoState!==e&&(e===pU.DECODING&&this.setVideoState(pU.STARTING,t),this.logger.print("setVideoState",e,t),this._videoState=e,this.safeEmit(dU.onWTNRemoteVideoStateChanged,{streamId:this.streamId,state:e,reason:t}))}setAudioState(e,t){this._audioState!==e&&(e===_U.DECODING&&this.setAudioState(_U.STARTING,t),this.logger.print("setAudioState",e,t),this._audioState=e,this.safeEmit(dU.onWTNRemoteAudioStateChanged,{streamId:this.streamId,state:e,reason:t}))}muteToSubMediaType(e,t){let i=!1;const o=rb(this.subMediaType),r=sb(this.subMediaType);return"boolean"==typeof e&&o===e&&(this.subMediaType+=e?-eh.AUDIO:eh.AUDIO,i=!0),"boolean"==typeof t&&r===t&&(this.subMediaType+=t?-eh.VIDEO:eh.VIDEO,i=!0),i}getEnableMediaType(){return{audio:rb(this.subMediaType),video:sb(this.subMediaType)}}_initObserverEvent(e){var t,i;null===(t=this.observer)||void 0===t||t.once("recvAudioFirstFrame",(()=>{this.setAudioState(_U.DECODING,e?mU.NETWORK_RECOVERY:mU.REMOTE_START)})),null===(i=this.observer)||void 0===i||i.once("recvVideoFirstFrame",(()=>{this.setVideoState(pU.DECODING,e?vU.NETWORK_RECOVERY:vU.REMOTE_START)}))}}const yU=["rid"];var bU=Object.defineProperty,TU=Object.getOwnPropertyDescriptor,IU=(e,t,i,o)=>{for(var r,s=o>1?void 0:o?TU(t,i):t,n=e.length-1;n>=0;n--)(r=e[n])&&(s=(o?r(t,i,s):r(s))||s);return o&&s&&bU(t,i,s),s};class EU extends kI{constructor(e){super(),Xu(this,"_reportName","WTNStream"),Xu(this,"_localStreams",new Map),Xu(this,"_remoteStreams",new Map),Xu(this,"_logger",void 0),Xu(this,"_monitor",void 0),Xu(this,"_ontrackCallbackMap",new Map),Xu(this,"_pushTaskMap",new Map),Xu(this,"_playTaskMap",new Map),Xu(this,"engineId",void 0),Xu(this,"_publicVideoPlayerConfig",new Map),Xu(this,"__onSEIMessageReceived",void 0),Xu(this,"__onRemoteStreamStats",void 0),Xu(this,"__onResubscribe",void 0),Xu(this,"__onPlayerEvents",void 0),Xu(this,"_clearSignalListeners",void 0),this._ctx=e,this._monitor=uS(e.id),this._logger=new LS("WTNStream",1,e.id),this.engineId=e.id,this._addSignalListeners()}async startPushWTN(e,t,i,o){let r=arguments.length>4&&void 0!==arguments[4]&&arguments[4];if(i=!!i,o=!!o,this._logger.print("startPushWTN",e,t,i,o),Zg(t),!Vg(e)&&Ng(e,"token"),this._localStreams.get(t))return;const s=new SU(t,e,this._ctx,r);this._addLocalStreamEventHandler(s),s.setState(cU.START,lU.START_PUSH),this._localStreams.set(t,s),await this._ctx.signalingManager.connect(),s.videoTrack=this._ctx.localVideoTrack,s.audioTrack=this._ctx.localAudioTrack,s.pubAudio=!o,s.pubVideo=!i,await new Promise(((e,i)=>{r||this._pushTaskMap.set(t,{resolve:()=>{e(),s.startReport((()=>{}),this._ctx.handler)},reject:i}),this._sendStartPushStreamSignal(s).catch((e=>i(e)))}))}async stopPushWTN(e){this._logger.print("stopPushWTN",e);const t=this._localStreams.get(e);t&&(t.setState(cU.STOP,lU.STOP_PUSH),this._ctx.signalingManager.sendSignaling("stopPushStream",{appId:this._ctx.appId,streamId:e}).catch((()=>{})),await this._stopLocalStream(t))}async muteWTNLocalAudio(e,t){this._logger.print("muteWTNLocalAudio",e,t);const i=this._localStreams.get(e);if(!i)throw new Cg(Eg.INVALID_PARAMS,"streamId not found");this._assertNotConnect(),i.pubAudio=!t,await this._updatePushStream(i)}async muteWTNLocalVideo(e,t){this._logger.print("muteWTNLocalVideo",e,t);const i=this._localStreams.get(e);if(!i)throw new Cg(Eg.INVALID_PARAMS,"streamId not found");this._assertNotConnect(),i.pubVideo=!t,await this._updatePushStream(i)}sendWTNSEIMessage(e,t,i){this._logger.info("sendWTNSEIMessage()","streamId: %o, sei: %o, repeatCount: %o",e,t,i);const o=this._localStreams.get(e);if(!o||!o.pubVideo&&!o.pubAudio)return;if(!sE()&&!rE())return cb("Your browser does not support sending SEI"),!1;Pg(i,"repeatCount",0,30);const r="string"==typeof t?new Uint8Array(Qy.str2ab(t)):t;if(!t.length)return this._logger.warn("sei message must not be empty"),!1;if(r.byteLength>4096)return void this._logger.warn("sei size must not bigger than 4KB");$S||this._maybeFillBackFrame2Stream(o);const s=Jy();o.sendSEIMessage({content:r,uuid:s,repeatCount:i+1}),setTimeout((async()=>{if(!o)return;var e;await o.revokeSEIMessage(s)&&(console.error("[RTC WebSDK] sei timeout for message: %o",t),null===(e=this._monitor)||void 0===e||e.report("rtc_sdk_callback",{sdk_callback_name:"sendSEIMessage",message:"timeout for message: ".concat(t),error_code:400}))}),Qg("SEI_TIME_OUT"))}async startPlayWTN(e,t,i,o){var r;let s=arguments.length>4&&void 0!==arguments[4]&&arguments[4];i=!!i,o=!!o,this._logger.print("startPlayWTN",e,t,i,o),Zg(t),!Vg(e)&&Ng(e,"token");let n=this._remoteStreams.get(t);if(n){if(n.state===uU.START||n.state===uU.SUCCESS)throw new Cg(Eg.REPEAT_PLAY,"repeat play public media stream");await this.stopPlayWTN(n.streamId)}n=new gU(t,e,this._ctx,s),this._addRemoteStreamEventHandler(n),n.setState(uU.START,hU.START_PLAY),n.muteToSubMediaType(o,i),this._remoteStreams.set(t,n),null===(r=n.observer)||void 0===r||r.setLogin(!0,n.getEnableMediaType());try{await this._ctx.signalingManager.connect(),await new Promise(((e,i)=>{s||this._playTaskMap.set(t,{resolve:e,reject:i}),this._sendStartPullStreamSignal(n).catch((e=>i(e)))}))}catch(a){throw this._remoteStreams.delete(t),a}}async stopPlayWTN(e){var t,i;this._logger.print("stopPlayWTN",e);const o=this._remoteStreams.get(e);if(o)return o.setState(uU.STOP,hU.STOP_PLAY),o.setAudioState(_U.STOPED,mU.MUTE),o.setVideoState(pU.STOPED,vU.MUTE),null===(t=o.observer)||void 0===t||t.setLogin(!1),null==o||null===(i=o.audioTrack)||void 0===i||i.stop(),this._remoteStreams.delete(e),await this._ctx.signalingManager.connect(),this._unsubscribePublicStream(o)}async muteWTNRemoteAudio(e,t){this._logger.print("muteWTNRemoteAudio",e,t),this._assertNotConnect();const i=this._remoteStreams.get(e);if(!i)throw new Cg(Eg.INVALID_PARAMS,"streamId not found");var o;i.muteToSubMediaType(t,null)&&(null===(o=i.observer)||void 0===o||o.setUnmuteAudio(!t),await this._updatePullStream(e,i),i.setAudioState(t?_U.STOPED:_U.DECODING,t?mU.MUTE:mU.UNMUTE))}async muteWTNRemoteVideo(e,t){this._logger.print("muteWTNRemoteVideo",e,t),this._assertNotConnect();const i=this._remoteStreams.get(e);if(!i)throw new Cg(Eg.INVALID_PARAMS,"streamId not found");var o;i.muteToSubMediaType(null,t)&&(null===(o=i.observer)||void 0===o||o.setUnmuteVideo(!t),await this._updatePullStream(e,i),i.setVideoState(t?pU.STOPED:pU.DECODING,t?vU.MUTE:vU.UNMUTE))}setWTNRemoteVideoPlayer(e,t){var i;if(this._logger.print("setWTNRemoteVideoPlayer()","streamId: %o, videoPlayerOption: %o",e,t),null===(i=this._publicVideoPlayerConfig.get(e))||void 0===i||null===(i=i.player)||void 0===i||i.destroy(),!t.renderDom)return void this._publicVideoPlayerConfig.delete(e);const o=new rN(this._ctx.id,QP,Fu(Fu({},t),{},{isLocal:!1,userId:e})),r=Fu(Fu({},t),{},{player:o});return this._publicVideoPlayerConfig.set(e,r),this._updateVideoPlayerState(e),o.domElement}setWTNRemoteAudioPlaybackVolume(e,t){var i;Ng(e,"publicStreamId"),t=Fg(t,"volume",0,400),this._ctx.publicAudioVolume.set(e,t),null===(i=this._remoteStreams.get(e))||void 0===i||null===(i=i.audioTrack)||void 0===i||i.setVolume(t)}__getRemoteStreams(){return this._remoteStreams}__getPublicStreamTrack(e,t){const i=this._remoteStreams.get(e);if(i)return"video"===t?i.videoTrack:i.audioTrack}async _updatePushTrack(){0!==this._localStreams.size&&(this._logger.info("_updatePushTrack()"),await this._ctx.signalingManager.connect(),this._localStreams.forEach((async e=>{e.videoTrack=this._ctx.localVideoTrack,e.audioTrack=this._ctx.localAudioTrack,await this._updatePushStream(e)})))}destroy(){var e;this._remoteStreams.forEach((e=>{e.destroy()})),this._remoteStreams=new Map,this.removeAllListeners(),this._ontrackCallbackMap.clear(),this._publicVideoPlayerConfig.forEach((e=>{e.player.destroy()})),this._publicVideoPlayerConfig.clear(),null===(e=this._clearSignalListeners)||void 0===e||e.call(this)}async _sendStartPushStreamSignal(e){var t,i,o,r;this._logger.print("_sendStartPushStreamSignal()","streamId: %s",e.streamId);const{streamId:s,Authorization:n,pubAudio:a,pubVideo:d}=e,{handler:c}=this._ctx;await(null==c?void 0:c.getDefaultSdp());const l=await c.publish(e),u=await KI(),{appId:h,businessId:_,useCloudProxy:m}=this._ctx,p={appId:h,streamId:s,Authorization:n,sdpInfo:{msid:e.stream.id,type:l.type,sdp:l.partialSdp,semantics:l.semantics},timestamp:Date.now(),params:{appId:h,businessId:_,userAgent:window.navigator.userAgent,sdkVersion:jg.VERSION,deviceId:bg.getDeviceId(),enableCloudProxy:m,channelProfile:"0",SDKCodecNegotiation:!0,supportedCodecs:u,sdkType:"rtc",joinRoomMode:1,deviceType:"web",platformType:2,rtsMode:this._ctx.rtsMode,mediaProcessingType:null!==(t=jg.MEDIA_PROCESSING_TYPE)&&void 0!==t?t:0},options:{supportCheckTokenPrivilege:!0,supportTokenExpireCallBack:!0,enableSceneConfigV2:!0,enableUnBundleMode:!0,enableAudioMux:!0,enableBigRoomMode:!0,needNegotiateSDP:!0,supportMultiVendor:!0,enableStreamStatusCallback:!0},attributes:{localaudio:!!e.audioTrack,localvideo:!!e.videoTrack,videostream:d,audiostream:a,extvideo:(null===(i=e.videoTrack)||void 0===i?void 0:i.sourceType)===ZI.EXTERNAL,extaudio:(null===(o=e.audioTrack)||void 0===o?void 0:o.sourceType)===ZI.EXTERNAL,videoDescriptions:l.videoDescriptions.map((e=>kf(e,yU))),videoType:UI.NORMAL},video:d,audio:a,screen:e.isScreen,accessParams:JSON.stringify({requireICEUfragV2:!0})};let v;try{this.emit("__onSendingPushStreamMessageHook"),v=await this._ctx.signalingManager.sendSignaling("startPushStream",p)}catch(g){if(await(null==c?void 0:c.rollback({msid:e.stream.id,stream:e,audioMid:l.audioMid,videoMid:l.videoMid})),g.code>=500&&g.code<600){const t=e.getPushBackOff();if(t.retryDuration<6e4)return this._logger.info("pushRetry","start msid: %s, retryDuration: %s",e.id,t.retryDuration),await new Promise((e=>setTimeout(e,t.interval))),e.updatePushBackOff(),e.resetStream(),e.setState(cU.START,lU.IN_RETRY),this._sendStartPushStreamSignal(e);throw this._logger.info("pushRetry","end"),e.setState(cU.FAIL,lU.RETRY_FAIL),await this._stopLocalStream(e),e.resetPushBackOff(),new Cg(Eg.WTN_PUSH_FAILED,g.message||"server error")}if(401===g.code)throw e.setState(cU.FAIL,lU.NO_PUSH_PERMISSION),await this._stopLocalStream(e),new Cg(Eg.WTN_PUSH_FAILED,g.message||"token error");if(g.code===Eg.OPERATION_CANCEL&&this._ctx.signalingManager.isReconnecting())return;throw new Cg(Eg.WTN_PUSH_FAILED,g.message||"push error")}e.pubAttributes=p.attributes;const f=await e.getSelectedCodec();e.currentVideoCodec=f;const S=new Promise(((t,i)=>{var o,r;null==c||c.handleAck({action:oD.publish,streamId:s,audioMid:l.audioMid,videoMid:l.videoMid,audioTransceiverInit:null==l?void 0:l.audioTransceiverInit,videoTransceiverInit:null==l?void 0:l.videoTransceiverInit,signalingAck:{sdp:null===(o=v)||void 0===o||null===(o=o.relayMessage)||void 0===o?void 0:o.sdp,sequenceId:null===(r=v)||void 0===r||null===(r=r.relayMessage)||void 0===r?void 0:r.sequenceId},stream:e,videoCodec:f,onSuccess:()=>{this._logger.info("pushStream()","pushStream success"),e.setState(cU.SUCCESS,lU.PUSH_SUCCESS),t(0)},onFail:e=>{this._logger.info("pushStream()","pushStream fail"),i(e)}})}));!US&&await S,null===(r=this._pushTaskMap.get(s))||void 0===r||r.resolve(),this._pushTaskMap.delete(s)}async _stopLocalStream(e){var t;e.stopBlackFrame(),await(null===(t=this._ctx.handler)||void 0===t?void 0:t.handleAck({action:oD.unpublish,audioMid:e.audioMid,videoMid:e.videoMid,stream:e,streamId:e.streamId})),e.destroy(),this._localStreams.delete(e.streamId)}async _updatePushStream(e){var t,i,o,r;const{videoTrack:s,audioTrack:n,pubAudio:a,pubVideo:d}=e;let c=null===(t=e.audioTrack)||void 0===t?void 0:t.preprocessingTrack;const l=null===(i=e.videoTrack)||void 0===i?void 0:i.preprocessingTrack;var u,h;d&&l?(e.stopBlackFrame(),await(null===(u=e.videoTransceiver)||void 0===u?void 0:u.sender.replaceTrack(l))):await(null===(h=e.videoTransceiver)||void 0===h?void 0:h.sender.replaceTrack(null));if(a&&c){var _;const{mixType:t,mixedAudioTrack:i}=e.audioTrack;i&&t!==Oh.PLAYOUT&&c.enabled&&(c=i),await(null===(_=e.audioTransceiver)||void 0===_?void 0:_.sender.replaceTrack(c))}else{var m;await(null===(m=e.audioTransceiver)||void 0===m?void 0:m.sender.replaceTrack(null))}const p={localaudio:!!n,localvideo:!!s,videostream:d,audiostream:a,extvideo:(null==s?void 0:s.sourceType)===ZI.EXTERNAL,extaudio:(null==n?void 0:n.sourceType)===ZI.EXTERNAL,videoType:s?UI.NORMAL:e.pubAttributes.videoType},v={};for(const[S,g]of Object.entries(p))g!==Reflect.get(e.pubAttributes,S)&&Reflect.set(v,S,g);var f;Object.keys(v).length&&(e.pubAudio=null!==(o=p.audiostream)&&void 0!==o?o:e.pubAudio,e.pubVideo=null!==(r=p.videostream)&&void 0!==r?r:e.pubVideo,e.pubAttributes=Fu(Fu({},e.pubAttributes),p),e.pubAttributes.videostream||e.stopBlackFrame(),await this._ctx.signalingManager.sendSignaling("updatePushStream",{appId:this._ctx.appId,streamId:e.streamId,attributes:p}),US&&await(null===(f=this._ctx.handler)||void 0===f?void 0:f.setCurrentDescription()))}async _sendStartPullStreamSignal(e){var t,i,o,r,s;this._logger.print("startPullStream()","streamId:",e.streamId);const{streamId:n,Authorization:a}=e,{handler:d}=this._ctx,c=await(null==d?void 0:d.subscribe(e,{multiChatMode:!1}));if(!c)throw new Cg(Eg.ADD_TRANSCEIVER_FAILED,"add transceiver failed");const l=jy(),{audioMid:u,videoMid:h}=c,{appId:_,businessId:m,useCloudProxy:p}=this._ctx,v=await KI(),f={appId:_,streamId:n,Authorization:a,audio:!0,video:!0,screen:!1,timestamp:Date.now(),sdpInfo:{sdp:c.partialSdp,semantics:c.semantics,type:c.type},params:{appId:_,businessId:m,userAgent:window.navigator.userAgent,sdkVersion:jg.VERSION,deviceId:bg.getDeviceId(),enableCloudProxy:p,channelProfile:"0",SDKCodecNegotiation:!0,supportedCodecs:v,sdkType:"rtc",joinRoomMode:1,deviceType:"web",platformType:2,rtsMode:this._ctx.rtsMode,mediaProcessingType:null!==(t=jg.MEDIA_PROCESSING_TYPE)&&void 0!==t?t:0},options:{supportCheckTokenPrivilege:!0,supportTokenExpireCallBack:!0,enableSceneConfigV2:!0,enableUnBundleMode:!0,enableAudioMux:!0,enableBigRoomMode:!0,needNegotiateSDP:!0,supportMultiVendor:!0,enableStreamStatusCallback:!0},config:{enableMediaType:e.getEnableMediaType(),qualityLayer:{spatialLayer:0,temporalLayer:0}},accessParams:JSON.stringify({requireICEUfragV2:!0})};let S;try{this.emit("__onSendingPullStreamMessageHook"),S=await this._ctx.signalingManager.sendSignaling("startPullStream",f)}catch(I){if(await(null==d?void 0:d.rollback({msid:n,stream:e}).catch((()=>{}))),401===I.code)throw e.setState(uU.FAIL,hU.NO_PLAY_PERMISSION),new Cg(Eg.WTN_PLAY_FAILED,I.message||"token error");if(433===I.code)throw e.setState(uU.FAIL,hU.OVER_CLIENT_SUBSCRIBE_STREAM_LIMIT),new Cg(Eg.WTN_PLAY_FAILED,I.message||"over client subscribe stream limit");if(434===I.code)throw e.setState(uU.FAIL,hU.OVER_STREAM_SUBSCRIBE_USER_LIMIT),new Cg(Eg.WTN_PLAY_FAILED,I.message||"over stream subscribe user limit");if(I.code===Eg.OPERATION_CANCEL&&this._ctx.signalingManager.isReconnecting())return;throw e.setState(uU.FAIL,hU.INTERNAL),new Cg(Eg.WTN_PLAY_FAILED,I.message||"play wtn error")}const g=[];g.push(new Promise(((t,i)=>{const o=setTimeout((()=>i(new Cg(Eg.WTN_PLAY_FAILED,"wait video timeout for streamId: ".concat(n)))),cw),r=i=>{"video"===i.mediaType&&(this._logger.success("remoteStream ".concat(e.userId," received video track")),e.off("ontrack",r),clearTimeout(o),t(0))};e.on("ontrack",r)}))),g.push(new Promise(((t,i)=>{const o=setTimeout((()=>i(new Cg(Eg.WTN_PLAY_FAILED,"wait audio timeout for streamId: ".concat(n)))),cw),r=i=>{"audio"===i.mediaType&&(this._logger.success("remoteStream ".concat(e.userId," received audio track")),e.off("ontrack",r),clearTimeout(o),t(0))};e.on("ontrack",r)})));const y=t=>{e.ontrack(t)};null===(i=this._ctx.handler)||void 0===i||i.on("ontrack",y),this._ontrackCallbackMap.set(e,y);const{sequenceId:b,sdp:T}=S.relayMessage;e.videoMid=h,e.audioMid=u,e.sequenceId=b,e.streamState=AN.SUB_ED,await(null===(o=this._ctx.handler)||void 0===o?void 0:o.handleAck({action:oD.subscribe,streamId:n,audioMid:u,videoMid:h,audioTransceiverInit:c.audioTransceiverInit,videoTransceiverInit:c.videoTransceiverInit,signalingAck:{sdp:T,sequenceId:b},stream:e})),await Promise.all(g),null===(r=this._monitor)||void 0===r||r.report("rtc_subscribe_stat",{result:"success",start:l,message:"unknown",stream_user_id:e.userId}),e.startReport((t=>{var i;t.publicStreamId=t.userId,delete t.userId,delete t.isScreen;const o=nb(t);o.audioStats&&this.safeEmit(dU.onWTNRemoteAudioStats,{streamId:e.streamId,audioStats:o.audioStats}),o.videoStats&&this.safeEmit(dU.onWTNRemoteVideoStats,{streamId:e.streamId,videoStats:o.videoStats}),null===(i=this.__onRemoteStreamStats)||void 0===i||i.call(this,o)}),this._ctx.handler),this._updateVideoPlayerState(n),this._initAudioPlayer(n),e.subVideo=e.getEnableMediaType().video,e.subAudio=e.getEnableMediaType().audio,null===(s=this._playTaskMap.get(n))||void 0===s||s.resolve(),this._playTaskMap.delete(n)}async _unsubscribePublicStream(e){var t;lw("_unsubscribePublicStream()",e,this._logger);const i={appId:this._ctx.appId,streamId:e.streamId};try{await this._ctx.signalingManager.sendSignaling("stopPullStream",i)}catch(o){}e.streamState=AN.INIT,await(null===(t=this._ctx.handler)||void 0===t?void 0:t.handleAck({action:oD.unsubscribe,streamId:e.streamId,audioMid:e.audioMid,videoMid:e.videoMid,stream:e})),e.subMediaType=Hg.NONE,this._removeOnTrackListener(e),e.statsReport.unsubscribe(),e.destroy()}async _updatePullStream(e,t){const i=t.getEnableMediaType();await this._ctx.signalingManager.sendSignaling("updatePullStream",{appId:this._ctx.appId,streamId:e,config:{enableMediaType:i}}),t.subVideo=i.video,t.subAudio=i.audio}_removeOnTrackListener(e){const t=this._ontrackCallbackMap.get(e);if(t){const i=e.vendorHandler||this._ctx.handler;null==i||i.off("ontrack",t),this._ontrackCallbackMap.delete(e)}}_addSignalListeners(){const e={[LI.ON_CONNECTION_STATE_CHANGE]:e=>{e.state===ih.CONNECTION_STATE_RECONNECTED?(Array.from(this._remoteStreams.values()).forEach((e=>{const{streamId:t,token:i}=e,{audio:o,video:r}=e.getEnableMediaType();e.destroy(),this._remoteStreams.delete(t),this.startPlayWTN(i,t,!r,!o,!0).then((()=>{var t;null===(t=this.__onResubscribe)||void 0===t||t.call(this,{stream:e})}))})),Array.from(this._localStreams.values()).forEach((e=>{const{token:t,pubAudio:i,pubVideo:o}=e;e.destroy(),this._localStreams.delete(e.streamId),this.startPushWTN(t,e.streamId,!o,!i,!0)}))):e.state===ih.CONNECTION_STATE_DISCONNECTED&&(this._remoteStreams.forEach((e=>{e.setState(uU.FAIL,hU.IN_RETRY),e.setAudioState(_U.FROZEN,mU.NETWORK_CONGESTION),e.setVideoState(pU.FROZEN,vU.NETWORK_CONGESTION)})),this._localStreams.forEach((e=>{e.setState(cU.FAIL,lU.IN_RETRY)})))},[OI.ON_STREAM_PUSHED_BY_OTHER]:e=>{const t=this._localStreams.get(e.streamId);this._logger.print("_addSignalListeners","onStreamPushedByOther",e.streamId),t&&(t.setState(cU.FAIL,lU.STREAM_PUSH_BY_OTHER),this._stopLocalStream(t))},[OI.ON_STREAM_PULL_STATE_CHANGED]:async e=>{const t=this._remoteStreams.get(e.streamId);if(this._logger.print("_addSignalListeners","onStreamPullStateChanged",e),t)switch(e.code){case 0:t.setState(uU.SUCCESS,hU.PLAY_SUCCESS);break;case 1:case 2:case 3:const o={1:hU.STREAM_NOT_EXIST,2:hU.REMOTE_STOP,3:hU.REMOTE_FAILURE}[e.code];t.setAudioState(_U.STOPED,mU.REMOTE_STOP),t.setVideoState(pU.STOPED,vU.REMOTE_STOP),t.setState(uU.FAIL,o);break;case 4:const r=t.getPushBackOff();var i;if(r.retryDuration<6e4)this._logger.info("subRetry",t.streamId,r.retryDuration),t.setState(uU.START,hU.IN_RETRY),await new Promise((e=>setTimeout(e,r.interval))),t.updatePushBackOff(),await(null===(i=this._ctx)||void 0===i||null===(i=i.handler)||void 0===i?void 0:i.handleAck({action:oD.unsubscribe,streamId:t.streamId,audioMid:t.audioMid,videoMid:t.videoMid,stream:t})),t.clean(),await this._sendStartPullStreamSignal(t);else t.setState(uU.FAIL,hU.RETRY_FAIL),this._logger.info("subRetry","end",t.streamId),t.resetPushBackOff()}}};Object.keys(e).forEach((t=>{this._ctx.signalingManager.on(t,e[t])})),this._clearSignalListeners=()=>{Object.keys(e).forEach((t=>{this._ctx.signalingManager.off(t,e[t])}))}}_addLocalStreamEventHandler(e){e.on(dU.onWTNPushStateChanged,(e=>{this.safeEmit(dU.onWTNPushStateChanged,e)}))}_addRemoteStreamEventHandler(e){e.on(dU.onWTNPlayStateChanged,(e=>{this.safeEmit(dU.onWTNPlayStateChanged,e)})),e.on(dU.onWTNRemoteAudioStateChanged,(e=>{this.safeEmit(dU.onWTNRemoteAudioStateChanged,e)})),e.on(dU.onWTNRemoteVideoStateChanged,(e=>{this.safeEmit(dU.onWTNRemoteVideoStateChanged,e)})),e.on("onSEIMessage",(t=>{if(t instanceof Uint8Array){const o=function(e){const t=new DataView(e.buffer);if(t.byteLength<=4||65535!==t.getUint16(0))return{seiCount:1,seis:[e]};const i={seiCount:0,seis:[]};let o=!1,r=2;for(;r<t.byteLength;){const s=t.getUint16(r);if(r+=2,t.byteLength-r<s){o=!0;break}const n=new Uint8Array(e.buffer,r,s);if(r+=s,t.byteLength-r>0&&t.byteLength-r<=2){o=!0;break}i.seiCount++,i.seis.push(n)}return o&&(i.seiCount=1,i.seis=[e]),i}(t);for(let t=0;t<o.seiCount;t++){var i;null===(i=this.__onSEIMessageReceived)||void 0===i||i.call(this,{sei:o.seis[t],publicStreamId:e.streamId}),this.safeEmit(dU.onWTNSEIMessageReceived,{streamId:e.streamId,sei:o.seis[t]})}}}))}_updateVideoPlayerState(e){const t=this._remoteStreams.get(e);if(t){const r=this._publicVideoPlayerConfig.get(e);var i,o;if(r)null===(i=t.videoTrack)||void 0===i||i.setPlayer(this._ctx.id,r,null===(o=this._ctx)||void 0===o?void 0:o.autoPlayPolicy,this._initPlayerEvents.bind(this))}}_initAudioPlayer(e){const t=this._remoteStreams.get(e);if(null!=t&&t.audioTrack){var i,o;const r=new sN(this._ctx.id,e,{muted:(null===(i=this._ctx)||void 0===i?void 0:i.autoPlayPolicy)===Sh.VIDEO_ONLY||(null===(o=this._ctx)||void 0===o?void 0:o.autoPlayPolicy)===Sh.PLAY_MANUALLY,isScreen:!1});t.audioTrack.setPlayer(r),t.audioTrack.bindPlayerEvent(this._initPlayerEvents.bind(this)),t.audioTrack.play()}}_initPlayerEvents(e){var t;let i=arguments.length>1&&void 0!==arguments[1]&&arguments[1],o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:$u.STREAM_INDEX_MAIN;null===(t=this.__onPlayerEvents)||void 0===t||t.call(this,e,i,o),e.on("playback_event",(t=>{const i=this._remoteStreams.get(e.userId);if("loadeddata"===t.eventName){const e=()=>{i&&"video"===t.type&&this.safeEmit(dU.onWTNFirstRemoteVideoFrameDecoded,{streamId:i.streamId})};null==i||!i.observer||i.observer.audioFirstFrameReceived?e():i.observer.once("recvVideoFirstFrame",e)}}))}async _maybeFillBackFrame2Stream(e){var t;if(e.refreshBlackFrameLifetime(),null===(t=e.videoTransceiver)||void 0===t||!t.sender.track){var i;const t=e.genBlackFrame();if(!t)return;null===(i=e.videoTransceiver)||void 0===i||null===(i=i.sender)||void 0===i||i.replaceTrack(t),e.pubAttributes.videoType=UI.BLACK,this._ctx.signalingManager.sendSignaling("updatePushStream",{streamId:e.streamId,appId:this._ctx.appId,attributes:{videoType:UI.BLACK}}),e.on("black-frame-ended",(()=>{var t;null===(t=e.videoTransceiver)||void 0===t||null===(t=t.sender)||void 0===t||t.replaceTrack(null),e.pubAttributes.videoType=UI.NORMAL,this._ctx.signalingManager.sendSignaling("updatePushStream",{streamId:e.streamId,appId:this._ctx.appId,attributes:{videoType:UI.NORMAL}})}))}}safeEmit(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),o=1;o<t;o++)i[o-1]=arguments[o];return vS(this._ctx.id,e,i),super.safeEmit(e,...i)}_assertNotConnect(){if(!this._ctx.signalingManager.isConnected())throw new Cg(Eg.NOT_CONNECTED_YET,"server not connected")}}IU([mS()],EU.prototype,"startPushWTN",1),IU([mS()],EU.prototype,"stopPushWTN",1),IU([mS()],EU.prototype,"muteWTNLocalAudio",1),IU([mS()],EU.prototype,"muteWTNLocalVideo",1),IU([mS()],EU.prototype,"sendWTNSEIMessage",1),IU([mS()],EU.prototype,"startPlayWTN",1),IU([mS()],EU.prototype,"stopPlayWTN",1),IU([mS()],EU.prototype,"muteWTNRemoteAudio",1),IU([mS()],EU.prototype,"muteWTNRemoteVideo",1),IU([mS()],EU.prototype,"setWTNRemoteVideoPlayer",1),IU([mS()],EU.prototype,"setWTNRemoteAudioPlaybackVolume",1),IU([MD],EU.prototype,"_sendStartPushStreamSignal",1),IU([MD],EU.prototype,"_stopLocalStream",1),IU([MD],EU.prototype,"_sendStartPullStreamSignal",1),IU([MD],EU.prototype,"_unsubscribePublicStream",1);const RU=new LS("AudioDeviceManager",1);class CU extends EI.EventEmitter{constructor(e){super(),Xu(this,"_audioLevelFetcher",void 0),Xu(this,"_playbackDeviceTestTimer",void 0),Xu(this,"_audioElement",void 0),Xu(this,"_audioTrack",void 0),Xu(this,"_mediaRecorder",void 0),Xu(this,"_recoderTimer",void 0),Xu(this,"_isAudioPlaybackDeviceTesting",!1),Xu(this,"_isAudioDeviceRecordTesting",!1),Xu(this,"_audioCaptureAndRecoderResolve",void 0),Xu(this,"_onAutoplayFailed",void 0),Xu(this,"_audioPlaybackDeviceId",void 0),this._ctx=e}get audioTrack(){return this._audioTrack}async startAudioPlaybackDeviceTest(e,t){if(this._isAudioPlaybackDeviceTesting||this._isAudioDeviceRecordTesting)throw new Cg(Eg.REPEAT_DEVICE_TEST,"device test cannot be called repeatedly at the same time.");this._isAudioPlaybackDeviceTesting=!0,RU.info("startAudioPlaybackDeviceTest()","Invoke");try{await this._playAudioFile(e,{loop:!0})}catch(wZ){throw RU.error("startAudioPlaybackDeviceTest()","error",wZ),this.stopAudioPlaybackDeviceTest(),wZ}this._startEmitAudioPlaybackDeviceTestVolume(t)}stopAudioPlaybackDeviceTest(){this._isAudioPlaybackDeviceTesting&&(RU.info("stopAudioPlaybackDeviceTest()","Invoke"),this._isAudioPlaybackDeviceTesting=!1,this._stopEmitAudioPlaybackDeviceTestVolume(),this._destroyAudioElement())}async startAudioDeviceRecordTest(e,t,i){let o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:3e4;if(!window.MediaRecorder)throw new Cg(Eg.NOT_SUPPORTED,"Your browser does not support MediaRecorder.");if(this._isAudioDeviceRecordTesting||this._isAudioPlaybackDeviceTesting)throw new Cg(Eg.REPEAT_DEVICE_TEST,"device test cannot be called repeatedly at the same time.");this._isAudioDeviceRecordTesting=!0,RU.info("startAudioDeviceRecordTest()","Invoke"),this._recoderTimer=setTimeout((()=>{RU.info("startAudioDeviceRecordTest()","".concat(o,'ms automatic call method "stopAudioDeviceRecordAndPlayTest"')),this._stopAudioCaptureAndRecoder()}),o);try{this._onAutoplayFailed=t,await this._startAudioCaptureAndRecoder(e,null!=i?i:100)}catch(r){throw this._isAudioDeviceRecordTesting=!1,delete this._onAutoplayFailed,r}delete this._audioCaptureAndRecoderResolve}stopAudioDeviceRecordAndPlayTest(){RU.info("stopAudioDeviceRecordAndPlayTest()","Invoke"),void 0!==this._recoderTimer&&(clearTimeout(this._recoderTimer),delete this._recoderTimer),this._stopAudioCaptureAndRecoder()}stopAudioDevicePlayTest(){this._isAudioDeviceRecordTesting&&(RU.info("stopAudioDevicePlayTest()","Invoke"),this._isAudioDeviceRecordTesting=!1,this._mediaRecorder&&(this._mediaRecorder.ondataavailable=null),this.stopAudioDeviceRecordAndPlayTest(),this._stopEmitAudioPlaybackDeviceTestVolume(),this._destroyAudioElement()),delete this._onAutoplayFailed}getRecordTrack(){return this._audioTrack}async setSinkId(e){if(RU.info("setSinkId()","Invoke"),void 0===HTMLAudioElement.prototype.setSinkId)throw new Cg(Eg.NOT_SUPPORTED,"setSinkId not supported by current browser");const t=await BP.getAudioPlaybackDeviceById(e);if(!t)throw new Cg(Eg.INVALID_DEVICE_ID,"audio playback device id ".concat(e," is invalid"));return this._audioPlaybackDeviceId=e,this._setAudioCtxSinkId(),t}getSinkId(){return this._audioPlaybackDeviceId}destroy(){RU.info("destroy()","Invoke"),super.removeAllListeners(),this.stopAudioPlaybackDeviceTest(),this.stopAudioDevicePlayTest()}async _playAudioFile(e,t){return RU.info("_playAudioFile()","Invoke url=".concat(e,"; loop=").concat(t.loop)),new Promise(((i,o)=>{const r=KP("audio",{attributes:{src:e,crossOrigin:"anonymous"}});this._audioElement=r,r.loop=t.loop,this._audioLevelFetcher=new FP(r),r.onplaying=()=>{r.onplaying=null,RU.info("_playAudioFile()","onplaying"),i()},r.onerror=async e=>{var t;RU.error("_playAudioFile()","onerror",e);const i=e.message||(null==r||null===(t=r.error)||void 0===t?void 0:t.message);o(new Cg(Eg.LOAD_RESOURCES_FAILED,"Failed to play recorded audio".concat(i?", reason: ".concat(i):".")))},this._setAudioCtxSinkId().then((()=>{var e,t;return null===(e=r.play())||void 0===e||null===(t=e.catch)||void 0===t?void 0:t.call(e,(e=>{RU.warn("_playAudioFile()","autoplay error",e);const t="Failed to play recorded audio, ".concat(e.name,": ").concat(e.message);"NotAllowedError"===e.name&&this._onAutoplayFailed?this._onAutoplayFailed((()=>{var e;return Promise.all([null===(e=this._audioLevelFetcher)||void 0===e?void 0:e.resume(),r.play()])})):o(new Cg(Eg.LOAD_RESOURCES_FAILED,t))}))}))}))}_destroyAudioElement(){this._audioElement&&(RU.info("_destroyAudioElement()","Invoke"),this._audioElement.onplaying=null,this._audioElement.onerror=null,this._audioElement.src="",delete this._audioElement,"function"==typeof this._audioCaptureAndRecoderResolve&&this._audioCaptureAndRecoderResolve())}_startEmitAudioPlaybackDeviceTestVolume(e){e=Math.max(e,100),this._audioElement&&(RU.info("_startEmitAudioPlaybackDeviceTestVolume()","start timer(".concat(e,"ms)")),this._playbackDeviceTestTimer=self.setInterval((()=>{this._audioLevelFetcher&&this.emit("onAudioPlaybackDeviceTestVolume",this._audioLevelFetcher.getAudioLevel())}),e))}_stopEmitAudioPlaybackDeviceTestVolume(){var e;void 0!==this._playbackDeviceTestTimer&&(RU.info("_stopEmitAudioPlaybackDeviceTestVolume()","stop timer"),self.clearInterval(this._playbackDeviceTestTimer),delete this._playbackDeviceTestTimer),null===(e=this._audioLevelFetcher)||void 0===e||e.destroy(),delete this._audioLevelFetcher}async _startAudioCaptureAndRecoder(e,t){this._audioTrack=await fN(this._ctx,this._ctx.audioProfileManager.getConstraints()),this._audioTrack.setVolume(t+.01);const i=new MediaStream([this._audioTrack.preprocessingTrack]);return RU.info("startAudioDeviceRecordTest()","create microphone track success!"),new Promise(((t,o)=>{let r;"function"==typeof MediaRecorder.isTypeSupported&&(r=["audio/webm","audio/mp4"].find((e=>MediaRecorder.isTypeSupported(e))),RU.info("startAudioDeviceRecordTest()","use mimeType: ".concat(r))),this._mediaRecorder=new MediaRecorder(i,r?{mimeType:r}:void 0);const s=this._mediaRecorder.mimeType;this._mediaRecorder.ondataavailable=async i=>{if(this._isAudioDeviceRecordTesting){var r;RU.info("startAudioDeviceRecordTest()","get recorded file(mimeType: ".concat(s,")."));const a=new Blob([i.data],{type:s});try{await this._playAudioFile(gP.createObjectURL(a),{loop:!1})}catch(n){return o(n)}this._startEmitAudioPlaybackDeviceTestVolume(e),null===(r=this._audioElement)||void 0===r||r.addEventListener("ended",(()=>{this.stopAudioDevicePlayTest(),t()})),this._audioCaptureAndRecoderResolve=t}else t()},this._mediaRecorder.onerror=e=>{o(new Cg(Eg.AUDIO_DEVICE_TEST_FAILED,e.message||"mediaRecorder error"))},this._audioCaptureAndRecoderResolve=t,this._mediaRecorder.start()}))}_stopAudioCaptureAndRecoder(){var e;this._mediaRecorder&&("recording"===this._mediaRecorder.state&&this._mediaRecorder.stop(),delete this._mediaRecorder),null===(e=this._audioTrack)||void 0===e||e.destroy(),delete this._audioTrack}async _setAudioCtxSinkId(){let e=this._audioPlaybackDeviceId;if(e){"default"===e&&(e="");try{var t,i;null===(t=YP.getAudioContextInstance())||void 0===t||null===(i=t.setSinkId)||void 0===i||i.call(t,e),RU.info("setSinkId","ctx.sinkId=".concat(e))}catch(o){RU.error("setSinkId","failed, ".concat(o.name," - ").concat(o.message))}}}}const kU=()=>({url:"",video:{codec:yh.H264,width:640,height:360,fps:15,gop:2,kBitRate:AU(640,360,15)},audio:{codec:"AAC",kBitRate:64,sampleRate:48e3,channels:2,AACProfile:gh.LC},layout:{regions:[],appData:"",backgroundColor:"#000000"}});function AU(e,t,i){return e*t<=288e3?i<=15?800:1200:e*t<=864e3?i<=15?1200:1800:e*t<=1152e3?i<=15?1600:2400:e*t<=2592e3?i<=15?2500:3750:i<=15?3300:5e3}function PU(e){if("string"!=typeof e||!/^rtmps?:\/\//.test(e))throw new Cg(Eg.INVALID_PARAMS,"Invalid rtmp address")}function NU(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];if(null==e||!e.length)throw new Cg(Eg.INVALID_PARAMS,"regions should not be empty.");for(const t of e){if("string"!=typeof t.userId)throw new Cg(Eg.INVALID_PARAMS,"region.userId(".concat(t.userId,") should be a string."));if(Ug(t.userId),"boolean"!=typeof t.isScreenStream)throw new Cg(Eg.INVALID_PARAMS,"region.isScreenStream(".concat(t.isScreenStream,") should be a boolean."))}}function wU(e,t){var i,o;const r=(e,i)=>{const o=e.reduce(((e,t)=>null==e?void 0:e[t]),t),r=e.reduce(((e,t)=>null==e?void 0:e[t]),kU());return o&&i(o)?o:r},s=e=>e%2==0?e:e+1,n=s(r(["video","width"],(e=>e>=2&&e<=1920))),a=s(r(["video","height"],(e=>e>=2&&e<=1920))),d=r(["video","fps"],(e=>e>=1&&e<=60)),c=(null===(i=t.video)||void 0===i?void 0:i.kBitRate)||0,l=r(["audio","sampleRate"],(e=>!![32e3,44100,48e3].find((t=>t===e||t/1e3===e))));return{type:"transcode",action:e,transcodeMeta:{transcode:{url:t.url},control:{protocol:"2.0"},audio:{codec:r(["audio","codec"],(e=>"AAC"===e)),bitRate:1e3*r(["audio","kBitRate"],(e=>e>=32&&e<=192)),sampleRate:l<100?1e3*l:l,channels:r(["audio","channels"],(e=>[1,2].includes(e))),profile:r(["audio","AACProfile"],(e=>[gh.LC,gh.HEv1,gh.HEv2].includes(e)))},video:{codec:r(["video","codec"],(e=>["H264","H265"].includes(e))),fps:d,gop:r(["video","gop"],(e=>e>=1&&e<=5))*d,bitRate:1e3*(c>=16&&c<=1e4?c:AU(n,a,d)),width:n,height:a},layout:{canvas:{bgnd:r(["layout","backgroundColor"],(e=>/^#([0-9a-fA-F]{6}|[0-9a-fA-F]{3})$/.test(e)))},regions:(null===(o=t.layout)||void 0===o||null===(o=o.regions)||void 0===o?void 0:o.map((e=>({alpha:!e.alpha||Number(e.alpha)>1||Number(e.alpha)<=0?1:Number(e.alpha),uid:e.userId,zorder:!e.zorder||Number(e.zorder)<0||Number(e.zorder)>100?0:Number(e.zorder),x:!e.x||Number(e.x)>=1||Number(e.x)<0?0:Number(e.x),y:!e.y||Number(e.y)>=1||Number(e.y)<0?0:Number(e.y),w:!e.w||Number(e.w)>1||Number(e.w)<=0?1:Number(e.w),h:!e.h||Number(e.h)>1||Number(e.h)<=0?1:Number(e.h),renderMode:e.renderMode&&[1,2,3].includes(e.renderMode)?e.renderMode:1,contentControl:e.contentControl&&[0,1,2].includes(e.contentControl)?e.contentControl:0,screen:!!e.isScreenStream}))))||[],app_data:r(["layout","appData"],(e=>"string"==typeof e))}}}}const OU={getDefaultValue:kU,checkStartParams:function(e){var t;PU(e.url),NU(null===(t=e.layout)||void 0===t?void 0:t.regions)},checkUpdateParams:function(e){var t;e.url&&PU(e.url),NU(null===(t=e.layout)||void 0===t?void 0:t.regions)},getStartParams:function(e){return wU("started",e)},getUpdateParams:function(e){return wU("layoutChanged",e)}};let MU;var LU=JO,xU=Zd;wi({target:"Object",stat:!0},{fromEntries:function(e){var t={};return LU(e,(function(e,i){xU(t,e,i)}),{AS_ENTRIES:!0}),t}});var VU=i($.Object.fromEntries);const DU=["ele","fakeEle"],UU=["orgTrack","mediaTrack","preprocessingTrack"],ZU=["orgTrack","mediaTrack","preprocessingTrack"],WU=["currentTime","duration","ended","error","muted","networkState","paused","readyState","seekable","sinkId","src","volume"],XU=["currentTime","sampleRate","state","baseLatency","outputLatency","sinkId"],GU=["contentHint","enabled","id","kind","label","muted","readyState"],FU=["currentDirection","direction","mid","stopped"];let HU;function YU(e){const t={};if(e instanceof MediaStream){t.id=e.id,t.active=e.active;const i=e.getTracks();t.tracks=i.map((e=>VU(GU.map((t=>[t,e[t]])))))}return t}function KU(e){const t=[];let i=[];e&&e._room&&e._room._remoteStreams&&(i=e._room._remoteStreams.values());for(const o of i)o.forEach((e=>{e.audioTrack&&t.push(e.audioTrack)}));e._localAudioTrack&&t.push(e._localAudioTrack),e._localScreenAudioTrack&&t.push(e._localScreenAudioTrack);for(const o of t){if(o._audioLevelFetcher&&o._audioLevelFetcher._ctx)return o._audioLevelFetcher._ctx;if(o._ac)return o._ac;if(o._audioFetchMap&&Array.from(o._audioFetchMap.values()).length)return Array.from(o._audioFetchMap.values())[0]._ctx;if(o._ap&&o._ap._ac)return o._ap._ac}return null}function BU(e){const t=[];e._localAudioTrack&&t.push({userId:"__local__",mediaType:"audio",isScreen:!1,isPublic:!1,isVirtual:!1,orgTrack:e._localAudioTrack._originTrack,mediaTrack:e._localAudioTrack._mediaTrack,preprocessingTrack:e._localAudioTrack._preProcessingTrack}),e._localScreenAudioTrack&&t.push({userId:"__local__",mediaType:"audio",isScreen:!0,isPublic:!1,isVirtual:!1,orgTrack:e._localScreenAudioTrack._originTrack,mediaTrack:e._localScreenAudioTrack._mediaTrack,preprocessingTrack:e._localScreenAudioTrack._preProcessingTrack}),e._localVideoTrack&&t.push({userId:"__local__",mediaType:"video",isScreen:!1,isPublic:!1,isVirtual:!1,orgTrack:e._localVideoTrack._originTrack,mediaTrack:e._localVideoTrack._mediaTrack,preprocessingTrack:e._localVideoTrack._preProcessingTrack}),e._localScreenVideoTrack&&t.push({userId:"__local__",mediaType:"video",isScreen:!0,isPublic:!1,isVirtual:!1,orgTrack:e._localScreenVideoTrack._originTrack,mediaTrack:e._localScreenVideoTrack._mediaTrack,preprocessingTrack:e._localScreenVideoTrack._preProcessingTrack}),e._room&&e._room._remoteStreams&&e._room._remoteStreams.forEach(((e,i)=>{e.forEach((e=>{e.audioTrack&&t.push({userId:i,mediaType:"audio",isScreen:e.isScreen,isPublic:!1,isVirtual:!1,orgTrack:e.audioTrack._originTrack,mediaTrack:e.audioTrack._mediaTrack}),e.videoTrack&&t.push({userId:i,mediaType:"video",isScreen:e.isScreen,isPublic:!1,isVirtual:!1,orgTrack:e.videoTrack._originTrack,mediaTrack:e.videoTrack._mediaTrack})}))}));let i=e._publicStreamManager;return i||(i=e._outsideRoom),i&&i.remoteStreams&&i.remoteStreams.forEach(((e,i)=>{e.audioTrack&&t.push({userId:i,mediaType:"audio",isScreen:e.isScreen,isPublic:!0,isVirtual:!1,orgTrack:e.audioTrack._originTrack,mediaTrack:e.audioTrack._mediaTrack}),e.videoTrack&&t.push({userId:i,mediaType:"video",isScreen:e.isScreen,isPublic:!0,isVirtual:!1,orgTrack:e.videoTrack._originTrack,mediaTrack:e.videoTrack._mediaTrack})})),e&&e._room&&e._room._virtualStreams&&e._room._virtualStreams.forEach(((e,i)=>{e.audioTrack&&t.push({userId:"virtualStream-".concat(i),mediaType:"audio",isScreen:!1,isPublic:!1,isVirtual:!0,orgTrack:e.audioTrack._originTrack,mediaTrack:e.audioTrack._mediaTrack}),e.videoTrack&&t.push({userId:"virtualStream-".concat(i),mediaType:"video",isScreen:!1,isPublic:!1,isVirtual:!0,orgTrack:e.videoTrack._originTrack,mediaTrack:e.videoTrack._mediaTrack})})),t}async function JU(e,t){if(!e)return;const i=new MediaStream;i.addTrack(e);const o=t.createMediaStreamSource(i),r=t.createAnalyser();o.connect(r),"suspended"===t.state&&(console.warn(t.state),t.resume());const s=new Uint8Array(2048);r.getByteTimeDomainData(s),await new Promise((e=>{setTimeout(e,50)})),r.getByteTimeDomainData(s),await new Promise((e=>{setTimeout(e,50)}));let n=0;s.forEach((e=>n=Math.max(n,Math.abs(e-128))));const a=n/128*256,d=a>2?a:0;return o.disconnect(),r.disconnect(),d}function jU(e){if(!e)return;const t={track:e.track?e.track.id:void 0,transport:{state:e.transport?e.transport.state:void 0}};return e.transport&&e.transport.iceTransport&&(t.iceTransport={state:e.transport.iceTransport.state,role:e.transport.iceTransport.role,gatheringState:e.transport.iceTransport.gatheringState,component:e.transport.iceTransport.component}),t}async function zU(e){const t={stats:[],mediaElementStates:[],audioContextStates:[],volumes:[],trackStates:[],tranceiverStates:[]},i=[];return await new Promise((o=>{let r,s=0;const n=()=>{i.push(async function(e){const t=Date.now();let i=[];e._ctx.handler&&e._ctx.handler._peerConnection&&(i=await e._ctx.handler._peerConnection.getStats());const o=[];return i.forEach((e=>{o.push(e)})),{timestamp:t,stats:o}}(e).then((e=>{t.stats.push(e)})),async function(e){const t=Date.now(),i=[];var o;e._videoPlayer&&i.push({userId:"__local__",mediaType:"video",isScreen:!1,isPublic:!1,ele:e._videoPlayer._videoDom}),e._screenPlayer&&i.push({userId:"__local__",mediaType:"video",isScreen:!0,isPublic:!1,ele:e._screenPlayer._videoDom}),e._remoteVideoPlayer&&e._remoteVideoPlayer.forEach(((e,t)=>{i.push({userId:t,mediaType:"video",isScreen:!1,isPublic:!1,ele:e?e._videoDom:void 0})})),e._remoteScreenPlayer&&(null===(o=e._remoteScreenPlayer)||void 0===o||o.forEach(((e,t)=>{i.push({userId:t,mediaType:"video",isScreen:!0,isPublic:!1,ele:e?e._videoDom:void 0})}))),e._remoteAudioPlayer&&e._remoteAudioPlayer.forEach(((e,t)=>{i.push({userId:t,mediaType:"audio",isScreen:!1,isPublic:!1,ele:e?e._audioDom:void 0,fakeEle:e?e._fakeAudioDom:void 0})})),e._remoteScreenAudioPlayer&&e._remoteScreenAudioPlayer.forEach(((e,t)=>{i.push({userId:t,mediaType:"audio",isScreen:!0,isPublic:!1,ele:e?e._audioDom:void 0,fakeEle:e?e._fakeAudioDom:void 0})})),e._publicStreamVideoPlayer&&e._publicStreamVideoPlayer.forEach(((e,t)=>{i.push({userId:t,mediaType:"video",isScreen:!1,isPublic:!0,ele:e?e._videoDom:void 0})})),e._publicStreamAudioPlayer&&e._publicStreamAudioPlayer.forEach(((e,t)=>{i.push({userId:t,mediaType:"audio",isScreen:!1,isPublic:!0,ele:e?e._audioDom:void 0,fakeEle:e?e._fakeAudioDom:void 0})})),e._localVideoTrack&&e._localVideoTrack.videoPlayers&&e._localVideoTrack.videoPlayers.forEach(((e,t)=>{i.push({playerId:t.toString(),userId:"__local__",mediaType:"video",isScreen:!1,isPublic:!1,ele:e._videoDom})})),e._localScreenTrack&&e._localScreenTrack.videoPlayers&&e._localScreenTrack.videoPlayers.forEach(((e,t)=>{i.push({playerId:t.toString(),userId:"__local__",mediaType:"video",isScreen:!0,isPublic:!1,ele:e._videoDom})})),e._room&&e._room._remoteStreams&&e._room._remoteStreams.forEach(((e,t)=>{e.forEach((e=>{if(e.audioTrack){const o=e.audioTrack._audioPlayer;i.push({userId:t,mediaType:"audio",isScreen:e.isScreen,isPublic:!1,ele:o?o._audioDom:void 0,fakeEle:o?o._fakeAudioDom:void 0})}e.videoTrack&&e.videoTrack.videoPlayers&&e.videoTrack.videoPlayers.forEach(((o,r)=>{i.push({playerId:r.toString(),userId:t,mediaType:"video",isScreen:e.isScreen,isPublic:!1,ele:o?o._videoDom:void 0})}))}))}));let r=e._publicStreamManager;return r||(r=e._outsideRoom),r&&r.remoteStreams&&r.remoteStreams.forEach(((e,t)=>{if(e.audioTrack){const o=e.audioTrack._audioPlayer;i.push({userId:t,mediaType:"audio",isScreen:!1,isPublic:!0,ele:o?o._audioDom:void 0,fakeEle:o?o._fakeAudioDom:void 0})}e.videoTrack&&e.videoTrack.videoPlayers&&e.videoTrack.videoPlayers.forEach(((e,o)=>{i.push({playerId:o.toString(),userId:t,mediaType:"video",isScreen:!1,isPublic:!0,ele:e?e._videoDom:void 0})}))})),e&&e._room&&e._room._virtualStreams&&e._room._virtualStreams.forEach(((e,t)=>{if(e.audioTrack){const o=e.audioTrack._audioPlayer;i.push({userId:"virtualStream-".concat(t),mediaType:"audio",isScreen:!1,isPublic:!1,isVirtual:!0,ele:o?o._audioDom:void 0,fakeEle:o?o._fakeAudioDom:void 0})}})),{timestamp:t,elementStats:i.map((e=>{let{ele:t,fakeEle:i}=e,o=kf(e,DU);const r=Fu({ele:Fu({srcObject:t?YU(t.srcObject):void 0},VU(WU.map((e=>[e,t[e]]))))},o);return i&&(r.fakeEle=Fu({srcObject:YU(i.srcObject)},VU(WU.map((e=>[e,i[e]]))))),r}))}}(e).then((e=>{t.mediaElementStates.push(e)})),async function(e){const t=Date.now(),i=KU(e),o={};return i?(XU.forEach((e=>{o[e]=i[e]})),{timestamp:t,acState:o}):{timestamp:t,acState:void 0}}(e).then((e=>{t.audioContextStates.push(e)})),async function(e){const t=Date.now();if(HU||(HU=new AudioContext),"suspended"===HU.state&&await new Promise((t=>{const i=setTimeout((()=>{console.warn("[RTC_AMBULANCE] AudioContext resume failed, try to find one in RTCEngine"),HU=KU(e),HU&&console.warn("[RTC_AMBULANCE] find AudioContext in RTCEngine success"),t()}),1e3);HU.resume().then((()=>{clearTimeout(i),t()}),(()=>{clearTimeout(i),HU=null,t()}))})),!HU)return void console.error("[RTC_AMBULANCE] get volume is not supported");const i=BU(e),o=[];return await Promise.all(i.filter((e=>"audio"===e.mediaType)).map((async e=>{let{orgTrack:t,mediaTrack:i,preprocessingTrack:r}=e;const s=Fu({},kf(e,UU));await Promise.all([JU(t,HU).then((e=>{s.orgTrackVolume=e})),JU(i,HU).then((e=>{s.mediaTrackVolume=e})),JU(r,HU).then((e=>{s.preprocessingTrackVolume=e}))]),o.push(s)}))),{timestamp:t,trackVolumes:o}}(e).then((e=>{t.volumes.push(e)})),async function(e){return{timestamp:Date.now(),trackStates:BU(e).map((e=>{let{orgTrack:t,mediaTrack:i,preprocessingTrack:o}=e,r=kf(e,ZU);return Fu({orgTrack:t?VU(GU.map((e=>[e,t[e]]))):void 0,mediaTrack:i?VU(GU.map((e=>[e,i[e]]))):void 0,preprocessingTrack:o?VU(GU.map((e=>[e,o[e]]))):void 0},r)}))}}(e).then((e=>{t.trackStates.push(e)})),async function(e){const t=Date.now();let i=[];e._ctx._handler&&e._ctx._handler._peerConnection&&(i=e._ctx._handler._peerConnection.getTransceivers());const o=[];return i.forEach((e=>{const t=Fu({sender:jU(e.sender),receiver:jU(e.receiver)},VU(FU.map((t=>[t,e[t]]))));o.push(t)})),{timestamp:t,tranceiverStates:o}}(e).then((e=>{t.tranceiverStates.push(e)}))),s++,s>=10?Promise.all(i).then((()=>{o()})):(clearTimeout(r),r=setTimeout(n,500))};r=setTimeout(n,500)})),console.log("RTC_AMBULANCE",t),t}class QU{constructor(){Xu(this,"containers",new WeakSet)}getContainerById(e){return document.getElementById(e)}registerContainer(e){var t;"string"==typeof e&&(e=null!==(t=this.getContainerById(e))&&void 0!==t?t:void 0);return!(!e||this.containers.has(e))&&(this.containers.add(e),!0)}unregisterContainer(e){var t;"string"==typeof e&&(e=null!==(t=this.getContainerById(e))&&void 0!==t?t:void 0);return!!e&&(this.containers.delete(e),!0)}}const qU=["videoStats","audioStats"];var $U,eZ=Object.defineProperty,tZ=Object.getOwnPropertyDescriptor,iZ=(e,t,i,o)=>{for(var r,s=o>1?void 0:o?tZ(t,i):t,n=e.length-1;n>=0;n--)(r=e[n])&&(s=(o?r(t,i,s):r(s))||s);return o&&s&&eZ(t,i,s),s};const oZ=($U=class extends kI{constructor(e,t,i){var o;super(),o=this,Xu(this,"monitor",void 0),Xu(this,"logger",void 0),Xu(this,"_room",void 0),Xu(this,"_wtnStreamManager",void 0),Xu(this,"_appId",void 0),Xu(this,"_localImgVideoTrack",void 0),Xu(this,"_localImgScreenTrack",void 0),Xu(this,"_localScreenVideoTrack",void 0),Xu(this,"_localScreenAudioTrack",void 0),Xu(this,"_tempMixingAudioTrack",void 0),Xu(this,"_localAudioVolume",100),Xu(this,"_localScreenAudioVolume",100),Xu(this,"_remoteAudioVolume",new Map),Xu(this,"_remoteScreenAudioVolume",new Map),Xu(this,"_localVideoPlayerConfig",{[$u.STREAM_INDEX_MAIN]:new Map,[$u.STREAM_INDEX_SCREEN]:new Map}),Xu(this,"_remoteVideoPlayerConfig",{[$u.STREAM_INDEX_MAIN]:new Map,[$u.STREAM_INDEX_SCREEN]:new Map}),Xu(this,"_publicStreamIds",new Map),Xu(this,"_dummyMainImage",void 0),Xu(this,"_dummyScreenImage",void 0),Xu(this,"_trackSourceType",void 0),Xu(this,"_liveTranscodeConfig",void 0),Xu(this,"_startCloudProxyTimestamp",void 0),Xu(this,"_pauseAllSubscribeState",{audio:void 0,video:void 0,resumeAudioStreamIds:{},resumeVideoStreamIds:{}}),Xu(this,"_audioVolumeIndicationTimer",void 0),Xu(this,"_dummyMainTimer",void 0),Xu(this,"_dummyScreenTimer",void 0),Xu(this,"_audioPropertiesReportTimer",null),Xu(this,"_mirrorType",sh.MIRROR_TYPE_RENDER),Xu(this,"_audioMixingManager",void 0),Xu(this,"_pubLock",void 0),Xu(this,"_subLocks",void 0),Xu(this,"_audioCaptureLock",void 0),Xu(this,"_videoCaptureLock",void 0),Xu(this,"_screenCaptureLock",void 0),Xu(this,"_subScreenLocks",void 0),Xu(this,"_rtmClient",void 0),Xu(this,"_messageStatisticsObserver",void 0),Xu(this,"_waitForNewToken",!1),Xu(this,"_originIceConfigRequestUrls",void 0),Xu(this,"_originConfigServerUrls",void 0),Xu(this,"_originLogServerUrl",void 0),Xu(this,"_audioDeviceManager",void 0),Xu(this,"_config",void 0),Xu(this,"_needClosePreTrack",!1),Xu(this,"_containerCollisionDetector",new QU),Xu(this,"_ctx",void 0),Xu(this,"_removeDeviceEventHandler",void 0),Xu(this,"_updateMixAudioTrack",(async function(e){var t;let i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Oh.PLAYOUT_AND_PUBLISH;if(o.logger.info("_updateMixAudioTrack()"),!o._localAudioTrack)return void(e&&(o._tempMixingAudioTrack={track:e,type:i}));e?(o._localAudioTrack.mixType=i,o._localAudioTrack.mixedAudioTrack=e):(delete o._localAudioTrack.mixType,delete o._localAudioTrack.mixedAudioTrack);await(null===(t=o._room)||void 0===t?void 0:t.hasPublished())&&await o._updatePublish(),o._wtnStreamManager._updatePushTrack()})),Xu(this,"_onVideoDeviceStateChange",(e=>{this.safeEmit(xh.onVideoDeviceStateChanged,e)})),Xu(this,"_onAudioDeviceStateChange",(e=>{this.safeEmit(xh.onAudioDeviceStateChanged,e)})),Xu(this,"_onAudioMixingMessage",(e=>{this.safeEmit(xh.onAudioMixingStateChanged,e)})),Xu(this,"_onAudioMixingAutoplayFailed",(e=>{this.safeEmit(xh.onAutoplayFailed,e)})),Xu(this,"_revokeAutoplayFailedWorkaround",void 0),this.id=t,this._appId=e,this.monitor=uS(t),this._ctx=new OD(t,e,i),this._pubLock=new qN("pubLock"),this._subLocks=new Map,this._subScreenLocks=new Map,this._audioCaptureLock=new qN("audioCap"),this._videoCaptureLock=new qN("videoCap"),this._screenCaptureLock=new qN("screenCap"),this._addDeviceEventHandler(),this._audioDeviceManager=new CU(this._ctx),this._addSignalingEventHandler(),this._wtnStreamManager=new EU(this._ctx),this._addWTNStreamEventHandler(),hb&&(window.__rtc_engine__=this,window["__rtc_engine__".concat(Math.floor(100*Math.random()+1))]=this),this._trackSourceType={video:Hu.VIDEO_SOURCE_TYPE_INTERNAL,screenVideo:Hu.VIDEO_SOURCE_TYPE_INTERNAL,audio:Yu.AUDIO_SOURCE_TYPE_INTERNAL,screenAudio:Yu.AUDIO_SOURCE_TYPE_INTERNAL},this._config=i,this._rtmClient=new aU(this._ctx),this._handleRTMClient(this._rtmClient),this._handleAudioDeviceManager(),this._messageStatisticsObserver=new iS(t),this.logger=new LS("Engine",0,t),Hf(this.id),oZ.hasReportNativeDetector||(this.monitor.reportLongString("NativeDetector",JSON.stringify(wb)),oZ.hasReportNativeDetector=!0),this._initAutoplayFailedWorkaround()}get appId(){return this._appId}set appId(e){this._appId=e}async updateToken(e){if(this.logger.info("updateToken()","token: %s",e),Ng(e,"token"),this._room&&this._waitForNewToken)return this._waitForNewToken=!1,this._room.config.token=e,await this._join(this._room);if(!this._room)throw new Cg(Eg.UPDATE_TOKEN_BEFORE_JOIN,"update token before join room");await this._room.updateToken(e);const t=[];if(this._room.config.tokenPublishPrivilegeExpired&&this._room.config.isAutoPublish&&this._ctx.visibility&&t.push(this._updatePublish({mediaType:eh.AUDIO_AND_VIDEO})),this._room.config.tokenSubscribePrivilegeExpired){const{isAutoSubscribeAudio:e,isAutoSubscribeVideo:i}=this._room.config,o=(e?eh.AUDIO:0)|(i?eh.VIDEO:0);o&&t.push(this._triedResumeAllRemoteStreams(o,!0))}await Promise.allSettled(t)}async setVideoCaptureDevice(e){if(this.logger.info("setVideoCaptureDevice()","deviceId: %s",e),Ng(e,"deviceId"),!this._localVideoTrack)return void this._ctx.videoProfile.setCaptureDeviceId(e);if(zS&&$S){if(this._localVideoTrack.originTrack.getSettings().deviceId===e)return}const t=this._ctx.videoProfile.getCaptureConfig(e);var i;$S&&WS&&_g>=85&&_g<=91&&(null===(i=this.localVideoTrack)||void 0===i||i.removePlayerTrack());this._needClosePreTrack=this._needClosePreTrack||lE,this._needClosePreTrack&&(this._removeLocalTrackEvents(this._localVideoTrack),this._localVideoTrack.destroy(),delete this._localVideoTrack),this.logger.info("setVideoCaptureDevice()","start createCameraVideoTrack...");const o=await vN(this._ctx,t).catch((e=>{if(this._localVideoTrack&&!this._localVideoTrack.dummy)return this.logger.warn("setVideoCaptureDevice()","createCameraVideoTrack failed, stop pre VideoTrack."),this._removeLocalTrackEvents(this._localVideoTrack),this._localVideoTrack.destroy(),delete this._localVideoTrack,vN(this._ctx,t).then((e=>(this._needClosePreTrack=!0,e))).catch((async()=>{this.logger.error("setVideoCaptureDevice()","createCameraVideoTrack failed, rollback.");const t=await vN(this._ctx);throw this._switchTrack(t),e}));throw e}));this.logger.success("setVideoCaptureDevice()","createCameraVideoTrack success."),this._ctx.videoProfile.setCaptureDeviceId(e),this._localVideoTrack&&(this._removeLocalTrackEvents(this._localVideoTrack),this._localVideoTrack.destroy());const r=this._ctx.videoProfile.getContentHint();r&&o.setContentHint(r),await this._switchTrack(o)}async setAudioCaptureDevice(e){var t;if(this.logger.info("setAudioCaptureDevice()","deviceId: %s",e),Ng(e,"deviceId"),this._ctx.audioProfileManager.updateConstraints({deviceId:{exact:e}}),!this._localAudioTrack)return;this._localAudioTrack.destroy(),this._removeLocalTrackEvents(this._localAudioTrack);const i=await fN(this._ctx,this._ctx.audioProfileManager.getConstraints());this._initLocalTrackEvents(i),this._localAudioTrack=i,this._localAudioTrack.setVolume(this._localAudioVolume),this._wtnStreamManager._updatePushTrack(),this._room&&null!==(t=this._room.localStream)&&void 0!==t&&t.pubAudio&&await this._updatePublish()}_addDeviceEventHandler(){BP.on(xh.onVideoDeviceStateChanged,this._onVideoDeviceStateChange),BP.on(xh.onAudioDeviceStateChanged,this._onAudioDeviceStateChange),this._removeDeviceEventHandler=()=>{BP.off(xh.onVideoDeviceStateChanged,this._onVideoDeviceStateChange),BP.off(xh.onAudioDeviceStateChanged,this._onAudioDeviceStateChange)}}_addSignalingEventHandler(){const e=this._ctx.signalingManager;e.on(LI.ON_CONNECTION_STATE_CHANGE,this._onConnectionStateChange.bind(this)),e.on(LI.ON_RECONNECT_FAILED,(()=>{this.safeEmit(xh.onError,{errorCode:Eg.RECONNECT_FAILED})})),e.on(LI.CONNECT_WITH_TCP,(()=>{this.safeEmit(xh.onIceConnectWithTcp)}))}_addWTNStreamEventHandler(){this._wtnStreamManager.__onResubscribe=e=>{const t=e.stream;t&&(t.audioTrack&&this._updateAudioPlayerState(t),t.videoTrack&&this._updateVideoPlayerState(t))},this._wtnStreamManager.__onRemoteStreamStats=e=>{this.safeEmit(xh.onPublicStreamStats,e)},this._wtnStreamManager.__onSEIMessageReceived=e=>{this.safeEmit(xh.onPublicStreamSEIMessageReceived,e)},this._wtnStreamManager.__onPlayerEvents=(e,t,i)=>{this._initPlayerEvents(e,t,i)}}_addHandlerEventHandler(){var e,t,i,o,r,s,n,a,d,c,l,u,h,_,m,p,v,f,S,g,y,b,T,I,E,R,C,k,A,P,N,w,O,M,L,x,V,D,U,Z,W,X;null===(e=this._room)||void 0===e||e.on(OI.ON_ADD_STREAM,this._onAddStream.bind(this)),null===(t=this._room)||void 0===t||t.on(OI.ON_REMOVE_STREAM,this._onRemoveStream.bind(this)),null===(i=this._room)||void 0===i||i.on(OI.USER_CONNECTION,this._onUserConnection.bind(this)),null===(o=this._room)||void 0===o||o.on(wN.ON_USER_LEAVE,this._onUserLeave.bind(this)),null===(r=this._room)||void 0===r||r.on(wN.ON_ROOM_ERROR,this._onRoomError.bind(this)),null===(s=this._room)||void 0===s||s.on(wN.ON_NETWORK_QUALITY,this._onNetworkQuality.bind(this)),null===(n=this._room)||void 0===n||n.on(OI.ON_CUSTOM_MESSAGE,this._onCustomMessage.bind(this)),null===(a=this._room)||void 0===a||a.on(OI.USER_MESSAGE_RECEIVED,this._onUserMessageReceived.bind(this)),null===(d=this._room)||void 0===d||d.on(OI.USER_BINARY_MESSAGE_RECEIVED,this._onUserBinaryMessageReceived.bind(this)),null===(c=this._room)||void 0===c||c.on(OI.ON_USER_TOKEN_WILL_EXPIRE,this._onUserTokenWillExpire.bind(this)),null===(l=this._room)||void 0===l||l.on(OI.ON_TOKEN_PUBLISH_PRIVILEGE_WILL_EXPIRE,this._onUserTokenPublishPrivilegeWillExpire.bind(this)),null===(u=this._room)||void 0===u||u.on(OI.ON_TOKEN_PUBLISH_PRIVILEGE_DID_EXPIRED,this._onUserTokenPublishPrivilegeDidExpired.bind(this)),null===(h=this._room)||void 0===h||h.on(OI.ON_TOKEN_SUBSCRIBE_PRIVILEGE_WILL_EXPIRE,this._onUserTokenSubscribePrivilegeWillExpire.bind(this)),null===(_=this._room)||void 0===_||_.on(OI.ON_TOKEN_SUBSCRIBE_PRIVILEGE_DID_EXPIRED,this._onUserTokenSubscribePrivilegeDidExpired.bind(this)),null===(m=this._room)||void 0===m||m.on(OI.POST_PROCESSING_MESSAGE,(e=>{var t;"2.0"===(null==(t=e)?void 0:t.protocol)?this._onStreamMixingEvent({error:e.error,event:e.eventType,message:e.message}):"publicStreamCallback"===e.type?this._onPushPublicStreamResult(e):"transcodeStatusCallback"===e.type&&this._onLiveTranscodingResult(e)})),null===(p=this._room)||void 0===p||p.on(LI.ON_VENDOR_CONNECTION_STATE_CHANGE,(e=>this.safeEmit(xh.onVendorConnectionStateChanged,e))),null===(v=this._room)||void 0===v||v.on(wN.RESUBSCRIBE,this._onResubscribe.bind(this)),null===(f=this._room)||void 0===f||f.on(wN.SUBSCRIBE_PUSH_TRACK,this._onSubscribePushTrack.bind(this)),null===(S=this._room)||void 0===S||S.on(wN.REMOVE_PUSH_TRACK,this._onRemovePushTrack.bind(this)),null===(g=this._room)||void 0===g||g.on(wN.ON_PUBLISH_RESULT,(e=>{var t,i,o;e.state===zu.PUBLISH_SUCC&&(null===(i=this._room)||void 0===i||i.config.setTokenPublishPrivilegeExpired(!1));e.state===zu.PUBLISH_FAIL&&e.errorCode===Eg.TOKEN_NO_PUBLISH_PERMISSION&&(null===(o=this._room)||void 0===o||o.config.setTokenPublishPrivilegeExpired(!0));const r=!(e.retry||null===(t=this._room)||void 0===t||!t.config.isAutoPublish);r&&this.safeEmit(xh.onAutoPublishResult,e),this.safeEmit(xh.onPublishResult,{isScreen:e.isScreen,isAutoPublish:r,errorCode:e.errorCode})})),null===(y=this._room)||void 0===y||y.on(wN.ON_SUBSCRIBE_RESULT,(e=>{var t;e.state===ju.SUBSCRIBE_SUCC&&(null===(t=this._room)||void 0===t||t.config.setTokenSubscribePrivilegeExpired(!1));e.state===ju.SUBSCRIBE_FAIL&&e.errorCode===Eg.TOKEN_NO_SUBSCRIBE_PERMISSION&&this._handleLoseSubscribePrivilege(),this.safeEmit(xh.onSubscribeResult,{userId:e.userId,isScreen:e.isScreen,isAutoSubscribe:!1,errorCode:e.errorCode})})),null===(b=this._room)||void 0===b||b.on(wN.ON_REMOTE_STREAM_STATS,(e=>{this.safeEmit(xh.onRemoteStreamStats,e)})),null===(T=this._room)||void 0===T||T.on(wN.ON_LOCAL_STREAM_STATS,(e=>{this.safeEmit(xh.onLocalStreamStats,e)})),null===(I=this._room)||void 0===I||I.on(wN.ON_SUBTITLE_STATE_CHANGED,(e=>{this.safeEmit(xh.onSubtitleStateChanged,e)})),null===(E=this._room)||void 0===E||E.on(wN.ON_SUBTITLE_MESSAGE_RECEIVED,(e=>{this.safeEmit(xh.onSubtitleMessageReceived,e)})),null===(R=this._room)||void 0===R||R.on(wN.ON_USER_PUBLISH_STATE_CHANGE,this._onUserPublishStateChange.bind(this)),null===(C=this._room)||void 0===C||C.on(wN.ON_USER_START_AUDIO_CAPTURE,((e,t)=>{let{userId:i}=e;this._updateAudioPlayerState(t),this.safeEmit(xh.onUserStartAudioCapture,{userId:i})})),null===(k=this._room)||void 0===k||k.on(wN.ON_USER_STOP_AUDIO_CAPTURE,(e=>{let{userId:t}=e;this.safeEmit(xh.onUserStopAudioCapture,{userId:t})})),null===(A=this._room)||void 0===A||A.on(wN.ON_USER_START_VIDEO_CAPTURE,(e=>{let{userId:t}=e;this.safeEmit(xh.onUserStartVideoCapture,{userId:t})})),null===(P=this._room)||void 0===P||P.on(wN.ON_USER_STOP_VIDEO_CAPTURE,(e=>{let{userId:t}=e;this.safeEmit(xh.onUserStopVideoCapture,{userId:t})})),null===(N=this._room)||void 0===N||N.on(wN.ON_SEI_MESSAGED_RECEIVED,(e=>{this.safeEmit(xh.onSEIMessageReceived,e)})),null===(w=this._room)||void 0===w||w.on(wN.ON_REMOTE_VIDEO_SIZE_CHANGED,((e,t)=>{this.safeEmit(xh.onRemoteVideoSizeChanged,e,t)})),null===(O=this._room)||void 0===O||O.on(wN.ON_SIMULCAST_SUBSCRIBE_FALLBACK,(e=>this.safeEmit(xh.onSimulcastSubscribeFallback,e))),null===(M=this._room)||void 0===M||M.on(wN.ON_VIDEO_STREAM_BANNED,(e=>{this.safeEmit(xh.onVideoStreamBanned,{uid:e.uid,banned:e.banned})})),null===(L=this._room)||void 0===L||L.on(wN.ON_AUDIO_STREAM_BANNED,(e=>{this.safeEmit(xh.onAudioStreamBanned,{uid:e.uid,banned:e.banned})})),null===(x=this._room)||void 0===x||x.on(wN.ON_FORWARD_STREAM_ERROR,(e=>{this.safeEmit(xh.onForwardStreamError,e)})),null===(V=this._room)||void 0===V||V.on(wN.ON_REJOIN_WITH_TCP,(()=>{this.safeEmit(xh.onRejoinWithTcp)})),null===(D=this._room)||void 0===D||D.on(wN.PUB_RETRY,(e=>{this.safeEmit(xh.onPublishRetry,e)})),null===(U=this._room)||void 0===U||U.on(wN.SUB_RETRY,(e=>{this.safeEmit(xh.onSubscribeRetry,e)})),null===(Z=this._room)||void 0===Z||Z.on(wN.VIDEO_TYPE_CHANGE,(e=>{this.safeEmit(xh.onSEIStreamUpdate,e)})),null===(W=this._room)||void 0===W||W.on(wN.JOIN_SUCCESS,(e=>{this._ctx.isPreConnection||this.safeEmit(xh.onConnectionStateChanged,{state:e?ih.CONNECTION_STATE_RECONNECTED:ih.CONNECTION_STATE_CONNECTED})})),null===(X=this._room)||void 0===X||X.on(wN.UPDATE_PUBLISH,(e=>{let{streamIndex:t}=e;t===$u.STREAM_INDEX_MAIN?this._updatePublish():t===$u.STREAM_INDEX_SCREEN&&this._updateScreenPublish()}))}safeEmit(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),o=1;o<t;o++)i[o-1]=arguments[o];if(function(e){const t=Qg("FORCE_ENABLED_REPORT_CALLBACKS");if(null!=t&&t.includes(e))return!0;if(e===xh.onRemoteStreamStats&&Qg("UPLOAD_REMOTE_STATS"))return!0;return![xh.onRemoteStreamStats,xh.onLocalStreamStats,xh.onAudioVolumeIndication,xh.onLocalAudioPropertiesReport,xh.onRemoteAudioPropertiesReport].includes(e)}(e)){if(e===xh.onRemoteStreamStats){const e=Qg("UPLOAD_REMOTE_STATS"),t=Qg("FORCE_ENABLED_REPORT_CALLBACKS").includes("onRemoteStreamStats"),o=i[0],{videoStats:r,audioStats:s}=o,n=kf(o,qU);i[0]=Fu({},n),(e&eh.VIDEO||t)&&(i[0].videoStats=r),(e&eh.AUDIO||t)&&(i[0].audioStats=s)}vS(this.id,e,i)}return super.safeEmit(e,...i)}_removeHandlerEventHandler(){var e;null===(e=this._room)||void 0===e||e.removeAllListeners()}async connect(){await this._ctx.signalingManager.connect()}async joinRoom(e,t,i,o){var r,s,n,a,d;if(this.logger.info("joinRoom()","token: %o roomId: %o, userInfo: %o, roomConfig: %o",e,t,i,o),Vg(e)||Ng(e,"token"),this._room)throw new Cg(Eg.REPEAT_JOIN,"Already joined");null===(r=this._ctx.monitor)||void 0===r||r.report("rtc_sdk_api_call",{sdk_api_name:"host",message:location.host,error_code:0}),Dg(t),function(e){Mg(e,"userInfo"),Ug(e.userId),Vg(e.extraInfo)||Ng(e.extraInfo,"userInfo.extraInfo",1,200)}(i);const c=new dw({token:e,roomId:t,userInfo:i},this._ctx);return function(e){Mg(e,"roomConfig"),kg(e.isAutoPublish,"roomConfig.isAutoPublish"),kg(e.isAutoSubscribeAudio,"roomConfig.isAutoSubscribeAudio"),kg(e.isAutoSubscribeVideo,"roomConfig.isAutoSubscribeVideo"),Vg(e.roomProfileType)||wg(e.roomProfileType,"roomConfig",[vh.communication,vh.chat,vh.chatRoom,vh.coHost,vh.meeting,vh.classRoom])}(c.updateRoomConfig(o)),c.setLiveControlMessage(this._liveTranscodeConfig&&OU.getStartParams(this._liveTranscodeConfig)),this._room=new tU(c,this._ctx),this.monitor.set({rtc_session_id:this._room.config.sessionId}),this._addHandlerEventHandler(),this._ctx.useCloudProxy&&(this._startCloudProxyTimestamp=Date.now()),null===(s=this._localVideoTrack)||void 0===s||s.setUserId(i.userId),null===(n=this._localScreenVideoTrack)||void 0===n||n.setUserId(i.userId),null===(a=this._localAudioTrack)||void 0===a||a.setUserId(i.userId),null===(d=this._localScreenAudioTrack)||void 0===d||d.setUserId(i.userId),(e=>{if(e.extraInfo)try{const t=JSON.parse(e.extraInfo);t.source_language&&["zh","en","ja"].indexOf(t.source_language)}catch(i){}else{var t;const i=(null===(t=navigator.language)||void 0===t?void 0:t.substring(0,2))||"";["zh","en","ja"].indexOf(i)>-1&&(e.extraInfo=JSON.stringify({source_language:i}))}})(i),await this._join(this._room)}async _join(e){try{var t;const i=await e.join();return this._waitForNewToken=!1,this._ctx.audioProfileManager.setRoomId(e.config.roomId),null!==(t=this._room)&&void 0!==t&&t.config.isAutoPublish&&(this._ctx.visibility?this._updatePublish({invokeByJoinRoom:!0,mediaType:eh.AUDIO_AND_VIDEO}).catch((e=>{this.logger.error("_join","_updatePublish failed",e)})):(this.safeEmit(xh.onAutoPublishResult,{isScreen:!1,state:zu.PUBLISH_FAIL}),this.safeEmit(xh.onPublishResult,{isScreen:!1,isAutoPublish:!0,errorCode:Eg.NO_PUBLISH_PERMISSION}))),this.monitor.set({rtc_vid:e.config.rtcVid}),Kf(this.id,e.config.roomId),Bf(this.id,e.config.userId),i}catch(i){throw i.code===Eg.INVALID_TOKEN?this._waitForNewToken=!0:(e.destroy(),this._room===e&&delete this._room),i}}async leaveRoom(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this.logger.info("leaveRoom()");const t=this._room;delete this._room,this._ctx.resetPubSubLock(ND.LEAVE),this._ctx.callId=void 0,e?await(null==t?void 0:t.leave(e)):null==t||t.leave(e).catch(),this._removeHandlerEventHandler(),this._subLocks=new Map,this._subScreenLocks=new Map,this._ctx.audioProfileManager.setRoomId(),this._liveTranscodeConfig&&this.stopLiveTranscoding(),null==t||t.destroy(),this._remoteVideoPlayerConfig[$u.STREAM_INDEX_MAIN].forEach((e=>{e.forEach((e=>{const{player:t,renderDom:i}=e;null==t||t.destroy(),this._containerCollisionDetector.unregisterContainer(i)}))})),this._remoteVideoPlayerConfig[$u.STREAM_INDEX_MAIN].clear(),this._remoteVideoPlayerConfig[$u.STREAM_INDEX_SCREEN].forEach((e=>{e.forEach((e=>{const{player:t,renderDom:i}=e;null==t||t.destroy(),this._containerCollisionDetector.unregisterContainer(i)}))})),this._remoteVideoPlayerConfig[$u.STREAM_INDEX_SCREEN].clear(),this._publicStreamIds=new Map,Kf(this.id,""),Bf(this.id,""),this.monitor.set({rtc_session_id:"",rtc_vid:""})}_destroyLocalTrack(){this._localAudioTrack&&(this._removeLocalTrackEvents(this._localAudioTrack),this._localAudioTrack.destroy(),this._localAudioTrack=void 0),this._localVideoTrack&&(this._removeLocalTrackEvents(this._localVideoTrack),this._localVideoTrack.destroy(),this._localVideoTrack=void 0),this._localScreenAudioTrack&&(this._removeLocalTrackEvents(this._localScreenAudioTrack),this._localScreenAudioTrack.destroy(),this._localScreenAudioTrack=void 0),this._localScreenVideoTrack&&(this._removeLocalTrackEvents(this._localScreenVideoTrack),this._localScreenVideoTrack.destroy(),this._localScreenVideoTrack=void 0),this._localImgVideoTrack&&(this._localImgVideoTrack.stop(),this._localImgVideoTrack=void 0),this._localImgScreenTrack&&(this._localImgScreenTrack.stop(),this._localImgScreenTrack=void 0)}destroy(){var e,t,i,o;this.logger.info("destroy()"),this.removeAllListeners(),this._removeHandlerEventHandler(),null===(e=this._removeDeviceEventHandler)||void 0===e||e.call(this),null===(t=this._revokeAutoplayFailedWorkaround)||void 0===t||t.call(this),null===(i=this._room)||void 0===i||i.destroy(),this._room=void 0,this._subLocks=new Map,this._subScreenLocks=new Map,this._audioCaptureLock=new qN("audioCap"),this._videoCaptureLock=new qN("videoCap"),this._screenCaptureLock=new qN("screenCap"),this._pauseAllSubscribeState={audio:void 0,video:void 0,resumeVideoStreamIds:{},resumeAudioStreamIds:{}},this._messageStatisticsObserver.destroy(),this.monitor.destroy(),Yf(this.id),clearInterval(this._audioVolumeIndicationTimer),clearInterval(this._dummyMainTimer),clearInterval(this._dummyScreenTimer),this._audioVolumeIndicationTimer=void 0,this._stopAudioPropertiesReport(),this._destroyLocalTrack(),null===(o=this._audioMixingManager)||void 0===o||o.destroy(),this._rtmClient.destroy(),this._wtnStreamManager.destroy(),this._publicStreamIds=new Map,this._audioDeviceManager.destroy(),this._ctx.destroy(),this._localAudioVolume=100,this._localScreenAudioVolume=100,this._remoteAudioVolume.clear(),this._remoteScreenAudioVolume.clear(),this._localVideoPlayerConfig[$u.STREAM_INDEX_MAIN].forEach((e=>{e.player.destroy()})),this._localVideoPlayerConfig[$u.STREAM_INDEX_MAIN].clear(),this._localVideoPlayerConfig[$u.STREAM_INDEX_SCREEN].forEach((e=>{e.player.destroy()})),this._localVideoPlayerConfig[$u.STREAM_INDEX_SCREEN].clear(),this._remoteVideoPlayerConfig[$u.STREAM_INDEX_MAIN].forEach((e=>{e.forEach((e=>{e.player.destroy()}))})),this._remoteVideoPlayerConfig[$u.STREAM_INDEX_MAIN].clear(),this._remoteVideoPlayerConfig[$u.STREAM_INDEX_SCREEN].forEach((e=>{e.forEach((e=>{e.player.destroy()}))})),this._remoteVideoPlayerConfig[$u.STREAM_INDEX_SCREEN].clear()}async publishStream(e){this.logger.info("publishStream()","mediaType: %o",e),this._checkMediaType(e),this._assertNotInRoom(),sb(e)&&!this._localVideoTrack&&this._localImgVideoTrack&&(this._localVideoTrack=await async function(e,t){const i=new $P(e,t,{streamIndex:XI.MAIN,sourceType:ZI.INTERNAL,isDummy:!0});return await i.isTrackReady,i}(this._ctx,this._localImgVideoTrack)),await this._updatePublish({mediaType:e},!0)}async unpublishStream(e,t){var i;if(this.logger.info("unpublishStream()","mediaType: %o",e),this._checkMediaType(e),this._assertNotInRoom(),t)return null===(i=this._room)||void 0===i?void 0:i.unpublish();await this._updatePublish({mediaType:e,pubState:MN.UNPUB},!0)}async publishScreen(e){this.logger.info("publishScreen()","mediaType: %o",e),this._checkMediaType(e),this._assertNotInRoom();try{sb(e)&&!this._localScreenVideoTrack&&this._localImgScreenTrack&&(this._localScreenVideoTrack=await async function(e,t){const i=new $P(e,t,{isDummy:!0,streamIndex:XI.SCREEN,sourceType:ZI.INTERNAL});return await i.isTrackReady,i}(this._ctx,this._localImgScreenTrack)),await this._updateScreenPublish({mediaType:e,pubState:MN.PUB})}catch(wZ){throw wZ instanceof Cg?wZ:new Cg(Eg.UNEXPECTED_ERROR,"unexpected error",wZ)}}async unpublishScreen(e){this.logger.info("unpublishScreen()","mediaType: %o",e),this._checkMediaType(e),this._assertNotInRoom(),await this._updateScreenPublish({mediaType:e,pubState:MN.UNPUB})}async subscribeStream(e,t){return this.logger.info("subscribeStream()","userId: %o, mediaType: %o",e,t),this._subscribe(!1,e,t)}async _subscribe(e,t,i){var o;const r=i;if(i===eh.AUDIO&&null!==(o=this._room)&&void 0!==o&&o.config.isMultiChatMode())return void this.logger.warn("subscribeStream()","due to multiChatMode return");const s=this._room.remoteStreams.get(t),n=null==s?void 0:s.find((t=>t.isScreen===e));if(!n)throw new Cg(Eg.STREAM_NOT_EXIST,"stream not exist");const a=this._pauseAllSubscribeState.audio,d=this._pauseAllSubscribeState.video;this._pauseAllSubscribeState.audio&&(i-=i&eh.AUDIO),this._pauseAllSubscribeState.video&&(i-=i&eh.VIDEO),this.logger.warn("subscribeStream()","due to pauseAll mediaType: %o",i);const{hasSubscribed:c}=n;n.originalMediaType=i;try{var l;await this._room.subscribe(n,i),rb(i)&&this._updateAudioPlayerState(n),sb(i)&&this._updateVideoPlayerState(n);let o=0,s=0;if(a!==this._pauseAllSubscribeState.audio&&(this._pauseAllSubscribeState.audio?o|=eh.AUDIO:s|=eh.AUDIO),d!==this._pauseAllSubscribeState.video&&(this._pauseAllSubscribeState.video?o|=eh.VIDEO:s|=eh.VIDEO),o&&this.pauseAllSubscribedStream(o),s&&this.resumeAllSubscribedStream(s),rb(r)&&(this._pauseAllSubscribeState.resumeAudioStreamIds[n.streamId]=n.streamId),sb(r)&&(this._pauseAllSubscribeState.resumeVideoStreamIds[n.streamId]=n.streamId),n.audioTrack||n.videoTrack){var u,h;const i=!(e||!(null!==(u=this._room)&&void 0!==u&&u.config.isAutoSubscribeAudio||null!==(h=this._room)&&void 0!==h&&h.config.isAutoSubscribeVideo)),o={userId:t,isScreen:!1,state:ju.SUBSCRIBE_SUCC};i&&this.safeEmit(xh.onAutoSubscribeResult,o),this.safeEmit(xh.onSubscribeResult,{userId:t,isScreen:e,isAutoSubscribe:i})}var _,m;if((null===(l=this._room)||void 0===l||!l.config.isMultiChatMode())&&!c&&rb(i)&&n.hasAudio)null===(_=n.observer)||void 0===_||_.setSubscribeAudio(!0);if(!c&&sb(i)&&n.hasVideo)null===(m=n.observer)||void 0===m||m.setSubscribeVideo(!0)}catch(wZ){throw wZ instanceof Cg&&wZ.code===Eg.TOKEN_NO_SUBSCRIBE_PERMISSION&&this._handleLoseSubscribePrivilege(),wZ}}async _handleLoseSubscribePrivilege(){var e;null===(e=this._room)||void 0===e||e.config.setTokenSubscribePrivilegeExpired(!0);try{await this._unSubscribeAllRemoteStreams()}catch(wZ){}}async unsubscribeStream(e,t){return this.logger.info("unsubscribeStream()","userId: %o, mediaType: %o",e,t),this._unsubscribe(!1,e,t)}async subscribeScreen(e,t){return this.logger.info("subscribeScreen() userId: %o, mediaType: %o",e,t),this._subscribe(!0,e,t)}async unsubscribeScreen(e,t){return this.logger.info("unsubscribeScreen() userId: %o, mediaType: %o",e,t),this._unsubscribe(!0,e,t)}_unsubscribe(e,t,i,o){var r;if(i===eh.AUDIO&&null!==(r=this._room)&&void 0!==r&&r.config.isMultiChatMode())return void this.logger.warn("subscribeStream()","due to multiChatMode return");const s=this._room.remoteStreams.get(t),n=null==s?void 0:s.find((t=>t.isScreen===e));if(!n)throw new Cg(Eg.STREAM_NOT_EXIST,"stream not exist");var a;$S&&_g&&_g>=85&&_g<=91&&i!==eh.AUDIO&&(null===(a=n.videoTrack)||void 0===a||a.stopAll());return this._room.unsubscribe(n,i).then((()=>{o||(rb(i)&&delete this._pauseAllSubscribeState.resumeAudioStreamIds[n.streamId],sb(i)&&delete this._pauseAllSubscribeState.resumeVideoStreamIds[n.streamId])}))}async setRemoteVideoConfig(e,t){var i;return this.logger.info("setRemoteVideoConfig() userId: %o, remoteVideoConfig: %o",e,t),this._ctx.videoProfile.checkSimulcastApiVersion("old"),Ug(e),function(e){if("number"!=typeof(null==e?void 0:e.width)||"number"!=typeof(null==e?void 0:e.height))throw new Cg(Eg.INVALID_PARAMS,"remoteVideoConfig must contain width, height, frameRate")}(t),this._ctx.videoProfile.setRemoteUserVideoConfig(e,t),null===(i=this._room)||void 0===i?void 0:i.updateSubVideoConfig(e).then((()=>{}))}async setRemoteSimulcastStreamType(e,t){var i;this.logger.info("setRemoteSimulcastStreamType()","userId: %s, streamType: %s",e,t),this._ctx.videoProfile.checkSimulcastApiVersion("new"),Ug(e),wg(t,"SimulcastStreamType",[kh.VIDEO_STREAM_HIGH,kh.VIDEO_STREAM_MID,kh.VIDEO_STREAM_LOW]),this._ctx.videoProfile.setRemoteUserVideoConfig(e,t),await(null===(i=this._room)||void 0===i?void 0:i.updateSubVideoConfig(e))}async startVideoCapture(e){var t,i;if(this.logger.info("startVideoCapture()","deviceId: %s",e),Vg(e)||Ng(e,"deviceId"),e&&this._ctx.videoProfile.setCaptureDeviceId(e),this._trackSourceType.video===Hu.VIDEO_SOURCE_TYPE_EXTERNAL)throw new Cg(Eg.STREAM_TYPE_NOT_MATCH,"setVideoSourceType as internal first");if(this._localVideoTrack&&!this._localVideoTrack.dummy)throw new Cg(Eg.REPEAT_CAPTURE,"Has already capture");let o={};const r=await vN(this._ctx),s=this._ctx.videoProfile.getContentHint();s&&r.setContentHint(s),this._initLocalTrackEvents(r),this._localVideoTrack=r;this._localVideoPlayerConfig[$u.STREAM_INDEX_MAIN].forEach((e=>{var t,i;null===(t=this._localVideoTrack)||void 0===t||t.setPlayer(e,this._mirrorType,null===(i=this._config)||void 0===i?void 0:i.autoPlayPolicy,this._initPlayerEvents.bind(this))}));o=r.originTrack.getSettings();const n={width:o.width,height:o.height};if(this._localVideoTrack.resolution=n,this._ctx.videoProfile.__autoResetVideoEncoderConfig(o),setTimeout((()=>this.safeEmit(xh.onLocalVideoSizeChanged,{streamIndex:$u.STREAM_INDEX_MAIN,info:n}))),this._ctx.engineDestroyed)return this._destroyLocalTrack(),o;if(this._wtnStreamManager._updatePushTrack(),!this._room)return o;const{isAutoPublish:a}=this._room.config;return(null!==(t=this._room.localStream)&&void 0!==t&&t.pubVideo||a)&&this._ctx.visibility&&this._updatePublish(),null===(i=this._room.localStream)||void 0===i||null===(i=i.observer)||void 0===i||i.setEnableVideo(!0),o}async getLocalStreamStats(){var e;return await(null===(e=this._room)||void 0===e?void 0:e.getLocalStreamStats())}async stopVideoCapture(){var e,t;if(this.logger.info("stopVideoCapture()"),this._trackSourceType.video===Hu.VIDEO_SOURCE_TYPE_EXTERNAL)throw new Cg(Eg.STREAM_TYPE_NOT_MATCH,"setVideoSourceType as internal first");if(this._localVideoTrack&&!this._localVideoTrack.dummy){const e=this._ctx.extensionManager.getPluginByName(LP.PRE_PROCESSING,"RTCBeautyExtension");e&&e.emit("stop"),this._removeLocalTrackEvents(this._localVideoTrack),this._localVideoTrack.destroy(),this._localImgVideoTrack?this._localVideoTrack.setTrack(this._localImgVideoTrack,{isDummy:!0}):this._localVideoTrack=void 0}this._wtnStreamManager._updatePushTrack(),this._room&&(null!==(e=this._room.localStream)&&void 0!==e&&e.pubVideo&&await this._updatePublish(),null===(t=this._room.localStream)||void 0===t||null===(t=t.observer)||void 0===t||t.setEnableVideo(!1))}async startAudioCapture(e){var t,i;if(this.logger.info("startAudioCapture()","deviceId: $o",e),Vg(e)||Ng(e,"deviceId"),e&&this._ctx.audioProfileManager.updateConstraints({deviceId:{exact:e}}),this._trackSourceType.audio===Yu.AUDIO_SOURCE_TYPE_EXTERNAL)throw new Cg(Eg.STREAM_TYPE_NOT_MATCH,"setAudioSourceType as internal first");if(this._localAudioTrack)throw new Cg(Eg.REPEAT_CAPTURE,"Has already capture");let o={};const r=await fN(this._ctx,this._ctx.audioProfileManager.getConstraints());o=r.originTrack.getSettings(),this._initLocalTrackEvents(r),this._localAudioTrack=r,this._localAudioTrack.setVolume(this._localAudioVolume);const{frameSize:s,callback:n}=this._ctx._localAudioTrackDumpConfig[$u.STREAM_INDEX_MAIN];s&&n&&this._localAudioTrack.setDataFetcher(s,n);const{position:a,volume:d}=this._ctx.earMonitorSettings[$u.STREAM_INDEX_MAIN];if(a!==Ah.NONE&&(this._localAudioTrack.play(a),this._localAudioTrack.setPlaybackVolume(d)),this._tempMixingAudioTrack&&(this._localAudioTrack.mixType=this._tempMixingAudioTrack.type,this._localAudioTrack.mixedAudioTrack=this._tempMixingAudioTrack.track,delete this._tempMixingAudioTrack),this._ctx.engineDestroyed)return this._destroyLocalTrack(),o;if(this._wtnStreamManager._updatePushTrack(),!this._room)return o;const{isAutoPublish:c}=this._room.config;return(null!==(t=this._room.localStream)&&void 0!==t&&t.pubAudio||c)&&this._ctx.visibility&&this._updatePublish(),null===(i=this._room.localStream)||void 0===i||null===(i=i.observer)||void 0===i||i.setEnableAudio(!0),o}async stopAudioCapture(){var e,t,i;if(this.logger.info("stopAudioCapture()"),this._trackSourceType.audio===Yu.AUDIO_SOURCE_TYPE_EXTERNAL)throw new Cg(Eg.STREAM_TYPE_NOT_MATCH,"setAudioSourceType as internal first");this._localAudioTrack&&(this._removeLocalTrackEvents(this._localAudioTrack),this._localAudioTrack.destroy()),this._localAudioTrack=void 0,null===(e=this._audioMixingManager)||void 0===e||e.stopAll(),this._wtnStreamManager._updatePushTrack(),this._room&&(null!==(t=this._room.localStream)&&void 0!==t&&t.pubAudio&&await this._updatePublish(),null===(i=this._room.localStream)||void 0===i||null===(i=i.observer)||void 0===i||i.setEnableAudio(!1))}async startAudioAndVideoCapture(e,t){var i,o,r,s;this.logger.print("startAudioAndVideoCapture","optionsOrAudioDeviceId: $o",e,"videoDeviceId: $o",t);const{audioDeviceId:n,videoDeviceId:a}=function(e,t){let i;return Vg(t)||Ng(t,"videoDeviceId"),Vg(e)||("string"==typeof e?(Ng(e,"audioDeviceId"),i=e):(i=null==e?void 0:e.audioDeviceId,t=null==e?void 0:e.videoDeviceId,Ng(i,"audioDeviceId"),Ng(t,"videoDeviceId"))),{audioDeviceId:i,videoDeviceId:t}}(e,t);if(n&&this._ctx.audioProfileManager.updateConstraints({deviceId:{exact:n}}),this._trackSourceType.video===Hu.VIDEO_SOURCE_TYPE_EXTERNAL||this._trackSourceType.audio===Yu.AUDIO_SOURCE_TYPE_EXTERNAL)throw new Cg(Eg.STREAM_TYPE_NOT_MATCH,this._trackSourceType.video===Hu.VIDEO_SOURCE_TYPE_EXTERNAL?"setVideoSourceType as internal first":"setAudioSourceType as internal first");if(this._localVideoTrack&&!this._localVideoTrack.dummy)throw new Cg(Eg.REPEAT_CAPTURE,"video has already capture");if(this._localAudioTrack)throw new Cg(Eg.REPEAT_CAPTURE,"audio has already capture");const d=this._ctx.videoProfile.getCaptureConfig(a);let c={},l={};const{audioTrack:u,videoTrack:h}=await async function(e,t,i){var o,r;let s;new LS("TrackFactory",0,e.id).print("createCameraAndMicrophoneTrack","audioConstraints:",t,"videoConstraints:",i);const n=(null===(o=t.deviceId)||void 0===o?void 0:o.exact)||"default",a=(null===(r=i.deviceId)||void 0===r?void 0:r.exact)||"default",d=sm(),c=sm();try{var l,u,h,_,m,p;null===(l=e.monitor)||void 0===l||l.report("rtc_video_capture_event",{event_type:"start",media_device_id:a,capture_session_id:d}),null===(u=e.monitor)||void 0===u||u.report("rtc_audio_device_event",{device_type:"audio_record",event_type:"start_begin",media_device_id:n,event_session_id:c});const o=jy();US&&(i.frameRate={ideal:30,max:30}),e.extensionManager.getPluginByName(LP.PRE_PROCESSING,"RTCAIAnsExtension")&&(t.autoGainControl=!0,t.noiseSuppression=!1),s=await BP.getUserMedia({audio:t,video:i}),null===(h=e.monitor)||void 0===h||h.report("rtc_video_capture_event",{event_type:"start_capture_result",media_device_id:a,media_device_name:(null===(_=s.getVideoTracks()[0])||void 0===_?void 0:_.label)||"",reason:"success",elapse:jy()-o,capture_session_id:d}),null===(m=e.monitor)||void 0===m||m.report("rtc_audio_device_event",{device_type:"audio_record",event_type:"start_result",media_device_id:n,media_device_name:(null===(p=s.getAudioTracks()[0])||void 0===p?void 0:p.label)||"",reason:"success",elapse:jy()-o,event_session_id:c})}catch(wZ){var v,f;throw null===(v=e.monitor)||void 0===v||v.report("rtc_video_capture_event",{event_type:"running_failed",media_device_id:a,error_code:wZ.code,reason:wZ.name+wZ.message,capture_session_id:d}),null===(f=e.monitor)||void 0===f||f.report("rtc_audio_device_event",{device_type:"audio_record",event_type:"start_end",media_device_id:n,error_code:wZ.code,reason:wZ.name+wZ.message,event_session_id:c}),new Cg(Eg.GET_VIDEO_TRACK_FAILED,"throw error from getUserMedia. [".concat(wZ.name||"unknown name","]: ").concat(wZ.message||"unknown message","."),wZ)}const S=s.getVideoTracks()[0],g=new $P(e,S,{streamIndex:XI.MAIN,sourceType:ZI.INTERNAL,captureSessionId:d}),y=s.getAudioTracks()[0],b=new aN(e,y,{streamIndex:XI.MAIN,sourceType:ZI.INTERNAL,captureSessionId:c});return await Promise.all([g.isTrackReady,b.isTrackReady]),{videoTrack:g,audioTrack:b}}(this._ctx,this._ctx.audioProfileManager.getConstraints(),d),_=this._ctx.videoProfile.getContentHint();_&&h.setContentHint(_),a&&this._ctx.videoProfile.setCaptureDeviceId(a),this._initLocalTrackEvents(h),this._localVideoTrack=h;this._localVideoPlayerConfig[$u.STREAM_INDEX_MAIN].forEach((e=>{var t,i;null===(t=this._localVideoTrack)||void 0===t||t.setPlayer(e,this._mirrorType,null===(i=this._config)||void 0===i?void 0:i.autoPlayPolicy,this._initPlayerEvents.bind(this))})),this._initLocalTrackEvents(u),this._localAudioTrack=u,this._localAudioTrack.setVolume(this._localAudioVolume);const{frameSize:m,callback:p}=this._ctx._localAudioTrackDumpConfig[$u.STREAM_INDEX_MAIN];m&&p&&this._localAudioTrack.setDataFetcher(m,p),this._tempMixingAudioTrack&&(this._localAudioTrack.mixType=this._tempMixingAudioTrack.type,this._localAudioTrack.mixedAudioTrack=this._tempMixingAudioTrack.track,delete this._tempMixingAudioTrack);let v=h.originTrack;c=v.getSettings();const f={width:c.width||0,height:c.height||0};if(this._localVideoTrack.resolution=f,this._ctx.videoProfile.__autoResetVideoEncoderConfig(c),setTimeout((()=>this.safeEmit(xh.onLocalVideoSizeChanged,{streamIndex:$u.STREAM_INDEX_MAIN,info:f}))),v=u.originTrack,l=v.getSettings(),this._ctx.engineDestroyed)return this._destroyLocalTrack(),{audioTrackSettings:l,videoTrackSettings:c};if(this._wtnStreamManager._updatePushTrack(),!this._room)return{audioTrackSettings:l,videoTrackSettings:c};const{isAutoPublish:S}=this._room.config;return(null!==(i=this._room.localStream)&&void 0!==i&&i.pubVideo||null!==(o=this._room.localStream)&&void 0!==o&&o.pubAudio||S)&&this._ctx.visibility&&this._updatePublish(),null===(r=this._room.localStream)||void 0===r||null===(r=r.observer)||void 0===r||r.setEnableVideo(!0),null===(s=this._room.localStream)||void 0===s||null===(s=s.observer)||void 0===s||s.setEnableAudio(!0),{audioTrackSettings:l,videoTrackSettings:c}}async startVideoAndAudioCapture(e,t){return this.startAudioAndVideoCapture(t,e)}getAudioMixingManager(){return this.logger.info("getAudioMixingManager()","invoke"),this._audioMixingManager||(this._audioMixingManager=new nU({getLocalAudioTrack:()=>this._localAudioTrack,updateLocalAudioTrack:this._updateMixAudioTrack,emitMessage:this._onAudioMixingMessage,onAutoPlayFailed:this._onAudioMixingAutoplayFailed},this.id)),this._audioMixingManager}getWTNStreamManager(){return this._wtnStreamManager}getCallId(){var e;return null===(e=this._ctx)||void 0===e?void 0:e.callId}async startScreenCapture(){var e,t,i;let o=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(this.logger.info("startScreenCapture()","config: %o",o),this._trackSourceType.screenVideo===Hu.VIDEO_SOURCE_TYPE_EXTERNAL)throw new Cg(Eg.STREAM_TYPE_NOT_MATCH,"setVideoSourceType as internal first");if(this._trackSourceType.screenAudio===Yu.AUDIO_SOURCE_TYPE_EXTERNAL)throw new Cg(Eg.STREAM_TYPE_NOT_MATCH,"setAudioSourceType as internal first");const[r,s]=await SN(this._ctx,o);null==s||s.setVolume(this._localScreenAudioVolume),this._localScreenVideoTrack&&!this._localScreenVideoTrack.dummy&&(this._removeLocalTrackEvents(this._localScreenVideoTrack),this._localScreenVideoTrack.destroy()),null===(e=this._localScreenAudioTrack)||void 0===e||e.destroy(),delete this._localScreenAudioTrack,this._localScreenVideoTrack=r;const{contentHint:n}=this._ctx.videoProfile.getScreenEncodeConfig();n&&r.setContentHint(n);const a=r.originTrack;setTimeout((()=>{const e=a.getSettings(),t={width:e.width,height:e.height};r.resolution=t,this.safeEmit(xh.onLocalVideoSizeChanged,{streamIndex:$u.STREAM_INDEX_SCREEN,info:{width:e.width,height:e.height}})}),500),s&&(this._localScreenAudioTrack=s,this._initLocalTrackEvents(s));this._localVideoPlayerConfig[$u.STREAM_INDEX_SCREEN].forEach((e=>{var t,i;null===(t=this._localScreenVideoTrack)||void 0===t||t.setPlayer(e,sh.MIRROR_TYPE_NONE,null===(i=this._config)||void 0===i?void 0:i.autoPlayPolicy,this._initPlayerEvents.bind(this))})),this._initLocalTrackEvents(this._localScreenVideoTrack,!0),(null!==(t=this._room)&&void 0!==t&&null!==(t=t.localScreenStream)&&void 0!==t&&t.pubAudio||null!==(i=this._room)&&void 0!==i&&null!==(i=i.localScreenStream)&&void 0!==i&&i.pubVideo)&&await this._updateScreenPublish()}async stopScreenCapture(){var e,t,i,o;this.logger.info("stopScreenCapture()"),null===(e=this._localScreenVideoTrack)||void 0===e||e.stopAll(),this._localScreenVideoTrack&&(this._localScreenVideoTrack.dummy||(this._removeLocalTrackEvents(this._localScreenVideoTrack),this._localScreenVideoTrack.destroy(),this._localImgScreenTrack&&this._localScreenVideoTrack.setTrack(this._localImgScreenTrack,{isDummy:!0}))),this._localScreenAudioTrack&&(this._removeLocalTrackEvents(this._localScreenAudioTrack),this._localScreenAudioTrack.destroy()),this._localScreenAudioTrack=void 0,null!==(t=this._localScreenVideoTrack)&&void 0!==t&&t.dummy||(this._localScreenVideoTrack=void 0),(null!==(i=this._room)&&void 0!==i&&null!==(i=i.localScreenStream)&&void 0!==i&&i.pubAudio||null!==(o=this._room)&&void 0!==o&&null!==(o=o.localScreenStream)&&void 0!==o&&o.pubVideo)&&await this._updateScreenPublish()}setLocalVideoPlayer(e,t){var i;this.logger.info("setLocalVideoPlayer()","streamIndex: %o, videoPlayerOption: %o",e,t),wg(e,"streamIndex",[$u.STREAM_INDEX_MAIN,$u.STREAM_INDEX_SCREEN]);const o=e===$u.STREAM_INDEX_MAIN?this._localVideoTrack:this._localScreenVideoTrack,r=null!==(i=null==t?void 0:t.playerId)&&void 0!==i?i:QP;if(null==t||!t.renderDom){var s,n;null===(s=this._localVideoPlayerConfig[e].get(r))||void 0===s||null===(s=s.player)||void 0===s||s.destroy();const t=null===(n=this._localVideoPlayerConfig[e].get(r))||void 0===n?void 0:n.renderDom;return this._containerCollisionDetector.unregisterContainer(t),void this._localVideoPlayerConfig[e].delete(r)}Wg(t);const a=this._localVideoPlayerConfig[e].get(r);if(!a){var d,c,l;const{renderDom:i}=t;if(!this._containerCollisionDetector.registerContainer(i))return this.monitor.report("rtc_error",{message:"RenderDom is not empty",error_code:JP.DUPLICATE_DOM}),void cb("renderDom is not empty");const s=new rN(this._ctx.id,r,Fu(Fu({},t),{},{isLocal:!0,isScreen:e===$u.STREAM_INDEX_SCREEN,userId:null!==(d=t.userId)&&void 0!==d?d:"_local_"})),n=Fu(Fu({},t),{},{player:s});return this._localVideoPlayerConfig[e].set(r,n),null==o||o.setPlayer(n,e===$u.STREAM_INDEX_MAIN?this._mirrorType:sh.MIRROR_TYPE_NONE,null===(c=this._config)||void 0===c?void 0:c.autoPlayPolicy,this._initPlayerEvents.bind(this)),null===(l=n.player)||void 0===l?void 0:l.domElement}void 0!==t.renderMode&&(null==o||o.setRenderMode(r,t.renderMode),a.renderMode=t.renderMode)}async startLiveTranscoding(e){var t;this.logger.info("startLiveTranscoding()","transcode: %o",e),OU.checkStartParams(e),this._liveTranscodeConfig=e;const i=null===(t=this._room)||void 0===t?void 0:t.config;if(i&&i.roomId.length+i.userId.length>126)throw new Cg(Eg.INVALID_PARAMS,"The roomId+userId must be within 126 bytes");try{this.safeEmit(xh.onStreamMixingEvent,{event:ON.START,error:0,message:""}),this._room&&this._ctx.signalingManager.isConnected()&&await this._room.liveControlMessage(OU.getStartParams(this._liveTranscodeConfig))}catch(wZ){throw wZ instanceof Cg?wZ:new Cg(Eg.UNEXPECTED_ERROR,"unexpected error",wZ)}}async updateLiveTranscoding(e){var t,i;if(this.logger.info("updateLiveTranscoding()","transcode: %o",e),!this._liveTranscodeConfig)return;const o=BN({},e);delete o.audio,null===(t=o.video)||void 0===t||delete t.codec,null===(i=o.video)||void 0===i||delete i.gop,OU.checkUpdateParams(o),this._liveTranscodeConfig=BN(this._liveTranscodeConfig,o);try{var r;this.safeEmit(xh.onStreamMixingEvent,{event:ON.UPDATE,error:0,message:""}),await(null===(r=this._room)||void 0===r?void 0:r.liveControlMessage(OU.getUpdateParams(this._liveTranscodeConfig)))}catch(wZ){throw wZ instanceof Cg?wZ:new Cg(Eg.UNEXPECTED_ERROR,"unexpected error",wZ)}}async stopLiveTranscoding(){if(this.logger.info("stopLiveTranscoding()"),this._liveTranscodeConfig){delete this._liveTranscodeConfig;try{var e;this.safeEmit(xh.onStreamMixingEvent,{event:ON.STOP,error:0,message:""}),await(null===(e=this._room)||void 0===e?void 0:e.liveControlMessage({action:"stopped",type:"transcode"}))}catch(wZ){throw wZ instanceof Cg?wZ:new Cg(Eg.UNEXPECTED_ERROR,"unexpected error",wZ)}}}async startSubtitle(e){var t;this.logger.info("startSubtitle()","config: %o",e),this._assertNotInRoom(),await(null===(t=this._room)||void 0===t?void 0:t.startSubtitle(e))}async updateSubtitleConfig(e){var t;this.logger.info("updateSubtitleConfig()","config: %o",e),this._assertNotInRoom(),await(null===(t=this._room)||void 0===t?void 0:t.updateSubtitleConfig(e))}stopSubtitle(){var e;this.logger.info("stopSubtitle()","invoke"),null===(e=this._room)||void 0===e||e.stopSubtitle()}setBusinessId(e){return this.logger.info("setBusinessId()","businessId: %s",e),!function(e){return"string"!=typeof e}(e)&&!this._room&&(this._ctx.businessId=e,!0)}async setUserVisibility(e){var t;if(this.logger.info("setUserVisibility()","enable: %o",e),e=!!e,this._ctx.visibility!==e)if(this._room){var i;if(this._assertNotInRoom(),this._room.localStream)null===(i=this._room.localStream.observer)||void 0===i||i.setPublisher(e);if(!e){const e=await this._pubLock.lock();try{this._room.unpublish(),this._room.unpublishScreen()}finally{e()}}this._ctx.visibility=e;try{await this._room.updateUserAttributes()}catch(o){throw this._ctx.visibility=!e,o}e&&null!==(t=this._room)&&void 0!==t&&t.config.isAutoPublish&&this._updatePublish({mediaType:eh.AUDIO_AND_VIDEO})}else this._ctx.visibility=e}_initPlayerEvents(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const i=(arguments.length>2&&void 0!==arguments[2]?arguments[2]:$u.STREAM_INDEX_MAIN)===$u.STREAM_INDEX_SCREEN;e.on("playback_event",(o=>{switch(o.eventName){case"timeupdate":if(!e.hasStartPlaying&&e instanceof sN){var r;e.hasStartPlaying=!0;const t=e.userId.replace("_screen",""),o=null===(r=this._room)||void 0===r||null===(r=r.remoteStreams.get(t))||void 0===r?void 0:r.find((e=>e.isScreen===i));setTimeout((()=>{var e;const t={is_screen:i,media_type:"audio",codec:null==o||null===(e=o.getRemoteStreamStats())||void 0===e||null===(e=e.audioStats)||void 0===e?void 0:e.codecType};this.logger.info("remote_audio_playing",JSON.stringify(t)),this.monitor.report("remote_audio_playing",t)}),8e3)}return;case"loadeddata":if("audio"===o.type){var s;const o=e.userId.replace("_screen",""),r=null===(s=this._room)||void 0===s||null===(s=s.remoteStreams.get(o))||void 0===s?void 0:s.find((e=>e.isScreen===i)),n=()=>{t?this.safeEmit(xh.onFirstPublicStreamAudioFrameDecoded,{publicStreamId:o}):(this.safeEmit(xh.onAudioFirstFrameDecoded,{userId:o,isScreen:i}),this.safeEmit(xh.onRemoteAudioFirstFrame,{userId:o,isScreen:i})),this.monitor.report("first_remote_audio_render",{stream_id:"",stream_user_id:o||""},{isScreen:i})};null==r||!r.observer||r.observer.audioFirstFrameReceived?n():r.observer.once("recvAudioFirstFrame",n)}else{var n,a;const r={userId:e.userId,height:(null===(n=e.domElement)||void 0===n?void 0:n.videoHeight)||0,width:(null===(a=e.domElement)||void 0===a?void 0:a.videoWidth)||0,isScreen:i,playerId:e.playerId};t?(r.publicStreamId=r.userId,delete r.userId,delete r.isScreen,this.safeEmit(xh.onFirstPublicStreamVideoFrameRendered,r),this.safeEmit(xh.onFirstPublicStreamVideoFrameDecoded,r)):e.isLocal||(this.safeEmit(xh.onVideoFirstFrameRendered,r),this.safeEmit(xh.onVideoFirstFrameDecoded,r),this.safeEmit(xh.onRemoteVideoFirstFrame,r)),this.monitor.report("first_remote_video_render",{stream_id:"",stream_user_id:o.userId||""},{isScreen:i})}break;case"autoplay-error":{t&&(o.publicStreamId=o.userId),fS(this.id,"autoplay-error",e instanceof rN?"video":"audio",0,o.userId||"");const i={userId:o.userId,kind:e instanceof rN?"video":"audio",mediaType:e instanceof rN?eh.VIDEO:eh.AUDIO,streamIndex:e.isScreen?$u.STREAM_INDEX_SCREEN:$u.STREAM_INDEX_MAIN};return e instanceof rN&&(i.playerId=e.playerId===QP?void 0:e.playerId),void this.safeEmit(xh.onAutoplayFailed,i)}case"playing":{var d;const t=e.userId.replace("_screen",""),r=null===(d=this._room)||void 0===d||null===(d=d.remoteStreams.get(t))||void 0===d?void 0:d.find((e=>e.isScreen===i));"audio"===o.type?setTimeout((()=>{var e;const t={is_screen:i,media_type:"audio",codec:null==r||null===(e=r.getRemoteStreamStats())||void 0===e||null===(e=e.audioStats)||void 0===e?void 0:e.codecType};this.logger.info("remote_audio_playing",JSON.stringify(t)),this.monitor.report("remote_audio_playing",t)}),8e3):setTimeout((()=>{var e,t,o,s,n,a,d,c,l,u;const h={is_screen:i,media_type:"video",codec:null==r||null===(e=r.getRemoteStreamStats())||void 0===e||null===(e=e.videoStats)||void 0===e?void 0:e.codecType,stats_frame_size_width:null==r||null===(t=r.getRemoteStreamStats())||void 0===t||null===(t=t.videoStats)||void 0===t?void 0:t.frameSizeWidth,stats_frame_size_height:null==r||null===(o=r.getRemoteStreamStats())||void 0===o||null===(o=o.videoStats)||void 0===o?void 0:o.frameSizeHeight,stats_frame_rate_decode:null==r||null===(s=r.getRemoteStreamStats())||void 0===s||null===(s=s.videoStats)||void 0===s?void 0:s.decoderOutputFrameRate,stats_frame_rate_receive:null==r||null===(n=r.getRemoteStreamStats())||void 0===n||null===(n=n.videoStats)||void 0===n?void 0:n.receivedFrameRate,stats_frame_decoder_name:null==r||null===(a=r.getRemoteStreamStats())||void 0===a||null===(a=a.videoStats)||void 0===a?void 0:a.decoderName,stats_gpu_url:jg.GPU_URL||(null===(d=fb())||void 0===d?void 0:d.renderer),track_frame_size_width:null==r||null===(c=r.videoTrack)||void 0===c||null===(c=c.originTrack)||void 0===c?void 0:c.getSettings().width,track_frame_size_height:null==r||null===(l=r.videoTrack)||void 0===l||null===(l=l.originTrack)||void 0===l?void 0:l.getSettings().height,track_frame_rate:null==r||null===(u=r.videoTrack)||void 0===u||null===(u=u.originTrack)||void 0===u?void 0:u.getSettings().frameRate};this.logger.info("remote_video_playing",JSON.stringify(h)),this.monitor.report("remote_video_playing",h)}),8e3);break}}e instanceof rN&&(o.playerId=e.playerId===QP?void 0:e.playerId),this.safeEmit(xh.onPlayerEvent,o)}))}_initLocalTrackEvents(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];["track-ended","track-mute","track-unmute"].forEach((t=>{e.on(t,(async e=>{this.monitor.report("rtc_error",{message:"track-".concat(t," mediaType: ").concat(e.originTrack.kind),error_code:JP.TRACK_ERROR,capture_session_id:e.captureSessionId,media_type:t,reason:t});let i=!1;e!==this._localScreenAudioTrack&&e!==this._localScreenVideoTrack||(i=!0);const{kind:o}=e.originTrack;this.safeEmit({"track-ended":xh.onTrackEnded,"track-mute":xh.onTrackMute,"track-unmute":xh.onTrackUnmute}[t],{kind:o,isScreen:i}),(qS||JS)&&("track-mute"===t&&(WP.emit(UP.ON_IOS_LOCAL_TRACK_MUTE,o),"audio"===o&&(await this.stopAudioCapture(),this.startAudioCapture())),"track-unmute"===t&&WP.emit(UP.ON_IOS_LOCAL_TRACK_UNMUTE,o))}))})),e.on("resolution-change",(e=>{this._ctx.extensionManager.getPluginsByType(LP.PRE_PROCESSING).forEach((i=>{var o;null==i||null===(o=i.applyConstraints)||void 0===o||o.call(i,t?$u.STREAM_INDEX_SCREEN:$u.STREAM_INDEX_MAIN,e)})),this.safeEmit(xh.onLocalVideoSizeChanged,{streamIndex:t?$u.STREAM_INDEX_SCREEN:$u.STREAM_INDEX_MAIN,info:e})})),e.on("needReplaceTrack",(()=>{if(e instanceof aN){var t,i;e.stopDataFetcher();const s=this._ctx._localAudioTrackDumpConfig[null!==(t=e.streamIndex)&&void 0!==t?t:$u.STREAM_INDEX_MAIN];null!=s&&s.frameSize&&null!=s&&s.callback&&e.setDataFetcher(s.frameSize,s.callback);const{position:n,volume:a}=this._ctx.earMonitorSettings[null!==(i=e.streamIndex)&&void 0!==i?i:$u.STREAM_INDEX_MAIN];if(n!==Ah.NONE&&(e.play(n),e.setPlaybackVolume(a)),this._room){const{streamIndex:t}=e;var o,r;if(t===$u.STREAM_INDEX_MAIN)null!==(o=this._room.localStream)&&void 0!==o&&o.pubAudio&&this._ctx.visibility&&this._updatePublish();else null!==(r=this._room.localStream)&&void 0!==r&&r.pubAudio&&this._ctx.visibility&&this._updateScreenPublish()}}})),e.on("autoplay-error",(e=>{this.safeEmit(xh.onAutoplayFailed,e)}))}_removeLocalTrackEvents(e){e.removeAllListeners("track-ended"),e.removeAllListeners("track-mute"),e.removeAllListeners("track-unmute"),e.removeAllListeners("resolution-change")}setRemoteVideoPlayer(e,t){var i,o,r,s,n,a;this.logger.info("setRemoteVideoPlayer()","streamIndex: %o, videoPlayerOption: %o",e,t),wg(e,"streamIndex",[$u.STREAM_INDEX_MAIN,$u.STREAM_INDEX_SCREEN]),Wg(t);const{userId:d}=t,c=e===$u.STREAM_INDEX_SCREEN,l=null===(i=this._room)||void 0===i||null===(i=i.remoteStreams.get(d))||void 0===i?void 0:i.find((e=>e.isScreen===c)),u=null==l?void 0:l.videoTrack,h=null!==(o=t.playerId)&&void 0!==o?o:QP;null===(r=this._getRemoteVideoPlayerConfig(e,d,h))||void 0===r||null===(r=r.player)||void 0===r||r.destroy();const _=null===(s=this._getRemoteVideoPlayerConfig(e,d,h))||void 0===s?void 0:s.renderDom;var m;if(this._containerCollisionDetector.unregisterContainer(_),!t.renderDom)return void(null===(m=this._remoteVideoPlayerConfig[e].get(d))||void 0===m||m.delete(h));const{renderDom:p}=t;if(!this._containerCollisionDetector.registerContainer(p))return this.monitor.report("rtc_error",{message:"RenderDom is not empty",error_code:JP.DUPLICATE_DOM}),void cb("renderDom is not empty");const v=new rN(this.id,h,Fu(Fu({},t),{},{isLocal:!1,isScreen:c,userId:d})),f=Fu(Fu({},t),{},{player:v});return this._setRemoteVideoPlayerConfig(e,d,h,f),null==u||u.setPlayer(this.id,f,null===(n=this._config)||void 0===n?void 0:n.autoPlayPolicy,this._initPlayerEvents.bind(this)),l&&this._updateVideoPlayerState(l),null===(a=f.player)||void 0===a?void 0:a.domElement}setLocalVideoMirrorType(e){var t;this.logger.info("setLocalVideoMirrorType()","mirrorType: %o",e),wg(e,"mirrorType",[sh.MIRROR_TYPE_NONE,sh.MIRROR_TYPE_RENDER]),this._mirrorType=e,null===(t=this.localVideoTrack)||void 0===t||t.mirror(!!e)}setRemoteVideoMirrorType(e,t,i){var o;this.logger.info("setRemoteVideoMirrorType()","userId: %s, streamIndex: %o, mirrorType: %o",e,t,i),Ug(e),wg(t,"streamIndex",[$u.STREAM_INDEX_MAIN,$u.STREAM_INDEX_SCREEN]),wg(i,"mirrorType",[sh.MIRROR_TYPE_NONE,sh.MIRROR_TYPE_RENDER]),this._ctx.setUserStreamConf(e,t,{mirrorType:i}),null===(o=this._room)||void 0===o||null===(o=o.remoteStreams.get(e))||void 0===o||null===(o=o.find((e=>e.isScreen===(t===$u.STREAM_INDEX_SCREEN))))||void 0===o||null===(o=o.videoTrack)||void 0===o||o.mirror(!!i)}async setAudioPlaybackDevice(e){var t;this.logger.info("setAudioPlaybackDevice()","deviceId: %s",e),Ng(e,"deviceId");const i=await this._audioDeviceManager.setSinkId(e);null===(t=this._room)||void 0===t||t.remoteStreams.forEach((t=>{t.forEach((t=>{var i;null===(i=t.audioTrack)||void 0===i||i.setPlaybackDevice(e)}))})),this.safeEmit(xh.onAudioPlaybackDeviceChanged,i),this.monitor.report("rtc_audio_device",{audio_event:"playout_device_switch",message:JSON.stringify(i),error_code:0})}async play(e){var t;let i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:eh.AUDIO_AND_VIDEO,o=arguments.length>2?arguments[2]:void 0,r=arguments.length>3?arguments[3]:void 0;this.logger.info("play()","userId: %s, mediaType: %s, streamIndex: %s",e,i,o);const s=null!=r?r:QP,n=!e||e===this._getUserId()||"local_user"===e,a=void 0===o||o===$u.STREAM_INDEX_MAIN,d=void 0===o||o===$u.STREAM_INDEX_SCREEN,c=i!==eh.VIDEO,l=i!==eh.AUDIO,u=[];if(n&&l){if(a&&this._localVideoTrack){this._localVideoTrack.mirror(!!this._mirrorType);const e=this._localVideoTrack.play(s);e&&u.push(e)}if(d&&this._localScreenVideoTrack){var h;(null===(h=this._localScreenVideoTrack)||void 0===h?void 0:h.manuallyPlay(s))&&u.push()}}this._audioMixingManager&&e===this._audioMixingManager.id&&u.push(this._audioMixingManager.resumeLocalPlay());let _=[];var m;(null===(t=this._room)||void 0===t||t.remoteStreams.forEach(((t,i)=>{e&&e!==i||t.forEach((e=>{e.audioTrack&&_.push(e.audioTrack),e.videoTrack&&_.push(e.videoTrack)}))})),this._wtnStreamManager.__getRemoteStreams().forEach(((t,i)=>{e&&e!==i||(t.audioTrack&&_.push(t.audioTrack),t.videoTrack&&_.push(t.videoTrack))})),a||(_=_.filter((e=>!!e.isScreen))),d||(_=_.filter((e=>!e.isScreen))),c||(_=_.filter((e=>"audio"!==e.mediaType))),l||(_=_.filter((e=>"video"!==e.mediaType))),c)&&(null===(m=this._room)||void 0===m||m.virtualStreams.forEach((e=>{e.audioTrack&&_.push(e.audioTrack)})));return _.forEach((e=>{const t=e.manuallyPlay(s);t&&u.push(t)})),Promise.all(u).then((()=>{}))}async stop(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:eh.AUDIO_AND_VIDEO,i=arguments.length>2?arguments[2]:void 0,o=arguments.length>3?arguments[3]:void 0;this.logger.info("stop()","userId: %s, mediaType: %s, streamIndex: %s, playerId: %s",e,t,i,o);const r=null!=o?o:QP,s=!e||e===this._getUserId()||"local_user"===e,n=void 0===i||i===$u.STREAM_INDEX_MAIN,a=void 0===i||i===$u.STREAM_INDEX_SCREEN,d=t!==eh.VIDEO,c=t!==eh.AUDIO;if(s&&c&&(n&&this._localVideoTrack&&this._localVideoTrack.pause(r),a&&this._localScreenVideoTrack&&this._localScreenVideoTrack.pause(r)),e){var l;let t=[];null===(l=this._room)||void 0===l||null===(l=l.remoteStreams.get(e))||void 0===l||l.forEach((e=>{e.audioTrack&&t.push(e.audioTrack),e.videoTrack&&t.push(e.videoTrack)}));const i=this._wtnStreamManager.__getPublicStreamTrack(e,"audio"),o=this._wtnStreamManager.__getPublicStreamTrack(e,"video");i&&t.push(i),o&&t.push(o),n||(t=t.filter((e=>!!e.isScreen))),a||(t=t.filter((e=>!e.isScreen))),d||(t=t.filter((e=>"audio"!==e.mediaType))),c||(t=t.filter((e=>"video"!==e.mediaType))),t.forEach((e=>{e.pause(r)}))}}getAudioVolume(e,t){wg(e,"streamIndex",[$u.STREAM_INDEX_MAIN,$u.STREAM_INDEX_SCREEN]);let i=0;if(t){var o;const r=null===(o=this._room)||void 0===o||null===(o=o.remoteStreams.get(t))||void 0===o||null===(o=o.find((t=>t.isScreen===(e===$u.STREAM_INDEX_SCREEN))))||void 0===o?void 0:o.audioTrack;r&&(i=r.getAudioLevel())}else{const t=e===$u.STREAM_INDEX_MAIN?this._localAudioTrack:this._localScreenAudioTrack;t&&(i=t.getAudioLevel())}return{linearVolume:i,nonlinearVolume:ob(i)}}setAudioFrameCallback(e,t,i){var o;let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:4096;if(this.logger.info("setAudioFrameCallback()","streamIndex: %s, userId: %s, callback: %s, frameSize: %s",e,t,i?"true":"false",r),wg(r,"frameSize",[256,512,1024,2048,4096,8192,16384]),void 0===YP.isWorkletReady&&YP.getAudioContextInstance(),null===YP.isWorkletReady)throw this.logger.error("setAudioFrameCallback()","Not support AudioWorklet"),new Cg(Eg.NOT_SUPPORTED,"Not support AudioWorklet");t?i?this._ctx._remoteAudioTrackDumpConfig[e].set(t,{callback:i,frameSize:r}):this._ctx._remoteAudioTrackDumpConfig[e].delete(t):this._ctx._localAudioTrackDumpConfig[e]={callback:i,frameSize:i?r:void 0};const s=t?null===(o=this._room)||void 0===o||null===(o=o.remoteStreams.get(t))||void 0===o||null===(o=o.find((t=>t.isScreen===(e===$u.STREAM_INDEX_SCREEN))))||void 0===o?void 0:o.audioTrack:e===$u.STREAM_INDEX_MAIN?this._localAudioTrack:this._localScreenAudioTrack;s?i?s.setDataFetcher(r,i):s.stopDataFetcher():this.logger.warn("setAudioFrameCallback()","track not found")}async pauseAllSubscribedStream(e){this.logger.info("pauseAllSubscribedStream()","mediaType: %o",e),this._checkMediaType(e);return(()=>{rb(e)&&(this._pauseAllSubscribeState.audio=!0),sb(e)&&(this._pauseAllSubscribeState.video=!0)})(),this._room?this._pauseAllRemoteStreams(e):Promise.resolve()}async _pauseAllRemoteStreams(e){if(!this._room)return Promise.resolve();const t=[];return this._room.remoteStreams.forEach((i=>{Array.isArray(i)&&i.forEach((i=>{if(i.hasSubscribed){i.attributes.audiostream&&rb(e)&&(this._pauseAllSubscribeState.resumeAudioStreamIds[i.streamId]=i.streamId),i.attributes.videostream&&sb(e)&&(this._pauseAllSubscribeState.resumeVideoStreamIds[i.streamId]=i.streamId);const o=this._unsubscribe(i.isScreen,i.userId,e,!0);o&&t.push(o)}}))})),Promise.all(t).then((()=>{}))}async resumeAllSubscribedStream(e){this.logger.info("resumeAllSubscribedStream()","mediaType: %o",e),this._checkMediaType(e);if((()=>{rb(e)&&(this._pauseAllSubscribeState.audio=!1),sb(e)&&(this._pauseAllSubscribeState.video=!1)})(),!this._room)return Promise.resolve();await this._triedResumeAllRemoteStreams(e,!1)}async _triedResumeAllRemoteStreams(e,t){if(!this._room)return Promise.resolve();if(this._pauseAllSubscribeState.audio&&e===eh.AUDIO)return Promise.resolve();if(this._pauseAllSubscribeState.video&&e===eh.VIDEO)return Promise.resolve();if(this._pauseAllSubscribeState.video&&this._pauseAllSubscribeState.audio&&e===eh.AUDIO_AND_VIDEO)return Promise.resolve();const i=[],o=[...Object.keys(this._pauseAllSubscribeState.resumeAudioStreamIds)],r=[...Object.keys(this._pauseAllSubscribeState.resumeVideoStreamIds)];return this._room.remoteStreams.forEach((o=>{Array.isArray(o)&&o.forEach((o=>{if(t&&o.isScreen)return;const r=this._pauseAllSubscribeState.resumeAudioStreamIds[o.streamId],s=this._pauseAllSubscribeState.resumeVideoStreamIds[o.streamId];if(r&&rb(e)||s&&sb(e)){const t=this._subscribe(o.isScreen,o.userId,e).then((()=>{r&&rb(e)&&delete this._pauseAllSubscribeState.resumeAudioStreamIds[o.streamId],s&&sb(e)&&delete this._pauseAllSubscribeState.resumeVideoStreamIds[o.streamId]}));t&&i.push(t)}}))})),Promise.all(i).then((()=>{var e;return null===(e=this._room)||void 0===e||e.remoteStreams.forEach((e=>{Array.isArray(e)&&e.forEach((e=>{this._updateAudioPlayerState(e),this._updateVideoPlayerState(e)}))})),Promise.resolve()})).finally((()=>{var e;return null!==(e=this._room)&&void 0!==e&&e.config.tokenSubscribePrivilegeExpired&&(o.forEach((e=>{this._pauseAllSubscribeState.resumeAudioStreamIds[e]=e})),r.forEach((e=>{this._pauseAllSubscribeState.resumeVideoStreamIds[e]=e}))),Promise.resolve()}))}async sendUserMessage(e,t){var i;Ug(e),this._assertNotInRoom();const o=Date.now();return null===(i=this._room)||void 0===i||null===(i=i.sendUserMessage(e,t))||void 0===i?void 0:i.then((t=>(this._messageStatisticsObserver.countP2PMessage(!0,e,!1,o,t),t.id))).catch((t=>{throw this._messageStatisticsObserver.countP2PMessage(!1,e,!1,o,t),t}))}async sendUserBinaryMessage(e,t){var i;Ug(e),Lg(t,"message"),this._assertNotInRoom();const o=Date.now();return null===(i=this._room)||void 0===i||null===(i=i.sendUserMessage(e,t))||void 0===i?void 0:i.then((t=>(this._messageStatisticsObserver.countP2PMessage(!0,e,!0,o,t),t.id))).catch((t=>{throw this._messageStatisticsObserver.countP2PMessage(!1,e,!0,o,t),t}))}async sendRoomMessage(e){var t,i;this._assertNotInRoom();const o=null===(t=this._room)||void 0===t?void 0:t.config.roomId,r=Date.now();return null===(i=this._room)||void 0===i||null===(i=i.sendRoomMessage(e))||void 0===i?void 0:i.then((e=>(this._messageStatisticsObserver.countRoomMessage(!0,o,!1,r),e))).catch((e=>{throw this._messageStatisticsObserver.countRoomMessage(!1,o,!1,r),e}))}async sendRoomBinaryMessage(e){var t,i;this._assertNotInRoom();const o=null===(t=this._room)||void 0===t?void 0:t.config.roomId,r=Date.now();return null===(i=this._room)||void 0===i||null===(i=i.sendRoomMessage(e,!0))||void 0===i?void 0:i.then((e=>(this._messageStatisticsObserver.countRoomMessage(!0,o,!0,r),e))).catch((e=>{throw this._messageStatisticsObserver.countRoomMessage(!1,o,!0,r),e}))}async setAudioCaptureConfig(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.logger.info("setAudioCaptureConfig()","config: %o",e),delete e.deviceId,xg(e);await this._shouldUpdateAudioConf("setAudioCaptureConfig")&&this._ctx.audioProfileManager.updateConstraints(e)}async setVideoCaptureConfig(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this.logger.info("setVideoCaptureConfig()","config: %o",e),this._setVideoCaptureConfig(e)}async _setVideoCaptureConfig(){var e;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};delete t.deviceId,xg(t);const i=Fu(Fu({},this._ctx.videoProfile.getCaptureConfig()),t);return this._localVideoTrack&&await this._localVideoTrack.updateVideoCaptureConfig(i),this._ctx.videoProfile.setCaptureConfig(i),(null===(e=this._localVideoTrack)||void 0===e?void 0:e.originTrack.getSettings())||{}}enableSimulcastMode(e){this.logger.info("enableSimulcastMode()","enabled: %o",e),this._ctx.videoProfile.checkSimulcastApiVersion("old");try{return this._ctx.videoProfile.setSimulcastMode(e?Ch.VIDEO_ON_DEMAND:Ch.VIDEO_ONLY_ONE,this._room),!0}catch(t){return!1}}async setLocalSimulcastMode(e,t){var i;this.logger.info("setLocalSimulcastMode()","mode: %o, config: %o",e,t),this._ctx.videoProfile.checkSimulcastApiVersion("new"),await this._ctx.videoProfile.setSimulcastMode(e,this._room),await this._ctx.videoProfile.setSubVideoEncodeConfig(t,this._room,this._localVideoTrack);await(null===(i=this._room)||void 0===i?void 0:i.hasPublished())&&this._updatePublish()}async setVideoEncoderConfig(e){var t;if(this.logger.info("setVideoEncoderConfig()","descriptions: %o",e),await this._ctx.videoProfile.setVideoEncodeConfigPolyfill(e),this._localVideoTrack){const e=this._ctx.videoProfile.getContentHint();e&&this._localVideoTrack.setContentHint(e),await this._localVideoTrack.updateVideoCaptureConfig(this._ctx.videoProfile.getCaptureConfig())}this._updateDummyCaptureImage($u.STREAM_INDEX_MAIN);await(null===(t=this._room)||void 0===t?void 0:t.hasPublished())&&this._updatePublish()}setVideoEncoderAutoConfigList(e){if(Array.isArray(e))return TI(e).call(e,((e,t)=>e.maxKbps-t.maxKbps)),ey(e)}async setScreenEncoderConfig(e){var t;this.logger.info("setScreenEncoderConfig()","description: %o",e),this._ctx.videoProfile.setScreenEncodeConfig(e),this._localScreenVideoTrack&&("16.1"!==cg&&await this._localScreenVideoTrack.updateVideoCaptureConfig(e),e.contentHint&&this._localScreenVideoTrack.setContentHint(e.contentHint)),this._updateDummyCaptureImage($u.STREAM_INDEX_SCREEN);await(null===(t=this._room)||void 0===t?void 0:t.hasScreenPublished())&&this._updateScreenPublish()}sendSEIMessage(e,t,i){if(this.logger.info("sendSEIMessage()","streamIdex: %o, message: %o, repeatCount: %o",e,t,i),!sE()&&!rE())return cb("Your browser does not support sending SEI"),!1;wg(e,"streamIndex",[$u.STREAM_INDEX_MAIN,$u.STREAM_INDEX_SCREEN]),Pg(i,"repeatCount",0,30);const o="string"==typeof t?new Uint8Array(Qy.str2ab(t)):t;if(!t.length)return this.logger.warn("sei message must not be empty"),!1;let r;if(e===$u.STREAM_INDEX_MAIN){var s,n;if(!(null!==(s=this._room)&&void 0!==s&&null!==(s=s.localStream)&&void 0!==s&&s.pubAudio||null!==(n=this._room)&&void 0!==n&&null!==(n=n.localStream)&&void 0!==n&&n.pubVideo))return;r=this._room.localStream}else{var a,d;if(!(null!==(a=this._room)&&void 0!==a&&null!==(a=a.localScreenStream)&&void 0!==a&&a.pubAudio||null!==(d=this._room)&&void 0!==d&&null!==(d=d.localScreenStream)&&void 0!==d&&d.pubVideo))return;r=this._room.localScreenStream}if(o.byteLength>4096)return void this.logger.warn("sei size must not bigger than 4KB");var c;$S||(null===(c=this._room)||void 0===c||c.maybeFillBackFrame2Stream(r));const l=Jy();return r.sendSEIMessage({content:o,uuid:l,repeatCount:i+1}),setTimeout((async()=>{if(!r)return;if(await r.revokeSEIMessage(l)){const e="timeout for sei message(id: ".concat(l,")");console.error("[RTC WebSDK] ".concat(e)),this.monitor.report("rtc_sdk_callback",{sdk_callback_name:"sendSEIMessageTimeout",message:e,error_code:400})}}),Qg("SEI_TIME_OUT")),l}setAudioVolumeIndicationInterval(e){this.logger.info("setAudioVolumeIndicationInterval()","interval %o: ",e),("number"!=typeof e||e<200)&&(e=200);let t=[];this._audioVolumeIndicationTimer&&clearInterval(this._audioVolumeIndicationTimer),this._audioVolumeIndicationTimer=setInterval((()=>{var e,i;t=[],null===(e=this._room)||void 0===e||e.remoteStreams.forEach(((e,i)=>{var o;if(0===e.length)return;const r=e.find((e=>!e.isScreen)),s=null==r||null===(o=r.audioTrack)||void 0===o?void 0:o.getAudioLevel();t.push({userId:i,volume:s||0})}));const o=null===(i=this._localAudioTrack)||void 0===i?void 0:i.getAudioLevel();t.push({userId:this._getUserId(),volume:o||0}),this.safeEmit(xh.onAudioVolumeIndication,{speakers:t})}),e)}_sendActiveSpeaker(e,t){if(this._room&&this._room.remoteUsers.size>=1){const i=e[0],o=t.reduce(((e,t)=>e&&e.audioPropertiesInfo.nonlinearVolume>t.audioPropertiesInfo.nonlinearVolume?e:t),void 0);let r;if(r=i?o?i.audioPropertiesInfo.nonlinearVolume>o.audioPropertiesInfo.nonlinearVolume?i:o:i:o,r&&r.audioPropertiesInfo.nonlinearVolume>-35){let e;e=r.streamKey?this._room.remoteUsers.get(r.streamKey.userId):this._room.config.userInfo,e&&this.safeEmit(xh.onActiveSpeaker,{userId:e.userId,extraInfo:e.extraInfo})}}}enableAudioPropertiesReport(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.logger.info("enableAudioPropertiesReport()","config %o: ",e);const{enableInBackground:t=!0,localMainReportMode:i=nh.NORMAL,audioReportMode:o=ah.MICROPHONE}=e;let{interval:r=100}=e;this._stopAudioPropertiesReport(),r<=0||(r=Math.max(100,r),this._audioPropertiesReportTimer=self.setInterval((()=>{if(!t&&"hidden"===document.visibilityState)return;const e=[],r=this._audioDeviceManager.getRecordTrack()||this._localAudioTrack;if(r){var s;const t=null===(s=this._room)||void 0===s||null===(s=s.localStream)||void 0===s?void 0:s.audioHasPublish,n=!!this._audioDeviceManager.getRecordTrack(),a=r.getAudioLevel(o),d=ob(a),c={streamIndex:$u.STREAM_INDEX_MAIN,audioPropertiesInfo:{linearVolume:a,nonlinearVolume:d}};if(t||n)e.push(c);else switch(i){case nh.DISCONNECT:break;case nh.RESET:c.audioPropertiesInfo.linearVolume=0,c.audioPropertiesInfo.nonlinearVolume=-127,e.push(c);break;case nh.NORMAL:e.push(c);break;default:throw new Cg(Eg.INVALID_PARAMS,"invalid localMainReportMode: ".concat(i," in config"))}}if(this._localScreenAudioTrack){const t=this._localScreenAudioTrack.getAudioLevel();e.push({streamIndex:$u.STREAM_INDEX_SCREEN,audioPropertiesInfo:{linearVolume:t,nonlinearVolume:ob(t)}})}if(this.safeEmit(xh.onLocalAudioPropertiesReport,e),this._room){const t=[];if(this._room.config.isMultiChatMode()){this._room.getActiveSpeakerInMultiChatMode().forEach((e=>{var i,o;const r=255*e.audioLevel;t.push({streamKey:{userId:e.userId,streamIndex:$u.STREAM_INDEX_MAIN,roomId:null!==(i=null===(o=this._room)||void 0===o?void 0:o.config.roomId)&&void 0!==i?i:""},audioPropertiesInfo:{linearVolume:r,nonlinearVolume:ob(r)}})}))}else this._room.remoteStreams.forEach(((e,i)=>{e.forEach((e=>{if(e.audioTrack){var o,r;const s=e.audioTrack.getAudioLevel();t.push({streamKey:{userId:i,streamIndex:e.isScreen?$u.STREAM_INDEX_SCREEN:$u.STREAM_INDEX_MAIN,roomId:null!==(o=null===(r=this._room)||void 0===r?void 0:r.config.roomId)&&void 0!==o?o:""},audioPropertiesInfo:{linearVolume:s,nonlinearVolume:ob(s)}})}}))}));this.safeEmit(xh.onRemoteAudioPropertiesReport,t),this._sendActiveSpeaker(e,t.filter((e=>e.streamKey.streamIndex!==$u.STREAM_INDEX_SCREEN)))}}),r))}async setVideoSourceType(e,t){this.logger.print("setVideoSourceType()","index: %o, videoSourceType: %o",e,t),wg(e,"streamIndex",[$u.STREAM_INDEX_MAIN,$u.STREAM_INDEX_SCREEN]),wg(t,"VideoSourceType",[Hu.VIDEO_SOURCE_TYPE_EXTERNAL,Hu.VIDEO_SOURCE_TYPE_INTERNAL]);const i=e===$u.STREAM_INDEX_MAIN?"video":"screenVideo";if(this._trackSourceType[i]!==t){if(this._trackSourceType[i]=t,this.logger.print("setVideoSourceType","set ".concat(i," source type to ").concat(t)),this._localVideoTrack&&e===$u.STREAM_INDEX_MAIN){var o,r,s;let e=!1;if(t===Hu.VIDEO_SOURCE_TYPE_EXTERNAL){e=!0;const t=this._ctx.extensionManager.getPluginByName(LP.PRE_PROCESSING,"RTCBeautyExtension");t&&t.emit("stop"),this._removeLocalTrackEvents(this._localVideoTrack),this._localVideoTrack.destroy()}null===(o=this._localVideoTrack)||void 0===o||o.destroy(),this._localVideoTrack=void 0;const i=null===(r=this._room)||void 0===r?void 0:r.config.isAutoPublish;var n,a;if(e)null===(n=this._room)||void 0===n||null===(n=n.localStream)||void 0===n||null===(n=n.observer)||void 0===n||n.setEnableVideo(!1);else null===(a=this._room)||void 0===a||null===(a=a.localStream)||void 0===a||null===(a=a.observer)||void 0===a||a.setPushVideo(!1);(null!==(s=this._room)&&void 0!==s&&null!==(s=s.localStream)&&void 0!==s&&s.pubVideo||i)&&await this._updatePublish()}if(this._localScreenVideoTrack&&e===$u.STREAM_INDEX_SCREEN){var d,c;let e=!1;var l,u;if(t===Hu.VIDEO_SOURCE_TYPE_EXTERNAL&&(e=!0,this._removeLocalTrackEvents(this._localScreenVideoTrack),this._localScreenVideoTrack.destroy()),null===(d=this._localScreenVideoTrack)||void 0===d||d.destroy(),this._localScreenVideoTrack=void 0,e)null===(l=this._room)||void 0===l||null===(l=l.localScreenStream)||void 0===l||null===(l=l.observer)||void 0===l||l.setEnableVideo(!1);else null===(u=this._room)||void 0===u||null===(u=u.localScreenStream)||void 0===u||null===(u=u.observer)||void 0===u||u.setPushVideo(!1);null!==(c=this._room)&&void 0!==c&&null!==(c=c.localScreenStream)&&void 0!==c&&c.pubVideo&&await this._updateScreenPublish()}}}async setExternalVideoTrack(e,t){if(this.logger.print("setExternalVideoTrack()","index: %o, track: %o",e,t),wg(e,"streamIndex",[$u.STREAM_INDEX_MAIN,$u.STREAM_INDEX_SCREEN]),Og(t),e===$u.STREAM_INDEX_MAIN){var i,o;if(this._trackSourceType.video!==Hu.VIDEO_SOURCE_TYPE_EXTERNAL)throw new Cg(Eg.STREAM_TYPE_NOT_MATCH,"setVideoSourceType as external first");this._localVideoTrack=await async function(e,t){const i=new $P(e,t,{streamIndex:XI.MAIN,sourceType:ZI.EXTERNAL});return await i.isTrackReady,i}(this._ctx,t);const e=this._ctx.videoProfile.getContentHint();!t.contentHint&&e&&this._localVideoTrack.setContentHint(e),this._initLocalTrackEvents(this._localVideoTrack),this._localVideoPlayerConfig[$u.STREAM_INDEX_MAIN].forEach((e=>{var t,i;null===(t=this._localVideoTrack)||void 0===t||t.setPlayer(e,this._mirrorType,null===(i=this._config)||void 0===i?void 0:i.autoPlayPolicy,this._initPlayerEvents.bind(this))}));const r=null===(i=this._room)||void 0===i?void 0:i.config.isAutoPublish;(null!==(o=this._room)&&void 0!==o&&null!==(o=o.localStream)&&void 0!==o&&o.pubVideo||r)&&await this._updatePublish()}if(e===$u.STREAM_INDEX_SCREEN){var r,s;if(this._trackSourceType.screenVideo!==Hu.VIDEO_SOURCE_TYPE_EXTERNAL)throw new Cg(Eg.STREAM_TYPE_NOT_MATCH,"setVideoSourceType as external first");this._localScreenVideoTrack=await async function(e,t){const i=new $P(e,t,{sourceType:ZI.EXTERNAL,streamIndex:XI.SCREEN});return await i.isTrackReady,i}(this._ctx,t),this._initLocalTrackEvents(this._localScreenVideoTrack,!0),this._localVideoPlayerConfig[$u.STREAM_INDEX_SCREEN].forEach((e=>{var t,i;null===(t=this._localScreenVideoTrack)||void 0===t||t.setPlayer(e,this._mirrorType,null===(i=this._config)||void 0===i?void 0:i.autoPlayPolicy,this._initPlayerEvents.bind(this))})),null===(r=this._room)||void 0===r||null===(r=r.localScreenStream)||void 0===r||null===(r=r.observer)||void 0===r||r.setPushVideo(!0),null!==(s=this._room)&&void 0!==s&&null!==(s=s.localScreenStream)&&void 0!==s&&s.pubVideo&&await this._updateScreenPublish()}}async setAudioSourceType(e,t){this.logger.print("setAudioSourceType()","index: %o, audioSourceType: %o",e,t),wg(e,"streamIndex",[$u.STREAM_INDEX_MAIN,$u.STREAM_INDEX_SCREEN]),wg(t,"audioSourceType",[Yu.AUDIO_SOURCE_TYPE_EXTERNAL,Yu.AUDIO_SOURCE_TYPE_INTERNAL]);const i=e===$u.STREAM_INDEX_MAIN?"audio":"screenAudio";if(this._trackSourceType[i]!==t){if(this._trackSourceType[i]=t,this.logger.print("setVideoSourceType","set ".concat(i," source type to ").concat(t)),this._localAudioTrack&&e===$u.STREAM_INDEX_MAIN){var o,r;let e=!1;this._trackSourceType.audio===Yu.AUDIO_SOURCE_TYPE_EXTERNAL&&(e=!0,this._removeLocalTrackEvents(this._localAudioTrack),this._localAudioTrack.destroy()),this._localAudioTrack=void 0;const t=null===(o=this._room)||void 0===o?void 0:o.config.isAutoPublish;var s,n;if(e)null===(s=this._room)||void 0===s||null===(s=s.localStream)||void 0===s||null===(s=s.observer)||void 0===s||s.setEnableAudio(!1);else null===(n=this._room)||void 0===n||null===(n=n.localStream)||void 0===n||null===(n=n.observer)||void 0===n||n.setPushAudio(!1);(null!==(r=this._room)&&void 0!==r&&null!==(r=r.localStream)&&void 0!==r&&r.pubAudio||t)&&await this._updatePublish()}if(this._localScreenAudioTrack&&e===$u.STREAM_INDEX_SCREEN){var a;let e=!1;var d,c;if(this._trackSourceType.audio===Yu.AUDIO_SOURCE_TYPE_EXTERNAL&&(e=!0,this._removeLocalTrackEvents(this._localScreenAudioTrack),this._localScreenAudioTrack.destroy()),this._localScreenAudioTrack=void 0,e)null===(d=this._room)||void 0===d||null===(d=d.localScreenStream)||void 0===d||null===(d=d.observer)||void 0===d||d.setEnableAudio(!1);else null===(c=this._room)||void 0===c||null===(c=c.localScreenStream)||void 0===c||null===(c=c.observer)||void 0===c||c.setPushAudio(!1);null!==(a=this._room)&&void 0!==a&&null!==(a=a.localScreenStream)&&void 0!==a&&a.pubAudio&&await this._updateScreenPublish()}}}async setExternalAudioTrack(e,t){if(this.logger.print("setExternalAudioTrack()","index: %o, track: %o",e,t),wg(e,"streamIndex",[$u.STREAM_INDEX_MAIN,$u.STREAM_INDEX_SCREEN]),Og(t),e===$u.STREAM_INDEX_MAIN){var i,o,r;if(this._trackSourceType.audio!==Yu.AUDIO_SOURCE_TYPE_EXTERNAL)throw new Cg(Eg.STREAM_TYPE_NOT_MATCH,"setAudioSourceType as external first");this._localAudioTrack=await async function(e,t){const i=new aN(e,t,{streamIndex:XI.MAIN,sourceType:ZI.EXTERNAL});return await i.isTrackReady,i}(this._ctx,t),this._localAudioTrack.setVolume(this._localAudioVolume),this._initLocalTrackEvents(this._localAudioTrack);const e=this._ctx._localAudioTrackDumpConfig[$u.STREAM_INDEX_MAIN];e.frameSize&&e.callback&&this._localAudioTrack.setDataFetcher(e.frameSize,e.callback);const{position:s,volume:n}=this._ctx.earMonitorSettings[$u.STREAM_INDEX_MAIN];s!==Ah.NONE&&(this.setEarMonitorMode($u.STREAM_INDEX_MAIN,s),this.setEarMonitorVolume($u.STREAM_INDEX_MAIN,n));const a=null===(i=this._room)||void 0===i?void 0:i.config.isAutoPublish;null===(o=this._room)||void 0===o||null===(o=o.localStream)||void 0===o||null===(o=o.observer)||void 0===o||o.setPushAudio(!0),(null!==(r=this._room)&&void 0!==r&&null!==(r=r.localStream)&&void 0!==r&&r.pubAudio||a)&&await this._updatePublish()}if(e===$u.STREAM_INDEX_SCREEN){var s,n;if(this._trackSourceType.screenAudio!==Yu.AUDIO_SOURCE_TYPE_EXTERNAL)throw new Cg(Eg.STREAM_TYPE_NOT_MATCH,"setAudioSourceType as external first");this._localScreenAudioTrack=await async function(e,t){const i=new aN(e,t,{sourceType:ZI.EXTERNAL,streamIndex:XI.SCREEN});return await i.isTrackReady,i}(this._ctx,t),this._localScreenAudioTrack.setVolume(this._localScreenAudioVolume),this._initLocalTrackEvents(this._localScreenAudioTrack);const e=this._ctx._localAudioTrackDumpConfig[$u.STREAM_INDEX_SCREEN];e.frameSize&&e.callback&&this._localScreenAudioTrack.setDataFetcher(e.frameSize,e.callback);const{position:i,volume:o}=this._ctx.earMonitorSettings[$u.STREAM_INDEX_SCREEN];i!==Ah.NONE&&(this.setEarMonitorMode($u.STREAM_INDEX_SCREEN,i),this.setEarMonitorVolume($u.STREAM_INDEX_SCREEN,o)),null===(s=this._room)||void 0===s||null===(s=s.localScreenStream)||void 0===s||null===(s=s.observer)||void 0===s||s.setPushAudio(!0),null!==(n=this._room)&&void 0!==n&&null!==(n=n.localScreenStream)&&void 0!==n&&n.pubAudio&&await this._updateScreenPublish()}}async login(e,t){return this.logger.info("login()","token: %o, userInfo: %o",e,t),Vg(e)||Ng(e,"token"),Ug(t),this._rtmClient.login(e,t)}async logout(){return this.logger.info("logout()"),this._rtmClient.logout()}async updateLoginToken(e){return this.logger.info("updateLoginToken()","token: %o",e),Vg(e)||Ng(e,"token"),this._rtmClient.updateLoginToken(e)}async getPeerOnlineStatus(e){return this.logger.info("getPeerOnlineStatus()","userId: %o",e),Ug(e),this._rtmClient.getPeerOnlineStatus(e)}async sendUserMessageOutsideRoom(e,t){Ug(e);const i=Date.now();return this._rtmClient.sendUserMessageOutsideRoom(e,t).then((t=>(this._messageStatisticsObserver.countUserMessageOutsideRoom(!0,e,!1,i,t),t.id))).catch((t=>{throw this._messageStatisticsObserver.countUserMessageOutsideRoom(!1,e,!1,i,t),t}))}async sendUserBinaryMessageOutsideRoom(e,t){Ug(e),Lg(t,"message");const i=Date.now();return this._rtmClient.sendUserMessageOutsideRoom(e,t).then((t=>(this._messageStatisticsObserver.countUserMessageOutsideRoom(!0,e,!0,i,t),t.id))).catch((t=>{throw this._messageStatisticsObserver.countUserMessageOutsideRoom(!1,e,!0,i,t),t}))}async setServerParams(e,t){return this.logger.info("setServerParams()","signature: %o, url: %0",e,t),this._rtmClient.setServerParams(e,t)}async sendServerMessage(e){Ng(e,"message");const t=Date.now();return this._rtmClient.sendServerMessage(e).then((e=>{this._messageStatisticsObserver.countServerMessage(!0,!1,t,e)})).catch((e=>{throw this._messageStatisticsObserver.countServerMessage(!1,!1,t,e),e}))}async sendServerBinaryMessage(e){Lg(e,"message");const t=Date.now();return this._rtmClient.sendServerMessage(e).then((e=>{this._messageStatisticsObserver.countServerMessage(!0,!0,t,e)})).catch((e=>{throw this._messageStatisticsObserver.countServerMessage(!1,!0,t,e),e}))}startCloudProxy(e){if(this._room)throw new Cg(Eg.START_CLOUD_PROXY_AFTER_JOIN,"[startCloudProxy] should be invoke before join room ");if(this.logger.info("startCloudProxy()",e),Ng(e.logProxy,"logProxy"),Array.isArray(e.accessProxy))for(const t of e.accessProxy)Ng(t,"accessProxy");else Ng(e.accessProxy,"accessProxy");Ng(e.configProxy,"configProxy"),this._originIceConfigRequestUrls=Qg("ICE_CONFIG_REQUEST_URLS"),this._originLogServerUrl=Qg("LOG_SERVER_URL"),this._originConfigServerUrls=Qg("CONFIG_REQUEST_DOMAINS"),zg("ICE_CONFIG_REQUEST_URLS",e.accessProxy),zg("LOG_SERVER_URL",function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";return e?(/^https?:\/\/.+/.test(e)||(e="https://".concat(e)),"".concat(e,"/video/v1/webrtc_log/")):""}(e.logProxy)),zg("CONFIG_REQUEST_DOMAINS",[e.configProxy]),bg.clearAccessNode(this._appId),bg.clearAccessUrls(),this._ctx.useCloudProxy=!0}stopCloudProxy(){var e,t,i;if(this._room)throw new Cg(Eg.STOP_CLOUD_PROXY_BEFORE_LEAVE,"[stopCloudProxy] should be invoke after leave room ");this.logger.info("stopCloudProxy()");const o=null===(e=this._originIceConfigRequestUrls)||void 0===e?void 0:e.map((e=>e.replace("https://","").replace("/dispatch/v1/AccessInfo?Action=GetAccessInfo","")));zg("ICE_CONFIG_REQUEST_URLS",null!=o?o:[]),zg("LOG_SERVER_URL",null!==(t=this._originLogServerUrl)&&void 0!==t?t:""),zg("CONFIG_REQUEST_DOMAINS",null!==(i=this._originConfigServerUrls)&&void 0!==i?i:[]),bg.clearAccessNode(this._appId),bg.clearAccessUrls(),this._ctx.useCloudProxy=!1,this._startCloudProxyTimestamp=void 0}async startPushPublicStream(e,t){var i,o;if(this.logger.print("startPushPublicStream()","publicStreamId: %o, publicStreamParam: %o",e,t),Zg(e),this._assertNotInRoom(),this._publicStreamIds.get(e))throw new Cg(Eg.REPEAT_PUSH,"repeat push public media stream");this._room&&(null===(o=t.layout)||void 0===o||null===(o=o.regions)||void 0===o||o.map((e=>{var t;e.roomId=null===(t=this._room)||void 0===t?void 0:t.config.roomId})));const r=qg(e,"started",t);return null===(i=this._room)||void 0===i||null===(i=i.publicStreamControlMessage(r))||void 0===i?void 0:i.then((()=>{this._publicStreamIds.set(e,e)}))}async updatePublicStreamParam(e,t){var i;this.logger.print("startPushPublicStream()","publicStreamId: %o, publicStreamParam: %o",e,t),Zg(e),this._assertNotInRoom();const o=qg(e,"layoutChanged",t);return null===(i=this._room)||void 0===i?void 0:i.publicStreamControlMessage(o)}async stopPushPublicStream(e){var t;return this.logger.print("startPushPublicStream()","publicStreamId: %o",e),Zg(e),this._assertNotInRoom(),null===(t=this._room)||void 0===t?void 0:t.publicStreamControlMessage({type:"publicstream",action:"stopped",publicStreamID:e}).then((()=>{this._publicStreamIds.delete(e)}))}async startPlayPublicStream(e){await this._wtnStreamManager.startPlayWTN(null,e,!1,!1)}async stopPlayPublicStream(e){await this._wtnStreamManager.stopPlayWTN(e)}async setAudioProfile(e){this.logger.info("setAudioProfile()","profile: %o",e);await this._shouldUpdateAudioConf("setAudioProfile")&&this._ctx.audioProfileManager.setAudioProfile(e)}async setAudioEncodeMaxBitrate(e){if(this.logger.print("setAudioEncodeMaxBitrate()",e),Pg(e,"maxBitrate",6,256),this._ctx.audioProfileManager.setCustomMaxBitrate(e),this._ctx.audioProfileManager.customMaxBitrate){var t,i,o,r;if(US&&(null!==(t=this._room)&&void 0!==t&&null!==(t=t.localStream)&&void 0!==t&&t.pubAudio||null!==(i=this._room)&&void 0!==i&&null!==(i=i.localScreenStream)&&void 0!==i&&i.pubAudio))throw new Cg(Eg.NOT_SUPPORTED,"Your browser does not support set audio encode maxBitrate dynamically.");await(null===(o=this._room)||void 0===o?void 0:o.setAudioEncodeMaxBitrate($u.STREAM_INDEX_MAIN,e)),await(null===(r=this._room)||void 0===r?void 0:r.setAudioEncodeMaxBitrate($u.STREAM_INDEX_SCREEN,e))}}setPublicStreamVideoPlayer(e,t){return this._wtnStreamManager.setWTNRemoteVideoPlayer(e,t)}async setDummyCaptureImagePath(e,t){return new Promise(((i,o)=>{Ng(t,"filePath");const r=new Image;r.crossOrigin="anonymous",r.src=t,r.onload=()=>{e===$u.STREAM_INDEX_MAIN?this._dummyMainImage=r:this._dummyScreenImage=r;try{this._updateDummyCaptureImage(e),i()}catch(t){o(new Cg(Eg.UNEXPECTED_ERROR,t.message))}},r.onerror=()=>{o(new Cg(Eg.UNEXPECTED_ERROR,"Load image error"))}}))}_updateDummyCaptureImage(e){let t,i;if(e===$u.STREAM_INDEX_MAIN?(t=this._dummyMainImage,i=this._ctx.videoProfile.getVideoEncodeConfig()[0]):(t=this._dummyScreenImage,i=this._ctx.videoProfile.getScreenEncodeConfig()),!t)return;const o=document.createElement("canvas"),r=o.getContext("2d"),s=lb(i.width),n=lb(i.height);if(!r)throw new Cg(Eg.UNEXPECTED_ERROR,"Not support canvas");let a,d;!s||!n||t.width<=s&&t.height<=n?(a=t.width,d=t.height):(a=Math.min(s,t.width*n/t.height),d=Math.min(n,t.height*s/t.width)),o.width=a,o.height=d,r.drawImage(t,0,0,t.width,t.height,0,0,a,d);const c=window.setInterval((()=>{t&&r.drawImage(t,0,0,t.width,t.height,0,0,a,d)}),200);e===$u.STREAM_INDEX_MAIN?(clearInterval(this._dummyMainTimer),this._dummyMainTimer=c):(clearInterval(this._dummyScreenTimer),this._dummyScreenTimer=c);const l=o.captureStream(5).getVideoTracks()[0];var u,h;e===$u.STREAM_INDEX_MAIN?(this._localImgVideoTrack=l,null!==(u=this._localVideoTrack)&&void 0!==u&&u.dummy&&this._localVideoTrack.setTrack(this._localImgVideoTrack)):(this._localImgScreenTrack=l,null!==(h=this._localScreenVideoTrack)&&void 0!==h&&h.dummy&&this._localScreenVideoTrack.setTrack(this._localImgScreenTrack))}_addListenExtensionEvent(e){e.on("re-capture-audio",(()=>{this._localAudioTrack&&this.stopAudioCapture().then((()=>{this.startAudioCapture()}))})),e.on("re-capture-video",(()=>{this._localVideoTrack&&!this._localVideoTrack.dummy&&this.stopVideoCapture().then((()=>{this.startVideoCapture()}))})),e.on("reset-video-effect",(async(e,t)=>{if(this._localVideoTrack&&!this._localVideoTrack.dummy){var i;this._localVideoTrack&&this._removeLocalTrackEvents(this._localVideoTrack);try{await this._localVideoTrack.generatePreProcessingTrack()}catch(o){t(o)}this._initLocalTrackEvents(this._localVideoTrack),this._localVideoTrack.stopAll(),this._localVideoTrack.playAll(),this.safeEmit(xh.onLocalStreamTrackChangedByExtension,{streamIndex:$u.STREAM_INDEX_MAIN,type:"video"}),e(),null!==(i=this._room)&&void 0!==i&&null!==(i=i.localStream)&&void 0!==i&&i.pubVideo&&await this._updatePublish(),this._wtnStreamManager._updatePushTrack()}e()}))}async registerExtension(e){var t,i,o;e.monitor=this.monitor,e.logger=new LS(e.name,0,this.id);try{if(!(await e.isSupported()))throw new Error("This extension is not supported.")}catch(s){throw new Error("This extension is not supported.")}Qg("VERSION")!==e.version&&(cb("This extension version is ".concat(e.version,", but the sdk version is ").concat(Qg("VERSION"),".")),this.monitor.report("rtc_error",{message:"This extension version is ".concat(e.version,", but the sdk version is ").concat(Qg("VERSION"),"."),error_code:-1}));let r={};if("RTCAIAnsExtension"===e.name){r={overloadThreshold:Qg("AINR_OVERLOAD_THRESHOLD"),enableCache:Qg("AINR_ENABLE_DUMP"),urls:Qg("AINR_URLS"),cacheTime:Qg("AINR_CACHE_TIME"),dumpTime:Qg("AINR_DUMP_TIME")}}r=function(e){const t={};return Object.keys(e).forEach((i=>{void 0!==e[i]&&(t[i]=e[i])})),t}(r),await e.init(r),this._ctx.extensionManager.register(e),this._addListenExtensionEvent(e),null===(t=this._localAudioTrack)||void 0===t||t.generatePreProcessingTrack(),null===(i=this._localVideoTrack)||void 0===i||i.generatePreProcessingTrack(),null===(o=this._localScreenAudioTrack)||void 0===o||o.generatePreProcessingTrack()}defaultTranscoding(){return JSON.parse(JSON.stringify(OU.getDefaultValue()))}async _updatePublish(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.logger.info("_updatePublish()","config: %o",e);if(e=Fu(Fu({},{mediaType:void 0,invokeByJoinRoom:!1,pubState:MN.PUB}),e),!this._ctx.visibility)throw new Cg(Eg.NO_PUBLISH_PERMISSION,"no publish permission");const i=await this._pubLock.lock();if(this._room&&this._ctx.signalingManager.isConnected())try{await this._room.publish(this._localVideoTrack,this._localAudioTrack,e.mediaType,e.pubState,e.invokeByJoinRoom)}catch(wZ){throw wZ instanceof Cg?(wZ.code===Eg.TOKEN_NO_PUBLISH_PERMISSION&&this._room.config.setTokenPublishPrivilegeExpired(!0),wZ):new Cg(Eg.UNEXPECTED_ERROR,"unexpected error",wZ)}finally{i()}else if(i(),t)throw new Cg(Eg.NOT_CONNECTED_YET,"not connected")}async startAudioPlaybackDeviceTest(e,t){return this.logger.print("startAudioPlaybackDeviceTest()","filePath: %o, indicationInterval: %o",e,t),Ng(e,"filePath"),Pg(t,"indicationInterval"),await this._audioDeviceManager.startAudioPlaybackDeviceTest(e,t)}stopAudioPlaybackDeviceTest(){this.logger.info("stopAudioPlaybackDeviceTest()"),this._audioDeviceManager.stopAudioPlaybackDeviceTest()}async startAudioDeviceRecordTest(e,t){this.logger.print("startAudioDeviceRecordTest()","indicationInterval: %o",e),Pg(e,"indicationInterval"),await this._audioDeviceManager.startAudioDeviceRecordTest(e,t,this._localAudioVolume)}stopAudioDeviceRecordAndPlayTest(){this.logger.info("stopAudioDeviceRecordAndPlayTest()"),this._audioDeviceManager.stopAudioDeviceRecordAndPlayTest()}stopAudioDevicePlayTest(){this.logger.info("stopAudioDevicePlayTest()"),this._audioDeviceManager.stopAudioDevicePlayTest()}setRemoteUserPriority(e,t){var i;this.logger.print("setRemoteUserPriority()","userId: %o, priority: %o",e,t);try{Ug(e),wg(t,"priority",[_h.HIGH,_h.MEDIUM,_h.LOW])}catch(o){return console.warn(o),!1}return this._ctx.userPriority.set(e,t),null===(i=this._room)||void 0===i||i.updateRemoteUserPriority(e),!0}async takeLocalSnapshot(e){this.logger.print("takeLocalSnapshot()","streamIndex: %o",e),wg(e,"streamIndex",[$u.STREAM_INDEX_MAIN,$u.STREAM_INDEX_SCREEN]);const t=e===$u.STREAM_INDEX_MAIN?this.localVideoTrack:this.localScreenVideoTrack;if(!t)throw new Cg(Eg.INVOKED_BEFORE_CAPTURE,"capture first");return t.snapshot()}async takeRemoteSnapshot(e,t){var i;this.logger.print("takeRemoteSnapshot()","id: %o, streamIndex: %o",e,t),Ng(e,"id"),wg(t,"streamIndex",[$u.STREAM_INDEX_MAIN,$u.STREAM_INDEX_SCREEN]);const o=(null===(i=this._room)||void 0===i||null===(i=i.remoteStreams.get(e))||void 0===i||null===(i=i.find((e=>e.isScreen===(t===$u.STREAM_INDEX_SCREEN))))||void 0===i?void 0:i.videoTrack)||this._wtnStreamManager.__getPublicStreamTrack(e,"video");if(!o)throw new Cg(Eg.STREAM_NOT_EXIST,"stream not exist");return o.snapshot()}setSubscribeFallbackOption(e){this.logger.info("setSubscribeFallbackOption()","option: %o",e);try{wg(e,"option",[hh.DISABLE,hh.VIDEO_STREAM_LOW,hh.AUDIO_ONLY])}catch(t){return console.warn(t),!1}return!this._room&&(this._ctx.subscribeFallbackOption=e,!0)}getLocalStreamTrack(e,t){let i,o;if(e===$u.STREAM_INDEX_MAIN?(i="video"===t?this.localVideoTrack:this.localAudioTrack,o=()=>{var e;return null===(e=this._room)||void 0===e?void 0:e.localStream}):(i="video"===t?this.localScreenVideoTrack:this.localScreenAudioTrack,o=()=>{var e;return null===(e=this._room)||void 0===e?void 0:e.localScreenStream}),!i)return;const r=i instanceof aN&&i.mixedAudioTrack?i.mixedAudioTrack:i.preprocessingTrack;if(!r)return;const s=o();return this._reportMsTrackEvent(r,(null==s?void 0:s.stream.id)||"local"),r}getRemoteStreamTrack(e,t,i){var o;let r;const s=(null===(o=this._room)||void 0===o?void 0:o.remoteStreams.get(e))||[];if(null==s||!s.length)return;let n;var a,d,c,l;t===$u.STREAM_INDEX_MAIN?(n=s.find((e=>!e.isScreen)),r="video"===i?null===(a=n)||void 0===a?void 0:a.videoTrack:null===(d=n)||void 0===d?void 0:d.audioTrack):(n=s.find((e=>e.isScreen)),r="video"===i?null===(c=n)||void 0===c?void 0:c.videoTrack:null===(l=n)||void 0===l?void 0:l.audioTrack);if(!r)return;const u=r.preprocessingTrack;if(!u||!n)return;const{streamId:h}=n;return this._reportMsTrackEvent(u,h),u}getPublicStreamTrack(e,t){const i=this._wtnStreamManager.__getPublicStreamTrack(e,t),o=null==i?void 0:i.preprocessingTrack;if(o)return o?(this._reportMsTrackEvent(o,e),o):void 0}setRemoteStreamRenderSync(e){return!this._room&&(this._ctx.avSync=!!e,!0)}setJoinRoomParams(e){e&&(this._ctx.joinRoomParams=e)}async setAudioSelectionConfig(e){wg(e,"audioSelectionPriority",[Rh.DEFAULT,Rh.HIGH]),this._ctx.mediaParams||(this._ctx.mediaParams={}),this._ctx.mediaParams.audioSelectionConfig={isHighPriority:e===Rh.HIGH},this._room&&await this._room.updateMediaParams(this._ctx.mediaParams)}setCaptureVolume(e,t){wg(e,"streamIndex",[$u.STREAM_INDEX_MAIN,$u.STREAM_INDEX_SCREEN]),t=Fg(t,"volume",0,400);var i,o,r,s,n;e===$u.STREAM_INDEX_SCREEN?(null===(i=this._localScreenAudioTrack)||void 0===i||i.once("needReplaceTrack",(()=>{var e;null===(e=this._room)||void 0===e||e.updatePubScreenTrack()})),null===(o=this._localScreenAudioTrack)||void 0===o||o.setVolume(t),this._localScreenAudioVolume=t):(null===(r=this._localAudioTrack)||void 0===r||r.once("needReplaceTrack",(()=>{var e;null===(e=this._room)||void 0===e||e.updatePubTrack()})),null===(s=this._localAudioTrack)||void 0===s||s.setVolume(t),null===(n=this._audioDeviceManager.audioTrack)||void 0===n||n.setVolume(t),this._localAudioVolume=t)}setPlaybackVolume(e,t,i){var o,r,s;if(Ug(e),wg(t,"streamIndex",[$u.STREAM_INDEX_MAIN,$u.STREAM_INDEX_SCREEN]),i=Fg(i,"volume",0,400),null!==(o=this._room)&&void 0!==o&&o.config.isMultiChatMode())return void cb("setPlaybackVolume is not supported in Conference mode");const n=t===$u.STREAM_INDEX_SCREEN;n?this._remoteScreenAudioVolume.set(e,i):this._remoteAudioVolume.set(e,i);const a=null===(r=this._room)||void 0===r||null===(r=r.remoteStreams.get(e))||void 0===r?void 0:r.find((e=>e.isScreen===n));null==a||null===(s=a.audioTrack)||void 0===s||s.setVolume(i)}setPublicStreamVolume(e,t){this._wtnStreamManager.setWTNRemoteAudioPlaybackVolume(e,t)}async startForwardStreamToRooms(e){e.forEach((e=>{Dg(e.roomId)})),this._assertNotInRoom();return await this._room.startForwardStream2Rooms(e)}async updateForwardStreamToRooms(e){e.forEach((e=>{Dg(e.roomId)})),this._assertNotInRoom();return await this._room.updateForwardStream2Rooms(e)}async stopForwardStreamToRooms(){this._assertNotInRoom();return await this._room.stopForwardStream2Rooms()}async pauseForwardStreamToAllRooms(){this._assertNotInRoom();return await this._room.pauseForwardStream2AllRooms()}async resumeForwardStreamToAllRooms(){this._assertNotInRoom();return await this._room.resumeForwardStream2AllRooms()}async ambulance(){const e=await zU(this),t=JSON.stringify(e);return this.monitor.reportLongString("ambulance",t),e}async setEarMonitorMode(e,t){this.logger.info("setEarMonitorMode()","streamIndex: %s, position: %s",e,t),wg(e,"streamIndex",[$u.STREAM_INDEX_MAIN,$u.STREAM_INDEX_SCREEN]),wg(t,"position",[Ah.NONE,Ah.AFTER_CAPTURE,Ah.AFTER_PROCESS]),this._ctx.earMonitorSettings[e].position=t;const i=e===$u.STREAM_INDEX_MAIN?this.localAudioTrack:e===$u.STREAM_INDEX_SCREEN?this.localScreenAudioTrack:void 0;if(i)return t!==Ah.NONE?i.play(t):i.stop();this.logger.warn("setEarMonitorMode()","local audio track not exist")}setEarMonitorVolume(e,t){this.logger.info("setEarMonitorVolume()","streamIndex: %s, volume: %s",e,t),wg(e,"streamIndex",[$u.STREAM_INDEX_MAIN,$u.STREAM_INDEX_SCREEN]),t=Fg(t,"volume",0,400),this._ctx.earMonitorSettings[e].volume=t;const i=e===$u.STREAM_INDEX_MAIN?this.localAudioTrack:e===$u.STREAM_INDEX_SCREEN?this.localScreenAudioTrack:void 0;if(i)return i.setPlaybackVolume(t);this.logger.warn("setEarMonitorVolume()","local audio track not exist")}setUserInfo(e,t){Dg(e),Ug(t),this.monitor.set({room_id:e,user_id:t})}_reportMsTrackEvent(e,t){if(!e.hookStop){e.hookStop=!0;const i=e.stop;e.stop=()=>{fS(this.id,"stop",t,0,t),i.call(e)}}}async _updateScreenPublish(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.logger.info("_updateScreenPublish()");if(e=Fu(Fu({},{mediaType:void 0,pubState:MN.PUB}),e),!this._ctx.visibility)throw new Cg(Eg.NO_PUBLISH_PERMISSION,"no publish permission");const t=await this._pubLock.lock();if(this._room&&this._ctx.signalingManager.isConnected())try{await this._room.publishScreen(this._localScreenVideoTrack,this._localScreenAudioTrack,e.mediaType,e.pubState)}catch(wZ){throw wZ instanceof Cg?wZ:new Cg(Eg.UNEXPECTED_ERROR,"unexpected error",wZ)}finally{t()}else t()}_updateAudioPlayerState(e){this.logger.info("_updateAudioPlayerState()");const{userId:t,isScreen:i,isPublic:o}=e;if(e.audioTrack&&e.attributes.audiostream&&e.subAudio){var r,s,n;if(!e.audioTrack.havePlayer()){var a,d;const r=new sN(this.id,t,{muted:(null===(a=this._config)||void 0===a?void 0:a.autoPlayPolicy)===Sh.VIDEO_ONLY||(null===(d=this._config)||void 0===d?void 0:d.autoPlayPolicy)===Sh.PLAY_MANUALLY,isScreen:!o&&i});e.audioTrack.setPlayer(r),e.audioTrack.bindPlayerEvent(this._initPlayerEvents.bind(this));const s=this._audioDeviceManager.getSinkId();s&&e.audioTrack.setPlaybackDevice(s)}e.audioTrack.play();const u=o?null!==(r=this._ctx.publicAudioVolume.get(t))&&void 0!==r?r:100:i?null!==(s=this._remoteScreenAudioVolume.get(t))&&void 0!==s?s:100:null!==(n=this._remoteAudioVolume.get(t))&&void 0!==n?n:100;if(e.audioTrack.setVolume(u),ZS&&JS){var c,l;const e=null!==(c=null===(l=this._room)||void 0===l?void 0:l.remoteStreams)&&void 0!==c?c:new Map;h=e,MU&&clearTimeout(MU),MU=setTimeout((()=>{for(const[e,t]of h)null!=e&&e.startsWith("mux")&&t.forEach((e=>{var t;null===(t=e.audioTrack)||void 0===t||t.pause()}));for(const[e,t]of h)null!=e&&e.startsWith("mux")&&t.forEach((e=>{var t;null===(t=e.audioTrack)||void 0===t||t.play()}))}),2e3)}}else{var u;null===(u=e.audioTrack)||void 0===u||u.stop()}var h}_updateVideoPlayerState(e){if(this.logger.info("_updateVideoPlayerState()"),e.videoTrack){const i=e.isPublic?this._wtnStreamManager._publicVideoPlayerConfig:this._remoteVideoPlayerConfig[e.isScreen?$u.STREAM_INDEX_SCREEN:$u.STREAM_INDEX_MAIN].get(e.userId);if(i)for(const[,o]of i){var t;e.videoTrack.setPlayer(this.id,o,null===(t=this._config)||void 0===t?void 0:t.autoPlayPolicy,this._initPlayerEvents.bind(this))}}}get _localVideoTrack(){return this._ctx.localVideoTrack}get _localAudioTrack(){return this._ctx.localAudioTrack}set _localVideoTrack(e){this._ctx.localVideoTrack=e}set _localAudioTrack(e){this._ctx.localAudioTrack=e}async _onAddStream(e){const t=e.stream,{localaudio:i,audiostream:o,localvideo:r,videostream:s}=t.attributes;let n=Hg.NONE;o&&(n|=eh.AUDIO),s&&(n|=eh.VIDEO),n&&(await new Promise((e=>setTimeout(e))),t.isScreen?this.safeEmit(xh.onUserPublishScreen,{userId:t.userId,mediaType:n}):(this.safeEmit(xh.onUserPublishStream,{userId:t.userId,mediaType:n,videoStreamDescriptions:t.attributes.videoDescriptions}),this._handleAutoSubscribe(t,!0)),this.safeEmit("onAddStream",{userId:t.userId,mediaType:n,isScreen:!!t.isScreen}),t.isScreen||(i&&this.safeEmit(xh.onUserStartAudioCapture,{userId:t.userId}),r&&this.safeEmit(xh.onUserStartVideoCapture,{userId:t.userId})))}_handleAutoSubscribe(e,t){var i,o;let r=Hg.NONE;if(null!==(i=this._room)&&void 0!==i&&i.config.isAutoSubscribeAudio&&(r|=eh.AUDIO),null!==(o=this._room)&&void 0!==o&&o.config.isAutoSubscribeVideo&&(r|=eh.VIDEO),r){var s,n,a;if(t&&rb(r))null===(n=e.observer)||void 0===n||n.setAutoSubscribeAudio(!0);if(t&&sb(r))null===(a=e.observer)||void 0===a||a.setAutoSubscribeVideo(!0);null!==(s=this._room)&&void 0!==s&&s.config.tokenSubscribePrivilegeExpired?(rb(r)&&(this._pauseAllSubscribeState.resumeAudioStreamIds[e.streamId]=e.streamId),sb(r)&&(this._pauseAllSubscribeState.resumeVideoStreamIds[e.streamId]=e.streamId)):this._subscribe(!1,e.userId,r)}}_onRemoveStream(e){var t;const i=e.stream,o=null!==(t=sZ[e.reason])&&void 0!==t?t:th.STREAM_REMOVE_REASON_OTHER,r=i.isScreen?xh.onUserUnpublishScreen:xh.onUserUnpublishStream;let s=Hg.NONE;i.attributes.audiostream&&(s|=eh.AUDIO),i.attributes.videostream&&(s|=eh.VIDEO),s!==Hg.NONE&&(this.safeEmit(r,{userId:i.userId,mediaType:s,reason:o}),this.safeEmit("onRemoveStream",{userId:i.userId,isScreen:i.isScreen})),delete this._pauseAllSubscribeState.resumeAudioStreamIds[i.streamId],delete this._pauseAllSubscribeState.resumeVideoStreamIds[i.streamId],"function"==typeof e.callback&&e.callback()}_onUserConnection(e){setTimeout((()=>this.safeEmit(xh.onUserJoined,e)))}_onUserLeave(e){this.safeEmit(xh.onUserLeave,e)}_onRoomError(e){var t;this.safeEmit(xh.onError,e),null===(t=this._room)||void 0===t||t.destroy(),this._room=void 0}_onNetworkQuality(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];this.safeEmit(xh.onNetworkQuality,...t)}_onConnectionStateChange(e){if(void 0!==this._startCloudProxyTimestamp&&this._ctx.useCloudProxy&&e.state===ih.CONNECTION_STATE_CONNECTED&&this.safeEmit(xh.onCloudProxyConnected,{interval:Date.now()-this._startCloudProxyTimestamp}),(this._ctx.isPreConnection||e.state!==ih.CONNECTION_STATE_CONNECTED&&e.state!==ih.CONNECTION_STATE_RECONNECTED)&&this.safeEmit(xh.onConnectionStateChanged,e),e.state===ih.CONNECTION_STATE_RECONNECTING)for(const[o,r]of null!==(t=null===(i=this._room)||void 0===i?void 0:i.remoteStreams)&&void 0!==t?t:new Map){var t,i;o.startsWith("mux")&&r.forEach((e=>{var t;return null===(t=e.audioTrack)||void 0===t?void 0:t.stop()}))}else e.state===ih.CONNECTION_STATE_CONNECTED&&this._rtmClient.setRTSMessageLimit(this._ctx.rtsLimiter.conf)}_stopAudioPropertiesReport(){null!==this._audioPropertiesReportTimer&&(clearInterval(this._audioPropertiesReportTimer),this._audioPropertiesReportTimer=null)}_onResubscribe(e){var t,i;e.stream&&(null===(t=e.stream.videoTrack)||void 0===t||t.stopAll(),null===(i=e.stream.audioTrack)||void 0===i||i.stop(),this._updateAudioPlayerState(e.stream),this._updateVideoPlayerState(e.stream))}_onSubscribePushTrack(e){e.stream&&this._updateAudioPlayerState(e.stream)}_onRemovePushTrack(e){e.stream&&this._updateAudioPlayerState(e.stream)}_onUserPublishStateChange(e){let{userId:t,isScreen:i,mediaType:o,pubState:r,remoteStream:s}=e;const n={userId:t,mediaType:o};o&eh.AUDIO&&setTimeout((()=>{this._updateAudioPlayerState(s)})),i?r===MN.PUB?this.safeEmit(xh.onUserPublishScreen,n):this.safeEmit(xh.onUserUnpublishScreen,Fu(Fu({},n),{},{reason:th.STREAM_REMOVE_REASON_UNPUBLISH})):r===MN.PUB?(n.videoStreamDescriptions=s.attributes.videoDescriptions,this.safeEmit(xh.onUserPublishStream,n),this._handleAutoSubscribe(s,!0)):this.safeEmit(xh.onUserUnpublishStream,Fu(Fu({},n),{},{reason:th.STREAM_REMOVE_REASON_UNPUBLISH}))}_onCustomMessage(e){const{message:t}=e;e.binary?this.safeEmit(xh.onRoomBinaryMessageReceived,{userId:e.clientId,message:t}):this.safeEmit(xh.onRoomMessageReceived,{userId:e.clientId,message:t})}_onUserMessageReceived(e){this._messageStatisticsObserver.recvP2PMessage(e.userId),this.safeEmit(xh.onUserMessageReceived,e)}_onUserBinaryMessageReceived(e){this._messageStatisticsObserver.recvP2PMessage(e.userId),this.safeEmit(xh.onUserBinaryMessageReceived,e)}_onLiveTranscodingResult(e){this.safeEmit(xh.onLiveTranscodingResult,e)}_onStreamMixingEvent(e){this.safeEmit(xh.onStreamMixingEvent,e)}_onUserTokenWillExpire(){this.safeEmit(xh.onTokenWillExpire)}_onUserTokenPublishPrivilegeWillExpire(){this.safeEmit(xh.onTokenPublishPrivilegeWillExpire)}async _onUserTokenPublishPrivilegeDidExpired(){var e,t,i;await(null===(e=this._room)||void 0===e?void 0:e.unpublish()),await(null===(t=this._room)||void 0===t?void 0:t.unpublishScreen()),null===(i=this._room)||void 0===i||i.config.setTokenPublishPrivilegeExpired(!0),this.safeEmit(xh.onTokenPublishPrivilegeDidExpired,{errorCode:Eg.TOKEN_NO_PUBLISH_PERMISSION,message:"Token no longer has publish privilege"})}_onUserTokenSubscribePrivilegeWillExpire(){this.safeEmit(xh.onTokenSubscribePrivilegeWillExpire)}async _onUserTokenSubscribePrivilegeDidExpired(){this._handleLoseSubscribePrivilege(),this.safeEmit(xh.onTokenSubscribePrivilegeDidExpired,{errorCode:Eg.TOKEN_NO_SUBSCRIBE_PERMISSION,message:"Token no longer has subscribe privilege"})}async _unSubscribeAllRemoteStreams(){return this._room?this._pauseAllRemoteStreams(eh.AUDIO_AND_VIDEO):Promise.resolve()}_onPushPublicStreamResult(e){this.safeEmit(xh.onPushPublicStreamResult,e)}_handleRTMClient(e){e.on("onUserMessageReceivedOutsideRoom",(e=>{this._messageStatisticsObserver.recvP2POutRoomMessage(e.userId),this.safeEmit(xh.onUserMessageReceivedOutsideRoom,e)})),e.on("onUserBinaryMessageReceivedOutsideRoom",(e=>{this._messageStatisticsObserver.recvP2POutRoomMessage(e.userId),this.safeEmit(xh.onUserBinaryMessageReceivedOutsideRoom,e)})),e.on("onUserDisconnection",(()=>{this.safeEmit(xh.onError,{errorCode:Eg.RTM_DUPLICATE_LOGIN})})),e.on("onRTMTokenError",(()=>{this.safeEmit(xh.onError,{errorCode:Eg.RTM_TOKEN_ERROR})})),e.on("onServerParamsSetResult",(e=>{this.safeEmit(xh.onServerParamsSetResult,null==e?void 0:e.code)}))}getSubLock(e,t){const i=e?this._subScreenLocks:this._subLocks;let o=i.get(t);return o||(o=new qN("sub_".concat(e?1:0,"_").concat(t)),i.set(t,o)),o}get localAudioTrack(){return this._localAudioTrack}get localVideoTrack(){return this._localVideoTrack}get localScreenAudioTrack(){return this._localScreenAudioTrack}get localScreenVideoTrack(){return this._localScreenVideoTrack}get remoteStreams(){var e;const t=[];return null!==(e=this._room)&&void 0!==e&&e.remoteStreams&&this._room.remoteStreams.forEach((e=>{Array.isArray(e)&&e.forEach((e=>{t.push({userId:e.userId,isScreen:e.isScreen,hasVideo:e.hasVideo,hasAudio:e.hasAudio,videoStreamDescriptions:e.attributes.videoDescriptions})}))})),t}get iceState(){var e;return null===(e=this._ctx.peerConnection)||void 0===e?void 0:e.getIceConnectionState()}get remoteUsers(){var e;const t=[];return null!==(e=this._room)&&void 0!==e&&e.remoteUsers&&this._room.remoteUsers.forEach((e=>{t.push({userId:e.userId})})),t}get multiChatMode(){var e;return!(null===(e=this._room)||void 0===e||!e.config.isMultiChatMode())}get checkMediaType(){return this._checkMediaType}get assertNotInRoom(){return this._assertNotInRoom}get peerConnection(){var e;return null===(e=this._ctx.peerConnection)||void 0===e?void 0:e.getOriginRTCPeerConnection()}_handleAudioDeviceManager(){this._audioDeviceManager.on("onAudioPlaybackDeviceTestVolume",(e=>{this.safeEmit(xh.onAudioPlaybackDeviceTestVolume,e)}))}_assertNotInRoom(){if(!this._room||!this._ctx.signalingManager.isConnected())throw new Cg(Eg.NOT_CONNECTED_YET,"server not connected")}_checkMediaType(e){wg(e,"mediaType",[eh.AUDIO,eh.VIDEO,eh.AUDIO_AND_VIDEO])}_getUserId(){var e;return(null===(e=this._room)||void 0===e?void 0:e.config.userInfo.userId)||"local_user"}async _switchTrack(e){var t;this._initLocalTrackEvents(e),this._localVideoTrack=e,this._localVideoPlayerConfig[$u.STREAM_INDEX_MAIN].forEach((t=>{var i;e.setPlayer(t,this._mirrorType,null===(i=this._config)||void 0===i?void 0:i.autoPlayPolicy,this._initPlayerEvents.bind(this))})),null!==(t=this._room)&&void 0!==t&&null!==(t=t.localStream)&&void 0!==t&&t.pubVideo&&await this._updatePublish(),this._wtnStreamManager._updatePushTrack()}async _shouldUpdateAudioConf(e){var t,i;const o=await(null===(t=this._room)||void 0===t?void 0:t.hasPublished())||(null===(i=this._room)||void 0===i||null===(i=i.localStream)||void 0===i?void 0:i.pubAudio)||this._localAudioTrack&&this._localAudioTrack.sourceType===ZI.INTERNAL;if(o){const t="engine.".concat(e," should be called before publishing or capturing.");console.warn("[RTC WebSDK]: ".concat(t)),fS(this.id,e,t)}return!o}_getRemoteVideoPlayerConfig(e,t,i){var o;return null===(o=this._remoteVideoPlayerConfig[e].get(t))||void 0===o?void 0:o.get(i)}_setRemoteVideoPlayerConfig(e,t,i,o){const r=this._remoteVideoPlayerConfig[e].get(t)||new Map;r.set(i,o),this._remoteVideoPlayerConfig[e].set(t,r)}getRemoteVideoStats(){var e;const t=null===(e=this._room)||void 0===e?void 0:e.remoteStreams;if(!t||0===t.size)return{};const i={};return t.forEach(((e,t)=>{var o,r,s;let n,a;null!==(o=e[0])&&void 0!==o&&o.isScreen?(a=e[0],n=e[1]):(a=e[1],n=e[0]);const d={mainVideoStats:nb((null===(r=n)||void 0===r?void 0:r.getRemoteStreamStats().videoStats)||{}),screenVideoStats:nb((null===(s=a)||void 0===s?void 0:s.getRemoteStreamStats().videoStats)||{})};i[t]=d})),i}getRemoteAudioStats(){var e;const t=null===(e=this._room)||void 0===e?void 0:e.remoteStreams;if(!t||0===t.size)return{};const i={};return t.forEach(((e,t)=>{var o,r,s;let n,a;null!==(o=e[0])&&void 0!==o&&o.isScreen?(a=e[0],n=e[1]):(a=e[1],n=e[0]);const d={mainAudioStats:nb((null===(r=n)||void 0===r?void 0:r.getRemoteStreamStats().audioStats)||{}),screenAudioStats:nb((null===(s=a)||void 0===s?void 0:s.getRemoteStreamStats().audioStats)||{})};i[t]=d})),i}getLocalVideoStats(){var e,t;return{mainVideoStats:nb((null===(e=this._room)||void 0===e||null===(e=e.localStream)||void 0===e?void 0:e.getLocalStreamStats().videoStats)||{}),screenVideoStats:nb((null===(t=this._room)||void 0===t||null===(t=t.localScreenStream)||void 0===t?void 0:t.getLocalStreamStats().videoStats)||{})}}getLocalAudioStats(){var e,t;return{mainAudioStats:nb((null===(e=this._room)||void 0===e||null===(e=e.localStream)||void 0===e?void 0:e.getLocalStreamStats().audioStats)||{}),screenAudioStats:nb((null===(t=this._room)||void 0===t||null===(t=t.localScreenStream)||void 0===t?void 0:t.getLocalStreamStats().audioStats)||{})}}getPublicVideoStats(){const e=this._wtnStreamManager.__getRemoteStreams();if(!e||0===e.size)return{};const t={};return e.forEach(((e,i)=>{const o=nb(e.getRemoteStreamStats().videoStats||{});delete o.isScreen,t[i]=o})),t}getPublicAudioStats(){const e=this._wtnStreamManager.__getRemoteStreams();if(!e||0===e.size)return{};const t={};return e.forEach(((e,i)=>{const o=nb(e.getRemoteStreamStats().audioStats||{});delete o.isScreen,t[i]=o})),t}_initAutoplayFailedWorkaround(){if(jg.ENABLE_PLAY_AFTER_CLICK||zS){let e=[];this.on(xh.onAutoplayFailed,(t=>{e.push(t),o()}));const t=()=>{e.length>0&&(fS(this.id,"resumePlay",JSON.stringify(e)),Promise.all(e.map((e=>this.play(e.userId,e.mediaType,e.streamIndex,e.playerId)))).then((()=>{e=[],fS(this.id,"resumePlaySuccess",JSON.stringify(e))})).catch((()=>{fS(this.id,"resumePlayFailed",JSON.stringify(e))})))};let i;jg.ENABLE_PLAY_AFTER_CLICK&&(document.addEventListener("click",t),i=()=>{document.removeEventListener("click",t)});const o=()=>{var i,o;window.WeixinJSBridge&&(fS(this.id,"resumePlayInWxBridge",JSON.stringify(e)),null===(i=(o=window.WeixinJSBridge).invoke)||void 0===i||i.call(o,"getNetworkType",{},t))};let r;zS&&!window.WeixinJSBridge&&(document.addEventListener("WeixinJSBridgeReady",o,!1),r=()=>{document.removeEventListener("WeixinJSBridgeReady",o)}),this._revokeAutoplayFailedWorkaround=()=>{var e,t;null===(e=i)||void 0===e||e(),null===(t=r)||void 0===t||t()}}}},Xu($U,"hasReportNativeDetector",!1),$U);let rZ=oZ;iZ([mS()],rZ.prototype,"updateToken",1),iZ([mS(),dZ("video")],rZ.prototype,"setVideoCaptureDevice",1),iZ([mS(),dZ("audio")],rZ.prototype,"setAudioCaptureDevice",1),iZ([mS()],rZ.prototype,"connect",1),iZ([function(e,t,i){if("function"==typeof i.value){const e=i.value;i.value=function(){var t;const i=uS(this.id);for(var o=arguments.length,r=new Array(o),s=0;s<o;s++)r[s]=arguments[s];return null==i||i.set({room_id:r[1],user_id:null===(t=r[2])||void 0===t?void 0:t.userId}),e.apply(this,r)}}},mS()],rZ.prototype,"joinRoom",1),iZ([mS()],rZ.prototype,"leaveRoom",1),iZ([mS()],rZ.prototype,"destroy",1),iZ([mS(),LD],rZ.prototype,"publishStream",1),iZ([mS(),LD],rZ.prototype,"unpublishStream",1),iZ([mS(),LD],rZ.prototype,"publishScreen",1),iZ([mS(),LD],rZ.prototype,"unpublishScreen",1),iZ([mS(),LD],rZ.prototype,"subscribeStream",1),iZ([nZ],rZ.prototype,"_subscribe",1),iZ([mS(),LD],rZ.prototype,"unsubscribeStream",1),iZ([mS(),LD],rZ.prototype,"subscribeScreen",1),iZ([mS(),LD],rZ.prototype,"unsubscribeScreen",1),iZ([nZ],rZ.prototype,"_unsubscribe",1),iZ([mS(),aZ],rZ.prototype,"setRemoteVideoConfig",1),iZ([mS()],rZ.prototype,"setRemoteSimulcastStreamType",1),iZ([mS(),dZ("video")],rZ.prototype,"startVideoCapture",1),iZ([mS(),dZ("video")],rZ.prototype,"stopVideoCapture",1),iZ([mS(),dZ("audio")],rZ.prototype,"startAudioCapture",1),iZ([mS(),dZ("audio")],rZ.prototype,"stopAudioCapture",1),iZ([mS(),dZ("all")],rZ.prototype,"startAudioAndVideoCapture",1),iZ([mS()],rZ.prototype,"startVideoAndAudioCapture",1),iZ([mS()],rZ.prototype,"getAudioMixingManager",1),iZ([mS()],rZ.prototype,"getWTNStreamManager",1),iZ([mS()],rZ.prototype,"getCallId",1),iZ([mS(),cZ],rZ.prototype,"startScreenCapture",1),iZ([mS(),cZ],rZ.prototype,"stopScreenCapture",1),iZ([mS()],rZ.prototype,"setLocalVideoPlayer",1),iZ([mS(),LD],rZ.prototype,"startLiveTranscoding",1),iZ([mS(),LD],rZ.prototype,"updateLiveTranscoding",1),iZ([mS(),LD],rZ.prototype,"stopLiveTranscoding",1),iZ([mS(),LD],rZ.prototype,"startSubtitle",1),iZ([mS(),LD],rZ.prototype,"updateSubtitleConfig",1),iZ([mS(),LD],rZ.prototype,"stopSubtitle",1),iZ([mS()],rZ.prototype,"setBusinessId",1),iZ([mS(),LD],rZ.prototype,"setUserVisibility",1),iZ([mS()],rZ.prototype,"setRemoteVideoPlayer",1),iZ([mS()],rZ.prototype,"setLocalVideoMirrorType",1),iZ([mS()],rZ.prototype,"setRemoteVideoMirrorType",1),iZ([mS()],rZ.prototype,"setAudioPlaybackDevice",1),iZ([mS()],rZ.prototype,"play",1),iZ([mS()],rZ.prototype,"stop",1),iZ([mS()],rZ.prototype,"getAudioVolume",1),iZ([mS()],rZ.prototype,"setAudioFrameCallback",1),iZ([mS(),LD],rZ.prototype,"pauseAllSubscribedStream",1),iZ([mS(),LD],rZ.prototype,"resumeAllSubscribedStream",1),iZ([mS()],rZ.prototype,"sendUserMessage",1),iZ([mS()],rZ.prototype,"sendUserBinaryMessage",1),iZ([mS()],rZ.prototype,"sendRoomMessage",1),iZ([mS()],rZ.prototype,"sendRoomBinaryMessage",1),iZ([mS()],rZ.prototype,"setAudioCaptureConfig",1),iZ([db("4.51"),mS()],rZ.prototype,"setVideoCaptureConfig",1),iZ([mS()],rZ.prototype,"enableSimulcastMode",1),iZ([mS()],rZ.prototype,"setLocalSimulcastMode",1),iZ([mS()],rZ.prototype,"setVideoEncoderConfig",1),iZ([mS()],rZ.prototype,"setScreenEncoderConfig",1),iZ([mS(),LD],rZ.prototype,"sendSEIMessage",1),iZ([db("4.42"),mS()],rZ.prototype,"setAudioVolumeIndicationInterval",1),iZ([mS()],rZ.prototype,"enableAudioPropertiesReport",1),iZ([mS()],rZ.prototype,"setVideoSourceType",1),iZ([mS()],rZ.prototype,"setExternalVideoTrack",1),iZ([mS()],rZ.prototype,"setAudioSourceType",1),iZ([mS()],rZ.prototype,"setExternalAudioTrack",1),iZ([mS()],rZ.prototype,"login",1),iZ([mS()],rZ.prototype,"logout",1),iZ([mS()],rZ.prototype,"updateLoginToken",1),iZ([mS()],rZ.prototype,"getPeerOnlineStatus",1),iZ([mS()],rZ.prototype,"sendUserMessageOutsideRoom",1),iZ([mS()],rZ.prototype,"sendUserBinaryMessageOutsideRoom",1),iZ([mS()],rZ.prototype,"setServerParams",1),iZ([mS()],rZ.prototype,"sendServerMessage",1),iZ([mS()],rZ.prototype,"sendServerBinaryMessage",1),iZ([mS()],rZ.prototype,"startCloudProxy",1),iZ([mS()],rZ.prototype,"stopCloudProxy",1),iZ([mS()],rZ.prototype,"startPushPublicStream",1),iZ([mS()],rZ.prototype,"updatePublicStreamParam",1),iZ([mS()],rZ.prototype,"stopPushPublicStream",1),iZ([mS(["streamId"])],rZ.prototype,"startPlayPublicStream",1),iZ([mS(["streamId"])],rZ.prototype,"stopPlayPublicStream",1),iZ([mS()],rZ.prototype,"setAudioProfile",1),iZ([mS()],rZ.prototype,"setAudioEncodeMaxBitrate",1),iZ([mS()],rZ.prototype,"setPublicStreamVideoPlayer",1),iZ([mS()],rZ.prototype,"setDummyCaptureImagePath",1),iZ([mS()],rZ.prototype,"registerExtension",1),iZ([mS()],rZ.prototype,"startAudioPlaybackDeviceTest",1),iZ([mS()],rZ.prototype,"stopAudioPlaybackDeviceTest",1),iZ([mS()],rZ.prototype,"startAudioDeviceRecordTest",1),iZ([mS()],rZ.prototype,"stopAudioDeviceRecordAndPlayTest",1),iZ([mS()],rZ.prototype,"stopAudioDevicePlayTest",1),iZ([mS(),aZ],rZ.prototype,"setRemoteUserPriority",1),iZ([mS()],rZ.prototype,"takeLocalSnapshot",1),iZ([mS()],rZ.prototype,"takeRemoteSnapshot",1),iZ([mS()],rZ.prototype,"setSubscribeFallbackOption",1),iZ([mS()],rZ.prototype,"getLocalStreamTrack",1),iZ([mS()],rZ.prototype,"getRemoteStreamTrack",1),iZ([mS()],rZ.prototype,"getPublicStreamTrack",1),iZ([mS()],rZ.prototype,"setRemoteStreamRenderSync",1),iZ([mS()],rZ.prototype,"setJoinRoomParams",1),iZ([mS(),LD],rZ.prototype,"setAudioSelectionConfig",1),iZ([mS(),LD],rZ.prototype,"startForwardStreamToRooms",1),iZ([mS(),LD],rZ.prototype,"updateForwardStreamToRooms",1),iZ([mS(),LD],rZ.prototype,"stopForwardStreamToRooms",1),iZ([mS(),LD],rZ.prototype,"pauseForwardStreamToAllRooms",1),iZ([mS(),LD],rZ.prototype,"resumeForwardStreamToAllRooms",1),iZ([mS()],rZ.prototype,"setEarMonitorMode",1),iZ([mS([],{debounce:2e3,debounceTag:function(e){return"".concat(e)}})],rZ.prototype,"setEarMonitorVolume",1),iZ([mS()],rZ.prototype,"setUserInfo",1);const sZ={"client unpublished":th.STREAM_REMOVE_REASON_UNPUBLISH,"publish failed":th.STREAM_REMOVE_REASON_PUBLISH_FAILED,"stream removed":th.STREAM_REMOVE_REASON_KEEP_LIVE_FAILED,"client disconnected":th.STREAM_REMOVE_REASON_CLIENT_DISCONNECTED,"client republish":th.STREAM_REMOVE_REASON_REPUBLISH,"token publish privilege expired":th.STREAM_REMOVE_REASON_TOKEN_PRIVILEGE_EXPIRED};function nZ(e,t,i){const o=i.value;return i.value=async function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];const[r,s,n]=t;this.checkMediaType(n),this.assertNotInRoom();const a=await this.getSubLock(r,s).lock();try{return await o.apply(this,t)}finally{a()}},i}function aZ(e,t,i){const o=i.value;return i.value=async function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];const[r]=t,s=await this.getSubLock(!1,r).lock();try{return await o.apply(this,t)}finally{s()}},i}function dZ(e){return function(t,i,o){const r=o.value;return o.value=async function(){const t=[];"video"!==e&&t.push(this._audioCaptureLock.lock()),"audio"!==e&&t.push(this._videoCaptureLock.lock());const i=await Promise.all(t);try{for(var o=arguments.length,s=new Array(o),n=0;n<o;n++)s[n]=arguments[n];return await r.apply(this,s)}finally{i.forEach((e=>e()))}},o}}function cZ(e,t,i){const o=i.value;return i.value=async function(){const e=await this._screenCaptureLock.lock();try{for(var t=arguments.length,i=new Array(t),r=0;r<t;r++)i[r]=arguments[r];return await o.apply(this,i)}finally{e()}},i}var lZ=Object.defineProperty,uZ=Object.getOwnPropertyDescriptor,hZ=(e,t,i,o)=>{for(var r,s=o>1?void 0:o?uZ(t,i):t,n=e.length-1;n>=0;n--)(r=e[n])&&(s=(o?r(t,i,s):r(s))||s);return o&&s&&lZ(t,i,s),s};class _Z extends rZ{constructor(e,t,i){super(e,t,i),Xu(this,"singleStreamRenderMode",!1),this.id=t,this.logger=new LS("BLWEngine",0,t),ey([{width:192,height:108,frameRate:15,maxKbps:100},{width:320,height:180,frameRate:15,maxKbps:140},{width:640,height:360,frameRate:15,maxKbps:400},{width:1280,height:720,frameRate:15,maxKbps:1e3},{width:1920,height:1080,frameRate:15,maxKbps:2e3}]),this._handleEngineEvents()}async subscribeStream(e,t){return this.logger.print("subscribeStream()","userId: %o, mediaType: %o",e,t),this.singleStreamRenderMode&&sb(t)&&super.subscribeScreen(e,eh.VIDEO).catch((e=>{this.logger.error("singleStreamRenderMode subscribeScreen()",e)})),super.subscribeStream(e,t)}async unsubscribeStream(e,t){return this.logger.print("unsubscribeStream()","userId: %o, mediaType: %o",e,t),this.singleStreamRenderMode&&sb(t)&&super.unsubscribeScreen(e,eh.VIDEO).catch((e=>{this.logger.error("singleStreamRenderMode unsubscribeScreen()",e)})),super.unsubscribeStream(e,t)}setRemoteScreenVideoStreamIndex(e){return this.logger.print("setRemoteScreenVideoStreamIndex()","streamIndex: %o",e),!this._room&&(this.singleStreamRenderMode=e===$u.STREAM_INDEX_MAIN,!0)}setRemoteVideoPlayer(e,t){if(this.logger.print("setRemoteVideoPlayer()","streamIndex: %o, videoPlayerOption: %o",e,t),null==t||delete t.playerId,!this.singleStreamRenderMode||e!==$u.STREAM_INDEX_SCREEN)return super.setRemoteVideoPlayer(e,t)}destroy(){this.singleStreamRenderMode=!1,super.destroy()}_updateVideoPlayerState(e){var t,i,o,r;if(!this.singleStreamRenderMode)return super._updateVideoPlayerState(e);const{userId:s}=e,n=null===(t=this._room)||void 0===t?void 0:t.remoteStreams.get(s);let a,d;Array.isArray(n)&&n.forEach((e=>{e.isScreen?a=e:d=e}));let c=null===(i=d)||void 0===i||null===(i=i.videoTrack)||void 0===i?void 0:i.dangerousGetPlayer(QP);if(!c){var l;const e=null===(l=this._remoteVideoPlayerConfig[$u.STREAM_INDEX_MAIN].get(s))||void 0===l?void 0:l.get(QP);if(!e)return;var u,h,_;null===(u=d)||void 0===u||null===(u=u.videoTrack)||void 0===u||u.setPlayer(this.id,e,null===(h=this._config)||void 0===h?void 0:h.autoPlayPolicy,this._initPlayerEvents.bind(this)),c=null===(_=d)||void 0===_||null===(_=_.videoTrack)||void 0===_?void 0:_.dangerousGetPlayer(QP)}var m,p,v;if(!e.isScreen&&null!==(o=a)&&void 0!==o&&o.videoTrack&&a.videoHasPublish)return this.logger.print("_updateVideoPlayerState","prevent play main stream"),void(null===(m=c)||void 0===m||m.playVideo(a.videoTrack));e.videoTrack?(null===(p=this._config)||void 0===p?void 0:p.autoPlayPolicy)!==Sh.PLAY_MANUALLY&&(null===(v=c)||void 0===v||v.playVideo(e.videoTrack)):null!==(r=c)&&void 0!==r&&r.played&&c.stop()}_handleEngineEvents(){this.on(xh.onUserPublishScreen,(e=>{if(this.singleStreamRenderMode&&sb(e.mediaType)){var t,i;const o=null===(t=this._room)||void 0===t?void 0:t.remoteStreams.get(e.userId),r=null==o?void 0:o.find((e=>!e.isScreen)),s=null==o?void 0:o.find((e=>e.isScreen));null!=s&&s.hasSubscribed?(this.logger.info("onUserPublishScreen","singleStreamRenderMode screen hasSubscribed"),this._updateVideoPlayerState(s)):(null!==(i=this._room)&&void 0!==i&&i.config.isAutoSubscribeVideo||null!=r&&r.hasSubscribed&&sb(r.subMediaType))&&(this.logger.info("onUserPublishScreen","singleStreamRenderMode subscribeScreen"),this.subscribeScreen(e.userId,eh.VIDEO))}})),this.on(xh.onUserUnpublishScreen,(e=>{if(this.singleStreamRenderMode&&sb(e.mediaType)){var t;const i=null===(t=this._room)||void 0===t?void 0:t.remoteStreams.get(e.userId),o=null==i?void 0:i.find((e=>!e.isScreen));o&&setTimeout((()=>{this._updateVideoPlayerState(o)}))}}))}}hZ([mS()],_Z.prototype,"subscribeStream",1),hZ([mS()],_Z.prototype,"unsubscribeStream",1),hZ([mS()],_Z.prototype,"setRemoteScreenVideoStreamIndex",1),hZ([mS()],_Z.prototype,"setRemoteVideoPlayer",1),hZ([mS()],_Z.prototype,"destroy",1);const mZ=new LS("VERTC",0);mm.storeKey="".concat(Date.now(),"-").concat(bg.getDeviceId()),oS({rtc_sdk_version:jg.VERSION,device_id:bg.getDeviceId(),log_cache_key:mm.storeKey}),rS(jg.LOG_SERVER_URL);let pZ=1;const vZ=(e,t)=>{mZ.info("createEngine","Invoke VERTC.createEngine"),Ng(e,"appId");const i=(pZ++).toString();return hS(i,{rtc_app_id:e,auto_play_policy:null==t?void 0:t.autoPlayPolicy}),new rZ(e,i,t)},fZ=(e,t)=>{mZ.print("createBLWEngine","Invoke VERTC.createBLWEngine"),Ng(e,"appId");const i=(pZ++).toString();return hS(i,{rtc_app_id:e,auto_play_policy:null==t?void 0:t.autoPlayPolicy}),new _Z(e,i,t)},SZ=e=>{if(mZ.info("destroyEngine","Invoke VERTC.destroyEngine"),!(e instanceof rZ))throw new Cg(Eg.INVALID_ENGINE,"Invalid engine object");var t;e.destroy(),(t=e.monitor).report("sdk_init_engine",{start:Date.now(),type:"end"}),lS.delete(t.id)},gZ=async()=>BP.enumerateDevices(),yZ=async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{video:!0,audio:!0};const{video:t,audio:i}=e,o={video:!1,audio:!1},r=[];return t&&r.push(BP.getPermissions({video:!0,force:!0}).then((e=>{o.video=e.video,e.video||(o.videoExceptionError=e.reason)}))),i&&r.push(BP.getPermissions({audio:!0,force:!0}).then((e=>{o.audio=e.audio,e.audio||(o.audioExceptionError=e.reason)}))),await Promise.allSettled(r),o},bZ=async()=>BP.enumerateAudioCaptureDevices(),TZ=async()=>BP.enumerateVideoCaptureDevices(),IZ=async()=>BP.enumerateAudioPlaybackDevices(),EZ=()=>jg.VERSION,RZ=()=>(async()=>{try{return!(xS()||!window.RTCPeerConnection||!window.RTCPeerConnection.prototype.addTransceiver||!window.RTCPeerConnection.prototype.createDataChannel)&&await $I()&&await qI()}catch(e){return!1}})(),CZ=()=>(async()=>(await KI()).map((e=>e===YI.ByteVC1?"H265":e.toUpperCase())))(),kZ=e=>{let{logLevel:t,LogfileSize:i}=e;t&&(mm.logLevel=t),i&&(mm.LogfileSize=i)},AZ=e=>{mm.download(e)};function PZ(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return JSON.stringify(t.map((e=>e instanceof rZ?"[ENGINE]":e)))}function NZ(e,t){return function(){nS(t,0,PZ(...arguments));const i=e(...arguments);return"function"==typeof(null==i?void 0:i.then)?i.then((e=>(aS(t,0,PZ(e)),e))).catch((e=>{throw aS(t,e.code,e.message),e})):(aS(t,0,PZ(i)),i)}}return Fu(Fu(Fu(Fu({},new class{constructor(){Xu(this,"getSdkVersion",NZ(EZ,"getSdkVersion")),Xu(this,"createEngine",NZ(vZ,"createEngine")),Xu(this,"createBLWEngine",NZ(fZ,"createBLWEngine")),Xu(this,"destroyEngine",NZ(SZ,"destroyEngine")),Xu(this,"enumerateDevices",NZ(gZ,"enumerateDevices")),Xu(this,"enableDevices",NZ(yZ,"enableDevices")),Xu(this,"enumerateAudioCaptureDevices",NZ(bZ,"enumerateAudioCaptureDevices")),Xu(this,"enumerateVideoCaptureDevices",NZ(TZ,"enumerateVideoCaptureDevices")),Xu(this,"enumerateAudioPlaybackDevices",NZ(IZ,"enumerateAudioPlaybackDevices")),Xu(this,"getParameter",Qg),Xu(this,"setParameter",zg),Xu(this,"isSupported",NZ(RZ,"isSupported")),Xu(this,"getSupportedCodecs",NZ(CZ,"getSupportedCodecs")),Xu(this,"getElectronScreenSources",NZ(mN,"getElectronScreenSources")),Xu(this,"events",xh),Xu(this,"ErrorCode",Eg),Xu(this,"platform","VolcEngine"),Xu(this,"commitInfo","HEAD<6cd7430*>"),Xu(this,"downloadLog",NZ(AZ,"downloadLog")),Xu(this,"setLogConfig",NZ(kZ,"setLogConfig"))}}),Nh),Lh),{},{events:xh})}));
