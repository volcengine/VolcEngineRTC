---
is_dir: False    # True for dir; False for doc
status: 1    # 1 for online; 0 for offline
keywords: 实时音视频    # use ',' as separator
---

当你使用 RTC 实现实时音视频通信时，RTC 默认使用内部的编解码模块进行视频编解码。然而在一些场景下，你可能会发现内部编解码模块无法满足需求，比如：音视频应用中已实现了视频编解码模块，此时 RTC 再进行二次编解码有可能会产生延时和视频质量的损耗。

你可以参考本文，将自定义编码后的视频源，交由 RTC 进行传输，或对 RTC 拉取到的远端编码后视频源进行自定义解码渲染。


## 前提条件

你已经集成 v3.29 或更高版本的 RTC SDK。

## 自定义视频编码

集成步骤和时序图中的接口以 Windows 平台为例，参考对应平台的 [API 文档](#api-%E5%8F%82%E8%80%83)获取更多信息。
自定义编码的流程如下图所示。

![alt](https://portal.volccdn.com/obj/volcfe/cloud-universal-doc/upload_854ea82119acfc1b1a300f5f6b79c6f9.png =700x)

### 集成步骤

1.  在加入音视频房间前，通过调用 [setVideoSourceType](https://www.volcengine.com/docs/6348/Windows-api#IRTCVideo-setvideosourcetype) 指定自定义编码视频源，你需要设置 `VideoSourceType` 为 `kVideoSourceTypeEncodedWithoutAutoSimulcast = 3`。

2. 调用 [setExternalVideoEncoderEventHandler](https://www.volcengine.com/docs/6348/Windows-api#IRTCVideo-setexternalvideoencodereventhandler) 注册自定义编码帧推送事件回调。

3. （可选）调用 [setVideoEncoderConfig](https://www.volcengine.com/docs/6348/Windows-api#IRTCVideo-setvideoencoderconfig) 设置每路视频流的参数。
4.  你必须自行实现视频编码逻辑。出于节约本端编码性能消耗的考虑，推荐你根据 `onActiveVideoLayer`，按需编码。
5.  编码完成后，你需要在收到 `onStart` 回调通知后调用 `pushExternalEncodedVideoFrame` 将编码后的视频帧推送至 RTC SDK 进行传输。你必须根据实际编码时使用的参数来设置 `pushExternalEncodedVideoFrame` 中的 `IEncodedVideoFrame`。


:::warning
- 外部编码器推送给 SDK 的帧必须是完整的一帧，且只支持 IDR 帧和 P 帧，不支持推送多个帧拼接。
- 在收到 `IExternalVideoEncoderEventHandler` 回调的 [onRequestKeyFrame](https://www.volcengine.com/docs/6348/Windows-callback#IExternalVideoEncoderEventHandler-onrequestkeyframe) 时，必须重新编码一个 I 帧发送，否则订阅端会因为收不到 I 帧导致解码失败。
:::

### API 调用时序

![alt](https://portal.volccdn.com/obj/volcfe/cloud-universal-doc/upload_58fb724bc2e72078caefb324ac3269c5.jpg =800x)

### API 参考

|  <div style="width: 110pt">功能/平台</div> |   <div style="width: 190pt">Android</div> | <div style="width: 190pt">iOS</div> | <div style="width: 190pt">Windows</div> | <div style="width: 190pt">macOS</div> |
| --- | --- | --- | --- | --- |
| 设置自定义编码帧推送事件回调 | [setExternalVideoEncoderEventHandler](Android-api#RTCVideo-setexternalvideoencodereventhandler) | [setExternalVideoEncoderEventHandler:](iOS-api#ByteRTCVideo-setexternalvideoencodereventhandler) | [setExternalVideoEncoderEventHandler](Windows-api#IRTCVideo-setexternalvideoencodereventhandler) |[setExternalVideoEncoderEventHandler:](macOS-api#ByteRTCVideo-setexternalvideoencodereventhandler) |
| 设置视频输入源 |[setVideoSourceType](Android-api#RTCVideo-setvideosourcetype)|[setVideoSourceType:WithStreamIndex:](iOS-api#ByteRTCVideo-setvideosourcetype-withstreamindex) |[setVideoSourceType:WithStreamIndex:](macOS-api#ByteRTCVideo-setvideosourcetype-withstreamindex)|[setVideoSourceType](Windows-api#setvideosourcetype)|
| 设置多路流参数 | [setVideoEncoderConfig](Android-api#setvideoencoderconfig-2) | [setVideoEncoderConfig:config:](iOS-api#ByteRTCVideo-setvideoencoderconfig) | [setVideoEncoderConfig](Windows-api#IRTCVideo-setvideoencoderconfig-2) |[setVideoEncoderConfig:config:](macOS-api#ByteRTCVideo-setvideoencoderconfig) |
| 推送编码后视频帧 | [pushExternalEncodedVideoFrame](Android-api#RTCVideo-pushexternalencodedvideoframe) | [pushExternalEncodedVideoFrame:withVideoIndex:withEncodedVideoFrame:](iOS-api#ByteRTCVideo-pushexternalencodedvideoframe-withvideoindex-withencodedvideoframe) | [pushExternalEncodedVideoFrame](Windows-api#IRTCVideo-pushexternalencodedvideoframe) | [pushExternalEncodedVideoFrame:withVideoIndex:withEncodedVideoFrame:](macOS-api#ByteRTCVideo-pushexternalencodedvideoframe-withvideoindex-withencodedvideoframe) |
| 自定义编码视频发送端在可发送状态发生变化时，收到的回调 | [onActiveVideoLayer](Android-callback#IExternalVideoEncoderEventHandler-onactivevideolayer) | [onActiveVideoLayer:withVideoIndex:withActive:](iOS-callback#ByteRTCExternalVideoEncoderEventHandler-onactivevideolayer-withvideoindex-withactive) | [onActiveVideoLayer](Windows-callback#IExternalVideoEncoderEventHandler-onactivevideolayer) |[onActiveVideoLayer:withVideoIndex:withActive:](macOS-callback#ByteRTCExternalVideoEncoderEventHandler-onactivevideolayer-withvideoindex-withactive) |


## 自定义视频解码


集成步骤和时序图中的接口以 Windows 平台为例，参考对应平台的 [API 文档](#api-%E5%8F%82%E8%80%83-2)获取更多信息。
自定义解码的流程如下图所示。

![alt](https://portal.volccdn.com/obj/volcfe/cloud-universal-doc/upload_89c04e039ef38110ea66bd0b023cda2d.png =700x)

### 集成步骤

1. 在加入音视频房间前，通过调用 [registerRemoteEncodedVideoFrameObserver](https://www.volcengine.com/docs/6348/Windows-api#IRTCVideo-registerremoteencodedvideoframeobserver) 注册远端编码后视频帧回调。

2. 调用 [joinRoom](https://www.volcengine.com/docs/6348/Windows-api#IRTCRoom-joinroom) 加入房间，将订阅模式指定为手动订阅。
    
3. 通过 [onUserPublishStream](https://www.volcengine.com/docs/6348/Windows-callback#IRTCRoomEventHandler-onuserpublishstream) 或 [onUserPublishScreen](https://www.volcengine.com/docs/6348/Windows-callback#IRTCRoomEventHandler-onuserpublishscreen) 获取到远端流信息后，调用 [setVideoDecoderConfig](https://www.volcengine.com/docs/6348/Windows-api#IRTCVideo-setvideodecoderconfig) 将远端视频数据解码方式设置为自定义解码。

4. 调用 [subscribeStream](https://www.volcengine.com/docs/6348/Windows-api#subscribestream) 或 [subscribeScreen](https://www.volcengine.com/docs/6348/Windows-api#subscribescreen) 订阅远端流。

5. 当 SDK 监测到远端编码后视频数据时触发 [onRemoteEncodedVideoFrame](https://www.volcengine.com/docs/6348/Windows-callback#IRemoteEncodedVideoFrameObserver-onremoteencodedvideoframe)，你需要自行实现视频解码逻辑。
    
6. 自定义解码失败时，调用 [requestRemoteVideoKeyFrame](https://www.volcengine.com/docs/6348/Windows-api#IRTCVideo-requestremotevideokeyframe) 向远端请求关键帧。
    

### API 调用时序

![alt](https://portal.volccdn.com/obj/volcfe/cloud-universal-doc/upload_88ad97bf67f3086ac0a3a9f10326d282.jpg =800x)


### API 参考

|  <div style="width: 140pt">功能/平台</div> |   <div style="width: 170pt">Android</div> | <div style="width: 170pt">iOS</div> | <div style="width: 170pt">Windows</div> | <div style="width: 170pt">macOS</div> |
| --- | --- | --- | --- | --- |
| 注册远端编码后视频数据回调 | [registerRemoteEncodedVideoFrameObserver](Android-api#RTCVideo-registerremoteencodedvideoframeobserver) | [registerRemoteEncodedVideoFrameObserver:](iOS-api#ByteRTCVideo-registerremoteencodedvideoframeobserver) | [registerRemoteEncodedVideoFrameObserver](Windows-api#IRTCVideo-registerremoteencodedvideoframeobserver) | [registerRemoteEncodedVideoFrameObserver:](macOS-api#ByteRTCVideo-registerremoteencodedvideoframeobserver) |
| 设置远端视频数据解码方式 | [setVideoDecoderConfig](Android-api#RTCVideo-setvideodecoderconfig) | [setVideoDecoderConfig:withVideoDecoderConfig:](iOS-api#ByteRTCVideo-setvideodecoderconfig-withvideodecoderconfig) | [setVideoDecoderConfig](Windows-api#IRTCVideo-setvideodecoderconfig) | [setVideoDecoderConfig:withVideoDecoderConfig:](macOS-api#ByteRTCVideo-setvideodecoderconfig-withvideodecoderconfig) |
| 请求远端关键帧 | [requestRemoteVideoKeyFrame](Android-api#RTCVideo-requestremotevideokeyframe) | [requestRemoteVideoKeyFrame:](iOS-api#ByteRTCVideo-requestremotevideokeyframe) | [requestRemoteVideoKeyFrame](Windows-api#IRTCVideo-requestremotevideokeyframe) | [requestRemoteVideoKeyFrame:](macOS-api#ByteRTCVideo-requestremotevideokeyframe) |

## 功能变更日志

1. 自客户端版本 v3.29 起，支持自定义视频编码功能。
2. 自客户端版本 v3.56 起，发送端可以根据 `onActiveVideoLayer`，按需编码。

## 相关文档
[切换内部和自定义视频编码模块](100448)